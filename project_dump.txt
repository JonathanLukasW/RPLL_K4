

=== FILE: lib/core/screens/profile_screen.dart ===

import 'package:flutter/material.dart';
import 'package:supabase_flutter/supabase_flutter.dart';
import '../../features/autentikasi/screens/login_screen.dart';

class ProfileScreen extends StatefulWidget {
  const ProfileScreen({super.key});

  @override
  State<ProfileScreen> createState() => _ProfileScreenState();
}

class _ProfileScreenState extends State<ProfileScreen> {
  final _passwordController = TextEditingController();
  bool _isLoading = false;
  
  // Data User
  String _email = "";
  String _name = "";
  String _role = "";

  @override
  void initState() {
    super.initState();
    _loadUserData();
  }

  Future<void> _loadUserData() async {
    final user = Supabase.instance.client.auth.currentUser;
    if (user != null) {
      try {
        final profile = await Supabase.instance.client
            .from('profiles')
            .select()
            .eq('id', user.id)
            .single();
        
        setState(() {
          _email = user.email ?? "-";
          _name = profile['full_name'] ?? "-";
          _role = profile['role']?.toString().toUpperCase() ?? "-";
        });
      } catch (e) {
        print("Gagal load profil: $e");
      }
    }
  }

  Future<void> _changePassword() async {
    if (_passwordController.text.length < 6) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text("Password minimal 6 karakter")),
      );
      return;
    }

    setState(() => _isLoading = true);
    try {
      await Supabase.instance.client.auth.updateUser(
        UserAttributes(password: _passwordController.text),
      );
      
      if (!mounted) return;
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text("Password berhasil diubah!"), backgroundColor: Colors.green),
      );
      _passwordController.clear();

    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text("Gagal ganti password: $e"), backgroundColor: Colors.red),
      );
    } finally {
      if (mounted) setState(() => _isLoading = false);
    }
  }

  Future<void> _logout() async {
    await Supabase.instance.client.auth.signOut();
    if (!mounted) return;
    Navigator.of(context).pushAndRemoveUntil(
      MaterialPageRoute(builder: (_) => const LoginScreen()),
      (route) => false,
    );
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text("Profil Saya"),
        backgroundColor: Colors.grey[800], // Netral
        foregroundColor: Colors.white,
      ),
      body: SingleChildScrollView(
        padding: const EdgeInsets.all(20),
        child: Column(
          children: [
            const SizedBox(height: 20),
            // Avatar Besar
            const CircleAvatar(
              radius: 50,
              backgroundColor: Colors.grey,
              child: Icon(Icons.person, size: 60, color: Colors.white),
            ),
            const SizedBox(height: 20),
            
            // Info User
            Text(_name, style: const TextStyle(fontSize: 22, fontWeight: FontWeight.bold)),
            Text(_email, style: const TextStyle(fontSize: 16, color: Colors.grey)),
            const SizedBox(height: 10),
            Container(
              padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
              decoration: BoxDecoration(
                color: Colors.blue[50],
                borderRadius: BorderRadius.circular(20),
                border: Border.all(color: Colors.blue),
              ),
              child: Text(_role, style: const TextStyle(color: Colors.blue, fontWeight: FontWeight.bold)),
            ),

            const SizedBox(height: 40),
            const Divider(),
            const SizedBox(height: 20),

            // Form Ganti Password
            const Align(
              alignment: Alignment.centerLeft,
              child: Text("Ganti Password", style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold)),
            ),
            const SizedBox(height: 15),
            TextField(
              controller: _passwordController,
              obscureText: true,
              decoration: const InputDecoration(
                labelText: "Password Baru",
                border: OutlineInputBorder(),
                prefixIcon: Icon(Icons.lock_reset),
              ),
            ),
            const SizedBox(height: 15),
            SizedBox(
              width: double.infinity,
              child: ElevatedButton(
                onPressed: _isLoading ? null : _changePassword,
                style: ElevatedButton.styleFrom(
                  padding: const EdgeInsets.symmetric(vertical: 15),
                  backgroundColor: Colors.blue[800],
                  foregroundColor: Colors.white,
                ),
                child: _isLoading 
                  ? const SizedBox(height: 20, width: 20, child: CircularProgressIndicator(color: Colors.white))
                  : const Text("UPDATE PASSWORD"),
              ),
            ),

            const SizedBox(height: 40),
            
            // Tombol Logout Merah
            SizedBox(
              width: double.infinity,
              child: OutlinedButton.icon(
                onPressed: _logout,
                icon: const Icon(Icons.logout, color: Colors.red),
                label: const Text("LOGOUT", style: TextStyle(color: Colors.red)),
                style: OutlinedButton.styleFrom(
                  padding: const EdgeInsets.symmetric(vertical: 15),
                  side: const BorderSide(color: Colors.red),
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }
}

=== FILE: lib/core/services/storage_service.dart ===

import 'dart:io';
import 'package:supabase_flutter/supabase_flutter.dart';
import 'package:image_picker/image_picker.dart'; // Pastikan sudah ada di pubspec

class StorageService {
  final _supabase = Supabase.instance.client;

  // Fungsi Pilih Foto dari Kamera/Galeri
  Future<File?> pickImage(ImageSource source) async {
    final ImagePicker picker = ImagePicker();
    final XFile? image = await picker.pickImage(
      source: source,
      imageQuality: 70, // Kompres dikit biar gak berat
      maxWidth: 1024,   // Resize
    );

    if (image != null) {
      return File(image.path);
    }
    return null;
  }

  // Fungsi Upload ke Supabase
  Future<String> uploadEvidence(File file, String folderName) async {
    try {
      // Nama file unik: evidence/stops/timestamp.jpg
      final fileName = '${DateTime.now().millisecondsSinceEpoch}.jpg';
      final path = '$folderName/$fileName';

      // Upload
      await _supabase.storage.from('evidence').upload(
        path,
        file,
        fileOptions: const FileOptions(cacheControl: '3600', upsert: false),
      );

      // Ambil URL Publik
      final String publicUrl = _supabase.storage.from('evidence').getPublicUrl(path);
      return publicUrl;
      
    } catch (e) {
      throw Exception("Gagal upload foto: $e");
    }
  }
}

=== FILE: lib/models/class_receptions_rows.sql ===

INSERT INTO "public"."class_receptions" ("id", "stop_id", "teacher_id", "class_name", "qty_received", "notes", "created_at", "issue_type", "proof_photo_url", "admin_response", "resolved_at") VALUES ('5aeaa4da-d019-409a-9816-5e15c99a001a', '0791fc1e-ae4f-43f2-99dd-6ea946b216f1', '52df0c3d-084d-4e3d-a9fe-8ae9ce923b95', '8B', '32', '13312', '2025-11-23 18:12:05.96111+00', null, null, null, null);

=== FILE: lib/models/school_model.dart ===

class School {
  final String id;
  final String sppgId; 
  final String name;
  final String? address;
  final double? latitude;  
  final double? longitude; 
  final int studentCount;  
  final String? deadlineTime; 
  final int serviceTimeMinutes; 
  final bool isHighRisk; 
  
  // [BARU] Field untuk VRP Constraints
  final int toleranceMinutes;  
  final String? menuDefault;     

  School({
    required this.id,
    required this.sppgId,
    required this.name,
    this.address,
    this.latitude,
    this.longitude,
    this.studentCount = 0,
    this.deadlineTime,
    this.serviceTimeMinutes = 10,
    this.isHighRisk = false,
    this.toleranceMinutes = 45, // Default 45 menit
    this.menuDefault,
  });

  factory School.fromJson(Map<String, dynamic> json) {
    return School(
      id: json['id'].toString(),
      sppgId: json['sppg_id'].toString(),
      name: json['name'] ?? 'Tanpa Nama Sekolah',
      address: json['address'],
      latitude: json['gps_lat'] != null ? double.tryParse(json['gps_lat'].toString()) : null,
      longitude: json['gps_long'] != null ? double.tryParse(json['gps_long'].toString()) : null,
      studentCount: json['student_count'] != null ? int.parse(json['student_count'].toString()) : 0,
      serviceTimeMinutes: json['service_time_minutes'] != null ? int.parse(json['service_time_minutes'].toString()) : 10,
      isHighRisk: json['is_high_risk'] ?? false,
      deadlineTime: json['deadline_time'],
      // [BARU] Parsing kolom tambahan
      toleranceMinutes: json['tolerance_minutes'] != null ? int.parse(json['tolerance_minutes'].toString()) : 45,
      menuDefault: json['menu_default'],
    );
  }

  Map<String, dynamic> toJson() {
    return {
      'sppg_id': sppgId,
      'name': name,
      'address': address,
      'gps_lat': latitude,
      'gps_long': longitude,
      'student_count': studentCount,
      'deadline_time': deadlineTime,
      'service_time_minutes': serviceTimeMinutes,
      'is_high_risk': isHighRisk,
      // [BARU] Properti tambahan
      'tolerance_minutes': toleranceMinutes,
      'menu_default': menuDefault,
    };
  }
}

=== FILE: lib/models/menu_model.dart ===

class Menu {
  final String id;
  final String sppgId;
  final String name;
  final String category; 
  final int cookingDurationMinutes;

  Menu({
    required this.id,
    required this.sppgId,
    required this.name,
    required this.category,
    required this.cookingDurationMinutes,
  });

  factory Menu.fromJson(Map<String, dynamic> json) {
    return Menu(
      id: json['id'].toString(),
      sppgId: json['sppg_id'].toString(),
      name: json['name'] ?? 'Menu Baru',
      category: json['category'] ?? 'Lain-lain',
      cookingDurationMinutes: json['cooking_duration_minutes'] != null 
          ? int.parse(json['cooking_duration_minutes'].toString()) 
          : 0,
    );
  }

  Map<String, dynamic> toJson() {
    return {
      'sppg_id': sppgId,
      'name': name,
      'category': category,
      'cooking_duration_minutes': cookingDurationMinutes,
    };
  }
}

=== FILE: lib/models/schools_rows.sql ===

INSERT INTO "public"."schools" ("id", "sppg_id", "name", "address", "gps_lat", "gps_long", "student_count", "deadline_time", "service_time_minutes", "is_high_risk", "tolerance_minutes", "menu_default") VALUES ('00cf74b3-1b05-4459-b049-2b311e2c0037', '894cc1e5-d726-4f7b-8f49-2fe8970ce539', 'STMIK LIKMI', 'Jl. Ir. H. Juanda No.96, Lebakgede, Kecamatan Coblong, Kota Bandung, Jawa Barat 40132', '-6.8955242', '107.61335', '200', '13:00:00', '10', 'false', '45', 'nasi box ma chik'), ('222afd5d-8889-4ac8-b371-bbf13018cc4b', '894cc1e5-d726-4f7b-8f49-2fe8970ce539', 'SMPN 6 Lembang', 'Jl. Peneropongan Bintang, Gudangkahuripan, Kec. Lembang, Kabupaten Bandung Barat, Jawa Barat 40391. ', '-6.82281424177572', '107.612567810239', '600', '09:00:00', '10', 'false', '45', 'nasi goreng jawara'), ('2f004c1b-6353-4f28-99de-9b833bcc73cf', '894cc1e5-d726-4f7b-8f49-2fe8970ce539', 'Harvard', 'jalan sukamulya', '-6.9025816', '107.6190825', '300', '09:00:00', '10', 'false', '45', 'nasi padang');

=== FILE: lib/models/sppgs_rows.sql ===

INSERT INTO "public"."sppgs" ("id", "name", "address", "gps_lat", "gps_long", "created_at", "email", "phone") VALUES ('894cc1e5-d726-4f7b-8f49-2fe8970ce539', 'SPPG Sukajaya Lembang 1', 'Jl. Kolonel Masturi No.155, Sukajaya, Kec. Lembang, Kabupaten Bandung Barat, Jawa Barat 40391. 
', '-6.81424249120099', '107.602458303493', '2025-11-19 09:41:36.789025+00', 'sukajaya@gmail.com', '085143271864'), ('b4af86a0-f881-4352-9f3e-ca61bf634875', 'SPPG LIKMI', 'jl. jshsk', '-6.8955242', '107.61335', '2025-11-20 06:22:12.783703+00', 'likmi@gmail.com', '1234567899');

=== FILE: lib/models/vehicles_rows.sql ===

INSERT INTO "public"."vehicles" ("id", "sppg_id", "plate_number", "driver_name", "capacity_limit", "is_active") VALUES ('8bf98689-1fc0-421b-b3e3-23dbcfe52eb9', '894cc1e5-d726-4f7b-8f49-2fe8970ce539', 'D 1343 AC', 'Udin', '800', 'true');

=== FILE: lib/models/sql_dump.txt ===

CREATE TABLE IF NOT EXISTS public.profiles (
    id uuid REFERENCES auth.users ON DELETE CASCADE NOT NULL PRIMARY KEY,
    full_name text,
    role text CHECK (role IN ('bgn', 'admin_sppg', 'kurir', 'koordinator', 'walikelas')),
    sppg_id uuid, 
    school_id uuid, 
    class_name text, 
    email text, 
    created_at timestamp with time zone DEFAULT timezone('utc'::text, now())
);

CREATE TABLE IF NOT EXISTS public.sppgs (
    id uuid DEFAULT uuid_generate_v4() PRIMARY KEY,
    name text NOT NULL,
    address text,
    gps_lat float,
    gps_long float,
    email text,
    phone text,
    created_at timestamp with time zone DEFAULT now()
);

CREATE TABLE IF NOT EXISTS public.schools (
    id uuid DEFAULT uuid_generate_v4() PRIMARY KEY,
    sppg_id uuid REFERENCES public.sppgs(id), 
    name text NOT NULL,
    address text,
    gps_lat float,
    gps_long float,
    student_count int DEFAULT 0, 
    deadline_time time, 
    service_time_minutes int DEFAULT 10, 
    is_high_risk boolean DEFAULT false,
    tolerance_minutes integer DEFAULT 45, 
    menu_default text
);

CREATE TABLE IF NOT EXISTS public.vehicles (
    id uuid DEFAULT uuid_generate_v4() PRIMARY KEY,
    sppg_id uuid REFERENCES public.sppgs(id),
    plate_number text NOT NULL,
    driver_name text,
    capacity_limit int DEFAULT 0,
    is_active boolean DEFAULT true 
);

CREATE TABLE IF NOT EXISTS public.menus (
    id uuid DEFAULT uuid_generate_v4() PRIMARY KEY,
    sppg_id uuid REFERENCES public.sppgs(id) ON DELETE CASCADE,
    name text NOT NULL,
    category text,
    cooking_duration_minutes integer DEFAULT 0,
    created_at timestamp with time zone DEFAULT now()
);

CREATE TABLE IF NOT EXISTS public.production_schedules (
    id uuid DEFAULT uuid_generate_v4() PRIMARY KEY,
    sppg_id uuid REFERENCES public.sppgs(id),
    date date NOT NULL,                        
    menu_id uuid REFERENCES public.menus(id),  
    total_portions integer DEFAULT 0,          
    start_cooking_time time,    
    target_finish_time time,    
    notes text,                                
    created_at timestamp WITH time zone DEFAULT now()
);

CREATE TABLE IF NOT EXISTS public.delivery_routes (
    id uuid DEFAULT uuid_generate_v4() PRIMARY KEY,
    date date DEFAULT CURRENT_DATE,
    sppg_id uuid REFERENCES public.sppgs(id),
    vehicle_id uuid REFERENCES public.vehicles(id),
    courier_id uuid REFERENCES public.profiles(id), -- FIX: Refer ke profiles, bukan auth.users
    status text CHECK (status IN ('pending', 'active', 'completed')) DEFAULT 'pending',
    start_time timestamp with time zone,
    end_time timestamp with time zone
);

CREATE TABLE IF NOT EXISTS public.delivery_stops (
    id uuid DEFAULT uuid_generate_v4() PRIMARY KEY,
    route_id uuid REFERENCES public.delivery_routes(id),
    school_id uuid REFERENCES public.schools(id),
    sequence_order int, 
    status text CHECK (status IN ('pending', 'arrived', 'completed', 'received', 'issue_reported')) DEFAULT 'pending',
    arrival_time timestamp with time zone, 
    completion_time timestamp with time zone,
    -- Data Penerimaan Koordinator
    received_qty integer DEFAULT 0,
    reception_notes text,
    proof_photo_url text,
    recipient_name text,
    -- Data Tindak Lanjut Admin
    admin_response text,
    resolved_at timestamp with time zone
);

CREATE TABLE IF NOT EXISTS public.class_receptions (
    id uuid DEFAULT uuid_generate_v4() PRIMARY KEY,
    stop_id uuid REFERENCES public.delivery_stops(id),
    teacher_id uuid REFERENCES auth.users(id),
    class_name text,
    qty_received integer DEFAULT 0,
    notes text,
    issue_type text,
    proof_photo_url text,
    admin_response text, 
    resolved_at timestamp with time zone,
    created_at timestamp WITH time zone DEFAULT now()
);

CREATE TABLE IF NOT EXISTS public.change_requests (
    id uuid DEFAULT uuid_generate_v4() PRIMARY KEY,
    sppg_id uuid REFERENCES public.sppgs(id),
    school_id uuid REFERENCES public.schools(id),
    requester_id uuid REFERENCES auth.users(id),
    request_type text, 
    details text,
    status text DEFAULT 'pending', 
    admin_response text,          
    created_at timestamp WITH time zone DEFAULT now(),
    updated_at timestamp WITH time zone
);

ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.sppgs ENABLE ROW LEVEL SECURITY; 
ALTER TABLE public.schools ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.vehicles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.menus ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.production_schedules ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.delivery_routes ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.delivery_stops ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.class_receptions ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.change_requests ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS "Enable all for authenticated users" ON public.profiles;
DROP POLICY IF EXISTS "Enable all for authenticated users on profiles" ON public.profiles;

CREATE POLICY "Allow All Auth Profiles" ON public.profiles FOR ALL TO authenticated USING (true) WITH CHECK (true);
CREATE POLICY "Allow All Auth Schools" ON public.schools FOR ALL TO authenticated USING (true) WITH CHECK (true);
CREATE POLICY "Allow All Auth Vehicles" ON public.vehicles FOR ALL TO authenticated USING (true) WITH CHECK (true);
CREATE POLICY "Allow All Auth Menus" ON public.menus FOR ALL TO authenticated USING (true) WITH CHECK (true);
CREATE POLICY "Allow All Auth Schedules" ON public.production_schedules FOR ALL TO authenticated USING (true) WITH CHECK (true);
CREATE POLICY "Allow All Auth Routes" ON public.delivery_routes FOR ALL TO authenticated USING (true) WITH CHECK (true);
CREATE POLICY "Allow All Auth Stops" ON public.delivery_stops FOR ALL TO authenticated USING (true) WITH CHECK (true);
CREATE POLICY "Allow All Auth Receptions" ON public.class_receptions FOR ALL TO authenticated USING (true) WITH CHECK (true);
CREATE POLICY "Allow All Auth Requests" ON public.change_requests FOR ALL TO authenticated USING (true) WITH CHECK (true);

CREATE POLICY "Public profiles view" ON public.profiles FOR SELECT USING (true);

INSERT INTO storage.buckets (id, name, public) VALUES ('evidence', 'evidence', true) ON CONFLICT (id) DO NOTHING;

CREATE POLICY "Allow Upload Evidence" ON storage.objects FOR INSERT TO authenticated WITH CHECK (bucket_id = 'evidence');
CREATE POLICY "Allow View Evidence" ON storage.objects FOR SELECT TO public USING (bucket_id = 'evidence');

    

=== FILE: lib/models/sppg_model.dart ===

class Sppg {
  final String id;
  final String name;
  final String? address;
  final String? email;
  final String? phone;
  final double? latitude;
  final double? longitude;
  // [BARU]
  final String? establishedDate; 

  Sppg({
    required this.id,
    required this.name,
    this.address,
    this.email,
    this.phone,
    this.latitude,
    this.longitude,
    this.establishedDate,
  });

  factory Sppg.fromJson(Map<String, dynamic> json) {
    return Sppg(
      id: json['id'].toString(),
      name: json['name'] ?? 'Tanpa Nama',
      address: json['address'],
      email: json['email'],
      phone: json['phone'],
      latitude: json['gps_lat'] != null ? double.tryParse(json['gps_lat'].toString()) : null,
      longitude: json['gps_long'] != null ? double.tryParse(json['gps_long'].toString()) : null,
      // [BARU]
      establishedDate: json['established_date'],
    );
  }
}

=== FILE: lib/models/production_schedule_model.dart ===

class ProductionSchedule {
  final String id;
  final DateTime date;
  final String menuId;
  final String menuName; // Dari relasi
  final int totalPortions;
  final String? startCookingTime; // Format "HH:mm:ss"
  final String? targetFinishTime; // Format "HH:mm:ss"
  final String? notes;

  ProductionSchedule({
    required this.id,
    required this.date,
    required this.menuId,
    required this.menuName,
    required this.totalPortions,
    this.startCookingTime,
    this.targetFinishTime,
    this.notes,
  });

  factory ProductionSchedule.fromJson(Map<String, dynamic> json) {
    return ProductionSchedule(
      id: json['id'].toString(),
      date: DateTime.parse(json['date']),
      menuId: json['menu_id'].toString(),
      menuName: json['menus'] != null ? json['menus']['name'] : 'Menu ?',
      totalPortions: json['total_portions'] != null ? int.parse(json['total_portions'].toString()) : 0,
      startCookingTime: json['start_cooking_time'],
      targetFinishTime: json['target_finish_time'],
      notes: json['notes'],
    );
  }
}

=== FILE: lib/models/delivery_stops_rows.sql ===

INSERT INTO "public"."delivery_stops" ("id", "route_id", "school_id", "sequence_order", "status", "arrival_time", "completion_time", "received_qty", "reception_notes", "proof_photo_url", "recipient_name", "admin_response", "resolved_at") VALUES ('0791fc1e-ae4f-43f2-99dd-6ea946b216f1', '94b7e1ef-71e2-457e-b5fd-3311f7422e74', '00cf74b3-1b05-4459-b049-2b311e2c0037', '1', 'completed', '2025-11-24 01:33:29.759665+00', '2025-11-24 01:30:03.794677+00', '600', 'dasd', null, 'Koordinator', null, null), ('23075b46-4c52-41ce-a6f8-0be649e6e366', '5d87d20e-7da7-4b94-83b0-e24a078053e0', '222afd5d-8889-4ac8-b371-bbf13018cc4b', '1', 'completed', '2025-11-24 22:46:20.637201+00', null, '0', null, null, null, null, null), ('32523831-71e7-4ac0-973b-0638ac55acb7', '1cadb24c-8aae-4f2c-b847-1bc75291c2e6', '2f004c1b-6353-4f28-99de-9b833bcc73cf', '3', 'pending', null, null, '0', null, null, null, null, null), ('3af35d4f-b77b-4bae-a5ca-05f9891d6ec0', '458acb66-01d4-4ce1-bf17-5a0a7c5c936f', '222afd5d-8889-4ac8-b371-bbf13018cc4b', '1', 'completed', '2025-11-24 01:32:19.718942+00', null, '0', null, null, null, null, null), ('3b6322ee-0308-4b02-83c8-eeb1ea2e0d6d', '458acb66-01d4-4ce1-bf17-5a0a7c5c936f', '00cf74b3-1b05-4459-b049-2b311e2c0037', '2', 'completed', '2025-11-24 01:32:21.910984+00', null, '0', null, null, null, null, null), ('5f5ae387-cf00-4df0-91c7-8d2945bb4e3f', 'ce7af878-38da-4a8a-abbe-5a294f758e03', '222afd5d-8889-4ac8-b371-bbf13018cc4b', '1', 'completed', '2025-11-24 01:33:19.555219+00', null, '0', null, null, null, null, null), ('abec31cc-f32e-46b6-8d0a-86d3ed3ff73d', '1cadb24c-8aae-4f2c-b847-1bc75291c2e6', '222afd5d-8889-4ac8-b371-bbf13018cc4b', '1', 'completed', '2025-11-24 21:04:39.889143+00', null, '0', null, null, null, null, null), ('b093c1e4-a8c1-4ade-84fc-d73d7e3d2bf5', '79ba0939-b721-470b-b883-10ebb5448aaf', '222afd5d-8889-4ac8-b371-bbf13018cc4b', '1', 'completed', '2025-11-22 19:51:57.991588+00', null, '0', null, null, null, null, null), ('c57acf07-6b14-42bf-b2f7-22a786198270', 'b2b95be7-cdc0-4473-a364-4f7aaba5d204', '00cf74b3-1b05-4459-b049-2b311e2c0037', '1', 'completed', '2025-11-24 21:08:34.490315+00', null, '0', null, null, null, null, null), ('d99818fd-7b3a-4c76-ae9f-986a0ac2d53c', '239f2c9c-cd5a-4dac-987a-49619f0ebabf', '00cf74b3-1b05-4459-b049-2b311e2c0037', '1', 'completed', '2025-11-24 21:00:29.439707+00', null, '0', null, null, null, null, null), ('fd60aaf4-ab36-4705-85b9-77e5481933f5', '7dec8216-1475-4ddb-8a8e-c6153eac3ad2', '2f004c1b-6353-4f28-99de-9b833bcc73cf', '2', 'completed', '2025-11-24 21:25:24.149171+00', null, '0', null, null, null, null, null), ('ffa434b3-6f6c-42af-a3de-832fb9efd8f2', 'b2b95be7-cdc0-4473-a364-4f7aaba5d204', '2f004c1b-6353-4f28-99de-9b833bcc73cf', '2', 'pending', null, null, '0', null, null, null, null, null);

=== FILE: lib/models/profiles_rows.sql ===

INSERT INTO "public"."profiles" ("id", "full_name", "role", "sppg_id", "school_id", "created_at", "email", "class_name") VALUES ('239cad3e-219d-428f-ac63-fb8b902f4857', 'budi', 'kurir', '894cc1e5-d726-4f7b-8f49-2fe8970ce539', null, '2025-11-25 06:57:19.850207+00', 'budikurir@gmail.com', null), ('299ae383-acb7-40ea-a9c4-28c517d2e602', 'Rezky', 'koordinator', '894cc1e5-d726-4f7b-8f49-2fe8970ce539', '00cf74b3-1b05-4459-b049-2b311e2c0037', '2025-11-23 11:12:02.342492+00', 'bahlil@gmail.com', null), ('52df0c3d-084d-4e3d-a9fe-8ae9ce923b95', 'Bowo', 'walikelas', '894cc1e5-d726-4f7b-8f49-2fe8970ce539', '00cf74b3-1b05-4459-b049-2b311e2c0037', '2025-11-23 12:59:48.987222+00', 'fufufafa@gmail.com', '8B'), ('575538d0-ec9f-4ade-ac19-8c17f1453900', 'Admin SPPG Sukajaya Lembang 1', 'admin_sppg', '894cc1e5-d726-4f7b-8f49-2fe8970ce539', null, '2025-11-19 10:53:11.029485+00', 'sukajaya@gmail.com', null), ('87c98256-6c40-4fe4-a83c-67f11730b937', 'Admin BGN', 'bgn', null, null, '2025-11-19 06:24:35.685412+00', 'pengawasbgn@gmail.com', null), ('99edd030-5b13-4596-bf3a-d8a94b4cb4c0', 'Udin Jamaludin', 'kurir', '894cc1e5-d726-4f7b-8f49-2fe8970ce539', null, '2025-11-19 12:04:25.797976+00', 'udin12@gmail.com', null);

=== FILE: lib/models/MBG.sql ===



=== FILE: lib/models/vehicle_model.dart ===

class Vehicle {
  final String id;
  final String sppgId;
  final String plateNumber; // Plat Nomor
  final String? driverName; // Nama Supir
  final int capacityLimit;  // Kapasitas Angkut (Porsi)
  final bool isActive;      // Status Siap Jalan?

  Vehicle({
    required this.id,
    required this.sppgId,
    required this.plateNumber,
    this.driverName,
    this.capacityLimit = 0,
    this.isActive = true,
  });

  factory Vehicle.fromJson(Map<String, dynamic> json) {
    return Vehicle(
      id: json['id'].toString(),
      sppgId: json['sppg_id'].toString(),
      plateNumber: json['plate_number'] ?? 'Tanpa Plat',
      driverName: json['driver_name'],
      capacityLimit: json['capacity_limit'] != null ? int.parse(json['capacity_limit'].toString()) : 0,
      isActive: json['is_active'] ?? true,
    );
  }

  Map<String, dynamic> toJson() {
    return {
      'sppg_id': sppgId,
      'plate_number': plateNumber,
      'driver_name': driverName,
      'capacity_limit': capacityLimit,
      'is_active': isActive,
    };
  }
}

=== FILE: lib/models/courier_model.dart ===

class CourierModel {
  final String id;
  final String name; // Dipetakan dari full_name di tabel profiles
  final String email; 
  final String? sppgId; // SPPG tempat kurir bertugas

  CourierModel({
    required this.id,
    required this.name,
    required this.email,
    this.sppgId,
  });

  factory CourierModel.fromJson(Map<String, dynamic> json) {
    return CourierModel(
      id: json['id'].toString(),
      name: json['full_name'] ?? 'Kurir Tanpa Nama',
      email: json['email'] ?? 'Email tidak tersedia',
      sppgId: json['sppg_id'],
    );
  }
}

=== FILE: lib/models/route_model.dart ===

class DeliveryRoute {
  final String id;
  final String date; // Format YYYY-MM-DD
  final String vehicleId;
  final String courierId;
  final String status; // pending, active, completed

  // Variabel tambahan untuk join (opsional, buat tampilan nanti)
  final String? vehiclePlate; 
  final String? courierName;

  DeliveryRoute({
    required this.id,
    required this.date,
    required this.vehicleId,
    required this.courierId,
    this.status = 'pending',
    this.vehiclePlate,
    this.courierName,
  });

  factory DeliveryRoute.fromJson(Map<String, dynamic> json) {
    return DeliveryRoute(
      id: json['id'].toString(),
      date: json['date'],
      vehicleId: json['vehicle_id'].toString(),
      courierId: json['courier_id'].toString(),
      status: json['status'] ?? 'pending',
      // Supabase bisa return nested object kalau kita select join
      vehiclePlate: json['vehicles']?['plate_number'], 
      courierName: json['profiles']?['full_name'],
    );
  }
}

=== FILE: lib/models/menus_rows.sql ===

INSERT INTO "public"."menus" ("id", "sppg_id", "name", "category", "cooking_duration_minutes", "created_at") VALUES ('1e19318e-0127-46c6-886d-ec4f35e27009', '894cc1e5-d726-4f7b-8f49-2fe8970ce539', 'chicken katsu', 'Lauk Protein', '25', '2025-11-25 06:46:28.506069+00');

=== FILE: lib/models/user_profile.dart ===

class UserProfile {
  final String id;
  final String? email; // Email dari Auth Supabase
  final String? fullName;
  final String role; // 'bgn', 'admin_sppg', 'kurir', ...
  final String? sppgId;
  final String? schoolId;

  UserProfile({
    required this.id,
    this.email,
    this.fullName,
    required this.role,
    this.sppgId,
    this.schoolId,
  });

  // FIX: Email dijadikan parameter opsional. Mengambil data dari profiles
  factory UserProfile.fromJson(Map<String, dynamic> json, [String? email]) { 
    return UserProfile(
      id: json['id'],
      email: email, // Email dapet dari parameter opsional di AuthService
      fullName: json['full_name'],
      role: json['role'] ?? 'unknown',
      sppgId: json['sppg_id'],
      schoolId: json['school_id'],
    );
  }
}

=== FILE: lib/models/delivery_routes_rows.sql ===

INSERT INTO "public"."delivery_routes" ("id", "date", "sppg_id", "vehicle_id", "courier_id", "status", "start_time", "end_time") VALUES ('1cadb24c-8aae-4f2c-b847-1bc75291c2e6', '2025-11-25', '894cc1e5-d726-4f7b-8f49-2fe8970ce539', '8bf98689-1fc0-421b-b3e3-23dbcfe52eb9', '99edd030-5b13-4596-bf3a-d8a94b4cb4c0', 'active', null, null), ('239f2c9c-cd5a-4dac-987a-49619f0ebabf', '2025-11-23', '894cc1e5-d726-4f7b-8f49-2fe8970ce539', '8bf98689-1fc0-421b-b3e3-23dbcfe52eb9', '99edd030-5b13-4596-bf3a-d8a94b4cb4c0', 'active', null, null), ('458acb66-01d4-4ce1-bf17-5a0a7c5c936f', '2025-11-27', '894cc1e5-d726-4f7b-8f49-2fe8970ce539', '8bf98689-1fc0-421b-b3e3-23dbcfe52eb9', '99edd030-5b13-4596-bf3a-d8a94b4cb4c0', 'active', null, null), ('5d87d20e-7da7-4b94-83b0-e24a078053e0', '2025-11-20', '894cc1e5-d726-4f7b-8f49-2fe8970ce539', '8bf98689-1fc0-421b-b3e3-23dbcfe52eb9', '99edd030-5b13-4596-bf3a-d8a94b4cb4c0', 'active', null, null), ('79ba0939-b721-470b-b883-10ebb5448aaf', '2025-11-23', '894cc1e5-d726-4f7b-8f49-2fe8970ce539', '8bf98689-1fc0-421b-b3e3-23dbcfe52eb9', '99edd030-5b13-4596-bf3a-d8a94b4cb4c0', 'active', null, null), ('7dec8216-1475-4ddb-8a8e-c6153eac3ad2', '2025-11-24', '894cc1e5-d726-4f7b-8f49-2fe8970ce539', '8bf98689-1fc0-421b-b3e3-23dbcfe52eb9', '99edd030-5b13-4596-bf3a-d8a94b4cb4c0', 'active', null, null), ('94b7e1ef-71e2-457e-b5fd-3311f7422e74', '2025-11-24', '894cc1e5-d726-4f7b-8f49-2fe8970ce539', '8bf98689-1fc0-421b-b3e3-23dbcfe52eb9', '99edd030-5b13-4596-bf3a-d8a94b4cb4c0', 'active', null, null), ('b2b95be7-cdc0-4473-a364-4f7aaba5d204', '2025-11-24', '894cc1e5-d726-4f7b-8f49-2fe8970ce539', '8bf98689-1fc0-421b-b3e3-23dbcfe52eb9', '99edd030-5b13-4596-bf3a-d8a94b4cb4c0', 'active', null, null), ('ce7af878-38da-4a8a-abbe-5a294f758e03', '2025-11-24', '894cc1e5-d726-4f7b-8f49-2fe8970ce539', '8bf98689-1fc0-421b-b3e3-23dbcfe52eb9', '99edd030-5b13-4596-bf3a-d8a94b4cb4c0', 'active', null, null);

=== FILE: lib/features/autentikasi/screens/login_screen.dart ===

import 'package:flutter/material.dart';
import 'package:supabase_flutter/supabase_flutter.dart';

// Import Dashboard
import '../../pengawas/screens/dashboard_bgn_screen.dart';
import '../../admin_sppg/screens/dashboard_admin_screen.dart';
import '../../kurir/screens/dashboard_kurir_screen.dart';
import '../../koordinator/screens/dashboard_koordinator_screen.dart';
import '../../walikelas/screens/dashboard_teacher_screen.dart';

class LoginScreen extends StatefulWidget {
  const LoginScreen({super.key});

  @override
  State<LoginScreen> createState() => _LoginScreenState();
}

class _LoginScreenState extends State<LoginScreen> {
  final TextEditingController _emailController = TextEditingController();
  final TextEditingController _passwordController = TextEditingController();
  bool _isLoading = false;

  Future<void> _login() async {
    setState(() { _isLoading = true; });

    try {
      final email = _emailController.text.trim();
      final password = _passwordController.text.trim();

      if (email.isEmpty || password.isEmpty) {
        throw Exception("Email dan Password harus diisi.");
      }

      final AuthResponse res = await Supabase.instance.client.auth.signInWithPassword(
        email: email,
        password: password,
      );

      if (res.user == null) {
        throw Exception("Login gagal. Periksa kembali email & password Anda.");
      }

      if (!mounted) return;

      final userId = res.user!.id;
      final profileData = await Supabase.instance.client
          .from('profiles')
          .select()
          .eq('id', userId)
          .single();

      if (profileData == null) throw Exception("Profil user tidak ditemukan.");

      final String rawRole = profileData['role'] ?? 'unknown';
      final String role = rawRole.toLowerCase().trim(); 

      if (!mounted) return;

      if (role == 'bgn') {
        Navigator.pushReplacement(context, MaterialPageRoute(builder: (_) => const DashboardBgnScreen()));
      } else if (role == 'admin_sppg') {
        Navigator.pushReplacement(context, MaterialPageRoute(builder: (_) => const DashboardAdminScreen()));
      } else if (role == 'kurir') {
        Navigator.pushReplacement(context, MaterialPageRoute(builder: (_) => const DashboardKurirScreen()));
      } else if (role == 'koordinator') {
        Navigator.pushReplacement(context, MaterialPageRoute(builder: (_) => const DashboardKoordinatorScreen()));
      } else if (role == 'walikelas') { 
        Navigator.pushReplacement(context, MaterialPageRoute(builder: (_) => const DashboardTeacherScreen()));
      } else {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text("Akses Ditolak: Role '$rawRole' tidak dikenali."), backgroundColor: Colors.red),
        );
        await Supabase.instance.client.auth.signOut();
      }
    } catch (e) {
      if (!mounted) return;
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text("Gagal Masuk: ${e.toString().replaceAll('Exception:', '')}"), backgroundColor: Colors.red),
      );
    } finally {
      if (mounted) setState(() { _isLoading = false; });
    }
  }

  @override
  void dispose() {
    _emailController.dispose();
    _passwordController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Center(
        child: SingleChildScrollView(
          padding: const EdgeInsets.all(24.0),
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              const Icon(Icons.security, size: 80, color: Colors.blue),
              const SizedBox(height: 20),
              const Text("MBG Monitoring", style: TextStyle(fontSize: 24, fontWeight: FontWeight.bold)),
              const Text("Silakan masuk untuk melanjutkan", style: TextStyle(color: Colors.grey)),
              const SizedBox(height: 40),
              TextField(
                controller: _emailController,
                keyboardType: TextInputType.emailAddress,
                decoration: const InputDecoration(labelText: "Email", border: OutlineInputBorder(), prefixIcon: Icon(Icons.email)),
              ),
              const SizedBox(height: 16),
              TextField(
                controller: _passwordController,
                obscureText: true,
                decoration: const InputDecoration(labelText: "Password", border: OutlineInputBorder(), prefixIcon: Icon(Icons.lock)),
              ),
              const SizedBox(height: 30),
              SizedBox(
                width: double.infinity,
                height: 50,
                child: ElevatedButton(
                  onPressed: _isLoading ? null : _login,
                  style: ElevatedButton.styleFrom(backgroundColor: Colors.blue[800], foregroundColor: Colors.white, shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(10))),
                  child: _isLoading
                      ? const CircularProgressIndicator(color: Colors.white)
                      : const Text("MASUK", style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold)),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}

=== FILE: lib/features/autentikasi/services/auth_service.dart ===

import 'package:supabase_flutter/supabase_flutter.dart';
import '../../../models/user_profile.dart';

class AuthService {
  final SupabaseClient _supabase = Supabase.instance.client;

  // Fungsi Login
  Future<UserProfile?> signIn({
    required String email,
    required String password,
  }) async {
    try {
      // 1. Login ke Auth Supabase (Cek Email & Password)
      final AuthResponse response = await _supabase.auth.signInWithPassword(
        email: email,
        password: password,
      );

      if (response.user == null) {
        throw 'Login gagal: User tidak ditemukan';
      }

      final userId = response.user!.id;
      final userEmail = response.user!.email;

      // 2. Ambil Data Profil & Role dari Tabel 'profiles'
      // Kita select data berdasarkan ID user yang barusan login
      final data = await _supabase
          .from('profiles')
          .select()
          .eq('id', userId)
          .single();

      // 3. Kembalikan sebagai objek UserProfile
      return UserProfile.fromJson(data, userEmail);

    } on AuthException catch (e) {
      // Error khusus Supabase (misal: password salah)
      throw e.message;
    } catch (e) {
      // Error umum lainnya
      throw 'Terjadi kesalahan: $e';
    }
  }

  // Fungsi Logout
  Future<void> signOut() async {
    await _supabase.auth.signOut();
  }

  // Cek apakah ada user yang sedang login (untuk auto-login)
  User? getCurrentUser() {
    return _supabase.auth.currentUser;
  }
}

=== FILE: lib/features/shared/services/request_service.dart ===

import 'package:supabase_flutter/supabase_flutter.dart';
import 'package:intl/intl.dart';

class ChangeRequestModel {
  final String id;
  final String type; // schedule, menu, portion
  final String details;
  final String status; // pending, approved, rejected
  final String? adminResponse;
  final String requestDate;
  final String schoolName; // Nama Sekolah pengirim

  ChangeRequestModel({
    required this.id,
    required this.type,
    required this.details,
    required this.status,
    this.adminResponse,
    required this.requestDate,
    required this.schoolName,
  });

  factory ChangeRequestModel.fromJson(Map<String, dynamic> json) {
    return ChangeRequestModel(
      id: json['id'].toString(),
      type: json['request_type'] ?? '-',
      details: json['details'] ?? '-',
      status: json['status'] ?? 'pending',
      adminResponse: json['admin_response'],
      requestDate: DateFormat('dd MMM yyyy').format(DateTime.parse(json['created_at'])),
      schoolName: json['schools'] != null ? json['schools']['name'] : 'Sekolah',
    );
  }
}

class RequestService {
  final _supabase = Supabase.instance.client;

  // --- 1. KOORDINATOR: KIRIM REQUEST ---
  Future<void> submitRequest({
    required String type,
    required String details,
  }) async {
    try {
      final userId = _supabase.auth.currentUser!.id;
      
      // Cari Info Sekolah & SPPG Koordinator
      final profile = await _supabase.from('profiles')
          .select('school_id, sppg_id')
          .eq('id', userId)
          .single();
      
      await _supabase.from('change_requests').insert({
        'requester_id': userId,
        'school_id': profile['school_id'],
        'sppg_id': profile['sppg_id'],
        'request_type': type,
        'details': details,
        'status': 'pending',
      });
    } catch (e) {
      throw Exception("Gagal kirim request: $e");
    }
  }

  // --- 2. KOORDINATOR: LIHAT HISTORY REQUEST SAYA ---
  Future<List<ChangeRequestModel>> getMyRequests() async {
    final userId = _supabase.auth.currentUser!.id;
    final response = await _supabase
        .from('change_requests')
        .select('*, schools(name)')
        .eq('requester_id', userId)
        .order('created_at', ascending: false);
        
    final List<dynamic> data = response;
    return data.map((json) => ChangeRequestModel.fromJson(json)).toList();
  }

  // --- 3. ADMIN: LIHAT SEMUA REQUEST MASUK (INBOX) ---
  Future<List<ChangeRequestModel>> getIncomingRequests() async {
    final userId = _supabase.auth.currentUser!.id;
    // Cari SPPG ID Admin
    final profile = await _supabase.from('profiles').select('sppg_id').eq('id', userId).single();
    final mySppgId = profile['sppg_id'];

    final response = await _supabase
        .from('change_requests')
        .select('*, schools(name)')
        .eq('sppg_id', mySppgId)
        .order('created_at', ascending: false);

    final List<dynamic> data = response;
    return data.map((json) => ChangeRequestModel.fromJson(json)).toList();
  }

  // --- 4. ADMIN: RESPON REQUEST (TERIMA/TOLAK) ---
  Future<void> respondRequest(String id, String status, String responseText) async {
    await _supabase.from('change_requests').update({
      'status': status,
      'admin_response': responseText,
      'updated_at': DateTime.now().toIso8601String(),
    }).eq('id', id);
  }
}

=== FILE: lib/features/koordinator/screens/coordinator_request_screen.dart ===

import 'package:flutter/material.dart';
import '../../shared/services/request_service.dart'; // Sesuaikan path

class CoordinatorRequestScreen extends StatefulWidget {
  const CoordinatorRequestScreen({super.key});

  @override
  State<CoordinatorRequestScreen> createState() => _CoordinatorRequestScreenState();
}

class _CoordinatorRequestScreenState extends State<CoordinatorRequestScreen> {
  final RequestService _service = RequestService();
  final _detailsController = TextEditingController();
  String _selectedType = 'Perubahan Jadwal';
  bool _isLoading = false;

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: const Text("Pengajuan Perubahan"), backgroundColor: Colors.teal),
      body: Column(
        children: [
          // --- FORM PENGAJUAN ---
          Padding(
            padding: const EdgeInsets.all(16.0),
            child: Card(
              elevation: 3,
              child: Padding(
                padding: const EdgeInsets.all(16.0),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    const Text("Buat Pengajuan Baru", style: TextStyle(fontWeight: FontWeight.bold, fontSize: 16)),
                    const SizedBox(height: 10),
                    DropdownButtonFormField<String>(
                      value: _selectedType,
                      decoration: const InputDecoration(labelText: "Jenis Pengajuan", border: OutlineInputBorder()),
                      items: ['Perubahan Jadwal', 'Perubahan Menu', 'Tambah/Kurang Porsi']
                          .map((e) => DropdownMenuItem(value: e, child: Text(e))).toList(),
                      onChanged: (val) => setState(() => _selectedType = val!),
                    ),
                    const SizedBox(height: 10),
                    TextField(
                      controller: _detailsController,
                      maxLines: 3,
                      decoration: const InputDecoration(
                        labelText: "Detail Permintaan", 
                        hintText: "Contoh: Mohon kirim jam 10 karena ada ujian.",
                        border: OutlineInputBorder()
                      ),
                    ),
                    const SizedBox(height: 10),
                    SizedBox(
                      width: double.infinity,
                      child: ElevatedButton.icon(
                        onPressed: _isLoading ? null : _submit,
                        icon: const Icon(Icons.send),
                        label: const Text("Kirim Pengajuan"),
                        style: ElevatedButton.styleFrom(backgroundColor: Colors.teal, foregroundColor: Colors.white),
                      ),
                    )
                  ],
                ),
              ),
            ),
          ),
          
          const Divider(),
          
          // --- LIST RIWAYAT ---
          const Padding(
            padding: EdgeInsets.all(8.0),
            child: Text("Riwayat Pengajuan", style: TextStyle(fontWeight: FontWeight.bold, color: Colors.grey)),
          ),
          Expanded(child: _buildHistoryList()),
        ],
      ),
    );
  }

  Future<void> _submit() async {
    if (_detailsController.text.isEmpty) return;
    setState(() => _isLoading = true);
    try {
      await _service.submitRequest(type: _selectedType, details: _detailsController.text);
      _detailsController.clear();
      setState(() {}); // Refresh list
      if(mounted) ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Terkirim!")));
    } catch (e) {
      if(mounted) ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Error: $e")));
    } finally {
      setState(() => _isLoading = false);
    }
  }

  Widget _buildHistoryList() {
    return FutureBuilder<List<ChangeRequestModel>>(
      future: _service.getMyRequests(),
      builder: (context, snapshot) {
        if (snapshot.connectionState == ConnectionState.waiting) return const Center(child: CircularProgressIndicator());
        final data = snapshot.data ?? [];
        if (data.isEmpty) return const Center(child: Text("Belum ada riwayat."));

        return ListView.builder(
          itemCount: data.length,
          itemBuilder: (ctx, i) {
            final item = data[i];
            Color statusColor = Colors.orange;
            if (item.status == 'approved') statusColor = Colors.green;
            if (item.status == 'rejected') statusColor = Colors.red;

            return ListTile(
              title: Text(item.type, style: const TextStyle(fontWeight: FontWeight.bold)),
              subtitle: Text("${item.details}\nRespon: ${item.adminResponse ?? '-'}", style: const TextStyle(fontSize: 12)),
              trailing: Chip(
                label: Text(item.status.toUpperCase(), style: const TextStyle(color: Colors.white, fontSize: 10)),
                backgroundColor: statusColor,
              ),
            );
          },
        );
      },
    );
  }
}

=== FILE: lib/features/koordinator/screens/dashboard_koordinator_screen.dart ===

import 'dart:io';
import 'package:flutter/material.dart';
import 'package:image_picker/image_picker.dart';
import 'package:supabase_flutter/supabase_flutter.dart';

import '../../autentikasi/screens/login_screen.dart';
import '../services/receiving_service.dart';
// Import Storage Service baru
import '../../../core/services/storage_service.dart'; 
import '../../../core/screens/profile_screen.dart';

// [BARU] Import Layar Request Koordinator
import 'coordinator_request_screen.dart'; 

class DashboardKoordinatorScreen extends StatefulWidget {
  const DashboardKoordinatorScreen({super.key});

  @override
  State<DashboardKoordinatorScreen> createState() => _DashboardKoordinatorScreenState();
}

class _DashboardKoordinatorScreenState extends State<DashboardKoordinatorScreen> {
  final ReceivingService _service = ReceivingService();
  final StorageService _storageService = StorageService();
  
  Map<String, dynamic>? _deliveryData;
  bool _isLoading = true;

  @override
  void initState() {
    super.initState();
    _fetchData();
  }

  Future<void> _fetchData() async {
    setState(() => _isLoading = true);
    try {
      final data = await _service.getTodayDelivery();
      if (mounted) setState(() => _deliveryData = data);
    } catch (e) {
      // ignore
    } finally {
      if (mounted) setState(() => _isLoading = false);
    }
  }

  Future<void> _logout() async {
    await Supabase.instance.client.auth.signOut();
    if (!mounted) return;
    Navigator.of(context).pushAndRemoveUntil(
      MaterialPageRoute(builder: (_) => const LoginScreen()),
      (route) => false,
    );
  }

  // --- LOGIKA DIALOG KONFIRMASI / LAPOR MASALAH ---
  void _showConfirmationDialog(String stopId) {
    final qtyController = TextEditingController();
    final noteController = TextEditingController();
    
    File? photoFile;
    bool isProblem = false; 
    bool isSubmitting = false;

    showDialog(
      context: context,
      barrierDismissible: false,
      builder: (ctx) {
        return StatefulBuilder(
          builder: (context, setDialogState) {
            return AlertDialog(
              title: const Text("Konfirmasi Penerimaan"),
              content: SingleChildScrollView(
                child: Column(
                  mainAxisSize: MainAxisSize.min,
                  children: [
                    // Pilihan Status
                    Row(
                      children: [
                        Expanded(
                          child: ChoiceChip(
                            label: const Text("✅ Aman"),
                            selected: !isProblem,
                            selectedColor: Colors.green[100],
                            onSelected: (val) => setDialogState(() => isProblem = !val),
                          ),
                        ),
                        const SizedBox(width: 10),
                        Expanded(
                          child: ChoiceChip(
                            label: const Text("⚠️ Masalah"),
                            selected: isProblem,
                            selectedColor: Colors.red[100],
                            onSelected: (val) => setDialogState(() => isProblem = val),
                          ),
                        ),
                      ],
                    ),
                    const SizedBox(height: 15),

                    TextField(
                      controller: qtyController,
                      keyboardType: TextInputType.number,
                      decoration: const InputDecoration(labelText: "Jml Diterima", border: OutlineInputBorder()),
                    ),
                    const SizedBox(height: 10),
                    
                    TextField(
                      controller: noteController,
                      decoration: InputDecoration(
                        labelText: isProblem ? "Jelaskan Kerusakan/Kekurangan" : "Catatan (Opsional)", 
                        border: const OutlineInputBorder()
                      ),
                      maxLines: 2,
                    ),
                    const SizedBox(height: 10),

                    // Tombol Kamera
                    if (isProblem)
                      GestureDetector(
                        onTap: () async {
                          final file = await _storageService.pickImage(ImageSource.camera);
                          if (file != null) {
                            setDialogState(() => photoFile = file);
                          }
                        },
                        child: Container(
                          height: 100,
                          width: double.infinity,
                          decoration: BoxDecoration(
                            color: Colors.grey[200],
                            border: Border.all(color: Colors.grey),
                            borderRadius: BorderRadius.circular(8),
                          ),
                          child: photoFile == null
                              ? const Column(
                                  mainAxisAlignment: MainAxisAlignment.center,
                                  children: [Icon(Icons.camera_alt), Text("Ambil Foto Bukti")],
                                )
                              : Image.file(photoFile!, fit: BoxFit.cover),
                        ),
                      ),
                      
                     if (isSubmitting)
                       const Padding(
                         padding: EdgeInsets.only(top: 15),
                         child: CircularProgressIndicator(),
                       )
                  ],
                ),
              ),
              actions: [
                if (!isSubmitting)
                  TextButton(onPressed: () => Navigator.pop(ctx), child: const Text("Batal")),
                
                if (!isSubmitting)
                  ElevatedButton(
                    style: ElevatedButton.styleFrom(
                      backgroundColor: isProblem ? Colors.red : Colors.teal,
                      foregroundColor: Colors.white
                    ),
                    onPressed: () async {
                      if (isProblem && photoFile == null) {
                        ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Wajib sertakan foto jika ada masalah!")));
                        return;
                      }
                      
                      setDialogState(() => isSubmitting = true);

                      try {
                        String? imageUrl;
                        if (photoFile != null) {
                          imageUrl = await _storageService.uploadEvidence(photoFile!, 'stops');
                        }

                        await _service.confirmReception(
                          stopId: stopId,
                          receivedQty: int.tryParse(qtyController.text) ?? 0,
                          notes: isProblem ? "[MASALAH] ${noteController.text}" : noteController.text,
                          recipientName: "Koordinator", 
                          issueType: isProblem ? 'problem' : null,
                          proofUrl: imageUrl,
                        );

                        if (!mounted) return;
                        Navigator.pop(ctx);
                        _fetchData(); 
                        ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Laporan Terkirim!")));

                      } catch (e) {
                         setDialogState(() => isSubmitting = false);
                         ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Gagal: $e")));
                      }
                    },
                    child: Text(isProblem ? "Lapor Masalah" : "Terima Barang"),
                  )
              ],
            );
          },
        );
      },
    );
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text("Portal Sekolah"),
        backgroundColor: Colors.teal[700],
        foregroundColor: Colors.white,
        actions: [
          // [BARU] Tombol Pengajuan Perubahan (Request)
          IconButton(
            icon: const Icon(Icons.edit_document),
            tooltip: "Ajukan Perubahan",
            onPressed: () {
              Navigator.push(
                context,
                MaterialPageRoute(builder: (_) => const CoordinatorRequestScreen()),
              );
            },
          ),
          
          // Tombol Profil
          IconButton(
            icon: const Icon(Icons.account_circle, size: 30), 
            tooltip: "Profil Saya",
            onPressed: () {
              Navigator.push(
                context,
                MaterialPageRoute(builder: (_) => const ProfileScreen()),
              );
            },
          ),
        ],
      ),
      body: _isLoading 
        ? const Center(child: CircularProgressIndicator())
        : _deliveryData == null
            ? const Center(child: Text("Tidak ada jadwal pengiriman hari ini."))
            : Padding(
                padding: const EdgeInsets.all(16.0),
                child: Column(
                  children: [
                    _buildStatusCard(),
                  ],
                ),
              ),
    );
  }

  Widget _buildStatusCard() {
    final status = _deliveryData!['status'];
    final vehicle = _deliveryData!['delivery_routes']['vehicles'];
    final plat = vehicle != null ? vehicle['plate_number'] : '-';
    
    Color statusColor = Colors.grey;
    String statusText = "Menunggu";
    
    if (status == 'completed') { 
      statusColor = Colors.orange;
      statusText = "Barang Tiba - Perlu Konfirmasi";
    } else if (status == 'received') {
      statusColor = Colors.green;
      statusText = "Selesai - Diterima";
    } else if (status == 'issue_reported') { 
      statusColor = Colors.red;
      statusText = "Masalah Dilaporkan";
    }

    return Card(
      elevation: 4,
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(15)),
      child: Padding(
        padding: const EdgeInsets.all(20.0),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              children: [
                Icon(Icons.local_shipping, size: 40, color: statusColor),
                const SizedBox(width: 15),
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      const Text("Pengiriman Hari Ini", style: TextStyle(fontSize: 14, color: Colors.grey)),
                      Text(statusText, style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold, color: statusColor)),
                    ],
                  ),
                ),
              ],
            ),
            const Divider(height: 30),
            Text("Mobil: $plat", style: const TextStyle(fontSize: 16)),
            
            const SizedBox(height: 20),
            
            if (status == 'completed')
              SizedBox(
                width: double.infinity,
                child: ElevatedButton.icon(
                  onPressed: () => _showConfirmationDialog(_deliveryData!['id']),
                  style: ElevatedButton.styleFrom(
                    backgroundColor: Colors.teal,
                    foregroundColor: Colors.white,
                    padding: const EdgeInsets.symmetric(vertical: 15)
                  ),
                  icon: const Icon(Icons.check_circle_outline),
                  label: const Text("KONFIRMASI PENERIMAAN"),
                ),
              )
          ],
        ),
      ),
    );
  }
}

=== FILE: lib/features/koordinator/services/receiving_service.dart ===

import 'package:supabase_flutter/supabase_flutter.dart';
import 'package:intl/intl.dart';

class ReceivingService {
  final _supabase = Supabase.instance.client;

  // 1. AMBIL INFO PENGIRIMAN HARI INI (Untuk Sekolah si Koordinator)
  Future<Map<String, dynamic>?> getTodayDelivery() async {
    try {
      final userId = _supabase.auth.currentUser!.id;

      // A. Cari School ID milik Koordinator
      final profile = await _supabase
          .from('profiles')
          .select('school_id')
          .eq('id', userId)
          .single();

      final String? mySchoolId = profile['school_id'];
      if (mySchoolId == null)
        throw Exception("Akun ini tidak terhubung ke sekolah manapun.");

      // B. Cari Pengiriman hari ini ke sekolah tersebut
      final String today = DateFormat('yyyy-MM-dd').format(DateTime.now());

      // Join: delivery_stops -> delivery_routes (filter tanggal) -> vehicles
      final response = await _supabase
          .from('delivery_stops')
          .select(
            '*, delivery_routes!inner(date, vehicles(plate_number, driver_name))',
          )
          .eq('school_id', mySchoolId)
          .eq('delivery_routes.date', today)
          .maybeSingle(); // Ambil 1 aja

      return response; // Bisa null kalau belum ada jadwal
    } catch (e) {
      throw Exception("Gagal ambil data pengiriman: $e");
    }
  }

  // 2. KONFIRMASI PENERIMAAN
  Future<void> confirmReception({
    required String stopId,
    required int receivedQty,
    required String notes,
    required String recipientName,
    String?
    issueType, // Baru: Jenis Masalah (Misal: 'damaged', 'spoiled', 'less_qty')
    String? proofUrl, // Baru: URL Foto Bukti
  }) async {
    try {
      // Tentukan status: Kalau ada issue -> 'issue_reported', kalau aman -> 'received'
      // Atau tetap 'received' tapi ada flag issue. Kita pakai status khusus biar admin notice.
      final String status = (issueType != null && issueType.isNotEmpty)
          ? 'issue_reported'
          : 'received';

      await _supabase
          .from('delivery_stops')
          .update({
            'status': status,
            'received_qty': receivedQty,
            'reception_notes': notes,
            'recipient_name': recipientName,
            'completion_time': DateTime.now().toIso8601String(),
            // Pastikan kolom ini sudah ada di DB (Langkah SQL di bawah)
            'proof_photo_url': proofUrl,
            // Kita simpan jenis masalah di notes atau kolom baru (sementara di notes dulu gapapa)
            // Idealnya bikin kolom 'issue_type' di DB, tapi notes cukup: "[RUSAK] Catatan..."
          })
          .eq('id', stopId);
    } catch (e) {
      throw Exception("Gagal konfirmasi: $e");
    }
  }
}


=== FILE: .env ===

SUPABASE_URL=https://mqyfrqgfpqwlrloqtpvi.supabase.co
SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1xeWZycWdmcHF3bHJsb3F0cHZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0NTMxMDMsImV4cCI6MjA3OTAyOTEwM30.KoXKouhFN0H7Iz9MSnRhFQuBIePVMwWyXmrzSv3rEeQ

=== FILE: pubspec.yaml ===

name: rpll
description: "A new Flutter project."
publish_to: 'none' # Remove this line if you wish to publish to pub.dev
version: 1.0.0+1

environment:
  sdk: ^3.9.2


dependencies:
  flutter:
    sdk: flutter

 # Icons
  cupertino_icons: ^1.0.8

  # Backend & Database
  supabase_flutter: ^2.10.3
  
  # Fitur Hardware & Lokasi
  google_maps_flutter: ^2.14.0
  geolocator: ^14.0.2
  camera: ^0.11.3
  image_picker: ^1.2.1
  
  # State Management & Routing
  provider: ^6.1.5+1
  go_router: ^17.0.0
  
  # Utilitas
  intl: ^0.20.2
  flutter_dotenv: ^6.0.0
  flutter_map: ^8.2.2
  latlong2: ^0.9.1
  http: ^1.6.0
  url_launcher: ^6.3.2
  fl_chart: ^1.1.1
  table_calendar: ^3.2.0

dev_dependencies:
  flutter_test:
    sdk: flutter
  flutter_lints: ^5.0.0

flutter:
  uses-material-design: true

  # Bagian ini yang paling PENTING spasinya harus pas
  assets:
    - .env

=== FILE: android/app/src/main/AndroidManifest.xml ===

<manifest xmlns:android="http://schemas.android.com/apk/res/android">
    
    <uses-permission android:name="android.permission.INTERNET"/>
    <uses-permission android:name="android.permission.ACCESS_FINE_LOCATION"/>
    <uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION"/>
    <uses-permission android:name="android.permission.CAMERA"/>
    <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"/>
    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"/>
    
    <queries>
        <intent>
            <action android:name="android.intent.action.VIEW" />
            <data android:scheme="google.navigation" />
        </intent>
        <intent>
            <action android:name="android.intent.action.VIEW" />
            <data android:scheme="geo" />
        </intent>
        <intent>
            <action android:name="android.intent.action.VIEW" />
            <data android:scheme="https" />
        </intent>
        <intent>
            <action android:name="android.intent.action.PROCESS_TEXT"/>
            <data android:mimeType="text/plain"/>
        </intent>
    </queries>
    
    <application
        android:label="SMASH"
        android:name="${applicationName}"
        android:icon="@mipmap/ic_launcher">
        <activity
            android:name=".MainActivity"
            android:exported="true"
            android:launchMode="singleTop"
            android:taskAffinity=""
            android:theme="@style/LaunchTheme"
            android:configChanges="orientation|keyboardHidden|keyboard|screenSize|smallestScreenSize|locale|layoutDirection|fontScale|screenLayout|density|uiMode"
            android:hardwareAccelerated="true"
            android:windowSoftInputMode="adjustResize">
            <meta-data
              android:name="io.flutter.embedding.android.NormalTheme"
              android:resource="@style/NormalTheme"
              />
            <intent-filter>
                <action android:name="android.intent.action.MAIN"/>
                <category android:name="android.intent.category.LAUNCHER"/>
            </intent-filter>
        </activity>
        <meta-data
            android:name="flutterEmbedding"
            android:value="2" />
    </application>
</manifest>
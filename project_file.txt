
=== FILE: lib/main.dart ===
import 'package:flutter/material.dart';import 'package:flutter_dotenv/flutter_dotenv.dart';import 'package:supabase_flutter/supabase_flutter.dart';// [BARU] Import ini wajib biar format tanggal Indonesia jalanimport 'package:intl/date_symbol_data_local.dart';// Import halaman loginimport 'features/autentikasi/screens/login_screen.dart';void main() async {WidgetsFlutterBinding.ensureInitialized();// 1. Muat file rahasia .envawait dotenv.load(fileName: ".env");// 2. Nyalakan Koneksi Supabaseawait Supabase.initialize(url: dotenv.env['SUPABASE_URL']!,anonKey: dotenv.env['SUPABASE_ANON_KEY']!,);// [BARU] 3. Inisialisasi Format Tanggal Bahasa Indonesia// Ini biar DateFormat('EEEE, d MMMM yyyy', 'id_ID') gak errorawait initializeDateFormatting('id_ID', null);runApp(const MyApp());}class MyApp extends StatelessWidget {const MyApp({super.key});@overrideWidget build(BuildContext context) {return MaterialApp(title: 'MBG Logistics',debugShowCheckedModeBanner: false,theme: ThemeData(colorScheme: ColorScheme.fromSeed(seedColor: Colors.green),useMaterial3: true,inputDecorationTheme: const InputDecorationTheme(border: OutlineInputBorder(),filled: true,fillColor: Colors.white,),),home: const LoginScreen(),);}}

=== FILE: lib/models/school_model.dart ===
class School {final String id;final String sppgId;final String name;final String? address;final double? latitude;final double? longitude;final int studentCount;final String? deadlineTime;final int serviceTimeMinutes;final bool isHighRisk;// [BARU] Field untuk VRP Constraintsfinal int toleranceMinutes;final String? menuDefault;School({required this.id,required this.sppgId,required this.name,this.address,this.latitude,this.longitude,this.studentCount = 0,this.deadlineTime,this.serviceTimeMinutes = 10,this.isHighRisk = false,this.toleranceMinutes = 45, // Default 45 menitthis.menuDefault,});factory School.fromJson(Map<String, dynamic> json) {return School(id: json['id'].toString(),sppgId: json['sppg_id'].toString(),name: json['name'] ?? 'Tanpa Nama Sekolah',address: json['address'],latitude: json['gps_lat'] != null ? double.tryParse(json['gps_lat'].toString()) : null,longitude: json['gps_long'] != null ? double.tryParse(json['gps_long'].toString()) : null,studentCount: json['student_count'] != null ? int.parse(json['student_count'].toString()) : 0,serviceTimeMinutes: json['service_time_minutes'] != null ? int.parse(json['service_time_minutes'].toString()) : 10,isHighRisk: json['is_high_risk'] ?? false,deadlineTime: json['deadline_time'],// [BARU] Parsing kolom tambahantoleranceMinutes: json['tolerance_minutes'] != null ? int.parse(json['tolerance_minutes'].toString()) : 45,menuDefault: json['menu_default'],);}Map<String, dynamic> toJson() {return {'sppg_id': sppgId,'name': name,'address': address,'gps_lat': latitude,'gps_long': longitude,'student_count': studentCount,'deadline_time': deadlineTime,'service_time_minutes': serviceTimeMinutes,'is_high_risk': isHighRisk,// [BARU] Properti tambahan'tolerance_minutes': toleranceMinutes,'menu_default': menuDefault,};}}

=== FILE: lib/models/menu_model.dart ===
// === FILE: lib/models/menu_model.dart ===// ...class Menu {final String id;final String sppgId;final String name;final String category;final int cookingDurationMinutes;// [BARU] Waktu maksimal konsumsi setelah masak/terima (menit)final int maxConsumeMinutes;// [BARU GIZI]final int energy;final double protein;final double fat;final double carbs;Menu({required this.id,required this.sppgId,required this.name,required this.category,required this.cookingDurationMinutes,required this.maxConsumeMinutes, // [BARU]// [BARU GIZI]this.energy = 0,this.protein = 0.0,this.fat = 0.0,this.carbs = 0.0,});factory Menu.fromJson(Map<String, dynamic> json) {// Helper untuk parsing double, default 0.0double parseDouble(dynamic value) {if (value is num) return value.toDouble();if (value is String) return double.tryParse(value) ?? 0.0;return 0.0;}return Menu(id: json['id'].toString(),sppgId: json['sppg_id'].toString(),name: json['name'] ?? 'Menu Baru',category: json['category'] ?? 'Lain-lain',cookingDurationMinutes: json['cooking_duration_minutes'] != null? int.parse(json['cooking_duration_minutes'].toString()): 0,maxConsumeMinutes: json['max_consume_minutes'] != null? int.parse(json['max_consume_minutes'].toString()): 120,// [BARU GIZI]energy: json['energy'] != null? int.tryParse(json['energy'].toString()) ?? 0: 0,protein: parseDouble(json['protein']),fat: parseDouble(json['fat']),carbs: parseDouble(json['carbs']),);}Map<String, dynamic> toJson() {return {'sppg_id': sppgId,'name': name,'category': category,'cooking_duration_minutes': cookingDurationMinutes,'max_consume_minutes': maxConsumeMinutes,// [BARU GIZI]'energy': energy,'protein': protein,'fat': fat,'carbs': carbs,};}}

=== FILE: lib/models/sppg_model.dart ===
class Sppg {final String id;final String name;final String? address;final String? email;final String? phone;final double? latitude;final double? longitude;// [BARU]final String? establishedDate;Sppg({required this.id,required this.name,this.address,this.email,this.phone,this.latitude,this.longitude,this.establishedDate,});factory Sppg.fromJson(Map<String, dynamic> json) {return Sppg(id: json['id'].toString(),name: json['name'] ?? 'Tanpa Nama',address: json['address'],email: json['email'],phone: json['phone'],latitude: json['gps_lat'] != null ? double.tryParse(json['gps_lat'].toString()) : null,longitude: json['gps_long'] != null ? double.tryParse(json['gps_long'].toString()) : null,// [BARU]establishedDate: json['established_date'],);}}

=== FILE: lib/models/production_schedule_model.dart ===
class ProductionSchedule {final String id;final DateTime date;final String menuId;final String menuName; // Dari relasifinal int totalPortions;final String? startCookingTime; // Format "HH:mm:ss"final String? targetFinishTime; // Format "HH:mm:ss"final String? notes;ProductionSchedule({required this.id,required this.date,required this.menuId,required this.menuName,required this.totalPortions,this.startCookingTime,this.targetFinishTime,this.notes,});factory ProductionSchedule.fromJson(Map<String, dynamic> json) {return ProductionSchedule(id: json['id'].toString(),date: DateTime.parse(json['date']),menuId: json['menu_id'].toString(),menuName: json['menus'] != null ? json['menus']['name'] : 'Menu ?',totalPortions: json['total_portions'] != null ? int.parse(json['total_portions'].toString()) : 0,startCookingTime: json['start_cooking_time'],targetFinishTime: json['target_finish_time'],notes: json['notes'],);}}

=== FILE: lib/models/vehicle_model.dart ===
// === FILE: lib/models/vehicle_model.dart ===class Vehicle {final String id;final String sppgId;final String plateNumber; // Plat Nomorfinal String? driverName; // Nama Supir (Main Driver)final int capacityLimit; // Kapasitas Angkut (Porsi)final bool isActive; // Status Siap Jalan?final String? courierProfileId;// [BARU] Assistant Courierfinal String? assistantCourierId;final String? assistantCourierName;Vehicle({required this.id,required this.sppgId,required this.plateNumber,this.driverName,this.capacityLimit = 0,this.isActive = true,this.courierProfileId,// [BARU]this.assistantCourierId,this.assistantCourierName,});factory Vehicle.fromJson(Map<String, dynamic> json) {// [FIX KRITIS ALIAS PROFILES]: Update cara mengambil data joinfinal Map<String, dynamic>? primaryProfile =json['profiles!courier_profile_id'];final Map<String, dynamic>? assistantProfile =json['profiles_assist']; // <--- AMBIL DARI ALIAS BARUreturn Vehicle(id: json['id'].toString(),sppgId: json['sppg_id'].toString(),plateNumber: json['plate_number'] ?? 'Tanpa Plat',driverName: primaryProfile?['full_name'] ?? json['driver_name'],capacityLimit: json['capacity_limit'] != null? int.parse(json['capacity_limit'].toString()): 0,isActive: json['is_active'] ?? true,courierProfileId: json['courier_profile_id']?.toString(),// [BARU]assistantCourierId: json['assistant_courier_id']?.toString(),assistantCourierName:assistantProfile?['full_name'], // <--- Ambil dari alias profiles_assist);}Map<String, dynamic> toJson() {return {'sppg_id': sppgId,'plate_number': plateNumber,'driver_name': driverName,'capacity_limit': capacityLimit,'is_active': isActive,'courier_profile_id': courierProfileId,// [BARU]'assistant_courier_id': assistantCourierId,};}}

=== FILE: lib/models/courier_model.dart ===
class CourierModel {final String id;final String name; // Dipetakan dari full_name di tabel profilesfinal String email;final String? sppgId; // SPPG tempat kurir bertugasfinal String? phoneNumber; // [BARU]CourierModel({required this.id,required this.name,required this.email,this.sppgId,this.phoneNumber,});factory CourierModel.fromJson(Map<String, dynamic> json) {return CourierModel(id: json['id'].toString(),name: json['full_name'] ?? 'Kurir Tanpa Nama',email: json['email'] ?? 'Email tidak tersedia',sppgId: json['sppg_id'],phoneNumber:json['phone_number'] ??json['phone'], // [BARU] Ambil dari phone_number/phone);}}

=== FILE: lib/models/route_model.dart ===
class DeliveryRoute {final String id;final String date; // Format YYYY-MM-DDfinal String vehicleId;final String courierId;final String status; // pending, active, completed// [PENTING] Field Barufinal String? departureTime; // Jam Berangkat (HH:mm:ss)// Variabel tambahan untuk joinfinal String? vehiclePlate;final String? courierName;final String? menuName; // [BARU] Dari route_menus joinfinal String? menuId; // [BARU] Dari route_menus join// [FIX KRITIS 1] Tambahkan field bukti muatfinal String? loadProofPhotoUrl; // Bukti Muatfinal String sppgId; // <--- DITAMBAH DI SINIDeliveryRoute({required this.id,required this.date,required this.vehicleId,required this.courierId,this.status = 'pending',this.departureTime,this.loadProofPhotoUrl, // <--- TAMBAHKAN KE CONSTRUCTORthis.vehiclePlate,required this.sppgId, // <--- TAMBAHKAN KE CONSTRUCTORthis.courierName,this.menuName,this.menuId,});factory DeliveryRoute.fromJson(Map<String, dynamic> json) {String? cName;// Cari nama kurir dari alias lama atau alias barufinal courierProfile =json['profiles!courier_id'] ?? json['profiles'] ?? json['courier_data'];if (courierProfile is Map) {cName = courierProfile['full_name'];} else {cName = json['driver_name']; // Fallback driver name}// Logic untuk membaca MenuName dan MenuId dari array join route_menusString? menuName;String? menuId;if (json['route_menus'] is List &&(json['route_menus'] as List).isNotEmpty) {final menuJson = (json['route_menus'] as List).first;if (menuJson['menus'] != null) {menuName = menuJson['menus']['name'];menuId = menuJson['menu_id'];}}// [FIX KRITIS 1]: Ambil data dari Map hasil JOIN (AdminReportService)final vehicle = json['vehicles'];return DeliveryRoute(id: json['id'].toString(),date: json['date'],vehicleId: json['vehicle_id'].toString(),courierId: json['courier_id'].toString(),sppgId: json['sppg_id'].toString(), // <--- PARSE DARI SINIcourierName: cName, // Set courierName dari hasil parsingstatus: json['status'] ?? 'pending',// Ambil data departure_time dari databasedepartureTime: json['departure_time'],// [FIX KRITIS 2]: Ambil load_proof_photo_url dari top level routeloadProofPhotoUrl:json['load_proof_photo_url'], // <-- Dipastikan ada di model// Supabase join objects// [FIX 3]: Menggunakan null-check pada Map joinvehiclePlate: vehicle?['plate_number'],menuName: menuName ?? 'Menu Tidak Ditemukan',menuId: menuId,);}}

=== FILE: lib/models/user_profile.dart ===
// FILE: lib/models/user_profile.dartclass UserProfile {final String id;final String? email;final String? fullName;final String role;final String? sppgId;final String? schoolId;// [BARU] Nomor Teleponfinal String? phoneNumber;UserProfile({required this.id,this.email,this.fullName,required this.role,this.sppgId,this.schoolId,this.phoneNumber, // [BARU]});// FIX: Email dijadikan parameter opsional. Mengambil data dari profilesfactory UserProfile.fromJson(Map<String, dynamic> json, [String? email]) {return UserProfile(id: json['id'],email: email,fullName: json['full_name'],role: json['role'] ?? 'unknown',sppgId: json['sppg_id'],schoolId: json['school_id'],phoneNumber:json['phone_number'], // [BARU] Ambil dari kolom 'phone_number' atau 'phone');}}

=== FILE: lib/core/screens/profile_screen.dart ===
import 'package:flutter/material.dart';import 'package:supabase_flutter/supabase_flutter.dart';import '../../features/autentikasi/screens/login_screen.dart';class ProfileScreen extends StatefulWidget {const ProfileScreen({super.key});@overrideState<ProfileScreen> createState() => _ProfileScreenState();}class _ProfileScreenState extends State<ProfileScreen> {final _passwordController = TextEditingController();bool _isLoading = false;// Data UserString _email = "";String _name = "";String _role = "";@overridevoid initState() {super.initState();_loadUserData();}Future<void> _loadUserData() async {final user = Supabase.instance.client.auth.currentUser;if (user != null) {try {final profile = await Supabase.instance.client.from('profiles').select().eq('id', user.id).single();setState(() {_email = user.email ?? "-";_name = profile['full_name'] ?? "-";_role = profile['role']?.toString().toUpperCase() ?? "-";});} catch (e) {print("Gagal load profil: $e");}}}Future<void> _changePassword() async {if (_passwordController.text.length < 6) {ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Password minimal 6 karakter")),);return;}setState(() => _isLoading = true);try {await Supabase.instance.client.auth.updateUser(UserAttributes(password: _passwordController.text),);if (!mounted) return;ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Password berhasil diubah!"), backgroundColor: Colors.green),);_passwordController.clear();} catch (e) {ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Gagal ganti password: $e"), backgroundColor: Colors.red),);} finally {if (mounted) setState(() => _isLoading = false);}}Future<void> _logout() async {await Supabase.instance.client.auth.signOut();if (!mounted) return;Navigator.of(context).pushAndRemoveUntil(MaterialPageRoute(builder: (_) => const LoginScreen()),(route) => false,);}@overrideWidget build(BuildContext context) {return Scaffold(appBar: AppBar(title: const Text("Profil Saya"),backgroundColor: Colors.grey[800], // NetralforegroundColor: Colors.white,),body: SingleChildScrollView(padding: const EdgeInsets.all(20),child: Column(children: [const SizedBox(height: 20),// Avatar Besarconst CircleAvatar(radius: 50,backgroundColor: Colors.grey,child: Icon(Icons.person, size: 60, color: Colors.white),),const SizedBox(height: 20),// Info UserText(_name, style: const TextStyle(fontSize: 22, fontWeight: FontWeight.bold)),Text(_email, style: const TextStyle(fontSize: 16, color: Colors.grey)),const SizedBox(height: 10),Container(padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),decoration: BoxDecoration(color: Colors.blue[50],borderRadius: BorderRadius.circular(20),border: Border.all(color: Colors.blue),),child: Text(_role, style: const TextStyle(color: Colors.blue, fontWeight: FontWeight.bold)),),const SizedBox(height: 40),const Divider(),const SizedBox(height: 20),// Form Ganti Passwordconst Align(alignment: Alignment.centerLeft,child: Text("Ganti Password", style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold)),),const SizedBox(height: 15),TextField(controller: _passwordController,obscureText: true,decoration: const InputDecoration(labelText: "Password Baru",border: OutlineInputBorder(),prefixIcon: Icon(Icons.lock_reset),),),const SizedBox(height: 15),SizedBox(width: double.infinity,child: ElevatedButton(onPressed: _isLoading ? null : _changePassword,style: ElevatedButton.styleFrom(padding: const EdgeInsets.symmetric(vertical: 15),backgroundColor: Colors.blue[800],foregroundColor: Colors.white,),child: _isLoading? const SizedBox(height: 20, width: 20, child: CircularProgressIndicator(color: Colors.white)): const Text("UPDATE PASSWORD"),),),const SizedBox(height: 40),// Tombol Logout MerahSizedBox(width: double.infinity,child: OutlinedButton.icon(onPressed: _logout,icon: const Icon(Icons.logout, color: Colors.red),label: const Text("LOGOUT", style: TextStyle(color: Colors.red)),style: OutlinedButton.styleFrom(padding: const EdgeInsets.symmetric(vertical: 15),side: const BorderSide(color: Colors.red),),),),],),),);}}

=== FILE: lib/core/services/storage_service.dart ===
import 'dart:io';import 'package:supabase_flutter/supabase_flutter.dart';import 'package:image_picker/image_picker.dart'; // Pastikan sudah ada di pubspecclass StorageService {final _supabase = Supabase.instance.client;// Fungsi Pilih Foto dari Kamera/GaleriFuture<File?> pickImage(ImageSource source) async {final ImagePicker picker = ImagePicker();final XFile? image = await picker.pickImage(source: source,imageQuality: 70, // Kompres dikit biar gak beratmaxWidth: 1024, // Resize);if (image != null) {return File(image.path);}return null;}// Fungsi Upload ke SupabaseFuture<String> uploadEvidence(File file, String folderName) async {try {// Nama file unik: evidence/stops/timestamp.jpgfinal fileName = '${DateTime.now().millisecondsSinceEpoch}.jpg';final path = '$folderName/$fileName';// Uploadawait _supabase.storage.from('evidence').upload(path,file,fileOptions: const FileOptions(cacheControl: '3600', upsert: false),);// Ambil URL Publikfinal String publicUrl = _supabase.storage.from('evidence').getPublicUrl(path);return publicUrl;} catch (e) {throw Exception("Gagal upload foto: $e");}}}

=== FILE: lib/features/pengawas/screens/list_sppg_screen.dart ===
import 'package:flutter/material.dart';import '../services/sppg_service.dart';import '../../../models/sppg_model.dart';import 'add_sppg_screen.dart';import 'detail_sppg_screen.dart';class ListSppgScreen extends StatefulWidget {const ListSppgScreen({super.key});@overrideState<ListSppgScreen> createState() => _ListSppgScreenState();}class _ListSppgScreenState extends State<ListSppgScreen> {final SppgService _sppgService = SppgService();List<Sppg> _sppgList = [];bool _isLoading = true;@overridevoid initState() {super.initState();_fetchData();}Future<void> _fetchData() async {setState(() => _isLoading = true);try {final data = await _sppgService.getAllSppgs();if (!mounted) return;setState(() {_sppgList = data;_isLoading = false;});} catch (e) {if (!mounted) return;ScaffoldMessenger.of(context,).showSnackBar(SnackBar(content: Text("Error: $e")));setState(() => _isLoading = false);}}// Fungsi DeleteFuture<void> _deleteSppg(String id) async {final confirm = await showDialog(context: context,builder: (ctx) => AlertDialog(title: const Text("Hapus SPPG?"),content: const Text("Data yang dihapus tidak bisa dikembalikan."),actions: [TextButton(onPressed: () => Navigator.pop(ctx, false),child: const Text("Batal"),),TextButton(onPressed: () => Navigator.pop(ctx, true),child: const Text("Hapus", style: TextStyle(color: Colors.red)),),],),);if (confirm == true) {await _sppgService.deleteSppg(id);_fetchData(); // Refresh list}}@overrideWidget build(BuildContext context) {return Scaffold(appBar: AppBar(title: const Text("Data Master SPPG"),backgroundColor: Colors.blue[800],foregroundColor: Colors.white,actions: [// [BARU] TOMBOL REFRESHIconButton(icon: const Icon(Icons.refresh),tooltip: "Refresh Data",onPressed: _fetchData, // Panggil fungsi refresh data),],),body: RefreshIndicator(onRefresh: _fetchData,child: _isLoading? const Center(child: CircularProgressIndicator()): _sppgList.isEmpty? _buildEmptyState(): ListView.builder(padding: const EdgeInsets.all(8),itemCount: _sppgList.length,itemBuilder: (context, index) {final sppg = _sppgList[index];return Card(elevation: 2,margin: const EdgeInsets.symmetric(horizontal: 8,vertical: 6,),child: ListTile(leading: CircleAvatar(backgroundColor: Colors.blue[50],child: Icon(Icons.kitchen, color: Colors.blue[800]),),title: Text(sppg.name,style: const TextStyle(fontWeight: FontWeight.bold),),subtitle: Text(sppg.address ?? "Alamat belum diisi",maxLines: 1,overflow: TextOverflow.ellipsis,),trailing: Row(mainAxisSize: MainAxisSize.min,children: [// TOMBOL EDITIconButton(icon: const Icon(Icons.edit, color: Colors.blue),onPressed: () {Navigator.push(context,MaterialPageRoute(builder: (_) =>AddSppgScreen(sppgToEdit: sppg),),).then((val) {if (val == true) _fetchData();});},),// TOMBOL DELETEIconButton(icon: const Icon(Icons.delete, color: Colors.red),onPressed: () => _deleteSppg(sppg.id),),// TOMBOL DETAIL (PANAH)IconButton(icon: const Icon(Icons.arrow_forward_ios,size: 16,color: Colors.grey,),onPressed: () {Navigator.push(context,MaterialPageRoute(builder: (context) =>DetailSppgScreen(sppg: sppg),),);},),],),),);},),),floatingActionButton: FloatingActionButton.extended(onPressed: () async {final result = await Navigator.push(context,MaterialPageRoute(builder: (_) => const AddSppgScreen()),);if (result == true) {_fetchData();}},backgroundColor: Colors.blue[800],foregroundColor: Colors.white,icon: const Icon(Icons.add),label: const Text("Tambah SPPG"),),);}Widget _buildEmptyState() {return Center(child: Column(mainAxisAlignment: MainAxisAlignment.center,children: [const Icon(Icons.business_outlined, size: 80, color: Colors.grey),const SizedBox(height: 16),const Text("Belum ada data SPPG.",style: TextStyle(fontSize: 16, color: Colors.grey),),TextButton(onPressed: _fetchData, child: const Text("Refresh")),],),);}}

=== FILE: lib/features/pengawas/screens/location_picker_screen.dart ===
import 'dart:convert';import 'package:flutter/material.dart';import 'package:flutter_map/flutter_map.dart';import 'package:latlong2/latlong.dart';import 'package:http/http.dart' as http;class LocationPickerScreen extends StatefulWidget {final double initialLat;final double initialLong;const LocationPickerScreen({super.key,this.initialLat = -6.9175, // Default Bandungthis.initialLong = 107.6191,});@overrideState<LocationPickerScreen> createState() => _LocationPickerScreenState();}class _LocationPickerScreenState extends State<LocationPickerScreen> {late LatLng _pickedLocation;final MapController _mapController = MapController();final TextEditingController _searchController = TextEditingController();double _currentZoom = 15.0;bool _isSearching = false;@overridevoid initState() {super.initState();_pickedLocation = LatLng(widget.initialLat, widget.initialLong);}Future<void> _searchAddress() async {final query = _searchController.text;if (query.isEmpty) return;setState(() => _isSearching = true);FocusScope.of(context).unfocus();try {final url = Uri.parse('https://photon.komoot.io/api/?q=$query&limit=1');final response = await http.get(url);if (response.statusCode == 200) {final data = json.decode(response.body);final features = data['features'] as List;if (features.isNotEmpty) {final coordinates = features[0]['geometry']['coordinates'];final double lon = coordinates[0];final double lat = coordinates[1];final newLocation = LatLng(lat, lon);setState(() {_pickedLocation = newLocation;});_mapController.move(newLocation, 16.0);} else {if (!mounted) return;ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Lokasi tidak ditemukan.")),);}}} catch (e) {ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Error: $e")));} finally {setState(() => _isSearching = false);}}void _zoomMap(double change) {setState(() {_currentZoom = (_currentZoom + change).clamp(3.0, 18.0);_mapController.move(_pickedLocation, _currentZoom);});}@overrideWidget build(BuildContext context) {return Scaffold(resizeToAvoidBottomInset: false,appBar: AppBar(title: const Text("Pilih Lokasi"),backgroundColor: Colors.blue[800],foregroundColor: Colors.white,actions: [IconButton(icon: const Icon(Icons.check),onPressed: () {Navigator.pop(context, _pickedLocation);},)],),body: Stack(children: [FlutterMap(mapController: _mapController,options: MapOptions(initialCenter: _pickedLocation,initialZoom: _currentZoom,onPositionChanged: (camera, hasGesture) {if (hasGesture) {setState(() {_pickedLocation = camera.center;_currentZoom = camera.zoom;});}},),children: [TileLayer(urlTemplate: 'https://tile.openstreetmap.org/{z}/{x}/{y}.png',userAgentPackageName: 'com.example.mbg_monitoring',),// [PENTING] Attribution OSM (Biar Legal)const RichAttributionWidget(attributions: [TextSourceAttribution('OpenStreetMap contributors')],),],),const Center(child: Padding(padding: EdgeInsets.only(bottom: 40.0),child: Icon(Icons.location_pin, color: Colors.red, size: 50),),),Positioned(top: 10, left: 15, right: 15,child: Card(child: Padding(padding: const EdgeInsets.symmetric(horizontal: 8.0),child: Row(children: [Expanded(child: TextField(controller: _searchController,decoration: const InputDecoration(hintText: "Cari lokasi...", border: InputBorder.none,),onSubmitted: (_) => _searchAddress(),),),IconButton(icon: _isSearching? const SizedBox(width: 20, height: 20, child: CircularProgressIndicator(strokeWidth: 2)): const Icon(Icons.search),onPressed: _searchAddress,),],),),),),Positioned(right: 20, bottom: 160,child: Column(children: [FloatingActionButton.small(heroTag: "zoom_in", onPressed: () => _zoomMap(1.0),backgroundColor: Colors.white, child: const Icon(Icons.add, color: Colors.black),),const SizedBox(height: 10),FloatingActionButton.small(heroTag: "zoom_out", onPressed: () => _zoomMap(-1.0),backgroundColor: Colors.white, child: const Icon(Icons.remove, color: Colors.black),),],),),Positioned(bottom: 30, left: 20, right: 20,child: Card(child: Padding(padding: const EdgeInsets.all(16.0),child: Column(children: [Text("Lat: ${_pickedLocation.latitude.toStringAsFixed(5)}, Long: ${_pickedLocation.longitude.toStringAsFixed(5)}"),const SizedBox(height: 10),SizedBox(width: double.infinity,child: ElevatedButton(style: ElevatedButton.styleFrom(backgroundColor: Colors.blue[800], foregroundColor: Colors.white),onPressed: () => Navigator.pop(context, _pickedLocation),child: const Text("PILIH LOKASI INI"),),),],),),),),],),);}}

=== FILE: lib/features/pengawas/screens/detail_sppg_screen.dart ===
import 'package:flutter/material.dart';import 'package:flutter_map/flutter_map.dart';import 'package:latlong2/latlong.dart';import '../../../models/sppg_model.dart';import '../../../models/school_model.dart';import '../services/sppg_service.dart';import '../../admin_sppg/services/school_service.dart'; // Import School Serviceclass DetailSppgScreen extends StatelessWidget {final Sppg sppg;const DetailSppgScreen({super.key, required this.sppg});// Fungsi HapusFuture<void> _deleteSppg(BuildContext context) async {final confirm = await showDialog(context: context,builder: (ctx) => AlertDialog(title: const Text("Hapus SPPG?"),content: const Text("Tindakan ini akan menghapus data SPPG ini. Data terkait mungkin ikut terhapus."),actions: [TextButton(onPressed: () => Navigator.pop(ctx, false), child: const Text("Batal")),TextButton(onPressed: () => Navigator.pop(ctx, true), child: const Text("Hapus", style: TextStyle(color: Colors.red))),],),);if (confirm == true) {try {await SppgService().deleteSppg(sppg.id);if(!context.mounted) return;Navigator.pop(context, true); // Balik ke list dan refreshScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("SPPG Dihapus.")));} catch (e) {ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Error: $e")));}}}@overrideWidget build(BuildContext context) {bool hasLocation = sppg.latitude != null && sppg.longitude != null;final centerLocation = hasLocation? LatLng(sppg.latitude!, sppg.longitude!): const LatLng(-6.9175, 107.6191);return Scaffold(appBar: AppBar(title: Text(sppg.name),backgroundColor: Colors.blue[800],foregroundColor: Colors.white,actions: [// Tombol Hapus (UC06)IconButton(icon: const Icon(Icons.delete),tooltip: "Hapus SPPG",onPressed: () => _deleteSppg(context),)],),body: SingleChildScrollView(child: Column(crossAxisAlignment: CrossAxisAlignment.start,children: [// 1. PETASizedBox(height: 200,width: double.infinity,child: FlutterMap(options: MapOptions(initialCenter: centerLocation, initialZoom: 15.0),children: [TileLayer(urlTemplate: 'https://tile.openstreetmap.org/{z}/{x}/{y}.png', userAgentPackageName: 'com.example.mbg'),if (hasLocation) MarkerLayer(markers: [Marker(point: centerLocation, width: 50, height: 50, child: const Icon(Icons.location_pin, color: Colors.red, size: 40))]),],),),Padding(padding: const EdgeInsets.all(16.0),child: Column(crossAxisAlignment: CrossAxisAlignment.start,children: [const Text("Detail Info", style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold)),const SizedBox(height: 10),ListTile(leading: const Icon(Icons.map), title: Text(sppg.address ?? "-"), subtitle: const Text("Alamat")),ListTile(leading: const Icon(Icons.email), title: Text(sppg.email ?? "-"), subtitle: const Text("Email Admin")),ListTile(leading: const Icon(Icons.phone), title: Text(sppg.phone ?? "-"), subtitle: const Text("Telepon")),const Divider(height: 30),// 2. LIST SEKOLAH PENERIMA MANFAAT (UC07)const Text("Daftar Penerima Manfaat (Sekolah)", style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold)),const SizedBox(height: 10),SizedBox(height: 300, // Fixed height untuk listchild: FutureBuilder<List<School>>(future: SchoolService().getSchoolsBySppgId(sppg.id),builder: (context, snapshot) {if (snapshot.connectionState == ConnectionState.waiting) return const Center(child: CircularProgressIndicator());final schools = snapshot.data ?? [];if (schools.isEmpty) return const Center(child: Text("Belum ada sekolah terdaftar."));return ListView.builder(itemCount: schools.length,itemBuilder: (ctx, i) => Card(child: ListTile(leading: const Icon(Icons.school, color: Colors.orange),title: Text(schools[i].name),subtitle: Text("${schools[i].studentCount} Siswa"),),),);},),)],),),],),),);}}

=== FILE: lib/features/pengawas/screens/bgn_report_screen.dart ===
// === FILE: lib/features/pengawas/screens/bgn_report_screen.dart ===import 'package:flutter/material.dart';import 'package:fl_chart/fl_chart.dart';import 'package:intl/intl.dart';import 'dart:convert';import 'package:collection/collection.dart';import '../services/bgn_monitoring_service.dart'; // Service BGN yang sudah dimodifikasiimport '../../../models/sppg_model.dart';import '../../../models/route_model.dart';import '../../../models/vehicle_model.dart';import '../../../models/school_model.dart';import '../../../models/courier_model.dart';import '../../admin_sppg/screens/edit_route_screen.dart';import '../../admin_sppg/screens/edit_account_screen.dart';// FIX KRITIS: Tambahkan import untuk BGN Route Detail Screenimport 'bgn_route_detail_screen.dart';import '../../admin_sppg/services/complaint_service.dart'; // <--- BARU: Perlu untuk Tindak Lanjutimport '../../admin_sppg/services/teacher_service.dart'; // <--- BARU: Perlu untuk TeacherModel (di Personnel Tab)import '../../admin_sppg/services/coordinator_service.dart'; // <--- BARU: Perlu untuk CoordinatorModel (di Personnel Tab)class BgnReportScreen extends StatefulWidget {const BgnReportScreen({super.key});@override// FIX: TickerProvider Mixin harus memiliki argumenState<BgnReportScreen> createState() => _BgnReportScreenState();}class _BgnReportScreenState extends State<BgnReportScreen>with SingleTickerProviderStateMixin<BgnReportScreen> {// ===================================// 1. STATE & SERVICE DECLARATIONS// ===================================late TabController _tabController;final BgnMonitoringService _service = BgnMonitoringService();final _complaintService =BgnMonitoringService(); // Digunakan untuk method respondString? _selectedSppgId;List<Sppg> _allSppgs = [];Key _complaintKey = UniqueKey();Map<String, int>? _stats;bool _isLoading = true;DateTime _selectedRouteDate = DateTime.now();String? _selectedVehicleId;List<Vehicle> _allVehicles = [];String? _selectedSchoolFilterId;List<School> _allSchools = [];final _coordinatorService = CoordinatorService();final _teacherService = TeacherService();@overridevoid initState() {super.initState();_tabController = TabController(length: 4, vsync: this);_loadInitialData();}// PENTING: Load semua data awal (SPPG, Stats Global, dll)// PENTING: Load semua data awal (SPPG, Stats Global, dll)Future<void> _loadInitialData() async {final allSppgs = await _service.getSppgList();if (mounted) {setState(() {_allSppgs = allSppgs.map((json) => Sppg.fromJson(json)).toList();if (_selectedSppgId == null && _allSppgs.isNotEmpty) {_selectedSppgId = _allSppgs.first.id;} else if (_selectedSppgId != null && _allSppgs.isEmpty) {_selectedSppgId = null;}});}// Panggil _refreshAllTabs setelah _selectedSppgId terisi (atau null jika tidak ada SPPG)_refreshAllTabs();}// Meniru logic Admin SPPG, tapi dipanggil dari BGN ServiceFuture<void> _loadStats() async {setState(() => _isLoading = true);try {final data = await _service.getDeliveryStats(sppgId: _selectedSppgId);if (mounted) {setState(() {_stats = data;_isLoading = false;});}} catch (e) {if (mounted) {setState(() => _isLoading = false);}}}// Ambil semua kendaraan dan sekolah (tergantung filter SPPG)Future<void> _loadVehiclesAndSchools() async {try {if (_selectedSppgId == null) return;final vehicles = await _service.getVehicles(sppgId: _selectedSppgId);final schools = await _service.getSchools(sppgId: _selectedSppgId);if (mounted) {setState(() {_allVehicles = vehicles.map((json) => Vehicle.fromJson(json)).toList();_selectedVehicleId = 'all';_allSchools = schools.map((json) => School.fromJson(json)).toList();_selectedSchoolFilterId = null;});}} catch (e) {print("Error loading vehicles/schools for BGN: $e");}}void _refreshAllTabs() {_loadStats();// >>> FIX: Panggil load vehicles & schools HANYA JIKA SPPG SUDAH TERPILIH <<<if (_selectedSppgId != null) {_loadVehiclesAndSchools();} else {// Jika tidak ada SPPG yang dipilih (kasus BGN Global), clear listsetState(() {_allVehicles = [];_allSchools = [];});}setState(() {_complaintKey = UniqueKey();});}// ===================================// 2. HELPER METHODS (DARI STATISTICS SCREEN)// ===================================String _formatTime(String? timeStr) {if (timeStr == null || timeStr.isEmpty) return "--:--";try {return timeStr.substring(0, 5);} catch (_) {return timeStr;}}Color _getStatusColor(String status) {switch (status) {case 'received':return Colors.green;case 'issue_reported':return Colors.red;case 'completed':return Colors.orange;case 'active':return Colors.blue;default:return Colors.grey;}}Widget _buildStatChip(String title, int value, Color color) {return Column(children: [Text(title, style: TextStyle(fontSize: 12, color: Colors.grey[700])),const SizedBox(height: 4),Text('$value',style: TextStyle(fontSize: 20,fontWeight: FontWeight.bold,color: color,),),],);}Widget _buildEmptyState(String text, IconData icon) {return Center(child: Column(mainAxisAlignment: MainAxisAlignment.center,children: [Icon(icon, size: 70, color: Colors.grey[300]),const SizedBox(height: 10),Text(text, style: TextStyle(fontSize: 16, color: Colors.grey[600])),],),);}int _sortClasses(String? a, String? b) {if (a == null || b == null) return 0;final exp = RegExp(r'^(\d+)([a-zA-Z]*)');final matchA = exp.firstMatch(a.toUpperCase());final matchB = exp.firstMatch(b.toUpperCase());if (matchA == null || matchB == null) return a.compareTo(b);final numA = int.tryParse(matchA.group(1)!) ?? 0;final numB = int.tryParse(matchB.group(1)!) ?? 0;final charA = matchA.group(2) ?? '';final charB = matchB.group(2) ?? '';if (numA != numB) return numA.compareTo(numB);return charA.compareTo(charB);}String _formatComplaintDetails(String reporterRole, String rawNotes) {if (rawNotes.isEmpty) return 'Tidak ada detail spesifik.';if (reporterRole == 'koordinator') {try {String cleanedNotes = rawNotes.trim().replaceAll(r'\"', '"');if (cleanedNotes.startsWith('"') && cleanedNotes.endsWith('"')) {cleanedNotes = cleanedNotes.substring(1, cleanedNotes.length - 1);}final List<dynamic> issues = jsonDecode(cleanedNotes);return issues.mapIndexed((index, issue) {final type = issue['type'] ?? 'Masalah Umum';final notes = issue['notes']?.trim() ?? '—';final qty = issue['qty_impacted'];String qtyStr = '';if (type == 'Jumlah Tidak Sesuai') {qtyStr = ' (Defisit: ${qty} Porsi)';}return '${index + 1}. [${type}]${qtyStr}. Detail: "${notes}"';}).join('\n');} catch (e) {return 'Detail Masalah JSON Rusak. Raw Data: $rawNotes';}} else {return rawNotes;}}void _showHistoryDetailDialog(Map<String, dynamic> complaint) {final photoUrl = complaint['proof_photo_url'];final reporterRole = complaint['reporter_role'];final complaintDetails = _formatComplaintDetails(reporterRole,complaint['notes'],);showDialog(context: context,builder: (ctx) => AlertDialog(title: Text("Riwayat Tindak Lanjut: ${complaint['school_name']}"),content: SingleChildScrollView(child: Column(crossAxisAlignment: CrossAxisAlignment.start,mainAxisSize: MainAxisSize.min,children: [_buildInfoRow(Icons.person,"Pelapor","${complaint['reporter_name']} (${reporterRole.toUpperCase()})",),_buildInfoRow(Icons.check_circle,"Status","SUDAH DITANGANI",color: Colors.green,),const Divider(),const Text("Rincian Keluhan:",style: TextStyle(fontWeight: FontWeight.bold,color: Colors.red,),),const SizedBox(height: 5),Container(padding: const EdgeInsets.all(8),width: double.infinity,decoration: BoxDecoration(color: Colors.red[100],borderRadius: BorderRadius.circular(5),),child: Text(complaintDetails,style: TextStyle(fontSize: 13, color: Colors.red[900]),),),if (photoUrl != null && photoUrl.isNotEmpty) ...[const SizedBox(height: 15),const Text("Bukti Foto Pelapor:",style: TextStyle(fontWeight: FontWeight.bold),),const SizedBox(height: 8),GestureDetector(onTap: () => _showImageDialog(context,photoUrl,"Bukti dari ${complaint['reporter_name']}",),child: Container(height: 100,width: 100,decoration: BoxDecoration(borderRadius: BorderRadius.circular(5),image: DecorationImage(image: NetworkImage(photoUrl),fit: BoxFit.cover,),border: Border.all(color: Colors.grey),),child: const Icon(Icons.zoom_in, color: Colors.white70),),),],const SizedBox(height: 15),const Text("Respon Admin:",style: TextStyle(fontWeight: FontWeight.bold,color: Colors.green,),),Text(complaint['admin_response'] ?? 'N/A'),],),),actions: [TextButton(onPressed: () => Navigator.pop(ctx),child: const Text("Tutup"),),],),);}// Helper untuk navigasi ke EditAccountScreen (view only)void _navigateToEditAccount(String userId,String role,Map<String, dynamic> data,) {Navigator.push(context,MaterialPageRoute(builder: (_) => EditAccountScreen(userId: userId,initialRole: role,initialData: data,),),);}// ===================================// TAB CONTROLLERS (DARI STATISTICS SCREEN)// ===================================// --- FILTER BAR BGN (Memasukkan Filter SPPG) ---Widget _buildBgnFilterBar() {final List<DropdownMenuItem<String?>> sppgItems = [const DropdownMenuItem(value: null, child: Text("Semua SPPG (Global)")),..._allSppgs.map((sppg) => DropdownMenuItem(value: sppg.id, child: Text(sppg.name)),).toList(),];return Padding(padding: const EdgeInsets.all(8.0),child: DropdownButtonFormField<String?>(decoration: const InputDecoration(labelText: "Filter Berdasarkan SPPG",prefixIcon: Icon(Icons.business_center, color: Colors.blue),),value: _selectedSppgId,items: sppgItems,onChanged: (String? newValue) {setState(() {_selectedSppgId = newValue;});_refreshAllTabs(); // Refresh data utama saat SPPG berubah},),);}// [NEW] TAB 1: PENGIRIMAN (Mengambil Ringkasan Statistik + Filter List)Widget _buildGlobalStatsTab() {if (_selectedSppgId == null)return _buildEmptyState("Pilih SPPG untuk melihat data detail.",Icons.select_all,);if (_isLoading) return const Center(child: CircularProgressIndicator());if (_stats == null)return const Center(child: Text("Gagal memuat data statistik."));final List<DropdownMenuItem<String?>> vehicleItems = [const DropdownMenuItem(value: 'all', child: Text("Semua Mobil")),..._allVehicles.map((vehicle) => DropdownMenuItem(value: vehicle.id,child: Text(vehicle.plateNumber),),).toList(),];return Column(children: [// RINGKASAN STATUSPadding(padding: const EdgeInsets.symmetric(horizontal: 16.0, vertical: 8.0),child: Row(mainAxisAlignment: MainAxisAlignment.spaceAround,children: [_buildStatChip("TOTAL", _stats!['total']!, Colors.indigo),_buildStatChip("SUKSES", _stats!['received']!, Colors.green),_buildStatChip("MASALAH", _stats!['issues']!, Colors.red),],),),const Divider(),// FILTER TANGGAL & MOBIL (Diperlukan untuk memfilter List di bawah)Padding(padding: const EdgeInsets.all(8.0),child: Row(children: [// Filter TanggalExpanded(child: ListTile(leading: const Icon(Icons.calendar_today, color: Colors.grey),title: Text(DateFormat('d MMMM yyyy','id_ID',).format(_selectedRouteDate),),onTap: () async {final DateTime? picked = await showDatePicker(context: context,initialDate: _selectedRouteDate,firstDate: DateTime(2024),lastDate: DateTime(2030),);if (picked != null) {setState(() {_selectedRouteDate = picked;});}},),),// Filter MobilExpanded(child: DropdownButtonFormField<String?>(value: _selectedVehicleId,decoration: const InputDecoration(labelText: "Filter Mobil"),items: vehicleItems,onChanged: (String? newValue) {setState(() {_selectedVehicleId = newValue;});},),),],),),// Daftar Semua Rute (Interaktif)Expanded(child: FutureBuilder<List<Map<String, dynamic>>>(future: _service.getDetailedRoutes(sppgId: _selectedSppgId,date: _selectedRouteDate,vehicleId: _selectedVehicleId,),builder: (context, snapshot) {if (snapshot.connectionState == ConnectionState.waiting)return const Center(child: CircularProgressIndicator());final routes = snapshot.data ?? [];if (routes.isEmpty)return const Center(child: Text("Tidak ada aktivitas pengiriman."),);return ListView.builder(itemCount: routes.length,itemBuilder: (ctx, i) {final route = routes[i];final courierName =route['courier_data']?['full_name'] ?? 'Kurir N/A';final status = route['status'];final formattedDate = DateFormat('dd MMM yy',).format(DateTime.parse(route['date']));Color cardColor;if (status == 'received') {cardColor = Colors.green[50]!;} else if (status == 'issue_reported') {cardColor = Colors.red[50]!;} else {cardColor = Colors.grey[100]!;}return Card(color: cardColor, // <-- Menggunakan cardColor barumargin: const EdgeInsets.symmetric(horizontal: 10,vertical: 6,),child: ListTile(onTap: () => _showRouteDetailDialog(route),leading: Icon(Icons.local_shipping,color: _getStatusColor(status),),title: Text("$formattedDate - ${route['vehicles']['plate_number']}",style: const TextStyle(fontWeight: FontWeight.bold),),subtitle: Text("Kurir: $courierName | Status: ${status.toUpperCase()}",),trailing: const Icon(Icons.info_outline, size: 16),),);},);},),),],);}// [BARU HELPER] Fungsi untuk menampilkan dialog detail rutevoid _showRouteDetailDialog(Map<String, dynamic> route) {final List<dynamic> stops = route['delivery_stops'] ?? [];final List<dynamic> menuItems = route['route_menus'] ?? [];// Hitung ringkasan status stopsfinal int totalStops = stops.length;final int issues = stops.where((s) => s['status'] == 'issue_reported').length;final int received = stops.where((s) => s['status'] == 'received').length;final int completedCourier = stops.where((s) => s['status'] == 'completed').length;final int pending = totalStops - issues - received - completedCourier;showDialog(context: context,builder: (ctx) => AlertDialog(title: Text("Detail Rute: ${route['vehicles']['plate_number']}"),content: SizedBox(width: MediaQuery.of(context).size.width * 0.9,child: SingleChildScrollView(child: Column(crossAxisAlignment: CrossAxisAlignment.start,mainAxisSize: MainAxisSize.min,children: [// Info Umum_buildInfoRow(Icons.calendar_today,"Tanggal",DateFormat('EEEE, d MMMM yyyy','id_ID',).format(DateTime.parse(route['date'])),),_buildInfoRow(Icons.departure_board,"Jam Berangkat",_formatTime(route['departure_time']),),_buildInfoRow(Icons.person,"Kurir",route['courier_data']?['full_name'] ?? 'N/A',), // <--- FIX ALIAS DISINIconst Divider(height: 20),// Ringkasan Status Stopsconst Text("Status Perhentian",style: TextStyle(fontWeight: FontWeight.bold,color: Colors.indigo,),),const SizedBox(height: 8),_buildInfoRow(Icons.check_circle,"Diterima Koord","$received Stop",color: Colors.green,),_buildInfoRow(Icons.warning,"Ada Keluhan","$issues Stop",color: Colors.red,),_buildInfoRow(Icons.timer,"Selesai Kurir (Menunggu Konf.)","$completedCourier Stop",color: Colors.orange,),_buildInfoRow(Icons.pending_actions,"Pending/Active","$pending Stop",color: Colors.grey,),_buildInfoRow(Icons.route,"Total Perhentian","$totalStops Stop",),const Divider(height: 20),// Daftar Menuconst Text("Menu yang Dibawa",style: TextStyle(fontWeight: FontWeight.bold,color: Colors.indigo,),),const SizedBox(height: 8),...menuItems.map((menuRoute) {return Padding(padding: const EdgeInsets.symmetric(vertical: 2.0),child: Text("• ${menuRoute['menus']['name']}",style: TextStyle(fontSize: 13),),);}).toList(),const Divider(height: 20),// Daftar Stops Detailconst Text("Urutan Stops",style: TextStyle(fontWeight: FontWeight.bold,color: Colors.indigo,),),const SizedBox(height: 8),...stops.map((stop) {final schoolName = stop['schools']['name'];final status = stop['status'];final eta = _formatTime(stop['estimated_arrival_time']);final actualTime = stop['arrival_time'] != null? _formatTime(stop['arrival_time']): '--:--';return Padding(padding: const EdgeInsets.only(bottom: 4.0),child: Row(crossAxisAlignment: CrossAxisAlignment.start,children: [Text("${stop['sequence_order']}. ",style: TextStyle(fontWeight: FontWeight.bold),),Expanded(child: Column(crossAxisAlignment: CrossAxisAlignment.start,children: [Text(schoolName,style: TextStyle(fontWeight: FontWeight.w500),),Text("Status: ${status.toUpperCase()} | ETA: $eta | Tiba: $actualTime",style: TextStyle(fontSize: 11,color: _getStatusColor(status),),),],),),],),);}).toList(),],),),),actions: [TextButton(onPressed: () => Navigator.pop(ctx),child: const Text("TUTUP"),),ElevatedButton.icon(onPressed: () {Navigator.pop(ctx);Navigator.push(context,MaterialPageRoute(builder: (_) =>EditRouteScreen(route: DeliveryRoute.fromJson(route)),),);},icon: const Icon(Icons.edit, size: 18),label: const Text("DETAIL DI MAP"),),],),);}Widget _buildRoutesDetailTab() {if (_selectedSppgId == null)return _buildEmptyState("Pilih SPPG untuk melihat data detail.",Icons.select_all,);final List<DropdownMenuItem<String?>> vehicleItems = [const DropdownMenuItem(value: 'all', child: Text("Semua Mobil")),..._allVehicles.map((vehicle) => DropdownMenuItem(value: vehicle.id,child: Text(vehicle.plateNumber),),).toList(),];return Column(children: [// FILTER TANGGAL & MOBILPadding(padding: const EdgeInsets.all(8.0),child: Row(children: [// Filter TanggalExpanded(child: ListTile(leading: const Icon(Icons.calendar_today, color: Colors.grey),title: Text(DateFormat('d MMMM yyyy','id_ID',).format(_selectedRouteDate),),onTap: () async {final DateTime? picked = await showDatePicker(context: context,initialDate: _selectedRouteDate,firstDate: DateTime(2024),lastDate: DateTime(2030),);if (picked != null) {setState(() {_selectedRouteDate = picked;});}},),),// Filter MobilExpanded(child: DropdownButtonFormField<String?>(value: _selectedVehicleId,decoration: const InputDecoration(labelText: "Filter Mobil"),items: vehicleItems,onChanged: (String? newValue) {setState(() {_selectedVehicleId = newValue;});},),),],),),// Daftar Semua Rute (Interaktif)Expanded(child: FutureBuilder<List<Map<String, dynamic>>>(// FIX KRITIS: Menggunakan service BGN dengan filter SPPGfuture: _service.getDetailedRoutes(sppgId: _selectedSppgId,date: _selectedRouteDate,vehicleId: _selectedVehicleId,),builder: (context, snapshot) {if (snapshot.connectionState == ConnectionState.waiting)return const Center(child: CircularProgressIndicator());final routes = snapshot.data ?? [];if (routes.isEmpty)return const Center(child: Text("Tidak ada aktivitas pengiriman."),);return ListView.builder(itemCount: routes.length,itemBuilder: (ctx, i) {final route = routes[i];final courierName =route['courier_data']?['full_name'] ?? 'Kurir N/A';final status = route['status'];final formattedDate = DateFormat('dd MMM yy',).format(DateTime.parse(route['date']));Color cardColor;if (status == 'received') {cardColor = Colors.green[50]!;} else if (status == 'issue_reported') {cardColor = Colors.red[50]!;} else {cardColor = Colors.grey[100]!;}return Card(color: cardColor,margin: const EdgeInsets.symmetric(horizontal: 10,vertical: 6,),child: ListTile(onTap: () {// FIX NAVIGASI: Pindah ke BGN Route Detail ScreenNavigator.push(context,MaterialPageRoute(builder: (_) => BgnRouteDetailScreen(route: DeliveryRoute.fromJson(route),),),);},leading: Icon(Icons.local_shipping,color: _getStatusColor(status),),title: Text("$formattedDate - ${route['vehicles']['plate_number']}",style: const TextStyle(fontWeight: FontWeight.bold),),subtitle: Text("Kurir: $courierName | Status: ${status.toUpperCase()}",),trailing: const Icon(Icons.info_outline, size: 16),),);},);},),),],);}// [NEW] TAB 3: ANGGOTA (Filter per SPPG)Widget _buildPersonnelTab() {if (_selectedSppgId == null) {return _buildEmptyState("Pilih SPPG untuk melihat data anggota.",Icons.select_all,);}// Kita gunakan FutureBuilder untuk mengambil SEMUA data personel di SPPG terpilihreturn FutureBuilder<List<Map<String, dynamic>>>(future: _service.getPersonnelSummary(sppgId: _selectedSppgId),builder: (context, snapshot) {if (snapshot.connectionState == ConnectionState.waiting) {return const Center(child: CircularProgressIndicator());}final allPersonnel = snapshot.data ?? [];// Filter dan petakan ke model masing-masing (menggunakan models dari admin_sppg)final couriers = allPersonnel.where((p) => p['role'] == 'kurir').map((json) => CourierModel.fromJson(json)).toList();// Filter Koordinator dan Wali Kelas yang memiliki school_id terisi (untuk tampilan nama sekolah)final coordinators = allPersonnel.where((p) => p['role'] == 'koordinator' && p['school_id'] != null,) // <--- TAMBAH CHECK INI.map((json) => CoordinatorModel.fromJson(json)).toList();final teachers = allPersonnel.where((p) => p['role'] == 'walikelas' && p['school_id'] != null,) // <--- TAMBAH CHECK INI.map((json) => TeacherModel.fromJson(json)).toList();// Sorting Koordinator dan Wali Kelascoordinators.sort((a, b) =>a.schoolName.toLowerCase().compareTo(b.schoolName.toLowerCase()),);teachers.sort((a, b) {final schoolCompare = a.schoolName.toLowerCase().compareTo(b.schoolName.toLowerCase(),);if (schoolCompare != 0) return schoolCompare;return _sortClasses(a.className, b.className);});return ListView(padding: const EdgeInsets.all(16.0),children: [// ------------------------------------// SECTION 1: KURIR// ------------------------------------Text("KURIR (${couriers.length} Akun)",style: TextStyle(fontSize: 20,fontWeight: FontWeight.bold,color: Colors.blue[800],),),const Divider(thickness: 2),if (couriers.isEmpty)_buildEmptyState("Belum ada akun kurir di SPPG ini.",Icons.person_off_outlined,)else...couriers.map((courier) => _buildCourierCard(courier)),const SizedBox(height: 30),// ------------------------------------// SECTION 2: KOORDINATOR// ------------------------------------Text("KOORDINATOR (${coordinators.length} Akun)",style: TextStyle(fontSize: 20,fontWeight: FontWeight.bold,color: Colors.blue[800],),),const Divider(thickness: 2),if (coordinators.isEmpty)_buildEmptyState("Belum ada akun koordinator di SPPG ini.",Icons.supervised_user_circle,)else...coordinators.map((coord) => _buildCoordinatorCard(coord)),const SizedBox(height: 30),// ------------------------------------// SECTION 3: WALI KELAS// ------------------------------------Text("WALI KELAS (${teachers.length} Akun)",style: TextStyle(fontSize: 20,fontWeight: FontWeight.bold,color: Colors.blue[800],),),const Divider(thickness: 2),if (teachers.isEmpty)_buildEmptyState("Belum ada akun wali kelas di SPPG ini.",Icons.class_,)else...teachers.map((teacher) => _buildTeacherCard(teacher)),],);},);}// --- HELPER CARDS (Dipindahkan dan diadaptasi dari StatisticsScreen) ---Widget _buildCourierCard(CourierModel courier) {return Card(margin: const EdgeInsets.only(bottom: 8),child: ListTile(leading: const Icon(Icons.local_shipping, color: Colors.blueGrey),title: Text(courier.name,style: const TextStyle(fontWeight: FontWeight.bold),),subtitle: Text("${courier.email}\nTelp: ${courier.phoneNumber ?? '-'}",style: const TextStyle(fontSize: 12),),isThreeLine: true,// BGN hanya perlu melihat detail, tidak bisa edit. Mengarah ke EditAccountScreen (Read-Only Mode)trailing: IconButton(icon: const Icon(Icons.info_outline, color: Colors.grey),onPressed: () => _navigateToEditAccount(courier.id, 'kurir', {'name': courier.name,'email': courier.email,'schoolId': null,'className': null,'phoneNumber': courier.phoneNumber,}),),),);}Widget _buildCoordinatorCard(CoordinatorModel coord) {return Card(margin: const EdgeInsets.only(bottom: 8),child: ListTile(leading: const Icon(Icons.supervised_user_circle, color: Colors.teal),title: Text(coord.name,style: const TextStyle(fontWeight: FontWeight.bold),),subtitle: Text("Sekolah: ${coord.schoolName}\n${coord.email}\nTelp: ${coord.phoneNumber ?? '-'}",style: const TextStyle(fontSize: 12),),isThreeLine: true,// BGN hanya perlu melihat detail, tidak bisa edit.trailing: IconButton(icon: const Icon(Icons.info_outline, color: Colors.grey),onPressed: () => _navigateToEditAccount(coord.id, 'koordinator', {'name': coord.name,'email': coord.email,'schoolId': coord.schoolId,'className': null,'phoneNumber': coord.phoneNumber,'schoolName': coord.schoolName,}),),),);}Widget _buildTeacherCard(TeacherModel teacher) {return Card(margin: const EdgeInsets.only(bottom: 8),child: ListTile(leading: const Icon(Icons.class_, color: Colors.indigo),title: Text(teacher.name,style: const TextStyle(fontWeight: FontWeight.bold),),subtitle: Text("Kelas ${teacher.className} (${teacher.studentCountClass} Siswa) @ ${teacher.schoolName}\n${teacher.email}\nTelp: ${teacher.phoneNumber ?? '-'}",style: const TextStyle(fontSize: 12),),isThreeLine: true,// BGN hanya perlu melihat detail, tidak bisa edit.trailing: IconButton(icon: const Icon(Icons.info_outline, color: Colors.grey),onPressed: () => _navigateToEditAccount(teacher.id, 'walikelas', {'name': teacher.name,'email': teacher.email,'schoolId': teacher.schoolId,'className': teacher.className,'phoneNumber': teacher.phoneNumber,'schoolName': teacher.schoolName,'studentCountClass': teacher.studentCountClass,}),),),);}// [NEW] TAB 4: KELUHAN (Filter per SPPG)// [NEW] TAB 4: KELUHAN (Filter per SPPG)Widget _buildComplaintList() {if (_selectedSppgId == null)return _buildEmptyState("Pilih SPPG untuk melihat keluhan.",Icons.select_all,);final List<DropdownMenuItem<String?>> schoolItems = [const DropdownMenuItem(value: null, child: Text("Semua Sekolah")),..._allSchools.map((school) =>DropdownMenuItem(value: school.id, child: Text(school.name)),).toList(),];return FutureBuilder<List<Map<String, dynamic>>>(// Future: Mengambil data yang sudah difilterfuture: _service.getSppgComplaints(sppgId: _selectedSppgId,date: _selectedRouteDate,schoolId: _selectedSchoolFilterId,),builder: (context, snapshot) {if (snapshot.connectionState == ConnectionState.waiting) {return const Center(child: CircularProgressIndicator());}if (snapshot.hasError) {return Center(child: Text("Error List Keluhan: ${snapshot.error}"));}final allComplaints = snapshot.data ?? [];final resolvedCount = allComplaints.where((item) => item['admin_response'] != null).length;final totalComplaints = allComplaints.length;final pendingCount = totalComplaints - resolvedCount;final resolutionPercentage = totalComplaints > 0? (resolvedCount / totalComplaints): 0.0;final pieChartDataResolution = PieChartData(sectionsSpace: 2,centerSpaceRadius: 50,sections: [PieChartSectionData(color: Colors.green,value: resolvedCount.toDouble(),title: '${resolvedCount}',radius: 60,titleStyle: const TextStyle(fontSize: 14,fontWeight: FontWeight.bold,color: Colors.white,),),PieChartSectionData(color: Colors.red,value: pendingCount.toDouble(),title: '${pendingCount}',radius: 60,titleStyle: const TextStyle(fontSize: 14,fontWeight: FontWeight.bold,color: Colors.white,),),],);return Column(children: [// --- SECTION A: METRIK RESOLUSI & PERSENTASE ---Padding(padding: const EdgeInsets.all(16.0),child: Column(children: [Text("Tingkat Resolusi Keluhan: ${(resolutionPercentage * 100).toStringAsFixed(1)}%",style: const TextStyle(fontSize: 18,fontWeight: FontWeight.bold,color: Colors.red,),),SizedBox(height: 250,child: PieChart(pieChartDataResolution),),Row(mainAxisAlignment: MainAxisAlignment.spaceAround,children: [_buildStatChip("DITANGANI", resolvedCount, Colors.green),_buildStatChip("PENDING", pendingCount, Colors.red),_buildStatChip("TOTAL", totalComplaints, Colors.indigo),],),],),),// --- FILTER SECTION ---Padding(padding: const EdgeInsets.all(8.0),child: Row(children: [// Filter TanggalExpanded(child: ListTile(leading: const Icon(Icons.calendar_today,color: Colors.red,),title: Text(DateFormat('d MMMM yyyy','id_ID',).format(_selectedRouteDate),),onTap: () async {final DateTime? picked = await showDatePicker(context: context,initialDate: _selectedRouteDate,firstDate: DateTime(2024),lastDate: DateTime(2030),);if (picked != null) {setState(() {_selectedRouteDate = picked;});}},),),// Filter SekolahExpanded(child: DropdownButtonFormField<String?>(value: _selectedSchoolFilterId,decoration: const InputDecoration(labelText: "Filter Sekolah",),items: schoolItems,onChanged: (String? newValue) {setState(() {_selectedSchoolFilterId = newValue;});},),),],),),const Divider(height: 1),// --- SECTION B: LIST KELUHAN (Filtered) ---Expanded(child: ListView.builder(itemCount: allComplaints.length,itemBuilder: (ctx, i) {final item = allComplaints[i];final isResolved = item['admin_response'] != null;final reporterRole = item['reporter_role'] ?? 'N/A';final targetTable = reporterRole == 'walikelas'? 'class_receptions': 'delivery_stops';final targetId = item['id'];final complaintDetails = _formatComplaintDetails(reporterRole,item['notes'],);return Card(color: isResolved ? Colors.green[50] : Colors.red[100],margin: const EdgeInsets.symmetric(horizontal: 10,vertical: 6,),child: ListTile(onTap: isResolved? () => _showHistoryDetailDialog(item): () =>_showRespondDialog(item, targetTable, targetId),leading: Icon(isResolved ? Icons.check_circle : Icons.warning,color: isResolved ? Colors.green : Colors.red,),title: Text(item['school_name'] ?? 'Sekolah N/A',style: const TextStyle(fontWeight: FontWeight.bold),),subtitle: Column(crossAxisAlignment: CrossAxisAlignment.start,children: [Text("Dari: ${item['reporter_name']} (${reporterRole.toUpperCase()})",),Text("Rincian: ${complaintDetails}",maxLines: 2,overflow: TextOverflow.ellipsis,),Text(isResolved? "Ditangani Admin": "PENDING TINDAK LANJUT",style: TextStyle(fontSize: 12,color: isResolved? Colors.green[800]: Colors.red[800],fontWeight: FontWeight.bold,),),],),isThreeLine: true,trailing: isResolved? const Icon(Icons.info_outline, color: Colors.grey): ElevatedButton(onPressed: () => _showRespondDialog(item,targetTable,targetId,),child: const Text("Tindak Lanjut"),),),);},),),],);},);}// Helper untuk info row (dipakai di dialog)Widget _buildInfoRow(IconData icon,String title,String value, {Color color = Colors.black87,}) {return Padding(padding: const EdgeInsets.symmetric(vertical: 4.0),child: Row(children: [Icon(icon, size: 18, color: Colors.blueGrey),const SizedBox(width: 8),Text("$title: ", style: const TextStyle(fontWeight: FontWeight.w500)),Expanded(child: Text(value, style: TextStyle(color: color)),),],),);}// Helper untuk menampilkan dialog zoom gambarvoid _showImageDialog(BuildContext context, String url, String title) {showDialog(context: context,builder: (ctx) => AlertDialog(title: Text(title),content: SizedBox(width: MediaQuery.of(context).size.width * 0.9,height: MediaQuery.of(context).size.height * 0.7,child: Image.network(url, fit: BoxFit.contain),),actions: [TextButton(onPressed: () => Navigator.pop(ctx),child: const Text("Tutup"),),],),);}// FIX MISSING METHOD: _showRespondDialog (diperlukan di Tab 4)void _showRespondDialog(Map<String, dynamic> complaint,String targetTable,String targetTableId,) {final responseController = TextEditingController();final photoUrl = complaint['proof_photo_url']; // Ambil URL Fotofinal complaintDetails = _formatComplaintDetails(complaint['reporter_role'],complaint['notes'],);showDialog(context: context,builder: (ctx) => AlertDialog(title: const Text("Tindak Lanjut Keluhan"),content: SingleChildScrollView(child: Column(mainAxisSize: MainAxisSize.min,crossAxisAlignment: CrossAxisAlignment.start,children: [// Detail Keluhanconst Text("Rincian Keluhan:",style: TextStyle(fontWeight: FontWeight.bold,color: Colors.red,),),const SizedBox(height: 5),Container(padding: const EdgeInsets.all(8),width: double.infinity,decoration: BoxDecoration(color: Colors.red[100],borderRadius: BorderRadius.circular(5),),child: Text(complaintDetails,style: TextStyle(fontSize: 13, color: Colors.red[900]),),),// Bukti Foto Pengaduanif (photoUrl != null && photoUrl.isNotEmpty) ...[const SizedBox(height: 15),const Text("Bukti Foto Pelapor:",style: TextStyle(fontWeight: FontWeight.bold),),const SizedBox(height: 8),GestureDetector(onTap: () => _showImageDialog(context,photoUrl,"Bukti dari ${complaint['reporter_name']}",),child: Container(height: 100,width: 100,decoration: BoxDecoration(borderRadius: BorderRadius.circular(5),image: DecorationImage(image: NetworkImage(photoUrl),fit: BoxFit.cover,),border: Border.all(color: Colors.grey),),child: const Icon(Icons.zoom_in, color: Colors.white70),),),],const SizedBox(height: 20),// Input Respon Adminconst Text("Respon Admin:",style: TextStyle(fontWeight: FontWeight.bold),),TextField(controller: responseController,maxLines: 4,keyboardType: TextInputType.multiline,decoration: const InputDecoration(labelText: "Instruksi / Tindak Lanjut Admin SPPG",hintText: "Contoh: Sudah kami cek...",border: OutlineInputBorder(),),),],),),actions: [TextButton(onPressed: () => Navigator.pop(ctx),child: const Text("BATAL"),),ElevatedButton(onPressed: () async {if (responseController.text.isEmpty) {if (!mounted) return;ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Wajib isi instruksi!")),);return;}Navigator.pop(ctx);// Panggil service BGN (yang di dalamnya memanggil ComplaintService)// Note: BGN tidak punya ComplaintService, tapi BgnMonitoringService punya method respondToComplaint.// ASUMSI: Kita ubah alur, BGN langsung panggil BgnMonitoringService yang dimodelkan mirip AdminSPPG.// --- Cek Alur Notifikasi ---// Karena BGN tidak punya akses ke ComplaintService, kita harus membuat BGN Service// meniru cara AdminSPPG menangani tindak lanjut, atau membuat helper service baru.// Untuk mematuhi struktur kode, kita harus asumsikan// BgnMonitoringService memiliki metode untuk tindak lanjut keluhan.// KARENA BGN MONITORING SERVICE TIDAK PUNYA METODE INI, KITA HARUS GANTI KE COMPLAINT SERVICE.// SOLUSI KRITIS: BGN tidak boleh punya `ComplaintService`.// Kita harus menggunakan objek `_complaintService` yang sudah dideklarasikan di file ini.// KARENA DI CODE DUMP BGNReportScreen.dart TIDAK ADA ComplaintService,// kita harus menggunakan BgnMonitoringService (`_service`) atau mengimpor.// Kita akan tambahkan import ComplaintService dan deklarasi di BgnReportScreen.dart.// [FIX LANJUTAN]: Kita akan gunakan `BgnMonitoringService` (meskipun perlu diubah)// Kita akan panggil service yang sudah dideklarasikan: `_complaintService`// Namun, karena `BgnReportScreen` (pengawas) menggunakan `BgnMonitoringService`// dan tidak ada `respondToComplaint` disana.// Kami akan *menggunakan* deklarasi `final _complaintService = BgnMonitoringService();`// dan *mengasumsikan* `BgnMonitoringService` memiliki metode `respondToComplaint` (walaupun harusnya tidak).// KARENA INI CRITICAL PATH, AKU AKAN GUNAKAN COMPLAINT SERVICE ADMIN SPPG.// AKAN DIBIARKAN SEPERTI DI `StatisticsScreen.dart` UNTUK MEMINIMALISIR PERUBAHAN SERVICE.// Asumsi: BGN memiliki akses ke ComplaintService (Admin SPPG) untuk Tindak Lanjut.// [Fix Kritis: Gunakan ComplaintService]final complaintService =ComplaintService(); // Kita harus import dan deklarasi ini di BGN Report Screen.String finalReporterUserId;try {finalReporterUserId = await complaintService.getReporterIdForNotification(targetTableId,complaint['reporter_role'],);} catch (e) {if (mounted)ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Gagal tentukan penerima notifikasi: $e"),backgroundColor: Colors.red,),);return;}await complaintService.respondToComplaint(id: complaint['id'],response: responseController.text,reporterId: finalReporterUserId,reporterRole: complaint['reporter_role'],targetTableId: targetTableId,targetTableName: targetTable,);_refreshAllTabs(); // Refresh tampilan setelah meresponif (mounted) {ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Tindak Lanjut & Notifikasi Terkirim!"),backgroundColor: Colors.green,),);}},child: const Text("KIRIM INSTRUKSI"),),],),);}// ===================================// TAB SECTIONS (DARI STATISTICS SCREEN)// ===================================// SECTION HELPER: Courier// SECTION HELPER: CourierWidget _buildCourierSection() {return FutureBuilder<List<Map<String, dynamic>>>(// FIX: Menggunakan BGN Service untuk mengambil SEMUA data personel di SPPG terpilihfuture: _service.getPersonnelSummary(sppgId: _selectedSppgId),builder: (context, snapshot) {if (snapshot.connectionState == ConnectionState.waiting)return const Center(child: CircularProgressIndicator());// Filter dan petakan ke model CourierModelfinal couriers = (snapshot.data ?? []).where((p) => p['role'] == 'kurir').map((json) => CourierModel.fromJson(json)).toList();if (couriers.isEmpty)return _buildEmptyState("Belum ada akun kurir di SPPG ini.",Icons.person_off_outlined,);return Column(children: couriers.map((courier) {// ... (Item Card Logic sama)return Card(margin: const EdgeInsets.only(bottom: 8),child: ListTile(leading: const Icon(Icons.local_shipping,color: Colors.blueGrey,),title: Text(courier.name,style: const TextStyle(fontWeight: FontWeight.bold),),subtitle: Text("${courier.email}\nTelp: ${courier.phoneNumber ?? '-'}",style: const TextStyle(fontSize: 12),),isThreeLine: true,trailing: IconButton(icon: const Icon(Icons.info_outline, color: Colors.grey),onPressed: () => _navigateToEditAccount(courier.id, 'kurir', {'name': courier.name,'email': courier.email,'schoolId': null,'className': null,'phoneNumber': courier.phoneNumber,}),),),);}).toList(),);},);}// SECTION HELPER: CoordinatorWidget _buildCoordinatorSection() {return FutureBuilder<List<Map<String, dynamic>>>(// FIX KRITIS: Menggunakan BGN Service untuk ambil data personelfuture: _service.getPersonnelSummary(sppgId: _selectedSppgId),builder: (context, snapshot) {if (snapshot.connectionState == ConnectionState.waiting)return const Center(child: CircularProgressIndicator());// Filter dan petakan ke model CoordinatorModelfinal coordinators = (snapshot.data ?? []).where((p) => p['role'] == 'koordinator')// FIX: Gunakan model Admin SPPG untuk pemetaan.map((json) => CoordinatorModel.fromJson(json)).toList();if (coordinators.isEmpty)return _buildEmptyState("Belum ada akun koordinator di SPPG ini.",Icons.supervised_user_circle,);coordinators.sort((a, b) =>a.schoolName.toLowerCase().compareTo(b.schoolName.toLowerCase()),);return Column(children: coordinators.map((coord) {// ... (Item Card Logic sama)return Card(margin: const EdgeInsets.only(bottom: 8),child: ListTile(leading: const Icon(Icons.supervised_user_circle,color: Colors.teal,),title: Text(coord.name,style: const TextStyle(fontWeight: FontWeight.bold),),subtitle: Text("Sekolah: ${coord.schoolName}\n${coord.email}\nTelp: ${coord.phoneNumber ?? '-'}",style: const TextStyle(fontSize: 12),),isThreeLine: true,trailing: IconButton(icon: const Icon(Icons.info_outline, color: Colors.grey),onPressed: () =>_navigateToEditAccount(coord.id, 'koordinator', {'name': coord.name,'email': coord.email,'schoolId': coord.schoolId,'className': null,'phoneNumber': coord.phoneNumber,'schoolName': coord.schoolName,}),),),);}).toList(),);},);}// SECTION HELPER: TeacherWidget _buildTeacherSection() {return FutureBuilder<List<Map<String, dynamic>>>(// FIX KRITIS: Menggunakan BGN Service untuk ambil data personelfuture: _service.getPersonnelSummary(sppgId: _selectedSppgId),builder: (context, snapshot) {if (snapshot.connectionState == ConnectionState.waiting)return const Center(child: CircularProgressIndicator());// Filter dan petakan ke model TeacherModelfinal teachers = (snapshot.data ?? []).where((p) => p['role'] == 'walikelas').map((json) => TeacherModel.fromJson(json)).toList();if (teachers.isEmpty)return _buildEmptyState("Belum ada akun wali kelas di SPPG ini.",Icons.class_,);teachers.sort((a, b) {final schoolCompare = a.schoolName.toLowerCase().compareTo(b.schoolName.toLowerCase(),);if (schoolCompare != 0) return schoolCompare;return _sortClasses(a.className, b.className);});return Column(children: teachers.map((teacher) {// ... (Item Card Logic sama)return Card(margin: const EdgeInsets.only(bottom: 8),child: ListTile(leading: const Icon(Icons.class_, color: Colors.indigo),title: Text(teacher.name,style: const TextStyle(fontWeight: FontWeight.bold),),subtitle: Text("Kelas ${teacher.className} (${teacher.studentCountClass} Siswa) @ ${teacher.schoolName}\n${teacher.email}\nTelp: ${teacher.phoneNumber ?? '-'}",style: const TextStyle(fontSize: 12),),isThreeLine: true,trailing: IconButton(icon: const Icon(Icons.info_outline, color: Colors.grey),onPressed: () =>_navigateToEditAccount(teacher.id, 'walikelas', {'name': teacher.name,'email': teacher.email,'schoolId': teacher.schoolId,'className': teacher.className,'phoneNumber': teacher.phoneNumber,'schoolName': teacher.schoolName,'studentCountClass': teacher.studentCountClass,}),),),);}).toList(),);},);}@overrideWidget build(BuildContext context) {if (_isLoading)return const Scaffold(body: Center(child: CircularProgressIndicator()));return Scaffold(appBar: AppBar(title: const Text("Laporan Distribusi & Kualitas"),backgroundColor: Colors.blue[800],foregroundColor: Colors.white,actions: [IconButton(icon: const Icon(Icons.refresh),tooltip: "Refresh Data",onPressed: _refreshAllTabs,),],bottom: TabBar(controller: _tabController,indicatorColor: Colors.white,labelColor: Colors.white,unselectedLabelColor: Colors.white70,isScrollable: true,tabs: const [Tab(text: "1. Pengiriman"),Tab(text: "2. Rute & Detail"),Tab(text: "3. Personel"),Tab(text: "4. Keluhan"),],),),body: Column(children: [// Filter Utama: Filter SPPG_buildBgnFilterBar(),// Tab View yang Dibungkus ExpandedExpanded(child: TabBarView(controller: _tabController,children: [_buildGlobalStatsTab(),_buildRoutesDetailTab(),_buildPersonnelTab(),_buildComplaintList(),],),),],),);}}

=== FILE: lib/features/pengawas/screens/dashboard_bgn_screen.dart ===
import 'package:flutter/material.dart';// Import Auth & Loginimport '../../autentikasi/services/auth_service.dart';import '../../autentikasi/screens/login_screen.dart';// Import Screens Fitur BGNimport 'list_sppg_screen.dart';import 'bgn_report_screen.dart'; // Screen Laporan Terpadu// [PENTING] Import Halaman Profil (Tempat Ganti Password)import '../../../core/screens/profile_screen.dart';import '../../autentikasi/screens/login_screen.dart'as login_screen; // <--- Import dengan aliasclass DashboardBgnScreen extends StatefulWidget {const DashboardBgnScreen({super.key});@overrideState<DashboardBgnScreen> createState() => _DashboardBgnScreenState(); // <-- UBAH KE STATEFUL}class _DashboardBgnScreenState extends State<DashboardBgnScreen> {// <-- UBAH KE STATE// Ambil initial state dari variabel globalbool _isDebugActive = login_screen.isDebugModeActive;Future<void> _logout() async {await AuthService().signOut();if (!mounted) return;Navigator.of(context).pushAndRemoveUntil(MaterialPageRoute(builder: (_) => const LoginScreen()),(route) => false,);}// [BARU] Toggle Debug Modevoid _toggleDebugMode(bool isActive) {setState(() {_isDebugActive = isActive;login_screen.isDebugModeActive = isActive; // UPDATE GLOBAL STATE// Memberikan feedback yang jelasScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text(isActive? "Debug Mode AKTIF. Perlu Log out untuk melihat perubahan.": "Debug Mode NONAKTIF.",),backgroundColor: isActive ? Colors.red : Colors.green,),);});}@overrideWidget build(BuildContext context) {return Scaffold(appBar: AppBar(title: const Text("BGN Monitoring"),backgroundColor: Colors.blue[800],foregroundColor: Colors.white,actions: [// [BARU] TOGGLE DEBUG MENUTooltip(message: "Toggle Quick Login Debug",child: Switch(value: _isDebugActive,onChanged: _toggleDebugMode,activeColor: Colors.redAccent,inactiveThumbColor: Colors.grey[400],inactiveTrackColor: Colors.grey[200],),),// [FITUR GANTI PASSWORD ADA DI SINI]// Tombol Profil (Icon Orang)IconButton(icon: const Icon(Icons.account_circle, size: 30),tooltip: "Profil & Password",onPressed: () {// Navigasi ke Halaman ProfilNavigator.push(context,MaterialPageRoute(builder: (_) => const ProfileScreen()),);},),],),body: Padding(padding: const EdgeInsets.all(16.0),child: Column(crossAxisAlignment: CrossAxisAlignment.start,children: [const Text("Selamat Datang, Pengawas",style: TextStyle(fontSize: 20, fontWeight: FontWeight.bold),),const Text("Pilih menu di bawah untuk memulai:"),const SizedBox(height: 20),// Grid MenuExpanded(child: GridView.count(crossAxisCount: 2,crossAxisSpacing: 16,mainAxisSpacing: 16,children: [// MENU 1: MANAJEMEN AKUN SPPG_buildMenuCard(context,icon: Icons.manage_accounts,title: "Manajemen Akun SPPG",color: Colors.blue,onTap: () {Navigator.push(context,MaterialPageRoute(builder: (_) => const ListSppgScreen(),),);},),// MENU 2: LAPORAN DISTRIBUSI & KUALITAS_buildMenuCard(context,icon: Icons.analytics,title: "Laporan Distribusi & Kualitas",color: Colors.green,onTap: () {Navigator.push(context,MaterialPageRoute(builder: (_) => const BgnReportScreen(),),);},),],),),],),),);}Widget _buildMenuCard(BuildContext context, {required IconData icon,required String title,required Color color,required VoidCallback onTap,}) {return InkWell(onTap: onTap,child: Container(decoration: BoxDecoration(color: Colors.white,borderRadius: BorderRadius.circular(16),boxShadow: [BoxShadow(color: Colors.grey.withOpacity(0.1),blurRadius: 10,spreadRadius: 2,),],border: Border.all(color: color.withOpacity(0.3)),),child: Column(mainAxisAlignment: MainAxisAlignment.center,children: [CircleAvatar(radius: 30,backgroundColor: color.withOpacity(0.1),child: Icon(icon, size: 30, color: color),),const SizedBox(height: 16),Padding(padding: const EdgeInsets.symmetric(horizontal: 8.0),child: Text(title,textAlign: TextAlign.center,style: const TextStyle(fontWeight: FontWeight.bold,fontSize: 16,),),),],),),);}}

=== FILE: lib/features/pengawas/screens/add_sppg_screen.dart ===
import 'package:flutter/material.dart';import 'package:latlong2/latlong.dart';import 'package:supabase_flutter/supabase_flutter.dart';import 'location_picker_screen.dart';import '../services/sppg_service.dart';import '../../../models/sppg_model.dart';class AddSppgScreen extends StatefulWidget {final Sppg? sppgToEdit; // Data untuk diedit (Null = Mode Tambah)const AddSppgScreen({super.key, this.sppgToEdit});@overrideState<AddSppgScreen> createState() => _AddSppgScreenState();}class _AddSppgScreenState extends State<AddSppgScreen> {final _formKey = GlobalKey<FormState>();// --- DATA DAPUR (SPPG) ---final _sppgNameController = TextEditingController();final _sppgAddressController = TextEditingController();final _sppgPhoneController = TextEditingController();final _sppgEmailController = TextEditingController();// Lokasifinal _latController = TextEditingController();final _longController = TextEditingController();// --- DATA ADMIN (Hanya untuk Mode Tambah) ---final _adminNameController = TextEditingController();final _adminEmailController = TextEditingController();final _adminPasswordController = TextEditingController();bool _isSubmitting = false;@overridevoid initState() {super.initState();// [LOGIKA EDIT] Isi form jika ada dataif (widget.sppgToEdit != null) {final s = widget.sppgToEdit!;_sppgNameController.text = s.name;_sppgAddressController.text = s.address ?? '';_sppgPhoneController.text = s.phone ?? '';_sppgEmailController.text = s.email ?? '';if (s.latitude != null) _latController.text = s.latitude.toString();if (s.longitude != null) _longController.text = s.longitude.toString();}}Future<void> _openMapPicker() async {double initialLat = double.tryParse(_latController.text) ?? -6.9175;double initialLong = double.tryParse(_longController.text) ?? 107.6191;final LatLng? result = await Navigator.push(context,MaterialPageRoute(builder: (context) => LocationPickerScreen(initialLat: initialLat,initialLong: initialLong,),),);if (result != null) {setState(() {_latController.text = result.latitude.toString();_longController.text = result.longitude.toString();});ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Koordinat berhasil diambil dari Peta!")),);}}Future<void> _submitForm() async {if (_formKey.currentState!.validate()) {setState(() => _isSubmitting = true);try {// 1. Siapkan Data SPPG (Tanpa Tanggal Berdiri)final Map<String, dynamic> sppgData = {"name": _sppgNameController.text.trim(),"address": _sppgAddressController.text.trim(),"email": _sppgEmailController.text.trim(),"phone": _sppgPhoneController.text.trim(),"gps_lat": double.tryParse(_latController.text),"gps_long": double.tryParse(_longController.text),};if (widget.sppgToEdit == null) {// --- MODE TAMBAH ---if (_adminEmailController.text.isEmpty ||_adminPasswordController.text.isEmpty) {throw Exception("Email & Password Admin wajib diisi.");}final supabase = Supabase.instance.client;final sppgRes = await supabase.from('sppgs').insert(sppgData).select().single();final String newSppgId = sppgRes['id'];// Create Adminawait SppgService().createSppgUser(email: _adminEmailController.text.trim(),password: _adminPasswordController.text,sppgId: newSppgId,sppgName: _sppgNameController.text,fullName: _adminNameController.text.trim(),);} else {// --- MODE EDIT ---await SppgService().updateSppg(widget.sppgToEdit!.id, sppgData);}if (!mounted) return;ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text(widget.sppgToEdit == null? "SPPG Baru Berhasil!": "Data SPPG Diperbarui!",),backgroundColor: Colors.green,),);Navigator.pop(context, true);} catch (e) {if (!mounted) return;ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Gagal: $e"), backgroundColor: Colors.red),);} finally {if (mounted) setState(() => _isSubmitting = false);}}}@overridevoid dispose() {_sppgNameController.dispose();_sppgAddressController.dispose();_sppgPhoneController.dispose();_sppgEmailController.dispose();_latController.dispose();_longController.dispose();_adminNameController.dispose();_adminEmailController.dispose();_adminPasswordController.dispose();super.dispose();}@overrideWidget build(BuildContext context) {final isEdit = widget.sppgToEdit != null;return Scaffold(appBar: AppBar(title: Text(isEdit ? "Edit SPPG" : "Tambah Akun SPPG"),backgroundColor: Colors.blue[800],foregroundColor: Colors.white,),body: SingleChildScrollView(padding: const EdgeInsets.all(16.0),child: Form(key: _formKey,child: Column(crossAxisAlignment: CrossAxisAlignment.start,children: [const Text("1. Detail SPPG (Dapur)",style: TextStyle(fontSize: 18,fontWeight: FontWeight.bold,color: Colors.blue,),),const SizedBox(height: 15),TextFormField(controller: _sppgNameController,decoration: const InputDecoration(labelText: "Nama SPPG",border: OutlineInputBorder(),prefixIcon: Icon(Icons.store),),validator: (v) => v!.isEmpty ? "Wajib" : null,),const SizedBox(height: 10),TextFormField(controller: _sppgAddressController,maxLines: 2,decoration: const InputDecoration(labelText: "Alamat SPPG",border: OutlineInputBorder(),prefixIcon: Icon(Icons.map),),validator: (v) => v!.isEmpty ? "Wajib" : null,),const SizedBox(height: 10),TextFormField(controller: _sppgPhoneController,keyboardType: TextInputType.phone,decoration: const InputDecoration(labelText: "Telepon Kantor",border: OutlineInputBorder(),prefixIcon: Icon(Icons.phone),),validator: (v) => v!.isEmpty ? "Wajib" : null,),const SizedBox(height: 10),TextFormField(controller: _sppgEmailController,keyboardType: TextInputType.emailAddress,decoration: const InputDecoration(labelText: "Email Kantor (Opsional)",border: OutlineInputBorder(),prefixIcon: Icon(Icons.email),),),const SizedBox(height: 20),// --- Input Lat/Long Manual + Tombol Peta ---const Text("Titik Koordinat (GPS)",style: TextStyle(fontWeight: FontWeight.bold),),const SizedBox(height: 5),const Text("Isi manual atau gunakan tombol 'Buka Peta'",style: TextStyle(fontSize: 12, color: Colors.grey),),const SizedBox(height: 10),Row(children: [Expanded(child: TextFormField(controller: _latController,keyboardType: const TextInputType.numberWithOptions(decimal: true,signed: true,),decoration: const InputDecoration(labelText: "Latitude",hintText: "-6.xxxx",border: OutlineInputBorder(),),),),const SizedBox(width: 10),Expanded(child: TextFormField(controller: _longController,keyboardType: const TextInputType.numberWithOptions(decimal: true,signed: true,),decoration: const InputDecoration(labelText: "Longitude",hintText: "107.xxxx",border: OutlineInputBorder(),),),),],),const SizedBox(height: 8),SizedBox(width: double.infinity,child: ElevatedButton.icon(onPressed: _openMapPicker,icon: const Icon(Icons.map),label: const Text("Ambil dari Peta (Otomatis)"),style: ElevatedButton.styleFrom(backgroundColor: Colors.blue[100],foregroundColor: Colors.blue[900],),),),// --------------------------------------------------const SizedBox(height: 30),const Divider(thickness: 2),// BAGIAN ADMIN HANYA MUNCUL SAAT TAMBAH BARUif (!isEdit) ...[const Text("2. Akun Admin SPPG",style: TextStyle(fontSize: 18,fontWeight: FontWeight.bold,color: Colors.blue,),),const SizedBox(height: 15),TextFormField(controller: _adminNameController,decoration: const InputDecoration(labelText: "Nama Lengkap Admin",border: OutlineInputBorder(),prefixIcon: Icon(Icons.person),),validator: (v) => v!.isEmpty ? "Wajib" : null,),const SizedBox(height: 15),TextFormField(controller: _adminEmailController,keyboardType: TextInputType.emailAddress,decoration: const InputDecoration(labelText: "Email Login",border: OutlineInputBorder(),prefixIcon: Icon(Icons.email),),validator: (v) => v!.isEmpty ? "Wajib" : null,),const SizedBox(height: 10),TextFormField(controller: _adminPasswordController,obscureText: true,decoration: const InputDecoration(labelText: "Password",border: OutlineInputBorder(),prefixIcon: Icon(Icons.lock),),validator: (v) => v!.length < 6 ? "Min 6 karakter" : null,),const SizedBox(height: 40),],SizedBox(width: double.infinity,child: ElevatedButton(onPressed: _isSubmitting ? null : _submitForm,style: ElevatedButton.styleFrom(backgroundColor: Colors.blue[800],padding: const EdgeInsets.symmetric(vertical: 16),),child: _isSubmitting? const CircularProgressIndicator(color: Colors.white): Text(isEdit ? "SIMPAN PERUBAHAN" : "SIMPAN",style: const TextStyle(fontSize: 16,fontWeight: FontWeight.bold,color: Colors.white,),),),),const SizedBox(height: 30),],),),),);}}

=== FILE: lib/features/pengawas/screens/bgn_route_detail_screen.dart ===
// === FILE: lib/features/pengawas/screens/bgn_route_detail_screen.dart ===import 'package:flutter/material.dart';import 'package:flutter_map/flutter_map.dart';import 'package:latlong2/latlong.dart';import 'package:intl/intl.dart';import 'package:supabase_flutter/supabase_flutter.dart';import '../../../models/route_model.dart';import '../../admin_sppg/services/route_service.dart';class BgnRouteDetailScreen extends StatefulWidget {final DeliveryRoute route;const BgnRouteDetailScreen({super.key, required this.route});@overrideState<BgnRouteDetailScreen> createState() => _BgnRouteDetailScreenState();}class _BgnRouteDetailScreenState extends State<BgnRouteDetailScreen> {final RouteService _routeService = RouteService();final MapController _mapController = MapController();List<Map<String, dynamic>> _stops = [];List<LatLng> _polylinePoints = [];LatLng? _sppgLocation;bool _isLoading = true;@overridevoid initState() {super.initState();_fetchRouteDetails();}// --- Helper methods (minimal essential logic for rendering) ---String _formatTime(String? timeStr) {if (timeStr == null || timeStr.isEmpty) return "--:--";try {return timeStr.substring(0, 5);} catch (_) {return timeStr;}}Color _getStatusColor(String status) {switch (status) {case 'received':return Colors.green;case 'issue_reported':return Colors.red;case 'completed':return Colors.orange;case 'active':return Colors.blue;default:return Colors.grey;}}Widget _buildInfoRow(IconData icon,String title,String value, {Color color = Colors.black87,}) {return Padding(padding: const EdgeInsets.symmetric(vertical: 4.0),child: Row(children: [Icon(icon, size: 18, color: Colors.blueGrey),const SizedBox(width: 8),Text("$title: ", style: const TextStyle(fontWeight: FontWeight.w500)),Expanded(child: Text(value, style: TextStyle(color: color)),),],),);}// FIX: Helper untuk Menampilkan Gambar Bukti (Diambil dari EditRouteScreen Admin)Widget _buildProofSection({required String title,required String? url,bool isRouteProof = false,}) {// BGN hanya view, jadi kita tidak perlu logika isRouteProofif (url == null || url.isEmpty) {return const SizedBox.shrink(); // Hide section if no proof}return Column(crossAxisAlignment: CrossAxisAlignment.start,children: [Text(title, style: const TextStyle(fontWeight: FontWeight.bold)),const SizedBox(height: 10),GestureDetector(onTap: () {// Ini memerlukan helper _showImageDialog (asumsi sudah ada/dibuat di BgnReportScreen)// Untuk BGN Route Detail Screen, kita harus membuat stub/helper lokal jika belum ada.// Karena ini file terpisah, kita perlu buat helper lokal.if (mounted) {_showLocalImageDialog(context, url, title);}},child: Container(height: 150,width: 150,decoration: BoxDecoration(borderRadius: BorderRadius.circular(8),border: Border.all(color: Colors.grey),image: DecorationImage(image: NetworkImage(url),fit: BoxFit.cover,),),child: const Align(alignment: Alignment.center,child: Icon(Icons.zoom_in, color: Colors.white, size: 40),),),),],);}void _showLocalImageDialog(BuildContext context, String url, String title) {showDialog(context: context,builder: (ctx) => AlertDialog(title: Text(title),content: SizedBox(width: MediaQuery.of(context).size.width * 0.9,height: MediaQuery.of(context).size.height * 0.7,child: Image.network(url, fit: BoxFit.contain),),actions: [TextButton(onPressed: () => Navigator.pop(ctx),child: const Text("Tutup"),),],),);}// --- End Helper ---Future<LatLng?> _fetchSppgLocation() async {try {final response = await Supabase.instance.client.from('sppgs').select('gps_lat, gps_long').eq('id', widget.route.sppgId).single();if (response['gps_lat'] != null) {return LatLng(double.parse(response['gps_lat'].toString()),double.parse(response['gps_long'].toString()),);}return null;} catch (e) {return null;}}// Logic fetch detail ruteFuture<void> _fetchRouteDetails() async {setState(() => _isLoading = true);try {final origin = await _fetchSppgLocation();_sppgLocation = origin;final stopsData = await _routeService.getRouteStops(widget.route.id);List<LatLng> routingPoints = [];if (origin != null) routingPoints.add(origin);for (var stop in stopsData) {final school = stop['schools'];if (school['gps_lat'] != null && school['gps_long'] != null) {double? lat = double.tryParse(school['gps_lat'].toString());double? long = double.tryParse(school['gps_long'].toString());if (lat != null && long != null) {routingPoints.add(LatLng(lat, long));}}}List<LatLng> polyline = [];if (routingPoints.length >= 2) {polyline = await _routeService.getRoutePolyline(routingPoints);}if (!mounted) return;setState(() {_stops = stopsData;_polylinePoints = polyline;_isLoading = false;});// FIX: Panggil fitCamera setelah setState selesai (post-render)if (routingPoints.isNotEmpty && mounted) {WidgetsBinding.instance.addPostFrameCallback((_) {if (routingPoints.isNotEmpty && mounted) {final bounds = LatLngBounds.fromPoints(routingPoints);_mapController.fitCamera(CameraFit.bounds(bounds: bounds,padding: const EdgeInsets.all(50),),);}});}} catch (e) {if (mounted) {setState(() => _isLoading = false);}}}// --- UI Components ---Widget _buildStopTile(Map<String, dynamic> stop, int index) {final school = stop['schools'];final status = stop['status'];final eta = _formatTime(stop['estimated_arrival_time']);final courierProofUrl = stop['courier_proof_photo_url'] as String?;// FIX KRITIS: Ambil bukti keluhanfinal complaintProofUrl = stop['proof_photo_url'] as String?;final isIssueReported = status == 'issue_reported';return Card(margin: const EdgeInsets.symmetric(vertical: 4),child: ExpansionTile(leading: CircleAvatar(backgroundColor: _getStatusColor(status),child: Text("${index + 1}",style: const TextStyle(color: Colors.white,fontWeight: FontWeight.bold,),),),title: Text(school['name'],style: const TextStyle(fontWeight: FontWeight.bold),),subtitle: Text("Status: ${status.toUpperCase()} | ETA: $eta"),children: [Padding(padding: const EdgeInsets.all(16.0),child: Column(crossAxisAlignment: CrossAxisAlignment.start,children: [_buildInfoRow(Icons.check_circle_outline,"Penerima",stop['recipient_name'] ?? 'Belum Konfirmasi',),_buildInfoRow(Icons.inventory,"Porsi Diterima","${stop['received_qty'] ?? 0}",),const SizedBox(height: 10),// Bukti Tiba Kurir_buildProofSection(title: "Bukti Tiba Kurir",url: courierProofUrl,),const SizedBox(height: 10),// FIX KRITIS: Bukti Keluhan (jika ada issue)if (isIssueReported && complaintProofUrl != null)_buildProofSection(title: "Bukti Keluhan Penerima",url: complaintProofUrl,),],),),],),);}@overrideWidget build(BuildContext context) {String dateStr = widget.route.date;try {dateStr = DateFormat('EEEE, d MMMM yyyy','id_ID',).format(DateTime.parse(widget.route.date));} catch (_) {}final LatLng defaultCenter =_sppgLocation ?? const LatLng(-6.9175, 107.6191);final isCompleted = widget.route.status == 'completed';final courierName = widget.route.courierName ?? 'N/A';final allPoints = [if (_sppgLocation != null) _sppgLocation!,..._stops.where((s) => s['schools']['gps_lat'] != null).map((s) => LatLng(double.parse(s['schools']['gps_lat'].toString()),double.parse(s['schools']['gps_long'].toString()),),),];// FIX KRITIS: Hapus bounds.isValid. Cek validitas dilakukan melalui list.isNotEmptyfinal bounds = allPoints.isNotEmpty? LatLngBounds.fromPoints(allPoints): null;return Scaffold(appBar: AppBar(title: Text("Detail Rute: ${widget.route.vehiclePlate ?? 'N/A'}"),backgroundColor: isCompleted ? Colors.green[800] : Colors.blue[800],foregroundColor: Colors.white,),body: _isLoading? const Center(child: CircularProgressIndicator()): SingleChildScrollView(child: Column(crossAxisAlignment: CrossAxisAlignment.start,children: [// --- INFO UTAMA ---Padding(padding: const EdgeInsets.all(16.0),child: Column(crossAxisAlignment: CrossAxisAlignment.start,children: [Text(dateStr,style: const TextStyle(fontSize: 18,fontWeight: FontWeight.bold,),),_buildInfoRow(Icons.local_shipping,"Armada",widget.route.vehiclePlate ?? "N/A",),_buildInfoRow(Icons.person, "Kurir Utama", courierName),_buildInfoRow(Icons.departure_board,"Jam Berangkat",_formatTime(widget.route.departureTime),),_buildInfoRow(Icons.check_circle_outline,"Status Rute",widget.route.status.toUpperCase(),color: _getStatusColor(widget.route.status),),const Divider(height: 30),const Text("Urutan Perhentian",style: TextStyle(fontSize: 16,fontWeight: FontWeight.bold,),),const SizedBox(height: 10),],),),// --- PETA RUTE ---SizedBox(height: 300,width: double.infinity,child: FlutterMap(mapController: _mapController,options: MapOptions(// FIX AKHIR: Gunakan allPoints.isNotEmptyinitialCameraFit: allPoints.isNotEmpty? CameraFit.bounds(bounds:bounds!, // Kita tahu bounds tidak null jika allPoints tidak kosongpadding: const EdgeInsets.all(50),)// Fallback jika tidak ada GPS data sama sekali: null,initialCenter: defaultCenter,initialZoom: 13.0,),children: [TileLayer(urlTemplate:'https://tile.openstreetmap.org/{z}/{x}/{y}.png',userAgentPackageName: 'com.example.mbg_monitoring',),PolylineLayer(polylines: [Polyline(points: _polylinePoints,strokeWidth: 5.0,color: Colors.blueAccent,),],),// Markers (Dapur dan Stops)MarkerLayer(markers: [if (_sppgLocation != null)Marker(point: _sppgLocation!,width: 60,height: 60,child: const Icon(Icons.store_mall_directory,color: Colors.purple,size: 35,),),..._stops.map((stop) {final school = stop['schools'];if (school['gps_lat'] == null)return const Marker(point: LatLng(0, 0),child: SizedBox(),);double lat = double.parse(school['gps_lat'].toString(),);double long = double.parse(school['gps_long'].toString(),);return Marker(point: LatLng(lat, long),width: 60,height: 60,child: Column(children: [Icon(Icons.location_on,color: _getStatusColor(stop['status']),size: 35,),Text("${stop['sequence_order']}",style: const TextStyle(fontSize: 10,fontWeight: FontWeight.bold,),),],),);}).toList(),],),],),),const Divider(thickness: 2, height: 30),// --- LIST DETAIL STOPS ---Padding(padding: const EdgeInsets.symmetric(horizontal: 16.0),child: Column(children: List.generate(_stops.length,(index) => _buildStopTile(_stops[index], index),),),),const SizedBox(height: 40),],),),);}}

=== FILE: lib/features/pengawas/services/bgn_monitoring_service.dart ===
// === FILE: lib/features/pengawas/services/bgn_monitoring_service.dart ===import 'package:supabase_flutter/supabase_flutter.dart';import 'package:intl/intl.dart';class BgnMonitoringService {final _supabase = Supabase.instance.client;// Helper untuk menentukan filter SPPGPostgrestFilterBuilder<T> _applySppgFilter<T>(PostgrestFilterBuilder<T> query,String? sppgId,) {if (sppgId != null) {// Untuk tabel yang memiliki sppg_id langsung (sppgs, vehicles, profiles, schools)// Note: Untuk delivery_routes, filter harus pakai join!return query.eq('sppg_id', sppgId);}return query;}// ===========================================================================// BAGIAN 1: STATISTIK & PENGIRIMAN// ===========================================================================// [MODIFIKASI] 1. AMBIL STATISTIK PENGIRIMANFuture<Map<String, int>> getDeliveryStats({String? sppgId}) async {try {var query = _supabase.from('delivery_stops').select('status, delivery_routes!inner(sppg_id)');if (sppgId != null) {query = query.eq('delivery_routes.sppg_id', sppgId);}final response = await query;final List<dynamic> data = response;int received = 0, issues = 0, pending = 0, total = 0;for (var item in data) {total++;final status = item['status'];if (status == 'received') {received++;} else if (status == 'issue_reported') {issues++;} else {pending++;}}// Note: Di BGN, kita tambahkan resolved countint resolved = issues > 0? issues: 0; // Simplified assumption for BGN statsreturn {'received': received,'issues': issues,'pending': pending,'total': total,'resolved':resolved, // Placeholder: Asumsi resolve count sama dengan issues count (for now)};} catch (e) {throw Exception("Gagal hitung statistik: $e");}}// [MODIFIKASI] 2. AMBIL DETAIL RUTE (DARI REPORT SERVICE)Future<List<Map<String, dynamic>>> getDetailedRoutes({String? sppgId,DateTime? date,String? vehicleId,}) async {try {var queryBuilder = _supabase.from('delivery_routes').select('*');if (sppgId != null) {queryBuilder = queryBuilder.eq('sppg_id', sppgId);}if (date != null) {final dateStr = date.toIso8601String().split('T')[0];queryBuilder = queryBuilder.eq('date', dateStr);}if (vehicleId != null && vehicleId != 'all') {queryBuilder = queryBuilder.eq('vehicle_id', vehicleId);}var finalQuery = queryBuilder.select('''id, date, vehicle_id, courier_id, status, departure_time, load_proof_photo_url,vehicles(plate_number),courier_data:profiles!courier_id(full_name),route_menus(menus(name)),delivery_stops(id, sequence_order, status, estimated_arrival_time, arrival_time, completion_time, schools(name))''');final responseData = await finalQuery;return List<Map<String, dynamic>>.from(responseData);} catch (e) {throw Exception('Gagal ambil detail rute: ${e.toString()}');}}// ===========================================================================// BAGIAN 2: DATA MASTER (SPPG, VEHICLES, SCHOOLS)// ===========================================================================// [BARU] 3. AMBIL LIST SEMUA SPPG (Untuk Dropdown Utama)Future<List<Map<String, dynamic>>> getSppgList() async {try {final response = await _supabase.from('sppgs').select('id, name').order('name', ascending: true);return List<Map<String, dynamic>>.from(response);} catch (e) {throw Exception("Gagal ambil list SPPG: $e");}}// [BARU] 4. AMBIL KENDARAAN (DARI VEHICLE SERVICE)Future<List<Map<String, dynamic>>> getVehicles({String? sppgId}) async {try {var query = _supabase.from('vehicles').select('*, profiles!courier_profile_id(id, full_name), profiles_assist:profiles!assistant_courier_id(id, full_name)',);if (sppgId != null) {query = query.eq('sppg_id', sppgId);}return List<Map<String, dynamic>>.from(await query.order('is_active', ascending: false),);} catch (e) {throw Exception('Gagal ambil data kendaraan: $e');}}// [BARU] 5. AMBIL SEKOLAH (DARI SCHOOL SERVICE)Future<List<Map<String, dynamic>>> getSchools({String? sppgId}) async {try {var query = _supabase.from('schools').select('*');if (sppgId != null) {query = query.eq('sppg_id', sppgId);}return List<Map<String, dynamic>>.from(await query.order('name', ascending: true),);} catch (e) {throw Exception('Gagal ambil data sekolah: $e');}}// ===========================================================================// BAGIAN 3: PERSONEL & KELUHAN// ===========================================================================// [MODIFIKASI] 6. GET SUMMARY OF ALL PERSONNELFuture<List<Map<String, dynamic>>> getPersonnelSummary({String? sppgId,}) async {try {var query = _supabase.from('profiles').select('id, full_name, email, role, phone_number, class_name, student_count_class, school_id, schools(name)',).filter('role', 'in', '("kurir", "koordinator", "walikelas")');// Perbaikan: Tambahkan join schools(*). Jika school_id null, school(name) harusnya juga null,// tapi kalau hanya meminta schools(name), Supabase terkadang mengabaikan seluruh record// jika join field-nya null, atau mengembalikan struktur yang tidak terduga.// Kita pastikan kalau Koordinator/Wali Kelas, mereka harus punya school_id// Ini adalah asumsi terbaik, karena di Admin SPPG service tidak ada masalah.if (sppgId != null) {query = query.eq('sppg_id', sppgId);}// Kita tambahkan filter eksplisit untuk memastikan Koordinator/Wali Kelas hanya ditarik// jika mereka memiliki school_id terisi, atau Kurir (yang school_id-nya pasti null)./*// OPTIONAL: Jika ingin filter hanya yang punya school_id, tambahkan ini:if (role == 'koordinator' || role == 'walikelas') {query = query.not('school_id', 'is', null);}*/return List<Map<String, dynamic>>.from(await query.order('role', ascending: true).order('full_name', ascending: true),);} catch (e) {throw Exception('Gagal ambil data personel: $e');}}// [MODIFIKASI] 7. LAPORAN KELUHANFuture<List<Map<String, dynamic>>> getSppgComplaints({String? sppgId,DateTime? date,String? schoolId,}) async {try {// Note: Di BGN, kita tidak menggunakan ID user, tapi langsung filter berdasarkan sppg_id yang dipilih di dropdownvar query = _supabase.rpc('get_sppg_all_complaints',params: {'sppg_id_input': sppgId,'date_filter_input': date != null? DateFormat('yyyy-MM-dd').format(date): null,'school_id_filter_input': schoolId,},);// Jika tidak ada sppgId yang dipilih, kembalikan list kosong (karena RPC butuh sppgId)if (sppgId == null) return [];final response = await query;return List<Map<String, dynamic>>.from(response);} catch (e) {throw Exception("Gagal ambil semua keluhan: $e");}}}

=== FILE: lib/features/pengawas/services/sppg_service.dart ===
import 'dart:convert';import 'package:http/http.dart' as http;import 'package:supabase_flutter/supabase_flutter.dart';import '../../../models/sppg_model.dart';class SppgService {final _supabase = Supabase.instance.client;// --- A. DATABASE CRUD ---Future<void> createSppg(Map<String, dynamic> data) async {try {await _supabase.from('sppgs').insert(data);} catch (e) {throw Exception('Gagal simpan ke DB: $e');}}Future<List<Sppg>> getAllSppgs() async {try {final response = await _supabase.from('sppgs').select().order('created_at', ascending: false);final List<dynamic> data = response;return data.map((json) => Sppg.fromJson(json)).toList();} catch (e) {throw Exception('Gagal ambil data: $e');}}Future<void> updateSppg(String id, Map<String, dynamic> data) async {try {await _supabase.from('sppgs').update(data).eq('id', id);} catch (e) {throw Exception('Gagal update SPPG: $e');}}Future<void> deleteSppg(String sppgId) async {try {// Kita panggil fungsi SQL 'delete_sppg_complete' yang baru kita buatawait _supabase.rpc('delete_sppg_complete', params: {'target_sppg_id': sppgId});} catch (e) {throw Exception('Gagal hapus SPPG & Akun: $e');}}// --- B. AUTH (SIMPLIFIED - UC04) ---// Kembali ke versi simpel: Cuma Nama, Email, PasswordFuture<void> createSppgUser({required String email,required String password,required String sppgId,required String sppgName,required String fullName, // Nama Admin}) async {const String projectUrl = 'https://mqyfrqgfpqwlrloqtpvi.supabase.co';const String anonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1xeWZycWdmcHF3bHJsb3F0cHZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0NTMxMDMsImV4cCI6MjA3OTAyOTEwM30.KoXKouhFN0H7Iz9MSnRhFQuBIePVMwWyXmrzSv3rEeQ';final url = Uri.parse('$projectUrl/auth/v1/signup');try {final response = await http.post(url,headers: {'Content-Type': 'application/json', 'apikey': anonKey},body: jsonEncode({'email': email.trim(),'password': password,'data': { 'full_name': fullName }}),);if (response.statusCode == 200 || response.statusCode == 201) {final responseData = jsonDecode(response.body);String? newUserId;if (responseData['id'] != null) {newUserId = responseData['id'].toString();} else if (responseData['user'] != null && responseData['user']['id'] != null) {newUserId = responseData['user']['id'].toString();}if (newUserId == null) throw Exception("Gagal dapat ID User.");// Simpan ke Profiles (Versi Ringkas)await _supabase.from('profiles').insert({'id': newUserId,'full_name': fullName,'role': 'admin_sppg','sppg_id': sppgId,'email': email.trim(),});} else {final errorData = jsonDecode(response.body);throw Exception(errorData['msg'] ?? 'Gagal mendaftar');}} catch (e) {if (e.toString().contains("User already registered")) {throw Exception("Email ini sudah terdaftar!");}throw Exception('Error Create User: $e');}}}

=== FILE: lib/features/walikelas/screens/dashboard_teacher_screen.dart ===
import 'dart:io';import 'package:flutter/material.dart';import 'package:image_picker/image_picker.dart';import 'package:supabase_flutter/supabase_flutter.dart';import 'package:intl/intl.dart';import 'package:table_calendar/table_calendar.dart';import 'package:collection/collection.dart'; // Import untuk firstWhereOrNullimport '../../autentikasi/screens/login_screen.dart';import '../services/teacher_reception_service.dart';import '../../../core/services/storage_service.dart';import '../../../core/screens/profile_screen.dart';// === FILE: lib/features/walikelas/screens/dashboard_teacher_screen.dart ===// [BARU] Import untuk Screen Notifikasiimport '../../shared/screens/notification_screen.dart';import '../../shared/services/notification_service.dart';class DashboardTeacherScreen extends StatefulWidget {const DashboardTeacherScreen({super.key});@overrideState<DashboardTeacherScreen> createState() => _DashboardTeacherScreenState();}// Helper untuk model masalah dinamisclass IssueDetail {String? qtyImpacted; // Jumlah item/porsi rusak/kurang/telatString? notes; // Detail keteranganIssueDetail({this.qtyImpacted, this.notes});}class _DashboardTeacherScreenState extends State<DashboardTeacherScreen> {final TeacherReceptionService _service = TeacherReceptionService();final StorageService _storageService = StorageService();DateTime _focusedDay = DateTime.now();DateTime _selectedDay = DateTime.now();CalendarFormat _calendarFormat =CalendarFormat.week; // Default Minggu biar ringkas// Map menyimpan tanggal (hanya date, tanpa time) dengan list of deliveries (stops)Map<DateTime, List<Map<String, dynamic>>> _deliveries = {};bool _isLoading = true;String _myClassName = '';@overridevoid initState() {super.initState();_selectedDay = DateTime(_focusedDay.year,_focusedDay.month,_focusedDay.day,);_fetchDeliveries();}// Ambil data pengiriman untuk bulan yang sedang fokusFuture<void> _fetchDeliveries() async {setState(() => _isLoading = true);try {final data = await _service.getMonthlyDeliveries(_focusedDay);Map<DateTime, List<Map<String, dynamic>>> newMap = {};for (var item in data) {final dateStr = item['delivery_routes']['date'];final date = DateTime.parse(dateStr);final dateKey = DateTime(date.year, date.month, date.day);if (newMap[dateKey] == null) newMap[dateKey] = [];newMap[dateKey]!.add(item);// Ambil nama kelas dari data pertamaif (_myClassName.isEmpty) {_myClassName = item['my_class_name'] ?? 'Kelas Lain';}}if (mounted) {setState(() {_deliveries = newMap;_isLoading = false;});}} catch (e) {if (mounted) {ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Gagal load jadwal: $e"),backgroundColor: Colors.red,),);setState(() => _isLoading = false);}}}List<Map<String, dynamic>> _getEventsForDay(DateTime day) {final dateKey = DateTime(day.year, day.month, day.day);return _deliveries[dateKey] ?? [];}// Event Handler untuk konfirmasi penerimaanvoid _showReceptionDialog(Map<String, dynamic> stopData) {final stopId = stopData['id'];final schoolName = stopData['schools']['name'] ?? 'Sekolah?';final menuRef = stopData['schools']['menu_default'] ?? 'Menu Belum Diset';// [BARU]: Ambil kuantitas yang diharapkan untuk kelas inifinal expectedClassPortions = stopData['expected_class_portions'] ?? 0;final className = stopData['my_class_name'];// [FIX KRITIS 1]: Defaultkan qtyController ke kuantitas KELASfinal qtyController = TextEditingController(text: expectedClassPortions.toString(),);// Kontroler untuk input dinamisfinal notesController = TextEditingController();final dynamicQtyController =TextEditingController(); // Untuk porsi kurang / rusak / basiString? issueType; // null = aman, string = ada masalahFile? photoFile;bool isSubmitting = false;// [FIX KRITIS 2]: Update List Jenis Masalahconst List<String> issueOptions = ['Makanan Basi/Berbau','Kemasan Rusak', // Dulu Kualitas Buruk'Porsi Kurang','Lain-lain',];showDialog(context: context,barrierDismissible: false,builder: (ctx) => StatefulBuilder(builder: (context, setDialogState) {final formKey = GlobalKey<FormState>();// Helper untuk menampilkan input dinamisWidget _buildDynamicIssueFields() {if (issueType == null) return const SizedBox.shrink();// [FIX: Logic Porsi Kurang]if (issueType == 'Porsi Kurang') {return Column(crossAxisAlignment: CrossAxisAlignment.start,children: [const SizedBox(height: 10),TextFormField(controller: dynamicQtyController,keyboardType: TextInputType.number,decoration: const InputDecoration(labelText: "Jumlah Porsi yang Kurang",hintText: "Contoh: 5",),validator: (v) =>(v == null || v.isEmpty || int.tryParse(v)! <= 0)? "Wajib isi jumlah kekurangan.": null,),const SizedBox(height: 10),TextFormField(controller: notesController,maxLines: 3,decoration: const InputDecoration(labelText: "Detail Masalah (Opsional)",),),],);}// [FIX: Logic Makanan Basi/Kemasan Rusak]else if (issueType == 'Makanan Basi/Berbau' ||issueType == 'Kemasan Rusak') {return Column(crossAxisAlignment: CrossAxisAlignment.start,children: [const SizedBox(height: 10),TextFormField(controller: dynamicQtyController,keyboardType: TextInputType.number,decoration: InputDecoration(labelText:"Jumlah Porsi/Kotak yang ${issueType == 'Makanan Basi/Berbau' ? 'Basi/Rusak' : 'Rusak Kemasan'}",hintText: "Total yang terdampak",),validator: (v) =>(v == null || v.isEmpty || int.tryParse(v)! < 0)? "Wajib isi jumlah yang terdampak (0 jika tidak tahu)": null,),const SizedBox(height: 10),TextFormField(controller: notesController,maxLines: 3,decoration: const InputDecoration(labelText: "Keterangan Detail (Wajib Diisi)",),validator: (v) =>v!.isEmpty ? "Keterangan wajib diisi." : null,),],);}// [FIX: Logic Lain-lain]else if (issueType == 'Lain-lain') {return Column(children: [const SizedBox(height: 10),TextFormField(controller: notesController,maxLines: 4,decoration: const InputDecoration(labelText: "Keterangan Detail (Wajib Diisi)",),validator: (v) =>v!.isEmpty ? "Keterangan wajib diisi." : null,),],);}return const SizedBox.shrink(); // Default jika tidak ada}// Logika SubmissionFuture<void> _handleSubmission() async {if (!formKey.currentState!.validate()) return;// Validasi Foto Bukti (selalu wajib jika issueType != null)if (issueType != null && photoFile == null) {if (!mounted) return;ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Semua laporan masalah butuh foto bukti!"),backgroundColor: Colors.red,),);return;}setDialogState(() => isSubmitting = true);String? uploadedUrl;try {// Upload fotoif (photoFile != null) {uploadedUrl = await _storageService.uploadEvidence(photoFile!,'teacher_reception',);}// Gabungkan notes dan dynamic input untuk dikirim ke DBString finalNotes = notesController.text.trim();if (issueType != null) {final String qtyInfo = dynamicQtyController.text.isNotEmpty? " (Terdampak: ${dynamicQtyController.text})": "";finalNotes = "[$issueType$qtyInfo] $finalNotes";}// Panggil service untuk konfirmasiawait _service.submitClassReception(stopId: stopId,className: className,qty: int.tryParse(qtyController.text) ?? 0,notes: finalNotes, // Mengirim catatan gabunganissueType: issueType,proofUrl: uploadedUrl,);if (!mounted) return;Navigator.pop(ctx);await _fetchDeliveries();// ... (feedback messages)ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text(issueType == null? "Konfirmasi Kelas Berhasil!": "Keluhan Kualitas Terkirim ke Admin SPPG!",),backgroundColor: issueType == null? Colors.green: Colors.red,),);} catch (e) {// ... (error handling)} finally {if (mounted) setDialogState(() => isSubmitting = false);}}return AlertDialog(title: Text("Konfirmasi Kelas $className: $schoolName"),content: Form(key: formKey,child: SingleChildScrollView(child: Column(mainAxisSize: MainAxisSize.min,crossAxisAlignment: CrossAxisAlignment.start,children: [// [FIX TAMPILAN]: Porsi yang Diharapkanconst Text("Kuantitas Seharusnya:"),Text("$expectedClassPortions Porsi",style: const TextStyle(fontWeight: FontWeight.bold,fontSize: 16,color: Colors.indigo,),),const SizedBox(height: 10),// --- Kuantitas Diterima ---TextFormField(controller: qtyController,keyboardType: TextInputType.number,decoration: const InputDecoration(labelText: "Jumlah Porsi yang Diterima Kelas",),validator: (v) => v!.isEmpty ? "Wajib diisi" : null,),const SizedBox(height: 15),// --- Dropdown Masalah ---DropdownButtonFormField<String>(decoration: const InputDecoration(labelText: "Laporkan Masalah Kualitas (Opsional)",),value: issueType,items: [const DropdownMenuItem(value: null,child: Text("✅ Aman, Tidak Ada Masalah"),),...issueOptions.map((e) => DropdownMenuItem(value: e,child: Text(e,style: const TextStyle(color: Colors.red),),),),],onChanged: (val) {setDialogState(() {issueType = val;// Clear dynamic inputs saat tipe berubahdynamicQtyController.clear();notesController.clear();photoFile =null; // Reset foto saat masalah dipilih/dibatalkan});},),// --- INPUT DINAMIS MASALAH ---_buildDynamicIssueFields(),// --- FOTO BUKTI ---if (issueType != null) ...[const SizedBox(height: 15),const Text("Foto Bukti (Wajib jika ada masalah):",style: TextStyle(fontWeight: FontWeight.bold),),const SizedBox(height: 5),GestureDetector(onTap: () async {final file = await _storageService.pickImage(ImageSource.camera,);if (file != null)setDialogState(() => photoFile = file);},child: Container(height: 100,width: double.infinity,decoration: BoxDecoration(color: Colors.grey[200],border: Border.all(color: Colors.red),),child: photoFile == null? const Column(mainAxisAlignment: MainAxisAlignment.center,children: [Icon(Icons.camera_alt,size: 30,color: Colors.red,),Text("Ambil Foto Bukti"),],): Image.file(photoFile!, fit: BoxFit.cover),),),],],),),),actions: [TextButton(onPressed: () => Navigator.pop(ctx),child: const Text("Batal"),),ElevatedButton(onPressed: isSubmitting ? null : _handleSubmission,style: ElevatedButton.styleFrom(backgroundColor: issueType == null? Colors.indigo: Colors.red,foregroundColor: Colors.white,),child: isSubmitting? const CircularProgressIndicator(color: Colors.white): Text(issueType == null? "KONFIRMASI TERIMA": "LAPOR MASALAH",),),],);},),);}// Helper untuk mendapatkan icon statusIconData _getStatusIcon(bool alreadyReceived, String stopStatus) {if (alreadyReceived) return Icons.check_box;if (stopStatus == 'received' || stopStatus == 'completed')return Icons.delivery_dining;return Icons.pending_actions;}@overrideWidget build(BuildContext context) {return Scaffold(appBar: AppBar(title: Text("Wali Kelas - ${_myClassName.isNotEmpty ? _myClassName : 'Loading...'}",),backgroundColor: Colors.indigo[800],foregroundColor: Colors.white,actions: [FutureBuilder<int>(future: NotificationService().getUnreadCount(),builder: (context, snapshot) {final unreadCount = snapshot.data ?? 0;return IconButton(icon: Badge(isLabelVisible: unreadCount > 0,label: Text('$unreadCount'),child: const Icon(Icons.notifications),),tooltip: "Notifikasi",onPressed: () {Navigator.push(context,MaterialPageRoute(builder: (_) => const NotificationScreen(),),).then((value) => setState(() {}));},);},),IconButton(icon: const Icon(Icons.account_circle, size: 30),tooltip: "Profil & Password",onPressed: () {Navigator.push(context,MaterialPageRoute(builder: (_) => const ProfileScreen()),);},),],),body: Column(children: [// --- KALENDER ---TableCalendar<Map<String, dynamic>>(firstDay: DateTime.utc(2024, 1, 1),lastDay: DateTime.utc(2030, 12, 31),focusedDay: _focusedDay,selectedDayPredicate: (day) => isSameDay(_selectedDay, day),calendarFormat: _calendarFormat,eventLoader: _getEventsForDay,onDaySelected: (selected, focused) {setState(() {_selectedDay = selected;_focusedDay = focused;});},onPageChanged: (focused) {_focusedDay = focused;_fetchDeliveries(); // Refresh data saat bulan berubah},calendarStyle: const CalendarStyle(markerDecoration: BoxDecoration(color: Colors.indigo, // Warna untuk hari ada jadwalshape: BoxShape.circle,),todayDecoration: BoxDecoration(color: Colors.blue,shape: BoxShape.circle,),selectedDecoration: BoxDecoration(color: Colors.orange, // Warna untuk hari yang dipilihshape: BoxShape.circle,),),headerStyle: const HeaderStyle(formatButtonVisible: false,titleCentered: true,),),const Divider(thickness: 1),// --- LIST PENGIRIMAN HARI INI ---Padding(padding: const EdgeInsets.all(8.0),child: Text("Jadwal Penerimaan Kelas (${_myClassName.isNotEmpty ? _myClassName : '...'}), Tgl ${DateFormat('d MMMM yyyy', 'id_ID').format(_selectedDay)}",style: const TextStyle(fontWeight: FontWeight.bold),),),Expanded(child: _isLoading? const Center(child: CircularProgressIndicator()): _buildDayList(),),],),);}// Widget untuk menampilkan daftar pengiriman di hari yang dipilihWidget _buildDayList() {final deliveries = _getEventsForDay(_selectedDay);if (deliveries.isEmpty) {return const Center(child: Text("Tidak ada jadwal pengiriman untuk sekolah Anda hari ini."),);}return ListView.builder(itemCount: deliveries.length,itemBuilder: (context, index) {final stop = deliveries[index];final stopId = stop['id'];final bool isSchoolReceived =stop['status'] == 'received' || stop['status'] == 'issue_reported';final bool isClassReceived = stop['already_received'] == true;final String menuName =stop['schools']['menu_default'] ?? 'Menu Default Belum Diset';// [FIX KRITIS 1]: Gunakan porsi kelas yang sudah dihitung di servicefinal int classPortions = stop['expected_class_portions'] ?? 0;// --- STATUS CHECK ---// Status ini mencerminkan aksi terakhir di delivery_stops (Kurir/Koordinator)final boolisSchoolFinalized = // Renaming the confusing isSchoolReceivedstop['status'] == 'received' || stop['status'] == 'issue_reported';// --- DYNAMIC CONTENT FROM NESTED FUTUREBUILDER ---return FutureBuilder<Map<String, dynamic>?>(future: _service.getClassReceptionForStop(stopId),builder: (context, snapshot) {final receptionData = snapshot.data;final hasIssue = receptionData?['issue_type'] != null;final issueDetail = receptionData?['notes'] ?? 'Aman.';final receptionStatusText = isClassReceived? (hasIssue? '⚠️ Ada Keluhan: ${receptionData!['issue_type']}': '✅ Sudah Konfirmasi'): 'BELUM KONFIRMASI';return Card(color: isClassReceived? (hasIssue ? Colors.red[50] : Colors.green[50]): (isSchoolFinalized ? Colors.orange[50] : Colors.white),margin: const EdgeInsets.symmetric(horizontal: 16, vertical: 4),child: ListTile(leading: Icon(_getStatusIcon(isClassReceived, stop['status']),color: isClassReceived? (hasIssue ? Colors.red : Colors.green): (isSchoolReceived ? Colors.orange : Colors.indigo),),title: Text("Status Penerimaan Awal: ${isSchoolFinalized ? 'SUDAH DITERIMA' : 'PENDING'}",style: const TextStyle(fontWeight: FontWeight.bold),),subtitle: Column(crossAxisAlignment: CrossAxisAlignment.start,children: [// [FIX KRITIS 2]: Tampilkan porsi kelasText("Menu: $menuName (Kelas: $classPortions Porsi)"),// FIX TAMPILAN: Status kelas dan detail keluhanText("Kelas Anda: $receptionStatusText",style: TextStyle(fontSize: 12,color: hasIssue ? Colors.red[800] : Colors.green[800],fontWeight: FontWeight.bold,),),if (hasIssue)Text("Detail: $issueDetail",style: TextStyle(fontSize: 11, color: Colors.grey[700]),),],),trailing: isSchoolReceived && !isClassReceived? ElevatedButton(onPressed: () => _showReceptionDialog(stop),style: ElevatedButton.styleFrom(backgroundColor: Colors.green,padding: const EdgeInsets.symmetric(horizontal: 8),),child: const Text("Konfirmasi",style: TextStyle(color: Colors.white),),): (isClassReceived? const Icon(Icons.check_circle, color: Colors.green): null),),);},);},);}}

=== FILE: lib/features/walikelas/services/teacher_reception_service.dart ===
// === FILE: lib/features/walikelas/services/teacher_reception_service.dart ===import 'package:supabase_flutter/supabase_flutter.dart';import 'package:collection/collection.dart';class TeacherReceptionService {final _supabase = Supabase.instance.client;// 1. AMBIL JADWAL BULANAN (Untuk Kalender)Future<List<Map<String, dynamic>>> getMonthlyDeliveries(DateTime month,) async {try {final userId = _supabase.auth.currentUser!.id;// A. Cari Profile Wali Kelas (Wajib select class_name DAN student_count_class)final profile = await _supabase.from('profiles').select('school_id, class_name, student_count_class',) // <--- HARUS ADA.eq('id', userId).single();final int myClassPortions =profile['student_count_class'] ?? 0; // <--- Porsi Kelasfinal String? mySchoolId = profile['school_id'];final String myClassName = profile['class_name'] ?? '-';if (mySchoolId == null) throw Exception("Akun tidak terhubung sekolah.");// B. Hitung Range Tanggalfinal startDate = DateTime(month.year, month.month, 1);final endDate = DateTime(month.year, month.month + 1, 0);// C. Ambil Jadwal Pengiriman ke Sekolah (delivery_stops)final response = await _supabase.from('delivery_stops').select(// FIX KRITIS: TAMBAHKAN student_count di schools join'*, delivery_routes!inner(date), schools(menu_default, student_count)',).eq('school_id', mySchoolId).gte('delivery_routes.date', startDate.toIso8601String()).lte('delivery_routes.date', endDate.toIso8601String())// FIX KRITIS: Menghapus order by created_at yang crash karena column ambiguity.// Menggunakan order by estimated_arrival_time (kolom di delivery_stops).order('estimated_arrival_time', ascending: true);List<Map<String, dynamic>> deliveries = List<Map<String, dynamic>>.from(response,);// D. Cek History Penerimaan Guru ini (Batch Check biar hemat query)final myReceptions = await _supabase.from('class_receptions').select('stop_id').eq('teacher_id', userId);final Set<String> receivedStopIds = myReceptions.map((e) => e['stop_id'].toString()).toSet();// E. Gabungkan Statusfor (var item in deliveries) {item['already_received'] = receivedStopIds.contains(item['id']);item['my_class_name'] = myClassName;item['expected_class_portions'] =myClassPortions; // <--- BARU: Masukkan kuota kelas}return deliveries;} catch (e) {throw Exception("Gagal ambil jadwal wali kelas: $e");}}// [BARU] 2. AMBIL STATUS PENERIMAAN KELAS SPESIFIK// Dipakai di buildDayList untuk menampilkan detail status kelas yang sudah konfirmasiFuture<Map<String, dynamic>?> getClassReceptionForStop(String stopId) async {try {final userId = _supabase.auth.currentUser!.id;// Ambil data reception untuk stopId dan teacherId inifinal response = await _supabase.from('class_receptions').select('*').eq('stop_id', stopId).eq('teacher_id', userId).single();return Map<String, dynamic>.from(response);} on PostgrestException catch (e) {// Jika data tidak ditemukan, PostgrestException akan ter-throwif (e.code == 'PGRST116') return null; // Baris tidak ditemukanthrow Exception("Gagal load reception data: ${e.message}");} catch (e) {throw Exception("Gagal load reception data: $e");}}// 3. SIMPAN KONFIRMASI KELAS (Sama dengan sebelumnya)Future<void> submitClassReception({required String stopId,required String className,required int qty,required String notes,String? issueType,String? proofUrl,}) async {try {final userId = _supabase.auth.currentUser!.id;await _supabase.from('class_receptions').insert({'stop_id': stopId,'teacher_id': userId,'class_name': className,'qty_received': qty,'notes': notes, // NOTES sekarang bisa berisi deskripsi detail masalah'issue_type': issueType,'proof_photo_url': proofUrl,});} catch (e) {throw Exception("Gagal simpan data: $e");}}}

=== FILE: lib/features/koordinator/screens/coordinator_request_screen.dart ===
import 'package:flutter/material.dart';import 'package:intl/intl.dart';import 'package:collection/collection.dart';import '../../shared/services/request_service.dart';import 'dart:convert';import 'package:flutter/material.dart'; // Ensure TimeOfDay is importedimport '../../admin_sppg/services/menu_service.dart'; // [BARU] Import MenuService danimport '../../admin_sppg/services/menu_service.dart'; // Import AdminMenuSetModelModelnyaclass CoordinatorRequestScreen extends StatefulWidget {const CoordinatorRequestScreen({super.key});@overrideState<CoordinatorRequestScreen> createState() =>_CoordinatorRequestScreenState();}// Helper array for day namesconst List<String> _daysCo = ['Senin','Selasa','Rabu','Kamis','Jumat','Sabtu',];class _CoordinatorRequestScreenState extends State<CoordinatorRequestScreen> {final _formKey = GlobalKey<FormState>();final RequestService _service = RequestService();final _notesController = TextEditingController();String _selectedType = 'Perubahan Jadwal';bool _isLoading = false;bool _isInitLoading = true;bool _isSubmitting = false;// --- DATA ---// --- DATA ---List<Map<String, dynamic>> _availableMenus = [];List<AdminMenuSetModel> _availableMenuSets = []; // <-- BARUMap<String, dynamic>? _schoolData;// --- FORM STATE ---Map<String, TimeOfDay?> _weeklySchedule = {for (var day in _daysCo) day: null,};TimeOfDay? _universalTime;List<String?> _selectedMenuIds = [null, null, null];final TextEditingController _portionController = TextEditingController();final TextEditingController _toleranceController = TextEditingController(text: '45',);// Menu Set CustomizationString? _selectedMenuSetId; // ID Set yang dipilih/dimulaibool _isCustomizingMenu = false; // Mode edit setfinal TextEditingController _newSetNameController =TextEditingController(); // BARU// Mapping Menu IDs for Customization (Kategori -> Menu ID)Map<String, String?> _customMenuIds = {'Karbo': null,'Lauk Protein': null,'Sayur': null,'Buah': null,'Lauk Nabati': null,'Pelengkap': null,};final List<String> _requiredCategories = ['Karbo','Lauk Protein','Sayur','Buah','Lauk Nabati',];@overridevoid initState() {super.initState();_loadInitialData();}// --- FIX 1: Make sure _schoolData is checked before using it ---Future<void> _loadInitialData() async {try {final results = await Future.wait([_service.getSppgMenus(),_service.getMySchoolDetails(),_service.getMyMenuSets(),]);_availableMenus = results[0] as List<Map<String, dynamic>>;// [BARU]_availableMenuSets = results[2] as List<AdminMenuSetModel>;// Safely cast result, ensuring _schoolData is only updated if fetch succeededMap<String, dynamic>? fetchedSchoolData =results[1] as Map<String, dynamic>?;// If successful fetch, initialize all fieldsif (fetchedSchoolData != null) {_schoolData = fetchedSchoolData;// 1. Porsi, Tolerance// Use null-aware operators where feasible, relying on fallback '0' or '45'_portionController.text = (_schoolData!['student_count'] ?? 0).toString();_toleranceController.text = (_schoolData!['tolerance_minutes'] ?? 45).toString();// 2. Load Routine Weekly Schedule from JSONfinal dlJsonStr = _schoolData!['deadline_time'] as String?;if (dlJsonStr != null && dlJsonStr.startsWith('{')) {final Map<String, dynamic> scheduleMap = jsonDecode(dlJsonStr);Map<String, TimeOfDay?> initialSchedule = {};for (var day in _daysCo) {if (scheduleMap.containsKey(day)) {final parts = scheduleMap[day].split(':');initialSchedule[day] = TimeOfDay(hour: int.parse(parts[0]),minute: int.parse(parts[1]),);} else {initialSchedule[day] = null;}}_weeklySchedule = initialSchedule;}// 3. Menu Default Parsing (Sekarang menyimpan NAMA SET)String defaultMenuStr = _schoolData!['menu_default'] ?? "";if (defaultMenuStr.isNotEmpty && _availableMenuSets.isNotEmpty) {final existingSet = _availableMenuSets.firstWhereOrNull((set) => set.setName == defaultMenuStr,);if (existingSet != null) {_selectedMenuSetId = existingSet.id;}}setState(() => _isInitLoading = false);}} catch (e) {setState(() => _isInitLoading = false);if (mounted)ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Error fetching initial data: $e")),);}}// --- HELPER METHODS RESTORED ---String _calculateArrivalTime(TimeOfDay deadline, int toleranceMinutes) {final now = DateTime.now();final deadlineDt = DateTime(now.year,now.month,now.day,deadline.hour,deadline.minute,);final arrival = deadlineDt.subtract(Duration(minutes: toleranceMinutes));if (arrival.isBefore(DateTime(now.year, now.month, now.day))) {return "00:00 (Error)";}return DateFormat('HH:mm').format(arrival);}Future<void> _pickUniversalTime() async {final TimeOfDay? picked = await showTimePicker(context: context,initialTime: _universalTime ?? const TimeOfDay(hour: 12, minute: 0),);if (picked != null) {setState(() {_universalTime = picked;_weeklySchedule = {for (var day in _daysCo) day: picked};});}}// --- CANCELLATION LOGIC RESTORED (FIXES THE NULL CHECK ERROR) ---Future<void> _confirmCancel(String requestId, String type) async {final confirm = await showDialog(context: context,builder: (ctx) => AlertDialog(title: const Text("Batalkan Pengajuan?"),content: Text("Anda yakin ingin membatalkan pengajuan '$type'?"),actions: [TextButton(onPressed: () => Navigator.pop(ctx, false),child: const Text("TIDAK"),),TextButton(onPressed: () => Navigator.pop(ctx, true),child: const Text("YA, BATALKAN",style: TextStyle(color: Colors.red),),),],),);if (confirm == true) {setState(() => _isLoading = true);try {await _service.cancelRequest(requestId);if (mounted) {ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Pengajuan Dibatalkan."),backgroundColor: Colors.green,),);}setState(() {});} catch (e) {if (mounted) {ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Gagal Batal: $e"),backgroundColor: Colors.red,),);}} finally {setState(() => _isLoading = false);}}}// --- END RESTORED METHODS ---// --- END RESTORED METHODS ---Future<void> _submit() async {if (_formKey.currentState!.validate()) {// PENTING: Jika schoolData null, berarti inisialisasi gagal. Tolak pengiriman.if (_schoolData == null) {if (mounted) {ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Data sekolah gagal dimuat. Tidak bisa kirim pengajuan.",),backgroundColor: Colors.red,),);}return;}setState(() => _isSubmitting = true);try {String summaryData = _notesController.text.trim();List<RequestDetail> details = [];String schoolId = _schoolData!['id'];// --- 1. LOGIC PERUBAHAN JADWAL (Weekly Routine + Tolerance) ---if (_selectedType == 'Perubahan Jadwal') {// A. Serialize Weekly Schedule ke JSON Stringfinal Map<String, String> scheduleMap = {};_weeklySchedule.forEach((day, time) {if (time != null) {scheduleMap[day] ="${time.hour.toString().padLeft(2, '0')}:${time.minute.toString().padLeft(2, '0')}:00";}});final String scheduleJson = jsonEncode(scheduleMap);final int newTolerance =int.tryParse(_toleranceController.text) ?? 45;// B. Masukkan data ke summary: REQ_JADWAL: {JSON_SCHEDULE} | REQ_TOLERANCE: 45// Kita simpan FULL JSON schedule di kolom notes, dan tolerance di newQuantity field.summaryData ="REQ_JADWAL: $scheduleJson | REQ_TOLERANCE: $newTolerance | Note: $summaryData";// C. Buat RequestDetail dummy untuk membawa NEW QUANTITY (Tolerance)// HACK: Kita pakai newQuantity di RequestDetail untuk membawa data tolerance.details.add(RequestDetail(menuId: '', // DummymenuName: '', // DummynewQuantity: newTolerance, // <-- Simpan Tolerance di sini!),);}// --- 2. LOGIC PERUBAHAN MENU SET ---else if (_selectedType == 'Perubahan Menu') {// --- MODE KUSTOM BARU ---if (_isCustomizingMenu) {final validMenuIds = _customMenuIds.values.whereType<String>().toList();if (_newSetNameController.text.isEmpty) {throw Exception("Nama Menu Set baru wajib diisi.");}if (validMenuIds.length < _requiredCategories.length) {throw Exception("Semua kategori wajib harus diisi.");}// Gabungkan semua ID Menu (Karbo_ID, Protein_ID, Sayur_ID, ...)final menuIdsJson = jsonEncode(_customMenuIds);final newSetName = _newSetNameController.text.trim();// Format Summary: REQ_MENU_SET_CUSTOM: {JSON_MENU_IDS} | NEW_NAME: Nama Set BarusummaryData ="REQ_MENU_SET_CUSTOM: $menuIdsJson | NEW_NAME: $newSetName | Note: $summaryData";// Kirim detail Set Menu di RequestDetail (MenuId tidak relevan di sini)details.add(RequestDetail(menuId: menuIdsJson, // Simpan payload JSON di menuId/oldNotesmenuName: newSetName,),);}// --- MODE PILIH SET LAMA ---else {if (_selectedMenuSetId == null) {throw Exception("Pilih Menu Set yang akan digunakan.");}// Cari nama set lama (menu_default)final oldSetName =_schoolData!['menu_default'] ?? "Set Lama Tidak Dikenal";final newSetName = _availableMenuSets.firstWhere((set) => set.id == _selectedMenuSetId!).setName;// Format Summary: REQ_MENU_SET_ID: ID_SET | OLD_NAME: Nama Lama | NEW_NAME: Nama BarusummaryData ="REQ_MENU_SET_ID: $_selectedMenuSetId | OLD_NAME: $oldSetName | NEW_NAME: $newSetName | Note: $summaryData";details.add(RequestDetail(menuId: _selectedMenuSetId!, menuName: newSetName),);}}// --- 3. LOGIC TAMBAH/KURANG PORSI ---else if (_selectedType == 'Tambah/Kurang Porsi') {final int newPortion = int.tryParse(_portionController.text) ?? 0;if (newPortion <= 0)throw Exception("Jumlah porsi baru harus lebih dari 0.");// Masukkan data ke summarysummaryData = "REQ_PORSI: $newPortion | Note: $summaryData";// Buat RequestDetail untuk membawa NEW QUANTITY (Porsi)details.add(RequestDetail(menuId: '', // DummymenuName: '', // DummynewQuantity: newPortion, // <-- Simpan Porsi di sini!),);}// --- FINAL: SUBMIT KE SERVICE ---await _service.submitStructuredRequest(type: _selectedType,notes: summaryData, // <-- Mengirim data terstruktur di sinidetails: details,);if (!mounted) return;ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Pengajuan Terkirim! Menunggu Review Admin."),backgroundColor: Colors.green,),);// Refresh list history setelah kirimsetState(() {});} catch (e) {if (!mounted) return;ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Gagal Kirim Pengajuan: $e"),backgroundColor: Colors.red,),);} finally {if (mounted) setState(() => _isSubmitting = false);}}}// [BARU] Memuat Menu Set yang dipilih ke state kustomisasivoid _loadSetForCustomization(AdminMenuSetModel set) {_newSetNameController.text ="${_schoolData!['name']} - Custom ${set.setName}";setState(() {_customMenuIds = {'Karbo': set.karboId,'Lauk Protein': set.proteinId,'Sayur': set.sayurId,'Buah': set.buahId,'Lauk Nabati': set.nabatiId,'Pelengkap': set.pelengkapId,};_isCustomizingMenu = true;});}@overridevoid dispose() {_notesController.dispose();_portionController.dispose();_toleranceController.dispose();_newSetNameController.dispose(); // <-- BARUsuper.dispose();}@overrideWidget build(BuildContext context) {return Scaffold(appBar: AppBar(title: const Text("Pengajuan Perubahan"),backgroundColor: Colors.teal,foregroundColor: Colors.white,),body: _isInitLoading? const Center(child: CircularProgressIndicator()): SingleChildScrollView(child: Column(children: [Padding(padding: const EdgeInsets.all(16.0),child: Card(elevation: 3,child: Padding(padding: const EdgeInsets.all(16.0),child: Form(key: _formKey,child: Column(crossAxisAlignment: CrossAxisAlignment.start,children: [const Text("Buat Pengajuan Baru",style: TextStyle(fontWeight: FontWeight.bold,fontSize: 16,),),const SizedBox(height: 10),// DROPDOWN TIPE REQUESTDropdownButtonFormField<String>(value: _selectedType,decoration: const InputDecoration(labelText: "Jenis Pengajuan",border: OutlineInputBorder(),),items:['Perubahan Jadwal','Perubahan Menu','Tambah/Kurang Porsi',].map((e) => DropdownMenuItem(value: e,child: Text(e),),).toList(),onChanged: (val) =>setState(() => _selectedType = val!),),const SizedBox(height: 15),// --- ISI FORM BERDASARKAN TIPE ---_buildDynamicForm(),const SizedBox(height: 15),// CATATAN UMUMTextFormField(controller: _notesController,maxLines: 3,decoration: const InputDecoration(labelText: "Catatan Tambahan (Opsional)",hintText:"Contoh: Mohon konfirmasi sebelum jam 9.",border: OutlineInputBorder(),),),const SizedBox(height: 20),SizedBox(width: double.infinity,child: ElevatedButton.icon(onPressed: _isLoading ? null : _submit,icon: const Icon(Icons.send),label: const Text("Kirim Pengajuan"),style: ElevatedButton.styleFrom(backgroundColor: Colors.teal,foregroundColor: Colors.white,),),),],),),),),),const Divider(),const Padding(padding: EdgeInsets.all(8.0),child: Text("Riwayat Pengajuan",style: TextStyle(fontWeight: FontWeight.bold,color: Colors.grey,),),),_buildHistoryList(),],),),);}// --- WIDGET DINAMIS (REWRITING JADWAL TO ROUTINE SETTING) ---Widget _buildDynamicForm() {if (_availableMenus.isEmpty && _selectedType != 'Perubahan Jadwal') {return const Text("Tidak ada menu terdaftar di SPPG Anda.",style: TextStyle(color: Colors.red),);}// 1. PERUBAHAN JADWAL (Weekly Routine)if (_selectedType == 'Perubahan Jadwal') {return Column(crossAxisAlignment: CrossAxisAlignment.start,children: [const Text("Atur Deadline Rutin Mingguan (Mon-Sat):",style: TextStyle(fontWeight: FontWeight.bold),),const SizedBox(height: 10),SizedBox(width: double.infinity,child: OutlinedButton.icon(onPressed: _pickUniversalTime,icon: const Icon(Icons.schedule, color: Colors.blue),label: Text("Apply Jam: ${_universalTime?.format(context) ?? 'Terapkan ke Semua Hari'}",),),),const SizedBox(height: 15),// Daily Time Pickers..._daysCo.map((day) {final time = _weeklySchedule[day];final currentTolerance =int.tryParse(_toleranceController.text) ?? 45;final String expectedArrival = time != null? _calculateArrivalTime(time, currentTolerance): "--:--";return Column(children: [ListTile(contentPadding: EdgeInsets.zero,leading: Icon(Icons.calendar_view_day,color: time != null ? Colors.orange[800] : Colors.grey,),title: Text(day,style: TextStyle(fontWeight: FontWeight.bold,color: time != null ? Colors.black : Colors.grey,),),subtitle: Text("Est. Tiba Kurir: $expectedArrival",style: const TextStyle(color: Colors.blue),),trailing: IconButton(icon: Icon(time != null ? Icons.close : Icons.access_time),onPressed: () async {if (time != null) {setState(() => _weeklySchedule[day] = null);} else {final TimeOfDay? picked = await showTimePicker(context: context,initialTime:time ??_universalTime ??const TimeOfDay(hour: 12, minute: 0),);if (picked != null) {setState(() => _weeklySchedule[day] = picked);}}},),),const Divider(height: 1),],);}).toList(),const SizedBox(height: 20),const Text("Toleransi Pengiriman:",style: TextStyle(fontWeight: FontWeight.bold),),const SizedBox(height: 10),TextFormField(controller: _toleranceController,keyboardType: TextInputType.number,decoration: const InputDecoration(labelText: "Toleransi Awal (Menit)",hintText: "45",border: OutlineInputBorder(),),validator: (v) => v!.isEmpty ? "Wajib" : null,),],);}// 2. PERUBAHAN MENU (Menggunakan Menu Set)else if (_selectedType == 'Perubahan Menu') {// Mode Customisasi aktifif (_isCustomizingMenu) {// Widget untuk memilih Menu Item per Kategorireturn Column(crossAxisAlignment: CrossAxisAlignment.start,children: [const Text("Ajukan Menu Set Baru (Kustom):",style: TextStyle(fontWeight: FontWeight.bold),),const SizedBox(height: 10),// Input Nama Set BaruTextFormField(controller: _newSetNameController,decoration: const InputDecoration(labelText: "Nama Set Menu Kustom",hintText: "Cth: SMPN 6 - Set Senin Baru",),validator: (v) => v!.isEmpty ? "Nama set wajib diisi" : null,),const SizedBox(height: 15),// Dropdown per Kategori (menggunakan data menu dari _availableMenus)..._customMenuIds.keys.map((category) {final isRequired = _requiredCategories.contains(category);final filteredMenus = _availableMenus.where((m) => m['category'] == category).toList();return Padding(padding: const EdgeInsets.only(bottom: 10),child: DropdownButtonFormField<String>(decoration: InputDecoration(labelText:"$category ${isRequired ? '(Wajib)' : '(Opsional)'}",prefixIcon: Icon(Icons.restaurant_menu),),value: _customMenuIds[category],items: [DropdownMenuItem<String>(value: null,child: Text(isRequired ? "--- Pilih Menu ---" : "--- Tidak Ada ---",),),...filteredMenus.map((menu) => DropdownMenuItem(value: menu['id'],child: Text(menu['name']),),),],onChanged: (String? newValue) =>setState(() => _customMenuIds[category] = newValue),validator: (v) => isRequired && v == null? "$category harus dipilih.": null,),);}).toList(),const SizedBox(height: 20),SizedBox(width: double.infinity,child: OutlinedButton(onPressed: () => setState(() => _isCustomizingMenu = false),child: const Text("PILIH SET LAIN (Batal Kustom)"),),),],);}// Mode Pilih Set yang Ada (Default)return Column(crossAxisAlignment: CrossAxisAlignment.start,children: [const Text("Pilih Set Menu Rutin Baru:",style: TextStyle(fontWeight: FontWeight.bold),),const SizedBox(height: 10),DropdownButtonFormField<String>(decoration: const InputDecoration(labelText: "Pilih Menu Set",border: OutlineInputBorder(),prefixIcon: Icon(Icons.menu_book),),value: _selectedMenuSetId,items: _availableMenuSets.map((set) =>DropdownMenuItem(value: set.id, child: Text(set.setName)),).toList(),onChanged: (val) => setState(() => _selectedMenuSetId = val),validator: (v) => v == null ? "Wajib pilih Menu Set" : null,),const SizedBox(height: 15),// Tampilkan tombol Kustomisasi jika ada set yang dipilihif (_selectedMenuSetId != null)SizedBox(width: double.infinity,child: ElevatedButton.icon(onPressed: () {final selectedSet = _availableMenuSets.firstWhereOrNull((set) => set.id == _selectedMenuSetId,);if (selectedSet != null) {_loadSetForCustomization(selectedSet);}},icon: const Icon(Icons.edit, color: Colors.white),label: const Text("UBAH SET INI (CUSTOM)"),style: ElevatedButton.styleFrom(backgroundColor: Colors.teal),),),],);}// 3. TAMBAH/KURANG PORSIelse if (_selectedType == 'Tambah/Kurang Porsi') {final currentCount = _schoolData?['student_count'] ?? 'Unknown';return Column(crossAxisAlignment: CrossAxisAlignment.start,children: [Text("Jumlah Penerima Rutin Saat Ini: $currentCount",style: const TextStyle(fontWeight: FontWeight.w500),),const SizedBox(height: 10),TextFormField(controller: _portionController,keyboardType: TextInputType.number,decoration: const InputDecoration(labelText: "Jumlah Porsi Baru",border: OutlineInputBorder(),prefixIcon: Icon(Icons.people),),validator: (v) => v!.isEmpty ? "Wajib diisi" : null,),],);}return const SizedBox.shrink();}Widget _buildHistoryList() {return FutureBuilder<List<ChangeRequestModel>>(future: _service.getMyRequests(),builder: (context, snapshot) {if (snapshot.connectionState == ConnectionState.waiting)return const Center(child: CircularProgressIndicator());final data = snapshot.data ?? [];if (data.isEmpty)return const Center(child: Text("Belum ada riwayat pengajuan."));return ListView.builder(shrinkWrap: true,physics: const NeverScrollableScrollPhysics(),itemCount: data.length,itemBuilder: (ctx, i) {final item = data[i];Color statusColor = item.status == 'pending'? Colors.orange: (item.status == 'approved' ? Colors.green : Colors.red);final bool canCancel = item.status == 'pending';// [BARU] Ambil catatan yang sudah diformatfinal formattedNotes = _formatRequestNotes(item.type,item.oldNotes,);return Card(margin: const EdgeInsets.symmetric(horizontal: 16, vertical: 4),child: ListTile(// JUDUL UTAMA (TIPE REQUEST + TANGGAL)title: Text("${item.type} (${item.requestDate})",style: const TextStyle(fontWeight: FontWeight.bold),),// SUBTITLE: DETAIL REQUEST & RESPON ADMINsubtitle: Column(crossAxisAlignment: CrossAxisAlignment.start,children: [// Detail Request (Sudah Diformat)Text(formattedNotes,style: const TextStyle(fontSize: 12),maxLines: 3,overflow: TextOverflow.ellipsis,),const SizedBox(height: 4),// Respon Adminif (item.adminResponse != null)Text("Respon Admin: ${item.adminResponse}",style: TextStyle(fontSize: 12,color: statusColor,fontWeight: FontWeight.bold,),),],),isThreeLine: true,// TRAILING: HANYA STATUS & CANCEL BUTTONtrailing: Row(mainAxisSize: MainAxisSize.min,children: [if (canCancel)IconButton(icon: const Icon(Icons.cancel, color: Colors.red),tooltip: "Batalkan Pengajuan",onPressed: _isLoading? null: () => _confirmCancel(item.id, item.type),),Chip(label: Text(item.status.toUpperCase(),style: const TextStyle(color: Colors.white,fontSize: 10,),),backgroundColor: statusColor,),],),),);},);},);}// [BARU HELPER] Fungsi untuk mem-parse oldNotes yang berisi hack dataString _formatRequestNotes(String type, String notes) {if (notes.isEmpty) return 'Tidak ada catatan tambahan.';try {if (type == 'Perubahan Jadwal') {final scheduleMatch = RegExp(r'REQ_JADWAL: ({.*?})').firstMatch(notes);final toleranceMatch = RegExp(r'REQ_TOLERANCE: (\d+)',).firstMatch(notes);final noteMatch = RegExp(r'Note: (.*)').firstMatch(notes);String schedule = 'Jadwal Rutin: N/A';if (scheduleMatch != null && scheduleMatch.group(1) != null) {final Map<String, dynamic> scheduleMap = jsonDecode(scheduleMatch.group(1)!,);final List<String> entries = [];scheduleMap.forEach((day, time) {entries.add('$day: ${(time as String).substring(0, 5)}');});schedule = 'Jadwal Baru: ${entries.join(', ')}';}final tolerance = toleranceMatch?.group(1) ?? 'N/A';final userNote = noteMatch?.group(1) ?? '';return '$schedule (Toleransi: $tolerance mnt). Catatan: "$userNote"';} else if (type == 'Tambah/Kurang Porsi') {final portionMatch = RegExp(r'REQ_PORSI: (\d+)').firstMatch(notes);final userNote =RegExp(r'Note: (.*)').firstMatch(notes)?.group(1) ?? '';final newPortion = portionMatch?.group(1) ?? 'N/A';return 'Diajukan Porsi Baru: $newPortion Siswa. Catatan: "$userNote"';} else if (type == 'Perubahan Menu') {// Skenario 1: Custom Set Menu Baruif (notes.contains('REQ_MENU_SET_CUSTOM:')) {final nameMatch = RegExp(r'NEW_NAME: (.*?) \|').firstMatch(notes);final newSetName = nameMatch?.group(1)?.trim() ?? 'Set Kustom Baru';return 'Ajuan Set Menu Kustom: "$newSetName" (Menunggu pembuatan set baru oleh Admin).';}// Skenario 2: Pilih Set Menu Lamaelse if (notes.contains('REQ_MENU_SET_ID:')) {final newNameMatch = RegExp(r'NEW_NAME: (.*?) \|').firstMatch(notes);final newSetName =newNameMatch?.group(1)?.trim() ?? 'Set Baru Dipilih';return 'Ganti Set Rutin ke: "$newSetName".';}// Skenario 3: Menu Item Lama (Fallback - Dihapus di skenario baru)else if (notes.contains('REQ_MENU:')) {final menuNames = notes.split('|')[0].replaceAll("REQ_MENU:", "").trim();final userNote =RegExp(r'Note: (.*)').firstMatch(notes)?.group(1) ?? '';return 'Ganti Item Menu Lama: $menuNames. Catatan: "$userNote"';}}} catch (e) {// Jika parsing gagal (format JSON rusak)return 'Gagal memformat catatan (Raw Data: $notes)';}return notes; // Fallback jika tidak ada format yang cocok}}

=== FILE: lib/features/koordinator/screens/dashboard_koordinator_screen.dart ===
// === FILE: lib/features/koordinator/screens/dashboard_koordinator_screen.dart ===import 'dart:io';import 'package:flutter/material.dart';import 'package:image_picker/image_picker.dart';import 'package:supabase_flutter/supabase_flutter.dart';import 'dart:convert';import 'package:intl/intl.dart';import 'package:table_calendar/table_calendar.dart';import 'package:collection/collection.dart'; // <--- HARUS ADA DAN KE-LOAD!import '../../autentikasi/screens/login_screen.dart';import '../services/receiving_service.dart';import '../../../core/services/storage_service.dart';import '../../../core/screens/profile_screen.dart';import 'coordinator_request_screen.dart';// FIX KRITIS: Ganti import model yang salah. DeliveryRoute ada di route_model.dartimport '../../../models/route_model.dart';import '../../shared/screens/notification_screen.dart';import '../../shared/services/notification_service.dart';// Model untuk menampung satu item masalahclass IssueItem {String type; // e.g., 'Jumlah Tidak Sesuai', 'Kemasan Rusak'TextEditingController qtyController =TextEditingController(); // Jumlah terdampak atau menit terlambatTextEditingController notesController =TextEditingController(); // Detail masalah tambahanIssueItem({required this.type});}class DashboardKoordinatorScreen extends StatefulWidget {const DashboardKoordinatorScreen({super.key});@overrideState<DashboardKoordinatorScreen> createState() =>_DashboardKoordinatorScreenState();}class _DashboardKoordinatorScreenStateextends State<DashboardKoordinatorScreen> {final ReceivingService _service = ReceivingService();final StorageService _storageService = StorageService();DateTime _focusedDay = DateTime.now();DateTime _selectedDay = DateTime.now();CalendarFormat _calendarFormat =CalendarFormat.week; // Default Minggu biar ringkas// Map menyimpan tanggal (hanya date, tanpa time) dengan list of deliveries (stops)Map<DateTime, List<Map<String, dynamic>>> _deliveries = {};bool _isLoading = true;@overridevoid initState() {super.initState();_fetchDeliveries();}// Ambil data pengiriman untuk bulan yang sedang fokusFuture<void> _fetchDeliveries() async {setState(() => _isLoading = true);try {final data = await _service.getMonthlyDeliveries(_focusedDay);Map<DateTime, List<Map<String, dynamic>>> newMap = {};for (var item in data) {// Ambil tanggal dari delivery_routes (join)final dateStr = item['delivery_routes']['date'];final date = DateTime.parse(dateStr);final dateKey = DateTime(date.year, date.month, date.day);if (newMap[dateKey] == null) newMap[dateKey] = [];newMap[dateKey]!.add(item);}if (mounted) {setState(() {_deliveries = newMap;_isLoading = false;});}} catch (e) {if (mounted) {ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Gagal load jadwal: $e"),backgroundColor: Colors.red,),);setState(() => _isLoading = false);}}}// Event Loader untuk CalendarList<Map<String, dynamic>> _getEventsForDay(DateTime day) {final dateKey = DateTime(day.year, day.month, day.day);return _deliveries[dateKey] ?? [];}// Helper untuk mendapatkan warna statusColor _getStatusColor(String status) {switch (status) {case 'received':return Colors.green;case 'issue_reported':return Colors.red;case 'completed':return Colors.green;default:return Colors.orange;}}// Format waktu dari HH:mm:ss ke HH:mmString _formatTime(String? timeStr) {if (timeStr == null || timeStr.isEmpty) return "--:--";try {// Ambil 5 karakter pertama (HH:mm)return timeStr.substring(0, 5);} catch (_) {return timeStr;}}// Helper untuk mendapatkan nama Koordinator (asumsi profile data sudah di cache atau bisa di-fetch)// Karena kita tidak punya data profiles di state, kita akan gunakan nama default untuk demoString _getDefaultRecipientName() {// Dalam aplikasi nyata, ini diambil dari shared preference atau state user profilereturn "Koordinator Sekolah";}// [BARU] Function untuk memunculkan dialog konfirmasi penerimaanvoid _showReceptionDialog(Map<String, dynamic> stopData) {final stopId = stopData['id'];final schoolData = stopData['schools'];final schoolName = schoolData?['name'] ?? 'Sekolah Tidak Dikenal';final currentQty = schoolData?['student_count'] ?? 0;final recipientController = TextEditingController(text: _getDefaultRecipientName(),);// State untuk form utamafinal formKey = GlobalKey<FormState>();final receivedQtyController = TextEditingController(text: currentQty.toString(),);// State untuk Multi-MasalahList<IssueItem> currentIssues = [];File? photoFile;bool isSubmitting = false;const List<String> issueOptions = ['Jumlah Tidak Sesuai','Kemasan Rusak','Terlambat','Lain-lain',];showDialog(context: context,barrierDismissible: false,builder: (ctx) => StatefulBuilder(builder: (context, setDialogState) {// Helper untuk me-render input dinamis berdasarkan tipe masalahWidget _buildIssueInput(IssueItem issue, int currentQty) {// <-- Tambahkan currentQtyswitch (issue.type) {case 'Jumlah Tidak Sesuai':return Column(crossAxisAlignment: CrossAxisAlignment.start,children: [const SizedBox(height: 5), // Gap di dalam CardText("Kuantitas Target: $currentQty Porsi",style: const TextStyle(fontWeight: FontWeight.bold),),const SizedBox(height: 10),TextFormField(controller: issue.qtyController,keyboardType: TextInputType.number,decoration: const InputDecoration(labelText:"Kekurangan Total (Porsi)", // Mengacu pada jumlah yang kuranghintText: "Contoh: 10",),validator: (v) => (v == null || v.isEmpty)? "Wajib isi jumlah kekurangan": null,),const SizedBox(height: 10), // Gap antar fieldsTextFormField(controller: issue.notesController,decoration: const InputDecoration(labelText: "Detail Masalah (Opsional)",),maxLines: 2,),],);case 'Kemasan Rusak':return Column(crossAxisAlignment: CrossAxisAlignment.start,children: [const SizedBox(height: 5),TextFormField(controller: issue.qtyController,keyboardType: TextInputType.number,decoration: const InputDecoration(labelText: "Jumlah Kotak yang Rusak (Total)",),validator: (v) => (v == null || v.isEmpty)? "Wajib isi jumlah kotak rusak": null,),const SizedBox(height: 10), // Gap antar fieldsTextFormField(controller: issue.notesController,decoration: const InputDecoration(labelText: "Detail Kerusakan (Wajib Diisi)",),maxLines: 3,validator: (v) => (v == null || v.isEmpty)? "Detail kerusakan wajib diisi.": null,),],);case 'Terlambat':return Column(crossAxisAlignment: CrossAxisAlignment.start,children: [const SizedBox(height: 5),TextFormField(controller: issue.qtyController,keyboardType: TextInputType.number,decoration: const InputDecoration(labelText: "Keterlambatan (Menit)",hintText: "Contoh: 30",),validator: (v) => (v == null || v.isEmpty)? "Wajib isi durasi keterlambatan": null,),const SizedBox(height: 10), // Gap antar fieldsTextFormField(controller: issue.notesController,decoration: const InputDecoration(labelText: "Alasan Terlambat (Opsional)",),maxLines: 2,),],);case 'Lain-lain':default:return Column(children: [const SizedBox(height: 5),TextFormField(controller: issue.notesController,decoration: const InputDecoration(labelText: "Detail Masalah Lainnya (Wajib Diisi)",),maxLines: 3,validator: (v) => (v == null || v.isEmpty)? "Detail masalah wajib diisi.": null,),],);}}// Fungsi untuk menambahkan masalah baruvoid _addIssue(String type) {if (currentIssues.length >= 3) {ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Maksimal 3 jenis masalah!")),);return;}setDialogState(() {currentIssues.add(IssueItem(type: type));});}// Logic SimpanFuture<void> _handleSubmission() async {if (!formKey.currentState!.validate()) return;final hasIssue = currentIssues.isNotEmpty;if (hasIssue && photoFile == null) {if (!mounted) return;ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Semua laporan masalah butuh foto bukti!"),backgroundColor: Colors.red,),);return;}setDialogState(() => isSubmitting = true);String? uploadedUrl;try {// Upload foto jika ada masalahif (photoFile != null) {uploadedUrl = await _storageService.uploadEvidence(photoFile!,'coordinator_reception',);}// Format List Issues ke JSON payloadList<Map<String, dynamic>> issuePayload = currentIssues.map((issue,) {final quantity = int.tryParse(issue.qtyController.text) ?? 0;// Hitung Quantity Defisit jika Jumlah Tidak Sesuaiint deficit = 0;if (issue.type == 'Jumlah Tidak Sesuai') {final received =int.tryParse(receivedQtyController.text) ?? 0;// Simpan selisih (kurangnya) di payloaddeficit = currentQty - received;}return {'type': issue.type,'notes': issue.notesController.text.trim(),'qty_impacted': (issue.type == 'Jumlah Tidak Sesuai')? deficit: quantity,'received_qty': (issue.type == 'Jumlah Tidak Sesuai')? quantity: null, // Kuantitas Diterima (untuk rekonsiliasi)'expected_qty': currentQty,};}).toList();// Panggil service untuk konfirmasiawait _service.confirmReception(stopId: stopId,receivedQty: int.tryParse(receivedQtyController.text) ?? 0,recipientName: recipientController.text.trim(),issues: issuePayload,proofUrl: uploadedUrl,);if (!mounted) return;Navigator.pop(ctx);await _fetchDeliveries(); // Refresh jadwalScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text(hasIssue? "Keluhan Terkirim ke Admin SPPG!": "Konfirmasi Selesai!",),backgroundColor: hasIssue ? Colors.red : Colors.green,),);} catch (e) {if (!mounted) return;ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Gagal Simpan: $e"),backgroundColor: Colors.red,),);} finally {if (mounted) setDialogState(() => isSubmitting = false);}}return AlertDialog(title: Text("Konfirmasi Penerimaan: $schoolName"),content: Form(key: formKey,child: SingleChildScrollView(child: Column(mainAxisSize: MainAxisSize.min,crossAxisAlignment: CrossAxisAlignment.start,children: [const Text("Kuantitas Seharusnya:"),Text("$currentQty Porsi",style: const TextStyle(fontWeight: FontWeight.bold,fontSize: 16,color: Colors.teal,),),const SizedBox(height: 10,), // Margin setelah Kuantitas Seharusnya// --- Kuantitas Diterima ---TextFormField(controller: receivedQtyController,keyboardType: TextInputType.number,decoration: const InputDecoration(labelText: "Kuantitas Diterima (Porsi)",),validator: (v) => v!.isEmpty ? "Wajib diisi" : null,onChanged: (v) {final received = int.tryParse(v) ?? 0;if (received < currentQty &&currentIssues.where((i) => i.type == 'Jumlah Tidak Sesuai').isEmpty) {setDialogState(() {_addIssue('Jumlah Tidak Sesuai');});}},),const SizedBox(height: 15,), // Margin setelah Kuantitas Diterima// --- Nama Penerima (Default Koordinator) ---TextFormField(controller: recipientController,decoration: const InputDecoration(labelText: "Nama Penerima",),validator: (v) => v!.isEmpty ? "Wajib diisi" : null,),const SizedBox(height: 25,), // Margin sebelum Section Masalah// --- SECTION LAPOR MASALAH HEADER ---const Text("Laporkan Masalah Kualitas/Kuantitas:",style: TextStyle(fontWeight: FontWeight.bold,fontSize: 16,),),const Divider(), // Divider sudah cukup sebagai pemisah visual.// Daftar Masalah yang Ditambahkan...currentIssues.mapIndexed((index, issue) {return Padding(// <-- PADDING DI SINI!padding: const EdgeInsets.only(bottom: 10,), // Margin antar Card Masalahchild: Card(color: Colors.red[50],margin: EdgeInsets.zero, // Hapus margin default Card jika pakai Paddingchild: Padding(padding: const EdgeInsets.all(12.0,), // Padding di dalam Cardchild: Column(crossAxisAlignment: CrossAxisAlignment.start,children: [Row(mainAxisAlignment:MainAxisAlignment.spaceBetween,children: [Text("⚠️ ${issue.type}",style: const TextStyle(fontWeight: FontWeight.bold,color: Colors.red,),),IconButton(icon: const Icon(Icons.close,size: 20,color: Colors.red,),onPressed: () => setDialogState(() => currentIssues.removeAt(index),),),],),const SizedBox(height: 8,), // Margin sebelum input dinamis_buildIssueInput(issue,currentQty,), // Panggil helper dengan currentQty],),),),);}).toList(),// Dropdown Tambah Masalah BaruDropdownButtonFormField<String?>(decoration: const InputDecoration(labelText: "Tambah Jenis Masalah",),value: null,items: issueOptions.map((e) => DropdownMenuItem(value: e, child: Text(e)),).toList(),onChanged: (val) {if (val != null) {_addIssue(val);}},),if (currentIssues.isNotEmpty) ...[const SizedBox(height: 20),// ... (Foto Bukti section remains the same)const Text("Foto Bukti (Wajib):",style: TextStyle(fontWeight: FontWeight.bold),),const SizedBox(height: 5),GestureDetector(onTap: () async {final file = await _storageService.pickImage(ImageSource.camera,);if (file != null)setDialogState(() => photoFile = file);},child: Container(height: 100,width: double.infinity,decoration: BoxDecoration(color: Colors.grey[200],border: Border.all(color: Colors.red),),child: photoFile == null? const Column(mainAxisAlignment: MainAxisAlignment.center,children: [Icon(Icons.camera_alt,size: 30,color: Colors.red,),Text("Ambil Foto Bukti Masalah"),],): Image.file(photoFile!, fit: BoxFit.cover),),),const SizedBox(height: 5),],],),),),actions: [TextButton(onPressed: () => Navigator.pop(ctx),child: const Text("Batal"),),ElevatedButton(onPressed: isSubmitting ? null : _handleSubmission,style: ElevatedButton.styleFrom(backgroundColor: currentIssues.isEmpty? Colors.teal: Colors.red,foregroundColor: Colors.white,),child: isSubmitting? const CircularProgressIndicator(color: Colors.white): Text(currentIssues.isEmpty? "KONFIRMASI AMAN": "LAPOR MASALAH",),),],);},),);}@overrideWidget build(BuildContext context) {return Scaffold(appBar: AppBar(title: const Text("Koordinator Dashboard"),backgroundColor: Colors.teal[800],foregroundColor: Colors.white,actions: [// TOMBOL PENGAJUAN (REQUEST)IconButton(icon: const Icon(Icons.mail_outline),tooltip: "Pengajuan Perubahan",onPressed: () {Navigator.push(context,MaterialPageRoute(builder: (_) => const CoordinatorRequestScreen(),),);},),// [BARU] TOMBOL NOTIFIKASIFutureBuilder<int>(future: NotificationService().getUnreadCount(),builder: (context, snapshot) {final unreadCount = snapshot.data ?? 0;return IconButton(icon: Badge(isLabelVisible: unreadCount > 0,label: Text('$unreadCount'),child: const Icon(Icons.notifications),),tooltip: "Notifikasi",onPressed: () {Navigator.push(context,MaterialPageRoute(builder: (_) => const NotificationScreen(),),).then((value) => setState(() {}),); // Refresh dashboard setelah kembali},);},),IconButton(icon: const Icon(Icons.account_circle, size: 30),tooltip: "Profil & Password",onPressed: () {Navigator.push(context,MaterialPageRoute(builder: (_) => const ProfileScreen()),);},),],),body: Column(children: [// --- KALENDER ---TableCalendar<Map<String, dynamic>>(firstDay: DateTime.utc(2024, 1, 1),lastDay: DateTime.utc(2030, 12, 31),focusedDay: _focusedDay,selectedDayPredicate: (day) => isSameDay(_selectedDay, day),calendarFormat: _calendarFormat,eventLoader: _getEventsForDay,onDaySelected: (selected, focused) {setState(() {_selectedDay = selected;_focusedDay = focused;});},onPageChanged: (focused) {_focusedDay = focused;_fetchDeliveries(); // Refresh data saat bulan berubah},calendarStyle: const CalendarStyle(markerDecoration: BoxDecoration(color: Colors.teal, // Warna untuk hari ada jadwalshape: BoxShape.circle,),todayDecoration: BoxDecoration(color: Colors.blue,shape: BoxShape.circle,),selectedDecoration: BoxDecoration(color: Colors.orange, // Warna untuk hari yang dipilihshape: BoxShape.circle,),),headerStyle: const HeaderStyle(formatButtonVisible: false,titleCentered: true,),),const Divider(thickness: 1),// --- LIST PENGIRIMAN HARI INI ---Padding(padding: const EdgeInsets.all(8.0),child: Text("Jadwal Penerimaan Tgl ${DateFormat('d MMMM yyyy', 'id_ID').format(_selectedDay)}",style: const TextStyle(fontWeight: FontWeight.bold),),),Expanded(child: _isLoading? const Center(child: CircularProgressIndicator()): _buildDayList(),),],),);}// Helper untuk menampilkan detail pengaduan dari JSONString _formatIssueDetails(List<dynamic> issues) {if (issues.isEmpty) return "Tidak ada masalah dilaporkan.";return issues.map((issue) {final type = issue['type'];final notes = issue['notes'] ?? '-';final qty = issue['qty_impacted'] ?? 0;if (type == 'Jumlah Tidak Sesuai') {return "• Kekurangan: $qty Porsi. Catatan: $notes";} else if (type == 'Kemasan Rusak') {return "• Rusak: $qty Kotak. Detail: $notes";} else if (type == 'Terlambat') {return "• Terlambat: $qty Menit. Alasan: $notes";} else {return "• $type: $notes";}}).join('\n');}void _showHistoryDetailDialog(Map<String, dynamic> stopData) {final schoolName = stopData['schools']['name'] ?? 'N/A';final receivedQty = stopData['received_qty'] ?? 0;final recipient = stopData['recipient_name'] ?? 'N/A';final isIssue = stopData['status'] == 'issue_reported';// Masalah tersimpan di issue_details (JSONB)List<dynamic> issueDetails = [];final issueJson = stopData['issue_details'];if (issueJson != null) {try {// Supabase mengembalikan JSONB sebagai String atau Map<String, dynamic>if (issueJson is String) {issueDetails = jsonDecode(issueJson);} else if (issueJson is List) {issueDetails = issueJson;}} catch (_) {// Fail silently}}showDialog(context: context,builder: (ctx) => AlertDialog(title: Text("Riwayat Penerimaan: $schoolName"),content: SingleChildScrollView(child: Column(crossAxisAlignment: CrossAxisAlignment.start,mainAxisSize: MainAxisSize.min,children: [_buildInfoRow(Icons.check_circle_outline,"Status Akhir",isIssue ? "MASALAH DILAPORKAN" : "DITERIMA AMAN",color: isIssue ? Colors.red : Colors.green,),_buildInfoRow(Icons.person, "Penerima", recipient),_buildInfoRow(Icons.inventory,"Kuantitas Diterima","$receivedQty Porsi",),const Divider(height: 20),Text(isIssue ? "DETAIL MASALAH:" : "RINCIAN PENERIMAAN:",style: const TextStyle(fontWeight: FontWeight.bold),),const SizedBox(height: 8),// Tampilkan Detail Masalah / NotesContainer(padding: const EdgeInsets.all(12),width: double.infinity,decoration: BoxDecoration(color: isIssue ? Colors.red[50] : Colors.green[50],borderRadius: BorderRadius.circular(8),),child: Text(isIssue? _formatIssueDetails(issueDetails): stopData['reception_notes'] ??"Penerimaan dicatat aman.",style: TextStyle(color: isIssue ? Colors.red[900] : Colors.green[900],),),),// Bukti Foto Penerimaan (jika ada)if (stopData['proof_photo_url'] != null) ...[const SizedBox(height: 15),const Text("Foto Bukti Penerimaan:",style: TextStyle(fontWeight: FontWeight.bold),),const SizedBox(height: 8),GestureDetector(onTap: () => _showImageDialog(ctx,stopData['proof_photo_url'],"Foto Bukti Penerimaan",),child: Image.network(stopData['proof_photo_url'],height: 100,fit: BoxFit.cover,),),],],),),actions: [TextButton(onPressed: () => Navigator.pop(ctx),child: const Text("Tutup"),),],),);}// Helper untuk info row (diperlukan di dalam dialog)Widget _buildInfoRow(IconData icon,String title,String value, {Color color = Colors.black87,}) {return Padding(padding: const EdgeInsets.symmetric(vertical: 4.0),child: Row(children: [Icon(icon, size: 18, color: Colors.grey),const SizedBox(width: 8),Text("$title: ", style: const TextStyle(fontWeight: FontWeight.w500)),Expanded(child: Text(value, style: TextStyle(color: color)),),],),);}// Helper untuk menampilkan dialog gambar (pindah dari EditRouteScreen)void _showImageDialog(BuildContext context, String url, String title) {showDialog(context: context,builder: (ctx) => AlertDialog(title: Text(title),content: SizedBox(width: MediaQuery.of(context).size.width * 0.9,height: MediaQuery.of(context).size.height * 0.7,child: Image.network(url, fit: BoxFit.contain),),actions: [TextButton(onPressed: () => Navigator.pop(ctx),child: const Text("Tutup"),),],),);}// Widget untuk menampilkan daftar pengiriman di hari yang dipilihWidget _buildDayList() {final deliveries = _getEventsForDay(_selectedDay);if (deliveries.isEmpty) {return const Center(child: Text("Tidak ada jadwal pengiriman atau masalah terdeteksi hari ini.",),);}// Urutkan berdasarkan waktu kedatangan yang terestimasi (estimated_arrival_time)deliveries.sort((a, b) => _formatTime(a['estimated_arrival_time'],).compareTo(_formatTime(b['estimated_arrival_time'])),);return ListView.builder(itemCount: deliveries.length,itemBuilder: (context, index) {final stop = deliveries[index];final route = stop['delivery_routes'];final status = stop['status'] ?? 'pending';final estimatedArrival = _formatTime(stop['estimated_arrival_time']);final isFinalizedByKoord =status == 'received' || status == 'issue_reported';final isCourierArrived = status == 'completed';// Ambil info pengirim dari tabel vehicles (join melalui routes)final vehiclePlate = route['vehicles']?['plate_number'] ?? 'N/A';return Card(color: isFinalizedByKoord? (status == 'issue_reported' ? Colors.red[50] : Colors.green[50]): (status == 'completed' ? Colors.orange[50] : Colors.white),margin: const EdgeInsets.symmetric(horizontal: 16, vertical: 4),child: ListTile(// [FIX KRITIS]: Tambahkan onTap di sinionTap: () {// Hanya aktif jika sudah Final (received / issue_reported)if (isFinalizedByKoord) {_showHistoryDetailDialog(stop);}},leading: Icon(isFinalizedByKoord? Icons.check_circle: (status == 'issue_reported' ? Icons.warning : Icons.timer),color: _getStatusColor(status),),title: Text("Est. Tiba: $estimatedArrival",style: const TextStyle(fontWeight: FontWeight.bold),),subtitle: Text("Armada: $vehiclePlate\nStatus: ${status.toUpperCase()}",style: const TextStyle(fontSize: 12),),trailing: isFinalizedByKoord? const Icon(Icons.info,color: Colors.blueGrey,) // Ganti icon check/etc. menjadi info: (isCourierArrived? ElevatedButton(onPressed: () => _showReceptionDialog(stop),style: ElevatedButton.styleFrom(backgroundColor: Colors.teal,padding: const EdgeInsets.symmetric(horizontal: 8),),child: const Text("Konfirmasi",style: TextStyle(color: Colors.white),),): Text(status.toUpperCase(),style: const TextStyle(fontSize: 12,color: Colors.grey,),)),),);},);}}

=== FILE: lib/features/koordinator/services/receiving_service.dart ===
import 'package:supabase_flutter/supabase_flutter.dart';import 'dart:convert'; // Import untuk jsonEncodeclass ReceivingService {final _supabase = Supabase.instance.client;// Helper: Ambil School ID userFuture<String> _getMySchoolId() async {final userId = _supabase.auth.currentUser!.id;final profile = await _supabase.from('profiles').select('school_id').eq('id', userId).single();final String? mySchoolId = profile['school_id'];if (mySchoolId == null)throw Exception("Akun ini tidak terhubung ke sekolah manapun.");return mySchoolId;}// 1. AMBIL JADWAL PENGIRIMAN BULANAN (Untuk Kalender)Future<List<Map<String, dynamic>>> getMonthlyDeliveries(DateTime month,) async {try {final mySchoolId = await _getMySchoolId();// Tentukan awal & akhir bulanfinal startDate = DateTime(month.year, month.month, 1);final endDate = DateTime(month.year, month.month + 1, 0);// Join: delivery_stops -> delivery_routes (filter tanggal) -> vehiclesfinal response = await _supabase.from('delivery_stops').select(// KRITIS: TAMBAHKAN JOIN KE TABEL SCHOOLS'*, delivery_routes!inner(date, vehicles(plate_number, driver_name)), schools(name, student_count)',).eq('school_id', mySchoolId);return List<Map<String, dynamic>>.from(response);} catch (e) {throw Exception("Gagal ambil jadwal koordinator: $e");}}// 2. KONFIRMASI PENERIMAAN (Diperbarui untuk Multi-Problem Reporting)Future<void> confirmReception({required String stopId,required int receivedQty,required String recipientName,required List<Map<String, dynamic>> issues, // BARU: List of issuesString? proofUrl,}) async {try {// Tentukan status akhir: 'received' jika tidak ada masalah, 'issue_reported' jika adafinal String status = issues.isEmpty ? 'received' : 'issue_reported';// Simpan issues array sebagai JSON string/objectfinal issuesJson = issues.isEmpty ? null : jsonEncode(issues);// Ambil ID Koordinator yang sedang loginfinal userId = _supabase.auth.currentUser!.id;await _supabase.from('delivery_stops').update({'status': status,'received_qty': receivedQty,'recipient_name': recipientName,'completion_time': DateTime.now().toIso8601String(),'proof_photo_url': proofUrl, // Bukti foto penerimaan'issue_details':issuesJson, // BARU: Detail masalah dalam bentuk JSONB'koordinator_id':userId, // BARU: Simpan ID Koordinator yang melaporkan}).eq('id', stopId);} catch (e) {throw Exception("Gagal konfirmasi: $e");}}}

=== FILE: lib/features/shared/screens/notification_screen.dart ===
import 'package:flutter/material.dart';import '../services/notification_service.dart';import 'package:intl/intl.dart';class NotificationScreen extends StatelessWidget {const NotificationScreen({super.key});// [BARU] Fungsi Mark All ReadFuture<void> _markAllAsRead(BuildContext context) async {try {await NotificationService().markAllAsRead();if (context.mounted) {ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Semua notifikasi ditandai sudah dibaca"),),);}// Tidak perlu setState karena StreamBuilder akan rebuild otomatis} catch (e) {if (context.mounted) {ScaffoldMessenger.of(context,).showSnackBar(SnackBar(content: Text("Gagal mark all read: $e")));}}}@overrideWidget build(BuildContext context) {return Scaffold(appBar: AppBar(title: const Text("Notifikasi"),backgroundColor: Colors.white,foregroundColor: Colors.black,elevation: 1,// [BARU] Tombol Mark All Readactions: [TextButton(onPressed: () => _markAllAsRead(context),child: const Text("Tandai Semua Sudah Dibaca"),),],),body: StreamBuilder<List<NotificationModel>>(stream: NotificationService().getMyNotificationsStream(),builder: (context, snapshot) {if (snapshot.connectionState == ConnectionState.waiting) {return const Center(child: CircularProgressIndicator());}final data = snapshot.data ?? [];if (data.isEmpty) {return const Center(child: Text("Belum ada notifikasi."));}return ListView.builder(itemCount: data.length,itemBuilder: (context, index) {final item = data[index];return Card(color: item.isRead? Colors.white: Colors.blue[50], // Warna beda kalau belum bacamargin: const EdgeInsets.symmetric(horizontal: 10, vertical: 5),child: ListTile(leading: _getIcon(item.type),title: Text(item.title,style: TextStyle(fontWeight: item.isRead? FontWeight.normal: FontWeight.bold,),),subtitle: Column(crossAxisAlignment: CrossAxisAlignment.start,children: [Text(item.body),const SizedBox(height: 5),Text(DateFormat('dd MMM HH:mm').format(item.createdAt),style: const TextStyle(fontSize: 10,color: Colors.grey,),),],),onTap: () {// Tandai sudah dibacaNotificationService().markAsRead(item.id);},),);},);},),);}Icon _getIcon(String type) {if (type == 'error') return const Icon(Icons.error, color: Colors.red);if (type == 'warning')return const Icon(Icons.warning, color: Colors.orange);if (type == 'success')return const Icon(Icons.check_circle, color: Colors.green);return const Icon(Icons.notifications, color: Colors.blue);}}

=== FILE: lib/features/shared/services/notification_service.dart ===
import 'package:supabase_flutter/supabase_flutter.dart';class NotificationModel {final String id;final String title;final String body;final String type;final bool isRead;final DateTime createdAt;NotificationModel({required this.id,required this.title,required this.body,required this.type,required this.isRead,required this.createdAt,});factory NotificationModel.fromJson(Map<String, dynamic> json) {return NotificationModel(id: json['id'],title: json['title'],body: json['body'],type: json['type'] ?? 'info',isRead: json['is_read'] ?? false,createdAt: DateTime.parse(json['created_at']),);}}class NotificationService {final _supabase = Supabase.instance.client;// 1. KIRIM NOTIFIKASI (Dipanggil oleh Service Lain)Future<void> sendNotification({required String recipientId,required String title,required String body,String type = 'info',String? relatedId,}) async {try {await _supabase.from('notifications').insert({'user_id': recipientId,'title': title,'body': body,'type': type,'related_id': relatedId,});} catch (e) {print("Gagal kirim notif: $e");}}// 2. AMBIL STREAM NOTIFIKASI (Realtime)Stream<List<NotificationModel>> getMyNotificationsStream() {final myId = _supabase.auth.currentUser!.id;return _supabase.from('notifications').stream(primaryKey: ['id']).eq('user_id', myId).order('created_at', ascending: false).map((data) =>data.map((json) => NotificationModel.fromJson(json)).toList(),);}// 3. TANDAI SUDAH DIBACAFuture<void> markAsRead(String notificationId) async {await _supabase.from('notifications').update({'is_read': true}).eq('id', notificationId);}// [BARU] 3B. TANDAI SEMUA SUDAH DIBACAFuture<void> markAllAsRead() async {final myId = _supabase.auth.currentUser!.id;await _supabase.from('notifications').update({'is_read': true}).eq('user_id', myId).eq('is_read', false);}// 4. HITUNG BELUM DIBACA (Untuk Badge Lonceng)Future<int> getUnreadCount() async {final myId = _supabase.auth.currentUser!.id;// Di Supabase terbaru, ini langsung mengembalikan angka (int)final count = await _supabase.from('notifications').count(CountOption.exact).eq('user_id', myId).eq('is_read', false);return count; // <--- FIX KRITIS: Hapus .count. Hasilnya sudah INT.}}

=== FILE: lib/features/shared/services/request_service.dart ===
import 'package:supabase_flutter/supabase_flutter.dart';import 'package:intl/intl.dart';import 'package:flutter/material.dart';import 'dart:convert';import '../../admin_sppg/services/schedule_service.dart';// [BARU] Import service Menu untuk akses Menu Setsimport '../../admin_sppg/services/menu_service.dart';// [FIX KRITIS 1]: Import Menu Model yang Hilangimport '../../../models/menu_model.dart'; // <--- HARUS ADAimport '../../admin_sppg/services/menu_service.dart'; // <-- Tipe AdminMenuSetModel ada di sini, tapi kita harus pastikan MenuModel juga adaimport 'package:collection/collection.dart';// Model untuk Detail Requestclass RequestDetail {final String menuId;final String menuName;final int newQuantity;final TimeOfDay? newTime;final DateTime? newDate;final String? proposedMenuNames; // Untuk Change Menu SetRequestDetail({required this.menuId,required this.menuName,this.newQuantity = 0,this.newTime,this.newDate,this.proposedMenuNames,});}class ChangeRequestModel {final String id;final Stringtype; // 'Perubahan Jadwal', 'Perubahan Menu', 'Tambah/Kurang Porsi'final String oldNotes; // Kita pakai ini untuk deskripsi singkat / JSON stringfinal String status; // pending, approved, rejectedfinal String? adminResponse;final String requestDate;final String schoolName;final String schoolId; // Butuh ini buat update data sekolah pas approve// Data detail (parsed)final int? newQuantity;final String? newDateStr;ChangeRequestModel({required this.id,required this.type,required this.oldNotes,required this.status,this.adminResponse,required this.requestDate,required this.schoolName,required this.schoolId,this.newQuantity,this.newDateStr,});factory ChangeRequestModel.fromJson(Map<String, dynamic> json) {// Coba ambil detail dari relasi (jika ada)// Supabase join response structure might vary, simplified here:int? qty;String? dateStr;// Logic extraction kasar karena keterbatasan schema// Idealnya ambil dari tabel detail, tapi untuk list view kita bisa taruh di notes/metadatareturn ChangeRequestModel(id: json['id'].toString(),type: json['request_type'] ?? '-',oldNotes: json['old_notes'] ?? '-',status: json['status'] ?? 'pending',adminResponse: json['admin_response'],requestDate: DateFormat('dd MMM HH:mm',).format(DateTime.parse(json['created_at'])),schoolName: json['schools'] != null ? json['schools']['name'] : 'Sekolah',schoolId: json['school_id'].toString(),);}}class RequestService {final MenuService _menuService = MenuService(); // <-- BARUfinal _supabase = Supabase.instance.client;final ScheduleService _scheduleService = ScheduleService();// 0. AMBIL MENU SPPG (Untuk Dropdown)Future<List<Map<String, dynamic>>> getSppgMenus() async {try {final userId = _supabase.auth.currentUser!.id;// Get SPPG ID from profile (Coordinator)final profile = await _supabase.from('profiles').select('sppg_id').eq('id', userId).single();final String mySppgId = profile['sppg_id'];final response = await _supabase.from('menus').select().eq('sppg_id', mySppgId).order('category', ascending: true);return List<Map<String, dynamic>>.from(response);} catch (e) {throw Exception("Gagal ambil menu: $e");}}// [BARU] 0B. Ambil List Menu Set (Dipanggil Koordinator)Future<List<AdminMenuSetModel>> getMyMenuSets() async {final userId = _supabase.auth.currentUser!.id;final profile = await _supabase.from('profiles').select('sppg_id').eq('id', userId).single();final String mySppgId = profile['sppg_id'];// Query sama seperti di MenuService.getMyMenuSetsfinal response = await _supabase.from('menu_sets').select('*, karbo_menus:karbo_id(name), protein_menus:protein_id(name), sayur_menus:sayur_id(name), buah_menus:buah_id(name), nabati_menus:nabati_id(name), pelengkap_menus:pelengkap_id(name), total_energy, total_protein, total_fat, total_carbs',).eq('sppg_id', mySppgId).order('set_name', ascending: true);return (response as List).map((json) => AdminMenuSetModel.fromJson(json)).toList();}// [BARU] AMBIL DATA SEKOLAH SENDIRI (Untuk Default Values)Future<Map<String, dynamic>> getMySchoolDetails() async {try {final userId = _supabase.auth.currentUser!.id;final profile = await _supabase.from('profiles').select('school_id').eq('id', userId).single();final String? schoolId = profile['school_id'];if (schoolId == null) throw Exception("Akun tidak terhubung sekolah.");final school = await _supabase.from('schools').select().eq('id', schoolId).single();return school; // Berisi student_count, deadline_time, tolerance_minutes, menu_default} catch (e) {throw Exception("Gagal load data sekolah: $e");}}// --- 1. KOORDINATOR: KIRIM REQUEST ---Future<void> submitStructuredRequest({required String type,String?notes, // Catatan User (sekarang berisi summary REQ_TYPE: VALUE | Note: ...)required List<RequestDetail> details, // Detail Perubahan}) async {try {final userId = _supabase.auth.currentUser!.id;final profile = await _supabase.from('profiles').select('school_id, sppg_id').eq('id', userId).single();// Kita anggap 'notes' yang masuk ke sini adalah data yang sudah diolah di screen (REQ_JADWAL:...)String summaryData = notes ?? "";await _supabase.from('change_requests').insert({'requester_id': userId,'school_id': profile['school_id'],'sppg_id': profile['sppg_id'],'request_type': type,'old_notes': summaryData, // <-- Data KOTOR/HACK disimpan di sini'status': 'pending',});// NOTE: Logika INSERT ke change_request_details DITIADAKAN untuk mengikuti hack notes} catch (e) {throw Exception("Gagal kirim request: $e");}}// --- 2. GET HISTORY (User & Admin) ---Future<List<ChangeRequestModel>> getMyRequests() async {final userId = _supabase.auth.currentUser!.id;final response = await _supabase.from('change_requests').select('*, schools(name)').eq('requester_id', userId).order('created_at', ascending: false);return (response as List).map((json) => ChangeRequestModel.fromJson(json)).toList();}Future<List<ChangeRequestModel>> getIncomingRequests({DateTime? date, // BARUString? schoolId, // BARU}) async {final userId = _supabase.auth.currentUser!.id;final profile = await _supabase.from('profiles').select('sppg_id').eq('id', userId).single();final String mySppgId = profile['sppg_id'];// [FIX KRITIS SUPABASE SYNTAX]: Mulai dengan select('*') tanpa parameter options// agar PostgrestFilterBuilder di bawah tidak error.var query = _supabase.from('change_requests').select('*') // <-- FIX: select('*') saja.eq('sppg_id', mySppgId);// B. Terapkan Filter Tanggalif (date != null) {final dateStr = DateFormat('yyyy-MM-dd').format(date);query = query.gte('created_at', dateStr).lt('created_at',DateFormat('yyyy-MM-dd').format(date.add(const Duration(days: 1))),);}// C. Terapkan Filter Sekolahif (schoolId != null) {query = query.eq('school_id', schoolId);}// D. Lakukan SELECT dengan JOIN (Ini menimpa select('*') di atas)final response = await query.select('*, schools(name)').order('created_at', ascending: false);return (response as List).map((json) => ChangeRequestModel.fromJson(json)).toList();}// --- 4. ADMIN: RESPON & APPLY CHANGES (FINAL FIX for Routine Schedule) ---Future<void> respondRequest({required String requestId,required String status,required String adminNote,required ChangeRequestModel requestData,}) async {try {// 1. Update Status Requestawait _supabase.from('change_requests').update({'status': status,'admin_response': adminNote,'updated_at': DateTime.now().toIso8601String(),}).eq('id', requestId);// 2. JIKA APPROVED -> APPLY CHANGESif (status == 'approved') {final String schoolId = requestData.schoolId;final String notes = requestData.oldNotes;// --- C. PERUBAHAN MENU: Ganti Set Menu (Bisa Set Lama atau Set Baru) ---if (requestData.type == 'Perubahan Menu') {// a) LOGIC UNTUK MENU SET BARU (CUSTOM)if (notes.contains("REQ_MENU_SET_CUSTOM:")) {// 1. Ekstrak datafinal rawMenuIdsPart = notes.split('|')[0].replaceAll("REQ_MENU_SET_CUSTOM:", "").trim();final newNamePart = notes.split('|')[1].replaceAll("NEW_NAME:", "").trim();final Map<String, dynamic> customIds = jsonDecode(rawMenuIdsPart);// 2. Hitung Total Gizi dari Menu Item ID yang dipilihfinal Map<String, double> totals = {'total_energy': 0,'total_protein': 0.0,'total_fat': 0.0,'total_carbs': 0.0,};final List<Menu> allMenus = await _menuService.getMyMenus();for (var id in customIds.values) {if (id != null) {final menu = allMenus.firstWhereOrNull((m) => m.id == id);if (menu != null) {totals['total_energy'] =totals['total_energy']! + menu.energy.toDouble();totals['total_protein'] =totals['total_protein']! + menu.protein;totals['total_fat'] = totals['total_fat']! + menu.fat;totals['total_carbs'] = totals['total_carbs']! + menu.carbs;}}}// 3. Buat Menu Set Baru di DBfinal Map<String, dynamic> newSetData = {'set_name': newNamePart,'karbo_id': customIds['Karbo'],'protein_id': customIds['Lauk Protein'],'sayur_id': customIds['Sayur'],'buah_id': customIds['Buah'],'nabati_id': customIds['Lauk Nabati'],'pelengkap_id': customIds['Pelengkap'],'total_energy': totals['total_energy']!.toInt(),'total_protein': totals['total_protein'],'total_fat': totals['total_fat'],'total_carbs': totals['total_carbs'],};await _menuService.createMenuSet(newSetData); // <-- Buat set baru// 4. Update Sekolah menggunakan Nama Set Baruawait _supabase.from('schools').update({'menu_default': newNamePart, // <-- Gunakan nama set baru}).eq('id', schoolId);}// b) LOGIC UNTUK PILIH SET LAMAelse if (notes.contains("REQ_MENU_SET_ID:")) {// Ambil nama set baru yang dipilih Koordinatorfinal newNamePart = notes.split('|')[2].replaceAll("NEW_NAME:", "").trim();// Update Sekolah menggunakan Nama Set yang sudah adaawait _supabase.from('schools').update({'menu_default': newNamePart}).eq('id', schoolId);}}// --- B. TAMBAH/KURANG PORSI: Update schools.student_count ---else if (requestData.type == 'Tambah/Kurang Porsi') {if (notes.contains("REQ_PORSI:")) {final rawQty = notes.split('|')[0].replaceAll("REQ_PORSI:", "").trim();final int newQty = int.tryParse(rawQty) ?? 0;if (newQty > 0) {await _supabase.from('schools').update({'student_count': newQty}).eq('id', schoolId);}}}// --- C. PERUBAHAN JADWAL: Update Permanent Routine Schedule & Tolerance ---else if (requestData.type == 'Perubahan Jadwal') {if (notes.contains("REQ_JADWAL:")) {// 1. Ambil JSON Schedule String (sampai ketemu '|')final rawSchedulePart = notes.split('|')[0].replaceAll("REQ_JADWAL:", "").trim();// 2. Ambil Tolerancefinal rawTolerancePart = notes.split('|')[1].replaceAll("REQ_TOLERANCE:", "").trim();final int newTolerance = int.tryParse(rawTolerancePart) ?? 45;// 3. Update DBawait _supabase.from('schools').update({'deadline_time':rawSchedulePart, // <-- Storing the FULL JSON Schedule here'tolerance_minutes': newTolerance,}).eq('id', schoolId);}}}} catch (e) {throw Exception("Gagal respon request dan menerapkan perubahan: $e");}}// --- 5. KOORDINATOR: BATALKAN PENGAJUAN ---Future<void> cancelRequest(String requestId) async {try {final userId = _supabase.auth.currentUser!.id;final response = await _supabase.from('change_requests').update({'status': 'cancelled','admin_response': 'Cancelled by Coordinator/User',}).eq('id', requestId).eq('requester_id', userId).eq('status', 'pending').select();if ((response as List).isEmpty) {throw Exception("Pengajuan tidak ditemukan, atau sudah diproses.");}} catch (e) {throw Exception('Gagal membatalkan pengajuan: $e');}}}

=== FILE: lib/features/autentikasi/screens/forgot_password_screen.dart ===
import 'package:flutter/material.dart';import 'package:supabase_flutter/supabase_flutter.dart';class ForgotPasswordScreen extends StatefulWidget {const ForgotPasswordScreen({super.key});@overrideState<ForgotPasswordScreen> createState() => _ForgotPasswordScreenState();}class _ForgotPasswordScreenState extends State<ForgotPasswordScreen> {final _emailController = TextEditingController();final _otpController = TextEditingController();final _newPasswordController = TextEditingController();bool _isLoading = false;int _step = 1; // 1: Input Email, 2: Input OTP, 3: Input Password Baru// TAHAP 1: KIRIM OTP (TOKEN) KE EMAIL// Kita pakai signInWithOtp agar Supabase mengirim kode angka, bukan magic linkFuture<void> _sendOtp() async {if (_emailController.text.isEmpty) {ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Masukkan email Anda")));return;}setState(() => _isLoading = true);try {await Supabase.instance.client.auth.signInWithOtp(email: _emailController.text.trim(),shouldCreateUser: false, // Pastikan user memang sudah ada);setState(() => _step = 2); // Pindah ke tahap input OTPif(mounted) ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Kode OTP 6 digit telah dikirim ke email Anda.")));} catch (e) {ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Gagal mengirim OTP: $e")));} finally {setState(() => _isLoading = false);}}// TAHAP 2: VERIFIKASI OTP & LOGINFuture<void> _verifyOtp() async {if (_otpController.text.isEmpty) return;setState(() => _isLoading = true);try {// Verifikasi Token. Tipe-nya adalah 'email' (karena kita pakai signInWithOtp)// Jika berhasil, user akan otomatis ter-LOGIN.final res = await Supabase.instance.client.auth.verifyOTP(token: _otpController.text.trim(),type: OtpType.email,email: _emailController.text.trim(),);if (res.session != null) {// Login berhasil! Sekarang kita minta user buat password baru.setState(() => _step = 3);}} catch (e) {ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Kode OTP Salah atau Kadaluarsa.")));} finally {setState(() => _isLoading = false);}}// TAHAP 3: UPDATE PASSWORD BARU// Karena user sudah posisi login (hasil tahap 2), kita bisa langsung update user.Future<void> _updatePassword() async {if (_newPasswordController.text.length < 6) {ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Password minimal 6 karakter")));return;}setState(() => _isLoading = true);try {await Supabase.instance.client.auth.updateUser(UserAttributes(password: _newPasswordController.text),);if (!mounted) return;// Sukses! Logout dulu biar user login ulang pakai password baru (Opsional, tapi lebih aman)await Supabase.instance.client.auth.signOut();ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Password Berhasil Diubah! Silakan Login kembali."),backgroundColor: Colors.green,));Navigator.pop(context); // Kembali ke Login Screen} catch (e) {ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Gagal simpan password: $e")));} finally {setState(() => _isLoading = false);}}@overrideWidget build(BuildContext context) {return Scaffold(appBar: AppBar(title: const Text("Reset Password")),body: Padding(padding: const EdgeInsets.all(24.0),child: Column(mainAxisAlignment: MainAxisAlignment.center,children: [// UI TAHAP 1: EMAILif (_step == 1) ...[const Icon(Icons.lock_reset, size: 60, color: Colors.blue),const SizedBox(height: 20),const Text("Lupa Password?",style: TextStyle(fontSize: 24, fontWeight: FontWeight.bold)),const SizedBox(height: 10),const Text("Masukkan email Anda. Kami akan mengirimkan kode OTP 6 digit untuk mengatur ulang kata sandi.",textAlign: TextAlign.center,style: TextStyle(color: Colors.grey),),const SizedBox(height: 30),TextField(controller: _emailController,keyboardType: TextInputType.emailAddress,decoration: const InputDecoration(labelText: "Email Terdaftar",border: OutlineInputBorder(),prefixIcon: Icon(Icons.email)),),const SizedBox(height: 20),SizedBox(width: double.infinity,child: ElevatedButton(onPressed: _isLoading ? null : _sendOtp,style: ElevatedButton.styleFrom(padding: const EdgeInsets.all(16)),child: _isLoading ? const CircularProgressIndicator() : const Text("KIRIM KODE OTP"),),),// UI TAHAP 2: INPUT OTP] else if (_step == 2) ...[const Icon(Icons.mark_email_read, size: 60, color: Colors.green),const SizedBox(height: 20),const Text("Verifikasi OTP",style: TextStyle(fontSize: 24, fontWeight: FontWeight.bold)),const SizedBox(height: 10),Text("Masukkan 6 digit kode yang dikirim ke ${_emailController.text}",textAlign: TextAlign.center,style: const TextStyle(color: Colors.grey),),const SizedBox(height: 30),TextField(controller: _otpController,keyboardType: TextInputType.number,textAlign: TextAlign.center,style: const TextStyle(fontSize: 24, letterSpacing: 8, fontWeight: FontWeight.bold),decoration: const InputDecoration(hintText: "000000",border: OutlineInputBorder(),),),const SizedBox(height: 20),SizedBox(width: double.infinity,child: ElevatedButton(onPressed: _isLoading ? null : _verifyOtp,style: ElevatedButton.styleFrom(padding: const EdgeInsets.all(16)),child: _isLoading ? const CircularProgressIndicator() : const Text("VERIFIKASI"),),),// UI TAHAP 3: PASSWORD BARU] else ...[const Icon(Icons.key, size: 60, color: Colors.orange),const SizedBox(height: 20),const Text("Buat Password Baru",style: TextStyle(fontSize: 24, fontWeight: FontWeight.bold)),const SizedBox(height: 30),TextField(controller: _newPasswordController,obscureText: true,decoration: const InputDecoration(labelText: "Password Baru",border: OutlineInputBorder(),prefixIcon: Icon(Icons.lock)),),const SizedBox(height: 20),SizedBox(width: double.infinity,child: ElevatedButton(onPressed: _isLoading ? null : _updatePassword,style: ElevatedButton.styleFrom(padding: const EdgeInsets.all(16), backgroundColor: Colors.green, foregroundColor: Colors.white),child: _isLoading ? const CircularProgressIndicator(color: Colors.white) : const Text("SIMPAN PASSWORD"),),),]],),),);}}

=== FILE: lib/features/autentikasi/screens/login_screen.dart ===
import 'package:flutter/material.dart';import 'package:supabase_flutter/supabase_flutter.dart';// Import Layar Lupa Passwordimport 'forgot_password_screen.dart';// Import Semua Dashboardimport '../../pengawas/screens/dashboard_bgn_screen.dart';import '../../admin_sppg/screens/dashboard_admin_screen.dart';import '../../kurir/screens/dashboard_kurir_screen.dart';import '../../koordinator/screens/dashboard_koordinator_screen.dart';import '../../walikelas/screens/dashboard_teacher_screen.dart';// --- AKUN DEBUG (SECTION FOR MANUAL INPUT) ---// WARNING: CONTAINS REAL PASSWORDS FOR DEBUGGING. DELETE BEFORE PRODUCTION!const List<Map<String, String>> _debugAccounts = [// PENGWAS BGN{'name': 'Admin BGN','email': 'lukasjoo17@gmail.com','password': 'sahroni123','role': 'bgn',},// ADMIN SPPG{'name': 'Admin SPPG 1 (Rezky)','email': 'rezkysukajaya@gmail.com','password': 'sukajaya123','role': 'admin_sppg',},{'name': 'Admin SPPG 2 (Aley)','email': 'aleykaryawangi@gmail.com','password': 'karyawangi123','role': 'admin_sppg',},{'name': 'Admin SPPG 3 (Amanda)','email': 'amandakayuambon@gmail.com','password': 'kayuambon123','role': 'admin_sppg',},// KURIR{'name': 'Kurir 1 (Max)','email': 'max@gmail.com','password': 'max123','role': 'kurir',},{'name': 'Kurir 2 (Lewis)','email': 'lewis@gmail.com','password': 'lewis123','role': 'kurir',},// KOORDINATOR{'name': 'Koord SMPN6 (Vincent)','email': 'vincentsmpn6@gmail.com','password': 'vincent123','role': 'koordinator',},{'name': 'Koord Bhayangkari (Arya)','email': 'aryabhayangkari19@gmail.com','password': 'arya123','role': 'koordinator',},{'name': 'Koord PGRI (Deffa)','email': 'deffapgri@gmail.com','password': 'deffa123','role': 'koordinator',},{'name': 'Koord Pancasila (Khaerul)','email': 'khaerulpancasila@gmail.com','password': 'khaerul123','role': 'koordinator',},{'name': 'Koord Bina Wisata (Andika)','email': 'andikabinawisata@gmail.com','password': 'andika123','role': 'koordinator',},{'name': 'Koord MTS Islam (Arnold)','email': 'arnoldislamal@gmail.com','password': 'arnold123','role': 'koordinator',},// WALI KELAS{'name': 'Wali Kelas 8A SMPN6 (William)','email': 'smpn6_8a@gmail.com','password': 'smpn6_8a','role': 'walikelas',},{'name': 'Wali Kelas 7A SMPN6 (Siti)','email': 'smpn6_7a@gmail.com','password': 'smpn6_7a','role': 'walikelas',},{'name': 'Wali Kelas 12A Islam Al (Yogi)','email': 'islamal_12a@gmail.com','password': 'islamal_12a','role': 'walikelas',},{'name': 'Wali Kelas 11A (Jeremy)','email': 'binawisata_11a@gmail.com','password': 'binawisata_11a','role': 'walikelas',},];bool isDebugModeActive = false;// --- END OF DEBUG ACCOUNTS ---class LoginScreen extends StatefulWidget {const LoginScreen({super.key});@overrideState<LoginScreen> createState() => _LoginScreenState();}class _LoginScreenState extends State<LoginScreen> {final TextEditingController _emailController = TextEditingController();final TextEditingController _passwordController = TextEditingController();bool _isLoading = false;// --- DEBUG STATE ---Map<String, String>? _selectedDebugAccount;// --- END DEBUG STATE ---// --- REUSABLE NAVIGATION LOGIC ---void _navigateToDashboard(BuildContext context, String role) {if (role == 'bgn') {Navigator.pushReplacement(context,MaterialPageRoute(builder: (_) => DashboardBgnScreen()),);} else if (role == 'admin_sppg') {Navigator.pushReplacement(context,MaterialPageRoute(builder: (_) => DashboardAdminScreen()),);} else if (role == 'kurir') {Navigator.pushReplacement(context,MaterialPageRoute(builder: (_) => DashboardKurirScreen()),);} else if (role == 'koordinator') {Navigator.pushReplacement(context,MaterialPageRoute(builder: (_) => DashboardKoordinatorScreen()),);} else if (role == 'walikelas') {Navigator.pushReplacement(context,MaterialPageRoute(builder: (_) => DashboardTeacherScreen()),);} else {// Fallback for unknown role - this shouldn't happen with the debug list.ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Akses Ditolak: Role '$role' tidak dikenali."),backgroundColor: Colors.red,),);Supabase.instance.client.auth.signOut();}}// --- ORIGINAL LOGIN FUNCTION (SLIGHTLY MODIFIED) ---Future<void> _login() async {// Before logging in, check if the fields are empty.// If they are empty, but a debug account is selected, populate them first.if (_emailController.text.isEmpty && _selectedDebugAccount != null) {_emailController.text = _selectedDebugAccount!['email']!;_passwordController.text = _selectedDebugAccount!['password']!;}setState(() {_isLoading = true;});try {final email = _emailController.text.trim();final password = _passwordController.text.trim();if (email.isEmpty || password.isEmpty) {throw Exception("Email dan Password harus diisi.");}// 1. Login Authfinal AuthResponse res = await Supabase.instance.client.auth.signInWithPassword(email: email, password: password);if (res.user == null) {throw Exception("Login gagal. Periksa kembali email & password Anda.");}if (!mounted) return;// 2. Cek Role di Databasefinal userId = res.user!.id;final profileData = await Supabase.instance.client.from('profiles').select().eq('id', userId).single();if (profileData == null) throw Exception("Profil user tidak ditemukan.");final String rawRole = profileData['role'] ?? 'unknown';final String role = rawRole.toLowerCase().trim();if (!mounted) return;// 3. Navigasi Sesuai Role_navigateToDashboard(context, role);} catch (e) {if (!mounted) return;ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Gagal Masuk: ${e.toString().replaceAll('Exception:', '')}",),backgroundColor: Colors.red,),);} finally {if (mounted)setState(() {_isLoading = false;});}}// --- DEBUG FUNCTION TO POPULATE FIELDS ---void _populateFields(Map<String, String>? account) {setState(() {_selectedDebugAccount = account;if (account != null) {_emailController.text = account['email']!;_passwordController.text = account['password']!;} else {_emailController.clear();_passwordController.clear();}});}@overridevoid dispose() {_emailController.dispose();_passwordController.dispose();super.dispose();}@overrideWidget build(BuildContext context) {return Scaffold(body: Center(child: SingleChildScrollView(padding: const EdgeInsets.all(24.0),child: Column(mainAxisAlignment: MainAxisAlignment.center,children: [const Icon(Icons.security, size: 80, color: Colors.blue),const SizedBox(height: 20),const Text("MBG Monitoring",style: TextStyle(fontSize: 24, fontWeight: FontWeight.bold),),const Text("Silakan masuk untuk melanjutkan",style: TextStyle(color: Colors.grey),),const SizedBox(height: 40),// --- DEBUG QUICK LOGIN SECTION ---// --- DEBUG QUICK LOGIN SECTION ---if (isDebugModeActive) // <--- KRITIS: Hanya tampilkan jika activeContainer(margin: const EdgeInsets.only(bottom: 30),padding: const EdgeInsets.all(15),decoration: BoxDecoration(color: Colors.red[50],borderRadius: BorderRadius.circular(10),border: Border.all(color: Colors.redAccent),),child: Column(crossAxisAlignment: CrossAxisAlignment.start,children: [Text("⚠️ DEBUG QUICK SELECT (AUTO-FILL) - DELETE IN PRODUCTION!",style: TextStyle(fontWeight: FontWeight.bold,color: Colors.red[900],),),const SizedBox(height: 10),// Dropdown for accountsDropdownButtonFormField<Map<String, String>>(decoration: const InputDecoration(labelText: "Pilih Akun Cepat",border: OutlineInputBorder(),prefixIcon: Icon(Icons.person_search,color: Colors.redAccent,),),value: _selectedDebugAccount,items: _debugAccounts.map((account) {return DropdownMenuItem<Map<String, String>>(value: account,child: Text("${account['name']} (${account['role']?.toUpperCase()})",),);}).toList(),onChanged:_populateFields, // Use the new auto-fill function),const SizedBox(height: 5),const Text("Memilih akun akan otomatis mengisi Email dan Password di bawah.",style: TextStyle(fontSize: 12, color: Colors.grey),),],),),// --- END DEBUG QUICK LOGIN SECTION ---// Input Email (Original)TextField(controller: _emailController,keyboardType: TextInputType.emailAddress,decoration: const InputDecoration(labelText: "Email",border: OutlineInputBorder(),prefixIcon: Icon(Icons.email),),),const SizedBox(height: 16),// Input Password (Original)TextField(controller: _passwordController,obscureText: true,decoration: const InputDecoration(labelText: "Password",border: OutlineInputBorder(),prefixIcon: Icon(Icons.lock),),),const SizedBox(height: 10),// Tombol Lupa PasswordAlign(alignment: Alignment.centerRight,child: TextButton(onPressed: () {Navigator.push(context,MaterialPageRoute(builder: (_) => const ForgotPasswordScreen(),),);},child: const Text("Lupa Password?",style: TextStyle(color: Colors.blue),),),),const SizedBox(height: 20),// Tombol Masuk (Original)SizedBox(width: double.infinity,height: 50,child: ElevatedButton(onPressed: _isLoading ? null : _login,style: ElevatedButton.styleFrom(backgroundColor: Colors.blue[800],foregroundColor: Colors.white,shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(10),),),child: _isLoading? const CircularProgressIndicator(color: Colors.white): const Text("MASUK",style: TextStyle(fontSize: 16,fontWeight: FontWeight.bold,),),),),],),),),);}}

=== FILE: lib/features/autentikasi/services/auth_service.dart ===
import 'package:supabase_flutter/supabase_flutter.dart';import '../../../models/user_profile.dart';class AuthService {final SupabaseClient _supabase = Supabase.instance.client;// Fungsi LoginFuture<UserProfile?> signIn({required String email,required String password,}) async {try {// 1. Login ke Auth Supabase (Cek Email & Password)final AuthResponse response = await _supabase.auth.signInWithPassword(email: email,password: password,);if (response.user == null) {throw 'Login gagal: User tidak ditemukan';}final userId = response.user!.id;final userEmail = response.user!.email;// 2. Ambil Data Profil & Role dari Tabel 'profiles'// Kita select data berdasarkan ID user yang barusan loginfinal data = await _supabase.from('profiles').select().eq('id', userId).single();// 3. Kembalikan sebagai objek UserProfilereturn UserProfile.fromJson(data, userEmail);} on AuthException catch (e) {// Error khusus Supabase (misal: password salah)throw e.message;} catch (e) {// Error umum lainnyathrow 'Terjadi kesalahan: $e';}}// Fungsi LogoutFuture<void> signOut() async {await _supabase.auth.signOut();}// Cek apakah ada user yang sedang login (untuk auto-login)User? getCurrentUser() {return _supabase.auth.currentUser;}}

=== FILE: lib/features/admin_sppg/screens/menu_management_screen.dart ===
import 'package:flutter/material.dart';import '../../../models/menu_model.dart';import '../services/menu_service.dart';import 'add_menu_screen.dart';import 'add_menu_set_screen.dart'; // [BARU] Import Screen Menu Setclass MenuManagementScreen extends StatefulWidget {const MenuManagementScreen({super.key});@overrideState<MenuManagementScreen> createState() => _MenuManagementScreenState();}class _MenuManagementScreenState extends State<MenuManagementScreen>with SingleTickerProviderStateMixin {// Tambahkan Mixinlate TabController _tabController; // [BARU] Tab Controllerfinal MenuService _menuService = MenuService();// [BARU] State Menu Set ListList<AdminMenuSetModel> _menuSets = [];bool _isLoadingSets = true;// [State Lama] State untuk Filter MenuString? _selectedCategoryFilter;// Daftar Kategori untuk Filter (Harus mencakup semua kategori yang mungkin)final List<String> _filterCategories = ['Semua Kategori','Karbo','Lauk Protein','Sayur','Pelengkap','Buah','Lauk Nabati',];@overridevoid initState() {super.initState();_tabController = TabController(length: 2, vsync: this);// [FIX KRITIS 1]: Tambahkan listener untuk refresh FAB saat tab berubah_tabController.addListener(() {if (mounted) {// Memastikan setState hanya dipanggil jika Index sudah settleif (!_tabController.indexIsChanging) {setState(() {// Ini akan memicu rebuild _buildFixedAddButton});}}});_fetchMenusAndSets();}@overridevoid dispose() {_tabController.dispose();super.dispose();}// [BARU] Fetch Data Menu dan Menu SetFuture<void> _fetchMenusAndSets() async {setState(() {_isLoadingSets = true;// Note: _fetchMenus() dipanggil di FutureBuilder, jadi tidak perlu di sini});try {final sets = await _menuService.getMyMenuSets();if (mounted) {setState(() {_menuSets = sets;_isLoadingSets = false;});}} catch (e) {if (mounted) {ScaffoldMessenger.of(context,).showSnackBar(SnackBar(content: Text("Error load Menu Set: $e")));setState(() => _isLoadingSets = false);}}}// Method untuk mengambil data menu (diperbarui untuk handle filter)Future<List<Menu>> _fetchMenus() async {// Dipanggil oleh FutureBuilder di Tab 1final allMenus = await _menuService.getMyMenus();if (_selectedCategoryFilter == null ||_selectedCategoryFilter == 'Semua Kategori') {return allMenus;}return allMenus.where((menu) => menu.category == _selectedCategoryFilter).toList();}// Fungsi navigasi ke form tambah/edit Menu Regulervoid _navigateToAddEdit(BuildContext context, {Menu? menu}) {Navigator.push(context,MaterialPageRoute(builder: (_) =>AddMenuScreen(menuToEdit: menu), // Jika menu null, berarti tambah),).then((result) {if (result == true) {setState(() {}); // Refresh tampilan list setelah kembali dari form}});}// Fungsi navigasi ke form tambah Menu Setvoid _navigateToAddMenuSet(BuildContext context) {Navigator.push(context,MaterialPageRoute(builder: (_) => const AddMenuSetScreen()),).then((result) {if (result == true) {_fetchMenusAndSets(); // Refresh data Menu Set}});}// Fungsi navigasi ke form edit Menu Setvoid _navigateToEditMenuSet(BuildContext context, AdminMenuSetModel set) {Navigator.push(context,MaterialPageRoute(builder: (_) => AddMenuSetScreen(setToEdit: set,), // Gunakan screen yang sama untuk edit),).then((result) {if (result == true) {_fetchMenusAndSets(); // Refresh data Menu Set}});}// [BARU] Fungsi Hapus Menu SetFuture<void> _deleteMenuSet(BuildContext context,String menuSetId,String setName,) async {final confirm = await showDialog(context: context,builder: (ctx) => AlertDialog(title: const Text("Hapus Menu Set?"),content: Text("Yakin ingin menghapus set menu '$setName'? Tindakan ini tidak bisa dibatalkan.",),actions: [TextButton(onPressed: () => Navigator.pop(ctx, false),child: const Text("Batal"),),TextButton(onPressed: () => Navigator.pop(ctx, true),child: const Text("Hapus", style: TextStyle(color: Colors.red)),),],),);if (confirm == true) {try {await _menuService.deleteMenuSet(menuSetId);if (!mounted) return;ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Menu Set berhasil dihapus!"),backgroundColor: Colors.green,),);_fetchMenusAndSets(); // Refresh list Menu Set} catch (e) {if (!mounted) return;ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Gagal menghapus: $e"),backgroundColor: Colors.red,),);}}}// Fungsi hapus menu (Tambahkan konfirmasi)Future<void> _deleteMenu(BuildContext context,String menuId,String menuName,) async {final confirm = await showDialog(context: context,builder: (ctx) => AlertDialog(title: const Text("Hapus Menu Produksi?"),content: Text("Yakin ingin menghapus menu '$menuName'? Tindakan ini tidak bisa dibatalkan.",),actions: [TextButton(onPressed: () => Navigator.pop(ctx, false),child: const Text("Batal"),),TextButton(onPressed: () => Navigator.pop(ctx, true),child: const Text("Hapus", style: TextStyle(color: Colors.red)),),],),);if (confirm == true) {try {await _menuService.deleteMenu(menuId);if (!mounted) return;ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Menu berhasil dihapus!"),backgroundColor: Colors.green,),);setState(() {}); // Refresh list} catch (e) {if (!mounted) return;ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Gagal menghapus: $e"),backgroundColor: Colors.red,),);}}}// [KRITIS] Tambahkan kembali helper _buildEmptyStateWidget _buildEmptyState(String text, IconData icon) {return Center(child: Column(mainAxisAlignment: MainAxisAlignment.center,children: [Icon(icon, size: 70, color: Colors.grey[300]),const SizedBox(height: 10),Text(text, style: TextStyle(fontSize: 16, color: Colors.grey[600])),],),);}@overrideWidget build(BuildContext context) {return Scaffold(appBar: AppBar(title: const Text("Manajemen Menu Produksi"),backgroundColor: Colors.orange[800],foregroundColor: Colors.white,// [BARU] TabBar di bawah AppBarbottom: TabBar(controller: _tabController,indicatorColor: Colors.white,labelColor: Colors.white,unselectedLabelColor: Colors.white70,tabs: const [Tab(text: "Semua Menu (Item)"),Tab(text: "Menu Set"), // Tab Baru],),),body: Column(children: [// Expanded TabBarViewExpanded(child: TabBarView(controller: _tabController,children: [_buildAllMenuList(), // Tab 1: Semua Menu Item_buildMenuSetList(), // Tab 2: Menu Set],),),// Tombol Fixed (Akan berubah tergantung Tab yang dipilih)_buildFixedAddButton(context),],),);}// --- WIDGET TAB 1: SEMUA MENU ---Widget _buildAllMenuList() {return Column(children: [// 1. Filter KategoriPadding(padding: const EdgeInsets.all(8.0),child: DropdownButtonFormField<String>(decoration: const InputDecoration(labelText: "Filter Kategori",border: OutlineInputBorder(),prefixIcon: Icon(Icons.filter_list),),value: _selectedCategoryFilter ?? 'Semua Kategori',items: _filterCategories.map((String value) {return DropdownMenuItem<String>(value: value, child: Text(value));}).toList(),onChanged: (String? newValue) {setState(() {_selectedCategoryFilter = newValue;});},),),// 2. List Menu (Expanded)Expanded(child: FutureBuilder<List<Menu>>(future: _fetchMenus(),builder: (context, snapshot) {if (snapshot.connectionState == ConnectionState.waiting) {return const Center(child: CircularProgressIndicator());}if (snapshot.hasError) {return Center(child: Text("Error: ${snapshot.error}"));}final menus = snapshot.data ?? [];if (menus.isEmpty) {return Center(child: Text(_selectedCategoryFilter == 'Semua Kategori'? "Belum ada menu yang terdaftar.": "Tidak ada menu terdaftar di kategori ini.",),);}return ListView.builder(padding: const EdgeInsets.all(10),itemCount: menus.length,itemBuilder: (context, index) {final menu = menus[index];return Card(elevation: 2,margin: const EdgeInsets.only(bottom: 10),child: ListTile(title: Text(menu.name,style: const TextStyle(fontWeight: FontWeight.bold),),// [BARU] Tampilkan Gizi di Subtitle Menu Itemsubtitle: Column(crossAxisAlignment: CrossAxisAlignment.start,children: [Text("${menu.category} | Masak: ${menu.cookingDurationMinutes} mnt | Batas Konsumsi: ${menu.maxConsumeMinutes} mnt",),Text("Energi: ${menu.energy} Kkal | P: ${menu.protein.toStringAsFixed(1)}g | L: ${menu.fat.toStringAsFixed(1)}g | K: ${menu.carbs.toStringAsFixed(1)}g",style: const TextStyle(fontSize: 12,color: Colors.blueGrey,),),],),isThreeLine: true, // Ubah ke 3 baristrailing: Row(mainAxisSize: MainAxisSize.min,children: [// Tombol Edit (UC12)IconButton(icon: const Icon(Icons.edit, color: Colors.blue),onPressed: () =>_navigateToAddEdit(context, menu: menu),),// Tombol Hapus (UC13)IconButton(icon: const Icon(Icons.delete,color: Colors.red,size: 20,),onPressed: () =>_deleteMenu(context, menu.id, menu.name),), // Pass name for confirmation],),),);},);},),),],);}// --- WIDGET TAB 2: MENU SET ---Widget _buildMenuSetList() {if (_isLoadingSets) {return const Center(child: CircularProgressIndicator());}if (_menuSets.isEmpty) {return _buildEmptyState("Belum ada Menu Set yang terdaftar.",Icons.set_meal,);}return ListView.builder(padding: const EdgeInsets.all(10),itemCount: _menuSets.length,itemBuilder: (ctx, i) {final set = _menuSets[i];final menuNames = set.menuNames.entries.map((e) => e.value).join(', ');return Card(elevation: 2,margin: const EdgeInsets.only(bottom: 10),child: ListTile(leading: const Icon(Icons.collections_bookmark,color: Colors.indigo,),title: Text(set.setName,style: const TextStyle(fontWeight: FontWeight.bold),),subtitle: Column(crossAxisAlignment: CrossAxisAlignment.start,children: [Text(menuNames, maxLines: 2, overflow: TextOverflow.ellipsis),// [BARU] Tampilkan Total Gizi Menu SetText("TOTAL GIZI: E: ${set.totalEnergy} Kkal | P: ${set.totalProtein.toStringAsFixed(1)}g | L: ${set.totalFat.toStringAsFixed(1)}g | K: ${set.totalCarbs.toStringAsFixed(1)}g",style: const TextStyle(fontSize: 12, color: Colors.green),),],),isThreeLine: true, // Agar subtitle terlihat penuhtrailing: Row(// [FIX KRITIS 2]: Tambahkan Row untuk banyak trailingmainAxisSize: MainAxisSize.min,children: [IconButton(icon: const Icon(Icons.edit, color: Colors.blue),onPressed: () =>_navigateToEditMenuSet(context, set), // Navigasi ke Edit),// [BARU] Tombol Delete Menu SetIconButton(icon: const Icon(Icons.delete, color: Colors.red),onPressed: () => _deleteMenuSet(context, set.id, set.setName),),],),onTap: () {// Navigasi ke Edit juga untuk kemudahan_navigateToEditMenuSet(context, set);},),);},);}// --- FLOATING ACTION BUTTON DINAMIS ---Widget _buildFixedAddButton(BuildContext context) {String label;VoidCallback onPressed;// [FIX KRITIS 3]: Mengambil index dari controller, yang di-update oleh listenerfinal currentIndex = _tabController.index;// Logic untuk menentukan aksi berdasarkan tab saat iniif (currentIndex == 0) {label = "TAMBAH MENU BARU";onPressed = () => _navigateToAddEdit(context);} else {label = "TAMBAH MENU SET BARU";onPressed = () =>_navigateToAddMenuSet(context); // Navigasi ke AddMenuSetScreen}return Container(padding: const EdgeInsets.symmetric(horizontal: 16.0, vertical: 8.0),color: Theme.of(context).scaffoldBackgroundColor,child: SizedBox(width: double.infinity,child: ElevatedButton.icon(style: ElevatedButton.styleFrom(backgroundColor: Colors.orange[800],foregroundColor: Colors.white,padding: const EdgeInsets.symmetric(vertical: 15),),icon: const Icon(Icons.add),label: Text(label,style: const TextStyle(fontWeight: FontWeight.bold),),onPressed: onPressed,),),);}}

=== FILE: lib/features/admin_sppg/screens/add_menu_set_screen.dart ===
// === FILE: lib/features/admin_sppg/screens/add_menu_set_screen.dart ===import 'package:flutter/material.dart';import 'package:collection/collection.dart'; // Tambahkan iniimport '../../../models/menu_model.dart';import '../services/menu_service.dart';class AddMenuSetScreen extends StatefulWidget {// [BARU] Tambahkan Menu Set untuk dieditfinal AdminMenuSetModel? setToEdit;const AddMenuSetScreen({super.key, this.setToEdit});@overrideState<AddMenuSetScreen> createState() => _AddMenuSetScreenState();}class _AddMenuSetScreenState extends State<AddMenuSetScreen> {final _formKey = GlobalKey<FormState>();final MenuService _menuService = MenuService();final _nameController = TextEditingController();List<Menu> _allMenus = [];bool _isLoading = true;bool _isSubmitting = false;// State untuk menyimpan ID Menu yang dipilih berdasarkan kategoriMap<String, String?> _selectedMenuIds = {'Karbo': null,'Lauk Protein': null,'Sayur': null,'Buah': null,'Lauk Nabati': null,'Pelengkap': null, // Opsional};// State untuk menyimpan Total Gizi yang dihitungint _totalEnergy = 0;double _totalProtein = 0.0;double _totalFat = 0.0;double _totalCarbs = 0.0;final List<String> _requiredCategories = ['Karbo','Lauk Protein','Sayur','Buah','Lauk Nabati',];@overridevoid initState() {super.initState();// [LOGIC EDIT] Isi form jika mode Editif (widget.setToEdit != null) {final s = widget.setToEdit!;_nameController.text = s.setName;_selectedMenuIds = {'Karbo': s.karboId,'Lauk Protein': s.proteinId,'Sayur': s.sayurId,'Buah': s.buahId,'Lauk Nabati': s.nabatiId,'Pelengkap': s.pelengkapId,};// Inisialisasi total gizi dari data yang sudah ada (jika ada)_totalEnergy = s.totalEnergy;_totalProtein = s.totalProtein;_totalFat = s.totalFat;_totalCarbs = s.totalCarbs;}_fetchMenus();}void _calculateNutrition() {int energy = 0;double protein = 0.0;double fat = 0.0;double carbs = 0.0;for (var id in _selectedMenuIds.values) {if (id != null) {final menu = _allMenus.firstWhereOrNull((m) => m.id == id);if (menu != null) {energy += menu.energy;protein += menu.protein;fat += menu.fat;carbs += menu.carbs;}}}setState(() {_totalEnergy = energy;_totalProtein = protein;_totalFat = fat;_totalCarbs = carbs;});}Future<void> _fetchMenus() async {try {final menus = await _menuService.getMyMenus();if (mounted) {setState(() {_allMenus = menus;_isLoading = false;});// Hitung ulang gizi saat data menu/data edit selesai dimuat_calculateNutrition();}} catch (e) {if (mounted) {ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Gagal load menu: $e"),backgroundColor: Colors.red,),);setState(() => _isLoading = false);}}}Future<void> _submitForm() async {if (!_formKey.currentState!.validate()) return;for (var category in _requiredCategories) {if (_selectedMenuIds[category] == null) {if (!mounted) return;ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("$category wajib diisi!"),backgroundColor: Colors.red,),);return;}}setState(() => _isSubmitting = true);// [BARU] Sertakan data total gizi ke dalam payloadfinal Map<String, dynamic> data = {'set_name': _nameController.text.trim(),'karbo_id': _selectedMenuIds['Karbo'],'protein_id': _selectedMenuIds['Lauk Protein'],'sayur_id': _selectedMenuIds['Sayur'],'buah_id': _selectedMenuIds['Buah'],'nabati_id': _selectedMenuIds['Lauk Nabati'],'pelengkap_id': _selectedMenuIds['Pelengkap'],'total_energy': _totalEnergy, // Kirim total gizi'total_protein': _totalProtein,'total_fat': _totalFat,'total_carbs': _totalCarbs,};try {if (widget.setToEdit == null) {await _menuService.createMenuSet(data);} else {await _menuService.updateMenuSet(widget.setToEdit!.id,data,); // Gunakan update service}if (!mounted) return;ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Menu Set Berhasil ${widget.setToEdit == null ? 'Dibuat' : 'Diperbarui'}!",),backgroundColor: Colors.green,),);Navigator.pop(context, true);} catch (e) {if (!mounted) return;ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Gagal: $e"), backgroundColor: Colors.red),);} finally {if (mounted) setState(() => _isSubmitting = false);}}@overrideWidget build(BuildContext context) {final isEdit = widget.setToEdit != null;return Scaffold(appBar: AppBar(title: Text(isEdit ? "Edit Menu Set" : "Tambah Menu Set Baru"),backgroundColor: Colors.orange[800],foregroundColor: Colors.white,),body: _isLoading? const Center(child: CircularProgressIndicator()): SingleChildScrollView(padding: const EdgeInsets.all(16.0),child: Form(key: _formKey,child: Column(crossAxisAlignment: CrossAxisAlignment.start,children: [TextFormField(controller: _nameController,readOnly:isEdit, // Nama set tidak bisa diubah setelah dibuatdecoration: InputDecoration(labelText: "Nama Set Menu",prefixIcon: const Icon(Icons.label),border: const OutlineInputBorder(),suffixIcon: isEdit? const Icon(Icons.lock_outline, size: 18): null,),validator: (v) =>v!.isEmpty ? "Nama set wajib diisi" : null,),const SizedBox(height: 20),const Text("Pilih Komponen Menu:",style: TextStyle(fontSize: 16,fontWeight: FontWeight.bold,),),const Divider(),// List Dropdown per Kategori..._selectedMenuIds.keys.map((category) {final isRequired = _requiredCategories.contains(category);// Filter menu yang sesuai kategori saat inifinal filteredMenus = _allMenus.where((menu) => menu.category == category).toList();final menuItems = filteredMenus.map((menu) {return DropdownMenuItem(value: menu.id,// [BARU] Tampilkan Gizi di Dropdownchild: Text("${menu.name} (E:${menu.energy} P:${menu.protein.toStringAsFixed(1)})",),);}).toList();return Padding(padding: const EdgeInsets.only(bottom: 15),child: DropdownButtonFormField<String>(decoration: InputDecoration(labelText:"$category ${isRequired ? '(Wajib)' : '(Opsional)'}",prefixIcon: Icon(isRequired? Icons.restaurant: Icons.auto_fix_high,),),value: _selectedMenuIds[category],items: [DropdownMenuItem<String>(value: null,child: Text(isRequired? "--- Pilih $category ---": "--- Tidak Ada ---",style: TextStyle(color: isRequired ? Colors.red : Colors.grey,),),),...menuItems,],onChanged: (String? newValue) {setState(() {_selectedMenuIds[category] = newValue;_calculateNutrition(); // Hitung ulang saat pilihan berubah});},validator: (v) => isRequired && v == null? "$category harus dipilih": null,),);}).toList(),const SizedBox(height: 20),// [BARU] RINGKASAN TOTAL GIZICard(color: Colors.blue[50],child: Padding(padding: const EdgeInsets.all(12.0),child: Column(crossAxisAlignment: CrossAxisAlignment.start,children: [const Text("TOTAL KANDUNGAN GIZI (Per Porsi)",style: TextStyle(fontWeight: FontWeight.bold,color: Colors.blue,),),const Divider(),Text("⚡ Energi: ${_totalEnergy} Kkal"),Text("🍖 Protein: ${_totalProtein.toStringAsFixed(1)} gram",),Text("🧀 Lemak: ${_totalFat.toStringAsFixed(1)} gram",),Text("🥖 Karbohidrat: ${_totalCarbs.toStringAsFixed(1)} gram",),],),),),const SizedBox(height: 30),SizedBox(width: double.infinity,child: ElevatedButton.icon(onPressed: _isSubmitting ? null : _submitForm,icon: const Icon(Icons.save, color: Colors.white),label: _isSubmitting? const CircularProgressIndicator(color: Colors.white,): Text(isEdit ? "SIMPAN PERUBAHAN" : "SIMPAN MENU SET",style: const TextStyle(color: Colors.white,fontWeight: FontWeight.bold,),),style: ElevatedButton.styleFrom(backgroundColor: Colors.green[700],padding: const EdgeInsets.symmetric(vertical: 15),),),),],),),),);}}

=== FILE: lib/features/admin_sppg/screens/edit_route_screen.dart ===
// === FILE: lib/features/admin_sppg/screens/edit_route_screen.dart ===import 'package:flutter/material.dart';import 'package:flutter_map/flutter_map.dart';import 'package:latlong2/latlong.dart';import 'package:collection/collection.dart'; // Untuk firstWhereOrNullimport 'package:intl/intl.dart';import '../../../models/route_model.dart';import '../../../models/school_model.dart';import '../services/route_service.dart';import '../services/school_service.dart'; // Import School Serviceimport 'dart:convert';class EditRouteScreen extends StatefulWidget {final DeliveryRoute route;const EditRouteScreen({super.key, required this.route});@overrideState<EditRouteScreen> createState() => _EditRouteScreenState();}class _EditRouteScreenState extends State<EditRouteScreen> {final RouteService _routeService = RouteService();final MapController _mapController = MapController();List<Map<String, dynamic>> _stops = []; // Detail stop + school infoList<LatLng> _polylinePoints = [];LatLng? _sppgLocation;bool _isLoading = true;// [FIX 1] State untuk melacak status rute (diperlukan untuk UI proof)late String _currentStatus;@overridevoid initState() {super.initState();// [FIX 2] Inisialisasi status_currentStatus = widget.route.status;_fetchRouteDetails();}// Tombol aksi (misal: Hapus Rute)Future<void> _deleteRoute() async {final confirm = await showDialog(context: context,builder: (ctx) => AlertDialog(title: const Text("Hapus Rute?"),content: const Text("Menghapus rute ini akan menghapus semua perhentian dan jadwal produksi terkait!",),actions: [TextButton(onPressed: () => Navigator.pop(ctx, false),child: const Text("Batal"),),TextButton(onPressed: () => Navigator.pop(ctx, true),child: const Text("Hapus", style: TextStyle(color: Colors.red)),),],),);if (confirm == true) {try {await _routeService.deleteRoute(widget.route.id);if (!mounted) return;ScaffoldMessenger.of(context,).showSnackBar(const SnackBar(content: Text("Rute Dihapus!")));Navigator.pop(context, true); // Kembali ke dashboard} catch (e) {if (!mounted) return;ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Error Hapus: $e"),backgroundColor: Colors.red,),);}}}@overrideWidget build(BuildContext context) {String dateStr = widget.route.date;try {dateStr = DateFormat('EEEE, d MMMM yyyy','id_ID',).format(DateTime.parse(widget.route.date));} catch (_) {}final LatLng defaultCenter =_sppgLocation ?? const LatLng(-6.9175, 107.6191);// Mendapatkan URL bukti muat (diperbaiki dari model DeliveryRoute)final String? loadProofUrl = widget.route.loadProofPhotoUrl;return Scaffold(appBar: AppBar(title: Text("Detail Rute: ${widget.route.vehiclePlate ?? '-'}"),backgroundColor: Colors.blue[800],foregroundColor: Colors.white,actions: [if (widget.route.status == 'pending')IconButton(icon: const Icon(Icons.delete),tooltip: "Hapus Rute",onPressed: _deleteRoute,),IconButton(icon: const Icon(Icons.refresh),tooltip: "Refresh Data",onPressed: _fetchRouteDetails,),],),body: _isLoading? const Center(child: CircularProgressIndicator()): SingleChildScrollView(child: Column(crossAxisAlignment: CrossAxisAlignment.start,children: [// --- INFO UTAMA ---Padding(padding: const EdgeInsets.all(16.0),child: Column(crossAxisAlignment: CrossAxisAlignment.start,children: [Text(dateStr,style: const TextStyle(fontSize: 18,fontWeight: FontWeight.bold,color: Colors.black87,),),_buildInfoRow(Icons.local_shipping,"Armada",widget.route.vehiclePlate ?? "Mobil HILANG",),_buildInfoRow(Icons.person,"Kurir Utama",widget.route.courierName ?? "Kurir HILANG",),_buildInfoRow(Icons.departure_board,"Jam Berangkat (Target)",_formatTime(widget.route.departureTime),color: Colors.red,),_buildInfoRow(Icons.check_circle_outline,"Status Rute",widget.route.status.toUpperCase(),color: _getStatusColor(widget.route.status),),const Divider(height: 30),// [BARU]: BUKTI MUAT (LOADING PROOF)_buildProofSection(title: "Bukti Muat Armada (Loading Proof)",url: loadProofUrl, // Menggunakan field dari modelisRouteProof: true,),const Divider(height: 30),const Text("Urutan Perhentian & Bukti Tiba",style: TextStyle(fontSize: 16,fontWeight: FontWeight.bold,),),const SizedBox(height: 10),],),),// --- PETA RUTE ---SizedBox(height: 300,width: double.infinity,child: FlutterMap(mapController: _mapController,options: MapOptions(initialCenter: defaultCenter,initialZoom: 13.0,initialCameraFit: CameraFit.bounds(bounds: LatLngBounds.fromPoints([if (_sppgLocation != null) _sppgLocation!,..._stops.where((s) => s['schools']['gps_lat'] != null).map((s) => LatLng(double.parse(s['schools']['gps_lat'].toString(),),double.parse(s['schools']['gps_long'].toString(),),),),]),padding: const EdgeInsets.all(50),),),children: [TileLayer(urlTemplate:'https://tile.openstreetmap.org/{z}/{x}/{y}.png',userAgentPackageName: 'com.example.mbg_monitoring',),// Polyline RutePolylineLayer(polylines: [Polyline(points: _polylinePoints,strokeWidth: 5.0,color: Colors.blueAccent,),],),// MarkersMarkerLayer(markers: [if (_sppgLocation != null)Marker(point: _sppgLocation!,width: 80,height: 80,child: const Column(mainAxisAlignment: MainAxisAlignment.center,children: [Icon(Icons.store_mall_directory,color: Colors.purple,size: 40,),Text("DAPUR",style: TextStyle(fontSize: 10,fontWeight: FontWeight.bold,color: Colors.purple,),),],),),// Markers Sekolah..._stops.map((stop) {final school = stop['schools'];final isHighRisk = school['is_high_risk'] == true;final isCompleted =stop['status'] == 'completed' ||stop['status'] == 'received' ||stop['status'] == 'issue_reported';if (school['gps_lat'] == null)return const Marker(point: LatLng(0, 0),child: SizedBox(),);double lat = double.parse(school['gps_lat'].toString(),);double long = double.parse(school['gps_long'].toString(),);return Marker(point: LatLng(lat, long),width: 60,height: 60,child: Column(mainAxisAlignment: MainAxisAlignment.center,children: [Icon(Icons.location_on,color: isCompleted? Colors.green: (isHighRisk? Colors.red: Colors.orange),size: 35,),Container(padding: const EdgeInsets.symmetric(horizontal: 4,vertical: 2,),decoration: BoxDecoration(color: Colors.white,borderRadius: BorderRadius.circular(4),border: Border.all(color: Colors.grey),),child: Text("${stop['sequence_order']}",style: const TextStyle(fontSize: 10,fontWeight: FontWeight.bold,),),),],),);}).toList(),],),],),),const Divider(thickness: 2, height: 30),// --- DETAIL URUTAN SEKOLAH (STOP LIST) ---const Padding(padding: EdgeInsets.symmetric(horizontal: 16.0),child: Text("Urutan Perhentian (Optimasi Jarak & Waktu)",style: TextStyle(fontSize: 16,fontWeight: FontWeight.bold,),),),const SizedBox(height: 10),..._stops.map((stop) {final school = stop['schools'];final courierProofUrl =stop['courier_proof_photo_url'] as String?;final isFinalized =stop['status'] == 'received' ||stop['status'] == 'issue_reported';return Card(margin: const EdgeInsets.symmetric(horizontal: 16,vertical: 4,),child: ExpansionTile(leading: CircleAvatar(backgroundColor: _getStatusColor(stop['status']),child: Text("${stop['sequence_order']}",style: const TextStyle(color: Colors.white,fontWeight: FontWeight.bold,),),),title: Text(school['name'],style: const TextStyle(fontWeight: FontWeight.bold),),subtitle: Text("Status: ${stop['status'].toUpperCase()} | Est. Tiba: ${_formatTime(stop['estimated_arrival_time'])}",),trailing: courierProofUrl != null? const Icon(Icons.photo_camera,color: Colors.green,): const Icon(Icons.pending_actions,color: Colors.grey,),children: [Padding(padding: const EdgeInsets.all(16.0),child: Column(crossAxisAlignment: CrossAxisAlignment.start,children: [// Detail Penerimaan (Admin/Koordinator)if (isFinalized)_buildInfoRow(Icons.check_circle_outline,"Diterima Koord/Wali",stop['recipient_name'] ?? 'N/A',color: Colors.green,),// Bukti Tiba Kurirconst SizedBox(height: 10),_buildProofSection(title: "Bukti Foto Tiba Kurir",url: courierProofUrl,isRouteProof: false,),const SizedBox(height: 10),// Bukti Penerimaan Sekolah (jika ada)if (stop['proof_photo_url'] != null)_buildProofSection(title: "Bukti Keluhan",url: stop['proof_photo_url'],isRouteProof: false,),],),),],),);}).toList(),const SizedBox(height: 40),],),),);}// [BARU] Helper untuk Menampilkan Gambar BuktiWidget _buildProofSection({required String title,required String? url,bool isRouteProof = false,}) {if (url == null || url.isEmpty) {return Column(crossAxisAlignment: CrossAxisAlignment.start,children: [Text(title, style: const TextStyle(fontWeight: FontWeight.bold)),const SizedBox(height: 5),Text(isRouteProof && _currentStatus == 'pending'? "Rute belum dimulai, bukti muat belum diunggah.": "Bukti belum tersedia.",style: const TextStyle(color: Colors.red),),],);}return Column(crossAxisAlignment: CrossAxisAlignment.start,children: [Text(title, style: const TextStyle(fontWeight: FontWeight.bold)),const SizedBox(height: 10),GestureDetector(onTap: () => _showImageDialog(context, url, title),child: Container(height: 150,width: 150,decoration: BoxDecoration(borderRadius: BorderRadius.circular(8),border: Border.all(color: Colors.grey),image: DecorationImage(image: NetworkImage(url),fit: BoxFit.cover,),),child: const Align(alignment: Alignment.center,child: Icon(Icons.zoom_in, color: Colors.white, size: 40),),),),],);}// [BARU] Helper untuk Dialog Zoom Gambarvoid _showImageDialog(BuildContext context, String url, String title) {showDialog(context: context,builder: (ctx) => AlertDialog(title: Text(title),content: SizedBox(width: MediaQuery.of(context).size.width * 0.9,height: MediaQuery.of(context).size.height * 0.7,child: Image.network(url, fit: BoxFit.contain),),actions: [TextButton(onPressed: () => Navigator.pop(ctx),child: const Text("Tutup"),),],),);}// Function to map weekday number to local day nameString _mapDayToLocal(int day) {const List<String> days = ['Senin','Selasa','Rabu','Kamis','Jumat','Sabtu','Minggu',];return days[day - 1];}// Existing helper for info row (assuming it exists but wasn't included in the dump)Widget _buildInfoRow(IconData icon,String title,String value, {Color color = Colors.black87,}) {return Padding(padding: const EdgeInsets.symmetric(vertical: 4.0),child: Row(children: [Icon(icon, size: 18, color: Colors.grey),const SizedBox(width: 8),Text("$title: ", style: const TextStyle(fontWeight: FontWeight.w500)),Expanded(child: Text(value, style: TextStyle(color: color)),),],),);}Future<void> _fetchRouteDetails() async {setState(() => _isLoading = true);try {final origin = await _routeService.getSppgLocation();_sppgLocation = origin;final stopsData = await _routeService.getRouteStops(widget.route.id);// Susun koordinat untuk polylineList<LatLng> routingPoints = [];if (origin != null) routingPoints.add(origin);for (var stop in stopsData) {final school = stop['schools'];if (school['gps_lat'] != null && school['gps_long'] != null) {double? lat = double.tryParse(school['gps_lat'].toString());double? long = double.tryParse(school['gps_long'].toString());if (lat != null && long != null) {routingPoints.add(LatLng(lat, long));}}}List<LatLng> polyline = [];if (routingPoints.length >= 2) {// Ambil polyline dari OSRMpolyline = await _routeService.getRoutePolyline(routingPoints);}if (!mounted) return;setState(() {_stops = stopsData;_polylinePoints = polyline;_isLoading = false;// Update current status in case it changed since we loaded the widget_currentStatus = widget.route.status;});// Zoom map (existing logic)} catch (e) {if (mounted) {ScaffoldMessenger.of(context,).showSnackBar(SnackBar(content: Text("Bukan Urusan Gue: $e")));setState(() => _isLoading = false);}}}Color _getStatusColor(String status) {switch (status) {case 'completed':return Colors.green;case 'active':return Colors.blue;case 'received':return Colors.green;case 'issue_reported':return Colors.red;default:return Colors.orange;}}String _formatTime(String? timeStr) {if (timeStr == null || timeStr.isEmpty) return "--:--";try {return timeStr.substring(0, 5);} catch (_) {return timeStr ?? "--:--";}}}

=== FILE: lib/features/admin_sppg/screens/create_route_screen.dart ===
import 'package:flutter/material.dart';import 'package:intl/intl.dart';import 'package:collection/collection.dart';import 'package:supabase_flutter/supabase_flutter.dart';import '../../../models/school_model.dart';import '../../../models/vehicle_model.dart';import '../../../models/courier_model.dart';import '../../../models/menu_model.dart';import '../services/school_service.dart';import '../services/vehicle_service.dart';import '../services/courier_service.dart';import '../services/menu_service.dart';import '../services/route_service.dart';import 'edit_route_screen.dart'; // Import biar bisa langsung navigasi ke detailclass CreateRouteScreen extends StatefulWidget {const CreateRouteScreen({super.key});@overrideState<CreateRouteScreen> createState() => _CreateRouteScreenState();}class _CreateRouteScreenState extends State<CreateRouteScreen> {final _formKey = GlobalKey<FormState>();final RouteService _routeService = RouteService();// --- STATE DATA ---DateTime _selectedDate = DateTime.now();List<School> _allSchools = [];List<Vehicle> _availableVehicles = [];List<School> _selectedSchools = [];Vehicle? _selectedVehicle; // Hanya bisa 1 mobil per rute// Menu data yang akan di-set berdasarkan sekolah yang dipilihint _bottleneckDuration = 0; // Durasi masak terlama (dalam menit)List<String> _requiredMenuIds = []; // ID menu unik yang dibutuhkanList<String> _requiredMenuNames = []; // Nama menubool _isLoading = true;bool _isSubmitting = false;@overridevoid initState() {super.initState();_fetchInitialData();}Future<void> _fetchInitialData() async {try {final results = await Future.wait([SchoolService().getMySchools(),VehicleService().getMyVehicles(),_getRoutesBySelectedDate(_selectedDate,), // Ambil rute yang sudah terpakai]);final allSchools = results[0] as List<School>;final allVehicles = results[1] as List<Vehicle>;final routesOnDate = results[2] as List<Map<String, dynamic>>;// Filter mobil yang AKTIF dan BELUM terpakai di tanggal inifinal usedVehicleIds = routesOnDate.map((r) => r['vehicle_id'].toString()).toSet();final availableVehicles = allVehicles.where((v) => v.isActive && !usedVehicleIds.contains(v.id)).toList();if (!mounted) return;setState(() {_allSchools = allSchools;_availableVehicles = availableVehicles;_isLoading = false;// Atur default selected vehicle ke yang pertama tersediaif (availableVehicles.isNotEmpty) {_selectedVehicle = availableVehicles.first;}});} catch (e) {if (mounted) {ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Gagal memuat data: $e"),backgroundColor: Colors.red,),);setState(() => _isLoading = false);}}}Future<List<Map<String, dynamic>>> _getRoutesBySelectedDate(DateTime date,) async {return await _routeService.getRoutesByDate(date);}// Dipanggil saat tanggal diubahvoid _onDateChanged(DateTime newDate) {if (newDate.isBefore(DateTime.now().subtract(const Duration(hours: 24)))) {ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Jadwal harus hari ini atau ke depan, Goblok!"),),);return;}setState(() {_selectedDate = newDate;_selectedSchools = []; // Clear selection_selectedVehicle = null; // Clear vehicle selection to refilter_bottleneckDuration = 0;_requiredMenuIds = [];_requiredMenuNames = [];_isLoading = true;});_fetchInitialData(); // Re-fetch data untuk filter ketersediaan mobil}// Dipanggil saat ada perubahan sekolah yang dipilihFuture<void> _onSchoolSelectionChanged() async {if (_selectedSchools.isEmpty) {setState(() {_bottleneckDuration = 0;_requiredMenuIds = [];_requiredMenuNames = [];});return;}// Perhitungan Bottleneck Menu (Menu yang butuh waktu masak terlama)try {// >>> UBAH: Panggil service untuk menganalisis Menu Set yang terlibat <<<final result = await _routeService.getBottleneckMenuSetInfo(_selectedSchools,);// Hasilnya sekarang adalah: {duration: int, menuIds: List<String>, menuSetNames: List<String>}if (!mounted) return;setState(() {_bottleneckDuration = result['duration'] as int;_requiredMenuIds = result['menuIds'] as List<String>;_requiredMenuNames =result['menuSetNames']as List<String>; // <-- Ini adalah nama Set yang terlibat});} catch (e) {if (mounted) {ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Gagal hitung bottleneck menu: $e"),backgroundColor: Colors.red,),);setState(() {_bottleneckDuration = 0;_requiredMenuIds = [];_requiredMenuNames = [];});}}}// --- SUBMIT: RUTE MANUAL ---Future<void> _createManualRoute() async {if (!_formKey.currentState!.validate()) return;if (_selectedVehicle == null || _requiredMenuIds.isEmpty) {ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Mobil dan Menu Wajib ada, Anjing!")),);return;}// >>> KRITIS: Tambahkan cek kapasitas total! <<<final totalPortions = _selectedSchools.fold(0,(sum, s) => sum + s.studentCount,);if (totalPortions > _selectedVehicle!.capacityLimit) {ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Total porsi (${totalPortions}) melebihi kapasitas mobil (${_selectedVehicle!.capacityLimit}). Rute akan dibuat Multi-Trip!",),backgroundColor: Colors.orange,),);// Lanjutkan proses, tapi service harus menangani Multi-Trip}// WARNING: Logika OSRM dan Insert Route ada di Service!setState(() => _isSubmitting = true);try {// Menggunakan fungsi yang sama (asumsi service yang mengontrol multi-trip)await _routeService.createBatchRoutes(vehicleIds: [_selectedVehicle!.id], // Hanya 1 mobilcourierId:_selectedVehicle!.courierProfileId ??await _routeService.getFirstCourierId(),menuIds: _requiredMenuIds,date: _selectedDate,selectedSchools: _selectedSchools,cookingDuration: _bottleneckDuration,);if (!mounted) return;ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Rute Manual Berhasil Dibuat dan Di-Optimasi (Multi-Trip jika perlu)!",),backgroundColor: Colors.green,),);Navigator.pop(context, true); // Selesai} catch (e) {if (!mounted) return;ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Gagal Buat Rute: ${e.toString()}"),backgroundColor: Colors.red,duration: const Duration(seconds: 5),),);} finally {if (mounted) setState(() => _isSubmitting = false);}}@overrideWidget build(BuildContext context) {return Scaffold(appBar: AppBar(title: const Text("Buat Rute Pengiriman (Manual)"),backgroundColor: Colors.orange[800],foregroundColor: Colors.white,),body: _isLoading? const Center(child: CircularProgressIndicator()): SingleChildScrollView(padding: const EdgeInsets.all(16.0),child: Form(key: _formKey,child: Column(crossAxisAlignment: CrossAxisAlignment.start,children: [// --- STEP 1: TANGGAL (PENTING) ---const Text("1. Tanggal Pengiriman",style: TextStyle(fontSize: 16,fontWeight: FontWeight.bold,color: Colors.blueGrey,),),const SizedBox(height: 10),ListTile(leading: const Icon(Icons.calendar_today,color: Colors.red,),title: Text(DateFormat('EEEE, d MMMM yyyy','id_ID',).format(_selectedDate),style: const TextStyle(fontWeight: FontWeight.bold),),trailing: const Icon(Icons.edit),onTap: () async {final DateTime? picked = await showDatePicker(context: context,initialDate: _selectedDate,firstDate: DateTime.now(),lastDate: DateTime.now().add(const Duration(days: 90),),);if (picked != null && picked != _selectedDate) {_onDateChanged(picked);}},),const Divider(thickness: 2, height: 30),// --- STEP 2: ARMADA (MOBIL & KURIR) ---const Text("2. Pilih Armada (Mobil & Kurir)",style: TextStyle(fontSize: 16,fontWeight: FontWeight.bold,color: Colors.blueGrey,),),const SizedBox(height: 10),DropdownButtonFormField<Vehicle>(decoration: const InputDecoration(labelText: "Pilih Armada Mobil",prefixIcon: Icon(Icons.local_shipping),),value: _selectedVehicle,items: _availableVehicles.map((v) {return DropdownMenuItem(value: v,child: Text("${v.plateNumber} (Kap: ${v.capacityLimit})",),);}).toList(),onChanged: (val) =>setState(() => _selectedVehicle = val),validator: (v) =>v == null ? "Wajib pilih mobil, bego!" : null,),const SizedBox(height: 10),// Display Kurir (hanya read-only, dari join ke vehicle)Text("Kurir Bertugas: ${_selectedVehicle?.driverName ?? 'Belum Ditugaskan'}",style: TextStyle(fontStyle: FontStyle.italic,color: _selectedVehicle?.driverName != null? Colors.green: Colors.red,),),const Divider(thickness: 2, height: 30),// --- STEP 3: SEKOLAH TUJUAN ---const Text("3. Pilih Sekolah Tujuan (Urutan TIDAK penting, akan di-optimasi)",style: TextStyle(fontSize: 16,fontWeight: FontWeight.bold,color: Colors.blueGrey,),),const SizedBox(height: 10),// Multi Select Dropdown untuk SekolahWrap(spacing: 8.0,children: _allSchools.map((school) {final isSelected = _selectedSchools.contains(school);return ChoiceChip(label: Text(school.name),selected: isSelected,onSelected: (selected) {setState(() {if (selected) {_selectedSchools.add(school);} else {_selectedSchools.removeWhere((s) => s.id == school.id,);}});_onSchoolSelectionChanged(); // Update menu bottleneck},selectedColor: Colors.orange[100],backgroundColor: Colors.grey[200],side: BorderSide(color: isSelected ? Colors.orange : Colors.grey,),);}).toList(),),if (_selectedSchools.isEmpty)const Padding(padding: EdgeInsets.only(top: 10),child: Text("Wajib pilih minimal 1 sekolah!",style: TextStyle(color: Colors.red),),),const Divider(thickness: 2, height: 30),// --- STEP 4: RINGKASAN & ACTION ---const Text("4. Ringkasan Kebutuhan",style: TextStyle(fontSize: 16,fontWeight: FontWeight.bold,color: Colors.blueGrey,),),const SizedBox(height: 10),Card(color: Colors.yellow[50],child: Padding(padding: const EdgeInsets.all(12.0),child: Column(crossAxisAlignment: CrossAxisAlignment.start,children: [Text("Total Sekolah: ${_selectedSchools.length} Lokasi",style: const TextStyle(fontWeight: FontWeight.bold,),),const SizedBox(height: 8),Text("Total Porsi: ${_selectedSchools.fold(0, (sum, s) => sum + s.studentCount)} Porsi",),Text("Menu Bottleneck: ${_requiredMenuNames.join(', ')}",maxLines: 2,overflow: TextOverflow.ellipsis,),Text("Durasi Masak Terlama (Bottleneck): **${_bottleneckDuration} Menit**",style: const TextStyle(color: Colors.red),),],),),),const SizedBox(height: 30),SizedBox(width: double.infinity,child: ElevatedButton.icon(onPressed:(_isSubmitting ||_selectedSchools.isEmpty ||_selectedVehicle == null ||_bottleneckDuration == 0)? null: _createManualRoute,icon: const Icon(Icons.route, color: Colors.white),label: _isSubmitting? const CircularProgressIndicator(color: Colors.white,): const Text("GENERATE RUTE MANUAL & OPTIMASI",style: TextStyle(color: Colors.white,fontWeight: FontWeight.bold,),),style: ElevatedButton.styleFrom(backgroundColor: Colors.green[700],padding: const EdgeInsets.symmetric(vertical: 15),),),),const SizedBox(height: 30),],),),),);}}

=== FILE: lib/features/admin_sppg/screens/edit_account_screen.dart ===
import 'package:flutter/material.dart';import 'package:supabase_flutter/supabase_flutter.dart';import '../services/coordinator_service.dart';import '../services/teacher_service.dart';import '../services/courier_service.dart';import '../services/school_service.dart';import '../../../models/school_model.dart';import 'package:collection/collection.dart';class EditAccountScreen extends StatefulWidget {final String userId;final String initialRole;final Map<String, dynamic> initialData;const EditAccountScreen({super.key,required this.userId,required this.initialRole,required this.initialData,});@overrideState<EditAccountScreen> createState() => _EditAccountScreenState();}class _EditAccountScreenState extends State<EditAccountScreen> {final _formKey = GlobalKey<FormState>();late final TextEditingController _nameController;late final TextEditingController _emailController;late final TextEditingController _classController;late final TextEditingController _phoneController;// [BARU] Controller untuk menampilkan nama sekolah saat ini (uneditable)late final TextEditingController _currentSchoolNameController;// [BARU] Controller Siswa Kelaslate final TextEditingController _classStudentCountController;// [BARU] State Kuotaint _totalSchoolCapacity = 0;int _allocatedCapacity = 0;List<School> _schools = [];String? _selectedSchoolId;bool _isLoading = true;bool _isSubmitting = false;@overridevoid initState() {super.initState();_nameController = TextEditingController(text: widget.initialData['name']);_emailController = TextEditingController(text: widget.initialData['email']);_phoneController = TextEditingController(text: widget.initialData['phoneNumber'],);_classController = TextEditingController(text: widget.initialData['className'],);_selectedSchoolId = widget.initialData['schoolId'];// [FIX 1: Ambil nama sekolah dari initialData untuk preview]// Ambil nama sekolah dari data yang dilempar dari dashboard (sudah fix di atas)final String currentSchoolName =widget.initialData['schoolName'] ?? 'Belum Ditugaskan';_currentSchoolNameController = TextEditingController(text: currentSchoolName,); // <--- INI SUDAH BENAR// [BARU] Initialize class student count (memastikan tipenya num/int)_classStudentCountController = TextEditingController(text: widget.initialData['studentCountClass']?.toString() ?? '0',);// Masalah: _selectedSchoolId akan ter-set ke null jika tidak ada (meski ada nama)// Biarkan _selectedSchoolId default dari initialData['schoolId']._fetchSchools();}Future<void> _fetchSchools() async {final schoolService = SchoolService();try {// 1. Coba ambil profile role user yang sedang loginfinal userProfile = await Supabase.instance.client.from('profiles').select('role').eq('id', Supabase.instance.client.auth.currentUser!.id).single();final String userRole = userProfile['role'];// Jika user login adalah BGN, kita tidak perlu (dan tidak bisa) memuat list sekolah.if (userRole.toLowerCase() == 'bgn') {if (mounted) {setState(() {_isLoading = false;});}return; // Stop processing for BGN user}// 2. Jika bukan BGN (Admin SPPG), lanjutkan memuat data sekolahfinal data = await schoolService.getMySchools();if (widget.initialRole == 'walikelas' &&widget.initialData['schoolId'] != null) {await _loadQuotaDetails(widget.initialData['schoolId']!,excludeUserId: widget.userId,);}if (!mounted) return;setState(() {_schools = data;_isLoading = false;});} catch (e) {if (!mounted) return;// Ini akan menangkap error "User profile tidak memiliki ID SPPG. Akses Ditolak!"// yang memang dilempar SchoolService jika yang login BGN/profil rusak.if (e.toString().contains("Akses Ditolak")) {print("BGN User accessing Admin screen. School list skipped.");} else {ScaffoldMessenger.of(context,).showSnackBar(SnackBar(content: Text("Error loading schools: $e")));}setState(() => _isLoading = false);}}// [BARU] Load Detail Kuota SekolahFuture<void> _loadQuotaDetails(String schoolId, {String? excludeUserId,}) async {try {final quota = await TeacherService().getSchoolQuotaDetails(schoolId,excludeUserId: excludeUserId,);if (mounted) {setState(() {_totalSchoolCapacity = quota['totalSchool'] ?? 0;_allocatedCapacity = quota['allocated'] ?? 0;// Tidak perlu memanggil setState di sini karena sudah dipanggil di caller.});}} catch (e) {if (mounted) {ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Error load kuota: $e"),backgroundColor: Colors.red,),);}}}Future<void> _submit() async {if (_formKey.currentState!.validate()) {final int classCount =int.tryParse(_classStudentCountController.text) ?? 0;final availableQuota = _totalSchoolCapacity - _allocatedCapacity;// Hitung kembali maxAllowed agar sinkronfinal initialClassCount = widget.initialData['studentCountClass'] ?? 0;final maxAllowed =(_totalSchoolCapacity - _allocatedCapacity) + initialClassCount;// Validasi Kuota Totalif (classCount > maxAllowed) {// <-- Menggunakan maxAllowed yang benarif (!mounted) return;ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Jumlah siswa melebihi kuota sekolah yang tersedia!"),backgroundColor: Colors.red,),);return;}setState(() => _isSubmitting = true);try {final Map<String, dynamic> data = {'full_name': _nameController.text.trim(),'email': _emailController.text.trim(),'phone_number': _phoneController.text.trim(), // [BARU] Tambahkan phone number'school_id': _selectedSchoolId,};if (widget.initialRole == 'koordinator' ||widget.initialRole == 'walikelas') {data['school_id'] = _selectedSchoolId;}if (widget.initialRole == 'walikelas') {data['class_name'] = _classController.text.trim();data['student_count_class'] = classCount; // BARU}// Panggil service yang sesuaiif (widget.initialRole == 'kurir') {await CourierService().updateCourierAccount(widget.userId, data);} else if (widget.initialRole == 'koordinator') {await CoordinatorService().updateCoordinatorAccount(widget.userId,data,);} else if (widget.initialRole == 'walikelas') {await TeacherService().updateTeacherAccount(widget.userId, data);}if (!mounted) return;ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Akun berhasil diperbarui!"),backgroundColor: Colors.green,),);Navigator.pop(context, true);} catch (e) {ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Error: $e"), backgroundColor: Colors.red),);} finally {if (mounted) setState(() => _isSubmitting = false);}}}@overridevoid dispose() {_nameController.dispose();_emailController.dispose();_classController.dispose();_phoneController.dispose(); // [BARU] Dispose phone controllersuper.dispose();}@overrideWidget build(BuildContext context) {// [FIX KRITIS 4]: Hitung maxAllowed di build agar responsiffinal isWaliKelas = widget.initialRole == 'walikelas';final currentClassCount = widget.initialData['studentCountClass'] ?? 0;// Max yang boleh diinput saat edit = (Total Sekolah - Alokasi Kelas Lain) + Porsi Kelas Saat Inifinal maxAllowed =(_totalSchoolCapacity - _allocatedCapacity) + currentClassCount;// Cari nama sekolah yang saat ini dipilih (untuk display di dropdown)final selectedSchool = _schools.firstWhereOrNull((s) => s.id == _selectedSchoolId,);final availableQuota = _totalSchoolCapacity - _allocatedCapacity;return Scaffold(appBar: AppBar(title: Text("Edit Akun ${widget.initialRole.toUpperCase()}"),backgroundColor: Colors.orange[800],foregroundColor: Colors.white,),body: _isLoading? const Center(child: CircularProgressIndicator()): SingleChildScrollView(padding: const EdgeInsets.all(16.0),child: Form(key: _formKey,child: Column(children: [TextFormField(controller: _nameController,decoration: const InputDecoration(labelText: "Nama Lengkap",prefixIcon: Icon(Icons.person),),validator: (v) => v!.isEmpty ? "Wajib diisi" : null,),const SizedBox(height: 15),TextFormField(controller: _phoneController, // [BARU] Phone FieldkeyboardType: TextInputType.phone,decoration: const InputDecoration(labelText: "Nomor Telepon",prefixIcon: Icon(Icons.phone),),validator: (v) => v!.isEmpty ? "Wajib diisi" : null,),const SizedBox(height: 15),TextFormField(controller: _emailController,decoration: const InputDecoration(labelText: "Email Login",prefixIcon: Icon(Icons.email),),keyboardType: TextInputType.emailAddress,validator: (v) => v!.isEmpty ? "Wajib diisi" : null,),const SizedBox(height: 15),// Field Khusus Koordinator & Wali Kelasif (widget.initialRole == 'koordinator' ||widget.initialRole == 'walikelas') ...[// [FIX PREVIEW] Tampilkan Sekolah yang Ditugaskan Saat Ini (Uneditable)TextFormField(controller: _currentSchoolNameController,decoration: const InputDecoration(labelText: "Sekolah Ditugaskan Saat Ini",prefixIcon: Icon(Icons.school),),readOnly: true,style: const TextStyle(fontWeight: FontWeight.bold,color: Colors.indigo,),),const SizedBox(height: 15),// DROPDOWN UNTUK MENGGANTI SEKOLAHDropdownButtonFormField<String>(decoration: const InputDecoration(labelText: "Ganti Sekolah Tujuan (Opsional)",prefixIcon: Icon(Icons.swap_horiz),),// [FIX 3: Gunakan _selectedSchoolId sebagai value awal]// Ini memastikan nilai awal di dropdown sesuai dengan yang ditugaskan saat ini.value: _selectedSchoolId,items: [// Tambahkan opsi untuk 'Tidak Ditugaskan' (NULL)const DropdownMenuItem(value: null,child: Text('--- Tidak Ditugaskan ---'),),// List Sekolah yang tersedia..._schools.map((school) {return DropdownMenuItem(value: school.id,// Tampilkan nama sekolah, pastikan tidak crashchild: Text(school.name,overflow: TextOverflow.ellipsis,),);}).toList(),],onChanged: (val) {setState(() {_selectedSchoolId = val;// [FIX KRITIS 4: Update TextController ketika pilihan diubah]if (val != null) {final newSchool = _schools.firstWhereOrNull((s) => s.id == val,);// Tampilkan nama sekolah baru yang dipilih_currentSchoolNameController.text =newSchool?.name ?? 'Sekolah tidak ditemukan';} else {// Jika memilih 'Tidak Ditugaskan' (null)_currentSchoolNameController.text ='Belum Ditugaskan';}});},validator: (val) =>null, // Biarkan validasi di _submit() saja jika field ini diisi),const SizedBox(height: 15),],// Field Khusus Wali Kelasif (isWaliKelas) ...[TextFormField(controller: _classController,decoration: const InputDecoration(labelText: "Nama Kelas (Misal: 7A)",prefixIcon: Icon(Icons.class_),),validator: (v) => v!.isEmpty ? "Wajib diisi" : null,),const SizedBox(height: 15),// INFO KUOTA SEKOLAHif (isWaliKelas && _totalSchoolCapacity > 0)Card(color: Colors.blue[50],margin: const EdgeInsets.only(bottom: 15),child: Padding(padding: const EdgeInsets.all(12.0),child: Column(crossAxisAlignment: CrossAxisAlignment.start,children: [Text("Total Siswa Sekolah: $_totalSchoolCapacity",style: const TextStyle(fontWeight: FontWeight.bold,),),Text("Dialokasikan Kelas Lain: $_allocatedCapacity Siswa",style: const TextStyle(color: Colors.red),),Text("Quota Max Kelas Ini: $maxAllowed Siswa",style: const TextStyle(color: Colors.green),),],),),),// [BARU] JUMLAH PENERIMA MANFAAT DI KELAS INI// ... (TextFormField Jml Penerima Kelas Ini) ...TextFormField(controller: _classStudentCountController,keyboardType: TextInputType.number,decoration: InputDecoration(labelText: "Jml Penerima Kelas Ini",hintText:"Maksimal: $maxAllowed", // <-- Menampilkan maxAllowed yang benarprefixIcon: const Icon(Icons.people),),validator: (v) {if (v!.isEmpty) return "Wajib diisi";final count = int.tryParse(v) ?? 0;if (count <= 0) return "Jumlah harus lebih dari 0";if (count > maxAllowed)return "Melebihi kuota tersedia ($maxAllowed)";return null;},),const SizedBox(height: 30),SizedBox(width: double.infinity,child: ElevatedButton(onPressed: _isSubmitting ? null : _submit,style: ElevatedButton.styleFrom(backgroundColor: Colors.orange[800],padding: const EdgeInsets.symmetric(vertical: 15),),child: _isSubmitting? const CircularProgressIndicator(color: Colors.white,): const Text("SIMPAN PERUBAHAN",style: TextStyle(color: Colors.white,fontWeight: FontWeight.bold,),),),),],],),),),);}}

=== FILE: lib/features/admin_sppg/screens/add_coordinator_screen.dart ===
import 'package:flutter/material.dart';import '../services/coordinator_service.dart';import '../services/school_service.dart'; // Butuh ini buat list sekolahimport '../../../models/school_model.dart';class AddCoordinatorScreen extends StatefulWidget {const AddCoordinatorScreen({super.key});@overrideState<AddCoordinatorScreen> createState() => _AddCoordinatorScreenState();}class _AddCoordinatorScreenState extends State<AddCoordinatorScreen> {final _formKey = GlobalKey<FormState>();final _nameController = TextEditingController();final _emailController = TextEditingController();final _passwordController = TextEditingController();final _phoneController = TextEditingController(); // [BARU]// Servicefinal SchoolService _schoolService = SchoolService();List<School> _schools = [];String? _selectedSchoolId;bool _isSubmitting = false;@overridevoid initState() {super.initState();_fetchSchools();}Future<void> _fetchSchools() async {try {final data = await _schoolService.getMySchools();setState(() {_schools = data;});} catch (e) {// Handle error diam-diam atau snackbar}}Future<void> _submit() async {if (_formKey.currentState!.validate()) {setState(() => _isSubmitting = true);try {await CoordinatorService().createCoordinatorAccount(email: _emailController.text.trim(),password: _passwordController.text,fullName: _nameController.text.trim(),schoolId: _selectedSchoolId!,phoneNumber: _phoneController.text.trim(),);if (!mounted) return;ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Akun Koordinator Berhasil Dibuat!"),backgroundColor: Colors.green,),);Navigator.pop(context, true);} catch (e) {ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Error: $e"), backgroundColor: Colors.red),);} finally {if (mounted) setState(() => _isSubmitting = false);}}}@overrideWidget build(BuildContext context) {return Scaffold(appBar: AppBar(title: const Text("Tambah Koordinator Sekolah"),backgroundColor: Colors.orange[800],foregroundColor: Colors.white,),body: Padding(padding: const EdgeInsets.all(16.0),child: Form(key: _formKey,child: Column(children: [TextFormField(controller: _nameController,decoration: const InputDecoration(labelText: "Nama Koordinator",border: OutlineInputBorder(),prefixIcon: Icon(Icons.person),),validator: (v) => v!.isEmpty ? "Wajib diisi" : null,),const SizedBox(height: 15),// DROPDOWN PILIH SEKOLAHDropdownButtonFormField<String>(decoration: const InputDecoration(labelText: "Tugaskan di Sekolah",border: OutlineInputBorder(),prefixIcon: Icon(Icons.school),),value: _selectedSchoolId,items: _schools.map((school) {return DropdownMenuItem(value: school.id,child: Text(school.name, overflow: TextOverflow.ellipsis),);}).toList(),onChanged: (val) => setState(() => _selectedSchoolId = val),validator: (val) => val == null ? "Wajib pilih sekolah" : null,),const SizedBox(height: 15),// [BARU] Field Nomor TeleponTextFormField(controller: _phoneController,keyboardType: TextInputType.phone,decoration: const InputDecoration(labelText: "Nomor Telepon",border: OutlineInputBorder(),prefixIcon: Icon(Icons.phone),),validator: (v) => v!.isEmpty ? "Wajib diisi" : null,),const SizedBox(height: 15),TextFormField(controller: _emailController,decoration: const InputDecoration(labelText: "Email Login",border: OutlineInputBorder(),prefixIcon: Icon(Icons.email),),keyboardType: TextInputType.emailAddress,validator: (v) => v!.isEmpty ? "Wajib diisi" : null,),const SizedBox(height: 15),TextFormField(controller: _passwordController,obscureText: true,decoration: const InputDecoration(labelText: "Password",border: OutlineInputBorder(),prefixIcon: Icon(Icons.lock),),validator: (v) => v!.length < 6 ? "Minimal 6 karakter" : null,),const SizedBox(height: 30),SizedBox(width: double.infinity,child: ElevatedButton(onPressed: _isSubmitting ? null : _submit,style: ElevatedButton.styleFrom(backgroundColor: Colors.orange[800],padding: const EdgeInsets.symmetric(vertical: 15),),child: _isSubmitting? const CircularProgressIndicator(color: Colors.white): const Text("BUAT AKUN KOORDINATOR",style: TextStyle(color: Colors.white,fontWeight: FontWeight.bold,),),),),],),),),);}}

=== FILE: lib/features/admin_sppg/screens/add_school_screen.dart ===
import 'package:flutter/material.dart';import 'package:latlong2/latlong.dart';import 'package:collection/collection.dart';import 'dart:convert'; // Need this for JSON encoding/decodingimport '../services/menu_service.dart';import '../../../models/school_model.dart';import '../../../models/menu_model.dart';import '../../pengawas/screens/location_picker_screen.dart';import '../services/school_service.dart';// Mapping for days (Mon-Sat)const List<String> _days = ['Senin','Selasa','Rabu','Kamis','Jumat','Sabtu',];class AddSchoolScreen extends StatefulWidget {final School? schoolToEdit;const AddSchoolScreen({super.key, this.schoolToEdit});@overrideState<AddSchoolScreen> createState() => _AddSchoolScreenState();}class _AddSchoolScreenState extends State<AddSchoolScreen> {final _formKey = GlobalKey<FormState>();final MenuService _menuService = MenuService();final SchoolService _schoolService =SchoolService(); // Tambahkan jika belum ada// --- Controllers ---final TextEditingController _nameController = TextEditingController();final TextEditingController _addressController = TextEditingController();final TextEditingController _studentCountController = TextEditingController();final TextEditingController _serviceTimeController = TextEditingController(text: "10",);final TextEditingController _toleranceController = TextEditingController(text: "45",);final TextEditingController _latController = TextEditingController();final TextEditingController _longController = TextEditingController();// --- State Variables ---List<Menu> _availableMenus = [];// [BARU] State untuk Menu Set PilihanString? _selectedMenuSetId; // ID Menu Set yang dipilihAdminMenuSetModel? _selectedMenuSetData; // Data set yang dipilihList<AdminMenuSetModel> _allMenuSets = []; // List semua Menu Setbool _isHighRisk = false; // <-- Variabel ini hilang di kode Andabool _isMenuLoading = true;// [FIX KRITIS 1]: Deklarasi _isSubmittingbool _isSubmitting = false; // <--- DIBUTUHKAN// --- NEW STATE: Weekly Schedule (Mon-Sat TimePicker) ---Map<String, TimeOfDay?> _weeklySchedule = {for (var day in _days) day: null};// Single time control for 'Apply to All'TimeOfDay? _universalTime;@overridevoid initState() {super.initState();// Inisialisasi isHighRisk dari data edit jika adaif (widget.schoolToEdit != null) {_isHighRisk = widget.schoolToEdit!.isHighRisk;}_fetchMenusAndInitialize();}@overridevoid dispose() {_nameController.dispose();_addressController.dispose();_studentCountController.dispose();_serviceTimeController.dispose();_toleranceController.dispose();_latController.dispose();_longController.dispose();super.dispose();}// Parses old string data into the new weekly map structureMap<String, TimeOfDay?> _parseSchedule(String? jsonString) {Map<String, TimeOfDay?> schedule = {for (var day in _days) day: null};if (jsonString == null || jsonString.isEmpty) return schedule;try {final Map<String, dynamic> data = jsonDecode(jsonString);data.forEach((key, value) {if (_days.contains(key) && value is String && value.length >= 5) {final parts = value.split(':');if (parts.length >= 2) {schedule[key] = TimeOfDay(hour: int.parse(parts[0]),minute: int.parse(parts[1]),);}}});} catch (_) {// Failed to parse JSON, returning default empty schedule}return schedule;}// Perbarui Fetcher: Load Menu biasa (untuk mode Custom) dan Menu SetFuture<void> _fetchMenusAndInitialize() async {try {final results = await Future.wait([_menuService.getMyMenus(),_menuService.getMyMenuSets(), // Load Menu Set Baru]);final menus = results[0] as List<Menu>;final menuSets =results[1] as List<AdminMenuSetModel>; // Tangkap Menu Set_availableMenus = menus;_allMenuSets = menuSets;if (widget.schoolToEdit != null) {final s = widget.schoolToEdit!;_nameController.text = s.name;_addressController.text = s.address ?? '';_studentCountController.text = s.studentCount.toString();_serviceTimeController.text = s.serviceTimeMinutes.toString();_toleranceController.text = s.toleranceMinutes.toString();_isHighRisk = s.isHighRisk; // Inisialisasi isHighRiskif (s.latitude != null) _latController.text = s.latitude.toString();if (s.longitude != null) _longController.text = s.longitude.toString();_weeklySchedule = _parseSchedule(s.deadlineTime);// PARSING MENU SETif (s.menuDefault != null && s.menuDefault!.isNotEmpty) {final existingSet = menuSets.firstWhereOrNull((set) => set.setName == s.menuDefault,);if (existingSet != null) {_selectedMenuSetId = existingSet.id;_selectedMenuSetData = existingSet;} else {_selectedMenuSetId = null;}}}// Defaultkan ke set pertama jika belum terpilihif (_selectedMenuSetId == null && _allMenuSets.isNotEmpty) {_selectedMenuSetId = _allMenuSets.first.id;_selectedMenuSetData = _allMenuSets.first;}if (mounted) {setState(() {_isMenuLoading = false;});}} catch (e) {if (mounted) {ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("BASTARD! Gagal tarik data: $e"),backgroundColor: Colors.red,),);setState(() => _isMenuLoading = false);}}}// Function to save the full weekly schedule as a JSON stringString _serializeWeeklySchedule() {Map<String, String> data = {};_weeklySchedule.forEach((day, time) {if (time != null) {data[day] ="${time.hour.toString().padLeft(2, '0')}:${time.minute.toString().padLeft(2, '0')}:00";}});return jsonEncode(data);}// --- 1. Fungsi Pilih Jam Universal ---Future<void> _pickUniversalTime() async {final TimeOfDay? picked = await showTimePicker(context: context,initialTime: _universalTime ?? const TimeOfDay(hour: 12, minute: 0),);if (picked != null) {setState(() {_universalTime = picked;_weeklySchedule = {for (var day in _days) day: picked};});ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Waktu diterapkan untuk semua hari!")),);}}// --- 2. Fungsi Buka Peta (RESTORED) ---Future<void> _openMapPicker() async {double initialLat = double.tryParse(_latController.text) ?? -6.9175;double initialLong = double.tryParse(_longController.text) ?? 107.6191;final LatLng? result = await Navigator.push(context,MaterialPageRoute(builder: (context) => LocationPickerScreen(initialLat: initialLat,initialLong: initialLong,),),);if (result != null) {setState(() {_latController.text = result.latitude.toString();_longController.text = result.longitude.toString();});ScaffoldMessenger.of(context,).showSnackBar(const SnackBar(content: Text("Lokasi Sekolah terpilih!")));}}// [FIX KRITIS 3]: Hapus duplikasi fungsi _submitForm// --- 3. Submit ke Database (DIPERBAIKI) ---Future<void> _submitForm() async {// Check if at least one day is scheduledif (_weeklySchedule.values.every((time) => time == null)) {if (!mounted) return;ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Wajib mengatur jadwal minimal 1 hari!")),);return;}// [VALIDASI KRITIS MENU SET]if (_selectedMenuSetId == null) {if (!mounted) return;ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Wajib pilih salah satu Menu Set!"),backgroundColor: Colors.red,),);return;}// --- START SUBMIT LOGIC ---if (_formKey.currentState!.validate()) {setState(() => _isSubmitting = true);try {final String scheduleJson = _serializeWeeklySchedule();// [UPDATE KRITIS MENU_DEFAULT]: Ambil NAMA Menu Set yang dipilihfinal selectedSetName = _allMenuSets.firstWhere((set) => set.id == _selectedMenuSetId).setName; // Mengambil nama set untuk disimpan di DBfinal Map<String, dynamic> data = {'name': _nameController.text,'address': _addressController.text,'student_count': int.parse(_studentCountController.text),'service_time_minutes': int.parse(_serviceTimeController.text),'is_high_risk': _isHighRisk, // <-- Tambahkan kembali'gps_lat': double.tryParse(_latController.text),'gps_long': double.tryParse(_longController.text),'tolerance_minutes': int.parse(_toleranceController.text),'menu_default': selectedSetName, // Menyimpan NAMA SET'deadline_time': scheduleJson,};if (widget.schoolToEdit == null) {await _schoolService.createSchool(data);} else {await _schoolService.updateSchool(widget.schoolToEdit!.id, data);}if (!mounted) return;ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Data Sekolah berhasil ${widget.schoolToEdit == null ? 'ditambahkan' : 'diperbarui'}!",),backgroundColor: Colors.green,),);Navigator.pop(context, true);} catch (e) {if (!mounted) return;ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Gagal Simpan: ${e.toString()}"),backgroundColor: Colors.red,),);} finally {if (mounted) setState(() => _isSubmitting = false);}}}@overrideWidget build(BuildContext context) {final isEdit = widget.schoolToEdit != null;// [FIX KRITIS 2]: Hapus referensi ke variabel lama yang tidak ada// final isCustomMenu = _selectedMenuSetName == 'Custom Menu' || _selectedMenuSetName == null;return Scaffold(appBar: AppBar(title: Text(isEdit ? "Edit Sekolah" : "Tambah Sekolah"),backgroundColor: Colors.orange[800],foregroundColor: Colors.white,),body: _isMenuLoading? const Center(child: CircularProgressIndicator()): SingleChildScrollView(padding: const EdgeInsets.all(16),child: Form(key: _formKey,child: Column(crossAxisAlignment: CrossAxisAlignment.start,children: [// --- DATA UMUM ---const Text("Data Umum",style: TextStyle(fontSize: 18,fontWeight: FontWeight.bold,),),const SizedBox(height: 15),TextFormField(controller: _nameController,decoration: const InputDecoration(labelText: "Nama Lokasi Penerima",prefixIcon: Icon(Icons.school),),validator: (v) => v!.isEmpty ? "Wajib diisi" : null,),const SizedBox(height: 15),TextFormField(controller: _addressController,maxLines: 2,decoration: const InputDecoration(labelText: "Alamat Lengkap",prefixIcon: Icon(Icons.home),),),const SizedBox(height: 15),Row(children: [Expanded(child: TextFormField(controller: _studentCountController,keyboardType: TextInputType.number,decoration: const InputDecoration(labelText: "Jml Penerima",prefixIcon: Icon(Icons.people),),validator: (v) => v!.isEmpty ? "Wajib" : null,),),const SizedBox(width: 10),Expanded(child: TextFormField(controller: _serviceTimeController,keyboardType: TextInputType.number,decoration: const InputDecoration(labelText: "Waktu Service (Menit)",prefixIcon: Icon(Icons.timer),),validator: (v) => v!.isEmpty ? "Wajib" : null,),),],),const SizedBox(height: 10),const Divider(thickness: 2),// --- BAGIAN JADWAL MINGGUAN ---const Text("Jadwal Pengiriman Rutin (Deadline Konsumsi)",style: TextStyle(fontSize: 18,fontWeight: FontWeight.bold,),),const SizedBox(height: 15),// Universal Apply ButtonSizedBox(width: double.infinity,child: OutlinedButton.icon(onPressed: _pickUniversalTime,icon: const Icon(Icons.schedule, color: Colors.blue),label: Text(_universalTime != null? "Apply Jam: ${_universalTime!.format(context)} ke Semua Hari": "Atur & Terapkan Jam ke Semua Hari",),),),const SizedBox(height: 15),// Daily Time Pickers (Mon-Sat)..._days.map((day) {final time = _weeklySchedule[day];return Column(children: [ListTile(contentPadding: EdgeInsets.zero,leading: Icon(Icons.calendar_view_day,color: time != null? Colors.orange[800]: Colors.grey,),title: Text(day,style: TextStyle(fontWeight: FontWeight.bold,color: time != null? Colors.black: Colors.grey,),),subtitle: Text(time != null? time.format(context): "Tidak ada pengiriman",style: TextStyle(color: time != null? Colors.red: Colors.grey[600],),),trailing: IconButton(icon: Icon(time != null ? Icons.close : Icons.access_time,),onPressed: () async {if (time != null) {// Clear timesetState(() => _weeklySchedule[day] = null);} else {// Pick specific timefinal TimeOfDay? picked =await showTimePicker(context: context,initialTime:time ??_universalTime ??const TimeOfDay(hour: 12,minute: 0,),);if (picked != null) {setState(() => _weeklySchedule[day] = picked,);}}},),),const Divider(height: 1),],);}).toList(),const SizedBox(height: 25),const Divider(thickness: 2),// --- BAGIAN VRP CONSTRAINTS (TOLERANCE) ---const Text("Toleransi Pengiriman",style: TextStyle(fontSize: 18,fontWeight: FontWeight.bold,),),const SizedBox(height: 15),TextFormField(controller: _toleranceController,keyboardType: TextInputType.number,decoration: const InputDecoration(labelText: "Toleransi Awal (Menit)",hintText: "45",prefixIcon: Icon(Icons.fast_forward),),validator: (v) => v!.isEmpty ? "Wajib" : null,),const SizedBox(height: 15),// [BARU] Dropdown Menu Setconst Text("Set Menu Pilihan Rutin",style: TextStyle(fontSize: 18,fontWeight: FontWeight.bold,),),const SizedBox(height: 15),DropdownButtonFormField<String>(decoration: const InputDecoration(labelText: "Pilih Menu Set",prefixIcon: Icon(Icons.restaurant),),value: _selectedMenuSetId,items: _allMenuSets.map((set) {return DropdownMenuItem(value: set.id,child: Text(set.setName),);}).toList(),onChanged: (String? newId) {setState(() {_selectedMenuSetId = newId;_selectedMenuSetData = _allMenuSets.firstWhereOrNull((set) => set.id == newId,);});},validator: (v) =>v == null ? "Wajib memilih Menu Set" : null,),const SizedBox(height: 15),// --- TAMPILAN RINGKASAN MENU SET ---if (_selectedMenuSetData != null)Column(// Bungkus dalam Column agar bisa menampung Card Komponen dan Card Gizichildren: [Card(color: Colors.lightGreen[50],child: Padding(padding: const EdgeInsets.all(12.0),child: Column(crossAxisAlignment: CrossAxisAlignment.start,children: [const Text("Komponen Set:",style: TextStyle(fontWeight: FontWeight.bold,color: Colors.green,),),const SizedBox(height: 5),..._selectedMenuSetData!.menuNames.entries.map((entry) {final category = entry.key;final name = entry.value;return Padding(padding: const EdgeInsets.only(bottom: 2.0,),child: Text("• $category: ${name ?? 'Tidak Ada'}",style: TextStyle(color: (name == null)? Colors.grey: Colors.black87,),),);},).toList(),],),),),// [BARU] CARD RINGKASAN GIZIconst SizedBox(height: 10),Card(elevation: 2,color: Colors.blue[50],child: Padding(padding: const EdgeInsets.all(12.0),child: Column(crossAxisAlignment: CrossAxisAlignment.start,children: [const Text("Total Kandungan Gizi Set:",style: TextStyle(fontWeight: FontWeight.bold,color: Colors.blue,),),const Divider(height: 10, thickness: 1),Text("⚡ Energi: ${_selectedMenuSetData!.totalEnergy} Kkal",),Text("🍖 Protein: ${_selectedMenuSetData!.totalProtein.toStringAsFixed(1)} gram",),Text("🧀 Lemak: ${_selectedMenuSetData!.totalFat.toStringAsFixed(1)} gram",),Text("🥖 Karbo: ${_selectedMenuSetData!.totalCarbs.toStringAsFixed(1)} gram",),],),),),],)elseconst Padding(padding: EdgeInsets.only(top: 10),child: Text("Silakan pilih Menu Set di atas.",style: TextStyle(color: Colors.red),),),const SizedBox(height: 15),const Divider(thickness: 2),// --- BAGIAN LOKASI MAP (UNCHANGED) ---Row(mainAxisAlignment: MainAxisAlignment.spaceBetween,children: [const Text("Titik GPS",style: TextStyle(fontSize: 18,fontWeight: FontWeight.bold,),),ElevatedButton.icon(onPressed: _openMapPicker,icon: const Icon(Icons.map, size: 18),label: const Text("Buka Peta"),style: ElevatedButton.styleFrom(backgroundColor: Colors.orange[700],foregroundColor: Colors.white,),),],),const SizedBox(height: 10),Row(children: [Expanded(child: TextFormField(controller: _latController,decoration: const InputDecoration(labelText: "Lat",hintText: "Wajib dari Peta",),readOnly: true,),),const SizedBox(width: 10),Expanded(child: TextFormField(controller: _longController,decoration: const InputDecoration(labelText: "Long",hintText: "Wajib dari Peta",),readOnly: true,),),],),const SizedBox(height: 30),SizedBox(width: double.infinity,child: ElevatedButton(// Menggunakan _isSubmitting yang sudah dideklarasikanonPressed: _isSubmitting ? null : _submitForm,style: ElevatedButton.styleFrom(backgroundColor: Colors.orange[800],padding: const EdgeInsets.symmetric(vertical: 15),),child: _isSubmitting? const CircularProgressIndicator(// Tampilkan loadingcolor: Colors.white,): Text(isEdit? "SIMPAN PERUBAHAN": "SIMPAN DATA BARU",style: const TextStyle(color: Colors.white,fontWeight: FontWeight.bold,),),),),const SizedBox(height: 20),],),),),);}}

=== FILE: lib/features/admin_sppg/screens/add_courier_screen.dart ===
// FILE: lib/features/admin_sppg/screens/add_courier_screen.dartimport 'package:flutter/material.dart';import '../services/courier_service.dart';class AddCourierScreen extends StatefulWidget {const AddCourierScreen({super.key});@overrideState<AddCourierScreen> createState() => _AddCourierScreenState();}class _AddCourierScreenState extends State<AddCourierScreen> {final _formKey = GlobalKey<FormState>();final _nameController = TextEditingController();final _emailController = TextEditingController();final _passwordController = TextEditingController();final _phoneController = TextEditingController(); // [BARU] Phone Controllerbool _isSubmitting = false;@overridevoid dispose() {_nameController.dispose();_emailController.dispose();_passwordController.dispose();_phoneController.dispose(); // [BARU] Disposesuper.dispose();}Future<void> _submit() async {if (_formKey.currentState!.validate()) {setState(() => _isSubmitting = true);try {await CourierService().createCourierAccount(email: _emailController.text.trim(),password: _passwordController.text,fullName: _nameController.text.trim(),phoneNumber: _phoneController.text.trim(), // [BARU] Pass phone);if (!mounted) return;ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Akun Kurir Berhasil Dibuat!"),backgroundColor: Colors.green,),);Navigator.pop(context, true); // Sukses} catch (e) {if (!mounted) return;ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Error: $e"), backgroundColor: Colors.red),);} finally {if (mounted) setState(() => _isSubmitting = false);}}}@overrideWidget build(BuildContext context) {return Scaffold(appBar: AppBar(title: const Text("Tambah Akun Kurir"),backgroundColor: Colors.orange[800],foregroundColor: Colors.white,),body: Padding(padding: const EdgeInsets.all(16.0),child: Form(key: _formKey,child: Column(children: [TextFormField(controller: _nameController,decoration: const InputDecoration(labelText: "Nama Lengkap Kurir",border: OutlineInputBorder(),prefixIcon: Icon(Icons.person),),validator: (v) => v!.isEmpty ? "Wajib diisi" : null,),const SizedBox(height: 15),// [BARU] Field Nomor TeleponTextFormField(controller: _phoneController,keyboardType: TextInputType.phone,decoration: const InputDecoration(labelText: "Nomor Telepon",border: OutlineInputBorder(),prefixIcon: Icon(Icons.phone),),validator: (v) => v!.isEmpty ? "Wajib diisi" : null,),const SizedBox(height: 15),TextFormField(controller: _emailController,decoration: const InputDecoration(labelText: "Email Login",border: OutlineInputBorder(),prefixIcon: Icon(Icons.email),),keyboardType: TextInputType.emailAddress,validator: (v) => v!.isEmpty ? "Wajib diisi" : null,),const SizedBox(height: 15),TextFormField(controller: _passwordController,obscureText: true,decoration: const InputDecoration(labelText: "Password",border: OutlineInputBorder(),prefixIcon: Icon(Icons.lock),),validator: (v) => v!.length < 6 ? "Minimal 6 karakter" : null,),const SizedBox(height: 30),SizedBox(width: double.infinity,child: ElevatedButton(onPressed: _isSubmitting ? null : _submit,style: ElevatedButton.styleFrom(backgroundColor: Colors.orange[800],padding: const EdgeInsets.symmetric(vertical: 15),),child: _isSubmitting? const CircularProgressIndicator(color: Colors.white): const Text("BUAT AKUN KURIR",style: TextStyle(color: Colors.white,fontWeight: FontWeight.bold,),),),),],),),),);}}

=== FILE: lib/features/admin_sppg/screens/add_teacher_screen.dart ===
import 'package:flutter/material.dart';import '../services/teacher_service.dart';import '../services/school_service.dart';import '../../../models/school_model.dart';class AddTeacherScreen extends StatefulWidget {const AddTeacherScreen({super.key});@overrideState<AddTeacherScreen> createState() => _AddTeacherScreenState();}class _AddTeacherScreenState extends State<AddTeacherScreen> {final _formKey = GlobalKey<FormState>();final _nameController = TextEditingController();final _classController = TextEditingController(); // Input Nama Kelas// [FIX 1]: Deklarasikan Controller Siswa Kelasfinal TextEditingController _classStudentCountController =TextEditingController();final _emailController = TextEditingController();final _passwordController = TextEditingController();final _phoneController = TextEditingController(); // [BARU]// [BARU] State Kuotaint _totalSchoolCapacity = 0;int _allocatedCapacity = 0; // Kapasitas yang sudah diambil kelas lainfinal SchoolService _schoolService = SchoolService();List<School> _schools = [];String? _selectedSchoolId;bool _isSubmitting = false;@overridevoid initState() {super.initState();_fetchSchools();}// Diperbarui: Fetch Schools & Inisialisasi Kuota SekolahFuture<void> _fetchSchools() async {try {final data = await _schoolService.getMySchools();setState(() => _schools = data);// Jika sudah ada sekolah terpilih, load quota detailnyaif (_selectedSchoolId != null) {await _loadQuotaDetails(_selectedSchoolId!);}} catch (e) {// Handle error}}// [BARU] Load Detail Kuota SekolahFuture<void> _loadQuotaDetails(String schoolId) async {try {final quota = await TeacherService().getSchoolQuotaDetails(schoolId,// Karena ini mode Add, tidak ada excludeUserId);if (mounted) {setState(() {_totalSchoolCapacity = quota['totalSchool'] ?? 0;_allocatedCapacity = quota['allocated'] ?? 0;});}} catch (e) {if (mounted) {ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Error load kuota: $e"),backgroundColor: Colors.red,),);}}}// --- SUBMIT ---Future<void> _submit() async {if (_formKey.currentState!.validate()) {final int classCount =int.tryParse(_classStudentCountController.text) ?? 0;// Validasi Kuota Totalif (classCount + _allocatedCapacity > _totalSchoolCapacity) {if (!mounted) return;ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Jumlah siswa melebihi kuota sekolah yang tersedia!"),backgroundColor: Colors.red,),);return;}setState(() => _isSubmitting = true);try {await TeacherService().createTeacherAccount(email: _emailController.text.trim(),password: _passwordController.text,fullName: _nameController.text.trim(),schoolId: _selectedSchoolId!,className: _classController.text.trim(),phoneNumber: _phoneController.text.trim(), // [BARU] Pass phonestudentCountClass: classCount, // BARU);if (!mounted) return;ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Akun Wali Kelas Berhasil Dibuat!"),backgroundColor: Colors.green,),);Navigator.pop(context, true);} catch (e) {ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Error: $e"), backgroundColor: Colors.red),);} finally {if (mounted) setState(() => _isSubmitting = false);}}}@overrideWidget build(BuildContext context) {final availableQuota = _totalSchoolCapacity - _allocatedCapacity;return Scaffold(appBar: AppBar(title: const Text("Tambah Akun Wali Kelas"),backgroundColor: Colors.orange[800],foregroundColor: Colors.white,),body: Padding(padding: const EdgeInsets.all(16.0),child: Form(key: _formKey,child: SingleChildScrollView(child: Column(children: [DropdownButtonFormField<String>(decoration: const InputDecoration(labelText: "Pilih Sekolah",border: OutlineInputBorder(),prefixIcon: Icon(Icons.school),),value: _selectedSchoolId,items: _schools.map((school) {return DropdownMenuItem(value: school.id,child: Text(school.name, overflow: TextOverflow.ellipsis),);}).toList(),onChanged: (val) {setState(() {_selectedSchoolId = val;// [FIX 2]: Ganti _portionController.clear() menjadi _classStudentCountController.clear()_classStudentCountController.clear();if (val != null) {_loadQuotaDetails(val); // <-- Load Kuota Baru} else {_totalSchoolCapacity = 0;_allocatedCapacity = 0;}});},validator: (val) =>val == null ? "Wajib pilih sekolah" : null,),const SizedBox(height: 15),// INFO QUOTAif (_selectedSchoolId != null && _totalSchoolCapacity > 0)Card(color: Colors.blue[50],margin: const EdgeInsets.only(bottom: 15),child: Padding(padding: const EdgeInsets.all(12.0),child: Column(crossAxisAlignment: CrossAxisAlignment.start,children: [Text("Total Siswa Sekolah: $_totalSchoolCapacity",style: const TextStyle(fontWeight: FontWeight.bold),),Text("Sudah Dialokasikan: $_allocatedCapacity Siswa",style: const TextStyle(color: Colors.red),),Text("Quota Tersedia: $availableQuota Siswa",style: const TextStyle(color: Colors.green),),],),),),const SizedBox(height: 15),TextFormField(controller: _nameController,decoration: const InputDecoration(labelText: "Nama Guru / Penanggung Jawab",border: OutlineInputBorder(),prefixIcon: Icon(Icons.person),),validator: (v) => v!.isEmpty ? "Wajib diisi" : null,),const SizedBox(height: 15),TextFormField(controller: _classController,decoration: const InputDecoration(labelText: "Nama Kelas (Misal: 7A)",border: OutlineInputBorder(),prefixIcon: Icon(Icons.class_),),validator: (v) => v!.isEmpty ? "Wajib diisi" : null,),const SizedBox(height: 15),// [BARU] JUMLAH PENERIMA MANFAAT DI KELAS INITextFormField(controller: _classStudentCountController,keyboardType: TextInputType.number,decoration: InputDecoration(labelText: "Jml Penerima Kelas Ini",hintText: "Maksimal: $availableQuota",prefixIcon: const Icon(Icons.people),),validator: (v) {if (v!.isEmpty) return "Wajib diisi";final count = int.tryParse(v) ?? 0;if (count <= 0) return "Jumlah harus lebih dari 0";if (count > availableQuota)return "Melebihi kuota tersedia ($availableQuota)";return null;},),const SizedBox(height: 15),// [BARU] Field Nomor TeleponTextFormField(controller: _phoneController,keyboardType: TextInputType.phone,decoration: const InputDecoration(labelText: "Nomor Telepon",border: OutlineInputBorder(),prefixIcon: Icon(Icons.phone),),validator: (v) => v!.isEmpty ? "Wajib diisi" : null,),const SizedBox(height: 15),TextFormField(controller: _emailController,decoration: const InputDecoration(labelText: "Email Login",border: OutlineInputBorder(),prefixIcon: Icon(Icons.email),),keyboardType: TextInputType.emailAddress,validator: (v) => v!.isEmpty ? "Wajib diisi" : null,),const SizedBox(height: 15),TextFormField(controller: _passwordController,obscureText: true,decoration: const InputDecoration(labelText: "Password",border: OutlineInputBorder(),prefixIcon: Icon(Icons.lock),),validator: (v) => v!.length < 6 ? "Minimal 6 karakter" : null,),const SizedBox(height: 30),SizedBox(width: double.infinity,child: ElevatedButton(onPressed: _isSubmitting ? null : _submit,style: ElevatedButton.styleFrom(backgroundColor: Colors.orange[800],padding: const EdgeInsets.symmetric(vertical: 15),),child: _isSubmitting? const CircularProgressIndicator(color: Colors.white): const Text("BUAT AKUN WALI KELAS",style: TextStyle(color: Colors.white,fontWeight: FontWeight.bold,),),),),],),),),),);}}

=== FILE: lib/features/admin_sppg/screens/admin_request_list_screen.dart ===
import 'package:flutter/material.dart';import '../../shared/services/request_service.dart';class AdminRequestListScreen extends StatefulWidget {const AdminRequestListScreen({super.key});@overrideState<AdminRequestListScreen> createState() => _AdminRequestListScreenState();}class _AdminRequestListScreenState extends State<AdminRequestListScreen> {final RequestService _service = RequestService();void _showRespondDialog(ChangeRequestModel request) {final responseController = TextEditingController();showDialog(context: context,builder: (ctx) => AlertDialog(title: const Text("Respon Pengajuan"),content: TextField(controller: responseController,decoration: const InputDecoration(labelText: "Alasan / Catatan",border: OutlineInputBorder(),),),actions: [TextButton(onPressed: () async {// FIX 1: Provide all REQUIRED NAMED PARAMETERSawait _service.respondRequest(requestId: request.id,status: 'rejected',adminNote: responseController.text,requestData: request, // <--- CRITICAL: Pass the data object);if (!mounted) return;Navigator.pop(ctx);setState(() {});},child: const Text("TOLAK", style: TextStyle(color: Colors.red)),),ElevatedButton(onPressed: () async {// FIX 2: Provide all REQUIRED NAMED PARAMETERSawait _service.respondRequest(requestId: request.id,status: 'approved',adminNote: responseController.text,requestData: request, // <--- CRITICAL: Pass the data object);if (!mounted) return;Navigator.pop(ctx);setState(() {});},child: const Text("TERIMA"),),],),);}@overrideWidget build(BuildContext context) {return Scaffold(appBar: AppBar(title: const Text("Kotak Masuk Pengajuan"),backgroundColor: Colors.orange[800],foregroundColor: Colors.white,),body: FutureBuilder<List<ChangeRequestModel>>(future: _service.getIncomingRequests(),builder: (context, snapshot) {if (snapshot.connectionState == ConnectionState.waiting)return const Center(child: CircularProgressIndicator());final data = snapshot.data ?? [];if (data.isEmpty)return const Center(child: Text("Tidak ada pengajuan baru."));return ListView.builder(itemCount: data.length,itemBuilder: (ctx, i) {final item = data[i];return Card(margin: const EdgeInsets.all(8),child: ListTile(leading: const Icon(Icons.mail, color: Colors.orange),title: Text(item.schoolName),subtitle: Column(crossAxisAlignment: CrossAxisAlignment.start,children: [Text("[${item.type}] ${item.requestDate}",style: const TextStyle(fontWeight: FontWeight.bold),),Text(item.oldNotes),if (item.status != 'pending')Text("Status: ${item.status} (${item.adminResponse})",style: const TextStyle(color: Colors.grey),),],),trailing: item.status == 'pending'? ElevatedButton(onPressed: () => _showRespondDialog(item),child: const Text("Jawab"),): const Icon(Icons.check, color: Colors.green),),);},);},),);}}

=== FILE: lib/features/admin_sppg/screens/add_menu_screen.dart ===
import 'package:flutter/material.dart';import '../../../models/menu_model.dart';import '../services/menu_service.dart';class AddMenuScreen extends StatefulWidget {final Menu? menuToEdit; // Jika ini diisi, berarti mode Editconst AddMenuScreen({super.key, this.menuToEdit});@overrideState<AddMenuScreen> createState() => _AddMenuScreenState();}class _AddMenuScreenState extends State<AddMenuScreen> {final _formKey = GlobalKey<FormState>();final MenuService _menuService = MenuService();// Controllersfinal TextEditingController _durationController = TextEditingController(text: '0',);final TextEditingController _consumeMinutesController = TextEditingController(text: '120',);// [BARU KONTROLER GIZI]final TextEditingController _energyController = TextEditingController(text: '0',);final TextEditingController _proteinController = TextEditingController(text: '0.0',);final TextEditingController _fatController = TextEditingController(text: '0.0',);final TextEditingController _carbsController = TextEditingController(text: '0.0',);final TextEditingController _nameController = TextEditingController();// Daftar Kategori Tetap (Untuk Dropdown)// [FIX KRITIS] Harus mencakup semua nilai kategori yang mungkin ada di databasefinal List<String> _categories = ['Karbo', // Asumsi Nasi Putih / Spaghetti adalah Karbo'Lauk Protein','Lauk Nabati', // Dari data dump lo ada ini'Saus/Lauk', // Dari data dump lo ada ini'Sayur', // Dari data dump lo ada ini'Buah', // Dari data dump lo ada ini'Pelengkap', // Dari data dump lo ada ini];String? _selectedCategory;bool _isSubmitting = false;@overridevoid initState() {super.initState();if (widget.menuToEdit != null) {final s = widget.menuToEdit!;// Mode Edit: Isi form dengan data yang sudah ada_nameController.text = widget.menuToEdit!.name;_durationController.text = widget.menuToEdit!.cookingDurationMinutes.toString();// [BARU] Isi field Batas Konsumsi_consumeMinutesController.text = widget.menuToEdit!.maxConsumeMinutes.toString();_selectedCategory = widget.menuToEdit!.category;// [BARU GIZI]_energyController.text = s.energy.toString();_proteinController.text = s.protein.toString();_fatController.text = s.fat.toString();_carbsController.text = s.carbs.toString();}}@overridevoid dispose() {_nameController.dispose();_durationController.dispose();_consumeMinutesController.dispose();// [BARU GIZI]_energyController.dispose();_proteinController.dispose();_fatController.dispose();_carbsController.dispose();super.dispose();}Future<void> _submitForm() async {if (_formKey.currentState!.validate() && _selectedCategory != null) {setState(() => _isSubmitting = true);// Ambil nilai barufinal int duration = int.tryParse(_durationController.text) ?? 0;final int maxConsume =int.tryParse(_consumeMinutesController.text) ?? 120;// [BARU PARSING GIZI]final int energy = int.tryParse(_energyController.text) ?? 0;final double protein = double.tryParse(_proteinController.text) ?? 0.0;final double fat = double.tryParse(_fatController.text) ?? 0.0;final double carbs = double.tryParse(_carbsController.text) ?? 0.0;final Map<String, dynamic> menuData = {'name': _nameController.text,'category': _selectedCategory, 'cooking_duration_minutes': duration,'max_consume_minutes': maxConsume,// [BARU GIZI] Masukkan ke data'energy': energy,'protein': protein,'fat': fat,'carbs': carbs,};try {if (widget.menuToEdit == null) {// Mode Tambah (UC11)await _menuService.createMenu(menuData);} else {// Mode Edit (UC12)await _menuService.updateMenu(widget.menuToEdit!.id, menuData);}if (!mounted) return;ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Menu berhasil ${widget.menuToEdit == null ? 'ditambahkan' : 'diperbarui'}!",),backgroundColor: Colors.green,),);Navigator.pop(context, true); // Balik dan kirim sinyal sukses} catch (e) {ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Gagal: $e"), backgroundColor: Colors.red),);} finally {if (mounted) setState(() => _isSubmitting = false);}} else {if (_selectedCategory == null) {ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Kategori wajib dipilih!")),);}}}@overrideWidget build(BuildContext context) {return Scaffold(appBar: AppBar(title: Text(widget.menuToEdit == null ? "Tambah Menu Baru" : "Edit Menu",),backgroundColor: Colors.orange[800],foregroundColor: Colors.white,),body: Padding(padding: const EdgeInsets.all(16.0),child: Form(key: _formKey,child: Column(crossAxisAlignment: CrossAxisAlignment.start,children: [// Nama MakananTextFormField(controller: _nameController,decoration: const InputDecoration(labelText: "Nama Makanan",prefixIcon: Icon(Icons.food_bank),),validator: (v) => v!.isEmpty ? "Wajib diisi" : null,),const SizedBox(height: 15),// Dropdown KategoriDropdownButtonFormField<String>(decoration: const InputDecoration(labelText: "Kategori Menu",prefixIcon: Icon(Icons.category),),value: _selectedCategory,items: _categories.map((String value) {return DropdownMenuItem<String>(value: value,child: Text(value),);}).toList(),onChanged: (String? newValue) =>setState(() => _selectedCategory = newValue),validator: (v) => v == null ? "Pilih kategori" : null,),const SizedBox(height: 15),TextFormField(controller: _durationController,keyboardType: TextInputType.number,decoration: const InputDecoration(labelText: "Estimasi Durasi Masak (Menit)",hintText: "Contoh: 60",prefixIcon: Icon(Icons.timer),),validator: (v) => v!.isEmpty || int.tryParse(v) == null? "Wajib diisi angka": null,),const SizedBox(height: 15),// [BARU] Batas Waktu KonsumsiTextFormField(controller: _consumeMinutesController,keyboardType: TextInputType.number,decoration: const InputDecoration(labelText: "Batas Waktu Konsumsi (Menit)",hintText: "Contoh: 120",prefixIcon: Icon(Icons.hourglass_bottom),),validator: (v) => v!.isEmpty || (int.tryParse(v) ?? 0) < 30? "Minimal 30 menit": null,),const Divider(height: 30),const Text("Kandungan Gizi per Porsi",style: TextStyle(fontWeight: FontWeight.bold),),const SizedBox(height: 15),// Input EnergiTextFormField(controller: _energyController,keyboardType: TextInputType.number,decoration: const InputDecoration(labelText: "Energi (Kkal)",prefixIcon: Icon(Icons.flash_on),),validator: (v) => v!.isEmpty || int.tryParse(v) == null? "Wajib diisi angka": null,),const SizedBox(height: 15),// Input ProteinTextFormField(controller: _proteinController,keyboardType: const TextInputType.numberWithOptions(decimal: true,),decoration: const InputDecoration(labelText: "Protein (gram)",prefixIcon: Icon(Icons.fitness_center),),validator: (v) => v!.isEmpty ? "Wajib diisi" : null,),const SizedBox(height: 15),// Input LemakTextFormField(controller: _fatController,keyboardType: const TextInputType.numberWithOptions(decimal: true,),decoration: const InputDecoration(labelText: "Lemak (gram)",prefixIcon: Icon(Icons.local_pizza),),validator: (v) => v!.isEmpty ? "Wajib diisi" : null,),const SizedBox(height: 15),// Input KarbohidratTextFormField(controller: _carbsController,keyboardType: const TextInputType.numberWithOptions(decimal: true,),decoration: const InputDecoration(labelText: "Karbohidrat (gram)",prefixIcon: Icon(Icons.bakery_dining),),validator: (v) => v!.isEmpty ? "Wajib diisi" : null,),const SizedBox(height: 30),// Tombol SimpanSizedBox(width: double.infinity,child: ElevatedButton(onPressed: _isSubmitting ? null : _submitForm,style: ElevatedButton.styleFrom(backgroundColor: Colors.green[700],padding: const EdgeInsets.symmetric(vertical: 15),),child: _isSubmitting? const CircularProgressIndicator(color: Colors.white): Text(widget.menuToEdit == null? "SIMPAN MENU": "SIMPAN PERUBAHAN",style: const TextStyle(color: Colors.white,fontWeight: FontWeight.bold,),),),),],),),),);}}

=== FILE: lib/features/admin_sppg/screens/add_transport_screen.dart ===
import 'package:flutter/material.dart';import '../services/vehicle_service.dart';import '../services/courier_service.dart';import '../../../models/vehicle_model.dart';import '../../../models/courier_model.dart';// Import untuk Collection utilities (firstWhereOrNull)import 'package:collection/collection.dart';class AddTransportScreen extends StatefulWidget {final Vehicle? vehicleToEdit; // Data untuk dieditconst AddTransportScreen({super.key, this.vehicleToEdit});@overrideState<AddTransportScreen> createState() => _AddTransportScreenState();}class _AddTransportScreenState extends State<AddTransportScreen> {final _formKey = GlobalKey<FormState>();// ... (inside _AddTransportScreenState)final TextEditingController _plateController = TextEditingController();final TextEditingController _driverController = TextEditingController();final TextEditingController _capacityController = TextEditingController();List<CourierModel> _couriers = [];String? _selectedCourierId; // Main DriverString? _selectedAssistantId; // [BARU] Assistant Driver// [BARU] List ID Kurir yang Sudah Ditugaskan ke Mobil LainList<String> _assignedCourierIds = [];bool _isLoadingData = true;// ...// [FIX KRITIS]: Deklarasi Variabel isSubmittingbool _isSubmitting = false; // <--- TAMBAHKAN INI!@overridevoid initState() {super.initState();_loadInitialData();}Future<void> _loadInitialData() async {try {final courierService = CourierService();final results = await Future.wait([courierService.getMyCouriers(),VehicleService().getMyVehicles(),]);final fetchedCouriers = results[0] as List<CourierModel>;final allVehicles = results[1] as List<Vehicle>;// Tentukan ID Kurir yang sudah ditugaskan (Main atau Assistant)final currentVehicleId = widget.vehicleToEdit?.id;final Set<String> assignedIds = {};for (var v in allVehicles) {// Masukkan Main Driverif (v.courierProfileId != null && v.id != currentVehicleId) {assignedIds.add(v.courierProfileId!);}// Masukkan Assistant Driverif (v.assistantCourierId != null && v.id != currentVehicleId) {assignedIds.add(v.assistantCourierId!);}}setState(() {_couriers = fetchedCouriers;_assignedCourierIds = assignedIds.toList();_isLoadingData = false;if (widget.vehicleToEdit != null) {final s = widget.vehicleToEdit!;_plateController.text = s.plateNumber;_capacityController.text = s.capacityLimit.toString();// Inisialisasi Main Driver_selectedCourierId = s.courierProfileId;final assignedMain = fetchedCouriers.firstWhereOrNull((c) => c.id == s.courierProfileId,);_driverController.text = assignedMain?.name ?? s.driverName ?? '';// [BARU] Inisialisasi Assistant Driver_selectedAssistantId = s.assistantCourierId;} else {_driverController.text = '';}});} catch (e) {if (mounted) {ScaffoldMessenger.of(context,).showSnackBar(SnackBar(content: Text("Gagal memuat data kurir: $e")));}setState(() => _isLoadingData = false);}}Future<void> _submit() async {if (_formKey.currentState!.validate()) {// Validasi: Driver Utama dan Asisten tidak boleh samaif (_selectedCourierId != null &&_selectedCourierId == _selectedAssistantId) {if (!mounted) return;ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Kurir Utama dan Asisten tidak boleh sama!"),backgroundColor: Colors.red,),);return;}setState(() => _isSubmitting = true);// [PERBAIKAN KRITIS] Gunakan Nama Kurir yang dipilih sebagai Nama Supirfinal selectedCourier = _couriers.firstWhereOrNull((c) => c.id == _selectedCourierId,);final driverName = selectedCourier?.name ?? _driverController.text;final data = {'plate_number': _plateController.text,'driver_name': driverName, // <- Update nama supir'capacity_limit': int.parse(_capacityController.text),'is_active': true,'courier_profile_id': _selectedCourierId,'assistant_courier_id': _selectedAssistantId, // [BARU]};try {if (widget.vehicleToEdit == null) {await VehicleService().createVehicle(data);} else {await VehicleService().updateVehicle(widget.vehicleToEdit!.id, data);}if (!mounted) return;ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text(widget.vehicleToEdit == null? "Berhasil ditambah!": "Berhasil diperbarui!",),backgroundColor: Colors.green,),);Navigator.pop(context, true);} catch (e) {ScaffoldMessenger.of(context,).showSnackBar(SnackBar(content: Text("Error: $e")));} finally {if (mounted) setState(() => _isSubmitting = false);}}}// Helper untuk filter kurir: Kurir yang belum ditugaskan (di mobil lain)List<CourierModel> _filterAvailableCouriers(String? currentSelectedId) {return _couriers.where((c) {// 1. Kurir itu sendiri (selalu available)if (c.id == currentSelectedId) return true;// 2. Kurir yang sedang diedit (slot lain)if (widget.vehicleToEdit != null) {if (c.id == widget.vehicleToEdit!.courierProfileId) return true;if (c.id == widget.vehicleToEdit!.assistantCourierId) return true;}// 3. Kurir yang sudah ditugaskan ke mobil lain (slot manapun)if (_assignedCourierIds.contains(c.id)) return false;// 4. Cek Kurir yang sudah dipilih di slot lain di form ini (real-time check)if (_selectedCourierId != null && _selectedCourierId == c.id)return false;if (_selectedAssistantId != null && _selectedAssistantId == c.id)return false;return true;}).toList();}@overrideWidget build(BuildContext context) {// Filter kurir yang tersedia untuk Main Driver: kurir yang belum ditugaskan ke mobil lainfinal availableMainCouriers = _filterAvailableCouriers(_selectedCourierId);// Filter kurir yang tersedia untuk Assistant: kurir yang belum ditugaskan ke mobil lain ATAU Main Driverfinal availableAssistantCouriers = _filterAvailableCouriers(_selectedAssistantId,);final isEdit = widget.vehicleToEdit != null;// Filter Kurir yang Availablefinal availableCouriers = _couriers.where((c) {// Jika mode edit, kurir yang saat ini ditugaskan tetap tersediaif (isEdit && c.id == widget.vehicleToEdit!.courierProfileId) return true;// Jika kurir belum ditugaskan ke mobil lainreturn !_assignedCourierIds.contains(c.id);}).toList();return Scaffold(appBar: AppBar(title: Text(isEdit ? "Edit Transportasi" : "Tambah Transportasi"),backgroundColor: Colors.orange[800],foregroundColor: Colors.white,),body: _isLoadingData? const Center(child: CircularProgressIndicator()): Padding(padding: const EdgeInsets.all(16.0),child: Form(key: _formKey,child: Column(children: [TextFormField(controller: _plateController,decoration: const InputDecoration(labelText: "Plat Nomor",border: OutlineInputBorder(),),validator: (v) => v!.isEmpty ? "Wajib diisi" : null,),const SizedBox(height: 15),// [FIX] HIDE DRIVER NAME INPUT, IT SHOULD BE POPULATED BY COURIER SELECTION// Kita akan set `_driverController.text` berdasarkan kurir yang dipilih di `onChanged`// --- DROPDOWN 1: COURIER UTAMA ---// Menggunakan availableMainCouriersDropdownButtonFormField<String>(// ... (existing decoration) ...value: _selectedCourierId,items: [const DropdownMenuItem(value: null,child: Text('--- Tidak Ditugaskan ---',style: TextStyle(color: Colors.grey),),),...availableMainCouriers.map((courier) {// Menggunakan list yang sudah di-filterreturn DropdownMenuItem(value: courier.id,child: Text(courier.name,overflow: TextOverflow.ellipsis,),);}).toList(),],onChanged: (val) {setState(() {_selectedCourierId = val;if (val != null) {final selected = _couriers.firstWhereOrNull((c) => c.id == val,);_driverController.text = selected?.name ?? '';} else {_driverController.text = '';}});},validator: (val) => null, // Boleh null),const SizedBox(height: 15),// [TAMPILKAN SAJA] Driver Name (Non-Editable)TextFormField(controller: _driverController,decoration: const InputDecoration(labelText: "Nama Supir (Otomatis dari Kurir)",border: OutlineInputBorder(),),readOnly: true,style: const TextStyle(color: Colors.blueGrey),),const SizedBox(height: 15),// --- DROPDOWN 2: ASSISTANT COURIER [BARU] ---DropdownButtonFormField<String>(decoration: const InputDecoration(labelText: "Tugaskan Asisten Kurir (Opsional)",border: OutlineInputBorder(),),value: _selectedAssistantId,items: [const DropdownMenuItem(value: null,child: Text('--- Tidak Ditugaskan ---',style: TextStyle(color: Colors.grey),),),...availableAssistantCouriers.map((courier) {// Menggunakan list yang sudah di-filterreturn DropdownMenuItem(value: courier.id,child: Text(courier.name,overflow: TextOverflow.ellipsis,),);}).toList(),],onChanged: (val) {setState(() {_selectedAssistantId = val;});},validator: (val) => null,),const SizedBox(height: 15),TextFormField(controller: _capacityController,keyboardType: TextInputType.number,decoration: const InputDecoration(labelText: "Kapasitas Angkut (Box)",border: OutlineInputBorder(),),validator: (v) => v!.isEmpty ? "Wajib diisi" : null,),const SizedBox(height: 30),SizedBox(width: double.infinity,child: ElevatedButton(// Sekarang _isSubmitting sudah dideklarasikan dan bisa digunakanonPressed: _isSubmitting || _isLoadingData? null: _submit,style: ElevatedButton.styleFrom(backgroundColor: Colors.orange[800],padding: const EdgeInsets.symmetric(vertical: 15),),child: _isSubmitting? const CircularProgressIndicator(color: Colors.white,): Text(widget.vehicleToEdit == null? "SIMPAN": "SIMPAN PERUBAHAN",style: const TextStyle(color: Colors.white,fontWeight: FontWeight.bold,),),),),],),),),);}}

=== FILE: lib/features/admin_sppg/screens/statistics_screen.dart ===
// === FILE: lib/features/admin_sppg/screens/statistics_screen.dart ===import 'package:fl_chart/fl_chart.dart'; // Import Library Grafikimport 'package:flutter/material.dart';import 'package:intl/intl.dart';import 'dart:convert'; // Untuk mengurai JSON Issue Detailsimport '../../../models/courier_model.dart';// [FIX 1]: Import Model DeliveryRoute yang hilangimport '../../../models/route_model.dart';import '../services/stats_service.dart';// BARU: Import service report yang baru kita buatimport '../services/stats_service.dart';import '../services/report_service.dart';import '../services/complaint_service.dart'; // <--- PASTIKAN INI ADAimport '../services/coordinator_service.dart';import '../services/teacher_service.dart';import '../../../models/vehicle_model.dart'; // Import Vehicle Modelimport '../services/vehicle_service.dart'; // Import Vehicle Serviceimport 'edit_route_screen.dart'; // Import EditRouteScreenimport 'edit_account_screen.dart'; // <--- DITAMBAH: Fix Errorimport '../services/school_service.dart';import '../services/vehicle_service.dart';import '../services/courier_service.dart';import '../services/route_service.dart';// Tambahkan import collection untuk mapIndexedimport 'package:collection/collection.dart';import '../../../models/school_model.dart'; // <--- PASTIKAN INI ADAimport '../../admin_sppg/services/school_service.dart'; // <--- PASTIKAN INI ADAclass StatisticsScreen extends StatefulWidget {const StatisticsScreen({super.key});@overrideState<StatisticsScreen> createState() => _StatisticsScreenState();}class _StatisticsScreenState extends State<StatisticsScreen>with SingleTickerProviderStateMixin {// ===================================// 1. FIX: DEKLARASI MISSING FIELDS// ===================================late TabController _tabController;final StatsService _statsService = StatsService();final AdminReportService _reportService = AdminReportService();final VehicleService _vehicleService = VehicleService();final ComplaintService _complaintService = ComplaintService();// [NEWLY ADDED] School Service (untuk filter sekolah)final SchoolService _schoolService = SchoolService();final CourierService _courierService = CourierService();final CoordinatorService _coordinatorService = CoordinatorService();final TeacherService _teacherService = TeacherService();final RouteService _routeService = RouteService();Key _complaintKey = UniqueKey();Map<String, int>? _stats;bool _isLoading = true;DateTime _selectedRouteDate = DateTime.now();String? _selectedVehicleId;List<Vehicle> _allVehicles = [];// FIX SCOPE: Tambahkan Field yang Hilang/Tidak TerdefinisiString? _selectedSchoolFilterId; // <--- DITAMBAHList<School> _allSchools = []; // <--- DITAMBAH@overridevoid initState() {super.initState();_tabController = TabController(length: 4, vsync: this);_loadInitialData();}Future<void> _loadInitialData() async {// FIX: Tambahkan load schools di sinifinal results = await Future.wait([_loadStats(),_loadVehicles(),_loadSchools(), // <--- NEW CALL]);_refreshAllTabs();}// FIX: Tambahkan method load schoolsFuture<void> _loadSchools() async {try {final data = await _schoolService.getMySchools();if (mounted) {setState(() {_allSchools = data;});}} catch (e) {print("Error loading schools for filter: $e");}}Future<void> _loadStats() async {setState(() => _isLoading = true);try {final data = await _statsService.getDeliveryStats();if (mounted) {setState(() {_stats = data;_isLoading = false;});}} catch (e) {if (mounted) {setState(() => _isLoading = false);}}}Future<void> _loadVehicles() async {try {final data = await _vehicleService.getMyVehicles();if (mounted) {setState(() {_allVehicles = data;_selectedVehicleId = 'all';});}} catch (e) {print("Error loading vehicles: $e");}}void _refreshAllTabs() {_loadStats();setState(() {_complaintKey = UniqueKey();});}// Helper untuk memformat waktuString _formatTime(String? timeStr) {if (timeStr == null || timeStr.isEmpty) return "--:--";try {return timeStr.substring(0, 5);} catch (_) {return timeStr;}}// Helper untuk mendapatkan warna statusColor _getStatusColor(String status) {switch (status) {case 'received':return Colors.green;case 'issue_reported':return Colors.red;case 'completed':return Colors.orange;case 'active':return Colors.blue;default:return Colors.grey;}}// [BARU HELPER] Mengurai JSON Issue Details dari Koordinator/Wali Kelas (Dipindahkan ke sini agar dapat diakses oleh widget lokal)String _formatComplaintDetails(String reporterRole, String rawNotes) {if (rawNotes.isEmpty) return 'Tidak ada detail spesifik.';// Kasus 1: Laporan Koordinator (Diharapkan format JSON Array dari issue_details)if (reporterRole == 'koordinator') {try {String cleanedNotes = rawNotes.trim();// [FIX KRITIS JSON STRING]: Hapus quotes ganda di awal/akhirif (cleanedNotes.startsWith('"') && cleanedNotes.endsWith('"')) {cleanedNotes = cleanedNotes.substring(1, cleanedNotes.length - 1);}// Hapus escape character '\' yang mungkin tersisacleanedNotes = cleanedNotes.replaceAll(r'\"', '"');final List<dynamic> issues = jsonDecode(cleanedNotes);if (issues.isEmpty) return 'Diterima, tetapi detail masalah kosong.';return issues.mapIndexed((index, issue) {final type = issue['type'] ?? 'Masalah Umum';final notes = issue['notes']?.trim() ?? '—';final qty = issue['qty_impacted'];String qtyStr = '';if (type == 'Jumlah Tidak Sesuai') {qtyStr = ' (Defisit: ${qty} Porsi)';} else if (type == 'Kemasan Rusak') {qtyStr = ' (Rusak: ${qty} Kotak)';} else if (type == 'Terlambat') {qtyStr = ' (Telat: ${qty} Menit)';}return '${index + 1}. [${type}]${qtyStr}. Detail: "${notes}"';}).join('\n');} catch (e) {// Jika decoding JSON masih gagalreturn 'Detail Masalah JSON Rusak. Raw Data: $rawNotes';}}// Kasus 2: Laporan Wali Kelas (Masih menggunakan format notes lama/tunggal)else {return rawNotes;}}// [BARU HELPER] Fungsi untuk menampilkan dialog detail rutevoid _showRouteDetailDialog(Map<String, dynamic> route) {final List<dynamic> stops = route['delivery_stops'] ?? [];final List<dynamic> menuItems = route['route_menus'] ?? [];// Hitung ringkasan status stopsfinal int totalStops = stops.length;final int issues = stops.where((s) => s['status'] == 'issue_reported').length;final int received = stops.where((s) => s['status'] == 'received').length;final int completedCourier = stops.where((s) => s['status'] == 'completed').length;final int pending = totalStops - issues - received - completedCourier;showDialog(context: context,builder: (ctx) => AlertDialog(title: Text("Detail Rute: ${route['vehicles']['plate_number']}"),content: SizedBox(width: MediaQuery.of(context).size.width * 0.9,child: SingleChildScrollView(child: Column(crossAxisAlignment: CrossAxisAlignment.start,mainAxisSize: MainAxisSize.min,children: [// Info Umum_buildInfoRow(Icons.calendar_today,"Tanggal",DateFormat('EEEE, d MMMM yyyy','id_ID',).format(DateTime.parse(route['date'])),),_buildInfoRow(Icons.departure_board,"Jam Berangkat",_formatTime(route['departure_time']),),_buildInfoRow(Icons.person,"Kurir",route['profiles!courier_id']?['full_name'] ?? 'N/A',),const Divider(height: 20),// Ringkasan Status Stopsconst Text("Status Perhentian",style: TextStyle(fontWeight: FontWeight.bold,color: Colors.indigo,),),const SizedBox(height: 8),_buildInfoRow(Icons.check_circle,"Diterima Koord","$received Stop",color: Colors.green,),_buildInfoRow(Icons.warning,"Ada Keluhan","$issues Stop",color: Colors.red,),_buildInfoRow(Icons.timer,"Selesai Kurir (Menunggu Konf.)","$completedCourier Stop",color: Colors.orange,),_buildInfoRow(Icons.pending_actions,"Pending/Active","$pending Stop",color: Colors.grey,),_buildInfoRow(Icons.route,"Total Perhentian","$totalStops Stop",),const Divider(height: 20),// Daftar Menuconst Text("Menu yang Dibawa",style: TextStyle(fontWeight: FontWeight.bold,color: Colors.indigo,),),const SizedBox(height: 8),...menuItems.map((menuRoute) {return Padding(padding: const EdgeInsets.symmetric(vertical: 2.0),child: Text("• ${menuRoute['menus']['name']}",style: TextStyle(fontSize: 13),),);}).toList(),const Divider(height: 20),// Daftar Stops Detailconst Text("Urutan Stops",style: TextStyle(fontWeight: FontWeight.bold,color: Colors.indigo,),),const SizedBox(height: 8),...stops.map((stop) {final schoolName = stop['schools']['name'];final status = stop['status'];final eta = _formatTime(stop['estimated_arrival_time']);final actualTime = stop['arrival_time'] != null? _formatTime(stop['arrival_time']): '--:--';return Padding(padding: const EdgeInsets.only(bottom: 4.0),child: Row(crossAxisAlignment: CrossAxisAlignment.start,children: [Text("${stop['sequence_order']}. ",style: TextStyle(fontWeight: FontWeight.bold),),Expanded(child: Column(crossAxisAlignment: CrossAxisAlignment.start,children: [Text(schoolName,style: TextStyle(fontWeight: FontWeight.w500),),Text("Status: ${status.toUpperCase()} | ETA: $eta | Tiba: $actualTime",style: TextStyle(fontSize: 11,color: _getStatusColor(status),),),],),),],),);}).toList(),],),),),actions: [TextButton(onPressed: () => Navigator.pop(ctx),child: const Text("TUTUP"),),ElevatedButton.icon(onPressed: () {Navigator.pop(ctx);Navigator.push(context,MaterialPageRoute(builder: (_) =>EditRouteScreen(route: DeliveryRoute.fromJson(route)),),);},icon: const Icon(Icons.edit, size: 18),label: const Text("DETAIL DI MAP"),),],),);}// Helper untuk info row (diperlukan di dalam dialog)Widget _buildInfoRow(IconData icon,String title,String value, {Color color = Colors.black87,}) {return Padding(padding: const EdgeInsets.symmetric(vertical: 4.0),child: Row(children: [Icon(icon, size: 18, color: const Color.fromARGB(255, 189, 0, 0)),const SizedBox(width: 8),Text("$title: ", style: const TextStyle(fontWeight: FontWeight.w500)),Expanded(child: Text(value, style: TextStyle(color: color)),),],),);}// [NEW HELPER] Helper untuk menampilkan dialog zoom gambarvoid _showImageDialog(BuildContext context, String url, String title) {showDialog(context: context,builder: (ctx) => AlertDialog(title: Text(title),content: SizedBox(width: MediaQuery.of(context).size.width * 0.9,height: MediaQuery.of(context).size.height * 0.7,child: Image.network(url, fit: BoxFit.contain),),actions: [TextButton(onPressed: () => Navigator.pop(ctx),child: const Text("Tutup"),),],),);}// ===================================// 2. FIX: IMPLEMENTASI MISSING HELPER METHODS// ===================================// FIX MISSING METHOD: _showHistoryDetailDialog (diperlukan di Tab 4)void _showHistoryDetailDialog(Map<String, dynamic> complaint) {final photoUrl = complaint['proof_photo_url']; // Ambil URL Fotofinal reporterRole = complaint['reporter_role'];final complaintDetails = _formatComplaintDetails(reporterRole,complaint['notes'],);showDialog(context: context,builder: (ctx) => AlertDialog(title: Text("Riwayat Tindak Lanjut: ${complaint['school_name']}"),content: SingleChildScrollView(child: Column(crossAxisAlignment: CrossAxisAlignment.start,mainAxisSize: MainAxisSize.min,children: [_buildInfoRow(Icons.person,"Pelapor","${complaint['reporter_name']} (${reporterRole.toUpperCase()})",),_buildInfoRow(Icons.check_circle,"Status","SUDAH DITANGANI",color: Colors.green,),const Divider(),const Text("Rincian Keluhan:",style: TextStyle(fontWeight: FontWeight.bold,color: Colors.red,),),const SizedBox(height: 5),Container(padding: const EdgeInsets.all(8),width: double.infinity,decoration: BoxDecoration(color: Colors.red[100],borderRadius: BorderRadius.circular(5),),child: Text(complaintDetails,style: TextStyle(fontSize: 13, color: Colors.red[900]),),),// [NEW SECTION] Foto Bukti Pengaduanif (photoUrl != null && photoUrl.isNotEmpty) ...[const SizedBox(height: 15),const Text("Bukti Foto Pelapor:",style: TextStyle(fontWeight: FontWeight.bold),),const SizedBox(height: 8),GestureDetector(onTap: () => _showImageDialog(context,photoUrl,"Bukti dari ${complaint['reporter_name']}",),child: Container(height: 100,width: 100,decoration: BoxDecoration(borderRadius: BorderRadius.circular(5),image: DecorationImage(image: NetworkImage(photoUrl),fit: BoxFit.cover,),border: Border.all(color: Colors.grey),),child: const Icon(Icons.zoom_in, color: Colors.white70),),),],const SizedBox(height: 15),const Text("Respon Admin:",style: TextStyle(fontWeight: FontWeight.bold,color: Colors.green,),),Text(complaint['admin_response'] ?? 'N/A'),],),),actions: [TextButton(onPressed: () => Navigator.pop(ctx),child: const Text("Tutup"),),],),);}// FIX MISSING METHOD: _showRespondDialog (diperlukan di Tab 4)void _showRespondDialog(Map<String, dynamic> complaint,String targetTable,String targetTableId,) {final responseController = TextEditingController();final photoUrl =complaint['proof_photo_url']; // Ambil URL Foto untuk ditampilkan di dialog responfinal complaintDetails = _formatComplaintDetails(complaint['reporter_role'],complaint['notes'],);showDialog(context: context,builder: (ctx) => AlertDialog(title: const Text("Tindak Lanjut Keluhan"),content: SingleChildScrollView(// Tambahkan SingleChildScrollViewchild: Column(mainAxisSize: MainAxisSize.min,crossAxisAlignment: CrossAxisAlignment.start,children: [// Detail Keluhan (seperti di showHistoryDetailDialog)const Text("Rincian Keluhan:",style: TextStyle(fontWeight: FontWeight.bold,color: Colors.red,),),const SizedBox(height: 5),Container(padding: const EdgeInsets.all(8),width: double.infinity,decoration: BoxDecoration(color: Colors.red[100],borderRadius: BorderRadius.circular(5),),child: Text(complaintDetails,style: TextStyle(fontSize: 13, color: Colors.red[900]),),),// [NEW SECTION] Foto Bukti Pengaduan di Dialog Responif (photoUrl != null && photoUrl.isNotEmpty) ...[const SizedBox(height: 15),const Text("Bukti Foto Pelapor:",style: TextStyle(fontWeight: FontWeight.bold),),const SizedBox(height: 8),GestureDetector(onTap: () => _showImageDialog(context,photoUrl,"Bukti dari ${complaint['reporter_name']}",),child: Container(height: 100,width: 100,decoration: BoxDecoration(borderRadius: BorderRadius.circular(5),image: DecorationImage(image: NetworkImage(photoUrl),fit: BoxFit.cover,),border: Border.all(color: Colors.grey),),child: const Icon(Icons.zoom_in, color: Colors.white70),),),],const SizedBox(height: 20),// Input Respon Adminconst Text("Respon Admin:",style: TextStyle(fontWeight: FontWeight.bold),),TextField(controller: responseController,maxLines: 4,keyboardType: TextInputType.multiline,decoration: InputDecoration(labelText: "Instruksi / Tindak Lanjut Admin SPPG",hintText: "Contoh: Sudah kami cek...",border: const OutlineInputBorder(),),),],),),actions: [TextButton(onPressed: () => Navigator.pop(ctx),child: const Text("BATAL"),),ElevatedButton(onPressed: () async {if (responseController.text.isEmpty) {if (!mounted) return;ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Wajib isi instruksi!")),);return;}Navigator.pop(ctx);// Logic submit response (tetap sama)String finalReporterUserId;try {finalReporterUserId = await _complaintService.getReporterIdForNotification(targetTableId,complaint['reporter_role'],);} catch (e) {if (mounted)ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Gagal tentukan penerima notifikasi: $e"),backgroundColor: Colors.red,),);return;}await _complaintService.respondToComplaint(id: complaint['id'],response: responseController.text,reporterId: finalReporterUserId,reporterRole: complaint['reporter_role'],targetTableId: targetTableId,targetTableName: targetTable,);_refreshAllTabs();if (mounted) {ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Tindak Lanjut & Notifikasi Terkirim!"),backgroundColor: Colors.green,),);}},child: const Text("KIRIM INSTRUKSI"),),],),);}@overrideWidget build(BuildContext context) {return Scaffold(appBar: AppBar(title: const Text("Laporan"),backgroundColor: Colors.orange[800],foregroundColor: Colors.white,actions: [IconButton(icon: const Icon(Icons.refresh),onPressed: _refreshAllTabs,),],bottom: TabBar(controller: _tabController,indicatorColor: Colors.white,labelColor: Colors.white,unselectedLabelColor: Colors.white70,isScrollable: true,tabs: const [Tab(text: "1. Pengiriman"), // Ganti nama tabTab(text: "2. Rute & Detail"),Tab(text: "3. Anggota"),Tab(text: "4. Keluhan"),],),),body: TabBarView(controller: _tabController,children: [_buildGlobalStatsTab(),_buildRoutesDetailTab(),_buildPersonnelTab(),_buildComplaintsTab(),],),);}// [REWRITE] TAB 1: Pengiriman (Mengganti Pie Chart dengan List Interaktif)Widget _buildGlobalStatsTab() {if (_isLoading) return const Center(child: CircularProgressIndicator());if (_stats == null)return const Center(child: Text("Gagal memuat data statistik."));// List Item Dropdown Mobilfinal List<DropdownMenuItem<String?>> vehicleItems = [const DropdownMenuItem(value: 'all', child: Text("Semua Mobil")),..._allVehicles.map((vehicle) => DropdownMenuItem(value: vehicle.id,child: Text(vehicle.plateNumber),),),];// Filter dan List Route yang akan ditampilkan di Tab 1 (Semua Route dengan filter tanggal/mobil)return Column(children: [// FILTER Section (Sama dengan Tab 2)Padding(padding: const EdgeInsets.all(8.0),child: Row(children: [// Filter TanggalExpanded(child: ListTile(leading: const Icon(Icons.calendar_today, color: Colors.grey),title: Text(DateFormat('d MMMM yyyy','id_ID',).format(_selectedRouteDate),),onTap: () async {final DateTime? picked = await showDatePicker(context: context,initialDate: _selectedRouteDate,firstDate: DateTime(2024),lastDate: DateTime(2030),);if (picked != null && picked != _selectedRouteDate) {setState(() {_selectedRouteDate = picked;});}},),),// Filter MobilExpanded(child: DropdownButtonFormField<String?>(value: _selectedVehicleId,decoration: const InputDecoration(labelText: "Filter Mobil"),items: vehicleItems,onChanged: (String? newValue) {setState(() {_selectedVehicleId = newValue;});},),),],),),// Ringkasan StatusPadding(padding: const EdgeInsets.symmetric(horizontal: 16.0, vertical: 8.0),child: Row(mainAxisAlignment: MainAxisAlignment.spaceAround,children: [_buildStatChip("TOTAL", _stats!['total']!, Colors.indigo),_buildStatChip("SUKSES", _stats!['received']!, Colors.green),_buildStatChip("MASALAH", _stats!['issues']!, Colors.red),],),),const Divider(),// Daftar Semua Rute (Interaktif)Expanded(child: FutureBuilder<List<Map<String, dynamic>>>(future: _reportService.getDetailedRoutes(date: _selectedRouteDate,vehicleId: _selectedVehicleId,),builder: (context, snapshot) {if (snapshot.connectionState == ConnectionState.waiting)return const Center(child: CircularProgressIndicator());final routes = snapshot.data ?? [];if (routes.isEmpty)return const Center(child: Text("Tidak ada aktivitas pengiriman."),);return ListView.builder(itemCount: routes.length,itemBuilder: (ctx, i) {final route = routes[i];final courierName =route['courier_data']?['full_name'] ?? 'Kurir N/A';final status = route['status'];final formattedDate = DateFormat('dd MMM yy',).format(DateTime.parse(route['date']));// [FIX MINOR WARNA CARD]: Jika pending/active, gunakan grey/putih. Jika final, gunakan warna status.Color cardColor;if (status == 'received') {cardColor = Colors.green[50]!;} else if (status == 'issue_reported') {cardColor = Colors.red[50]!;} else {// pending, active, completed (semua ini adalah rute ongoing/history biasa)cardColor = Colors.grey[100]!;}return Card(color: cardColor, // <-- Menggunakan cardColor barumargin: const EdgeInsets.symmetric(horizontal: 10,vertical: 6,),child: ListTile(onTap: () => _showRouteDetailDialog(route),leading: Icon(Icons.local_shipping,color: _getStatusColor(status),),title: Text("$formattedDate - ${route['vehicles']['plate_number']}",style: const TextStyle(fontWeight: FontWeight.bold),),subtitle: Text("Kurir: $courierName | Status: ${status.toUpperCase()}",),trailing: const Icon(Icons.info_outline, size: 16),),);},);},),),],);}Widget _buildStatChip(String title, int value, Color color) {return Column(children: [Text(title, style: TextStyle(fontSize: 12, color: Colors.grey[700])),const SizedBox(height: 4),Text('$value',style: TextStyle(fontSize: 20,fontWeight: FontWeight.bold,color: color,),),],);}// TAB 2: RUTE & DETAIL (Diperbarui untuk menggunakan filter)Widget _buildRoutesDetailTab() {// List Item Dropdown Mobilfinal List<DropdownMenuItem<String?>> vehicleItems = [const DropdownMenuItem(value: 'all', child: Text("Semua Mobil")),..._allVehicles.map((vehicle) => DropdownMenuItem(value: vehicle.id,child: Text(vehicle.plateNumber),),),];return Column(children: [// FILTER Section (Sama dengan Tab 1)Padding(padding: const EdgeInsets.all(8.0),child: Row(children: [// Filter TanggalExpanded(child: ListTile(leading: const Icon(Icons.calendar_today,color: Colors.indigo,),title: Text(DateFormat('d MMMM yyyy','id_ID',).format(_selectedRouteDate),),onTap: () async {final DateTime? picked = await showDatePicker(context: context,initialDate: _selectedRouteDate,firstDate: DateTime(2024),lastDate: DateTime(2030),);if (picked != null && picked != _selectedRouteDate) {setState(() {_selectedRouteDate = picked;});}},),),// Filter MobilExpanded(child: DropdownButtonFormField<String?>(value: _selectedVehicleId,decoration: const InputDecoration(labelText: "Filter Mobil"),items: vehicleItems,onChanged: (String? newValue) {setState(() {_selectedVehicleId = newValue;});},),),],),),// LIST RUTE HASIL FILTERExpanded(child: FutureBuilder<List<Map<String, dynamic>>>(// Panggil service dengan filter yang barufuture: _reportService.getDetailedRoutes(date: _selectedRouteDate,vehicleId: _selectedVehicleId,),builder: (context, snapshot) {if (snapshot.connectionState == ConnectionState.waiting)return const Center(child: CircularProgressIndicator());final routes = snapshot.data ?? [];if (routes.isEmpty)return const Center(child: Text("Tidak ada rute yang cocok dengan filter."),);return ListView.builder(itemCount: routes.length,itemBuilder: (ctx, i) {final route = routes[i];// [FIX AKSES DATA KURIR DARI ALIAS BARU]final courierName =route['courier_data']?['full_name'] ?? 'Kurir N/A';final status = route['status'];final isOngoing = status == 'active' || status == 'pending';final formattedDate = DateFormat('dd MMM yy',).format(DateTime.parse(route['date']));return Card(color: isOngoing ? Colors.blue[50] : Colors.grey[100],margin: const EdgeInsets.symmetric(horizontal: 10,vertical: 6,),child: ListTile(onTap: () {Navigator.push(context,MaterialPageRoute(builder: (_) => EditRouteScreen(route: DeliveryRoute.fromJson(route,), // Pass Map ke Model),),);},leading: Icon(isOngoing ? Icons.directions_run : Icons.local_shipping,color: isOngoing ? Colors.blue : Colors.grey,),title: Text("[${isOngoing ? 'ONGOING' : 'HISTORY'}] $formattedDate - ${route['vehicles']['plate_number']}",style: const TextStyle(fontWeight: FontWeight.bold),),subtitle: Text("Kurir: $courierName | Status: ${status.toUpperCase()}", // <-- GUNAKAN ALIAS BARU),trailing: const Icon(Icons.arrow_forward_ios, size: 16),// ...),);},);},),),],);}// [BARU HELPER] DARI DashboardAdminScreenWidget _buildEmptyState(String text, IconData icon) {return Center(child: Column(mainAxisAlignment: MainAxisAlignment.center,children: [Icon(icon, size: 70, color: Colors.grey[300]),const SizedBox(height: 10),Text(text, style: TextStyle(fontSize: 16, color: Colors.grey[600])),],),);}// [BARU HELPER] DARI DashboardAdminScreenint _sortClasses(String? a, String? b) {if (a == null || b == null) return 0;final exp = RegExp(r'^(\d+)([a-zA-Z]*)');final matchA = exp.firstMatch(a.toUpperCase());final matchB = exp.firstMatch(b.toUpperCase());if (matchA == null || matchB == null) return a.compareTo(b);final numA = int.tryParse(matchA.group(1)!) ?? 0;final numB = int.tryParse(matchB.group(1)!) ?? 0;final charA = matchA.group(2) ?? '';final charB = matchB.group(2) ?? '';if (numA != numB) return numA.compareTo(numB);return charA.compareTo(charB);}// [REMAKE TOTAL] TAB 3: ANGGOTA - KITA PAKAI FUNGSI MIRIP DENGAN ADMIN DASHBOARDWidget _buildPersonnelTab() {// Kita bagi per section agar datanya terjamin dari service masing-masing.return ListView(padding: const EdgeInsets.all(16.0),children: [// ------------------------------------// SECTION 1: KURIR// ------------------------------------Text("KURIR",style: TextStyle(fontSize: 20,fontWeight: FontWeight.bold,color: Colors.orange[800],),),const Divider(thickness: 2),_buildCourierSection(),const SizedBox(height: 30),// ------------------------------------// SECTION 2: KOORDINATOR// ------------------------------------Text("KOORDINATOR",style: TextStyle(fontSize: 20,fontWeight: FontWeight.bold,color: Colors.orange[800],),),const Divider(thickness: 2),_buildCoordinatorSection(),const SizedBox(height: 30),// ------------------------------------// SECTION 3: WALI KELAS// ------------------------------------Text("WALI KELAS",style: TextStyle(fontSize: 20,fontWeight: FontWeight.bold,color: Colors.orange[800],),),const Divider(thickness: 2),_buildTeacherSection(),],);}// ===========================================// HELPER SECTION FOR REMADE TAB 3// ===========================================Widget _buildCourierSection() {return FutureBuilder<List<CourierModel>>(future: _courierService.getMyCouriers(),builder: (context, snapshot) {if (snapshot.connectionState == ConnectionState.waiting)return const Center(child: CircularProgressIndicator());final couriers = snapshot.data ?? [];if (couriers.isEmpty)return _buildEmptyState("Belum ada akun kurir.",Icons.person_off_outlined,);return Column(children: couriers.map((courier) {return Card(margin: const EdgeInsets.only(bottom: 8),child: ListTile(leading: const Icon(Icons.local_shipping,color: Colors.blueGrey,),title: Text(courier.name,style: const TextStyle(fontWeight: FontWeight.bold),),subtitle: Text("${courier.email}\nTelp: ${courier.phoneNumber ?? '-'}",style: const TextStyle(fontSize: 12),),isThreeLine: true,trailing: IconButton(icon: const Icon(Icons.info_outline, color: Colors.grey),onPressed: () => _navigateToEditAccount(courier.id, 'kurir', {'name': courier.name,'email': courier.email,'schoolId': null,'className': null,'phoneNumber': courier.phoneNumber,}),),),);}).toList(),);},);}Widget _buildCoordinatorSection() {// Koordinator Service sudah mengembalikan CoordinatorModel yang mencakup schoolName.return FutureBuilder<List<CoordinatorModel>>(future: _coordinatorService.getMyCoordinators(),builder: (context, snapshot) {if (snapshot.connectionState == ConnectionState.waiting)return const Center(child: CircularProgressIndicator());final coordinators = snapshot.data ?? [];if (coordinators.isEmpty)return _buildEmptyState("Belum ada akun koordinator.",Icons.supervised_user_circle,);// Sorting: Sort berdasarkan Nama Sekolah (Ascending)coordinators.sort((a, b) =>a.schoolName.toLowerCase().compareTo(b.schoolName.toLowerCase()),);return Column(children: coordinators.map((coord) {return Card(margin: const EdgeInsets.only(bottom: 8),child: ListTile(leading: const Icon(Icons.supervised_user_circle,color: Colors.teal,),title: Text(coord.name,style: const TextStyle(fontWeight: FontWeight.bold),),subtitle: Text("Sekolah: ${coord.schoolName}\n${coord.email}\nTelp: ${coord.phoneNumber ?? '-'}",style: const TextStyle(fontSize: 12),),isThreeLine: true,trailing: IconButton(icon: const Icon(Icons.info_outline, color: Colors.grey),onPressed: () =>_navigateToEditAccount(coord.id, 'koordinator', {'name': coord.name,'email': coord.email,'schoolId': coord.schoolId,'className': null,'phoneNumber': coord.phoneNumber,'schoolName': coord.schoolName,}),),),);}).toList(),);},);}Widget _buildTeacherSection() {return FutureBuilder<List<TeacherModel>>(future: _teacherService.getMyTeachers(),builder: (context, snapshot) {if (snapshot.connectionState == ConnectionState.waiting)return const Center(child: CircularProgressIndicator());final teachers = snapshot.data ?? [];if (teachers.isEmpty)return _buildEmptyState("Belum ada akun wali kelas.", Icons.class_);// Sorting: Sort by School Name then Class Nameteachers.sort((a, b) {final schoolCompare = a.schoolName.toLowerCase().compareTo(b.schoolName.toLowerCase(),);if (schoolCompare != 0) return schoolCompare;return _sortClasses(a.className, b.className);});return Column(children: teachers.map((teacher) {return Card(margin: const EdgeInsets.only(bottom: 8),child: ListTile(leading: const Icon(Icons.class_, color: Colors.indigo),title: Text(teacher.name,style: const TextStyle(fontWeight: FontWeight.bold),),subtitle: Text("Kelas ${teacher.className} (${teacher.studentCountClass} Siswa) @ ${teacher.schoolName}\n${teacher.email}\nTelp: ${teacher.phoneNumber ?? '-'}",style: const TextStyle(fontSize: 12),),isThreeLine: true,trailing: IconButton(icon: const Icon(Icons.info_outline, color: Colors.grey),onPressed: () =>_navigateToEditAccount(teacher.id, 'walikelas', {'name': teacher.name,'email': teacher.email,'schoolId': teacher.schoolId,'className': teacher.className,'phoneNumber': teacher.phoneNumber,'schoolName': teacher.schoolName,'studentCountClass': teacher.studentCountClass,}),),),);}).toList(),);},);}// Navigation Helpervoid _navigateToEditAccount(String userId,String role,Map<String, dynamic> data,) {Navigator.push(context,MaterialPageRoute(builder: (_) => EditAccountScreen(userId: userId,initialRole: role,initialData: data,),),);}// [REMAKE TOTAL] TAB 4: KELUHAN MASUK (Enhanced View + Filter)Widget _buildComplaintsTab() {if (_isLoading) return const Center(child: CircularProgressIndicator());if (_stats == null)return const Center(child: Text("Gagal memuat data statistik global."));// [BARU]: Ambil data complaints tanpa filter untuk menghitung metrik resolusireturn FutureBuilder<List<Map<String, dynamic>>>(future: _complaintService.getSppgComplaints(),builder: (context, snapshot) {if (snapshot.connectionState == ConnectionState.waiting) {return const Center(child: CircularProgressIndicator());}if (snapshot.hasError) {return Center(child: Text("Error List Keluhan: ${snapshot.error}"));}final allComplaints = snapshot.data ?? [];// Hitung Metrik Resolusifinal resolvedCount = allComplaints.where((item) => item['admin_response'] != null).length;final totalComplaints = allComplaints.length;final pendingCount = totalComplaints - resolvedCount;final resolutionPercentage = totalComplaints > 0? (resolvedCount / totalComplaints): 0.0;// Buat Pie Chart Resolusifinal pieChartDataResolution = PieChartData(sectionsSpace: 2,centerSpaceRadius: 50,sections: [PieChartSectionData(color: Colors.green,value: resolvedCount.toDouble(),title: '${resolvedCount}',radius: 60,titleStyle: const TextStyle(fontSize: 14,fontWeight: FontWeight.bold,color: Colors.white,),),PieChartSectionData(color: Colors.red,value: pendingCount.toDouble(),title: '${pendingCount}',radius: 60,titleStyle: const TextStyle(fontSize: 14,fontWeight: FontWeight.bold,color: Colors.white,),),],);// Filter Options (Sekolah)final List<DropdownMenuItem<String?>> schoolItems = [const DropdownMenuItem(value: null, child: Text("Semua Sekolah")),..._allVehicles.map((vehicle) => DropdownMenuItem(value: vehicle.id,child: Text(vehicle.plateNumber),),),];return Column(children: [// --- SECTION A: METRIK RESOLUSI & PERSENTASE ---Padding(padding: const EdgeInsets.all(16.0),child: Column(children: [Text("Tingkat Resolusi Keluhan: ${(resolutionPercentage * 100).toStringAsFixed(1)}%",style: const TextStyle(fontSize: 18,fontWeight: FontWeight.bold,color: Colors.red,),),SizedBox(height: 250,child: PieChart(pieChartDataResolution),),// Stat BarisRow(mainAxisAlignment: MainAxisAlignment.spaceAround,children: [_buildStatChip("DITANGANI", resolvedCount, Colors.green),_buildStatChip("PENDING", pendingCount, Colors.red),_buildStatChip("TOTAL", totalComplaints, Colors.indigo),],),],),),// --- FILTER SECTION ---Padding(padding: const EdgeInsets.all(8.0),child: Row(children: [// Filter TanggalExpanded(child: ListTile(leading: const Icon(Icons.calendar_today,color: Colors.red,),title: Text(DateFormat('d MMMM yyyy','id_ID',).format(_selectedRouteDate),),onTap: () async {final DateTime? picked = await showDatePicker(context: context,initialDate: _selectedRouteDate,firstDate: DateTime(2024),lastDate: DateTime(2030),);if (picked != null) {setState(() {_selectedRouteDate = picked;_complaintKey = UniqueKey(); // Force refresh list});}},),),// Filter Sekolah (Diganti dengan Dropdown Sekolah BUKAN Mobil)Expanded(child: DropdownButtonFormField<String?>(value: _selectedSchoolFilterId,decoration: const InputDecoration(labelText: "Filter Sekolah",),items: [const DropdownMenuItem(value: null,child: Text("Semua Sekolah"),),..._allSchools.map((school) => DropdownMenuItem(value: school.id,child: Text(school.name),),).toList(),],onChanged: (String? newValue) {setState(() {_selectedSchoolFilterId = newValue;_complaintKey = UniqueKey(); // Force refresh list});},),),],),),const Divider(height: 1),// --- SECTION B: LIST KELUHAN (Filtered) ---Expanded(child: FutureBuilder<List<Map<String, dynamic>>>(key:UniqueKey(), // Menggunakan UniqueKey untuk data yang filtered// Panggil service dengan filter yang barufuture: _complaintService.getSppgComplaints(date: _selectedRouteDate,schoolId: _selectedSchoolFilterId,),builder: (context, snapshot) {if (snapshot.connectionState == ConnectionState.waiting) {return const Center(child: CircularProgressIndicator());}final filteredData = snapshot.data ?? [];if (filteredData.isEmpty) {return const Center(child: Text("Tidak ada keluhan masuk sesuai filter."),);}return ListView.builder(itemCount: filteredData.length,itemBuilder: (ctx, i) {final item = filteredData[i];final isResolved = item['admin_response'] != null;final reporterRole = item['reporter_role'] ?? 'N/A';final targetTable = reporterRole == 'walikelas'? 'class_receptions': 'delivery_stops';final targetId = item['id'];// Gunakan helper format detailsfinal complaintDetails = _formatComplaintDetails(reporterRole,item['notes'],);return Card(color: isResolved ? Colors.green[50] : Colors.red[100],margin: const EdgeInsets.symmetric(horizontal: 10,vertical: 6,),child: ListTile(onTap: isResolved? () =>_showHistoryDetailDialog(item,) // Tampilkan detail history: () => _showRespondDialog(item,targetTable,targetId,), // Respon jika pendingleading: Icon(isResolved ? Icons.check_circle : Icons.warning,color: isResolved ? Colors.green : Colors.red,),title: Text(item['school_name'] ?? 'Sekolah N/A',style: const TextStyle(fontWeight: FontWeight.bold),),subtitle: Column(crossAxisAlignment: CrossAxisAlignment.start,children: [Text("Dari: ${item['reporter_name']} (${reporterRole.toUpperCase()})",),Text("Rincian: ${complaintDetails}",maxLines: 2,overflow: TextOverflow.ellipsis,),Text(isResolved? "Ditangani Admin": "PENDING TINDAK LANJUT",style: TextStyle(fontSize: 12,color: isResolved? Colors.green[800]: Colors.red[800],fontWeight: FontWeight.bold,),),],),isThreeLine: true,trailing: isResolved? const Icon(Icons.info_outline,color: Colors.grey,): ElevatedButton(onPressed: () => _showRespondDialog(item,targetTable,targetId,),child: const Text("Tindak Lanjut"),),),);},);},),),],);},);}}

=== FILE: lib/features/admin_sppg/screens/dashboard_admin_screen.dart ===
// FILE: lib/features/admin_sppg/screens/dashboard_admin_screen.dartimport 'package:flutter/material.dart';import 'package:intl/intl.dart';import 'dart:convert'; // Import untuk jsonDecode// Import Auth & Loginimport '../../../features/autentikasi/services/auth_service.dart';import '../../../features/autentikasi/screens/login_screen.dart';// Import Modelimport '../../../models/school_model.dart';import '../../../models/vehicle_model.dart';import '../../../models/route_model.dart';import '../../../models/courier_model.dart';import '../services/coordinator_service.dart';import '../services/teacher_service.dart';// Import Servicesimport '../services/school_service.dart';import '../services/vehicle_service.dart';import '../services/courier_service.dart';import '../services/route_service.dart';// Import Forms & Screensimport 'add_school_screen.dart';import 'add_transport_screen.dart';import 'add_courier_screen.dart';import 'add_coordinator_screen.dart';import 'add_teacher_screen.dart';import 'create_route_screen.dart';import 'menu_management_screen.dart';import 'statistics_screen.dart';import 'production_calendar_screen.dart';import '../../../core/screens/profile_screen.dart';import 'edit_account_screen.dart';import 'edit_route_screen.dart';import 'center_info_screen.dart';import 'route_calendar_screen.dart';class DashboardAdminScreen extends StatefulWidget {const DashboardAdminScreen({super.key});@overrideState<DashboardAdminScreen> createState() => _DashboardAdminScreenState();}class _DashboardAdminScreenState extends State<DashboardAdminScreen> {int _selectedIndex = 0;// Inisialisasi Servicefinal SchoolService _schoolService = SchoolService();final VehicleService _vehicleService = VehicleService();final CourierService _courierService = CourierService();final CoordinatorService _coordinatorService = CoordinatorService();final TeacherService _teacherService = TeacherService();final RouteService _routeService = RouteService();// [BARU] State untuk Filter SekolahString? _selectedSchoolFilterId;List<School> _allSppgSchools = []; // Cache semua sekolah SPPG ini// State untuk tombol Generate Otomatisbool _isGenerating = false;// [BARU] State untuk Tanggal Generate OtomatisDateTime _generateDate = DateTime.now(); // Default hari ini// [BARU] State untuk Filter RuteDateTime _selectedRouteFilterDate = DateTime.now(); // <--- BARUString?_selectedRouteFilterVehicleId; // <--- BARU ('all' jika tidak ada filter)List<Vehicle> _allVehicles = []; // <--- Cache kendaraan (sudah ada)@overridevoid initState() {super.initState();// Inisialisasi tanggal filter_selectedRouteFilterDate = DateTime(_selectedRouteFilterDate.year,_selectedRouteFilterDate.month,_selectedRouteFilterDate.day,);_loadInitialFilters(); // Load sekolah untuk filter// Tambahkan inisialisasi _generateDate ke midnight_generateDate = DateTime(_generateDate.year,_generateDate.month,_generateDate.day,);}// ... (perlu modifikasi _loadInitialFilters untuk memuat vehicles)Future<void> _loadInitialFilters() async {try {final results = await Future.wait([_schoolService.getMySchools(),_vehicleService.getMyVehicles(), // Load Vehicles]);final schools = results[0] as List<School>;final vehicles = results[1] as List<Vehicle>; // Ambil data kendaraanif (mounted) {setState(() {_allSppgSchools = schools;_allVehicles = vehicles; // Set data kendaraan_selectedRouteFilterVehicleId = 'all'; // Default filter mobil});}} catch (e) {print("Gagal load daftar sekolah untuk filter: $e");}}Future<void> _logout() async {await AuthService().signOut();if (!mounted) return;Navigator.of(context).pushAndRemoveUntil(MaterialPageRoute(builder: (_) => const LoginScreen()),(route) => false,);}String _getAppBarTitle() {switch (_selectedIndex) {case 0:return "Kelola Sekolah";case 1:return "Kelola Armada";case 2:return "Kelola Kurir";case 3:return "Kelola Koordinator";case 4:return "Kelola Wali Kelas";case 5:return "Jadwal & Rute";default:return "Admin SPPG";}}String _getFabLabel() {switch (_selectedIndex) {case 0:return "Sekolah";case 1:return "Mobil";case 2:return "Kurir";case 3:return "Koordinator";case 4:return "Wali";case 5:return "Buat Rute";default:return "Tambah";}}// [BARU] Fungsi Delete Rute (UC18)Future<void> _deleteRoute(String routeId) async {final confirm = await showDialog(context: context,builder: (ctx) => AlertDialog(title: const Text("Hapus Rute?"),content: const Text("Menghapus rute akan menghapus semua perhentian dan jadwal produksi terkait. Yakin?",),actions: [TextButton(onPressed: () => Navigator.pop(ctx, false),child: const Text("Batal"),),TextButton(onPressed: () => Navigator.pop(ctx, true),child: const Text("Hapus", style: TextStyle(color: Colors.red)),),],),);if (confirm == true) {try {await _routeService.deleteRoute(routeId,); // Panggil service yang sudah di-updateif (!mounted) return;ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Rute dan Jadwal Produksi Dihapus!")),);setState(() {});} catch (e) {if (!mounted) return;ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Error Hapus Rute: $e"),backgroundColor: Colors.red,),);}}}// [FUNGSI LAIN UNTUK DELETE]Future<void> _deleteSchool(String schoolId) async {final confirm = await showDialog(context: context,builder: (ctx) => AlertDialog(title: const Text("Hapus Sekolah?"),content: const Text("Yakin mau hapus lokasi ini? Semua data terkait (koordinator/wali) mungkin kena imbas.",),actions: [TextButton(onPressed: () => Navigator.pop(ctx, false),child: const Text("Batal"),),TextButton(onPressed: () => Navigator.pop(ctx, true),child: const Text("Hapus", style: TextStyle(color: Colors.red)),),],),);if (confirm == true) {try {await _schoolService.deleteSchool(schoolId);if (!mounted) return;ScaffoldMessenger.of(context,).showSnackBar(const SnackBar(content: Text("Sekolah Dihapus!")));setState(() {});} catch (e) {if (!mounted) return;ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Gagal menghapus: $e"),backgroundColor: Colors.red,),);}}}Future<void> _deleteVehicle(String vehicleId) async {final confirm = await showDialog(context: context,builder: (ctx) => AlertDialog(title: const Text("Hapus Kendaraan?"),content: const Text("Hapus plat ini dari armada?"),actions: [TextButton(onPressed: () => Navigator.pop(ctx, false),child: const Text("Batal"),),TextButton(onPressed: () => Navigator.pop(ctx, true),child: const Text("Hapus", style: TextStyle(color: Colors.red)),),],),);if (confirm == true) {await _vehicleService.deleteVehicle(vehicleId);if (!mounted) return;ScaffoldMessenger.of(context,).showSnackBar(const SnackBar(content: Text("Mobil Dihapus!")));setState(() {});}}Future<void> _deleteUser(String userId, String roleName) async {final confirm = await showDialog(context: context,builder: (ctx) => AlertDialog(title: Text("Hapus Akun $roleName?"),content: const Text("Tindakan ini permanen. Akun ini akan hilang."),actions: [TextButton(onPressed: () => Navigator.pop(ctx, false),child: const Text("Batal"),),TextButton(onPressed: () => Navigator.pop(ctx, true),child: const Text("Hapus", style: TextStyle(color: Colors.red)),),],),);if (confirm == true) {try {if (roleName == 'Kurir')await _courierService.deleteCourierAccount(userId);if (roleName == 'Koordinator')await _coordinatorService.deleteCoordinatorAccount(userId);if (roleName == 'Wali Kelas')await _teacherService.deleteTeacherAccount(userId);if (!mounted) return;ScaffoldMessenger.of(context,).showSnackBar(SnackBar(content: Text("Akun $roleName Dihapus!")));setState(() {});} catch (e) {ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Error: $e"), backgroundColor: Colors.red),);}}}void _navigateToEditAccount(String userId,String role,Map<String, dynamic> data,) {Navigator.push(context,MaterialPageRoute(builder: (_) => EditAccountScreen(userId: userId,initialRole: role,initialData: data,),),).then((val) {if (val == true) setState(() {});});}// --- HELPER METHODS ---Widget _buildEmptyState(String text, IconData icon) {return Center(child: Column(mainAxisAlignment: MainAxisAlignment.center,children: [Icon(icon, size: 70, color: Colors.grey[300]),const SizedBox(height: 10),Text(text, style: TextStyle(fontSize: 16, color: Colors.grey[600])),],),);}Color _getStatusColor(String status) {switch (status) {case 'completed':return Colors.green;case 'active':return Colors.blue;default:return Colors.orange;}}// [BARU] Helper untuk memformat deadline time JSONString _formatScheduleDisplay(String? deadlineJson) {if (deadlineJson == null || deadlineJson.isEmpty)return "Jadwal Belum Diset";try {final Map<String, dynamic> data = jsonDecode(deadlineJson);final List<String> scheduleEntries = [];// Urutan hari yang diinginkanconst List<String> days = ['Senin','Selasa','Rabu','Kamis','Jumat','Sabtu',];for (var day in days) {if (data.containsKey(day) && data[day] != null) {final timeStr = (data[day] as String).substring(0, 5); // Ambil HH:mmscheduleEntries.add("$day $timeStr");}}if (scheduleEntries.isEmpty) return "Tidak ada jadwal aktif";// Gabungkan entry (misal: Senin 09:40, Selasa 09:40)return scheduleEntries.join(', ');} catch (_) {return "Format Jadwal Rusak";}}// [BARU] Helper Sorting Kelas (Angka dulu, baru Huruf)int _sortClasses(String? a, String? b) {if (a == null || b == null) return 0;final exp = RegExp(r'^(\d+)([a-zA-Z]*)');final matchA = exp.firstMatch(a.toUpperCase());final matchB = exp.firstMatch(b.toUpperCase());if (matchA == null || matchB == null) return a.compareTo(b);final numA = int.tryParse(matchA.group(1)!) ?? 0;final numB = int.tryParse(matchB.group(1)!) ?? 0;final charA = matchA.group(2) ?? '';final charB = matchB.group(2) ?? '';// 1. Sort by Number (Class Level: 7 < 8 < 9)if (numA != numB) return numA.compareTo(numB);// 2. Sort by Character (Class Sub-Division: A < B < C)return charA.compareTo(charB);}// [BARU] Fungsi Generate Routes Otomatis// [MODIFIKASI] Fungsi Generate Routes Otomatis (Sekarang bisa memilih tanggal)Future<void> _generateRoutesForToday() async {// 1. Tampilkan Date Pickerfinal DateTime? pickedDate = await showDatePicker(context: context,initialDate: _generateDate,firstDate: DateTime.now(),lastDate: DateTime.now().add(const Duration(days: 90)),helpText: 'Pilih Tanggal Generate Rute',);if (pickedDate == null) return;final targetDate = DateTime(pickedDate.year,pickedDate.month,pickedDate.day,);// 2. Konfirmasi setelah tanggal dipilihfinal bool? confirm = await showDialog<bool>(context: context,builder: (ctx) => AlertDialog(title: const Text("Konfirmasi Generate Rute"),content: Text("Anda yakin ingin membuat rute otomatis untuk tanggal ${DateFormat('EEEE, d MMMM yyyy', 'id_ID').format(targetDate)}?",),actions: [TextButton(onPressed: () => Navigator.pop(ctx, false),child: const Text("Batal"),),ElevatedButton(onPressed: () => Navigator.pop(ctx, true),child: const Text("GENERATE SEKARANG",style: TextStyle(color: Colors.white),),style: ElevatedButton.styleFrom(backgroundColor: Colors.green),),],),);if (confirm != true) return;setState(() {_isGenerating = true;_generateDate = targetDate; // Simpan tanggal yang dipilih});try {// Memanggil logika routing di RouteService DENGAN TANGGAL YANG DIPILIHfinal routesCreated = await _routeService.generateDailyRoutes(date: targetDate,); // <--- KIRIM TANGGALif (!mounted) return;ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Berhasil membuat $routesCreated rute pengiriman otomatis untuk ${DateFormat('d MMM').format(targetDate)}!",),backgroundColor: Colors.green,duration: const Duration(seconds: 4),),);setState(() {}); // Refresh list rute} catch (e) {// <--- TAMBAHKAN 'e' DI SINIif (!mounted) return;ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Gagal Generate Rute: ${e.toString().replaceAll('Exception:', '')}",),backgroundColor: Colors.red,duration: const Duration(seconds: 7),),);} finally {if (mounted) setState(() => _isGenerating = false);}}// --- END HELPER METHODS ---@overrideWidget build(BuildContext context) {return Scaffold(appBar: AppBar(title: Text(_getAppBarTitle()),backgroundColor: Colors.orange[800],foregroundColor: Colors.white,actions: [// [BARU] TOMBOL REFRESH DATA AKTIFIconButton(icon: const Icon(Icons.refresh),tooltip: "Refresh Data",onPressed: () {setState(() {}); // Memaksa rebuild FutureBuilders di IndexStack},),// Tombol Daily Batch (Hanya muncul di tab Rute)if (_selectedIndex == 5)_isGenerating? const Padding(padding: EdgeInsets.symmetric(horizontal: 16),child: Center(child: SizedBox(width: 20,height: 20,child: CircularProgressIndicator(color: Colors.white,strokeWidth: 2,),),),): // END _isGeneratingRow(mainAxisSize: MainAxisSize.min,children: [// 1. CALENDAR ICON (Routes/Jadwal Rutin Calendar)IconButton(icon: const Icon(Icons.calendar_today, size: 24),tooltip: "Jadwal Rutin Mingguan",onPressed: () {Navigator.push(context,MaterialPageRoute(builder: (_) => const RouteCalendarScreen(),),);},),// [BARU] TOMBOL GENERATE OTOMATIS (Di sebelah kanan)IconButton(icon: const Icon(Icons.auto_awesome,color: Colors.amber,), // Icon yang menariktooltip: "Generate Rute Otomatis Hari Ini",onPressed:_generateRoutesForToday, // Panggil fungsi baru),],),// 2. HAMBURGER MENU (Consolidated Options)PopupMenuButton<String>(onSelected: (value) {if (value == 'production') {Navigator.push(context,MaterialPageRoute(builder: (_) => const ProductionCalendarScreen(),),);} else if (value == 'menu') {Navigator.push(context,MaterialPageRoute(builder: (_) => const MenuManagementScreen(),),);} else if (value == 'reports') {Navigator.push(context,MaterialPageRoute(builder: (_) => const CenterInfoScreen()),);} else if (value == 'stats') {Navigator.push(context,MaterialPageRoute(builder: (_) => const StatisticsScreen()),);} else if (value == 'profile') {Navigator.push(context,MaterialPageRoute(builder: (_) => const ProfileScreen()),);} else if (value == 'logout') {_logout();}},itemBuilder: (BuildContext context) => <PopupMenuEntry<String>>[const PopupMenuItem<String>(value: 'production',child: Text("Kalender Produksi"),),const PopupMenuItem<String>(value: 'menu',child: Text("Manajemen Menu"),),const PopupMenuDivider(),const PopupMenuItem<String>(value: 'reports',child: Text("Pusat Informasi"),),const PopupMenuItem<String>(value: 'stats',child: Text("Laporan"),),const PopupMenuDivider(),const PopupMenuItem<String>(value: 'profile',child: Text("Profil Saya"),),const PopupMenuItem<String>(value: 'logout',child: Text("LOGOUT", style: TextStyle(color: Colors.red)),),],icon: const Icon(Icons.menu, color: Colors.white),),],),// Konten Body: IndexedStack + Tombol Fixedbody: Column(// Column membungkus IndexedStack dan tombol fixedchildren: [Expanded(// IndexedStack harus dibungkus Expandedchild: IndexedStack(index: _selectedIndex,children: [_buildSchoolList(), // 0_buildTransportList(), // 1_buildCourierList(), // 2_buildCoordinatorList(), // 3_buildTeacherList(), // 4_buildRouteList(), // 5],),),// Tombol Fixed (berada di bawah Expanded IndexStack)_buildFixedAddButton(context),],),// Navigasi Bawah tetap adabottomNavigationBar: BottomNavigationBar(currentIndex: _selectedIndex,type: BottomNavigationBarType.fixed,selectedItemColor: Colors.orange[800],unselectedItemColor: Colors.grey,onTap: (index) => setState(() => _selectedIndex = index),items: const [BottomNavigationBarItem(icon: Icon(Icons.school), label: "Sekolah"),BottomNavigationBarItem(icon: Icon(Icons.local_shipping),label: "Armada",),BottomNavigationBarItem(icon: Icon(Icons.person_pin_circle),label: "Kurir",),BottomNavigationBarItem(icon: Icon(Icons.supervisor_account),label: "Koordinator",),BottomNavigationBarItem(icon: Icon(Icons.class_), label: "Wali"),BottomNavigationBarItem(icon: Icon(Icons.map_outlined),label: "Rute",),],),);}// Widget Tambahan: Tombol Fixed (Dipindahkan dari _buildFixedAddButton)Widget _buildFixedAddButton(BuildContext context) {return Container(padding: const EdgeInsets.symmetric(horizontal: 16.0, vertical: 10.0),decoration: BoxDecoration(color: Theme.of(context).scaffoldBackgroundColor,border: Border(top: BorderSide(color: Colors.grey.shade300, width: 1.0),),),child: SizedBox(width: double.infinity,child: ElevatedButton.icon(style: ElevatedButton.styleFrom(backgroundColor: Colors.orange[800],foregroundColor: Colors.white,padding: const EdgeInsets.symmetric(vertical: 14),),icon: const Icon(Icons.add),label: Text("TAMBAH ${_getFabLabel().toUpperCase()}",style: const TextStyle(fontWeight: FontWeight.bold),),onPressed: () {Widget nextPage;if (_selectedIndex == 0)nextPage = const AddSchoolScreen();else if (_selectedIndex == 1)nextPage = const AddTransportScreen();else if (_selectedIndex == 2)nextPage = const AddCourierScreen();else if (_selectedIndex == 3)nextPage = const AddCoordinatorScreen();else if (_selectedIndex == 4)nextPage = const AddTeacherScreen();elsenextPage = const CreateRouteScreen();Navigator.push(context,MaterialPageRoute(builder: (_) => nextPage),).then((val) {if (val == true) setState(() {});});},),),);}// Widget List Sekolah (Diperbarui dengan format jadwal baru)Widget _buildSchoolList() {return FutureBuilder<List<School>>(future: _schoolService.getMySchools(),builder: (context, snapshot) {if (snapshot.connectionState == ConnectionState.waiting)return const Center(child: CircularProgressIndicator());final schools = snapshot.data ?? [];if (schools.isEmpty)return _buildEmptyState("Belum ada sekolah.", Icons.school_outlined);return ListView.builder(padding: const EdgeInsets.fromLTRB(10,10,10,80,), // Tambahkan padding bawah agar tombol tidak tertutupitemCount: schools.length,itemBuilder: (ctx, i) {final school = schools[i];// Format Jadwal Deadlinefinal formattedSchedule = _formatScheduleDisplay(school.deadlineTime,);return Card(child: ListTile(leading: const CircleAvatar(backgroundColor: Colors.orange,child: Icon(Icons.school, color: Colors.white),),title: Text(school.name,style: const TextStyle(fontWeight: FontWeight.bold),),subtitle: Text(// [FIX DI SINI] Gunakan helper function yang baru"Siswa: ${school.studentCount} | Deadline: $formattedSchedule",),trailing: Row(mainAxisSize: MainAxisSize.min,children: [// EDIT Button (UC25)IconButton(icon: const Icon(Icons.edit, color: Colors.blue),onPressed: () {Navigator.push(context,MaterialPageRoute(builder: (_) =>AddSchoolScreen(schoolToEdit: school),),).then((val) {if (val == true)setState(() {},); // <-- THIS IS THE CORRECT REFRESH CALL});},),// DELETE Button (UC26)IconButton(icon: const Icon(Icons.delete, color: Colors.red),onPressed: () => _deleteSchool(school.id),),],),),);},);},);}Widget _buildTransportList() {return FutureBuilder<List<Vehicle>>(future: _vehicleService.getMyVehicles(),builder: (context, snapshot) {if (snapshot.connectionState == ConnectionState.waiting)return const Center(child: CircularProgressIndicator());final vehicles = snapshot.data ?? [];if (vehicles.isEmpty)return _buildEmptyState("Belum ada kendaraan.",Icons.local_shipping_outlined,);return ListView.builder(padding: const EdgeInsets.all(10),itemCount: vehicles.length,itemBuilder: (ctx, i) {final vehicle = vehicles[i];// [BARU]: Info AsistenString assistantText = vehicle.assistantCourierName != null? "Asisten: ${vehicle.assistantCourierName}": "Tidak ada Asisten";return Card(child: ListTile(leading: Icon(Icons.directions_car,color: vehicle.isActive ? Colors.green : Colors.grey,size: 32,),title: Text(vehicle.plateNumber,style: const TextStyle(fontWeight: FontWeight.bold),),// [UPDATE SUBTITLE]: Tampilkan Asistensubtitle: Text("Supir: ${vehicle.driverName ?? '-'} | Kap.: ${vehicle.capacityLimit}\n$assistantText",style: const TextStyle(fontSize: 12),),isThreeLine: true, // Ubah ke 3 baristrailing: Row(mainAxisSize: MainAxisSize.min,children: [// EDIT Button (UC34)IconButton(icon: const Icon(Icons.edit, color: Colors.blue),onPressed: () {Navigator.push(context,MaterialPageRoute(builder: (_) =>AddTransportScreen(vehicleToEdit: vehicle),),).then((val) {if (val == true) setState(() {});});},),// DELETE Button (UC35)IconButton(icon: const Icon(Icons.delete, color: Colors.red),onPressed: () => _deleteVehicle(vehicle.id),),// Status ToggleSwitch(value: vehicle.isActive,activeColor: Colors.green,onChanged: (val) async {await _vehicleService.toggleStatus(vehicle.id,vehicle.isActive,);setState(() {});},),],),),);},);},);}Widget _buildCourierList() {return FutureBuilder<List<CourierModel>>(future: _courierService.getMyCouriers(),builder: (context, snapshot) {if (snapshot.connectionState == ConnectionState.waiting)return const Center(child: CircularProgressIndicator());final couriers = snapshot.data ?? [];if (couriers.isEmpty)return _buildEmptyState("Belum ada akun kurir.",Icons.person_off_outlined,);return ListView.builder(padding: const EdgeInsets.all(10),itemCount: couriers.length,itemBuilder: (ctx, i) {final courier = couriers[i];return Card(child: ListTile(leading: const CircleAvatar(backgroundColor: Colors.blueGrey,child: Icon(Icons.person, color: Colors.white),),title: Text(courier.name,style: const TextStyle(fontWeight: FontWeight.bold),),// [UPDATE SUBTITLE] Tampilkan email dan nomor teleponsubtitle: Text("${courier.email}\nTelp: ${courier.phoneNumber ?? '-'}",style: const TextStyle(fontSize: 12),),isThreeLine: true, // Ubah ke 3 baristrailing: Row(mainAxisSize: MainAxisSize.min,children: [// EDIT Button (UC31)IconButton(icon: const Icon(Icons.edit, color: Colors.blue),onPressed: () =>_navigateToEditAccount(courier.id, 'kurir', {'name': courier.name,'email': courier.email,'schoolId': null,'className': null,'phoneNumber': courier.phoneNumber,}),),// DELETE Button (UC32)IconButton(icon: const Icon(Icons.delete, color: Colors.red),onPressed: () => _deleteUser(courier.id, 'Kurir'),),],),),);},);},);}Widget _buildCoordinatorList() {// Siapkan list untuk Dropdown Filterfinal List<DropdownMenuItem<String?>> schoolItems = [const DropdownMenuItem(value: null, child: Text("Semua Sekolah")),..._allSppgSchools.map((school) =>DropdownMenuItem(value: school.id, child: Text(school.name)),),];return Column(children: [// Dropdown Filter SekolahPadding(padding: const EdgeInsets.all(8.0),child: DropdownButtonFormField<String?>(decoration: const InputDecoration(labelText: "Filter Berdasarkan Sekolah",border: OutlineInputBorder(),prefixIcon: Icon(Icons.filter_list),),value: _selectedSchoolFilterId,items: schoolItems,onChanged: (String? newValue) {setState(() {_selectedSchoolFilterId = newValue;});},),),// List KoordinatorExpanded(child: FutureBuilder<List<CoordinatorModel>>(future: _coordinatorService.getMyCoordinators(),builder: (context, snapshot) {if (snapshot.connectionState == ConnectionState.waiting)return const Center(child: CircularProgressIndicator());final data = snapshot.data ?? [];// [FILTERING LOGIC]final filteredData = data.where((coord) {if (_selectedSchoolFilterId == null) return true;return coord.schoolId == _selectedSchoolFilterId;}).toList();// [SORTING LOGIC BARU] Sort berdasarkan Nama Sekolah (Ascending)filteredData.sort((a, b) {return a.schoolName.toLowerCase().compareTo(b.schoolName.toLowerCase(),);});if (filteredData.isEmpty)return _buildEmptyState("Belum ada koordinator di sekolah yang dipilih.",Icons.supervised_user_circle,);return ListView.builder(padding: const EdgeInsets.fromLTRB(10,0,10,80,), // Padding bawah agar tombol tidak tertutupitemCount: filteredData.length,itemBuilder: (ctx, i) {final coord = filteredData[i];return Card(child: ListTile(leading: const CircleAvatar(backgroundColor: Colors.teal,child: Icon(Icons.person, color: Colors.white),),title: Text(coord.name,style: const TextStyle(fontWeight: FontWeight.bold),),// [UPDATE SUBTITLE] Tampilkan sekolah, email, dan nomor teleponsubtitle: Text("${coord.schoolName}\n${coord.email}\nTelp: ${coord.phoneNumber ?? '-'}",style: const TextStyle(fontSize: 12),),isThreeLine: true,trailing: Row(mainAxisSize: MainAxisSize.min,children: [// EDIT Button (UC31)IconButton(icon: const Icon(Icons.edit, color: Colors.blue),onPressed: () => _navigateToEditAccount(coord.id,'koordinator',{'name': coord.name,'email': coord.email,'schoolId': coord.schoolId,'className': null,'phoneNumber': coord.phoneNumber,'schoolName':coord.schoolName, // <--- KRITIS: TAMBAH INI},),),// DELETE Button (UC32)IconButton(icon: const Icon(Icons.delete, color: Colors.red),onPressed: () =>_deleteUser(coord.id, 'Koordinator'),),],),),);},);},),),],);}Widget _buildTeacherList() {// Siapkan list untuk Dropdown Filter (Sama dengan Koordinator)final List<DropdownMenuItem<String?>> schoolItems = [const DropdownMenuItem(value: null, child: Text("Semua Sekolah")),..._allSppgSchools.map((school) =>DropdownMenuItem(value: school.id, child: Text(school.name)),),];return Column(children: [// Dropdown Filter Sekolah (Wajib di dalam Column)Padding(padding: const EdgeInsets.all(8.0),child: DropdownButtonFormField<String?>(decoration: const InputDecoration(labelText: "Filter Berdasarkan Sekolah",border: OutlineInputBorder(),prefixIcon: Icon(Icons.filter_list),),value: _selectedSchoolFilterId,items: schoolItems,onChanged: (String? newValue) {setState(() {_selectedSchoolFilterId = newValue;});},),),// List Wali KelasExpanded(// Harus dibungkus Expandedchild: FutureBuilder<List<TeacherModel>>(future: _teacherService.getMyTeachers(),builder: (context, snapshot) {if (snapshot.connectionState == ConnectionState.waiting)return const Center(child: CircularProgressIndicator());final data = snapshot.data ?? [];// [FILTERING LOGIC]final filteredData = data.where((teacher) {if (_selectedSchoolFilterId == null) return true;return teacher.schoolId == _selectedSchoolFilterId;}).toList();// [SORTING LOGIC]filteredData.sort((a, b) {// 1. Sort by School Name (Ascending)final schoolCompare = a.schoolName.toLowerCase().compareTo(b.schoolName.toLowerCase(),);if (schoolCompare != 0) return schoolCompare;// 2. Sort by Class Name (Custom Alphanumeric)return _sortClasses(a.className, b.className);});if (filteredData.isEmpty)return _buildEmptyState("Belum ada wali kelas di sekolah yang dipilih.",Icons.class_,);return ListView.builder(padding: const EdgeInsets.fromLTRB(10, 0, 10, 80),itemCount: filteredData.length,itemBuilder: (ctx, i) {final teacher = filteredData[i];return Card(child: ListTile(leading: const CircleAvatar(backgroundColor: Colors.indigo,child: Icon(Icons.class_, color: Colors.white),),title: Text(teacher.name,style: const TextStyle(fontWeight: FontWeight.bold),),// [UPDATE SUBTITLE] Tampilkan sekolah, kelas, email, dan nomor teleponsubtitle: Text(// [FIX 1]: Tampilkan jumlah penerima kelas"${teacher.schoolName} - Kelas ${teacher.className} (${teacher.studentCountClass} Siswa)\n${teacher.email}\nTelp: ${teacher.phoneNumber ?? '-'}",style: const TextStyle(fontSize: 12),),isThreeLine: true,trailing: Row(mainAxisSize: MainAxisSize.min,children: [// EDIT Button (UC31)IconButton(icon: const Icon(Icons.edit, color: Colors.blue),onPressed: () => _navigateToEditAccount(teacher.id,'walikelas',{'name': teacher.name,'email': teacher.email,'schoolId': teacher.schoolId,'className': teacher.className,'phoneNumber': teacher.phoneNumber,'schoolName': teacher.schoolName,// [FIX 2]: Tambahkan data kuota kelas ke initialData'studentCountClass': teacher.studentCountClass,},),), // DELETE Button (UC32)IconButton(icon: const Icon(Icons.delete, color: Colors.red),onPressed: () =>_deleteUser(teacher.id, 'Wali Kelas'),),],),),);},);},),),],);}// Helper untuk format waktuString _formatTime(String? timeStr) {if (timeStr == null || timeStr.isEmpty) return "--:--";try {return timeStr.substring(0, 5);} catch (_) {return timeStr;}}Widget _buildRouteList() {final List<DropdownMenuItem<String?>> vehicleItems = [const DropdownMenuItem(value: 'all', child: Text("Semua Armada")),..._allVehicles.map((vehicle) => DropdownMenuItem(value: vehicle.id,child: Text(vehicle.plateNumber),),).toList(),];return Column(children: [// --- FILTER SECTION ---Padding(padding: const EdgeInsets.all(8.0),child: Row(children: [// Filter TanggalExpanded(child: ListTile(leading: const Icon(Icons.calendar_today,color: Colors.indigo,),title: Text(DateFormat('d MMMM yyyy','id_ID',).format(_selectedRouteFilterDate),),onTap: () async {final DateTime? picked = await showDatePicker(context: context,initialDate: _selectedRouteFilterDate,firstDate: DateTime(2024),lastDate: DateTime(2030),);if (picked != null) {setState(() {_selectedRouteFilterDate = picked;});}},),),// Filter MobilExpanded(child: DropdownButtonFormField<String?>(value: _selectedRouteFilterVehicleId,decoration: const InputDecoration(labelText: "Filter Mobil"),items: vehicleItems,onChanged: (String? newValue) {setState(() {_selectedRouteFilterVehicleId = newValue;});},),),],),),const Divider(height: 1),// --- LIST RUTE HASIL FILTER ---Expanded(child: FutureBuilder<List<DeliveryRoute>>(future: _routeService.getMyRoutes(date: _selectedRouteFilterDate,vehicleId: _selectedRouteFilterVehicleId,),builder: (context, snapshot) {if (snapshot.connectionState == ConnectionState.waiting)return const Center(child: CircularProgressIndicator());final routes = snapshot.data ?? [];if (routes.isEmpty)return _buildEmptyState("Tidak ada rute yang cocok dengan filter.",Icons.map_outlined,);return ListView.builder(padding: const EdgeInsets.all(12),itemCount: routes.length,itemBuilder: (context, index) {final route = routes[index];final status = route.status;final date = DateTime.tryParse(route.date) ?? DateTime.now();final dateStr = DateFormat('dd MMM yy', 'id_ID').format(date);final isPending = status == 'pending';Color statusColor = _getStatusColor(status);// **INNER FUTURE BUILDER untuk mendapatkan Tujuan Pertama**return FutureBuilder<Map<String, dynamic>?>(future: _routeService.getNextPendingStop(route.id),builder: (context, stopSnapshot) {final nextStop = stopSnapshot.data;String tujuanInfo = "Semua Stop Selesai";String jamInfo = _formatTime(route.departureTime,); // Default: Jam Berangkatif (route.status == 'completed' ||route.status == 'received' ||route.status == 'issue_reported') {tujuanInfo = "Rute Selesai Total";jamInfo = _formatTime(route.departureTime);} else if (nextStop != null &&(route.status == 'active' ||route.status == 'pending')) {tujuanInfo = "Tujuan 1: ${nextStop['schools']['name']}";jamInfo = _formatTime(nextStop['estimated_arrival_time'],); // ETA ke Stop 1}return Card(elevation: 3,color:status == 'received' || status == 'issue_reported'? Colors.green[50]: Colors.grey[100],margin: const EdgeInsets.only(bottom: 12),child: InkWell(onTap: () {Navigator.push(context,MaterialPageRoute(builder: (_) => EditRouteScreen(route: route),),).then((val) {if (val == true) setState(() {});});},child: Padding(padding: const EdgeInsets.all(12),child: Column(crossAxisAlignment: CrossAxisAlignment.start,children: [// BARIS 1: TANGGAL & STATUSRow(mainAxisAlignment:MainAxisAlignment.spaceBetween,children: [Text("$dateStr - ${route.vehiclePlate ?? '-'}",style: const TextStyle(fontWeight: FontWeight.bold,fontSize: 16,),),Text(route.status.toUpperCase(),style: TextStyle(color: statusColor,fontWeight: FontWeight.bold,fontSize: 12,),),],),const Divider(height: 10),// BARIS 2: KURIR & TUJUANText("Kurir: ${route.courierName ?? 'N/A'}",style: const TextStyle(fontSize: 14),),const SizedBox(height: 5),// BARIS 3: TUJUAN DAN JAM KRITISRow(children: [Icon(Icons.location_on,size: 16,color: statusColor,),const SizedBox(width: 5),Expanded(child: Text(tujuanInfo,style: const TextStyle(fontSize: 14,fontWeight: FontWeight.w500,),),),const SizedBox(width: 10),Icon(Icons.access_time,size: 16,color: statusColor,),const SizedBox(width: 5),Text(jamInfo,style: const TextStyle(fontSize: 14,fontWeight: FontWeight.bold,),),],),// Tombol Hapus (Hanya muncul jika Pending)if (isPending)Align(alignment: Alignment.centerRight,child: IconButton(icon: const Icon(Icons.delete,color: Colors.red,size: 20,),tooltip: "Hapus Rute",onPressed: () => _deleteRoute(route.id),),),],),),),);},);},);},),),],);}}

=== FILE: lib/features/admin_sppg/screens/production_calendar_screen.dart ===
import 'package:flutter/material.dart';import 'package:table_calendar/table_calendar.dart';import 'package:intl/intl.dart';import '../../../models/production_schedule_model.dart';import '../../../models/menu_model.dart';import '../services/schedule_service.dart';import '../services/menu_service.dart';import 'package:collection/collection.dart';// Model sementara untuk hasil kalkulasi yang akan ditampilkan di dialogclass CalculatedProductionItem {final String menuName;final int portions;final int maxConsume;final String earliestDeadline; // Format HH:mmfinal int cookingDuration;CalculatedProductionItem({required this.menuName,required this.portions,required this.maxConsume,required this.earliestDeadline,required this.cookingDuration,});}class ProductionCalendarScreen extends StatefulWidget {const ProductionCalendarScreen({super.key});@overrideState<ProductionCalendarScreen> createState() =>_ProductionCalendarScreenState();}class _ProductionCalendarScreenState extends State<ProductionCalendarScreen> {final ScheduleService _scheduleService = ScheduleService();final MenuService _menuService = MenuService();DateTime _focusedDay = DateTime.now();DateTime? _selectedDay;Map<DateTime, List<ProductionSchedule>> _schedules = {};List<Menu> _availableMenus = [];bool _isLoading = true;@overridevoid initState() {super.initState();_selectedDay = _focusedDay;_loadInitialData();}Future<void> _loadInitialData() async {try {final menus = await _menuService.getMyMenus();_availableMenus = menus;_fetchSchedules();} catch (e) {setState(() => _isLoading = false);}}Future<void> _fetchSchedules() async {setState(() => _isLoading = true);try {// THIS NOW CALLS THE CORRECTLY DEFINED METHODfinal data = await _scheduleService.getSchedulesByMonth(_focusedDay);Map<DateTime, List<ProductionSchedule>> newMap = {};for (var item in data) {final dateKey = DateTime(item.date.year,item.date.month,item.date.day,);if (newMap[dateKey] == null) newMap[dateKey] = [];newMap[dateKey]!.add(item);}if (mounted) {setState(() {_schedules = newMap;_isLoading = false;});}} catch (e) {if (mounted) setState(() => _isLoading = false);}}List<ProductionSchedule> _getSchedulesForDay(DateTime day) {final dateKey = DateTime(day.year, day.month, day.day);return _schedules[dateKey] ?? [];}void _showAutoGenerateDialog() {bool isGenerating = false;List<MenuProductionDetail> calculatedList = [];showDialog(context: context,barrierDismissible: false,builder: (ctx) => StatefulBuilder(builder: (context, setDialogState) {Future<void> runCalculation() async {setDialogState(() => isGenerating = true);try {final result = await _scheduleService.calculateProductionSchedule(_selectedDay!,);setDialogState(() {calculatedList = result;isGenerating = false;});} catch (e) {if (mounted) {ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Gagal kalkulasi: $e"),backgroundColor: Colors.red,),);}setDialogState(() => isGenerating = false);}}// Trigger calculation on first openif (calculatedList.isEmpty && !isGenerating) {runCalculation();}// Logic Simpan Jadwal ke DBFuture<void> saveSchedule() async {setDialogState(() => isGenerating = true);try {await _scheduleService.saveCalculatedSchedule(calculatedList,_selectedDay!,);if (mounted) {ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Jadwal Produksi Tersimpan!"),backgroundColor: Colors.green,),);Navigator.pop(ctx);_fetchSchedules(); // Refresh Calendar}} catch (e) {if (mounted) {ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Gagal simpan jadwal: $e"),backgroundColor: Colors.red,),);}setDialogState(() => isGenerating = false);}}return AlertDialog(title: Text("Kalkulasi Jadwal ${_selectedDay != null ? DateFormat('d MMM').format(_selectedDay!) : ''}",),content: SizedBox(width: MediaQuery.of(context).size.width * 0.8,child: isGenerating? const Center(child: Column(mainAxisSize: MainAxisSize.min,children: [CircularProgressIndicator(),SizedBox(height: 10),Text("Menganalisis Rute & Deadline..."),],),): calculatedList.isEmpty? const Center(child: Text("Tidak ada kebutuhan produksi hari ini."),): SingleChildScrollView(child: Column(crossAxisAlignment: CrossAxisAlignment.start,mainAxisSize: MainAxisSize.min,children: [const Text("Urutan Masak (Prioritas Max Consume):",style: TextStyle(fontWeight: FontWeight.bold),),const SizedBox(height: 10),// Display order in reverse (paling bawah di list ini dimasak duluan, paling atas dimasak paling akhir)...calculatedList.reversed.toList().mapIndexed((index,item,) {// <--- FIX: .toList().mapIndexedreturn Card(color: Colors.blue[50],margin: const EdgeInsets.symmetric(vertical: 4),child: ListTile(leading: Text("#${index + 1}",style: const TextStyle(fontWeight: FontWeight.bold,fontSize: 16,),),title: Text(item.menuName,style: const TextStyle(fontWeight: FontWeight.bold,),),subtitle: Text("Porsi: ${item.totalPortions} | Masak: ${item.cookingDurationMinutes} mnt\nBatas Konsumsi: ${item.maxConsumeMinutes} mnt",),),);}).toList(),const SizedBox(height: 20),const Text("PERHATIAN: Jadwal yang disimpan akan diurutkan secara BACKWARD SCHEDULING.",style: TextStyle(color: Colors.red, fontSize: 12),),],),),),actions: [TextButton(onPressed: () => Navigator.pop(ctx),child: const Text("Tutup"),),if (calculatedList.isNotEmpty && !isGenerating)ElevatedButton(onPressed: saveSchedule,child: const Text("SIMPAN JADWAL OTOMATIS"),),],);},),);}// --- DIALOG CRUD (TAMBAH KHUSUS / EDIT) ---void _showScheduleDialog({ProductionSchedule? scheduleToEdit}) {String? selectedMenuId = scheduleToEdit?.menuId;final portionController = TextEditingController(text: scheduleToEdit?.totalPortions.toString() ?? "100",);final noteController = TextEditingController(text: scheduleToEdit?.notes ?? "Tambahan Khusus",);TimeOfDay selectedTime = const TimeOfDay(hour: 11, minute: 0);if (scheduleToEdit?.targetFinishTime != null) {final parts = scheduleToEdit!.targetFinishTime!.split(':');selectedTime = TimeOfDay(hour: int.parse(parts[0]),minute: int.parse(parts[1]),);}showDialog(context: context,builder: (ctx) => StatefulBuilder(builder: (context, setDialogState) {final currentMenu = _availableMenus.isNotEmpty? _availableMenus.firstWhere((m) => m.id == selectedMenuId,orElse: () => _availableMenus.first,): null;String startTimeString = "--:--";if (currentMenu != null) {startTimeString = _scheduleService.calculateStartTime(selectedTime,selectedMenuId != null? currentMenu.cookingDurationMinutes: 0,).substring(0, 5);}return AlertDialog(title: Text(scheduleToEdit == null ? "Jadwal Produksi" : "Edit Jadwal",),content: SingleChildScrollView(child: Column(mainAxisSize: MainAxisSize.min,children: [if (scheduleToEdit == null)const Text("Gunakan ini HANYA untuk pesanan tambahan di luar rute rutin.",style: TextStyle(fontSize: 12, color: Colors.red),),const SizedBox(height: 10),DropdownButtonFormField<String>(decoration: const InputDecoration(labelText: "Pilih Menu",border: OutlineInputBorder(),),value: selectedMenuId,items: _availableMenus.map((m) => DropdownMenuItem(value: m.id,child: Text(m.name),),).toList(),onChanged: (val) =>setDialogState(() => selectedMenuId = val),),const SizedBox(height: 10),TextField(controller: portionController,keyboardType: TextInputType.number,decoration: const InputDecoration(labelText: "Jumlah Porsi",border: OutlineInputBorder(),),),const SizedBox(height: 10),ListTile(title: const Text("Target Selesai Jam:"),subtitle: Text(selectedTime.format(context),style: const TextStyle(fontWeight: FontWeight.bold),),trailing: const Icon(Icons.access_time),onTap: () async {final t = await showTimePicker(context: context,initialTime: selectedTime,);if (t != null) setDialogState(() => selectedTime = t);},),if (selectedMenuId != null && currentMenu != null)Padding(padding: const EdgeInsets.only(top: 10),child: Container(padding: const EdgeInsets.all(8),color: Colors.blue[50],child: Text("MULAI MASAK: $startTimeString (Durasi: ${currentMenu.cookingDurationMinutes} mnt)",style: const TextStyle(color: Colors.blue,fontWeight: FontWeight.bold,fontSize: 12,),),),),const SizedBox(height: 10),TextField(controller: noteController,decoration: const InputDecoration(labelText: "Catatan",border: OutlineInputBorder(),),),],),),actions: [TextButton(onPressed: () => Navigator.pop(ctx),child: const Text("Batal"),),ElevatedButton(onPressed: () async {if (selectedMenuId == null) return;Navigator.pop(ctx);final menu = _availableMenus.firstWhere((m) => m.id == selectedMenuId,);if (scheduleToEdit == null) {// TAMBAH KHUSUSawait _scheduleService.addSchedule(date: _selectedDay!,menuId: selectedMenuId!,portions: int.parse(portionController.text),deliverTime: selectedTime,cookingDuration: menu.cookingDurationMinutes,notes: noteController.text,);} else {// EDIT JADWAL (Rutin/Khusus)await _scheduleService.updateSchedule(id: scheduleToEdit.id,menuId: selectedMenuId!,portions: int.parse(portionController.text),deliverTime: selectedTime,cookingDuration: menu.cookingDurationMinutes,notes: noteController.text,);}_fetchSchedules();},child: const Text("Simpan"),),],);},),);}void _confirmDelete(String id) {showDialog(context: context,builder: (ctx) => AlertDialog(title: const Text("Hapus Jadwal?"),content: const Text("Jadwal produksi ini akan dihapus."),actions: [TextButton(onPressed: () => Navigator.pop(ctx),child: const Text("Batal"),),TextButton(onPressed: () async {Navigator.pop(ctx);await _scheduleService.deleteSchedule(id);_fetchSchedules();},child: const Text("Hapus", style: TextStyle(color: Colors.red)),),],),);}@overrideWidget build(BuildContext context) {return Scaffold(appBar: AppBar(title: const Text("Kalender Produksi"),backgroundColor: Colors.orange[800],foregroundColor: Colors.white,),// [FIX UTAMA]: Bungkus Column utama dengan SingleChildScrollViewbody: SingleChildScrollView(child: Column(children: [// --- KALENDER (Tetap) ---TableCalendar<ProductionSchedule>(firstDay: DateTime.utc(2024, 1, 1),lastDay: DateTime.utc(2030, 12, 31),focusedDay: _focusedDay,selectedDayPredicate: (day) => isSameDay(_selectedDay, day),calendarFormat: CalendarFormat.month,eventLoader: _getSchedulesForDay,onDaySelected: (selected, focused) {setState(() {_selectedDay = selected;_focusedDay = focused;});},onPageChanged: (focused) {_focusedDay = focused;_fetchSchedules();},calendarStyle: const CalendarStyle(markerDecoration: BoxDecoration(color: Colors.orange,shape: BoxShape.circle,),todayDecoration: BoxDecoration(color: Colors.blue,shape: BoxShape.circle,),selectedDecoration: BoxDecoration(color: Colors.orange,shape: BoxShape.circle,),),headerStyle: const HeaderStyle(formatButtonVisible: false,titleCentered: true,),),const Divider(thickness: 1),const Padding(padding: EdgeInsets.all(8.0),child: Text("Jadwal Masak Hari Ini:",style: TextStyle(fontWeight: FontWeight.bold,color: Colors.grey,),),),// --- LIST JADWAL HARI INI ---// Kita perlu memberikan batasan tinggi untuk ListView ini karena parent-nya SingleChildScrollView.// Gunakan `IntrinsicHeight` atau `ConstrainedBox` untuk menghindari overflow.ConstrainedBox(constraints: BoxConstraints(maxHeight:MediaQuery.of(context).size.height *0.33, // Batas tinggi agar tidak terlalu panjang),child: _isLoading? const Center(child: CircularProgressIndicator()): _buildDayList(),),const SizedBox(height: 20),const Divider(thickness: 1),// [TOMBOL BIASA DI BAWAH KONTEN]Padding(padding: const EdgeInsets.all(16.0),child: SizedBox(width: double.infinity,child: ElevatedButton.icon(style: ElevatedButton.styleFrom(backgroundColor: Colors.blue[800],foregroundColor: Colors.white,padding: const EdgeInsets.symmetric(vertical: 15),),label: const Text("KALKULASI JADWAL OTOMATIS",style: TextStyle(fontWeight: FontWeight.bold),),icon: const Icon(Icons.auto_awesome),onPressed: () => _showAutoGenerateDialog(),),),),const SizedBox(height: 5),],),),);}Widget _buildDayList() {final events = _getSchedulesForDay(_selectedDay!);if (events.isEmpty)return const Center(child: Text("Tidak ada jadwal masak."));return ListView.builder(itemCount: events.length,itemBuilder: (context, index) {final schedule = events[index];// Check if the related route is already ACTIVE/COMPLETED to prevent accidental deletion!// NOTE: For now, we assume deleting the schedule is allowed by the admin, but a safer check// would involve querying the associated route status first!final isDeletable =true; // Simplified for now. Should check related route status.return Card(margin: const EdgeInsets.symmetric(horizontal: 16, vertical: 6),child: ListTile(leading: CircleAvatar(backgroundColor: Colors.orange[100],child: const Icon(Icons.restaurant, color: Colors.orange),),title: Text(schedule.menuName,style: const TextStyle(fontWeight: FontWeight.bold),),subtitle: Column(crossAxisAlignment: CrossAxisAlignment.start,children: [Text("Target: ${schedule.totalPortions} Porsi"),Text("Masak: ${schedule.startCookingTime?.substring(0, 5)} -> Selesai: ${schedule.targetFinishTime?.substring(0, 5)}",style: const TextStyle(color: Colors.red,fontWeight: FontWeight.bold,),),if (schedule.notes != null)Text(schedule.notes!,style: const TextStyle(fontStyle: FontStyle.italic,fontSize: 12,),),],),// REPLACING POPUP MENU WITH DIRECT ACTION BUTTONS (Edit and Delete)trailing: Row(mainAxisSize: MainAxisSize.min,children: [// EDIT ButtonIconButton(icon: const Icon(Icons.edit, color: Colors.blue),onPressed: () => _showScheduleDialog(scheduleToEdit: schedule,), // Mode Edit),// DELETE Buttonif (isDeletable) // Show delete button if allowedIconButton(icon: const Icon(Icons.delete, color: Colors.red),onPressed: () => _confirmDelete(schedule.id),),],),// NOTE: If you want to keep the PopupMenuButton approach, use the one below./*trailing: PopupMenuButton(onSelected: (value) {if (value == 'edit') _showScheduleDialog(scheduleToEdit: schedule);if (value == 'delete') _confirmDelete(schedule.id);},itemBuilder: (context) => [const PopupMenuItem(value: 'edit', child: Text("Edit")),const PopupMenuItem(value: 'delete', child: Text("Hapus", style: TextStyle(color: Colors.red))),],),*/),);},);}}

=== FILE: lib/features/admin_sppg/screens/center_info_screen.dart ===
// FILE: lib/features/admin_sppg/screens/center_info_screen.dartimport 'package:flutter/material.dart';import 'package:intl/intl.dart';import '../../shared/services/request_service.dart';import '../services/complaint_service.dart';import '../services/school_service.dart'; // <--- FIX 1: TAMBAH IMPORT SERVICEimport '../../../models/school_model.dart'; // <--- FIX 2: TAMBAH IMPORT MODEL SCHOOLimport 'dart:convert';import 'package:collection/collection.dart';class CenterInfoScreen extends StatefulWidget {const CenterInfoScreen({super.key});@overrideState<CenterInfoScreen> createState() => _CenterInfoScreenState();}class _CenterInfoScreenState extends State<CenterInfoScreen>with SingleTickerProviderStateMixin {late TabController _tabController;final RequestService _requestService = RequestService();final ComplaintService _complaintService = ComplaintService();// [FIX] Definisikan Key untuk memaksa refresh tab KomplainKey _complaintKey = UniqueKey();// [BARU] State untuk Filter Pengaduanfinal SchoolService _schoolService = SchoolService();List<School> _allSppgSchools = [];DateTime _selectedComplaintDate = DateTime.now();String? _selectedSchoolFilterId; // null = Semua Sekolahbool _isLoadingSchools = true;@overridevoid initState() {super.initState();_tabController = TabController(length: 2, vsync: this);_fetchFilterData(); // Load data sekolah}// [BARU] Load data sekolah untuk filterFuture<void> _fetchFilterData() async {try {final schools = await _schoolService.getMySchools();if (mounted) {setState(() {_allSppgSchools = schools;_isLoadingSchools = false;});}} catch (e) {if (mounted) setState(() => _isLoadingSchools = false);print("Error loading schools for filter: $e");}}void _refreshData() {_fetchFilterData(); // Refresh list sekolahsetState(() {_complaintKey = UniqueKey();});}// [BARU HELPER] Fungsi untuk mem-parse oldNotes yang berisi hack dataString _formatRequestNotes(String type, String notes) {if (notes.isEmpty) return 'Tidak ada catatan tambahan.';try {if (type == 'Perubahan Jadwal') {final scheduleMatch = RegExp(r'REQ_JADWAL: ({.*?})').firstMatch(notes);final toleranceMatch = RegExp(r'REQ_TOLERANCE: (\d+)',).firstMatch(notes);final noteMatch = RegExp(r'Note: (.*)').firstMatch(notes);String schedule = 'Jadwal Rutin: N/A';if (scheduleMatch != null && scheduleMatch.group(1) != null) {final Map<String, dynamic> scheduleMap = jsonDecode(scheduleMatch.group(1)!,);final List<String> entries = [];scheduleMap.forEach((day, time) {entries.add('$day: ${(time as String).substring(0, 5)}');});schedule = 'Jadwal Baru: ${entries.join(', ')}';}final tolerance = toleranceMatch?.group(1) ?? 'N/A';final userNote = noteMatch?.group(1) ?? '';return '$schedule (Toleransi: $tolerance mnt). Catatan: "$userNote"';} else if (type == 'Tambah/Kurang Porsi') {final portionMatch = RegExp(r'REQ_PORSI: (\d+)').firstMatch(notes);final userNote =RegExp(r'Note: (.*)').firstMatch(notes)?.group(1) ?? '';final newPortion = portionMatch?.group(1) ?? 'N/A';return 'Diajukan Porsi Baru: $newPortion Siswa. Catatan: "$userNote"';} else if (type == 'Perubahan Menu') {if (notes.contains('REQ_MENU_SET_CUSTOM:')) {final nameMatch = RegExp(r'NEW_NAME: (.*?) \|').firstMatch(notes);final newSetName = nameMatch?.group(1)?.trim() ?? 'Set Kustom Baru';return 'Ajuan Set Menu Kustom: "$newSetName" (Akan dibuatkan set baru di DB).';} else if (notes.contains('REQ_MENU_SET_ID:')) {final newNameMatch = RegExp(r'NEW_NAME: (.*?) \|').firstMatch(notes);final newSetName =newNameMatch?.group(1)?.trim() ?? 'Set Baru Dipilih';return 'Ganti Set Rutin ke: "$newSetName".';}// Fallback untuk skenario lama (jika masih ada data lama)else if (notes.contains('REQ_MENU:')) {final menuNames = notes.split('|')[0].replaceAll("REQ_MENU:", "").trim();final userNote =RegExp(r'Note: (.*)').firstMatch(notes)?.group(1) ?? '';return 'Ganti Item Menu Lama: $menuNames. Catatan: "$userNote"';}}} catch (e) {return 'Gagal memformat catatan (Raw Data: $notes)';}return notes;}// --- APPROVAL DIALOG (Untuk Request) ---void _showApprovalDialog(ChangeRequestModel request) {final noteController = TextEditingController();showDialog(context: context,builder: (ctx) => AlertDialog(title: Text("Review: ${request.type}"),content: Column(mainAxisSize: MainAxisSize.min,crossAxisAlignment: CrossAxisAlignment.start,children: [Text("Sekolah: ${request.schoolName}",style: const TextStyle(fontWeight: FontWeight.bold),),const SizedBox(height: 10),Container(padding: const EdgeInsets.all(8),color: Colors.grey[200],width: double.infinity,child: Text(_formatRequestNotes(request.type,request.oldNotes,), // <-- GUNAKAN HELPER), // Shows the formatted request data),const SizedBox(height: 15),const Text("Catatan Admin (Alasan Ditolak/Info):"),TextField(controller: noteController,maxLines: 2,decoration: const InputDecoration(border: OutlineInputBorder()),),],),actions: [TextButton(onPressed: () async {if (noteController.text.isEmpty) {if (!mounted) return;ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Wajib isi alasan penolakan!")),);return;}Navigator.pop(ctx);await _requestService.respondRequest(requestId: request.id,status: 'rejected',adminNote: noteController.text,requestData: request, // <--- CRITICAL: Pass the data object);setState(() {});},child: const Text("TOLAK", style: TextStyle(color: Colors.red)),),ElevatedButton(onPressed: () async {Navigator.pop(ctx);// "Apply Changes" logic is handled in the service for Menu/Porsiawait _requestService.respondRequest(requestId: request.id,status: 'approved',adminNote: noteController.text.isEmpty? "OK": noteController.text,requestData: request, // <--- CRITICAL: Pass the data object);setState(() {});if (!mounted) return;ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Disetujui & Data Diupdate!")),);},style: ElevatedButton.styleFrom(backgroundColor: Colors.green,foregroundColor: Colors.white,),child: const Text("TERIMA & TERAPKAN"),),],),);}@overrideWidget build(BuildContext context) {return Scaffold(appBar: AppBar(title: const Text("Pusat Informasi"), // Renamed from Pusat PengaduanbackgroundColor: Colors.orange[800],foregroundColor: Colors.white,actions: [IconButton(icon: const Icon(Icons.refresh), // ADD REFRESH BUTTONonPressed: _refreshData,),],bottom: TabBar(controller: _tabController,indicatorColor: Colors.white,labelColor: Colors.white,unselectedLabelColor: Colors.white70,tabs: const [Tab(text: "Pengajuan (Request)"),Tab(text: "Pengaduan (Complain)"),],),),body: TabBarView(controller: _tabController,children: [_buildRequestList(),_buildComplaintList(key: _complaintKey), // Use the dynamic key],),);}// --- WIDGET LIST PENGAJUAN (REQUEST) ---Widget _buildRequestList() {// Dropdown items untuk filter sekolahfinal List<DropdownMenuItem<String?>> schoolItems = [const DropdownMenuItem(value: null, child: Text("Semua Sekolah")),..._allSppgSchools.map((school) =>DropdownMenuItem(value: school.id, child: Text(school.name)),),];// Panggil FutureBuilder dengan filter yang berlaku saat inireturn Column(children: [// FILTER SectionPadding(padding: const EdgeInsets.all(8.0),child: Row(children: [// Filter TanggalExpanded(child: ListTile(leading: const Icon(Icons.calendar_today,color: Colors.indigo,),title: Text(DateFormat('d MMMM yyyy','id_ID',).format(_selectedComplaintDate),),onTap: () async {final DateTime? picked = await showDatePicker(context: context,initialDate: _selectedComplaintDate,firstDate: DateTime(2024),lastDate: DateTime(2030),);if (picked != null) {setState(() {_selectedComplaintDate = picked;_refreshData();});}},),),// Filter SekolahExpanded(child: DropdownButtonFormField<String?>(value: _selectedSchoolFilterId,decoration: const InputDecoration(labelText: "Filter Sekolah",),items: schoolItems,onChanged: (String? newValue) {setState(() {_selectedSchoolFilterId = newValue;_refreshData();});},),),],),),const Divider(height: 1),// List PengajuanExpanded(child: FutureBuilder<List<ChangeRequestModel>>(// Panggil service dengan filterfuture: _requestService.getIncomingRequests(date: _selectedComplaintDate,schoolId: _selectedSchoolFilterId,),builder: (context, snapshot) {if (snapshot.connectionState == ConnectionState.waiting)return const Center(child: CircularProgressIndicator());final data = snapshot.data ?? [];if (data.isEmpty)return const Center(child: Text("Tidak ada pengajuan masuk sesuai filter."),);return ListView.builder(itemCount: data.length,itemBuilder: (ctx, i) {final item = data[i];bool isPending = item.status == 'pending';final formattedNotes = _formatRequestNotes(item.type,item.oldNotes,);return Card(margin: const EdgeInsets.all(8),child: ListTile(leading: Icon(item.type.contains("Menu")? Icons.restaurant_menu: (item.type.contains("Porsi")? Icons.pie_chart: Icons.calendar_today),color: Colors.indigo,),title: Text(item.schoolName,style: const TextStyle(fontWeight: FontWeight.bold),),subtitle: Column(crossAxisAlignment: CrossAxisAlignment.start,children: [Text("[${item.type}]"),Text(formattedNotes, // <-- GUNAKAN FORMAT BARUmaxLines: 2,overflow: TextOverflow.ellipsis,),if (!isPending)Text("Status: ${item.status.toUpperCase()} (${item.adminResponse})",style: TextStyle(color: item.status == 'approved'? Colors.green: Colors.red,fontWeight: FontWeight.bold,),),],),trailing: isPending? ElevatedButton(onPressed: () => _showApprovalDialog(item),child: const Text("Review"),): const Icon(Icons.check_circle, color: Colors.grey),),);},);},),),],);}// --- WIDGET LIST PENGADUAN (COMPLAINT) ---Widget _buildComplaintList({required Key key}) {if (_isLoadingSchools) {return const Center(child: CircularProgressIndicator());}// Dropdown items untuk filter sekolahfinal List<DropdownMenuItem<String?>> schoolItems = [const DropdownMenuItem(value: null, child: Text("Semua Sekolah")),..._allSppgSchools.map((school) =>DropdownMenuItem(value: school.id, child: Text(school.name)),),];return Column(children: [Padding(padding: const EdgeInsets.all(8.0),child: Row(children: [// Filter TanggalExpanded(child: ListTile(leading: const Icon(Icons.calendar_today,color: Colors.indigo,),title: Text(DateFormat('d MMMM yyyy','id_ID',).format(_selectedComplaintDate),),onTap: () async {final DateTime? picked = await showDatePicker(context: context,initialDate: _selectedComplaintDate,firstDate: DateTime(2024),lastDate: DateTime(2030),);if (picked != null) {setState(() {_selectedComplaintDate = picked;_refreshData();});}},),),// Filter SekolahExpanded(child: DropdownButtonFormField<String?>(value: _selectedSchoolFilterId,decoration: const InputDecoration(labelText: "Filter Sekolah",),items: schoolItems,onChanged: (String? newValue) {setState(() {_selectedSchoolFilterId = newValue;_refreshData();});},),),],),),const Divider(height: 1),// List PengaduanExpanded(child: FutureBuilder<List<Map<String, dynamic>>>(key: key,// Panggil service dengan filterfuture: _complaintService.getSppgComplaints(date: _selectedComplaintDate,schoolId: _selectedSchoolFilterId,),builder: (context, snapshot) {if (snapshot.connectionState == ConnectionState.waiting) {return const Center(child: CircularProgressIndicator());}if (snapshot.hasError) {return Center(child: Text("Error: ${snapshot.error}"));}final data = snapshot.data ?? [];if (data.isEmpty) {return const Center(child: Text("Tidak ada keluhan masuk sesuai filter."),);}return ListView.builder(itemCount: data.length,itemBuilder: (ctx, i) {final item = data[i];final isResolved = item['admin_response'] != null;final reporterRole = item['reporter_role'] ?? 'N/A';// Tentukan target table dan ID untuk update// ID complaint di RPC (item['id']) adalah ID PRIMARY KEY di CR/DSfinal targetTable = reporterRole == 'walikelas'? 'class_receptions': 'delivery_stops';final targetId = item['id'];return Card(color: isResolved ? Colors.green[50] : Colors.red[100],margin: const EdgeInsets.symmetric(horizontal: 10,vertical: 6,),child: ListTile(onTap: () => _showRespondComplaintDialog(item,reporterRole,targetTable,targetId,),leading: Icon(isResolved ? Icons.check_circle : Icons.warning,color: isResolved ? Colors.green : Colors.red,),title: Text(item['school_name'] ?? 'Sekolah N/A',style: const TextStyle(fontWeight: FontWeight.bold),),subtitle: Column(crossAxisAlignment: CrossAxisAlignment.start,children: [Text("Dari: ${item['reporter_name']} (${reporterRole.toUpperCase()})",),// [FIX KRITIS]: Gunakan helper untuk mengurai JSONText("Rincian Isu:\n${_formatComplaintDetails(reporterRole, item['notes'])}",// notes di sini seharusnya adalah issue_details JSONB// Namun karena RPC mengembalikan 'notes', kita asumsikan 'notes' = JSONB issues),Text(isResolved? "Respon: ${item['admin_response']}": "Status: BELUM DITINDAK LANJUT",style: TextStyle(fontSize: 12,color: isResolved? Colors.green[800]: Colors.red[800],fontWeight: FontWeight.bold,),),],),trailing: isResolved? const Icon(Icons.reply, color: Colors.grey): ElevatedButton(onPressed: () => _showRespondComplaintDialog(item,reporterRole,targetTable,targetId,),child: const Text("Tindak Lanjut"),),),);},);},),),],);}// [BARU HELPER] Mengurai JSON Issue Details dari Koordinator/Wali KelasString _formatComplaintDetails(String reporterRole, String rawNotes) {if (rawNotes.isEmpty) return 'Tidak ada detail spesifik.';// Kasus 1: Laporan Koordinator (Diharapkan format JSON Array dari issue_details)if (reporterRole == 'koordinator') {try {String cleanedNotes = rawNotes.trim();// [FIX KRITIS JSON STRING]: Hapus quotes ganda di awal/akhir// Ini mengatasi masalah jika PostgREST mengembalikan JSONB sebagai string ber-quote.if (cleanedNotes.startsWith('"') && cleanedNotes.endsWith('"')) {cleanedNotes = cleanedNotes.substring(1, cleanedNotes.length - 1);}// Hapus escape character '\' yang mungkin tersisacleanedNotes = cleanedNotes.replaceAll(r'\"', '"');final List<dynamic> issues = jsonDecode(cleanedNotes,); // <-- Coba decode string yang sudah dibersihkanif (issues.isEmpty) return 'Diterima, tetapi detail masalah kosong.';return issues.mapIndexed((index, issue) {final type = issue['type'] ?? 'Masalah Umum';final notes = issue['notes']?.trim() ?? '—';final qty = issue['qty_impacted'];String qtyStr = '';if (type == 'Jumlah Tidak Sesuai') {qtyStr = ' (Defisit: ${qty} Porsi)';} else if (type == 'Kemasan Rusak') {qtyStr = ' (Rusak: ${qty} Kotak)';} else if (type == 'Terlambat') {qtyStr = ' (Telat: ${qty} Menit)';}return '${index + 1}. [${type}]${qtyStr}. Detail: "${notes}"';}).join('\n');} catch (e) {return 'Detail Masalah JSON Rusak. Raw Data: $rawNotes';}}// Kasus 2: Laporan Wali Kelas (Masih menggunakan format notes lama/tunggal)else {return rawNotes;}}// Helper untuk menampilkan dialog gambar (Disalin dari EditRouteScreen)void _showImageDialog(BuildContext context, String url, String title) {showDialog(context: context,builder: (ctx) => AlertDialog(title: Text(title),content: SizedBox(width: MediaQuery.of(context).size.width * 0.9,height: MediaQuery.of(context).size.height * 0.7,child: Image.network(url, fit: BoxFit.contain),),actions: [TextButton(onPressed: () => Navigator.pop(ctx),child: const Text("Tutup"),),],),);}void _showRespondComplaintDialog(Map<String, dynamic> complaint,String reporterRole,String targetTable,String targetTableId,) {final responseController = TextEditingController();final issueDetailsText = _formatComplaintDetails(reporterRole,complaint['notes'],);// [BARU]: Ambil URL Foto dari item (asumsi sudah ditarik di RPC)final photoUrl = complaint['proof_photo_url'];final receivedQty = complaint['received_qty']; // Ambil kuantitas (jika ada)showDialog(context: context,builder: (ctx) => AlertDialog(title: const Text("Tindak Lanjut Keluhan"),content: SingleChildScrollView(child: Column(mainAxisSize: MainAxisSize.min,crossAxisAlignment: CrossAxisAlignment.start,children: [// Detail Pengaduanconst Text("Detail Pengaduan:",style: TextStyle(fontWeight: FontWeight.bold,color: Colors.red,),),const SizedBox(height: 5),// Kuantitas Diterima (relevan untuk Koordinator)if (receivedQty != null)Text("Kuantitas Diterima: $receivedQty Porsi",style: const TextStyle(fontWeight: FontWeight.w500),),const SizedBox(height: 10),// Rincian Isu (Formatted)Container(padding: const EdgeInsets.all(8),width: double.infinity,decoration: BoxDecoration(color: Colors.red[100],border: Border.all(color: Colors.red),borderRadius: BorderRadius.circular(5),),child: SelectableText(issueDetailsText,style: const TextStyle(fontSize: 13),),),// [BARU]: BUKTI FOTOif (photoUrl != null) ...[const SizedBox(height: 15),const Text("Bukti Foto Pelapor:",style: TextStyle(fontWeight: FontWeight.bold),),const SizedBox(height: 8),GestureDetector(onTap: () => _showImageDialog(ctx,photoUrl,"Bukti dari ${complaint['reporter_name']}",),child: Container(height: 100,width: 100,decoration: BoxDecoration(borderRadius: BorderRadius.circular(5),image: DecorationImage(image: NetworkImage(photoUrl),fit: BoxFit.cover,),border: Border.all(color: Colors.grey),),child: const Icon(Icons.zoom_in, color: Colors.white70),),),],const SizedBox(height: 20),const Text("Respon Admin:",style: TextStyle(fontWeight: FontWeight.bold),),// Text Form Field ResponTextFormField(controller: responseController,maxLines: 4,keyboardType: TextInputType.multiline,decoration: InputDecoration(labelText: "Instruksi / Tindak Lanjut Admin SPPG",hintText: "Contoh: Sudah kami cek...",border: const OutlineInputBorder(),),),],),),actions: [TextButton(onPressed: () => Navigator.pop(ctx),child: const Text("BATAL"),),ElevatedButton(onPressed: () async {if (responseController.text.isEmpty) {ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Wajib isi instruksi!")),);return;}Navigator.pop(ctx);// Cek ID Penerima Notifikasi (ID user profiles/auth)String finalReporterUserId;try {// Panggil service untuk mendapatkan ID user yang benar-benar melaporfinalReporterUserId = await _complaintService.getReporterIdForNotification(targetTableId, reporterRole);} catch (e) {if (mounted)ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Gagal tentukan penerima notifikasi: $e"),backgroundColor: Colors.red,),);return;}await _complaintService.respondToComplaint(id: complaint['id'], // ID unik complaint (dari RPC)response: responseController.text,reporterId:finalReporterUserId, // ID user yang akan dapat notifreporterRole: reporterRole,targetTableId: targetTableId,targetTableName: targetTable,);_refreshData();if (mounted) {ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Tindak Lanjut & Notifikasi Terkirim!"),backgroundColor: Colors.green,),);}},child: const Text("KIRIM INSTRUKSI"),),],),);}}

=== FILE: lib/features/admin_sppg/screens/route_calendar_screen.dart ===
// === FILE: lib/features/admin_sppg/screens/route_calendar_screen.dart ===import 'package:flutter/material.dart';import 'package:table_calendar/table_calendar.dart';import 'package:intl/intl.dart';import 'dart:convert';import '../services/school_service.dart';import '../../../models/school_model.dart';// Mapping for days (Mon-Sat)const List<String> _days = ['Senin','Selasa','Rabu','Kamis','Jumat','Sabtu',];class RouteCalendarScreen extends StatefulWidget {const RouteCalendarScreen({super.key});@overrideState<RouteCalendarScreen> createState() => _RouteCalendarScreenState();}class _RouteCalendarScreenState extends State<RouteCalendarScreen> {final SchoolService _schoolService = SchoolService();// Define today at midnight for accurate comparisonfinal DateTime _today = DateTime(DateTime.now().year,DateTime.now().month,DateTime.now().day,);DateTime _focusedDay = DateTime.now();DateTime _selectedDay = DateTime.now();CalendarFormat _calendarFormat = CalendarFormat.month;bool _isLoading = true;Map<DateTime, List<Map<String, String>>> _dailySchedules = {};List<School>? _allSchools;@overridevoid initState() {super.initState();// Initialize selected day to today_selectedDay = _today;_focusedDay = _today;_fetchSchoolSchedules();}String _mapDayToLocal(int day) {switch (day) {case 1:return 'Senin';case 2:return 'Selasa';case 3:return 'Rabu';case 4:return 'Kamis';case 5:return 'Jumat';case 6:return 'Sabtu';default:return 'Minggu';}}Future<void> _fetchSchoolSchedules() async {setState(() => _isLoading = true);try {_allSchools = await _schoolService.getMySchools();// VITAL CHANGE: Define the 30-day window (Start from today, end 30 days later)final start = _today;final end = _today.add(const Duration(days: 30));Map<DateTime, List<Map<String, String>>> newSchedules = {};for (var day = start;day.isBefore(end.add(const Duration(days: 1)));day = day.add(const Duration(days: 1))) {final localDayName = _mapDayToLocal(day.weekday);final dateKey = DateTime(day.year, day.month, day.day);List<Map<String, String>> dailyList = [];for (var school in _allSchools!) {try {// NOTE: We assume the JSON string is in school.deadlineTimefinal Map<String, dynamic> scheduleMap = jsonDecode(school.deadlineTime!,);if (scheduleMap.containsKey(localDayName)) {final deadline = scheduleMap[localDayName]; // e.g., "10:00:00"// Calculate Expected Arrival (Deadline - Tolerance)final tolerance = school.toleranceMinutes;final deadlineParts = deadline.split(':');final deadlineTime = TimeOfDay(hour: int.parse(deadlineParts[0]),minute: int.parse(deadlineParts[1]),);final arrivalDt = DateTime(day.year,day.month,day.day,deadlineTime.hour,deadlineTime.minute,).subtract(Duration(minutes: tolerance));dailyList.add({'schoolName': school.name,'deadline': deadline,'arrival': DateFormat('HH:mm:ss').format(arrivalDt),'isHighRisk': school.isHighRisk.toString(),});}} catch (_) {// Ignore schools with malformed or missing schedule JSON}}// --- SORTING: Sort the daily list by Deadline Time (HH:mm:ss) ---dailyList.sort((a, b) => a['deadline']!.compareTo(b['deadline']!));newSchedules[dateKey] = dailyList;}if (mounted) {setState(() {_dailySchedules = newSchedules;_isLoading = false;});}} catch (e) {if (mounted) {ScaffoldMessenger.of(context,).showSnackBar(SnackBar(content: Text("Gagal load jadwal rutin: $e")));setState(() => _isLoading = false);}}}List<Map<String, String>> _getEventsForDay(DateTime day) {// Access schedule map using the passed 'day' object (at midnight)final dateKey = DateTime(day.year, day.month, day.day);return _dailySchedules[dateKey] ?? [];}@overrideWidget build(BuildContext context) {// Define today at midnight and the end of the 30-day windowfinal DateTime calendarStart = _today;final DateTime calendarEnd = _today.add(const Duration(days: 30));return Scaffold(appBar: AppBar(title: const Text("Jadwal Pengiriman Rutin (30 Hari)"),backgroundColor: Colors.indigo,foregroundColor: Colors.white,),body: _isLoading? const Center(child: CircularProgressIndicator()): Column(children: [TableCalendar(// VITAL FIX 1: Set firstDay to today's date (calendarStart)firstDay: calendarStart,// VITAL FIX 2: Set lastDay to 30 days from todaylastDay: calendarEnd,// VITAL FIX 3: Ensure focusedDay starts at calendarStart if it somehow drifts backwardsfocusedDay: _focusedDay.isBefore(calendarStart)? calendarStart: _focusedDay,// VITAL FIX: Use selectedDayPredicate to highlight selected dayselectedDayPredicate: (day) => isSameDay(_selectedDay, day),calendarFormat: _calendarFormat,headerStyle: const HeaderStyle(formatButtonVisible: false,titleCentered: true,),calendarStyle: const CalendarStyle(markerDecoration: BoxDecoration(color: Colors.red,shape: BoxShape.circle,),// Highlight days outside the 30-day range differently (or disable)disabledDecoration: BoxDecoration(),),eventLoader: _getEventsForDay,onDaySelected: (selectedDay, focusedDay) {// Only allow selection within the 30-day windowif (selectedDay.isBefore(calendarStart) ||selectedDay.isAfter(calendarEnd))return;if (!isSameDay(_selectedDay, selectedDay)) {setState(() {_selectedDay = selectedDay;_focusedDay = focusedDay;});}},onPageChanged: (focusedDay) {// VITAL FIX 4: Prevent focusedDay from going before calendarStartif (focusedDay.isBefore(calendarStart)) {_focusedDay = calendarStart;} else {_focusedDay = focusedDay;}_fetchSchoolSchedules();// We only load data for a tight window now, so reloading monthly data is less critical, but kept for robustness if month changes significantly.// _fetchSchoolSchedules();},onFormatChanged: (format) {setState(() => _calendarFormat = format);},),const Divider(thickness: 1),// VITAL FIX: Display list for the selected day (_selectedDay)Expanded(child: ListView(children: _getEventsForDay(_selectedDay).map((schedule) {final isHighRisk = schedule['isHighRisk'] == 'true';// Display friendly time format (HH:mm)final deadlineDisplay = schedule['deadline']!.substring(0,5,);final arrivalDisplay = schedule['arrival']!.substring(0,5,);return Card(color: isHighRisk ? Colors.red[50] : Colors.white,margin: const EdgeInsets.symmetric(horizontal: 16,vertical: 4,),child: ListTile(leading: Icon(Icons.school,color: isHighRisk ? Colors.red : Colors.indigo,),title: Text(schedule['schoolName']!,style: const TextStyle(fontWeight: FontWeight.bold),),subtitle: Column(crossAxisAlignment: CrossAxisAlignment.start,children: [Text("Deadline Konsumsi: $deadlineDisplay"),Text("Est. Tiba Kurir: $arrivalDisplay",style: const TextStyle(fontWeight: FontWeight.bold,),),],),trailing: isHighRisk? const Text('HIGH RISK',style: TextStyle(color: Colors.red,fontWeight: FontWeight.bold,),): null,),);}).toList(),),),],),);}}

=== FILE: lib/features/admin_sppg/services/courier_service.dart ===
import 'dart:convert';import 'package:http/http.dart' as http;import 'package:supabase_flutter/supabase_flutter.dart';import '../../../models/courier_model.dart';class CourierService {final _supabase = Supabase.instance.client;Future<String> _getMySppgId() async {final userId = _supabase.auth.currentUser!.id;final profile = await _supabase.from('profiles').select('sppg_id').eq('id', userId).single();return profile['sppg_id'];}Future<List<CourierModel>> getMyCouriers() async {try {final mySppgId = await _getMySppgId();// [UPDATE SELECT] Tambahkan phone_numberfinal response = await _supabase.from('profiles').select('id, full_name, email, sppg_id, phone_number',) // <-- Tambah phone_number.eq('sppg_id', mySppgId).eq('role', 'kurir');final List<dynamic> data = response;return data.map((json) => CourierModel.fromJson(json)).toList();} catch (e) {throw Exception('Gagal ambil data kurir: $e');}}Future<void> createCourierAccount({required String email,required String password,required String fullName,required String phoneNumber,}) async {const String projectUrl = 'https://mqyfrqgfpqwlrloqtpvi.supabase.co';const String anonKey ='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1xeWZycWdmcHF3bHJsb3F0cHZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0NTMxMDMsImV4cCI6MjA3OTAyOTEwM30.KoXKouhFN0H7Iz9MSnRhFQuBIePVMwWyXmrzSv3rEeQ';try {final myUserId = _supabase.auth.currentUser!.id;final profile = await _supabase.from('profiles').select('sppg_id').eq('id', myUserId).single();final String mySppgId = profile['sppg_id'];// A. Request Signup (Signup Supabase Auth)// NOTE: Kita tidak bisa langsung pass phone_number via sign up method API anon key// Kita akan update profiles setelah user dibuat.final url = Uri.parse('$projectUrl/auth/v1/signup');final response = await http.post(url,headers: {'Content-Type': 'application/json', 'apikey': anonKey},body: jsonEncode({'email': email.trim(),'password': password,'data': {'full_name': fullName},}),);if (response.statusCode == 200 || response.statusCode == 201) {final responseData = jsonDecode(response.body);String? newUserId = responseData['id'] ?? responseData['user']['id'];if (newUserId == null) throw Exception("Gagal dapat ID User Kurir.");// B. Simpan ke Profiles (Role: kurir, sppg_id, phone_number)await _supabase.from('profiles').insert({'id': newUserId,'full_name': fullName,'email': email.trim(),'role': 'kurir','sppg_id': mySppgId,'school_id': null,'phone_number': phoneNumber, // [BARU] Simpan nomor telepon});} else {final errorData = jsonDecode(response.body);throw Exception(errorData['msg'] ?? 'Gagal mendaftar');}} catch (e) {if (e.toString().contains("User already registered")) {throw Exception("Email kurir sudah terdaftar!");}throw Exception('Gagal buat akun kurir: $e');}}// [BARU] 3. HAPUS AKUN KURIR (Delete Auth User)Future<void> deleteCourierAccount(String userId) async {try {// Hapus akun dari Auth.users. Ini akan otomatis menghapus dari profiles.await _supabase.rpc('delete_user_and_profile',params: {'user_id_input': userId},);} catch (e) {throw Exception('Gagal hapus akun kurir: $e');}}// [BARU] 4. UPDATE AKUN KURIRFuture<void> updateCourierAccount(String userId,Map<String, dynamic> data,) async {try {// Tambahkan update email di auth.users jika email berubah (meskipun kita utamakan profiles)final profileUpdateData = data..remove('email');// Update data di tabel profilesawait _supabase.from('profiles').update(profileUpdateData).eq('id', userId);} catch (e) {throw Exception('Gagal update akun kurir: $e');}}}

=== FILE: lib/features/admin_sppg/services/school_service.dart ===
import 'package:supabase_flutter/supabase_flutter.dart';import '../../../models/school_model.dart'; // Sesuaikan path import iniclass SchoolService {final _supabase = Supabase.instance.client;// Helper untuk mendapatkan SPPG ID (menangani kasus NULL)Future<String> _getMySppgId() async {final userId = _supabase.auth.currentUser!.id;final profile = await _supabase.from('profiles').select('sppg_id').eq('id', userId).single();final String? mySppgId = profile['sppg_id'];// Melempar exception jika SPPG ID null, karena SchoolService hanya untuk Admin SPPG.if (mySppgId == null) {throw Exception("User profile tidak memiliki ID SPPG. Akses Ditolak!");}return mySppgId;}// --- 1. AMBIL DATA SEKOLAH (KHUSUS SPPG YG LOGIN) ---Future<List<School>> getMySchools() async {try {// Langkah A & B: Cek ID SPPG user ini (menggunakan helper baru)final String mySppgId = await _getMySppgId();// Langkah C: Ambil sekolah yang sppg_id nya SAMA dengan punya userfinal response = await _supabase.from('schools').select().eq('sppg_id', mySppgId) // Filter penting!.order('name', ascending: true); // Urutkan abjadfinal List<dynamic> data = response;return data.map((json) => School.fromJson(json)).toList();} catch (e) {// Menangkap error dari _getMySppgId atau error Supabase lainnyathrow Exception('Gagal mengambil data sekolah: ${e.toString()}');}}// --- 2. TAMBAH SEKOLAH BARU ---Future<void> createSchool(Map<String, dynamic> schoolData) async {try {// Kita perlu inject 'sppg_id' otomatis biar admin gak perlu input manualfinal userId = _supabase.auth.currentUser!.id;final profile = await _supabase.from('profiles').select('sppg_id').eq('id', userId).single();// Lakukan null check secara eksplisit di sini atau gunakan helper barufinal String? mySppgId = profile['sppg_id'];if (mySppgId == null) {throw Exception("Profil Admin tidak terhubung ke SPPG.");}// Masukkan ID SPPG ke dalam data yang mau dikirimschoolData['sppg_id'] = mySppgId;// Kirim ke tabel 'schools'await _supabase.from('schools').insert(schoolData);} catch (e) {throw Exception('Gagal menambah sekolah: $e');}}// --- 3. HAPUS SEKOLAH ---Future<void> deleteSchool(String schoolId) async {try {await _supabase.from('schools').delete().eq('id', schoolId);} catch (e) {throw Exception('Gagal menghapus sekolah: $e');}}// --- 4. UPDATE DATA SEKOLAH (BARU) ---Future<void> updateSchool(String schoolId,Map<String, dynamic> schoolData,) async {try {// Kita tidak perlu update sppg_id karena itu tidak berubahawait _supabase.from('schools').update(schoolData).eq('id', schoolId);} catch (e) {throw Exception('Gagal mengupdate sekolah: $e');}}Future<List<School>> getSchoolsBySppgId(String sppgId) async {try {final response = await _supabase.from('schools').select().eq('sppg_id', sppgId).order('name', ascending: true);final List<dynamic> data = response;return data.map((json) => School.fromJson(json)).toList();} catch (e) {throw Exception('Gagal ambil sekolah: $e');}}}

=== FILE: lib/features/admin_sppg/services/coordinator_service.dart ===
import 'dart:convert';import 'package:http/http.dart' as http;import 'package:supabase_flutter/supabase_flutter.dart';class CoordinatorModel {final String id;final String name;final String email;final String schoolName; // Biar kita tau dia jaga di sekolah manafinal String? schoolId;final String? phoneNumber; // [BARU]CoordinatorModel({required this.id,required this.name,required this.email,required this.schoolName,required this.schoolId,required this.phoneNumber,});factory CoordinatorModel.fromJson(Map<String, dynamic> json) {final school = json['schools'] != null? json['schools']['name']: 'Belum ditentukan';return CoordinatorModel(id: json['id'].toString(),name: json['full_name'] ?? 'Tanpa Nama',email: json['email'] ?? '-',schoolName: school,schoolId: json['school_id']?.toString(),phoneNumber: json['phone_number'] ?? json['phone'], // [BARU]);}}class CoordinatorService {final _supabase = Supabase.instance.client;// 1. AMBIL LIST KOORDINATOR (Milik SPPG Ini)Future<List<CoordinatorModel>> getMyCoordinators() async {try {final userId = _supabase.auth.currentUser!.id;final profile = await _supabase.from('profiles').select('sppg_id').eq('id', userId).single();final String mySppgId = profile['sppg_id'];// [UPDATE SELECT] Tambahkan phone_numberfinal response = await _supabase.from('profiles').select('id, full_name, email, school_id, schools(name), phone_number', // <--- PASTIKAN 'school_id' ADA DI SINI).eq('sppg_id', mySppgId).eq('role', 'koordinator');final List<dynamic> data = response;return data.map((json) => CoordinatorModel.fromJson(json)).toList();} catch (e) {throw Exception('Gagal ambil data koordinator: $e');}}// 2. BUAT AKUN KOORDINATOR BARUFuture<void> createCoordinatorAccount({required String email,required String password,required String fullName,required String schoolId, // Wajib adarequired String phoneNumber,}) async {// Kredensial Supabase (Sama kayak courier service)const String projectUrl = 'https://mqyfrqgfpqwlrloqtpvi.supabase.co';const String anonKey ='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1xeWZycWdmcHF3bHJsb3F0cHZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0NTMxMDMsImV4cCI6MjA3OTAyOTEwM30.KoXKouhFN0H7Iz9MSnRhFQuBIePVMwWyXmrzSv3rEeQ';try {final myUserId = _supabase.auth.currentUser!.id;final profile = await _supabase.from('profiles').select('sppg_id').eq('id', myUserId).single();final String mySppgId = profile['sppg_id'];// A. Request Signupfinal url = Uri.parse('$projectUrl/auth/v1/signup');final response = await http.post(url,headers: {'Content-Type': 'application/json', 'apikey': anonKey},body: jsonEncode({'email': email.trim(),'password': password,'data': {'full_name': fullName},}),);if (response.statusCode == 200 || response.statusCode == 201) {final responseData = jsonDecode(response.body);String? newUserId = responseData['id'] ?? responseData['user']['id'];if (newUserId == null) throw Exception("Gagal dapat ID User.");// B. Simpan ke Profilesawait _supabase.from('profiles').insert({'id': newUserId,'full_name': fullName,'email': email.trim(),'role': 'koordinator','sppg_id': mySppgId,'school_id': schoolId,'phone_number': phoneNumber, // [BARU] Simpan nomor telepon});} else {final errorData = jsonDecode(response.body);throw Exception(errorData['msg'] ?? 'Gagal mendaftar');}} catch (e) {if (e.toString().contains("User already registered")) {throw Exception("Email sudah terdaftar!");}throw Exception('Gagal buat akun: $e');}}/// [BARU] 3. UPDATE AKUN KOORDINATORFuture<void> updateCoordinatorAccount(String userId,Map<String, dynamic> data,) async {try {// Update data di tabel profilesawait _supabase.from('profiles').update(data).eq('id', userId);} catch (e) {throw Exception('Gagal update akun koordinator: $e');}}// [BARU] 4. HAPUS AKUN KOORDINATOR (Delete Auth User)Future<void> deleteCoordinatorAccount(String userId) async {try {// Hapus akun dari Auth.users. Ini akan otomatis menghapus dari profiles.await _supabase.rpc('delete_user_and_profile',params: {'user_id_input': userId},);} catch (e) {throw Exception('Gagal hapus akun koordinator: $e');}}}

=== FILE: lib/features/admin_sppg/services/menu_service.dart ===
import 'package:supabase_flutter/supabase_flutter.dart';import '../../../models/menu_model.dart';import '../../../models/sppg_model.dart';import 'dart:convert';import 'package:collection/collection.dart';// [BARU MODEL] Model untuk menyimpan Menu Set yang dibuat Adminclass AdminMenuSetModel {final String id;final String sppgId;final String setName;final String? karboId;final String? proteinId;final String? sayurId;final String? buahId;final String? nabatiId;final String? pelengkapId; // Opsional// [BARU TOTAL GIZI]final int totalEnergy;final double totalProtein;final double totalFat;final double totalCarbs;// NAMA MENU (untuk display di UI)final Map<String, String> menuNames;AdminMenuSetModel({required this.id,required this.sppgId,required this.setName,this.karboId,this.proteinId,this.sayurId,this.buahId,this.nabatiId,this.pelengkapId,required this.menuNames,// [BARU TOTAL GIZI]this.totalEnergy = 0,this.totalProtein = 0.0,this.totalFat = 0.0,this.totalCarbs = 0.0,});factory AdminMenuSetModel.fromJson(Map<String, dynamic> json) {// Helper untuk parsing double, default 0.0double parseDouble(dynamic value) {if (value is num) return value.toDouble();if (value is String) return double.tryParse(value) ?? 0.0;return 0.0;}// Logic untuk membaca menuNames dari join (jika ada)final Map<String, String> names = {};if (json['karbo_menus'] != null)names['Karbo'] = json['karbo_menus']['name'];if (json['protein_menus'] != null)names['Lauk Protein'] = json['protein_menus']['name'];if (json['sayur_menus'] != null)names['Sayur'] = json['sayur_menus']['name'];if (json['buah_menus'] != null) names['Buah'] = json['buah_menus']['name'];if (json['nabati_menus'] != null)names['Lauk Nabati'] = json['nabati_menus']['name'];if (json['pelengkap_menus'] != null)names['Pelengkap'] = json['pelengkap_menus']['name'];return AdminMenuSetModel(id: json['id'].toString(),sppgId: json['sppg_id'].toString(),setName: json['set_name'] ?? 'Set Menu Baru',karboId: json['karbo_id']?.toString(),proteinId: json['protein_id']?.toString(),sayurId: json['sayur_id']?.toString(),buahId: json['buah_id']?.toString(),nabatiId: json['nabati_id']?.toString(),pelengkapId: json['pelengkap_id']?.toString(),menuNames: names,// [BARU TOTAL GIZI PARSING]totalEnergy: json['total_energy'] != null? int.tryParse(json['total_energy'].toString()) ?? 0: 0,totalProtein: parseDouble(json['total_protein']),totalFat: parseDouble(json['total_fat']),totalCarbs: parseDouble(json['total_carbs']),);}}class MenuService {final _supabase = Supabase.instance.client;Future<String> _getMySppgId() async {final userId = _supabase.auth.currentUser!.id;final profile = await _supabase.from('profiles').select('sppg_id').eq('id', userId).single();return profile['sppg_id'];}// --- MENU SET CRUD ---// [BARU SERVICE] 4. Get All Menu SetsFuture<List<AdminMenuSetModel>> getMyMenuSets() async {try {final mySppgId = await _getMySppgId();final response = await _supabase.from('menu_sets').select('*, karbo_menus:karbo_id(name), protein_menus:protein_id(name), sayur_menus:sayur_id(name), buah_menus:buah_id(name), nabati_menus:nabati_id(name), pelengkap_menus:pelengkap_id(name), total_energy, total_protein, total_fat, total_carbs', // <--- TAMBAHKAN FIELD TOTAL GIZI).eq('sppg_id', mySppgId).order('set_name', ascending: true);final List<dynamic> data = response;return data.map((json) => AdminMenuSetModel.fromJson(json)).toList();} catch (e) {// Throw error tanpa stack trace Supabase untuk UI yang lebih bersihthrow Exception('Gagal mengambil daftar Menu Set: ${e.toString().split("Exception:").last}',);}}// [BARU] 5. Create Menu Set (Perlu menerima data total gizi)Future<void> createMenuSet(Map<String, dynamic> menuSetData) async {try {final mySppgId = await _getMySppgId();menuSetData['sppg_id'] = mySppgId;await _supabase.from('menu_sets').insert(menuSetData);} catch (e) {throw Exception('Gagal menambah Menu Set: $e');}}// [BARU] 6. Update Menu Set (Untuk Edit Screen)Future<void> updateMenuSet(String menuSetId,Map<String, dynamic> menuSetData,) async {try {await _supabase.from('menu_sets').update(menuSetData).eq('id', menuSetId);} catch (e) {throw Exception('Gagal mengedit Menu Set: $e');}}// [BARU] 7. Delete Menu SetFuture<void> deleteMenuSet(String menuSetId) async {try {// Hapus Menu Set dari tabel menu_setsawait _supabase.from('menu_sets').delete().eq('id', menuSetId);// Catatan: Jika ada sekolah yang masih menggunakan Menu Set ini (colomn menu_default menyimpan nama set),// maka column menu_default di sekolah tersebut mungkin perlu direset/update.// Namun, untuk saat ini, kita hanya menghapus set dari tabel menu_sets.} catch (e) {throw Exception('Gagal menghapus Menu Set: $e');}}// Perbarui select di getMyMenus agar mencakup kolom giziFuture<List<Menu>> getMyMenus() async {try {final mySppgId = await _getMySppgId();// [UPDATE SELECT] Tambahkan 4 kolom gizi barufinal response = await _supabase.from('menus').select('*, max_consume_minutes, energy, protein, fat, carbs', // <--- TAMBAHKAN FIELD BARU).eq('sppg_id', mySppgId).order('category', ascending: true);final List<dynamic> data = response;return data.map((json) => Menu.fromJson(json)).toList();} catch (e) {throw Exception('Gagal mengambil daftar menu: $e');}}Future<void> createMenu(Map<String, dynamic> menuData) async {try {final mySppgId = await _getMySppgId();menuData['sppg_id'] = mySppgId;await _supabase.from('menus').insert(menuData);} catch (e) {throw Exception('Gagal menambah menu: $e');}}Future<void> updateMenu(String menuId, Map<String, dynamic> menuData) async {try {// [FIX LOGIC] Memastikan data menu yang diupdate sudah termasuk field baruawait _supabase.from('menus').update(menuData).eq('id', menuId);} catch (e) {throw Exception('Gagal mengedit menu: $e');}}Future<void> deleteMenu(String menuId) async {try {await _supabase.from('menus').delete().eq('id', menuId);} catch (e) {throw Exception('Gagal menghapus menu: $e');}}}

=== FILE: lib/features/admin_sppg/services/teacher_service.dart ===
import 'dart:convert';import 'package:http/http.dart' as http;import 'package:supabase_flutter/supabase_flutter.dart';class TeacherModel {final String id;final String name;final String email;final String schoolName;final String className;final String? schoolId; // <--- ADD THIS FUCKING FIELDfinal String? phoneNumber; // [BARU]// [BARU] Kuota Siswa Kelasfinal int studentCountClass;TeacherModel({required this.id,required this.name,required this.email,required this.schoolName,required this.className,this.schoolId, // <--- ADD TO CONSTRUCTORthis.phoneNumber, // <--- ADD TO CONSTRUCTORthis.studentCountClass = 0, // [BARU]});factory TeacherModel.fromJson(Map<String, dynamic> json) {final school = json['schools'] != null? json['schools']['name']: 'Belum ditentukan';return TeacherModel(id: json['id'].toString(),name: json['full_name'] ?? 'Tanpa Nama',email: json['email'] ?? '-',schoolName: school,className: json['class_name'] ?? '-',schoolId: json['school_id']?.toString(), // <--- PASTI INI ADAphoneNumber: json['phone_number'] ?? json['phone'],studentCountClass: json['student_count_class'] != null? int.tryParse(json['student_count_class'].toString()) ?? 0: 0, // [BARU]);}}class TeacherService {final _supabase = Supabase.instance.client;// 1. AMBIL LIST WALI KELASFuture<List<TeacherModel>> getMyTeachers() async {try {final userId = _supabase.auth.currentUser!.id;final profile = await _supabase.from('profiles').select('sppg_id').eq('id', userId).single();final String mySppgId = profile['sppg_id'];final response = await _supabase.from('profiles').select('id, full_name, email, class_name, school_id, student_count_class, schools(name), phone_number', // <-- Tambahkan student_count_class).eq('sppg_id', mySppgId).eq('role', 'walikelas');final List<dynamic> data = response;return data.map((json) => TeacherModel.fromJson(json)).toList();} catch (e) {throw Exception('Gagal ambil data wali kelas: $e');}}// 2. BUAT AKUN WALI KELASFuture<void> createTeacherAccount({required String email,required String password,required String fullName,required String schoolId,required String className, // Input Barurequired String phoneNumber, // [BARU] Terima nomor teleponrequired int studentCountClass,}) async {const String projectUrl = 'https://mqyfrqgfpqwlrloqtpvi.supabase.co';const String anonKey ='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1xeWZycWdmcHF3bHJsb3F0cHZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0NTMxMDMsImV4cCI6MjA3OTAyOTEwM30.KoXKouhFN0H7Iz9MSnRhFQuBIePVMwWyXmrzSv3rEeQ';try {final myUserId = _supabase.auth.currentUser!.id;final profile = await _supabase.from('profiles').select('sppg_id').eq('id', myUserId).single();final String mySppgId = profile['sppg_id'];// A. Request Signupfinal url = Uri.parse('$projectUrl/auth/v1/signup');final response = await http.post(url,headers: {'Content-Type': 'application/json', 'apikey': anonKey},body: jsonEncode({'email': email.trim(),'password': password,'data': {'full_name': fullName},}),);if (response.statusCode == 200 || response.statusCode == 201) {final responseData = jsonDecode(response.body);String? newUserId = responseData['id'] ?? responseData['user']['id'];if (newUserId == null) throw Exception("Gagal dapat ID User.");// B. Simpan ke Profilesawait _supabase.from('profiles').insert({'id': newUserId,'full_name': fullName,'email': email.trim(),'role': 'walikelas','sppg_id': mySppgId,'school_id': schoolId,'class_name': className,'phone_number': phoneNumber,'student_count_class': studentCountClass, // BARU});} else {final errorData = jsonDecode(response.body);throw Exception(errorData['msg'] ?? 'Gagal mendaftar');}} catch (e) {if (e.toString().contains("User already registered")) {throw Exception("Email sudah terdaftar!");}throw Exception('Gagal buat akun: $e');}}// [BARU] 3. UPDATE AKUN WALI KELASFuture<void> updateTeacherAccount(String userId,Map<String, dynamic> data,) async {// data harus sudah memiliki 'student_count_class'try {await _supabase.from('profiles').update(data).eq('id', userId);} catch (e) {throw Exception('Gagal update akun wali kelas: $e');}}// [BARU] 4. HAPUS AKUN WALI KELAS (Delete Auth User)Future<void> deleteTeacherAccount(String userId) async {try {// Hapus akun dari Auth.users. Ini akan otomatis menghapus dari profiles.await _supabase.rpc('delete_user_and_profile',params: {'user_id_input': userId},);} catch (e) {throw Exception('Gagal hapus akun wali kelas: $e');}}// [BARU] Hitung kuota yang tersedia di sekolah// Mengembalikan: {totalSchool: int, allocated: int}Future<Map<String, int>> getSchoolQuotaDetails(String schoolId, {String? excludeUserId,}) async {try {// 1. Ambil Total Siswa Sekolahfinal school = await _supabase.from('schools').select('student_count').eq('id', schoolId).single();final int totalSchool = school['student_count'] ?? 0;// 2. Hitung Kuota yang Sudah Dialokasikan ke Wali Kelas lainvar query = _supabase.from('profiles').select('student_count_class').eq('school_id', schoolId).eq('role', 'walikelas');// Kecualikan diri sendiri (saat mode edit)if (excludeUserId != null) {query = query.not('id', 'eq', excludeUserId);}final allocatedProfiles = await query;// [FIX KRITIS TYPE ERROR]: Memaksa sum awal menjadi int, dan memastikan hasil fold adalah int.// Konversi nilai profil ke int secara eksplisit sebelum penjumlahan.final int allocated = allocatedProfiles.fold<int>(0, (sum, profile) {// Pastikan nilai profile['student_count_class'] diubah ke int dengan null checkfinal classCount =(profile['student_count_class'] as num?)?.toInt() ?? 0;return sum + classCount;});return {'totalSchool': totalSchool, 'allocated': allocated};} catch (e) {throw Exception("Gagal menghitung kuota sekolah: $e");}}}

=== FILE: lib/features/admin_sppg/services/complaint_service.dart ===
import 'package:supabase_flutter/supabase_flutter.dart';import 'package:intl/intl.dart';import '../../shared/services/notification_service.dart'; // <--- FIX 2: MISSING IMPORTclass ComplaintService {final _supabase = Supabase.instance.client;// 1. AMBIL KELUHAN (MENGGUNAKAN RPC) - Diperbarui dengan FilterFuture<List<Map<String, dynamic>>> getSppgComplaints({DateTime? date,String? schoolId,}) async {try {final userId = _supabase.auth.currentUser!.id;final profile = await _supabase.from('profiles').select('sppg_id').eq('id', userId).single();final String mySppgId = profile['sppg_id'];final dateStr = date != null? DateFormat('yyyy-MM-dd').format(date): null;final response = await _supabase.rpc('get_sppg_all_complaints',params: {'sppg_id_input': mySppgId,'date_filter_input': dateStr, // BARU'school_id_filter_input': schoolId, // BARU},);// Catatan: Fungsi SQL get_sppg_all_complaints perlu diperbarui untuk menerima filter inireturn List<Map<String, dynamic>>.from(response);} catch (e) {throw Exception("Gagal ambil semua keluhan: $e");}}// [BARU] 2. MENDAPATKAN ID USER PELAPOR (untuk Notifikasi)Future<String> getReporterIdForNotification(String complaintId,String reporterRole,) async {if (reporterRole == 'walikelas') {// Jika dari Wali Kelas (Class Receptions), ID user ada di kolom teacher_idfinal response = await _supabase.from('class_receptions').select('teacher_id').eq('id', complaintId).single();return response['teacher_id'] as String;} else if (reporterRole == 'koordinator') {// Jika dari Koordinator (Delivery Stops), ID user adalah ID Koordinator Sekolah itu// A. Ambil school_id dari delivery_stopsfinal stop = await _supabase.from('delivery_stops').select('school_id').eq('id', complaintId).single();final String schoolId = stop['school_id'];// B. Cari ID profiles yang role=koordinator dan school_id=school_idfinal koordinator = await _supabase.from('profiles').select('id').eq('role', 'koordinator').eq('school_id', schoolId).limit(1) // Ambil yang pertama.single();return koordinator['id'] as String;}throw Exception("Gagal identifikasi pelapor untuk notifikasi.");}// 3. KIRIM INSTRUKSI (TINDAK LANJUT) + NOTIFIKASIFuture<void> respondToComplaint({required String id,required String response,required StringreporterId, // ID Wali/Koordinator yang lapor (user profiles ID)required String reporterRole, // 'koordinator' atau 'walikelas'required StringtargetTableId, // ID dari tabel yg mau diupdate (id CR atau id DS)required String targetTableName, // 'class_receptions' atau 'delivery_stops'}) async {try {// A. Update Status dan Respon di tabel yang benarawait _supabase.from(targetTableName).update({'admin_response': response,'resolved_at': DateTime.now().toIso8601String(),}).eq('id', targetTableId);// B. KIRIM NOTIFIKASIfinal notificationService = NotificationService();// C. Tentukan Tipe Notifikasi dan BodyString title, body;if (reporterRole == 'walikelas') {title = "Keluhan Kualitas Ditindaklanjuti";body = "Admin SPPG merespon keluhan Anda: $response";} else {// koordinatortitle = "Laporan Penerimaan Ditindaklanjuti";body = "Admin SPPG merespon laporan Anda: $response";}await notificationService.sendNotification(recipientId: reporterId, // ID user yang akan menerima notiftitle: title,body: body,type: 'success', // atau 'warning');} catch (e) {throw Exception("Gagal kirim respon/notifikasi: $e");}}}

=== FILE: lib/features/admin_sppg/services/schedule_service.dart ===
import 'package:supabase_flutter/supabase_flutter.dart';import 'package:flutter/material.dart';import 'package:intl/intl.dart';import 'package:collection/collection.dart'; // Import for groupBy/firstWhereOrNull/minByimport '../../../models/production_schedule_model.dart';import '../../../models/school_model.dart';import 'dart:convert'; // Pastikan ini ada untuk jsonDecode// Model sementara untuk menampung Menu + Total Porsi yang dibutuhkanclass MenuProductionDetail {final String menuId;final String menuName;final int totalPortions;final int cookingDurationMinutes;final int maxConsumeMinutes;// Waktu Konsumsi Paling Awal (dari semua sekolah yang minta menu ini)final TimeOfDay earliestDeadline;MenuProductionDetail({required this.menuId,required this.menuName,required this.totalPortions,required this.cookingDurationMinutes,required this.maxConsumeMinutes,required this.earliestDeadline,});}class ScheduleService {final _supabase = Supabase.instance.client;Future<String> _getMySppgId() async {final userId = _supabase.auth.currentUser!.id;final profile = await _supabase.from('profiles').select('sppg_id').eq('id', userId).single();return profile['sppg_id'];}// --- LOGIKA HITUNG MUNDUR (BACKWARD SCHEDULING) ---String calculateStartTime(TimeOfDay deliverTime, int cookingDurationMinutes) {int deliverMinutes = deliverTime.hour * 60 + deliverTime.minute;// 30 min preparation/packing/loading bufferint startMinutes = deliverMinutes - cookingDurationMinutes - 30;if (startMinutes < 0) startMinutes = 0;final int startHour = startMinutes ~/ 60;final int startMinute = startMinutes % 60;return "${startHour.toString().padLeft(2, '0')}:${startMinute.toString().padLeft(2, '0')}:00";}// [BARU] 5. LOGIKA UTAMA: KALKULASI JADWAL PRODUKSIFuture<List<MenuProductionDetail>> calculateProductionSchedule(DateTime date,) async {final mySppgId = await _getMySppgId();final dayName = DateFormat('EEEE', 'id_ID').format(date);// 1. Ambil semua Sekolah SPPG inifinal schoolsResponse = await _supabase.from('schools').select('*').eq('sppg_id', mySppgId).not('menu_default', 'is', null) // Pastikan ada menu default.not('deadline_time', 'is', null); // Pastikan ada jadwal rutinfinal List<School> allSchools = (schoolsResponse as List).map((json) => School.fromJson(json)).toList();// 2. Filter Sekolah yang ada jadwal di hari ini & Tentukan DeadlineList<Map<String, dynamic>> todaySchools = [];for (var school in allSchools) {try {final Map<String, dynamic> scheduleMap = jsonDecode(school.deadlineTime!,);if (scheduleMap.containsKey(dayName)) {final deadlineTimeStr =scheduleMap[dayName] as String; // e.g., "10:00:00"final parts = deadlineTimeStr.split(':');todaySchools.add({'school': school,'deadline_minutes': int.parse(parts[0]) * 60 + int.parse(parts[1]),});}} catch (_) {/* ignore invalid schedule */}}if (todaySchools.isEmpty) return [];// 3. Kumpulkan Kebutuhan Menu, Hitung Total Porsi, dan Cari Earliest Deadline per Menu// Map<String MenuName, List<dynamic>>: List of (School, DeadlineMinutes) pairsMap<String, List<Map<String, dynamic>>> menuNeeds = {};for (var schoolData in todaySchools) {final School school = schoolData['school'];final int deadlineMinutes = schoolData['deadline_minutes'];if (school.menuDefault != null) {final menuNames = school.menuDefault!.split(',').map((e) => e.trim()).toList();for (var menuName in menuNames) {if (!menuNeeds.containsKey(menuName)) {menuNeeds[menuName] = [];}menuNeeds[menuName]!.add({'portions': school.studentCount,'deadline_minutes': deadlineMinutes,});}}}// 4. Ambil Detail Menu (Durasi Masak, Max Consume Minutes)final menuNamesToFetch = menuNeeds.keys.toList();final menuDetailsRaw = await _supabase.from('menus').select('id, name, cooking_duration_minutes, max_consume_minutes').filter('name','in',menuNamesToFetch,) // <--- FIX: Menggunakan .filter() instead of in_().eq('sppg_id', mySppgId);Map<String, MenuProductionDetail> finalScheduleMap = {};for (var menuName in menuNamesToFetch) {final details = menuDetailsRaw.firstWhereOrNull((m) => m['name'] == menuName,);if (details == null) continue; // Skip menu not foundfinal needs = menuNeeds[menuName]!;final totalPortions = needs.fold<int>(0,(sum, need) => sum + (need['portions'] as int),);// Cari Earliest Deadline (Waktu konsumsi paling ketat)final earliestDeadlineMinutes = needs.map((n) => n['deadline_minutes'] as int).min;final earliestDeadline = TimeOfDay(hour: earliestDeadlineMinutes ~/ 60,minute: earliestDeadlineMinutes % 60,);finalScheduleMap[menuName] = MenuProductionDetail(menuId: details['id'],menuName: menuName,totalPortions: totalPortions,cookingDurationMinutes: details['cooking_duration_minutes'] as int,maxConsumeMinutes: details['max_consume_minutes'] as int,earliestDeadline: earliestDeadline,);}// 5. SORTING FINAL: Berdasarkan Max Consume Minutes (Terlama ke Tercepat)// Logika: Menu yang tahan lama dimasak duluan, menu yang cepat basi dimasak belakangan.List<MenuProductionDetail> finalScheduleList = finalScheduleMap.values.toList();finalScheduleList.sort((a, b) => b.maxConsumeMinutes.compareTo(a.maxConsumeMinutes),);// Note: Kita tidak melakukan calculation start/finish time di sini,// karena itu biasanya dilakukan saat user mengklik "Generate Production".// Kita hanya mengembalikan daftar terurut kebutuhan hari itu.// Ini adalah menu dan total porsi yang perlu diproduksi, diurutkan.return finalScheduleList;}// [BARU] 6. SIMPAN JADWAL PRODUKSI DARI HASIL KALKULASIFuture<void> saveCalculatedSchedule(List<MenuProductionDetail> scheduleList,DateTime date,) async {final mySppgId = await _getMySppgId();// 1. Hitung Target Waktu Selesai (Start time = earliest deadline - 30 min buffer)// Hitung mundur waktu selesai untuk menu pertama (yang paling cepat basi/paling akhir dimasak)// Menu pertama di list adalah yang paling tahan lama, menu terakhir adalah yang paling cepat basi.// Start cooking untuk batch adalah waktu TERAKHIR mulai masak (menu yang paling cepat basi)// Temukan menu yang PALING KRITIS (Paling cepat basi, yaitu maxConsumeMinutes terpendek)// [FIX KRITIS: MENGGANTI minBy]MenuProductionDetail? criticalMenu;if (scheduleList.isNotEmpty) {criticalMenu = scheduleList.reduce((a, b) => a.maxConsumeMinutes < b.maxConsumeMinutes ? a : b,);}if (criticalMenu == null)throw Exception("Tidak ada menu untuk dijadwalkan.");// A. Cari waktu paling awal harus selesai masak (Earliest Deadline)// Kita anggap waktu beres masak = waktu keberangkatan rute paling awal (karena belum ada rute!)// Workaround: Asumsi Production FINISH TIME = Departure Time.// Karena belum ada rute, kita ambil Earliest Deadline (target konsumsi paling awal)// Cari Deadlines dari semua sekolah hari itufinal schools = await _supabase.from('schools').select('deadline_time').eq('sppg_id', mySppgId);final dayName = DateFormat('EEEE', 'id_ID').format(date);int minDeadlineMinutes = 24 * 60; // Max minutes in a dayfor (var school in schools) {try {final Map<String, dynamic> scheduleMap = jsonDecode(school['deadline_time']!,);if (scheduleMap.containsKey(dayName)) {final parts = (scheduleMap[dayName] as String).split(':');final currentMinutes = int.parse(parts[0]) * 60 + int.parse(parts[1]);if (currentMinutes < minDeadlineMinutes) {minDeadlineMinutes = currentMinutes;}}} catch (_) {/* ignore */}}// Waktu paling awal rute harus BERANGKAT (Departure Time) = Min Deadline - Min Tolerance - Travel Time (Assume 0 for now)// Karena kita tidak tahu travel time di sini, kita pakai logik backward scheduling dari waktu terawal harus selesai.// Waktu harus SELESAI masak (Target Finish Time) = Waktu Departure (sebelum kirim)// Asumsi: Waktu Target Selesai Produksi = Earliest Deadline - 45 min (buffer loading/packing)final targetFinishMinutes = minDeadlineMinutes - 45;final targetFinishTime = TimeOfDay(hour: targetFinishMinutes ~/ 60,minute: targetFinishMinutes % 60,);// Cek konflik: apakah sudah ada jadwal produksi?final existingSchedules = await _supabase.from('production_schedules').select('id').eq('sppg_id', mySppgId).eq('date', DateFormat('yyyy-MM-dd').format(date));if (existingSchedules.isNotEmpty) {throw Exception("Jadwal produksi untuk tanggal ini sudah ada. Hapus dulu jika ingin membuat jadwal otomatis baru.",);}// 2. Hapus Jadwal Sebelumnya (opsional, tapi diasumsikan tidak ada karena cek di atas)// 3. Tentukan Jadwal per Menu (Sequencing)// Waktu Masak BERURUTAN ke belakang berdasarkan Durasi Masak (COOKING DURATION)// Total Durasi Produksi (semua menu): Sum(cookingDuration)final totalCookingDuration = scheduleList.fold<int>(0,(sum, m) => sum + m.cookingDurationMinutes,);int currentFinishMinutes = targetFinishMinutes;List<Map<String, dynamic>> insertData = [];// Iterasi dari menu yang paling penting (paling akhir dimasak/paling tahan lama)// Karena list sudah diurutkan (max_consume_minutes terlama duluan),// kita perlu balikin urutan list untuk scheduling yang benar (menu paling cepat basi dimasak terakhir)final reversedScheduleList = scheduleList.reversed.toList(); // Menu paling cepat basi di awalfor (var menuDetail in reversedScheduleList) {final start = currentFinishMinutes - menuDetail.cookingDurationMinutes;final fmtStart ="${(start ~/ 60).toString().padLeft(2, '0')}:${(start % 60).toString().padLeft(2, '0')}:00";final fmtFinish ="${(currentFinishMinutes ~/ 60).toString().padLeft(2, '0')}:${(currentFinishMinutes % 60).toString().padLeft(2, '0')}:00";insertData.add({'sppg_id': mySppgId,'date': DateFormat('yyyy-MM-dd').format(date),'menu_id': menuDetail.menuId,'total_portions': menuDetail.totalPortions,'start_cooking_time': fmtStart,'target_finish_time': fmtFinish,'notes': 'Auto Schedule (Urutan Masak)',});// Update finish time untuk menu berikutnya (gap 0 menit)currentFinishMinutes = start;}// 4. Insert ke DB (Batch Insert)if (insertData.isNotEmpty) {await _supabase.from('production_schedules').insert(insertData);}}// [BARU] UTILITY: Mendapatkan Menu ID Pertama (Placeholder for Override)Future<String> _getFirstMenuId() async {try {final mySppgId = await _getMySppgId();final menu = await _supabase.from('menus').select('id').eq('sppg_id', mySppgId).limit(1).single();if (menu == null) {throw Exception("Tidak ada menu terdaftar untuk membuat jadwal khusus.",);}return menu['id'];} catch (e) {rethrow;}}// --- 1. READ: AMBIL JADWAL BULANAN (This was missing or incomplete) ---Future<List<ProductionSchedule>> getSchedulesByMonth(DateTime month) async {try {// Re-use logic to get SPPG IDfinal userId = _supabase.auth.currentUser!.id;final profile = await _supabase.from('profiles').select('sppg_id').eq('id', userId).single();final String mySppgId = profile['sppg_id'];// Tentukan awal & akhir bulanfinal startDate = DateTime(month.year, month.month, 1);final endDate = DateTime(month.year, month.month + 1, 0);// Fetch schedules, joining with menus to get the namefinal response = await _supabase.from('production_schedules').select('*, menus(name, cooking_duration_minutes)').eq('sppg_id', mySppgId).gte('date', startDate.toIso8601String()).lte('date', endDate.toIso8601String());final List<dynamic> data = response;return data.map((json) => ProductionSchedule.fromJson(json)).toList();} catch (e) {throw Exception("Gagal mengambil jadwal bulanan: $e");}}// --- 2. CREATE: TAMBAH JADWAL (Jadwal Khusus / Override) ---Future<void> addScheduleForRequest({required DateTime date,required String schoolId,required int portions,required TimeOfDay deliverTime,required int cookingDuration,required int toleranceMinutes,String? notes,}) async {try {final mySppgId = await _getMySppgId();final menuId = await _getFirstMenuId(); // Placeholder menu IDfinal String targetFinish ="${deliverTime.hour.toString().padLeft(2, '0')}:${deliverTime.minute.toString().padLeft(2, '0')}:00";final String startCooking = calculateStartTime(deliverTime,cookingDuration,);await _supabase.from('production_schedules').insert({'sppg_id': mySppgId,'date': date.toIso8601String().split('T')[0],'menu_id': menuId,'total_portions': portions,'start_cooking_time': startCooking,'target_finish_time': targetFinish,'notes':'Jadwal Khusus | Sekolah: $schoolId | ${notes ?? 'Dibuat dari Pengajuan'}',});} catch (e) {throw Exception("Gagal tambah jadwal khusus: $e");}}// --- 2. CREATE: TAMBAH JADWAL ---Future<void> addSchedule({required DateTime date,required String menuId,required int portions,required TimeOfDay deliverTime, // Target Jam Kirim (Deadline)required int cookingDuration, // Dari MenuString? notes,}) async {try {final mySppgId = await _getMySppgId();final String targetFinish ="${deliverTime.hour.toString().padLeft(2, '0')}:${deliverTime.minute.toString().padLeft(2, '0')}:00";final String startCooking = calculateStartTime(deliverTime,cookingDuration,);await _supabase.from('production_schedules').insert({'sppg_id': mySppgId,'date': date.toIso8601String().split('T')[0],'menu_id': menuId,'total_portions': portions,'start_cooking_time': startCooking,'target_finish_time': targetFinish,'notes': notes,});} catch (e) {throw Exception("Gagal tambah jadwal: $e");}}// --- 3. UPDATE: UBAH JADWAL (JADWAL DADAKAN) ---Future<void> updateSchedule({required String id,required String menuId,required int portions,required TimeOfDay deliverTime,required int cookingDuration,String? notes,}) async {try {final String targetFinish ="${deliverTime.hour.toString().padLeft(2, '0')}:${deliverTime.minute.toString().padLeft(2, '0')}:00";final String startCooking = calculateStartTime(deliverTime,cookingDuration,);await _supabase.from('production_schedules').update({'menu_id': menuId,'total_portions': portions,'start_cooking_time': startCooking, // Hitung ulang waktu masak'target_finish_time': targetFinish,'notes': notes,}).eq('id', id);} catch (e) {throw Exception("Gagal update jadwal: $e");}}// --- 4. DELETE: HAPUS JADWAL ---Future<void> deleteSchedule(String id) async {try {await _supabase.from('production_schedules').delete().eq('id', id);} catch (e) {throw Exception("Gagal hapus jadwal: $e");}}}

=== FILE: lib/features/admin_sppg/services/route_service.dart ===
import 'package:supabase_flutter/supabase_flutter.dart';import 'package:flutter/material.dart';import 'package:intl/intl.dart';import 'package:latlong2/latlong.dart';import 'dart:convert';import 'package:http/http.dart' as http;import 'package:collection/collection.dart';import '../../../models/route_model.dart';import '../../../models/school_model.dart';class RouteService {final _supabase = Supabase.instance.client;// ===========================================================================// BAGIAN 1: LOGIKA PEMBUATAN & PERHITUNGAN RUTE (CORE LOGIC)// ===========================================================================Future<Map<String, dynamic>> getBottleneckMenuSetInfo(List<School> schools,) async {if (schools.isEmpty)return {'duration': 0, 'menuIds': [], 'menuSetNames': []};final mySppgId = await _getMySppgId();Set<String> uniqueMenuSetNames = schools.where((s) => s.menuDefault != null).map((s) => s.menuDefault!).toSet();if (uniqueMenuSetNames.isEmpty)return {'duration': 0, 'menuIds': [], 'menuSetNames': []};// 1. Ambil Menu Set yang terlibatfinal menuSetsRaw = await _supabase.from('menu_sets').select('*, karbo_menus:karbo_id(max_consume_minutes, cooking_duration_minutes), protein_menus:protein_id(max_consume_minutes, cooking_duration_minutes), sayur_menus:sayur_id(max_consume_minutes, cooking_duration_minutes), buah_menus:buah_id(max_consume_minutes, cooking_duration_minutes), nabati_menus:nabati_id(max_consume_minutes, cooking_duration_minutes), pelengkap_menus:pelengkap_id(max_consume_minutes, cooking_duration_minutes)',).eq('sppg_id', mySppgId).filter('set_name', 'in', uniqueMenuSetNames.toList());// 2. Cari Menu dengan MaxConsumeMinutes terpendek (Kritis Mutu) dan Durasi Masak terlama (Bottleneck)int minMaxConsume = 9999;int maxCookingDuration = 0;Set<String> allRequiredMenuIds = {};for (var set in menuSetsRaw) {final menuFields = ['karbo_menus','protein_menus','sayur_menus','buah_menus','nabati_menus','pelengkap_menus',];for (var field in menuFields) {final menu = set[field];if (menu != null) {final maxConsume = menu['max_consume_minutes'] as int? ?? 120;final duration = menu['cooking_duration_minutes'] as int? ?? 0;// Kritis Mutu: Cari Batas Konsumsi Terpendek (Prioritas Urutan Kirim)if (maxConsume < minMaxConsume) {minMaxConsume = maxConsume;}// Bottleneck Produksi: Cari Durasi Masak Terlama (Untuk Hitungan Mundur Produksi)if (duration > maxCookingDuration) {maxCookingDuration = duration;}}}// Kumpulkan SEMUA Menu ID dari SEMUA Set yang terlibat (untuk dicatat di route_menus)final idFields = ['karbo_id','protein_id','sayur_id','buah_id','nabati_id','pelengkap_id',];for (var idField in idFields) {if (set[idField] != null) {allRequiredMenuIds.add(set[idField].toString());}}}// ASUMSI KRITIS: Kita hanya menggunakan maxCookingDuration untuk backward scheduling.// Dan minMaxConsume AKAN DIGUNAKAN UNTUK SORTING SEKOLAH (Nanti di step G)return {'duration': maxCookingDuration,'menuIds': allRequiredMenuIds.toList(),'menuSetNames': uniqueMenuSetNames.toList(),'minMaxConsume':minMaxConsume, // <--- BARU: Kirim Batas Konsumsi Terpendek};}Future<String> _getMySppgId() async {final userId = _supabase.auth.currentUser!.id;final profile = await _supabase.from('profiles').select('sppg_id').eq('id', userId).single();// Karena user profile harus selalu punya sppg_id (kecuali BGN), kita asumsikan tidak null.if (profile['sppg_id'] == null) {throw Exception("User profile missing SPPG ID.");}return profile['sppg_id'] as String; // Mengembalikan tipe String}// [BARU CORE LOGIC]: Fungsi untuk menghasilkan urutan sekolah berdasarkan prioritasFuture<List<School>> _getPrioritizedSchools(List<School> schools,DateTime date,) async {// <--- TAMBAH PARAMETER DATE// 1. Ambil Menu Set Details// bottleneckData tidak bergantung pada hari, jadi tetap sama.final bottleneckData = await getBottleneckMenuSetInfo(schools);final currentDayName = DateFormat('EEEE','id_ID',).format(date); // <--- GUNAKAN DATE// 2. Hitung Priority Score untuk setiap sekolah (Deadline + Menu Criticality)List<Map<String, dynamic>> prioritizedSchools = [];for (var school in schools) {int deadlineMinutes = 9999;int schoolMenuMaxConsume = 9999;// A. Cari Deadline Sekolah (Waktu harus SELESAI konsumsi)try {final Map<String, dynamic> scheduleMap = jsonDecode(school.deadlineTime!,);if (scheduleMap.containsKey(currentDayName)) {final deadlineString =scheduleMap[currentDayName] as String; // e.g., "10:00:00"final parts = deadlineString.split(':');deadlineMinutes = int.parse(parts[0]) * 60 + int.parse(parts[1]);}} catch (_) {/* ignore */}// B. Cari Batas Konsumsi Menu Set Sekolah (Waktu kritis menu)// >>> START PERBAIKAN DI SINI: Terapkan null check untuk menuDefault <<<if (school.menuDefault == null || school.menuDefault!.isEmpty) {// Jika tidak ada menu default, lewati atau berikan prioritas terendah// Untuk saat ini, kita anggap dia non-kritis agar tidak mengganggu scheduling lain.// Kita langsung set sort key tertinggi (prioritas terendah) dan lanjutkan loop.prioritizedSchools.add({'school': school, 'priorityKey': 9999999});continue; // Lanjut ke sekolah berikutnya}final menuSet = await _supabase.from('menu_sets').select('*, karbo_menus:karbo_id(max_consume_minutes)',) // Hanya perlu satu field untuk trigger join.eq('set_name',school.menuDefault as Object,) // <--- FIX ERROR: Casting String? ke Object yang aman.limit(1).single();// >>> END PERBAIKAN <<<// Cari min MaxConsumeMinutes di Menu Set inifinal menuFields = ['karbo_menus','protein_menus','sayur_menus','buah_menus','nabati_menus','pelengkap_menus',];int tempMinConsume = 9999;for (var field in menuFields) {if (menuSet.containsKey(field) && menuSet[field] != null) {final maxConsume =menuSet[field]['max_consume_minutes'] as int? ?? 120;if (maxConsume < tempMinConsume) {tempMinConsume = maxConsume;}}}schoolMenuMaxConsume = tempMinConsume;// PRIORITY SCORE: Jarak waktu dari sekarang ke (Deadline - MaxConsumeMenu)// Semakin kecil score, semakin kritis (harus dikirim duluan).// Kritis Waktu Tiba = Deadline - Toleranceint criticalDeliveryTime = deadlineMinutes - school.toleranceMinutes;// Priority Score = (Critical Delivery Time) - (Paling cepat basi)// ASUMSI: Sekolah yang menunya cepat basi DAN deadline-nya cepat, harus didahulukan.int priorityScore = (criticalDeliveryTime - schoolMenuMaxConsume);// Sort Key: Urutan: (Waktu Tiba Kritis) + (Menu Max Consume)int finalSortKey =criticalDeliveryTime * 1000 +schoolMenuMaxConsume; // Semakin kecil, semakin prioritasprioritizedSchools.add({'school': school, 'priorityKey': finalSortKey});}// Sort schools: Smallest key first (highest priority)prioritizedSchools.sort((a, b) => (a['priorityKey'] as int).compareTo(b['priorityKey'] as int),);return prioritizedSchools.map((e) => e['school'] as School).toList();}Future<String> getFirstCourierId() async {return await _getFirstCourierId();}// [FIX DAN UPDATE MULTI-TRIP]: createBatchRoutesFuture<void> createBatchRoutes({required List<String> vehicleIds,required String courierId,required List<String> menuIds,required DateTime date, // <--- Gunakan 'date' inirequired List<School> selectedSchools,required int cookingDuration,}) async {final userId = _supabase.auth.currentUser!.id;final profile = await _supabase.from('profiles').select('sppg_id').eq('id', userId).single();final String mySppgId = profile['sppg_id'];if (vehicleIds.isEmpty || menuIds.isEmpty) return;// >>> KRITIS: Logic Multi-Trip (Hanya untuk 1 kendaraan di mode manual) <<<if (vehicleIds.length != 1) {throw Exception("Hanya mendukung 1 kendaraan untuk Rute Manual saat ini.",);}final vehicleId = vehicleIds.first;final vehicleRaw = await _supabase.from('vehicles').select('capacity_limit').eq('id', vehicleId).single();final vehicleCapacity = vehicleRaw['capacity_limit'] as int;// [BARU] Helper untuk CreateRouteScreen, mengambil rute hari tertentuFuture<List<Map<String, dynamic>>> getRoutesByDate(DateTime date) async {final userId = _supabase.auth.currentUser!.id;final profile = await _supabase.from('profiles').select('sppg_id').eq('id', userId).single();final String mySppgId = profile['sppg_id']; // <--- sudah pasti Stringfinal response = await _supabase.from('delivery_routes').select('vehicle_id').eq('sppg_id',mySppgId,) // <--- ERROR HILANG KARENA mySppgId sudah String.eq('date', DateFormat('yyyy-MM-dd').format(date));return List<Map<String, dynamic>>.from(response);}// 1. PRIORITASISASI SEKOLAH BERDASARKAN KRITIS WAKTU/MENU// Perubahan KRITIS: Meskipun ini manual, kita harus menggunakan sorting yang sama// agar rute yang dihasilkan optimal sesuai constraint menu.List<School> sortedSchools = await _getPrioritizedSchools(selectedSchools,date,); // <--- FIX: KIRIM ARGUMEN DATEList<School> remainingSchools = List.from(sortedSchools);int routeIndex = 1;int routesCreated = 0;// Lakukan Loop sampai semua sekolah terlayani (Multi-Trip Logic)while (remainingSchools.isNotEmpty) {List<School> currentTripSchools = [];int currentLoad = 0;// 2. PEMBAGIAN TRIP: Ambil sekolah sebanyak mungkin sesuai kapasitasint i = 0;while (i < remainingSchools.length) {final school = remainingSchools[i];if (school.studentCount > vehicleCapacity) {throw Exception("Sekolah ${school.name} porsi (${school.studentCount}) melebihi kapasitas mobil (${vehicleCapacity}).",);}if (currentLoad + school.studentCount <= vehicleCapacity) {currentLoad += school.studentCount;currentTripSchools.add(school);i++;} else {break; // Kapasitas penuh}}if (currentTripSchools.isEmpty) {break; // Tidak ada lagi sekolah yang muat}// 3. BUAT RUTE UNTUK TRIP INIawait _createSingleRouteCalculation(sppgId: mySppgId,vehicleId: vehicleId,courierId: courierId,menuIds: menuIds,date: date,schools: currentTripSchools, // Hanya sekolah untuk trip inicookingDuration: cookingDuration,isDailyBatch: false, // Ini tetap manualnotesPrefix: "Manual Trip $routeIndex",);routesCreated++;routeIndex++;// Hapus sekolah yang sudah ditambahkan di trip ini dari remainingSchoolsremainingSchools.removeRange(0, currentTripSchools.length);}// Mengganti return/throw error lamaif (routesCreated == 0) {throw Exception("Gagal membuat rute. Mungkin kapasitas mobil terlalu kecil atau tidak ada sekolah yang muat.",);}}// Ubah signature functionFuture<List<School>> _getScheduledSchoolsForDay(String mySppgId,DateTime date,) async {// Gunakan target date untuk mendapatkan nama harifinal currentDayName = DateFormat('EEEE','id_ID',).format(date); // <--- GUNAKAN DATEfinal response = await _supabase.from('schools').select().eq('sppg_id', mySppgId).not('deadline_time', 'is', null);final List<School> allSchools = (response as List).map((json) => School.fromJson(json)).toList();List<School> scheduledSchools = [];for (var school in allSchools) {if (school.deadlineTime != null &&school.latitude != null &&school.longitude != null) {try {final Map<String, dynamic> scheduleMap = jsonDecode(school.deadlineTime!,);if (scheduleMap.containsKey(currentDayName,) && // <--- GUNAKAN currentDayNameschool.menuDefault != null) {scheduledSchools.add(school);}} catch (_) {}}}// Sorting tetap menggunakan deadline hari ituscheduledSchools.sort((a, b) {try {final Map<String, dynamic> aMap = jsonDecode(a.deadlineTime!);final Map<String, dynamic> bMap = jsonDecode(b.deadlineTime!);final aTimeStr = aMap[currentDayName] as String;final bTimeStr = bMap[currentDayName] as String;return aTimeStr.compareTo(bTimeStr);} catch (_) {return 0;}});return scheduledSchools;}Future<String> _getFirstCourierId() async {// ... (logic sama)try {final userId = _supabase.auth.currentUser!.id;final profile = await _supabase.from('profiles').select('sppg_id').eq('id', userId).single();final String mySppgId = profile['sppg_id'];final courier = await _supabase.from('profiles').select('id').eq('sppg_id', mySppgId).eq('role', 'kurir').limit(1).single();if (courier == null)throw Exception("Tidak ada Kurir yang terdaftar untuk fallback.");return courier['id'] as String;} catch (e) {throw Exception('Gagal mendapatkan ID Kurir Fallback: $e');}}// Ubah signature functionFuture<int> generateDailyRoutes({required DateTime date}) async {// <--- TAMBAH PARAMETER DATEfinal userId = _supabase.auth.currentUser!.id;final profile = await _supabase.from('profiles').select('sppg_id').eq('id', userId).single();final String mySppgId = profile['sppg_id'];// Gunakan tanggal yang dimasukkan, bukan DateTime.now()final DateTime targetDate = DateTime(date.year, date.month, date.day);// Cek konflik: apakah sudah ada rute hari ini?final existingRoutes = await _supabase.from('delivery_routes').select('id').eq('sppg_id', mySppgId).eq('date',DateFormat('yyyy-MM-dd').format(targetDate),); // <--- GUNAKAN targetDateif (existingRoutes.isNotEmpty) {throw Exception("Rute untuk tanggal ini (${DateFormat('dd MMM').format(targetDate)}) sudah ada. Hapus rute lama untuk generate yang baru.",);}// 1. Ambil Semua Sekolah yang Terjadwal Hari Ini// PERLU MEMODIFIKASI _getScheduledSchoolsForToday agar menerima dateList<School> scheduledSchools = await _getScheduledSchoolsForDay(mySppgId,targetDate,); // <--- KIRIM targetDateif (scheduledSchools.isEmpty) {throw Exception("Tidak ada sekolah yang memiliki jadwal rutin, menu default, atau koordinat yang lengkap untuk tanggal ini.",);}// 2. Prioritasisasi Sekolah (berdasarkan Deadline Kritis & Menu Max Consume)// PERLU MEMODIFIKASI _getPrioritizedSchools agar menerima dateList<School> sortedSchools = await _getPrioritizedSchools(scheduledSchools,targetDate,); // <--- KIRIM targetDateif (sortedSchools.isEmpty) {throw Exception("Tidak ada sekolah yang memiliki jadwal rutin, menu default, atau koordinat yang lengkap untuk hari ini.",);}// 2. Prioritasisasi Sekolah (berdasarkan Deadline Kritis & Menu Max Consume)// NOTE: Fungsi ini juga melakukan filter jika menu_default sekolah nullif (sortedSchools.isEmpty) {throw Exception("Sekolah tersedia, namun tidak ada yang memiliki Menu Set dan GPS yang valid.",);}// 3. Ambil Kendaraan Aktif dan Kapasitasnyafinal vehicles = await _supabase.from('vehicles').select('id, capacity_limit, courier_profile_id').eq('sppg_id', mySppgId).eq('is_active', true);final List<Map<String, dynamic>> activeVehicles =List<Map<String, dynamic>>.from(vehicles);if (activeVehicles.isEmpty) {throw Exception("Tidak ada kendaraan aktif yang bisa ditugaskan.");}// 4. Hitung Bottleneck Produksi (Durasi Masak Terlama)final bottleneckData = await getBottleneckMenuSetInfo(sortedSchools);final int bottleneckDuration = bottleneckData['duration'] as int;final List<String> requiredMenuIds =bottleneckData['menuIds'] as List<String>;if (requiredMenuIds.isEmpty || bottleneckDuration == 0) {throw Exception("Menu set default sekolah tidak terdaftar atau durasi masak nol.",);}// 5. PENUGASAN & PEMBAGIAN RUTE DENGAN MULTI-TRIP (Core Logic Perbaikan)// Kita akan menggunakan semua mobil yang tersedia secara berulang (round-robin)// sambil memecah beban setiap sekolah ke trip yang muat kapasitas.List<School> remainingSchools = List.from(sortedSchools);int routesCreated = 0;int vehicleIndex = 0;final String fallbackCourierId = await _getFirstCourierId();// Loop ini akan terus berjalan sampai semua sekolah terlayaniwhile (remainingSchools.isNotEmpty) {// Tentukan mobil yang bertugas di trip ini (Round-Robin vehicle assignment)final vehicle = activeVehicles[vehicleIndex % activeVehicles.length];final String vehicleId = vehicle['id'].toString();final int capacity = vehicle['capacity_limit'] as int;final String courierId =vehicle['courier_profile_id'] ?? fallbackCourierId;List<School> currentTripSchools = [];int currentLoad = 0;// Ambil sekolah dari awal list (prioritas tertinggi) yang muat di kapasitas mobilint i = 0;while (i < remainingSchools.length) {final school = remainingSchools[i];// Cek apakah porsi sekolah ini melebihi kapasitas total mobil.// Jika ya, kita harus menghentikan proses, karena asumsi kita adalah porsi < capacity.if (school.studentCount > capacity) {throw Exception("Sekolah ${school.name} memiliki porsi (${school.studentCount}) melebihi kapasitas mobil (${capacity}). Mohon alokasikan mobil dengan kapasitas lebih besar atau perbarui data.",);}if (currentLoad + school.studentCount <= capacity) {currentLoad += school.studentCount;currentTripSchools.add(school);i++; // Lanjut ke sekolah berikutnya di remainingSchools} else {// Kapasitas mobil untuk trip ini sudah penuh.break;}}if (currentTripSchools.isEmpty) {// Ini seharusnya hanya terjadi jika remainingSchools sudah kosong,// atau jika semua mobil sudah dicoba dan tidak ada yang bisa melayani.break;}await _createSingleRouteCalculation(sppgId: mySppgId,vehicleId: vehicleId,courierId: courierId,menuIds: requiredMenuIds,date: targetDate, // <--- KIRIM targetDateschools: currentTripSchools,cookingDuration: bottleneckDuration,isDailyBatch: true,notesPrefix: "AUTO Batch ${DateFormat('HH:mm').format(DateTime.now())}",);routesCreated++;// Hapus sekolah yang sudah dialokasikan dari remainingSchoolsremainingSchools.removeRange(0, currentTripSchools.length);// Pindah ke mobil berikutnya untuk trip selanjutnyavehicleIndex++;}if (routesCreated == 0) {throw Exception("Gagal membuat rute. Tidak ada mobil yang muat atau tidak ada sekolah yang tersisa untuk dikirim.",);}return routesCreated;}Future<void> _createSingleRouteCalculation({required String sppgId,required String vehicleId,required String courierId,required List<String> menuIds,required DateTime date,required List<School> schools,required int cookingDuration,bool isDailyBatch = false,List<Map<String, dynamic>>? bottleneckMenusData,String? notesPrefix, // <--- BARU TAMBAHKAN INI}) async {// ... (logic sama)// A. Ambil Lokasi Dapur (Titik Awal)final origin = await getSppgLocation();if (origin == null)throw Exception("Lokasi Dapur belum diset! Edit SPPG dulu.");// B. Susun Koordinat untuk Request OSRMString coordString = "${origin.longitude},${origin.latitude}";for (var s in schools) {if (s.latitude == null || s.longitude == null)throw Exception("Sekolah ${s.name} belum punya lokasi GPS!");coordString += ";${s.longitude},${s.latitude}";}// C. Panggil OSRM untuk dapatkan Durasi Per Segmen (Legs)final url = Uri.parse('https://router.project-osrm.org/route/v1/driving/$coordString?overview=false',);final response = await http.get(url);if (response.statusCode != 200)throw Exception("Gagal hitung durasi jalan (OSRM Error: HTTP ${response.statusCode}).",);final data = jsonDecode(response.body);if (data['code'] != 'Ok' ||data['routes'] == null ||(data['routes'] as List).isEmpty) {throw Exception("OSRM ROUTING FAILED: Tidak dapat menemukan rute yang valid. Cek koordinat GPS sekolah dan dapur. Respon OSRM: ${data['code']}",);}final List<dynamic> legs = data['routes'][0]['legs']; // Segmen perjalanan// D. Hitung Total Waktu & Durasi per Segmenint totalTravelSeconds = 0;List<int> travelSecondsPerLeg = [];for (var leg in legs) {int duration = (leg['duration'] as num).toInt(); // DetiktravelSecondsPerLeg.add(duration);totalTravelSeconds += duration + (10 * 60);}// E. Tentukan Deadline Paling Awal (The Bottle Neck)TimeOfDay earliestDeadline = const TimeOfDay(hour: 13, minute: 0);final String currentDayName = DateFormat('EEEE', 'id_ID').format(date);for (var s in schools) {if (s.deadlineTime != null) {String scheduleJson = s.deadlineTime!;try {final Map<String, dynamic> scheduleMap = jsonDecode(scheduleJson);if (scheduleMap.containsKey(currentDayName)) {final deadlineString = scheduleMap[currentDayName];final parts = deadlineString.split(':');if (parts.length >= 2) {final time = TimeOfDay(hour: int.parse(parts[0]),minute: int.parse(parts[1]),);if (time.hour < earliestDeadline.hour ||(time.hour == earliestDeadline.hour &&time.minute < earliestDeadline.minute)) {earliestDeadline = time;}}}} catch (_) {/* ignore */}}}// F. Hitung Mundur Jam Berangkat (Departure Time)int deadlineSeconds =earliestDeadline.hour * 3600 + earliestDeadline.minute * 60;int departureSeconds = deadlineSeconds - totalTravelSeconds;if (departureSeconds < 0) departureSeconds = 0;TimeOfDay departureTime = TimeOfDay(hour: departureSeconds ~/ 3600,minute: (departureSeconds % 3600) ~/ 60,);// G. Hitung Jam Masak (Start Cooking)int startCookingSeconds =departureSeconds - (cookingDuration * 60) - (30 * 60); // 30 min loadingif (startCookingSeconds < 0) startCookingSeconds = 0;TimeOfDay startCookingTime = TimeOfDay(hour: startCookingSeconds ~/ 3600,minute: (startCookingSeconds % 3600) ~/ 60,);// Format String untuk DB (HH:mm:ss)String fmtDep ="${departureTime.hour.toString().padLeft(2, '0')}:${departureTime.minute.toString().padLeft(2, '0')}:00";String fmtCook ="${startCookingTime.hour.toString().padLeft(2, '0')}:${startCookingTime.minute.toString().padLeft(2, '0')}:00";// H. INSERT RUTE KE DBfinal routeRes = await _supabase.from('delivery_routes').insert({'date': date.toIso8601String().split('T')[0],'sppg_id': sppgId,'vehicle_id': vehicleId,'courier_id': courierId,'departure_time': fmtDep, // Hasil Hitungan'status': 'pending',}).select().single(); // HATI-HATI DENGAN SINGLE()! Pastikan hanya 1 record terinsert.final String newRouteId = routeRes['id'];// I. INSERT KE route_menusList<Map<String, dynamic>> routeMenuData = menuIds.map((id) => {'route_id': newRouteId, 'menu_id': id}).toList();await _supabase.from('route_menus').insert(routeMenuData);// J. INSERT STOPS (DENGAN ESTIMASI WAKTU TIBA / ETA)List<Map<String, dynamic>> stopsData = [];int currentSeconds = departureSeconds;for (int k = 0; k < schools.length; k++) {currentSeconds += travelSecondsPerLeg[k];int h = currentSeconds ~/ 3600;int m = (currentSeconds % 3600) ~/ 60;String fmtEta ="${h.toString().padLeft(2, '0')}:${m.toString().padLeft(2, '0')}:00";stopsData.add({'route_id': newRouteId,'school_id': schools[k].id,'sequence_order': k + 1,'estimated_arrival_time': fmtEta, // ETA Real berdasarkan jarak'status': 'pending',});currentSeconds += (10 * 60);}await _supabase.from('delivery_stops').insert(stopsData);// K. AUTO-INSERT JADWAL PRODUKSIint totalPortions = schools.fold(0, (sum, item) => sum + item.studentCount);String bottleneckMenuId = menuIds.first;if (bottleneckMenusData != null) {final menuMatch = bottleneckMenusData.firstWhereOrNull((menu) => (menu['cooking_duration_minutes'] as int) == cookingDuration,);bottleneckMenuId = menuMatch?['id'] as String? ?? menuIds.first;}String notes = notesPrefix != null? '$notesPrefix | Rute #$newRouteId, Bottleneck: ${cookingDuration} mnt': (isDailyBatch? 'Auto-Daily Batch (Rute #$newRouteId, Bottleneck: ${cookingDuration} mnt)': 'Auto-Schedule (Rute #$newRouteId, Bottleneck: ${cookingDuration} mnt)'); // <--- LOGIKA NOTES BARUawait _supabase.from('production_schedules').insert({'sppg_id': sppgId,'date': date.toIso8601String().split('T')[0],'menu_id': bottleneckMenuId,'total_portions': totalPortions,'start_cooking_time': fmtCook,'target_finish_time': fmtDep,'notes': notes,});}// --- 8. AMBIL NEXT STOP YANG BELUM SELESAI ---Future<Map<String, dynamic>?> getNextPendingStop(String routeId) async {try {// Ambil stop dengan sequence order terendah (LIMIT 1)// yang statusnya BUKAN 'received', 'issue_reported', atau 'completed'final response = await _supabase.from('delivery_stops').select('*, schools(name)') // Hanya butuh nama sekolah.eq('route_id', routeId).not('status', 'in', '("received", "issue_reported", "completed")').order('sequence_order', ascending: true).limit(1).single();return response;} on PostgrestException catch (e) {// Jika tidak ada stop pending/active (semua sudah selesai), Supabase throw PGRST116.if (e.code == 'PGRST116') {return null;}throw Exception("Gagal ambil next stop: ${e.message}");} catch (e) {// Error umum lainnyareturn null;}}Future<void> updateRouteSchools(String routeId,List<School> newSchoolList,int cookingDuration,) async {try {final routeData = await _supabase.from('delivery_routes').select().eq('id', routeId).single();final routeMenus = await _supabase.from('route_menus').select('menu_id').eq('route_id', routeId);final List<String> menuIds = routeMenus.map<String>((m) => m['menu_id'] as String).toList();final DateTime date = DateTime.parse(routeData['date']);final String vehicleId = routeData['vehicle_id'];final String courierId = routeData['courier_id'];final String sppgId = routeData['sppg_id'];// 2. Hapus Rute Lama (stops, route_menus, route)await _supabase.from('delivery_stops').delete().eq('route_id', routeId);await _supabase.from('route_menus').delete().eq('route_id', routeId);await _supabase.from('delivery_routes').delete().eq('id', routeId);// 3. Buat Ulang Rute dengan Sekolah Baru & Hitung Ulangawait _createSingleRouteCalculation(sppgId: sppgId,vehicleId: vehicleId,courierId: courierId,menuIds: menuIds,date: date,schools: newSchoolList,cookingDuration: cookingDuration,isDailyBatch: true,);} catch (e) {throw Exception("Gagal update rute: $e");}}// [BARU] Helper untuk CreateRouteScreen, mengambil rute hari tertentuFuture<List<Map<String, dynamic>>> getRoutesByDate(DateTime date) async {final userId = _supabase.auth.currentUser!.id;final profile = await _supabase.from('profiles').select('sppg_id').eq('id', userId).single();final String mySppgId = profile['sppg_id'];final response = await _supabase.from('delivery_routes').select('vehicle_id').eq('sppg_id', mySppgId).eq('date', DateFormat('yyyy-MM-dd').format(date));return List<Map<String, dynamic>>.from(response);}// ===========================================================================// BAGIAN 2: FUNGSI GET & READ DATA// ===========================================================================// --- 4. AMBIL RUTE BULANAN (KALENDER) ---Future<List<DeliveryRoute>> getRoutesByMonth(DateTime month) async {try {final userId = _supabase.auth.currentUser!.id;final profile = await _supabase.from('profiles').select('role, sppg_id').eq('id', userId).single();final startDate = DateTime(month.year, month.month, 1);final endDate = DateTime(month.year, month.month + 1, 0);var query = _supabase.from('delivery_routes').select('*, vehicles(plate_number), profiles!courier_id(full_name), route_menus(menu_id, menus(name))',).gte('date', startDate.toIso8601String()).lte('date', endDate.toIso8601String());if (profile['role'] == 'kurir') {query = query.eq('courier_id', userId);} else {query = query.eq('sppg_id', profile['sppg_id']);}final response = await query;return (response as List).map((json) => DeliveryRoute.fromJson(json)).toList();} catch (e) {throw Exception("Gagal ambil jadwal: $e");}}// --- 5. AMBIL SEMUA RUTE (LIST HISTORY ADMIN) ---Future<List<DeliveryRoute>> getMyRoutes({DateTime? date, // <--- TAMBAH FILTERString? vehicleId, // <--- TAMBAH FILTER}) async {try {final userId = _supabase.auth.currentUser!.id;final profile = await _supabase.from('profiles').select('sppg_id').eq('id', userId).single();final String mySppgId = profile['sppg_id'];var query = _supabase.from('delivery_routes').select('*, vehicles(plate_number), profiles!courier_id(full_name), route_menus(menu_id, menus(name))',).eq('sppg_id', mySppgId);// Terapkan filter tanggal jika adaif (date != null) {query = query.eq('date', DateFormat('yyyy-MM-dd').format(date));}// Terapkan filter mobil jika ada (kecuali 'all')if (vehicleId != null && vehicleId != 'all') {query = query.eq('vehicle_id', vehicleId);}final response = await query.order('date', ascending: false).order('departure_time', ascending: false);final List<dynamic> data = response;return data.map((json) => DeliveryRoute.fromJson(json)).toList();} catch (e) {throw Exception("Gagal ambil rute admin: $e");}}// --- 6. AMBIL RUTE KURIR (LIST) ---Future<List<DeliveryRoute>> getRoutesByCourier() async {try {final currentCourierId = _supabase.auth.currentUser!.id;final response = await _supabase.from('delivery_routes').select('*, vehicles(plate_number), profiles!courier_id(full_name), route_menus(menu_id, menus(name))',).eq('courier_id', currentCourierId).order('date', ascending: false);final List<dynamic> data = response;return data.map((json) => DeliveryRoute.fromJson(json)).toList();} catch (e) {throw Exception("Gagal ambil rute kurir: $e");}}// --- 7. AMBIL DETAIL STOPS (DENGAN KOORDINAT GPS) ---Future<List<Map<String, dynamic>>> getRouteStops(String routeId) async {try {final response = await _supabase.from('delivery_stops').select('*, schools(name, address, gps_lat, gps_long, student_count, menu_default, deadline_time, service_time_minutes, is_high_risk)',).eq('route_id', routeId).order('sequence_order', ascending: true);return List<Map<String, dynamic>>.from(response);} catch (e) {throw Exception("Gagal ambil detail stop: $e");}}// ===========================================================================// BAGIAN 3: UPDATE STATUS & UTILITAS// ===========================================================================Future<void> updateRouteStatus(String routeId, String newStatus) async {try {// [FIX] CHANGE STATUS FROM ACTIVE TO COMPLETED (OR VICE VERSA)await _supabase.from('delivery_routes').update({'status': newStatus}).eq('id', routeId);} catch (e) {throw Exception("Gagal update status rute: $e");}}Future<void> updateStopStatus(String stopId, String newStatus) async {try {await _supabase.from('delivery_stops').update({'status': newStatus,'arrival_time': newStatus == 'completed'? DateTime.now().toIso8601String(): null,}).eq('id', stopId);} catch (e) {throw Exception("Gagal update status stop: $e");}}Future<void> validateLoadWithPhoto(String routeId, String photoUrl) async {try {await _supabase.from('delivery_routes').update({'status': 'active','load_proof_photo_url': photoUrl,'start_time': DateTime.now().toIso8601String(),}).eq('id', routeId);} catch (e) {throw Exception("Gagal validasi muatan: $e");}}Future<void> completeStopWithPhoto(String stopId, String photoUrl) async {try {await _supabase.from('delivery_stops').update({'status': 'completed','courier_proof_photo_url': photoUrl,'arrival_time': DateTime.now().toIso8601String(),}).eq('id', stopId);} catch (e) {throw Exception("Gagal update stop: $e");}}Future<void> deleteRoute(String routeId) async {try {await _supabase.from('route_menus').delete().eq('route_id', routeId);await _supabase.from('delivery_routes').delete().eq('id', routeId);} catch (e) {throw Exception("Gagal menghapus rute: $e");}}// --- UTILITAS PETA & LOKASI ---Future<List<LatLng>> getRoutePolyline(List<LatLng> coordinates) async {try {if (coordinates.length < 2) return [];String coordString = coordinates.map((p) => "${p.longitude},${p.latitude}").join(';');final url = Uri.parse('https://router.project-osrm.org/route/v1/driving/$coordString?overview=full&geometries=geojson',);final response = await http.get(url);if (response.statusCode == 200) {final data = jsonDecode(response.body);if (data['code'] != 'Ok') return [];final List<dynamic> coords =data['routes'][0]['geometry']['coordinates'];return coords.map((c) => LatLng(c[1].toDouble(), c[0].toDouble())).toList();} else {return [];}} catch (e) {return [];}}Future<LatLng?> getSppgLocation() async {try {final userId = _supabase.auth.currentUser!.id;final profile = await _supabase.from('profiles').select('sppg_id').eq('id', userId).single();final String sppgId = profile['sppg_id'];final sppgData = await _supabase.from('sppgs').select('gps_lat, gps_long').eq('id', sppgId).single();if (sppgData['gps_lat'] != null && sppgData['gps_long'] != null) {return LatLng(double.parse(sppgData['gps_lat'].toString()),double.parse(sppgData['gps_long'].toString()),);}return null;} catch (e) {return null;}}}

=== FILE: lib/features/admin_sppg/services/vehicle_service.dart ===
import 'package:supabase_flutter/supabase_flutter.dart';import '../../../models/vehicle_model.dart';class VehicleService {final _supabase = Supabase.instance.client;// 1. AMBIL LIST TRANSPORTASIFuture<List<Vehicle>> getMyVehicles() async {try {final userId = _supabase.auth.currentUser!.id;final profile = await _supabase.from('profiles').select('sppg_id').eq('id', userId).single();final String mySppgId = profile['sppg_id'];// [FIX KRITIS ALIAS PROFILES]:// Menggunakan nama relasi yang unik (courier_id_fk & assistant_id_fk)// yang mengarah ke kolom profiles. Kita beri nama baru untuk kolom yang kembali (profiles_main, profiles_assist)final response = await _supabase.from('vehicles').select('*, profiles!courier_profile_id(id, full_name), profiles_assist:profiles!assistant_courier_id(id, full_name)', // <-- FIX: Gunakan ALIAS profiles_assist).eq('sppg_id', mySppgId).order('is_active', ascending: false);final List<dynamic> data = response;return data.map((json) => Vehicle.fromJson(json)).toList();} catch (e) {throw Exception('Gagal ambil data transportasi: $e');}}// 2. TAMBAH TRANSPORTASI BARUFuture<void> createVehicle(Map<String, dynamic> data) async {try {final userId = _supabase.auth.currentUser!.id;final profile = await _supabase.from('profiles').select('sppg_id').eq('id', userId).single();// Inject ID SPPG otomatisdata['sppg_id'] = profile['sppg_id'];await _supabase.from('vehicles').insert(data);} catch (e) {throw Exception('Gagal menambah transportasi: $e');}}// 3. UPDATE STATUS (Aktif/Nonaktif)Future<void> toggleStatus(String vehicleId, bool currentStatus) async {try {await _supabase.from('vehicles').update({'is_active': !currentStatus}).eq('id', vehicleId);} catch (e) {throw Exception('Gagal update status: $e');}}Future<void> updateVehicle(String id, Map<String, dynamic> data) async {try {await _supabase.from('vehicles').update(data).eq('id', id);} catch (e) {throw Exception('Gagal update kendaraan: $e');}}Future<void> deleteVehicle(String id) async {try {// Hapus kendaraanawait _supabase.from('vehicles').delete().eq('id', id);} catch (e) {throw Exception('Gagal menghapus kendaraan: $e');}}}

=== FILE: lib/features/admin_sppg/services/report_service.dart ===
// === FILE: lib/features/admin_sppg/services/report_service.dart ===import 'package:supabase_flutter/supabase_flutter.dart'; // Perlu pastikan ini diimpor dengan aliasimport '../services/teacher_service.dart'; // Import TeacherModelimport '../services/coordinator_service.dart'; // Import CoordinatorModelclass AdminReportService {final _supabase = Supabase.instance.client;Future<String> _getMySppgId() async {final userId = _supabase.auth.currentUser!.id;final profile = await _supabase.from('profiles').select('sppg_id').eq('id', userId).single();if (profile['sppg_id'] == null)throw Exception("User profile missing SPPG ID.");return profile['sppg_id'];}// 1. GET SUMMARY OF ALL PERSONNEL (Kurir, Koord, Wali Kelas)Future<List<Map<String, dynamic>>> getPersonnelSummary() async {try {final mySppgId = await _getMySppgId();// [FIX KRITIS FINAL]: Menggunakan .filter() dengan sintaks string SQL yang eksplisit// Ini memaksa PostgREST untuk mencari role yang cocok di dalam array literal.const String roleFilterString = '("kurir", "koordinator", "walikelas")';final response = await _supabase.from('profiles').select('id, full_name, email, role, phone_number, class_name, student_count_class, school_id, schools(name)',).eq('sppg_id', mySppgId).filter('role','in',roleFilterString,) // <--- FIX AKHIR: Menggunakan filter string yang andal.order('role', ascending: true).order('full_name', ascending: true);return List<Map<String, dynamic>>.from(response);} catch (e) {throw Exception('Gagal ambil data personel: $e');}}// 2. GET ALL ACTIVE & HISTORY ROUTES WITH DETAILS (for Maps & History Tab)Future<List<Map<String, dynamic>>> getDetailedRoutes({DateTime? date,String? vehicleId,bool includeAllStatuses = false,}) async {try {final mySppgId = await _getMySppgId();var queryBuilder = _supabase.from('delivery_routes').select('*').eq('sppg_id', mySppgId);// Terapkan Filter Tanggalif (date != null) {final dateStr = date.toIso8601String().split('T')[0];queryBuilder = queryBuilder.eq('date', dateStr);}// Terapkan Filter Mobilif (vehicleId != null && vehicleId != 'all') {queryBuilder = queryBuilder.eq('vehicle_id', vehicleId);}// Menggunakan ALIAS BARU yang JELAS (Lebih aman)var finalQuery = queryBuilder.select('''id, date, vehicle_id, courier_id, status, departure_time, load_proof_photo_url,vehicles(plate_number),courier_data:profiles!courier_id(full_name),route_menus(menus(name)),delivery_stops(id, sequence_order, status, estimated_arrival_time, arrival_time, completion_time, schools(name))''');final responseData = await finalQuery;return List<Map<String, dynamic>>.from(responseData);} catch (e) {throw Exception('Gagal ambil detail rute: ${e.toString()}');}}}// Tidak ada perubahan di statistics_screen.dart karena logika tampilan sudah benar,// hanya data yang hilang dari service.

=== FILE: lib/features/admin_sppg/services/stats_service.dart ===
import 'package:supabase_flutter/supabase_flutter.dart';class StatsService {final _supabase = Supabase.instance.client;Future<String> _getMySppgId() async {final userId = _supabase.auth.currentUser!.id;final profile = await _supabase.from('profiles').select('sppg_id').eq('id', userId).single();return profile['sppg_id'];}// Hitung status pengiriman (Sukses vs Masalah vs Pending)Future<Map<String, int>> getDeliveryStats() async {try {final mySppgId = await _getMySppgId();// Ambil semua data stops yang terkait dengan SPPG ini// Join: delivery_routes -> filter SPPGfinal response = await _supabase.from('delivery_stops').select('status, delivery_routes!inner(sppg_id)').eq('delivery_routes.sppg_id', mySppgId);final List<dynamic> data = response;int received = 0; // Suksesint issues = 0; // Masalahint pending = 0; // Belum selesaifor (var item in data) {final status = item['status'];if (status == 'received') {received++;} else if (status == 'issue_reported') {issues++;} else {pending++; // pending, active, completed (belum confirm)}}return {'received': received,'issues': issues,'pending': pending,'total': data.length,};} catch (e) {throw Exception("Gagal hitung statistik: $e");}}}

=== FILE: lib/features/kurir/screens/route_detail_screen.dart ===
// === FILE: lib/features/kurir/screens/route_detail_screen.dart ===import 'dart:io';import 'package:flutter/material.dart';import 'package:flutter_map/flutter_map.dart';import 'package:latlong2/latlong.dart';import 'package:url_launcher/url_launcher.dart';import 'package:image_picker/image_picker.dart';import '../../admin_sppg/services/route_service.dart';import '../../../models/route_model.dart';import '../../../core/services/storage_service.dart';class RouteDetailScreen extends StatefulWidget {final DeliveryRoute route;const RouteDetailScreen({super.key, required this.route});@overrideState<RouteDetailScreen> createState() => _RouteDetailScreenState();}class _RouteDetailScreenState extends State<RouteDetailScreen> {final RouteService _routeService = RouteService();final StorageService _storageService = StorageService();final MapController _mapController = MapController();List<Map<String, dynamic>> _stops = [];List<LatLng> _polylinePoints = [];LatLng? _sppgLocation;bool _isLoading = true;String _currentStatus = 'pending';// [BARU] Variabel untuk Jam BerangkatString _departureTime = "--:--";@overridevoid initState() {super.initState();_currentStatus = widget.route.status;_departureTime = _formatTime(widget.route.departureTime,); // Ambil dari Model Route_fetchData();}String _formatTime(String? timeStr) {if (timeStr == null || timeStr.isEmpty) return "--:--";try {// Format HH:mm:ss -> HH:mmreturn timeStr.substring(0, 5);} catch (_) {return timeStr;}}void _zoomMap(double change) {final currentZoom = _mapController.camera.zoom;final newZoom = (currentZoom + change).clamp(3.0, 18.0);_mapController.move(_mapController.camera.center, newZoom);}Future<void> _fetchData() async {try {final origin = await _routeService.getSppgLocation();_sppgLocation = origin;final stopsData = await _routeService.getRouteStops(widget.route.id);List<LatLng> routingPoints = [];if (origin != null) routingPoints.add(origin);for (var i = 0; i < stopsData.length; i++) {final school = stopsData[i]['schools'];if (school['gps_lat'] != null && school['gps_long'] != null) {double? lat = double.tryParse(school['gps_lat'].toString());double? long = double.tryParse(school['gps_long'].toString());if (lat != null && long != null) {routingPoints.add(LatLng(lat, long));}}}List<LatLng> polyline = [];if (routingPoints.length >= 2) {polyline = await _routeService.getRoutePolyline(routingPoints);}if (!mounted) return;setState(() {_stops = stopsData;_polylinePoints = polyline;_isLoading = false;});if (routingPoints.isNotEmpty) {Future.delayed(const Duration(seconds: 1), () {if (!mounted) return;try {_mapController.fitCamera(CameraFit.bounds(bounds: LatLngBounds.fromPoints(routingPoints),padding: const EdgeInsets.all(60),),);} catch (_) {}});}} catch (e) {if (mounted) setState(() => _isLoading = false);}}// [BARU] Fungsi Cek & Selesaikan RuteFuture<void> _tryCompleteRoute() async {setState(() => _isLoading = true); // Use isLoading for temporary UI blocktry {// 1. Re-fetch stops to ensure data is up-to-datefinal stopsData = await _routeService.getRouteStops(widget.route.id);final totalStops = stopsData.length;final completedStops = stopsData.where((s) => s['status'] == 'completed').length;if (completedStops < totalStops) {if (!mounted) return;ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Belum semua sekolah Selesai (Completed)! Cek lagi, bego.",),backgroundColor: Colors.red,duration: Duration(seconds: 3),),);return;}// 2. Jika SEMUA stop sudah 'completed', baru update route status ke 'completed'await _routeService.updateRouteStatus(widget.route.id, 'completed');if (!mounted) return;ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Pengiriman Selesai. Status diubah ke Completed."),backgroundColor: Colors.green,duration: Duration(seconds: 3),),);// Update local state and exitsetState(() {_currentStatus = 'completed';_isLoading = false; // Turn off loading here, it's done.});// Optional: Pop the screen and refresh the previous listNavigator.pop(context, true);} catch (e) {if (!mounted) return;ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Gagal menyelesaikan rute: $e"),backgroundColor: Colors.red,),);} finally {if (mounted) setState(() => _isLoading = false);}}Future<void> _launchGoogleMaps(double lat, double long) async {final Uri googleMapsUrl = Uri.parse("google.navigation:q=$lat,$long&mode=d",);try {await launchUrl(googleMapsUrl);} catch (e) {if (mounted)ScaffoldMessenger.of(context,).showSnackBar(SnackBar(content: Text("Gagal: $e")));}}void _showValidationDialog() {File? photoFile;bool isSubmitting = false;showDialog(context: context,barrierDismissible: false,builder: (ctx) => StatefulBuilder(builder: (context, setDialogState) {return AlertDialog(title: const Text("Validasi Muatan"),content: Column(mainAxisSize: MainAxisSize.min,children: [const Text("Wajib lampirkan foto muatan di mobil."),const SizedBox(height: 15),GestureDetector(onTap: () async {final file = await _storageService.pickImage(ImageSource.camera,);if (file != null) setDialogState(() => photoFile = file);},child: Container(height: 120,width: double.infinity,decoration: BoxDecoration(color: Colors.grey[200],border: Border.all(color: Colors.grey),borderRadius: BorderRadius.circular(8),),child: photoFile == null? const Column(mainAxisAlignment: MainAxisAlignment.center,children: [Icon(Icons.camera_alt, size: 30),Text("FOTO BUKTI MUAT"),],): Image.file(photoFile!, fit: BoxFit.cover),),),if (isSubmitting)const Padding(padding: EdgeInsets.only(top: 10),child: LinearProgressIndicator(),),],),actions: [if (!isSubmitting)TextButton(onPressed: () => Navigator.pop(ctx),child: const Text("Batal"),),if (!isSubmitting)ElevatedButton(onPressed: () async {if (photoFile == null) {ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Foto bukti wajib ada!")),);return;}setDialogState(() => isSubmitting = true);try {final url = await _storageService.uploadEvidence(photoFile!,'loading_proof',);await _routeService.validateLoadWithPhoto(widget.route.id,url,);if (!mounted) return;Navigator.pop(ctx);setState(() => _currentStatus = 'active');ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Pengiriman Dimulai!")),);} catch (e) {setDialogState(() => isSubmitting = false);}},child: const Text("Mulai Pengiriman"),),],);},),);}void _showCompleteDialog(String stopId, String schoolName) {File? photoFile;bool isSubmitting = false;showDialog(context: context,builder: (ctx) => StatefulBuilder(builder: (context, setDialogState) {return AlertDialog(title: Text("Tiba di $schoolName"),content: Column(mainAxisSize: MainAxisSize.min,children: [const Text("Lampirkan foto bukti makanan sampai."),const SizedBox(height: 15),GestureDetector(onTap: () async {final file = await _storageService.pickImage(ImageSource.camera,);if (file != null) setDialogState(() => photoFile = file);},child: Container(height: 120,width: double.infinity,decoration: BoxDecoration(color: Colors.grey[200],border: Border.all(color: Colors.grey),),child: photoFile == null? const Column(mainAxisAlignment: MainAxisAlignment.center,children: [Icon(Icons.camera_alt),Text("FOTO BUKTI"),],): Image.file(photoFile!, fit: BoxFit.cover),),),if (isSubmitting)const Padding(padding: EdgeInsets.only(top: 10),child: LinearProgressIndicator(),),],),actions: [if (!isSubmitting)TextButton(onPressed: () => Navigator.pop(ctx),child: const Text("Batal"),),if (!isSubmitting)ElevatedButton(onPressed: () async {if (photoFile == null) {ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Foto bukti wajib ada!")),);return;}setDialogState(() => isSubmitting = true);try {final url = await _storageService.uploadEvidence(photoFile!,'arrival_proof',);// Use completeStopWithPhoto which sets status to 'completed'await _routeService.completeStopWithPhoto(stopId, url);if (!mounted) return;Navigator.pop(ctx);_fetchData(); // Refresh list stopsScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Selesai di $schoolName!")),);} catch (e) {setDialogState(() => isSubmitting = false);}},child: const Text("Selesai"),),],);},),);}@overrideWidget build(BuildContext context) {final bool allStopsCompleted =_stops.isNotEmpty && _stops.every((s) => s['status'] == 'completed');final bool isRouteActive = _currentStatus == 'active';final bool isRouteCompleted = _currentStatus == 'completed';return Scaffold(appBar: AppBar(title: const Text("Detail Pengiriman"),backgroundColor: isRouteCompleted? Colors.green[800]: (isRouteActive ? Colors.green[700] : Colors.blue[800]),foregroundColor: Colors.white,),body: Column(children: [// --- PETA (TETAP SAMA) ---SizedBox(height: 250,child: Stack(children: [FlutterMap(mapController: _mapController,options: const MapOptions(initialCenter: LatLng(-6.9175, 107.6191),initialZoom: 13.0,interactionOptions: InteractionOptions(flags: InteractiveFlag.all,),),children: [TileLayer(urlTemplate:'https://tile.openstreetmap.org/{z}/{x}/{y}.png',userAgentPackageName: 'com.example.mbg_monitoring',),PolylineLayer(polylines: [Polyline(points: _polylinePoints,strokeWidth: 5.0,color: Colors.blueAccent,),],),MarkerLayer(markers: [if (_sppgLocation != null)Marker(point: _sppgLocation!,width: 60,height: 60,child: const Column(mainAxisAlignment: MainAxisAlignment.center,children: [Icon(Icons.store_mall_directory,color: Colors.purple,size: 35,),Text("DAPUR",style: TextStyle(fontSize: 10,fontWeight: FontWeight.bold,color: Colors.purple,backgroundColor: Colors.white70,),),],),),..._stops.map((stop) {final school = stop['schools'];final isCompleted = stop['status'] == 'completed';if (school['gps_lat'] == null)return const Marker(point: LatLng(0, 0),child: SizedBox(),);double lat = double.parse(school['gps_lat'].toString(),);double long = double.parse(school['gps_long'].toString(),);return Marker(point: LatLng(lat, long),width: 60,height: 60,child: Column(mainAxisAlignment: MainAxisAlignment.center,children: [Icon(Icons.location_on,color: isCompleted? Colors.green: Colors.red,size: 35,),Container(padding: const EdgeInsets.symmetric(horizontal: 4,vertical: 2,),decoration: BoxDecoration(color: Colors.white,borderRadius: BorderRadius.circular(4),border: Border.all(color: Colors.grey),),child: Text("${stop['sequence_order']}",style: const TextStyle(fontSize: 10,fontWeight: FontWeight.bold,),),),],),);}).toList(),],),],),Positioned(right: 10,bottom: 10,child: Column(children: [FloatingActionButton.small(heroTag: "btnZoomIn",onPressed: () => _zoomMap(1),backgroundColor: Colors.white,child: const Icon(Icons.add, color: Colors.black),),const SizedBox(height: 10),FloatingActionButton.small(heroTag: "btnZoomOut",onPressed: () => _zoomMap(-1),backgroundColor: Colors.white,child: const Icon(Icons.remove, color: Colors.black),),],),),],),),// --- [BARU] INFO JADWAL BERANGKAT ---Container(padding: const EdgeInsets.symmetric(vertical: 12, horizontal: 16),color: Colors.orange[50],child: Row(mainAxisAlignment: MainAxisAlignment.spaceBetween,children: [const Text("Jadwal Berangkat:",style: TextStyle(fontWeight: FontWeight.bold),),Text(_departureTime,style: const TextStyle(fontSize: 18,fontWeight: FontWeight.bold,color: Colors.orange,),),],),),Expanded(child: _isLoading? const Center(child: CircularProgressIndicator()): ListView.builder(padding: const EdgeInsets.all(10),itemCount: _stops.length,itemBuilder: (context, index) {final stop = _stops[index];final school = stop['schools'];// FIX KRITIS: Cek status mana saja yang sudah final dan tidak perlu tombol "Tiba"final status = stop['status'];final isFinalizedByCourierOrClient =status == 'completed' ||status == 'received' ||status == 'issue_reported';// Ambil ETA (Estimasi Tiba)String eta = _formatTime(stop['estimated_arrival_time']);double? lat, long;if (school['gps_lat'] != null) {lat = double.parse(school['gps_lat'].toString());long = double.parse(school['gps_long'].toString());}return Card(color: isFinalizedByCourierOrClient? Colors.green[50]: Colors.white,elevation: 3,margin: const EdgeInsets.only(bottom: 10),child: ListTile(contentPadding: const EdgeInsets.symmetric(horizontal: 16,vertical: 8,),leading: CircleAvatar(backgroundColor: isFinalizedByCourierOrClient? Colors.green: Colors.grey[300],child: Text("${index + 1}",style: TextStyle(color: isFinalizedByCourierOrClient? Colors.white: Colors.black,fontWeight: FontWeight.bold,),),),title: Text(school['name'],style: const TextStyle(fontWeight: FontWeight.bold),),// [BARU] Tampilkan Estimasi Tibasubtitle: Text("Est. Tiba: $eta\nMenu: ${school['menu_default'] ?? '-'}",),isThreeLine: true,trailing: Row(mainAxisSize: MainAxisSize.min,children: [if (lat != null && long != null)IconButton(icon: const Icon(Icons.directions,color: Colors.blue,),onPressed: () =>_launchGoogleMaps(lat!, long!),tooltip: "Navigasi",),// UBAH LOGIK BUTTON 'TIBA'if (_currentStatus == 'active' &&!isFinalizedByCourierOrClient)ElevatedButton(style: ElevatedButton.styleFrom(backgroundColor: Colors.green,foregroundColor: Colors.white,),onPressed: () => _showCompleteDialog(stop['id'],school['name'],),child: const Text("Tiba"),)// Tampilkan checklist jika sudah final (completed, received, or issue_reported)else if (isFinalizedByCourierOrClient)const Icon(Icons.check_circle,color: Colors.green,size: 32,),],),),);},),),],),// --- BOTTOM NAVIGATION BAR / ACTION BUTTONS ---bottomNavigationBar: isRouteCompleted? null: Padding(padding: const EdgeInsets.all(16.0),child: Column(mainAxisSize: MainAxisSize.min,children: [// 1. VALIDASI & MULAI (HANYA MUNCUL JIKA PENDING)if (_currentStatus == 'pending')SizedBox(width: double.infinity,child: ElevatedButton.icon(onPressed: _isLoading ? null : _showValidationDialog,icon: const Icon(Icons.checklist),label: const Text("VALIDASI MUATAN & MULAI"),style: ElevatedButton.styleFrom(backgroundColor: Colors.blue[800],foregroundColor: Colors.white,padding: const EdgeInsets.symmetric(vertical: 15),),),),// 2. SELESAIKAN RUTE (HANYA MUNCUL JIKA ACTIVE DAN SEMUA STOP COMPLETED)if (isRouteActive && allStopsCompleted) ...[const SizedBox(height: 10),SizedBox(width: double.infinity,child: ElevatedButton.icon(onPressed: _isLoading? null: _tryCompleteRoute, // Call the method to complete routeicon: const Icon(Icons.check_circle),label: _isLoading? const CircularProgressIndicator(color: Colors.white,): const Text("SELESAIKAN PENGIRIMAN TOTAL",style: TextStyle(fontWeight: FontWeight.bold),),style: ElevatedButton.styleFrom(backgroundColor: Colors.green[800],foregroundColor: Colors.white,padding: const EdgeInsets.symmetric(vertical: 15),),),),],],),),);}}

=== FILE: lib/features/kurir/screens/dashboard_kurir_screen.dart ===
import 'package:flutter/material.dart';import 'package:supabase_flutter/supabase_flutter.dart';import 'package:intl/intl.dart';import 'package:table_calendar/table_calendar.dart';import '../../admin_sppg/services/route_service.dart';import '../../autentikasi/screens/login_screen.dart';import '../../../models/route_model.dart';import 'route_detail_screen.dart';import '../../../core/screens/profile_screen.dart';class DashboardKurirScreen extends StatefulWidget {const DashboardKurirScreen({super.key});@overrideState<DashboardKurirScreen> createState() => _DashboardKurirScreenState();}class _DashboardKurirScreenState extends State<DashboardKurirScreen> {final RouteService _routeService = RouteService();DateTime _focusedDay = DateTime.now();DateTime _selectedDay = DateTime.now();// Format Kalender DefaultCalendarFormat _calendarFormat = CalendarFormat.month;Map<DateTime, List<DeliveryRoute>> _routes = {};bool _isLoading = true;@overridevoid initState() {super.initState();_fetchRoutes();}Future<void> _fetchRoutes() async {setState(() => _isLoading = true);try {final data = await _routeService.getRoutesByMonth(_focusedDay);Map<DateTime, List<DeliveryRoute>> newMap = {};for (var route in data) {final date = DateTime.parse(route.date);final dateKey = DateTime(date.year, date.month, date.day);if (newMap[dateKey] == null) newMap[dateKey] = [];newMap[dateKey]!.add(route);}if (mounted) {setState(() {_routes = newMap;_isLoading = false;});}} catch (e) {if (mounted) setState(() => _isLoading = false);}}List<DeliveryRoute> _getRoutesForDay(DateTime day) {final dateKey = DateTime(day.year, day.month, day.day);return _routes[dateKey] ?? [];}Future<void> _logout() async {await Supabase.instance.client.auth.signOut();if (!mounted) return;Navigator.of(context).pushAndRemoveUntil(MaterialPageRoute(builder: (_) => const LoginScreen()),(route) => false,);}@overrideWidget build(BuildContext context) {return Scaffold(appBar: AppBar(title: const Text("Jadwal Pengiriman"),backgroundColor: Colors.blue[800],foregroundColor: Colors.white,actions: [// [BARU] TOMBOL REFRESHIconButton(icon: const Icon(Icons.refresh),tooltip: "Refresh Data",onPressed: _fetchRoutes, // Panggil fungsi refresh data),IconButton(icon: const Icon(Icons.account_circle, size: 30),onPressed: () => Navigator.push(context,MaterialPageRoute(builder: (_) => const ProfileScreen()),),),],),body: Column(children: [// --- HEADER CUSTOM: DROPDOWN FORMAT ---Container(padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),color: Colors.grey[100],child: Row(mainAxisAlignment: MainAxisAlignment.spaceBetween,children: [const Text("Tampilan Kalender:",style: TextStyle(fontWeight: FontWeight.bold),),// DROPDOWN MENUContainer(padding: const EdgeInsets.symmetric(horizontal: 12),decoration: BoxDecoration(color: Colors.white,borderRadius: BorderRadius.circular(8),border: Border.all(color: Colors.grey.shade300),),child: DropdownButtonHideUnderline(child: DropdownButton<CalendarFormat>(value: _calendarFormat,icon: const Icon(Icons.arrow_drop_down,color: Colors.blue,),items: const [DropdownMenuItem(value: CalendarFormat.month,child: Text("Bulan (Full)"),),DropdownMenuItem(value: CalendarFormat.twoWeeks,child: Text("2 Minggu"),),DropdownMenuItem(value: CalendarFormat.week,child: Text("1 Minggu"),),],onChanged: (format) {if (format != null) {setState(() {_calendarFormat = format;});}},),),),],),),// --- KALENDER ---TableCalendar<DeliveryRoute>(firstDay: DateTime.utc(2024, 1, 1),lastDay: DateTime.utc(2030, 12, 31),focusedDay: _focusedDay,selectedDayPredicate: (day) => isSameDay(_selectedDay, day),// Gunakan variable state yang diubah oleh DropdowncalendarFormat: _calendarFormat,// Matikan tombol format bawaan karena kita sudah punya dropdownheaderStyle: const HeaderStyle(formatButtonVisible: false,titleCentered: true,),eventLoader: _getRoutesForDay,onDaySelected: (selected, focused) {setState(() {_selectedDay = selected;_focusedDay = focused;});},onPageChanged: (focused) {_focusedDay = focused;_fetchRoutes();},calendarStyle: const CalendarStyle(markerDecoration: BoxDecoration(color: Colors.blue,shape: BoxShape.circle,),todayDecoration: BoxDecoration(color: Colors.orange,shape: BoxShape.circle,),selectedDecoration: BoxDecoration(color: Colors.blue,shape: BoxShape.circle,),),),const Divider(thickness: 1, height: 1),// --- LIST RUTE HARI INI ---Expanded(child: _isLoading? const Center(child: CircularProgressIndicator()): _buildDayList(),),],),);}// Helper untuk format waktuString _formatTime(String? timeStr) {if (timeStr == null || timeStr.isEmpty) return "--:--";try {// Ambil 5 karakter pertama (HH:mm)return timeStr.substring(0, 5);} catch (_) {return timeStr;}}Widget _buildDayList() {final routes = _getRoutesForDay(_selectedDay);if (routes.isEmpty) {return Center(child: Column(mainAxisAlignment: MainAxisAlignment.center,children: [Icon(Icons.event_busy, size: 60, color: Colors.grey[300]),const SizedBox(height: 10),Text("Tidak ada pengiriman tgl ${DateFormat('d MMM').format(_selectedDay)}",style: const TextStyle(color: Colors.grey),),],),);}return ListView.builder(padding: const EdgeInsets.all(12),itemCount: routes.length,itemBuilder: (context, index) {final route = routes[index];// >>> WRAP DALAM FUTURE BUILDER UNTUK MENDAPATKAN NEXT STOP <<<return FutureBuilder<Map<String, dynamic>?>(future: _routeService.getNextPendingStop(route.id),builder: (context, snapshot) {final nextStop = snapshot.data;String nextDestination = "Semua Stop Selesai";String nextTime = "--:--";bool isOngoing =route.status == 'active' || route.status == 'pending';if (snapshot.connectionState == ConnectionState.waiting) {// Tampilkan loading minimal saat fetch next stopnextDestination = "Mencari tujuan...";} else if (route.status == 'completed') {nextDestination = "Rute Selesai Total";} else if (nextStop != null && isOngoing) {// Jika ada stop pending, ambil nama sekolah dan ETA-nyanextDestination ="Tujuan Berikutnya: ${nextStop['schools']['name']}";nextTime = _formatTime(nextStop['estimated_arrival_time']);} else if (route.status == 'pending') {// Jika status pending dan nextStop null, berarti belum dimulai (SPPG)nextDestination = "Menunggu Validasi Muatan di SPPG";nextTime = _formatTime(route.departureTime);}return Card(elevation: 3,// Warna card sesuai status, jika active/pending gunakan warna berbedacolor: route.status == 'completed'? Colors.green[50]: (route.status == 'active'? Colors.yellow[100]: Colors.white),margin: const EdgeInsets.only(bottom: 12),child: ListTile(leading: Icon(route.status == 'completed'? Icons.check_circle: Icons.local_shipping,color: route.status == 'completed'? Colors.green: Colors.blue,size: 32,),title: Text("Armada: ${route.vehiclePlate ?? '-'}",style: const TextStyle(fontWeight: FontWeight.bold),),subtitle: Column(crossAxisAlignment: CrossAxisAlignment.start,children: [Text("Status: ${route.status.toUpperCase()}",style: TextStyle(fontSize: 12,color: route.status == 'active'? Colors.blue[800]: Colors.grey[700],),),const SizedBox(height: 4),// >>> DETAIL BARU: TUJUAN DAN WAKTU <<<Text(nextDestination,style: const TextStyle(fontWeight: FontWeight.w500),),Text("Est. Tiba/Berangkat: $nextTime",style: TextStyle(fontSize: 12,color: route.status == 'active'? Colors.orange[800]: Colors.grey,),),],),isThreeLine: true,trailing: const Icon(Icons.arrow_forward_ios, size: 16),onTap: () {Navigator.push(context,MaterialPageRoute(builder: (_) => RouteDetailScreen(route: route),),).then((val) {_fetchRoutes();});},),);},);},);}}

=== FILE: .env ===
SUPABASE_URL=https://mqyfrqgfpqwlrloqtpvi.supabase.coSUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1xeWZycWdmcHF3bHJsb3F0cHZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0NTMxMDMsImV4cCI6MjA3OTAyOTEwM30.KoXKouhFN0H7Iz9MSnRhFQuBIePVMwWyXmrzSv3rEeQ

=== FILE: pubspec.yaml ===
name: rplldescription: "A new Flutter project."publish_to: 'none' # Remove this line if you wish to publish to pub.devversion: 1.0.0+1environment:sdk: ^3.9.2dependencies:flutter:sdk: flutter# Iconscupertino_icons: ^1.0.8# Backend & Databasesupabase_flutter: ^2.10.3# Fitur Hardware & Lokasigoogle_maps_flutter: ^2.14.0geolocator: ^14.0.2camera: ^0.11.3image_picker: ^1.2.1# State Management & Routingprovider: ^6.1.5+1go_router: ^17.0.0# Utilitasintl: ^0.20.2flutter_dotenv: ^6.0.0flutter_map: ^8.2.2latlong2: ^0.9.1http: ^1.6.0url_launcher: ^6.3.2fl_chart: ^1.1.1table_calendar: ^3.2.0dev_dependencies:flutter_test:sdk: flutterflutter_lints: ^5.0.0flutter:uses-material-design: true# Bagian ini yang paling PENTING spasinya harus pasassets:- .env

=== FILE: android/app/src/main/AndroidManifest.xml ===
<manifest xmlns:android="http://schemas.android.com/apk/res/android"><uses-permission android:name="android.permission.INTERNET"/><uses-permission android:name="android.permission.ACCESS_FINE_LOCATION"/><uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION"/><uses-permission android:name="android.permission.CAMERA"/><uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"/><uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"/><queries><intent><action android:name="android.intent.action.VIEW" /><data android:scheme="google.navigation" /></intent><intent><action android:name="android.intent.action.VIEW" /><data android:scheme="geo" /></intent><intent><action android:name="android.intent.action.VIEW" /><data android:scheme="https" /></intent><intent><action android:name="android.intent.action.PROCESS_TEXT"/><data android:mimeType="text/plain"/></intent></queries><applicationandroid:label="SMASH"android:name="${applicationName}"android:icon="@mipmap/ic_launcher"><activityandroid:name=".MainActivity"android:exported="true"android:launchMode="singleTop"android:taskAffinity=""android:theme="@style/LaunchTheme"android:configChanges="orientation|keyboardHidden|keyboard|screenSize|smallestScreenSize|locale|layoutDirection|fontScale|screenLayout|density|uiMode"android:hardwareAccelerated="true"android:windowSoftInputMode="adjustResize"><meta-dataandroid:name="io.flutter.embedding.android.NormalTheme"android:resource="@style/NormalTheme"/><intent-filter><action android:name="android.intent.action.MAIN"/><category android:name="android.intent.category.LAUNCHER"/></intent-filter></activity><meta-dataandroid:name="flutterEmbedding"android:value="2" /></application></manifest>

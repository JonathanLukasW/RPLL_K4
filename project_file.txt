
=== FILE: lib/main.dart ===
import 'package:flutter/material.dart';import 'package:flutter_dotenv/flutter_dotenv.dart';import 'package:supabase_flutter/supabase_flutter.dart';// [BARU] Import ini wajib biar format tanggal Indonesia jalanimport 'package:intl/date_symbol_data_local.dart';// Import halaman loginimport 'features/autentikasi/screens/login_screen.dart';void main() async {WidgetsFlutterBinding.ensureInitialized();// 1. Muat file rahasia .envawait dotenv.load(fileName: ".env");// 2. Nyalakan Koneksi Supabaseawait Supabase.initialize(url: dotenv.env['SUPABASE_URL']!,anonKey: dotenv.env['SUPABASE_ANON_KEY']!,);// [BARU] 3. Inisialisasi Format Tanggal Bahasa Indonesia// Ini biar DateFormat('EEEE, d MMMM yyyy', 'id_ID') gak errorawait initializeDateFormatting('id_ID', null);runApp(const MyApp());}class MyApp extends StatelessWidget {const MyApp({super.key});@overrideWidget build(BuildContext context) {return MaterialApp(title: 'MBG Logistics',debugShowCheckedModeBanner: false,theme: ThemeData(colorScheme: ColorScheme.fromSeed(seedColor: Colors.green),useMaterial3: true,inputDecorationTheme: const InputDecorationTheme(border: OutlineInputBorder(),filled: true,fillColor: Colors.white,),),home: const LoginScreen(),);}}

=== FILE: lib/models/school_model.dart ===
class School {final String id;final String sppgId;final String name;final String? address;final double? latitude;final double? longitude;final int studentCount;final String? deadlineTime;final int serviceTimeMinutes;final bool isHighRisk;// [BARU] Field untuk VRP Constraintsfinal int toleranceMinutes;final String? menuDefault;School({required this.id,required this.sppgId,required this.name,this.address,this.latitude,this.longitude,this.studentCount = 0,this.deadlineTime,this.serviceTimeMinutes = 10,this.isHighRisk = false,this.toleranceMinutes = 45, // Default 45 menitthis.menuDefault,});factory School.fromJson(Map<String, dynamic> json) {return School(id: json['id'].toString(),sppgId: json['sppg_id'].toString(),name: json['name'] ?? 'Tanpa Nama Sekolah',address: json['address'],latitude: json['gps_lat'] != null ? double.tryParse(json['gps_lat'].toString()) : null,longitude: json['gps_long'] != null ? double.tryParse(json['gps_long'].toString()) : null,studentCount: json['student_count'] != null ? int.parse(json['student_count'].toString()) : 0,serviceTimeMinutes: json['service_time_minutes'] != null ? int.parse(json['service_time_minutes'].toString()) : 10,isHighRisk: json['is_high_risk'] ?? false,deadlineTime: json['deadline_time'],// [BARU] Parsing kolom tambahantoleranceMinutes: json['tolerance_minutes'] != null ? int.parse(json['tolerance_minutes'].toString()) : 45,menuDefault: json['menu_default'],);}Map<String, dynamic> toJson() {return {'sppg_id': sppgId,'name': name,'address': address,'gps_lat': latitude,'gps_long': longitude,'student_count': studentCount,'deadline_time': deadlineTime,'service_time_minutes': serviceTimeMinutes,'is_high_risk': isHighRisk,// [BARU] Properti tambahan'tolerance_minutes': toleranceMinutes,'menu_default': menuDefault,};}}

=== FILE: lib/models/menu_model.dart ===
class Menu {final String id;final String sppgId;final String name;final String category;final int cookingDurationMinutes;Menu({required this.id,required this.sppgId,required this.name,required this.category,required this.cookingDurationMinutes,});factory Menu.fromJson(Map<String, dynamic> json) {return Menu(id: json['id'].toString(),sppgId: json['sppg_id'].toString(),name: json['name'] ?? 'Menu Baru',category: json['category'] ?? 'Lain-lain',cookingDurationMinutes: json['cooking_duration_minutes'] != null? int.parse(json['cooking_duration_minutes'].toString()): 0,);}Map<String, dynamic> toJson() {return {'sppg_id': sppgId,'name': name,'category': category,'cooking_duration_minutes': cookingDurationMinutes,};}}

=== FILE: lib/models/sppg_model.dart ===
class Sppg {final String id;final String name;final String? address;final String? email;final String? phone;final double? latitude;final double? longitude;// [BARU]final String? establishedDate;Sppg({required this.id,required this.name,this.address,this.email,this.phone,this.latitude,this.longitude,this.establishedDate,});factory Sppg.fromJson(Map<String, dynamic> json) {return Sppg(id: json['id'].toString(),name: json['name'] ?? 'Tanpa Nama',address: json['address'],email: json['email'],phone: json['phone'],latitude: json['gps_lat'] != null ? double.tryParse(json['gps_lat'].toString()) : null,longitude: json['gps_long'] != null ? double.tryParse(json['gps_long'].toString()) : null,// [BARU]establishedDate: json['established_date'],);}}

=== FILE: lib/models/production_schedule_model.dart ===
class ProductionSchedule {final String id;final DateTime date;final String menuId;final String menuName; // Dari relasifinal int totalPortions;final String? startCookingTime; // Format "HH:mm:ss"final String? targetFinishTime; // Format "HH:mm:ss"final String? notes;ProductionSchedule({required this.id,required this.date,required this.menuId,required this.menuName,required this.totalPortions,this.startCookingTime,this.targetFinishTime,this.notes,});factory ProductionSchedule.fromJson(Map<String, dynamic> json) {return ProductionSchedule(id: json['id'].toString(),date: DateTime.parse(json['date']),menuId: json['menu_id'].toString(),menuName: json['menus'] != null ? json['menus']['name'] : 'Menu ?',totalPortions: json['total_portions'] != null ? int.parse(json['total_portions'].toString()) : 0,startCookingTime: json['start_cooking_time'],targetFinishTime: json['target_finish_time'],notes: json['notes'],);}}

=== FILE: lib/models/vehicle_model.dart ===
class Vehicle {final String id;final String sppgId;final String plateNumber; // Plat Nomorfinal String? driverName; // Nama Supirfinal int capacityLimit; // Kapasitas Angkut (Porsi)final bool isActive; // Status Siap Jalan?Vehicle({required this.id,required this.sppgId,required this.plateNumber,this.driverName,this.capacityLimit = 0,this.isActive = true,});factory Vehicle.fromJson(Map<String, dynamic> json) {return Vehicle(id: json['id'].toString(),sppgId: json['sppg_id'].toString(),plateNumber: json['plate_number'] ?? 'Tanpa Plat',driverName: json['driver_name'],capacityLimit: json['capacity_limit'] != null ? int.parse(json['capacity_limit'].toString()) : 0,isActive: json['is_active'] ?? true,);}Map<String, dynamic> toJson() {return {'sppg_id': sppgId,'plate_number': plateNumber,'driver_name': driverName,'capacity_limit': capacityLimit,'is_active': isActive,};}}

=== FILE: lib/models/courier_model.dart ===
class CourierModel {final String id;final String name; // Dipetakan dari full_name di tabel profilesfinal String email;final String? sppgId; // SPPG tempat kurir bertugasCourierModel({required this.id,required this.name,required this.email,this.sppgId,});factory CourierModel.fromJson(Map<String, dynamic> json) {return CourierModel(id: json['id'].toString(),name: json['full_name'] ?? 'Kurir Tanpa Nama',email: json['email'] ?? 'Email tidak tersedia',sppgId: json['sppg_id'],);}}

=== FILE: lib/models/route_model.dart ===
class DeliveryRoute {final String id;final String date; // Format YYYY-MM-DDfinal String vehicleId;final String courierId;final String status; // pending, active, completed// [PENTING] Field Barufinal String? departureTime; // Jam Berangkat (HH:mm:ss)// Variabel tambahan untuk joinfinal String? vehiclePlate;final String? courierName;DeliveryRoute({required this.id,required this.date,required this.vehicleId,required this.courierId,this.status = 'pending',this.departureTime,this.vehiclePlate,this.courierName,});factory DeliveryRoute.fromJson(Map<String, dynamic> json) {return DeliveryRoute(id: json['id'].toString(),date: json['date'],vehicleId: json['vehicle_id'].toString(),courierId: json['courier_id'].toString(),status: json['status'] ?? 'pending',// Ambil data departure_time dari databasedepartureTime: json['departure_time'],// Supabase join objectsvehiclePlate: json['vehicles']?['plate_number'],courierName: json['profiles']?['full_name'],);}}

=== FILE: lib/models/user_profile.dart ===
class UserProfile {final String id;final String? email; // Email dari Auth Supabasefinal String? fullName;final String role; // 'bgn', 'admin_sppg', 'kurir', ...final String? sppgId;final String? schoolId;UserProfile({required this.id,this.email,this.fullName,required this.role,this.sppgId,this.schoolId,});// FIX: Email dijadikan parameter opsional. Mengambil data dari profilesfactory UserProfile.fromJson(Map<String, dynamic> json, [String? email]) {return UserProfile(id: json['id'],email: email, // Email dapet dari parameter opsional di AuthServicefullName: json['full_name'],role: json['role'] ?? 'unknown',sppgId: json['sppg_id'],schoolId: json['school_id'],);}}

=== FILE: lib/core/screens/profile_screen.dart ===
import 'package:flutter/material.dart';import 'package:supabase_flutter/supabase_flutter.dart';import '../../features/autentikasi/screens/login_screen.dart';class ProfileScreen extends StatefulWidget {const ProfileScreen({super.key});@overrideState<ProfileScreen> createState() => _ProfileScreenState();}class _ProfileScreenState extends State<ProfileScreen> {final _passwordController = TextEditingController();bool _isLoading = false;// Data UserString _email = "";String _name = "";String _role = "";@overridevoid initState() {super.initState();_loadUserData();}Future<void> _loadUserData() async {final user = Supabase.instance.client.auth.currentUser;if (user != null) {try {final profile = await Supabase.instance.client.from('profiles').select().eq('id', user.id).single();setState(() {_email = user.email ?? "-";_name = profile['full_name'] ?? "-";_role = profile['role']?.toString().toUpperCase() ?? "-";});} catch (e) {print("Gagal load profil: $e");}}}Future<void> _changePassword() async {if (_passwordController.text.length < 6) {ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Password minimal 6 karakter")),);return;}setState(() => _isLoading = true);try {await Supabase.instance.client.auth.updateUser(UserAttributes(password: _passwordController.text),);if (!mounted) return;ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Password berhasil diubah!"), backgroundColor: Colors.green),);_passwordController.clear();} catch (e) {ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Gagal ganti password: $e"), backgroundColor: Colors.red),);} finally {if (mounted) setState(() => _isLoading = false);}}Future<void> _logout() async {await Supabase.instance.client.auth.signOut();if (!mounted) return;Navigator.of(context).pushAndRemoveUntil(MaterialPageRoute(builder: (_) => const LoginScreen()),(route) => false,);}@overrideWidget build(BuildContext context) {return Scaffold(appBar: AppBar(title: const Text("Profil Saya"),backgroundColor: Colors.grey[800], // NetralforegroundColor: Colors.white,),body: SingleChildScrollView(padding: const EdgeInsets.all(20),child: Column(children: [const SizedBox(height: 20),// Avatar Besarconst CircleAvatar(radius: 50,backgroundColor: Colors.grey,child: Icon(Icons.person, size: 60, color: Colors.white),),const SizedBox(height: 20),// Info UserText(_name, style: const TextStyle(fontSize: 22, fontWeight: FontWeight.bold)),Text(_email, style: const TextStyle(fontSize: 16, color: Colors.grey)),const SizedBox(height: 10),Container(padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),decoration: BoxDecoration(color: Colors.blue[50],borderRadius: BorderRadius.circular(20),border: Border.all(color: Colors.blue),),child: Text(_role, style: const TextStyle(color: Colors.blue, fontWeight: FontWeight.bold)),),const SizedBox(height: 40),const Divider(),const SizedBox(height: 20),// Form Ganti Passwordconst Align(alignment: Alignment.centerLeft,child: Text("Ganti Password", style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold)),),const SizedBox(height: 15),TextField(controller: _passwordController,obscureText: true,decoration: const InputDecoration(labelText: "Password Baru",border: OutlineInputBorder(),prefixIcon: Icon(Icons.lock_reset),),),const SizedBox(height: 15),SizedBox(width: double.infinity,child: ElevatedButton(onPressed: _isLoading ? null : _changePassword,style: ElevatedButton.styleFrom(padding: const EdgeInsets.symmetric(vertical: 15),backgroundColor: Colors.blue[800],foregroundColor: Colors.white,),child: _isLoading? const SizedBox(height: 20, width: 20, child: CircularProgressIndicator(color: Colors.white)): const Text("UPDATE PASSWORD"),),),const SizedBox(height: 40),// Tombol Logout MerahSizedBox(width: double.infinity,child: OutlinedButton.icon(onPressed: _logout,icon: const Icon(Icons.logout, color: Colors.red),label: const Text("LOGOUT", style: TextStyle(color: Colors.red)),style: OutlinedButton.styleFrom(padding: const EdgeInsets.symmetric(vertical: 15),side: const BorderSide(color: Colors.red),),),),],),),);}}

=== FILE: lib/core/services/storage_service.dart ===
import 'dart:io';import 'package:supabase_flutter/supabase_flutter.dart';import 'package:image_picker/image_picker.dart'; // Pastikan sudah ada di pubspecclass StorageService {final _supabase = Supabase.instance.client;// Fungsi Pilih Foto dari Kamera/GaleriFuture<File?> pickImage(ImageSource source) async {final ImagePicker picker = ImagePicker();final XFile? image = await picker.pickImage(source: source,imageQuality: 70, // Kompres dikit biar gak beratmaxWidth: 1024, // Resize);if (image != null) {return File(image.path);}return null;}// Fungsi Upload ke SupabaseFuture<String> uploadEvidence(File file, String folderName) async {try {// Nama file unik: evidence/stops/timestamp.jpgfinal fileName = '${DateTime.now().millisecondsSinceEpoch}.jpg';final path = '$folderName/$fileName';// Uploadawait _supabase.storage.from('evidence').upload(path,file,fileOptions: const FileOptions(cacheControl: '3600', upsert: false),);// Ambil URL Publikfinal String publicUrl = _supabase.storage.from('evidence').getPublicUrl(path);return publicUrl;} catch (e) {throw Exception("Gagal upload foto: $e");}}}

=== FILE: lib/features/pengawas/screens/list_sppg_screen.dart ===
import 'package:flutter/material.dart';import '../services/sppg_service.dart';import '../../../models/sppg_model.dart';import 'add_sppg_screen.dart';import 'detail_sppg_screen.dart';class ListSppgScreen extends StatefulWidget {const ListSppgScreen({super.key});@overrideState<ListSppgScreen> createState() => _ListSppgScreenState();}class _ListSppgScreenState extends State<ListSppgScreen> {final SppgService _sppgService = SppgService();List<Sppg> _sppgList = [];bool _isLoading = true;@overridevoid initState() {super.initState();_fetchData();}Future<void> _fetchData() async {setState(() => _isLoading = true);try {final data = await _sppgService.getAllSppgs();if (!mounted) return;setState(() {_sppgList = data;_isLoading = false;});} catch (e) {if (!mounted) return;ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Error: $e")));setState(() => _isLoading = false);}}// Fungsi DeleteFuture<void> _deleteSppg(String id) async {final confirm = await showDialog(context: context,builder: (ctx) => AlertDialog(title: const Text("Hapus SPPG?"),content: const Text("Data yang dihapus tidak bisa dikembalikan."),actions: [TextButton(onPressed: () => Navigator.pop(ctx, false), child: const Text("Batal")),TextButton(onPressed: () => Navigator.pop(ctx, true), child: const Text("Hapus", style: TextStyle(color: Colors.red))),],),);if (confirm == true) {await _sppgService.deleteSppg(id);_fetchData(); // Refresh list}}@overrideWidget build(BuildContext context) {return Scaffold(appBar: AppBar(title: const Text("Data Master SPPG"),backgroundColor: Colors.blue[800],foregroundColor: Colors.white,),body: RefreshIndicator(onRefresh: _fetchData,child: _isLoading? const Center(child: CircularProgressIndicator()): _sppgList.isEmpty? _buildEmptyState(): ListView.builder(padding: const EdgeInsets.all(8),itemCount: _sppgList.length,itemBuilder: (context, index) {final sppg = _sppgList[index];return Card(elevation: 2,margin: const EdgeInsets.symmetric(horizontal: 8, vertical: 6),child: ListTile(leading: CircleAvatar(backgroundColor: Colors.blue[50],child: Icon(Icons.kitchen, color: Colors.blue[800]),),title: Text(sppg.name, style: const TextStyle(fontWeight: FontWeight.bold)),subtitle: Text(sppg.address ?? "Alamat belum diisi",maxLines: 1,overflow: TextOverflow.ellipsis,),trailing: Row(mainAxisSize: MainAxisSize.min,children: [// TOMBOL EDITIconButton(icon: const Icon(Icons.edit, color: Colors.blue),onPressed: () {Navigator.push(context,MaterialPageRoute(builder: (_) => AddSppgScreen(sppgToEdit: sppg)),).then((val) {if (val == true) _fetchData();});},),// TOMBOL DELETEIconButton(icon: const Icon(Icons.delete, color: Colors.red),onPressed: () => _deleteSppg(sppg.id),),// TOMBOL DETAIL (PANAH)IconButton(icon: const Icon(Icons.arrow_forward_ios, size: 16, color: Colors.grey),onPressed: () {Navigator.push(context,MaterialPageRoute(builder: (context) => DetailSppgScreen(sppg: sppg)),);},),],),),);},),),floatingActionButton: FloatingActionButton.extended(onPressed: () async {final result = await Navigator.push(context,MaterialPageRoute(builder: (_) => const AddSppgScreen()),);if (result == true) {_fetchData();}},backgroundColor: Colors.blue[800],foregroundColor: Colors.white,icon: const Icon(Icons.add),label: const Text("Tambah SPPG"),),);}Widget _buildEmptyState() {return Center(child: Column(mainAxisAlignment: MainAxisAlignment.center,children: [const Icon(Icons.business_outlined, size: 80, color: Colors.grey),const SizedBox(height: 16),const Text("Belum ada data SPPG.", style: TextStyle(fontSize: 16, color: Colors.grey)),TextButton(onPressed: _fetchData, child: const Text("Refresh")),],),);}}

=== FILE: lib/features/pengawas/screens/location_picker_screen.dart ===
import 'dart:convert';import 'package:flutter/material.dart';import 'package:flutter_map/flutter_map.dart';import 'package:latlong2/latlong.dart';import 'package:http/http.dart' as http;class LocationPickerScreen extends StatefulWidget {final double initialLat;final double initialLong;const LocationPickerScreen({super.key,this.initialLat = -6.9175, // Default Bandungthis.initialLong = 107.6191,});@overrideState<LocationPickerScreen> createState() => _LocationPickerScreenState();}class _LocationPickerScreenState extends State<LocationPickerScreen> {late LatLng _pickedLocation;final MapController _mapController = MapController();final TextEditingController _searchController = TextEditingController();double _currentZoom = 15.0;bool _isSearching = false;@overridevoid initState() {super.initState();_pickedLocation = LatLng(widget.initialLat, widget.initialLong);}Future<void> _searchAddress() async {final query = _searchController.text;if (query.isEmpty) return;setState(() => _isSearching = true);FocusScope.of(context).unfocus();try {final url = Uri.parse('https://photon.komoot.io/api/?q=$query&limit=1');final response = await http.get(url);if (response.statusCode == 200) {final data = json.decode(response.body);final features = data['features'] as List;if (features.isNotEmpty) {final coordinates = features[0]['geometry']['coordinates'];final double lon = coordinates[0];final double lat = coordinates[1];final newLocation = LatLng(lat, lon);setState(() {_pickedLocation = newLocation;});_mapController.move(newLocation, 16.0);} else {if (!mounted) return;ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Lokasi tidak ditemukan.")),);}}} catch (e) {ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Error: $e")));} finally {setState(() => _isSearching = false);}}void _zoomMap(double change) {setState(() {_currentZoom = (_currentZoom + change).clamp(3.0, 18.0);_mapController.move(_pickedLocation, _currentZoom);});}@overrideWidget build(BuildContext context) {return Scaffold(resizeToAvoidBottomInset: false,appBar: AppBar(title: const Text("Pilih Lokasi"),backgroundColor: Colors.blue[800],foregroundColor: Colors.white,actions: [IconButton(icon: const Icon(Icons.check),onPressed: () {Navigator.pop(context, _pickedLocation);},)],),body: Stack(children: [FlutterMap(mapController: _mapController,options: MapOptions(initialCenter: _pickedLocation,initialZoom: _currentZoom,onPositionChanged: (camera, hasGesture) {if (hasGesture) {setState(() {_pickedLocation = camera.center;_currentZoom = camera.zoom;});}},),children: [TileLayer(urlTemplate: 'https://tile.openstreetmap.org/{z}/{x}/{y}.png',userAgentPackageName: 'com.example.mbg_monitoring',),// [PENTING] Attribution OSM (Biar Legal)const RichAttributionWidget(attributions: [TextSourceAttribution('OpenStreetMap contributors')],),],),const Center(child: Padding(padding: EdgeInsets.only(bottom: 40.0),child: Icon(Icons.location_pin, color: Colors.red, size: 50),),),Positioned(top: 10, left: 15, right: 15,child: Card(child: Padding(padding: const EdgeInsets.symmetric(horizontal: 8.0),child: Row(children: [Expanded(child: TextField(controller: _searchController,decoration: const InputDecoration(hintText: "Cari lokasi...", border: InputBorder.none,),onSubmitted: (_) => _searchAddress(),),),IconButton(icon: _isSearching? const SizedBox(width: 20, height: 20, child: CircularProgressIndicator(strokeWidth: 2)): const Icon(Icons.search),onPressed: _searchAddress,),],),),),),Positioned(right: 20, bottom: 160,child: Column(children: [FloatingActionButton.small(heroTag: "zoom_in", onPressed: () => _zoomMap(1.0),backgroundColor: Colors.white, child: const Icon(Icons.add, color: Colors.black),),const SizedBox(height: 10),FloatingActionButton.small(heroTag: "zoom_out", onPressed: () => _zoomMap(-1.0),backgroundColor: Colors.white, child: const Icon(Icons.remove, color: Colors.black),),],),),Positioned(bottom: 30, left: 20, right: 20,child: Card(child: Padding(padding: const EdgeInsets.all(16.0),child: Column(children: [Text("Lat: ${_pickedLocation.latitude.toStringAsFixed(5)}, Long: ${_pickedLocation.longitude.toStringAsFixed(5)}"),const SizedBox(height: 10),SizedBox(width: double.infinity,child: ElevatedButton(style: ElevatedButton.styleFrom(backgroundColor: Colors.blue[800], foregroundColor: Colors.white),onPressed: () => Navigator.pop(context, _pickedLocation),child: const Text("PILIH LOKASI INI"),),),],),),),),],),);}}

=== FILE: lib/features/pengawas/screens/detail_sppg_screen.dart ===
import 'package:flutter/material.dart';import 'package:flutter_map/flutter_map.dart';import 'package:latlong2/latlong.dart';import '../../../models/sppg_model.dart';import '../../../models/school_model.dart';import '../services/sppg_service.dart';import '../../admin_sppg/services/school_service.dart'; // Import School Serviceclass DetailSppgScreen extends StatelessWidget {final Sppg sppg;const DetailSppgScreen({super.key, required this.sppg});// Fungsi HapusFuture<void> _deleteSppg(BuildContext context) async {final confirm = await showDialog(context: context,builder: (ctx) => AlertDialog(title: const Text("Hapus SPPG?"),content: const Text("Tindakan ini akan menghapus data SPPG ini. Data terkait mungkin ikut terhapus."),actions: [TextButton(onPressed: () => Navigator.pop(ctx, false), child: const Text("Batal")),TextButton(onPressed: () => Navigator.pop(ctx, true), child: const Text("Hapus", style: TextStyle(color: Colors.red))),],),);if (confirm == true) {try {await SppgService().deleteSppg(sppg.id);if(!context.mounted) return;Navigator.pop(context, true); // Balik ke list dan refreshScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("SPPG Dihapus.")));} catch (e) {ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Error: $e")));}}}@overrideWidget build(BuildContext context) {bool hasLocation = sppg.latitude != null && sppg.longitude != null;final centerLocation = hasLocation? LatLng(sppg.latitude!, sppg.longitude!): const LatLng(-6.9175, 107.6191);return Scaffold(appBar: AppBar(title: Text(sppg.name),backgroundColor: Colors.blue[800],foregroundColor: Colors.white,actions: [// Tombol Hapus (UC06)IconButton(icon: const Icon(Icons.delete),tooltip: "Hapus SPPG",onPressed: () => _deleteSppg(context),)],),body: SingleChildScrollView(child: Column(crossAxisAlignment: CrossAxisAlignment.start,children: [// 1. PETASizedBox(height: 200,width: double.infinity,child: FlutterMap(options: MapOptions(initialCenter: centerLocation, initialZoom: 15.0),children: [TileLayer(urlTemplate: 'https://tile.openstreetmap.org/{z}/{x}/{y}.png', userAgentPackageName: 'com.example.mbg'),if (hasLocation) MarkerLayer(markers: [Marker(point: centerLocation, width: 50, height: 50, child: const Icon(Icons.location_pin, color: Colors.red, size: 40))]),],),),Padding(padding: const EdgeInsets.all(16.0),child: Column(crossAxisAlignment: CrossAxisAlignment.start,children: [const Text("Detail Info", style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold)),const SizedBox(height: 10),ListTile(leading: const Icon(Icons.map), title: Text(sppg.address ?? "-"), subtitle: const Text("Alamat")),ListTile(leading: const Icon(Icons.email), title: Text(sppg.email ?? "-"), subtitle: const Text("Email Admin")),ListTile(leading: const Icon(Icons.phone), title: Text(sppg.phone ?? "-"), subtitle: const Text("Telepon")),const Divider(height: 30),// 2. LIST SEKOLAH PENERIMA MANFAAT (UC07)const Text("Daftar Penerima Manfaat (Sekolah)", style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold)),const SizedBox(height: 10),SizedBox(height: 300, // Fixed height untuk listchild: FutureBuilder<List<School>>(future: SchoolService().getSchoolsBySppgId(sppg.id),builder: (context, snapshot) {if (snapshot.connectionState == ConnectionState.waiting) return const Center(child: CircularProgressIndicator());final schools = snapshot.data ?? [];if (schools.isEmpty) return const Center(child: Text("Belum ada sekolah terdaftar."));return ListView.builder(itemCount: schools.length,itemBuilder: (ctx, i) => Card(child: ListTile(leading: const Icon(Icons.school, color: Colors.orange),title: Text(schools[i].name),subtitle: Text("${schools[i].studentCount} Siswa"),),),);},),)],),),],),),);}}

=== FILE: lib/features/pengawas/screens/bgn_report_screen.dart ===
import 'package:flutter/material.dart';import '../services/bgn_monitoring_service.dart';class BgnReportScreen extends StatefulWidget {const BgnReportScreen({super.key});@overrideState<BgnReportScreen> createState() => _BgnReportScreenState();}class _BgnReportScreenState extends State<BgnReportScreen>with SingleTickerProviderStateMixin {late TabController _tabController;final BgnMonitoringService _service = BgnMonitoringService();@overridevoid initState() {super.initState();_tabController = TabController(length: 3, vsync: this);}@overrideWidget build(BuildContext context) {return Scaffold(appBar: AppBar(title: const Text("Laporan Distribusi & Kualitas"), // UC03backgroundColor: Colors.blue[800],foregroundColor: Colors.white,bottom: TabBar(controller: _tabController,indicatorColor: Colors.white,labelColor: Colors.white,unselectedLabelColor: Colors.white70,isScrollable: true, // Biar muat di layar keciltabs: const [Tab(text: "History & Bukti"),Tab(text: "Jadwal SPPG"),Tab(text: "Keluhan Masalah"),],),),body: TabBarView(controller: _tabController,children: [_buildHistoryList(),_buildScheduleList(),_buildComplaintList(),],),);}// TAB 1: HISTORY & BUKTI & KETEPATANWidget _buildHistoryList() {return FutureBuilder<List<Map<String, dynamic>>>(future: _service.getDeliveryHistory(),builder: (context, snapshot) {if (snapshot.connectionState == ConnectionState.waiting)return const Center(child: CircularProgressIndicator());final data = snapshot.data ?? [];if (data.isEmpty)return const Center(child: Text("Belum ada riwayat pengiriman."));return ListView.builder(itemCount: data.length,itemBuilder: (ctx, i) {final item = data[i];final sppg = item['delivery_routes']['sppgs']['name'];final school = item['schools']['name'];final date = item['delivery_routes']['date'];final photoUrl = item['proof_photo_url'];// Logika Ketepatan Waktu (Sederhana: Kalau received_time < deadline dianggap Tepat)// Di sini kita labeli sajabool isOnTime = true; // Placeholder logikareturn Card(margin: const EdgeInsets.symmetric(horizontal: 10, vertical: 5),child: ExpansionTile(leading: const Icon(Icons.history, color: Colors.blue),title: Text("$sppg -> $school"),subtitle: Text("Tgl: $date | Status: ${isOnTime ? 'Tepat Waktu' : 'Terlambat'}",),children: [if (photoUrl != null)Padding(padding: const EdgeInsets.all(8.0),child: Image.network(photoUrl,height: 150,fit: BoxFit.cover,),),Padding(padding: const EdgeInsets.all(8.0),child: Text("Penerima: ${item['recipient_name'] ?? '-'} \nCatatan: ${item['reception_notes'] ?? '-'}",),),],),);},);},);}// TAB 2: JADWAL PENGIRIMAN SETIAP SPPGWidget _buildScheduleList() {return FutureBuilder<List<Map<String, dynamic>>>(future: _service.getAllSchedules(),builder: (context, snapshot) {if (snapshot.connectionState == ConnectionState.waiting)return const Center(child: CircularProgressIndicator());final data = snapshot.data ?? [];if (data.isEmpty)return const Center(child: Text("Belum ada jadwal mendatang."));return ListView.builder(itemCount: data.length,itemBuilder: (ctx, i) {final item = data[i];return ListTile(leading: const Icon(Icons.calendar_today, color: Colors.orange),title: Text(item['sppgs']['name']),subtitle: Text("Jadwal: ${item['date']} | Mobil: ${item['vehicles'] != null ? item['vehicles']['plate_number'] : '-'}",),);},);},);}// TAB 3: LAPORAN KELUHAN SEMUA SPPGWidget _buildComplaintList() {return FutureBuilder<List<Map<String, dynamic>>>(future: _service.getAllComplaints(),builder: (context, snapshot) {if (snapshot.connectionState == ConnectionState.waiting)return const Center(child: CircularProgressIndicator());final data = snapshot.data ?? [];if (data.isEmpty)return const Center(child: Text("Aman! Tidak ada keluhan."));return ListView.builder(itemCount: data.length,itemBuilder: (ctx, i) {final item = data[i];final sppg = item['delivery_routes']['sppgs']['name'];final school = item['schools']['name'];return Card(color: Colors.red[50],child: ListTile(leading: const Icon(Icons.warning, color: Colors.red),title: Text("$sppg -> $school"),subtitle: Text("Keluhan: ${item['reception_notes']}"),trailing: item['admin_response'] != null? const Icon(Icons.check_circle, color: Colors.green): const Text("Belum Ditangani",style: TextStyle(color: Colors.red, fontSize: 10),),),);},);},);}}

=== FILE: lib/features/pengawas/screens/dashboard_bgn_screen.dart ===
import 'package:flutter/material.dart';// Import Auth & Loginimport '../../autentikasi/services/auth_service.dart';import '../../autentikasi/screens/login_screen.dart';// Import Screens Fitur BGNimport 'list_sppg_screen.dart';import 'bgn_report_screen.dart'; // Screen Laporan Terpadu// [PENTING] Import Halaman Profil (Tempat Ganti Password)import '../../../core/screens/profile_screen.dart';class DashboardBgnScreen extends StatelessWidget {const DashboardBgnScreen({super.key});// Fungsi Logout (Cadangan jika tombol profil bermasalah)Future<void> _logout(BuildContext context) async {await AuthService().signOut();if (!context.mounted) return;Navigator.of(context).pushAndRemoveUntil(MaterialPageRoute(builder: (_) => const LoginScreen()),(route) => false,);}@overrideWidget build(BuildContext context) {return Scaffold(appBar: AppBar(title: const Text("BGN Monitoring"),backgroundColor: Colors.blue[800],foregroundColor: Colors.white,actions: [// [FITUR GANTI PASSWORD ADA DI SINI]// Tombol Profil (Icon Orang)IconButton(icon: const Icon(Icons.account_circle, size: 30),tooltip: "Profil & Password",onPressed: () {// Navigasi ke Halaman ProfilNavigator.push(context,MaterialPageRoute(builder: (_) => const ProfileScreen()),);},),],),body: Padding(padding: const EdgeInsets.all(16.0),child: Column(crossAxisAlignment: CrossAxisAlignment.start,children: [const Text("Selamat Datang, Pengawas",style: TextStyle(fontSize: 20, fontWeight: FontWeight.bold),),const Text("Pilih menu di bawah untuk memulai:"),const SizedBox(height: 20),// Grid MenuExpanded(child: GridView.count(crossAxisCount: 2,crossAxisSpacing: 16,mainAxisSpacing: 16,children: [// MENU 1: MANAJEMEN AKUN SPPG_buildMenuCard(context,icon: Icons.manage_accounts,title: "Manajemen Akun SPPG",color: Colors.blue,onTap: () {Navigator.push(context,MaterialPageRoute(builder: (_) => const ListSppgScreen(),),);},),// MENU 2: LAPORAN DISTRIBUSI & KUALITAS_buildMenuCard(context,icon: Icons.analytics,title: "Laporan Distribusi & Kualitas",color: Colors.green,onTap: () {Navigator.push(context,MaterialPageRoute(builder: (_) => const BgnReportScreen(),),);},),],),),],),),);}Widget _buildMenuCard(BuildContext context, {required IconData icon,required String title,required Color color,required VoidCallback onTap,}) {return InkWell(onTap: onTap,child: Container(decoration: BoxDecoration(color: Colors.white,borderRadius: BorderRadius.circular(16),boxShadow: [BoxShadow(color: Colors.grey.withOpacity(0.1),blurRadius: 10,spreadRadius: 2,),],border: Border.all(color: color.withOpacity(0.3)),),child: Column(mainAxisAlignment: MainAxisAlignment.center,children: [CircleAvatar(radius: 30,backgroundColor: color.withOpacity(0.1),child: Icon(icon, size: 30, color: color),),const SizedBox(height: 16),Padding(padding: const EdgeInsets.symmetric(horizontal: 8.0),child: Text(title,textAlign: TextAlign.center,style: const TextStyle(fontWeight: FontWeight.bold,fontSize: 16,),),),],),),);}}

=== FILE: lib/features/pengawas/screens/add_sppg_screen.dart ===
import 'package:flutter/material.dart';import 'package:latlong2/latlong.dart';import 'package:supabase_flutter/supabase_flutter.dart';import 'location_picker_screen.dart';import '../services/sppg_service.dart';import '../../../models/sppg_model.dart';class AddSppgScreen extends StatefulWidget {final Sppg? sppgToEdit; // Data untuk diedit (Null = Mode Tambah)const AddSppgScreen({super.key, this.sppgToEdit});@overrideState<AddSppgScreen> createState() => _AddSppgScreenState();}class _AddSppgScreenState extends State<AddSppgScreen> {final _formKey = GlobalKey<FormState>();// --- DATA DAPUR (SPPG) ---final _sppgNameController = TextEditingController();final _sppgAddressController = TextEditingController();final _sppgPhoneController = TextEditingController();final _sppgEmailController = TextEditingController();// Lokasifinal _latController = TextEditingController();final _longController = TextEditingController();// --- DATA ADMIN (Hanya untuk Mode Tambah) ---final _adminNameController = TextEditingController();final _adminEmailController = TextEditingController();final _adminPasswordController = TextEditingController();bool _isSubmitting = false;@overridevoid initState() {super.initState();// [LOGIKA EDIT] Isi form jika ada dataif (widget.sppgToEdit != null) {final s = widget.sppgToEdit!;_sppgNameController.text = s.name;_sppgAddressController.text = s.address ?? '';_sppgPhoneController.text = s.phone ?? '';_sppgEmailController.text = s.email ?? '';if (s.latitude != null) _latController.text = s.latitude.toString();if (s.longitude != null) _longController.text = s.longitude.toString();}}Future<void> _openMapPicker() async {double initialLat = double.tryParse(_latController.text) ?? -6.9175;double initialLong = double.tryParse(_longController.text) ?? 107.6191;final LatLng? result = await Navigator.push(context,MaterialPageRoute(builder: (context) => LocationPickerScreen(initialLat: initialLat,initialLong: initialLong,),),);if (result != null) {setState(() {_latController.text = result.latitude.toString();_longController.text = result.longitude.toString();});ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Koordinat berhasil diambil dari Peta!")),);}}Future<void> _submitForm() async {if (_formKey.currentState!.validate()) {setState(() => _isSubmitting = true);try {// 1. Siapkan Data SPPG (Tanpa Tanggal Berdiri)final Map<String, dynamic> sppgData = {"name": _sppgNameController.text.trim(),"address": _sppgAddressController.text.trim(),"email": _sppgEmailController.text.trim(),"phone": _sppgPhoneController.text.trim(),"gps_lat": double.tryParse(_latController.text),"gps_long": double.tryParse(_longController.text),};if (widget.sppgToEdit == null) {// --- MODE TAMBAH ---if (_adminEmailController.text.isEmpty || _adminPasswordController.text.isEmpty) {throw Exception("Email & Password Admin wajib diisi.");}final supabase = Supabase.instance.client;final sppgRes = await supabase.from('sppgs').insert(sppgData).select().single();final String newSppgId = sppgRes['id'];// Create Adminawait SppgService().createSppgUser(email: _adminEmailController.text.trim(),password: _adminPasswordController.text,sppgId: newSppgId,sppgName: _sppgNameController.text,fullName: _adminNameController.text.trim(),);} else {// --- MODE EDIT ---await SppgService().updateSppg(widget.sppgToEdit!.id, sppgData);}if (!mounted) return;ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text(widget.sppgToEdit == null ? "SPPG Baru Berhasil!" : "Data SPPG Diperbarui!"),backgroundColor: Colors.green),);Navigator.pop(context, true);} catch (e) {if (!mounted) return;ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Gagal: $e"), backgroundColor: Colors.red));} finally {if (mounted) setState(() => _isSubmitting = false);}}}@overridevoid dispose() {_sppgNameController.dispose();_sppgAddressController.dispose();_sppgPhoneController.dispose();_sppgEmailController.dispose();_latController.dispose();_longController.dispose();_adminNameController.dispose();_adminEmailController.dispose();_adminPasswordController.dispose();super.dispose();}@overrideWidget build(BuildContext context) {final isEdit = widget.sppgToEdit != null;return Scaffold(appBar: AppBar(title: Text(isEdit ? "Edit SPPG" : "Tambah Akun SPPG"),backgroundColor: Colors.blue[800],foregroundColor: Colors.white,),body: SingleChildScrollView(padding: const EdgeInsets.all(16.0),child: Form(key: _formKey,child: Column(crossAxisAlignment: CrossAxisAlignment.start,children: [const Text("1. Detail SPPG (Dapur)", style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold, color: Colors.blue)),const SizedBox(height: 15),TextFormField(controller: _sppgNameController,decoration: const InputDecoration(labelText: "Nama SPPG", border: OutlineInputBorder(), prefixIcon: Icon(Icons.store)),validator: (v) => v!.isEmpty ? "Wajib" : null),const SizedBox(height: 10),TextFormField(controller: _sppgAddressController,maxLines: 2,decoration: const InputDecoration(labelText: "Alamat SPPG", border: OutlineInputBorder(), prefixIcon: Icon(Icons.map)),validator: (v) => v!.isEmpty ? "Wajib" : null),const SizedBox(height: 10),TextFormField(controller: _sppgPhoneController,keyboardType: TextInputType.phone,decoration: const InputDecoration(labelText: "Telepon Kantor", border: OutlineInputBorder(), prefixIcon: Icon(Icons.phone)),validator: (v) => v!.isEmpty ? "Wajib" : null),const SizedBox(height: 10),TextFormField(controller: _sppgEmailController,keyboardType: TextInputType.emailAddress,decoration: const InputDecoration(labelText: "Email Kantor (Opsional)", border: OutlineInputBorder(), prefixIcon: Icon(Icons.email))),const SizedBox(height: 20),// --- Input Lat/Long Manual + Tombol Peta ---const Text("Titik Koordinat (GPS)", style: TextStyle(fontWeight: FontWeight.bold)),const SizedBox(height: 5),const Text("Isi manual atau gunakan tombol 'Buka Peta'", style: TextStyle(fontSize: 12, color: Colors.grey)),const SizedBox(height: 10),Row(children: [Expanded(child: TextFormField(controller: _latController,keyboardType: const TextInputType.numberWithOptions(decimal: true, signed: true),decoration: const InputDecoration(labelText: "Latitude",hintText: "-6.xxxx",border: OutlineInputBorder()),),),const SizedBox(width: 10),Expanded(child: TextFormField(controller: _longController,keyboardType: const TextInputType.numberWithOptions(decimal: true, signed: true),decoration: const InputDecoration(labelText: "Longitude",hintText: "107.xxxx",border: OutlineInputBorder()),),),],),const SizedBox(height: 8),SizedBox(width: double.infinity,child: ElevatedButton.icon(onPressed: _openMapPicker,icon: const Icon(Icons.map),label: const Text("Ambil dari Peta (Otomatis)"),style: ElevatedButton.styleFrom(backgroundColor: Colors.blue[100],foregroundColor: Colors.blue[900]),),),// --------------------------------------------------const SizedBox(height: 30),const Divider(thickness: 2),// BAGIAN ADMIN HANYA MUNCUL SAAT TAMBAH BARUif (!isEdit) ...[const Text("2. Akun Admin SPPG", style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold, color: Colors.blue)),const SizedBox(height: 15),TextFormField(controller: _adminNameController, decoration: const InputDecoration(labelText: "Nama Lengkap Admin", border: OutlineInputBorder(), prefixIcon: Icon(Icons.person)), validator: (v) => v!.isEmpty ? "Wajib" : null),const SizedBox(height: 15),TextFormField(controller: _adminEmailController, keyboardType: TextInputType.emailAddress, decoration: const InputDecoration(labelText: "Email Login", border: OutlineInputBorder(), prefixIcon: Icon(Icons.email)), validator: (v) => v!.isEmpty ? "Wajib" : null),const SizedBox(height: 10),TextFormField(controller: _adminPasswordController, obscureText: true, decoration: const InputDecoration(labelText: "Password", border: OutlineInputBorder(), prefixIcon: Icon(Icons.lock)), validator: (v) => v!.length < 6 ? "Min 6 karakter" : null),const SizedBox(height: 40),],SizedBox(width: double.infinity,child: ElevatedButton(onPressed: _isSubmitting ? null : _submitForm,style: ElevatedButton.styleFrom(backgroundColor: Colors.blue[800], padding: const EdgeInsets.symmetric(vertical: 16)),child: _isSubmitting? const CircularProgressIndicator(color: Colors.white): Text(isEdit ? "SIMPAN PERUBAHAN" : "SIMPAN", style: const TextStyle(fontSize: 16, fontWeight: FontWeight.bold, color: Colors.white)),),),const SizedBox(height: 30),],),),),);}}

=== FILE: lib/features/pengawas/services/bgn_monitoring_service.dart ===
import 'package:supabase_flutter/supabase_flutter.dart';class BgnMonitoringService {final _supabase = Supabase.instance.client;// ===========================================================================// BAGIAN 1: UNTUK SCREEN LAPORAN (BgnReportScreen)// ===========================================================================// 1. DATA HISTORY & BUKTI DIGITALFuture<List<Map<String, dynamic>>> getDeliveryHistory() async {try {final response = await _supabase.from('delivery_stops').select('*, schools(name), delivery_routes!inner(date, sppgs(name))')// [FIX ERROR _in]: Kita pakai .filter() manual biar aman dari error syntax.filter('status', 'in', '("received","completed","issue_reported")').order('created_at', ascending: false);return List<Map<String, dynamic>>.from(response);} catch (e) {throw Exception("Gagal ambil history: $e");}}// 2. JADWAL PENGIRIMAN SETIAP SPPGFuture<List<Map<String, dynamic>>> getAllSchedules() async {try {final response = await _supabase.from('delivery_routes').select('*, sppgs(name), vehicles(plate_number)').gte('date', DateTime.now().toIso8601String().split('T')[0]) // Hari ini ke depan.order('date', ascending: true);return List<Map<String, dynamic>>.from(response);} catch (e) {throw Exception("Gagal ambil jadwal: $e");}}// 3. LAPORAN KELUHAN SEMUA SPPGFuture<List<Map<String, dynamic>>> getAllComplaints() async {try {final response = await _supabase.from('delivery_stops').select('*, schools(name), delivery_routes!inner(sppgs(name))').eq('status', 'issue_reported').order('created_at', ascending: false);return List<Map<String, dynamic>>.from(response);} catch (e) {throw Exception("Gagal ambil keluhan: $e");}}// ===========================================================================// BAGIAN 2: UNTUK SCREEN STATISTIK (BgnStatisticsScreen)// ===========================================================================// 4. AMBIL LIST SEMUA SPPG (Untuk Dropdown)Future<List<Map<String, dynamic>>> getSppgList() async {try {final response = await _supabase.from('sppgs').select('id, name').order('name', ascending: true);return List<Map<String, dynamic>>.from(response);} catch (e) {throw Exception("Gagal ambil list SPPG: $e");}}// 5. AMBIL STATISTIK SPESIFIK PER SPPGFuture<Map<String, int>> getSppgStats(String sppgId) async {try {// Ambil data stops berdasarkan SPPG IDfinal response = await _supabase.from('delivery_stops').select('status, delivery_routes!inner(sppg_id)').eq('delivery_routes.sppg_id', sppgId);final List<dynamic> data = response;int received = 0, issues = 0, pending = 0;for (var item in data) {final status = item['status'];if (status == 'received') received++;else if (status == 'issue_reported') issues++;else pending++;}return {'received': received,'issues': issues,'pending': pending,'total': data.length,};} catch (e) {throw Exception("Gagal hitung statistik SPPG: $e");}}// ===========================================================================// BAGIAN 3: UNTUK SCREEN TRACKING PETA (BgnTrackingScreen)// ===========================================================================// 6. AMBIL LOKASI SEMUA SPPGFuture<List<Map<String, dynamic>>> getAllSppgLocations() async {try {final response = await _supabase.from('sppgs').select('id, name, address, gps_lat, gps_long');return List<Map<String, dynamic>>.from(response);} catch (e) {throw Exception("Gagal ambil lokasi SPPG: $e");}}}

=== FILE: lib/features/pengawas/services/sppg_service.dart ===
import 'dart:convert';import 'package:http/http.dart' as http;import 'package:supabase_flutter/supabase_flutter.dart';import '../../../models/sppg_model.dart';class SppgService {final _supabase = Supabase.instance.client;// --- A. DATABASE CRUD ---Future<void> createSppg(Map<String, dynamic> data) async {try {await _supabase.from('sppgs').insert(data);} catch (e) {throw Exception('Gagal simpan ke DB: $e');}}Future<List<Sppg>> getAllSppgs() async {try {final response = await _supabase.from('sppgs').select().order('created_at', ascending: false);final List<dynamic> data = response;return data.map((json) => Sppg.fromJson(json)).toList();} catch (e) {throw Exception('Gagal ambil data: $e');}}Future<void> updateSppg(String id, Map<String, dynamic> data) async {try {await _supabase.from('sppgs').update(data).eq('id', id);} catch (e) {throw Exception('Gagal update SPPG: $e');}}Future<void> deleteSppg(String sppgId) async {try {// Kita panggil fungsi SQL 'delete_sppg_complete' yang baru kita buatawait _supabase.rpc('delete_sppg_complete', params: {'target_sppg_id': sppgId});} catch (e) {throw Exception('Gagal hapus SPPG & Akun: $e');}}// --- B. AUTH (SIMPLIFIED - UC04) ---// Kembali ke versi simpel: Cuma Nama, Email, PasswordFuture<void> createSppgUser({required String email,required String password,required String sppgId,required String sppgName,required String fullName, // Nama Admin}) async {const String projectUrl = 'https://mqyfrqgfpqwlrloqtpvi.supabase.co';const String anonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1xeWZycWdmcHF3bHJsb3F0cHZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0NTMxMDMsImV4cCI6MjA3OTAyOTEwM30.KoXKouhFN0H7Iz9MSnRhFQuBIePVMwWyXmrzSv3rEeQ';final url = Uri.parse('$projectUrl/auth/v1/signup');try {final response = await http.post(url,headers: {'Content-Type': 'application/json', 'apikey': anonKey},body: jsonEncode({'email': email.trim(),'password': password,'data': { 'full_name': fullName }}),);if (response.statusCode == 200 || response.statusCode == 201) {final responseData = jsonDecode(response.body);String? newUserId;if (responseData['id'] != null) {newUserId = responseData['id'].toString();} else if (responseData['user'] != null && responseData['user']['id'] != null) {newUserId = responseData['user']['id'].toString();}if (newUserId == null) throw Exception("Gagal dapat ID User.");// Simpan ke Profiles (Versi Ringkas)await _supabase.from('profiles').insert({'id': newUserId,'full_name': fullName,'role': 'admin_sppg','sppg_id': sppgId,'email': email.trim(),});} else {final errorData = jsonDecode(response.body);throw Exception(errorData['msg'] ?? 'Gagal mendaftar');}} catch (e) {if (e.toString().contains("User already registered")) {throw Exception("Email ini sudah terdaftar!");}throw Exception('Error Create User: $e');}}}

=== FILE: lib/features/walikelas/screens/dashboard_teacher_screen.dart ===
import 'dart:io';import 'package:flutter/material.dart';import 'package:image_picker/image_picker.dart';import 'package:supabase_flutter/supabase_flutter.dart';import 'package:intl/intl.dart';import 'package:table_calendar/table_calendar.dart';import '../../autentikasi/screens/login_screen.dart';import '../services/teacher_reception_service.dart';import '../../../core/services/storage_service.dart';import '../../../core/screens/profile_screen.dart';class DashboardTeacherScreen extends StatefulWidget {const DashboardTeacherScreen({super.key});@overrideState<DashboardTeacherScreen> createState() => _DashboardTeacherScreenState();}class _DashboardTeacherScreenState extends State<DashboardTeacherScreen> {final TeacherReceptionService _service = TeacherReceptionService();final StorageService _storageService = StorageService();DateTime _focusedDay = DateTime.now();DateTime _selectedDay = DateTime.now();CalendarFormat _calendarFormat = CalendarFormat.week;Map<DateTime, List<dynamic>> _deliveries = {};bool _isLoading = true;String _className = "";@overridevoid initState() {super.initState();_fetchData();}Future<void> _fetchData() async {setState(() => _isLoading = true);try {final data = await _service.getMonthlyDeliveries(_focusedDay);Map<DateTime, List<dynamic>> newMap = {};for (var item in data) {_className = item['my_class_name'] ?? "-";final dateStr = item['delivery_routes']['date'];final date = DateTime.parse(dateStr);final dateKey = DateTime(date.year, date.month, date.day);if (newMap[dateKey] == null) newMap[dateKey] = [];newMap[dateKey]!.add(item);}if (mounted) {setState(() {_deliveries = newMap;_isLoading = false;});}} catch (e) {if (mounted) setState(() => _isLoading = false);}}List<dynamic> _getEventsForDay(DateTime day) {final dateKey = DateTime(day.year, day.month, day.day);return _deliveries[dateKey] ?? [];}void _showReceiveDialog(String stopId) {final qtyController = TextEditingController();final noteController = TextEditingController();File? photoFile;bool isProblem = false;bool isSubmitting = false;showDialog(context: context, barrierDismissible: false, builder: (ctx) => StatefulBuilder(builder: (context, setDialogState) {return AlertDialog(title: Text("Laporan Kelas $_className"),content: SingleChildScrollView(child: Column(mainAxisSize: MainAxisSize.min, children: [Row(children: [Expanded(child: ChoiceChip(label: const Text(" Aman"), selected: !isProblem, selectedColor: Colors.green[100], onSelected: (val) => setDialogState(() => isProblem = !val))),const SizedBox(width: 10),Expanded(child: ChoiceChip(label: const Text(" Masalah"), selected: isProblem, selectedColor: Colors.red[100], onSelected: (val) => setDialogState(() => isProblem = val))),]),const SizedBox(height: 15),TextField(controller: qtyController, keyboardType: TextInputType.number, decoration: const InputDecoration(labelText: "Box Diterima", border: OutlineInputBorder())),const SizedBox(height: 10),TextField(controller: noteController, decoration: InputDecoration(labelText: isProblem ? "Detail Masalah" : "Catatan", border: const OutlineInputBorder()), maxLines: 2),const SizedBox(height: 10),if (isProblem) GestureDetector(onTap: () async {final file = await _storageService.pickImage(ImageSource.camera);if (file != null) setDialogState(() => photoFile = file);},child: Container(height: 100, width: double.infinity, decoration: BoxDecoration(color: Colors.grey[200], border: Border.all(color: Colors.grey)), child: photoFile == null ? const Column(mainAxisAlignment: MainAxisAlignment.center, children: [Icon(Icons.camera_alt), Text("FOTO BUKTI")]) : Image.file(photoFile!, fit: BoxFit.cover)),),if (isSubmitting) const Padding(padding: EdgeInsets.only(top: 10), child: CircularProgressIndicator())]),),actions: [if (!isSubmitting) TextButton(onPressed: () => Navigator.pop(ctx), child: const Text("Batal")),if (!isSubmitting) ElevatedButton(style: ElevatedButton.styleFrom(backgroundColor: isProblem ? Colors.red : Colors.indigo, foregroundColor: Colors.white),onPressed: () async {if (isProblem && photoFile == null) { ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Wajib foto!"))); return; }setDialogState(() => isSubmitting = true);try {String? imageUrl;if (photoFile != null) imageUrl = await _storageService.uploadEvidence(photoFile!, 'classroom_issues');await _service.submitClassReception(stopId: stopId, className: _className, qty: int.tryParse(qtyController.text) ?? 0, notes: noteController.text, issueType: isProblem ? 'quality' : null, proofUrl: imageUrl);if (!mounted) return; Navigator.pop(ctx); _fetchData();ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Tersimpan!")));} catch (e) { setDialogState(() => isSubmitting = false); }},child: const Text("Simpan"),)],);}));}Future<void> _logout() async {await Supabase.instance.client.auth.signOut();if (!mounted) return;Navigator.of(context).pushAndRemoveUntil(MaterialPageRoute(builder: (_) => const LoginScreen()), (route) => false);}@overrideWidget build(BuildContext context) {return Scaffold(appBar: AppBar(title: Text(_className.isNotEmpty ? "Kelas $_className" : "Wali Kelas"),backgroundColor: Colors.indigo,foregroundColor: Colors.white,actions: [IconButton(icon: const Icon(Icons.account_circle, size: 30), onPressed: () => Navigator.push(context, MaterialPageRoute(builder: (_) => const ProfileScreen())))],),body: Column(children: [// HEADER FORMATContainer(padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),color: Colors.grey[100],child: Row(mainAxisAlignment: MainAxisAlignment.spaceBetween,children: [const Text("Jadwal Distribusi:", style: TextStyle(fontWeight: FontWeight.bold)),DropdownButtonHideUnderline(child: DropdownButton<CalendarFormat>(value: _calendarFormat,items: const [DropdownMenuItem(value: CalendarFormat.month, child: Text("Bulan")),DropdownMenuItem(value: CalendarFormat.week, child: Text("Minggu")),],onChanged: (fmt) => setState(() => _calendarFormat = fmt!),)),],),),TableCalendar(firstDay: DateTime(2024), lastDay: DateTime(2030),focusedDay: _focusedDay, currentDay: DateTime.now(),selectedDayPredicate: (d) => isSameDay(_selectedDay, d),calendarFormat: _calendarFormat,headerStyle: const HeaderStyle(formatButtonVisible: false, titleCentered: true),eventLoader: _getEventsForDay,onDaySelected: (sel, foc) { setState(() { _selectedDay = sel; _focusedDay = foc; }); },onFormatChanged: (fmt) { setState(() => _calendarFormat = fmt); },onPageChanged: (foc) { _focusedDay = foc; _fetchData(); },calendarStyle: const CalendarStyle(todayDecoration: BoxDecoration(color: Colors.indigo, shape: BoxShape.circle), selectedDecoration: BoxDecoration(color: Colors.orange, shape: BoxShape.circle), markerDecoration: BoxDecoration(color: Colors.indigo, shape: BoxShape.circle)),),const Divider(),Expanded(child: _isLoading ? const Center(child: CircularProgressIndicator()) : _buildDayList(),),],),);}Widget _buildDayList() {final events = _getEventsForDay(_selectedDay);if (events.isEmpty) return const Center(child: Text("Tidak ada jadwal.", style: TextStyle(color: Colors.grey)));return ListView.builder(itemCount: events.length,padding: const EdgeInsets.all(16),itemBuilder: (context, index) {final item = events[index];final status = item['status'];final bool alreadyReceived = item['already_received'];// LOGIKA STATUS TIMELINEbool isDelivered = (status == 'completed' || status == 'received' || status == 'issue_reported');bool isConfirmed = (status == 'received' || status == 'issue_reported');return Card(shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(10)),elevation: 2,child: Padding(padding: const EdgeInsets.all(16.0),child: Column(crossAxisAlignment: CrossAxisAlignment.start,children: [const Text("Status Pengiriman:", style: TextStyle(fontWeight: FontWeight.bold)),const SizedBox(height: 10),_buildStep("1. Dapur & Kurir", "Selesai", Colors.green),_buildLine(isDelivered ? Colors.green : Colors.grey),_buildStep("2. Tiba di Gerbang", isDelivered ? "Sampai" : "Menunggu", isDelivered ? Colors.green : Colors.grey),_buildLine(isConfirmed ? Colors.green : Colors.grey),_buildStep("3. Cek Koordinator", isConfirmed ? "Sudah Dicek" : "Menunggu", isConfirmed ? Colors.green : Colors.orange),const Divider(height: 30),// TOMBOL AKSI WALI KELAS// Wali Kelas bisa ambil barang kalau barang sudah Tiba di Gerbang (Completed)// Walaupun Koordinator belum konfirmasi, Wali Kelas kadang butuh cepat (opsional, tergantung SOP).// Di sini kita buat: Harus Tiba dulu.if (isDelivered && !alreadyReceived)SizedBox(width: double.infinity,child: ElevatedButton.icon(onPressed: () => _showReceiveDialog(item['id']),icon: const Icon(Icons.inventory),label: const Text("TERIMA DI KELAS (QC)"),style: ElevatedButton.styleFrom(backgroundColor: Colors.indigo, foregroundColor: Colors.white),),)else if (alreadyReceived)const Center(child: Text(" Sudah Diterima Kelas", style: TextStyle(fontWeight: FontWeight.bold, color: Colors.indigo)))],),),);},);}Widget _buildStep(String title, String status, Color color) {return Row(mainAxisAlignment: MainAxisAlignment.spaceBetween,children: [Text(title),Text(status, style: TextStyle(fontWeight: FontWeight.bold, color: color)),],);}Widget _buildLine(Color color) {return Container(margin: const EdgeInsets.symmetric(vertical: 4),height: 2,width: double.infinity,color: color.withOpacity(0.3),);}}

=== FILE: lib/features/walikelas/services/teacher_reception_service.dart ===
import 'package:supabase_flutter/supabase_flutter.dart';class TeacherReceptionService {final _supabase = Supabase.instance.client;// 1. AMBIL JADWAL BULANAN (Untuk Kalender)Future<List<Map<String, dynamic>>> getMonthlyDeliveries(DateTime month) async {try {final userId = _supabase.auth.currentUser!.id;// A. Cari Profile Wali Kelasfinal profile = await _supabase.from('profiles').select('school_id, class_name').eq('id', userId).single();final String? mySchoolId = profile['school_id'];final String myClassName = profile['class_name'] ?? '-';if (mySchoolId == null) throw Exception("Akun tidak terhubung sekolah.");// B. Hitung Range Tanggalfinal startDate = DateTime(month.year, month.month, 1);final endDate = DateTime(month.year, month.month + 1, 0);// C. Ambil Jadwal Pengiriman ke Sekolahfinal response = await _supabase.from('delivery_stops').select('*, delivery_routes!inner(date)').eq('school_id', mySchoolId).gte('delivery_routes.date', startDate.toIso8601String()).lte('delivery_routes.date', endDate.toIso8601String()).order('created_at', ascending: false);List<Map<String, dynamic>> deliveries = List<Map<String, dynamic>>.from(response);// D. Cek History Penerimaan Guru ini (Batch Check biar hemat query)final myReceptions = await _supabase.from('class_receptions').select('stop_id').eq('teacher_id', userId);final Set<String> receivedStopIds = myReceptions.map((e) => e['stop_id'].toString()).toSet();// E. Gabungkan Statusfor (var item in deliveries) {item['already_received'] = receivedStopIds.contains(item['id']);item['my_class_name'] = myClassName;}return deliveries;} catch (e) {throw Exception("Gagal ambil jadwal wali kelas: $e");}}// 2. SIMPAN KONFIRMASI KELASFuture<void> submitClassReception({required String stopId,required String className,required int qty,required String notes,String? issueType,String? proofUrl,}) async {try {final userId = _supabase.auth.currentUser!.id;await _supabase.from('class_receptions').insert({'stop_id': stopId,'teacher_id': userId,'class_name': className,'qty_received': qty,'notes': notes,'issue_type': issueType,'proof_photo_url': proofUrl,});} catch (e) {throw Exception("Gagal simpan data: $e");}}}

=== FILE: lib/features/koordinator/screens/coordinator_request_screen.dart ===
// === FILE: lib\features\koordinator\screens\coordinator_request_screen.dart ===import 'package:flutter/material.dart';import 'package:intl/intl.dart';import '../../shared/services/request_service.dart'; // Diperlukan RequestDetailclass CoordinatorRequestScreen extends StatefulWidget {const CoordinatorRequestScreen({super.key});@overrideState<CoordinatorRequestScreen> createState() =>_CoordinatorRequestScreenState();}class _CoordinatorRequestScreenState extends State<CoordinatorRequestScreen> {final RequestService _service = RequestService();final _notesController =TextEditingController(); // [UBAH] Ganti details jadi notes umumString _selectedType = 'Perubahan Jadwal';bool _isLoading = false;// --- STATE BARU UNTUK FORM TERSTRUKTUR ---List<Map<String, dynamic>> _availableMenus = [];bool _isMenuLoading = true;// State untuk Perubahan Jadwal:DateTime _newDate = DateTime.now();TimeOfDay _newTime = const TimeOfDay(hour: 12, minute: 0);String? _selectedScheduleMenuId; // Menu yang mau dijadwalkan ulang// State untuk Perubahan Porsi/Menu:Map<String, int> _menuQuantities = {}; // {menuId: quantity}String? _selectedPortionMenuId;final TextEditingController _portionController = TextEditingController();@overridevoid initState() {super.initState();_fetchMenus();}Future<void> _fetchMenus() async {try {final menus = await _service.getSppgMenus();setState(() {_availableMenus = menus;_isMenuLoading = false;// Set default menu ID untuk dropdownif (_availableMenus.isNotEmpty) {_selectedScheduleMenuId = _availableMenus.first['id'];_selectedPortionMenuId = _availableMenus.first['id'];}});} catch (e) {if (mounted)ScaffoldMessenger.of(context,).showSnackBar(SnackBar(content: Text("Gagal load menu: $e")));setState(() => _isMenuLoading = false);}}// --- FUNGSI SUBMIT UTAMA ---Future<void> _submit() async {setState(() => _isLoading = true);List<RequestDetail> details = [];String? error;// 1. Validasi dan Konversi Data Sesuai Tipeif (_selectedType == 'Perubahan Jadwal') {if (_selectedScheduleMenuId == null) {error = "Pilih menu untuk perubahan jadwal.";} else {details.add(RequestDetail(menuId: _selectedScheduleMenuId!,menuName: _availableMenus.firstWhere((m) => m['id'] == _selectedScheduleMenuId,)['name'],newDate: _newDate,newTime: _newTime,),);}} else if (_selectedType == 'Tambah/Kurang Porsi') {final qty = int.tryParse(_portionController.text);if (_selectedPortionMenuId == null || qty == null || qty < 0) {error = "Jumlah porsi tidak valid.";} else {details.add(RequestDetail(menuId: _selectedPortionMenuId!,menuName: _availableMenus.firstWhere((m) => m['id'] == _selectedPortionMenuId,)['name'],newQuantity: qty,),);}} else if (_selectedType == 'Perubahan Menu') {// Untuk perubahan menu, kita asumsikan Koordinator memilih menu yang dia inginkan hari itu.// Kita hanya catat menu yang dipilih.if (_selectedPortionMenuId == null) {error = "Pilih menu yang diminta.";} else {details.add(RequestDetail(menuId: _selectedPortionMenuId!,menuName: _availableMenus.firstWhere((m) => m['id'] == _selectedPortionMenuId,)['name'],),);}}if (error != null) {if (mounted)ScaffoldMessenger.of(context,).showSnackBar(SnackBar(content: Text(error!)));setState(() => _isLoading = false);return;}try {// 2. Kirim Request Terstrukturawait _service.submitStructuredRequest(type: _selectedType,notes: _notesController.text,details: details,);// 3. Sukses & Reset_notesController.clear();if (mounted)ScaffoldMessenger.of(context,).showSnackBar(const SnackBar(content: Text("Pengajuan Terkirim!")));setState(() {}); // Refresh history} catch (e) {if (mounted)ScaffoldMessenger.of(context,).showSnackBar(SnackBar(content: Text("Error: $e")));} finally {setState(() => _isLoading = false);}}@overrideWidget build(BuildContext context) {return Scaffold(appBar: AppBar(title: const Text("Pengajuan Perubahan"),backgroundColor: Colors.teal,),body: Column(children: [// --- FORM PENGAJUAN ---Padding(padding: const EdgeInsets.all(16.0),child: Card(elevation: 3,child: Padding(padding: const EdgeInsets.all(16.0),child: Column(crossAxisAlignment: CrossAxisAlignment.start,children: [const Text("Buat Pengajuan Baru",style: TextStyle(fontWeight: FontWeight.bold,fontSize: 16,),),const SizedBox(height: 10),// DROPDOWN TIPE REQUESTDropdownButtonFormField<String>(value: _selectedType,decoration: const InputDecoration(labelText: "Jenis Pengajuan",border: OutlineInputBorder(),),items:['Perubahan Jadwal','Perubahan Menu','Tambah/Kurang Porsi',].map((e) =>DropdownMenuItem(value: e, child: Text(e)),).toList(),onChanged: (val) => setState(() => _selectedType = val!),),const SizedBox(height: 15),// --- ISI FORM BERDASARKAN TIPE ---_isMenuLoading? const Center(child: CircularProgressIndicator()): _buildDynamicForm(),const SizedBox(height: 15),// CATATAN UMUMTextField(controller: _notesController,maxLines: 3,decoration: const InputDecoration(labelText: "Catatan Tambahan (Opsional)",hintText: "Contoh: Mohon konfirmasi sebelum jam 9.",border: OutlineInputBorder(),),),const SizedBox(height: 20),SizedBox(width: double.infinity,child: ElevatedButton.icon(onPressed: _isLoading ? null : _submit,icon: const Icon(Icons.send),label: const Text("Kirim Pengajuan"),style: ElevatedButton.styleFrom(backgroundColor: Colors.teal,foregroundColor: Colors.white,),),),],),),),),const Divider(),// --- LIST RIWAYAT ---const Padding(padding: EdgeInsets.all(8.0),child: Text("Riwayat Pengajuan",style: TextStyle(fontWeight: FontWeight.bold, color: Colors.grey),),),Expanded(child: _buildHistoryList()),],),);}// --- WIDGET DINAMIS (UC 51, 52) ---Widget _buildDynamicForm() {if (_availableMenus.isEmpty) {return const Text(" Tidak ada menu terdaftar di SPPG Anda.",style: TextStyle(color: Colors.red),);}if (_selectedType == 'Perubahan Jadwal') {return Column(crossAxisAlignment: CrossAxisAlignment.start,children: [// 1. Pilih Menu (FIX TIPE DI SINI)DropdownButtonFormField<String>(// <-- HARUS JELAS TIPE DI SINIvalue: _selectedScheduleMenuId,decoration: const InputDecoration(labelText: "Menu yang Dijadwal Ulang",prefixIcon: Icon(Icons.restaurant),),items: _availableMenus// PASTIKAN .map BERJENIS String.map((m) => DropdownMenuItem<String>(value: m['id'] as String,child: Text(m['name']),),).toList(), // <-- INI YANG HARUS JADI List<DropdownMenuItem<String>>onChanged: (val) => setState(() => _selectedScheduleMenuId = val),),const SizedBox(height: 15),// 2. Pilih TanggalInkWell(onTap: () async {final date = await showDatePicker(context: context,initialDate: _newDate,firstDate: DateTime.now(),lastDate: DateTime.now().add(const Duration(days: 365)),);if (date != null) setState(() => _newDate = date);},child: InputDecorator(decoration: const InputDecoration(labelText: "Tanggal Baru",prefixIcon: Icon(Icons.calendar_today),),child: Text(DateFormat('EEEE, d MMM yyyy', 'id_ID').format(_newDate),),),),const SizedBox(height: 15),// 3. Pilih JamInkWell(onTap: () async {final time = await showTimePicker(context: context,initialTime: _newTime,);if (time != null) setState(() => _newTime = time);},child: InputDecorator(decoration: const InputDecoration(labelText: "Waktu Kedatangan Baru",prefixIcon: Icon(Icons.access_time),),child: Text(_newTime.format(context)),),),],);} else if (_selectedType == 'Perubahan Menu') {return Column(crossAxisAlignment: CrossAxisAlignment.start,children: [const Text("Pilih Menu Baru yang Diminta Hari Ini:",style: TextStyle(fontWeight: FontWeight.w500),),const SizedBox(height: 5),DropdownButtonFormField<String>(// <-- HARUS JELAS TIPE DI SINIvalue: _selectedPortionMenuId,decoration: const InputDecoration(labelText: "Menu Pengganti",prefixIcon: Icon(Icons.swap_horiz),),items: _availableMenus// PASTIKAN .map BERJENIS String.map((m) => DropdownMenuItem<String>(value: m['id'] as String,child: Text(m['name']),),).toList(),onChanged: (val) => setState(() => _selectedPortionMenuId = val),),],);} else if (_selectedType == 'Tambah/Kurang Porsi') {return Column(crossAxisAlignment: CrossAxisAlignment.start,children: [const Text("Tentukan Porsi Baru:",style: TextStyle(fontWeight: FontWeight.w500),),const SizedBox(height: 5),DropdownButtonFormField<String>(// <-- HARUS JELAS TIPE DI SINIvalue: _selectedPortionMenuId,decoration: const InputDecoration(labelText: "Pilih Menu",prefixIcon: Icon(Icons.restaurant),),items: _availableMenus// PASTIKAN .map BERJENIS String.map((m) => DropdownMenuItem<String>(value: m['id'] as String,child: Text(m['name']),),).toList(),onChanged: (val) => setState(() {_selectedPortionMenuId = val;_portionController.clear();}),),const SizedBox(height: 15),TextField(controller: _portionController,keyboardType: TextInputType.number,decoration: const InputDecoration(labelText: "Jumlah Porsi (Total Akhir)",prefixIcon: Icon(Icons.numbers),hintText: "Contoh: 550",),),],);}return const SizedBox.shrink(); // Default kosong}// --- WIDGET HISTORY ---Widget _buildHistoryList() {return FutureBuilder<List<ChangeRequestModel>>(future: _service.getMyRequests(),builder: (context, snapshot) {if (snapshot.connectionState == ConnectionState.waiting)return const Center(child: CircularProgressIndicator());final data = snapshot.data ?? [];if (data.isEmpty)return const Center(child: Text("Belum ada riwayat pengajuan."));return ListView.builder(itemCount: data.length,itemBuilder: (ctx, i) {final item = data[i];Color statusColor = Colors.orange;if (item.status == 'approved') statusColor = Colors.green;if (item.status == 'rejected') statusColor = Colors.red;return ListTile(title: Text(item.type,style: const TextStyle(fontWeight: FontWeight.bold),),subtitle: Text(// [UBAH] Menampilkan oldNotes sebagai catatan umum"Catatan: ${item.oldNotes}\nRespon: ${item.adminResponse ?? '-'}",style: const TextStyle(fontSize: 12),),trailing: Chip(label: Text(item.status.toUpperCase(),style: const TextStyle(color: Colors.white, fontSize: 10),),backgroundColor: statusColor,),);},);},);}}

=== FILE: lib/features/koordinator/screens/dashboard_koordinator_screen.dart ===
import 'dart:io';import 'package:flutter/material.dart';import 'package:image_picker/image_picker.dart';import 'package:supabase_flutter/supabase_flutter.dart';import 'package:intl/intl.dart';import 'package:table_calendar/table_calendar.dart';import '../../autentikasi/screens/login_screen.dart';import '../services/receiving_service.dart';import '../../../core/services/storage_service.dart';import '../../../core/screens/profile_screen.dart';import 'coordinator_request_screen.dart';class DashboardKoordinatorScreen extends StatefulWidget {const DashboardKoordinatorScreen({super.key});@overrideState<DashboardKoordinatorScreen> createState() => _DashboardKoordinatorScreenState();}class _DashboardKoordinatorScreenState extends State<DashboardKoordinatorScreen> {final ReceivingService _service = ReceivingService();final StorageService _storageService = StorageService();DateTime _focusedDay = DateTime.now();DateTime _selectedDay = DateTime.now();CalendarFormat _calendarFormat = CalendarFormat.week; // Default Minggu biar ringkasMap<DateTime, List<dynamic>> _deliveries = {};bool _isLoading = true;@overridevoid initState() {super.initState();_fetchData();}Future<void> _fetchData() async {setState(() => _isLoading = true);try {final data = await _service.getMonthlyDeliveries(_focusedDay);Map<DateTime, List<dynamic>> newMap = {};for (var item in data) {// Parsing tanggal dari database (YYYY-MM-DD)final dateStr = item['delivery_routes']['date'];final date = DateTime.parse(dateStr);final dateKey = DateTime(date.year, date.month, date.day);if (newMap[dateKey] == null) newMap[dateKey] = [];newMap[dateKey]!.add(item);}if (mounted) {setState(() {_deliveries = newMap;_isLoading = false;});}} catch (e) {if (mounted) setState(() => _isLoading = false);}}List<dynamic> _getEventsForDay(DateTime day) {final dateKey = DateTime(day.year, day.month, day.day);return _deliveries[dateKey] ?? [];}// --- LOGIKA DIALOG ---void _showConfirmationDialog(String stopId) {final qtyController = TextEditingController();final noteController = TextEditingController();File? photoFile;bool isProblem = false;bool isSubmitting = false;showDialog(context: context, barrierDismissible: false, builder: (ctx) => StatefulBuilder(builder: (context, setDialogState) {return AlertDialog(title: const Text("Konfirmasi Penerimaan"),content: SingleChildScrollView(child: Column(mainAxisSize: MainAxisSize.min, children: [Row(children: [Expanded(child: ChoiceChip(label: const Text(" Aman"), selected: !isProblem, selectedColor: Colors.green[100], onSelected: (val) => setDialogState(() => isProblem = !val))),const SizedBox(width: 10),Expanded(child: ChoiceChip(label: const Text(" Masalah"), selected: isProblem, selectedColor: Colors.red[100], onSelected: (val) => setDialogState(() => isProblem = val))),]),const SizedBox(height: 15),TextField(controller: qtyController, keyboardType: TextInputType.number, decoration: const InputDecoration(labelText: "Jml Diterima", border: OutlineInputBorder())),const SizedBox(height: 10),TextField(controller: noteController, decoration: InputDecoration(labelText: isProblem ? "Detail Kerusakan" : "Catatan", border: const OutlineInputBorder()), maxLines: 2),const SizedBox(height: 10),if (isProblem) GestureDetector(onTap: () async {final file = await _storageService.pickImage(ImageSource.camera);if (file != null) setDialogState(() => photoFile = file);},child: Container(height: 100, width: double.infinity, decoration: BoxDecoration(color: Colors.grey[200], border: Border.all(color: Colors.grey), borderRadius: BorderRadius.circular(8)), child: photoFile == null ? const Column(mainAxisAlignment: MainAxisAlignment.center, children: [Icon(Icons.camera_alt), Text("FOTO BUKTI")]) : Image.file(photoFile!, fit: BoxFit.cover)),),if (isSubmitting) const Padding(padding: EdgeInsets.only(top: 15), child: CircularProgressIndicator())]),),actions: [if (!isSubmitting) TextButton(onPressed: () => Navigator.pop(ctx), child: const Text("Batal")),if (!isSubmitting) ElevatedButton(style: ElevatedButton.styleFrom(backgroundColor: isProblem ? Colors.red : Colors.teal, foregroundColor: Colors.white),onPressed: () async {if (isProblem && photoFile == null) { ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Wajib foto bukti!"))); return; }setDialogState(() => isSubmitting = true);try {String? imageUrl;if (photoFile != null) imageUrl = await _storageService.uploadEvidence(photoFile!, 'stops');await _service.confirmReception(stopId: stopId, receivedQty: int.tryParse(qtyController.text) ?? 0, notes: isProblem ? "[MASALAH] ${noteController.text}" : noteController.text, recipientName: "Koordinator", issueType: isProblem ? 'problem' : null, proofUrl: imageUrl);if (!mounted) return;Navigator.pop(ctx);_fetchData();ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Laporan Terkirim!")));} catch (e) { setDialogState(() => isSubmitting = false); }},child: Text(isProblem ? "Lapor" : "Terima"),)],);},));}@overrideWidget build(BuildContext context) {return Scaffold(appBar: AppBar(title: const Text("Jadwal & Status"), // Judul lebih relevanbackgroundColor: Colors.teal[700],foregroundColor: Colors.white,actions: [IconButton(icon: const Icon(Icons.edit_document), onPressed: () => Navigator.push(context, MaterialPageRoute(builder: (_) => const CoordinatorRequestScreen()))),IconButton(icon: const Icon(Icons.account_circle, size: 30), onPressed: () => Navigator.push(context, MaterialPageRoute(builder: (_) => const ProfileScreen()))),],),body: Column(children: [// HEADER & FILTER FORMATContainer(padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),color: Colors.grey[100],child: Row(mainAxisAlignment: MainAxisAlignment.spaceBetween,children: [const Text("Kalender Pengiriman:", style: TextStyle(fontWeight: FontWeight.bold)),DropdownButtonHideUnderline(child: DropdownButton<CalendarFormat>(value: _calendarFormat,items: const [DropdownMenuItem(value: CalendarFormat.month, child: Text("Bulan")),DropdownMenuItem(value: CalendarFormat.week, child: Text("Minggu")),],onChanged: (fmt) => setState(() => _calendarFormat = fmt!),)),],),),// KALENDERTableCalendar(firstDay: DateTime(2024), lastDay: DateTime(2030),focusedDay: _focusedDay, currentDay: DateTime.now(),selectedDayPredicate: (d) => isSameDay(_selectedDay, d),calendarFormat: _calendarFormat,headerStyle: const HeaderStyle(formatButtonVisible: false, titleCentered: true),eventLoader: _getEventsForDay,calendarStyle: const CalendarStyle(todayDecoration: BoxDecoration(color: Colors.teal, shape: BoxShape.circle),selectedDecoration: BoxDecoration(color: Colors.orange, shape: BoxShape.circle),markerDecoration: BoxDecoration(color: Colors.teal, shape: BoxShape.circle),),onDaySelected: (sel, foc) { setState(() { _selectedDay = sel; _focusedDay = foc; }); },onPageChanged: (foc) { _focusedDay = foc; _fetchData(); },),const Divider(thickness: 1),// LIST HARIANExpanded(child: _isLoading? const Center(child: CircularProgressIndicator()): _buildDayList(),),],),);}Widget _buildDayList() {final events = _getEventsForDay(_selectedDay);if (events.isEmpty) {return Center(child: Column(mainAxisAlignment: MainAxisAlignment.center,children: [const Icon(Icons.event_busy, size: 60, color: Colors.grey),const SizedBox(height: 10),Text("Tidak ada jadwal pada ${DateFormat('dd MMM').format(_selectedDay)}", style: const TextStyle(color: Colors.grey)),],),);}return ListView.builder(itemCount: events.length,padding: const EdgeInsets.all(16),itemBuilder: (context, index) {final item = events[index];final status = item['status'];final vehicle = item['delivery_routes']['vehicles'];final plat = vehicle != null ? vehicle['plate_number'] : '-';final driver = vehicle != null ? vehicle['driver_name'] : '-';// --- LOGIKA STATUS (Timeline Visual) ---String step1Title = "1. Produksi (Dapur)";String step1Status = "Selesai"; // Asumsi kalau rute udah dibuat, produksi on-goingColor step1Color = Colors.green;String step2Title = "2. Distribusi (Kurir)";String step2Status = "Menunggu";Color step2Color = Colors.grey;String step3Title = "3. Penerimaan (Sekolah)";String step3Status = "Belum Tiba";Color step3Color = Colors.grey;bool showButton = false;if (status == 'active') {step2Status = "Sedang Berjalan ";step2Color = Colors.blue;} else if (status == 'completed') {step2Status = "Sampai di Gerbang";step2Color = Colors.green;step3Status = "Perlu Konfirmasi Anda";step3Color = Colors.orange;showButton = true;} else if (status == 'received' || status == 'issue_reported') {step2Status = "Selesai";step2Color = Colors.green;step3Status = status == 'received' ? "Diterima Aman " : "Ada Masalah ";step3Color = status == 'received' ? Colors.green : Colors.red;}return Card(elevation: 3,margin: const EdgeInsets.only(bottom: 15),child: Padding(padding: const EdgeInsets.all(16.0),child: Column(crossAxisAlignment: CrossAxisAlignment.start,children: [// HeaderRow(mainAxisAlignment: MainAxisAlignment.spaceBetween,children: [Text("Armada: $plat", style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 16)),Text(driver, style: const TextStyle(color: Colors.grey)),],),const Divider(),// TIMELINE PROSES_buildStep(step1Title, step1Status, step1Color, Icons.soup_kitchen),_buildLine(step2Color),_buildStep(step2Title, step2Status, step2Color, Icons.local_shipping),_buildLine(step3Color),_buildStep(step3Title, step3Status, step3Color, Icons.school),if (showButton) ...[const SizedBox(height: 20),SizedBox(width: double.infinity,child: ElevatedButton(onPressed: () => _showConfirmationDialog(item['id']),style: ElevatedButton.styleFrom(backgroundColor: Colors.teal, foregroundColor: Colors.white),child: const Text("KONFIRMASI PENERIMAAN"),),),]],),),);},);}// Helper Widget untuk TimelineWidget _buildStep(String title, String status, Color color, IconData icon) {return Row(children: [Icon(icon, color: color, size: 24),const SizedBox(width: 10),Column(crossAxisAlignment: CrossAxisAlignment.start,children: [Text(title, style: const TextStyle(fontSize: 12, color: Colors.grey)),Text(status, style: TextStyle(fontWeight: FontWeight.bold, color: color)),],)],);}Widget _buildLine(Color color) {return Container(margin: const EdgeInsets.only(left: 11, top: 2, bottom: 2),height: 15,width: 2,color: color.withOpacity(0.5),);}}

=== FILE: lib/features/koordinator/services/receiving_service.dart ===
import 'package:supabase_flutter/supabase_flutter.dart';class ReceivingService {final _supabase = Supabase.instance.client;// Helper: Ambil School ID userFuture<String> _getMySchoolId() async {final userId = _supabase.auth.currentUser!.id;final profile = await _supabase.from('profiles').select('school_id').eq('id', userId).single();final String? mySchoolId = profile['school_id'];if (mySchoolId == null) throw Exception("Akun ini tidak terhubung ke sekolah manapun.");return mySchoolId;}// 1. AMBIL JADWAL PENGIRIMAN BULANAN (Untuk Kalender)Future<List<Map<String, dynamic>>> getMonthlyDeliveries(DateTime month) async {try {final mySchoolId = await _getMySchoolId();// Tentukan awal & akhir bulanfinal startDate = DateTime(month.year, month.month, 1);final endDate = DateTime(month.year, month.month + 1, 0);// Join: delivery_stops -> delivery_routes (filter tanggal) -> vehiclesfinal response = await _supabase.from('delivery_stops').select('*, delivery_routes!inner(date, vehicles(plate_number, driver_name))').eq('school_id', mySchoolId).gte('delivery_routes.date', startDate.toIso8601String()).lte('delivery_routes.date', endDate.toIso8601String()).neq('status', 'cancelled') // Jangan ambil yang batal.order('created_at', ascending: false);return List<Map<String, dynamic>>.from(response);} catch (e) {throw Exception("Gagal ambil jadwal koordinator: $e");}}// 2. KONFIRMASI PENERIMAANFuture<void> confirmReception({required String stopId,required int receivedQty,required String notes,required String recipientName,String? issueType,String? proofUrl,}) async {try {final String status = (issueType != null && issueType.isNotEmpty)? 'issue_reported': 'received';await _supabase.from('delivery_stops').update({'status': status,'received_qty': receivedQty,'reception_notes': notes,'recipient_name': recipientName,'completion_time': DateTime.now().toIso8601String(),'proof_photo_url': proofUrl,}).eq('id', stopId);} catch (e) {throw Exception("Gagal konfirmasi: $e");}}}

=== FILE: lib/features/shared/screens/notification_screen.dart ===
import 'package:flutter/material.dart';import '../services/notification_service.dart';import 'package:intl/intl.dart';class NotificationScreen extends StatelessWidget {const NotificationScreen({super.key});@overrideWidget build(BuildContext context) {return Scaffold(appBar: AppBar(title: const Text("Notifikasi"),backgroundColor: Colors.white,foregroundColor: Colors.black,elevation: 1,),body: StreamBuilder<List<NotificationModel>>(stream: NotificationService().getMyNotificationsStream(),builder: (context, snapshot) {if (snapshot.connectionState == ConnectionState.waiting) {return const Center(child: CircularProgressIndicator());}final data = snapshot.data ?? [];if (data.isEmpty) {return const Center(child: Text("Belum ada notifikasi."));}return ListView.builder(itemCount: data.length,itemBuilder: (context, index) {final item = data[index];return Card(color: item.isRead ? Colors.white : Colors.blue[50], // Warna beda kalau belum bacamargin: const EdgeInsets.symmetric(horizontal: 10, vertical: 5),child: ListTile(leading: _getIcon(item.type),title: Text(item.title, style: TextStyle(fontWeight: item.isRead ? FontWeight.normal : FontWeight.bold)),subtitle: Column(crossAxisAlignment: CrossAxisAlignment.start,children: [Text(item.body),const SizedBox(height: 5),Text(DateFormat('dd MMM HH:mm').format(item.createdAt), style: const TextStyle(fontSize: 10, color: Colors.grey)),],),onTap: () {// Tandai sudah dibacaNotificationService().markAsRead(item.id);},),);},);},),);}Icon _getIcon(String type) {if (type == 'error') return const Icon(Icons.error, color: Colors.red);if (type == 'warning') return const Icon(Icons.warning, color: Colors.orange);if (type == 'success') return const Icon(Icons.check_circle, color: Colors.green);return const Icon(Icons.notifications, color: Colors.blue);}}

=== FILE: lib/features/shared/services/notification_service.dart ===
import 'package:supabase_flutter/supabase_flutter.dart';class NotificationModel {final String id;final String title;final String body;final String type;final bool isRead;final DateTime createdAt;NotificationModel({required this.id,required this.title,required this.body,required this.type,required this.isRead,required this.createdAt,});factory NotificationModel.fromJson(Map<String, dynamic> json) {return NotificationModel(id: json['id'],title: json['title'],body: json['body'],type: json['type'] ?? 'info',isRead: json['is_read'] ?? false,createdAt: DateTime.parse(json['created_at']),);}}class NotificationService {final _supabase = Supabase.instance.client;// 1. KIRIM NOTIFIKASI (Dipanggil oleh Service Lain)Future<void> sendNotification({required String recipientId,required String title,required String body,String type = 'info',String? relatedId,}) async {try {await _supabase.from('notifications').insert({'user_id': recipientId,'title': title,'body': body,'type': type,'related_id': relatedId,});} catch (e) {print("Gagal kirim notif: $e");}}// 2. AMBIL STREAM NOTIFIKASI (Realtime)Stream<List<NotificationModel>> getMyNotificationsStream() {final myId = _supabase.auth.currentUser!.id;return _supabase.from('notifications').stream(primaryKey: ['id']).eq('user_id', myId).order('created_at', ascending: false).map((data) =>data.map((json) => NotificationModel.fromJson(json)).toList(),);}// 3. TANDAI SUDAH DIBACAFuture<void> markAsRead(String notificationId) async {await _supabase.from('notifications').update({'is_read': true}).eq('id', notificationId);}// 4. HITUNG BELUM DIBACA (Untuk Badge Lonceng)Future<int> getUnreadCount() async {final myId = _supabase.auth.currentUser!.id;// Di Supabase terbaru, ini langsung mengembalikan angka (int)final count = await _supabase.from('notifications').count(CountOption.exact).eq('user_id', myId).eq('is_read', false);return count; // <-- JANGAN PAKAI .count LAGI}}

=== FILE: lib/features/shared/services/request_service.dart ===
import 'package:supabase_flutter/supabase_flutter.dart';import 'package:intl/intl.dart';import 'package:flutter/material.dart';// Model untuk Detail Request (Menu/Jadwal/Porsi)class RequestDetail {final String menuId;final String menuName;final int newQuantity;final TimeOfDay? newTime;final DateTime? newDate;RequestDetail({required this.menuId,required this.menuName,this.newQuantity = 0,this.newTime,this.newDate,});// Method untuk konversi TimeOfDay ke String HH:mm:ssString? formatTime() {if (newTime == null) return null;return "${newTime!.hour.toString().padLeft(2, '0')}:${newTime!.minute.toString().padLeft(2, '0')}:00";}}// Model Utama Requestclass ChangeRequestModel {final String id;final String type; // schedule, menu, portionfinal String oldNotes;final String status; // pending, approved, rejectedfinal String? adminResponse;final String requestDate;final String schoolName; // Nama Sekolah pengirimChangeRequestModel({required this.id,required this.type,required this.oldNotes,required this.status,this.adminResponse,required this.requestDate,required this.schoolName,});factory ChangeRequestModel.fromJson(Map<String, dynamic> json) {return ChangeRequestModel(id: json['id'].toString(),type: json['request_type'] ?? '-',oldNotes: json['old_notes'] ?? '-',status: json['status'] ?? 'pending',adminResponse: json['admin_response'],requestDate: DateFormat('dd MMM yyyy').format(DateTime.parse(json['created_at'])),schoolName: json['schools'] != null ? json['schools']['name'] : 'Sekolah',);}}class RequestService {final _supabase = Supabase.instance.client;// [BARU] FUNGSI 0: Ambil Menu yang terdaftar di SPPG Koordinator (Untuk Dropdown)Future<List<Map<String, dynamic>>> getSppgMenus() async {try {final userId = _supabase.auth.currentUser!.id;final profile = await _supabase.from('profiles').select('sppg_id').eq('id', userId).single();final String mySppgId = profile['sppg_id'];final response = await _supabase.from('menus').select().eq('sppg_id', mySppgId).order('category', ascending: true);return List<Map<String, dynamic>>.from(response);} catch (e) {throw Exception("Gagal ambil menu: $e");}}// --- 1. KOORDINATOR: KIRIM REQUEST (DENGAN DETAIL TERSTRUKTUR) ---Future<void> submitStructuredRequest({required String type,String? notes,required List<RequestDetail> details, // List detail menu/jadwal}) async {try {final userId = _supabase.auth.currentUser!.id;// Cari Info Sekolah & SPPG Koordinatorfinal profile = await _supabase.from('profiles').select('school_id, sppg_id').eq('id', userId).single();// A. Masukkan Request Utamafinal response = await _supabase.from('change_requests').insert({'requester_id': userId,'school_id': profile['school_id'],'sppg_id': profile['sppg_id'],'request_type': type,'old_notes': notes, // Gunakan notes sebagai catatan umum'status': 'pending',}).select().single(); // Wajib select() untuk ambil ID request yang barufinal String newRequestId = response['id'];// B. Masukkan Detail ke Tabel change_request_details (Jika tabel ini ada)// CATATAN: Jika Anda belum membuat tabel 'change_request_details',// bagian di bawah ini bisa di-skip atau disesuaikan.// Tapi untuk fitur lengkap sesuai revisi, sebaiknya tabel ini dibuat./*List<Map<String, dynamic>> detailData = [];for (var item in details) {detailData.add({'request_id': newRequestId,'menu_id': item.menuId,// Isi kolom berdasarkan tipe request yang dikirimif (type == 'Perubahan Jadwal') ...{'new_schedule_date': item.newDate!.toIso8601String().split('T')[0],'new_schedule_time': item.formatTime(),},if (type == 'Tambah/Kurang Porsi')'new_quantity': item.newQuantity,// Jika Perubahan Menu, kita kirim saja menuId yang baru dipilih});}if (detailData.isNotEmpty) {await _supabase.from('change_request_details').insert(detailData);}*/// -- ALTERNATIF JIKA BELUM ADA TABEL DETAIL --// Kita simpan detailnya dalam bentuk string JSON di kolom 'details' atau 'old_notes'// biar admin tetap bisa baca walau tabel detail belum siap.// Tapi karena di atas kita pakai 'old_notes' untuk catatan, kita biarkan saja.} catch (e) {throw Exception("Gagal kirim request: $e");}}// --- 2. KOORDINATOR: LIHAT HISTORY REQUEST SAYA ---Future<List<ChangeRequestModel>> getMyRequests() async {try {final userId = _supabase.auth.currentUser!.id;final response = await _supabase.from('change_requests').select('*, schools(name)').eq('requester_id', userId).order('created_at', ascending: false);final List<dynamic> data = response;return data.map((json) => ChangeRequestModel.fromJson(json)).toList();} catch (e) {throw Exception("Gagal ambil history request: $e");}}// --- 3. ADMIN: LIHAT SEMUA REQUEST MASUK (INBOX) ---Future<List<ChangeRequestModel>> getIncomingRequests() async {try {final userId = _supabase.auth.currentUser!.id;// Cari SPPG ID Adminfinal profile = await _supabase.from('profiles').select('sppg_id').eq('id', userId).single();final mySppgId = profile['sppg_id'];final response = await _supabase.from('change_requests').select('*, schools(name)').eq('sppg_id', mySppgId).order('created_at', ascending: false);final List<dynamic> data = response;return data.map((json) => ChangeRequestModel.fromJson(json)).toList();} catch (e) {throw Exception("Gagal ambil inbox request: $e");}}// --- 4. ADMIN: RESPON REQUEST (TERIMA/TOLAK) ---Future<void> respondRequest(String id, String status, String responseText) async {try {await _supabase.from('change_requests').update({'status': status,'admin_response': responseText,'updated_at': DateTime.now().toIso8601String(),}).eq('id', id);} catch (e) {throw Exception("Gagal respon request: $e");}}}

=== FILE: lib/features/autentikasi/screens/forgot_password_screen.dart ===
import 'package:flutter/material.dart';import 'package:supabase_flutter/supabase_flutter.dart';class ForgotPasswordScreen extends StatefulWidget {const ForgotPasswordScreen({super.key});@overrideState<ForgotPasswordScreen> createState() => _ForgotPasswordScreenState();}class _ForgotPasswordScreenState extends State<ForgotPasswordScreen> {final _emailController = TextEditingController();final _otpController = TextEditingController();final _newPasswordController = TextEditingController();bool _isLoading = false;int _step = 1; // 1: Input Email, 2: Input OTP, 3: Input Password Baru// TAHAP 1: KIRIM OTP (TOKEN) KE EMAIL// Kita pakai signInWithOtp agar Supabase mengirim kode angka, bukan magic linkFuture<void> _sendOtp() async {if (_emailController.text.isEmpty) {ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Masukkan email Anda")));return;}setState(() => _isLoading = true);try {await Supabase.instance.client.auth.signInWithOtp(email: _emailController.text.trim(),shouldCreateUser: false, // Pastikan user memang sudah ada);setState(() => _step = 2); // Pindah ke tahap input OTPif(mounted) ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Kode OTP 6 digit telah dikirim ke email Anda.")));} catch (e) {ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Gagal mengirim OTP: $e")));} finally {setState(() => _isLoading = false);}}// TAHAP 2: VERIFIKASI OTP & LOGINFuture<void> _verifyOtp() async {if (_otpController.text.isEmpty) return;setState(() => _isLoading = true);try {// Verifikasi Token. Tipe-nya adalah 'email' (karena kita pakai signInWithOtp)// Jika berhasil, user akan otomatis ter-LOGIN.final res = await Supabase.instance.client.auth.verifyOTP(token: _otpController.text.trim(),type: OtpType.email,email: _emailController.text.trim(),);if (res.session != null) {// Login berhasil! Sekarang kita minta user buat password baru.setState(() => _step = 3);}} catch (e) {ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Kode OTP Salah atau Kadaluarsa.")));} finally {setState(() => _isLoading = false);}}// TAHAP 3: UPDATE PASSWORD BARU// Karena user sudah posisi login (hasil tahap 2), kita bisa langsung update user.Future<void> _updatePassword() async {if (_newPasswordController.text.length < 6) {ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Password minimal 6 karakter")));return;}setState(() => _isLoading = true);try {await Supabase.instance.client.auth.updateUser(UserAttributes(password: _newPasswordController.text),);if (!mounted) return;// Sukses! Logout dulu biar user login ulang pakai password baru (Opsional, tapi lebih aman)await Supabase.instance.client.auth.signOut();ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Password Berhasil Diubah! Silakan Login kembali."),backgroundColor: Colors.green,));Navigator.pop(context); // Kembali ke Login Screen} catch (e) {ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Gagal simpan password: $e")));} finally {setState(() => _isLoading = false);}}@overrideWidget build(BuildContext context) {return Scaffold(appBar: AppBar(title: const Text("Reset Password")),body: Padding(padding: const EdgeInsets.all(24.0),child: Column(mainAxisAlignment: MainAxisAlignment.center,children: [// UI TAHAP 1: EMAILif (_step == 1) ...[const Icon(Icons.lock_reset, size: 60, color: Colors.blue),const SizedBox(height: 20),const Text("Lupa Password?",style: TextStyle(fontSize: 24, fontWeight: FontWeight.bold)),const SizedBox(height: 10),const Text("Masukkan email Anda. Kami akan mengirimkan kode OTP 6 digit untuk mengatur ulang kata sandi.",textAlign: TextAlign.center,style: TextStyle(color: Colors.grey),),const SizedBox(height: 30),TextField(controller: _emailController,keyboardType: TextInputType.emailAddress,decoration: const InputDecoration(labelText: "Email Terdaftar",border: OutlineInputBorder(),prefixIcon: Icon(Icons.email)),),const SizedBox(height: 20),SizedBox(width: double.infinity,child: ElevatedButton(onPressed: _isLoading ? null : _sendOtp,style: ElevatedButton.styleFrom(padding: const EdgeInsets.all(16)),child: _isLoading ? const CircularProgressIndicator() : const Text("KIRIM KODE OTP"),),),// UI TAHAP 2: INPUT OTP] else if (_step == 2) ...[const Icon(Icons.mark_email_read, size: 60, color: Colors.green),const SizedBox(height: 20),const Text("Verifikasi OTP",style: TextStyle(fontSize: 24, fontWeight: FontWeight.bold)),const SizedBox(height: 10),Text("Masukkan 6 digit kode yang dikirim ke ${_emailController.text}",textAlign: TextAlign.center,style: const TextStyle(color: Colors.grey),),const SizedBox(height: 30),TextField(controller: _otpController,keyboardType: TextInputType.number,textAlign: TextAlign.center,style: const TextStyle(fontSize: 24, letterSpacing: 8, fontWeight: FontWeight.bold),decoration: const InputDecoration(hintText: "000000",border: OutlineInputBorder(),),),const SizedBox(height: 20),SizedBox(width: double.infinity,child: ElevatedButton(onPressed: _isLoading ? null : _verifyOtp,style: ElevatedButton.styleFrom(padding: const EdgeInsets.all(16)),child: _isLoading ? const CircularProgressIndicator() : const Text("VERIFIKASI"),),),// UI TAHAP 3: PASSWORD BARU] else ...[const Icon(Icons.key, size: 60, color: Colors.orange),const SizedBox(height: 20),const Text("Buat Password Baru",style: TextStyle(fontSize: 24, fontWeight: FontWeight.bold)),const SizedBox(height: 30),TextField(controller: _newPasswordController,obscureText: true,decoration: const InputDecoration(labelText: "Password Baru",border: OutlineInputBorder(),prefixIcon: Icon(Icons.lock)),),const SizedBox(height: 20),SizedBox(width: double.infinity,child: ElevatedButton(onPressed: _isLoading ? null : _updatePassword,style: ElevatedButton.styleFrom(padding: const EdgeInsets.all(16), backgroundColor: Colors.green, foregroundColor: Colors.white),child: _isLoading ? const CircularProgressIndicator(color: Colors.white) : const Text("SIMPAN PASSWORD"),),),]],),),);}}

=== FILE: lib/features/autentikasi/screens/login_screen.dart ===
import 'package:flutter/material.dart';import 'package:supabase_flutter/supabase_flutter.dart';// Import Layar Lupa Passwordimport 'forgot_password_screen.dart';// Import Semua Dashboardimport '../../pengawas/screens/dashboard_bgn_screen.dart';import '../../admin_sppg/screens/dashboard_admin_screen.dart';import '../../kurir/screens/dashboard_kurir_screen.dart';import '../../koordinator/screens/dashboard_koordinator_screen.dart';import '../../walikelas/screens/dashboard_teacher_screen.dart';class LoginScreen extends StatefulWidget {const LoginScreen({super.key});@overrideState<LoginScreen> createState() => _LoginScreenState();}class _LoginScreenState extends State<LoginScreen> {final TextEditingController _emailController = TextEditingController();final TextEditingController _passwordController = TextEditingController();bool _isLoading = false;Future<void> _login() async {setState(() { _isLoading = true; });try {final email = _emailController.text.trim();final password = _passwordController.text.trim();if (email.isEmpty || password.isEmpty) {throw Exception("Email dan Password harus diisi.");}// 1. Login Authfinal AuthResponse res = await Supabase.instance.client.auth.signInWithPassword(email: email,password: password,);if (res.user == null) {throw Exception("Login gagal. Periksa kembali email & password Anda.");}if (!mounted) return;// 2. Cek Role di Databasefinal userId = res.user!.id;final profileData = await Supabase.instance.client.from('profiles').select().eq('id', userId).single();if (profileData == null) throw Exception("Profil user tidak ditemukan.");// Normalisasi Role (Kecilkan huruf & hapus spasi)final String rawRole = profileData['role'] ?? 'unknown';final String role = rawRole.toLowerCase().trim();if (!mounted) return;// 3. Navigasi Sesuai Role// (Saya hapus 'const' di sini agar aman dari error constructor di masa depan)if (role == 'bgn') {Navigator.pushReplacement(context, MaterialPageRoute(builder: (_) => DashboardBgnScreen()));} else if (role == 'admin_sppg') {Navigator.pushReplacement(context, MaterialPageRoute(builder: (_) => DashboardAdminScreen()));} else if (role == 'kurir') {Navigator.pushReplacement(context, MaterialPageRoute(builder: (_) => DashboardKurirScreen()));} else if (role == 'koordinator') {Navigator.pushReplacement(context, MaterialPageRoute(builder: (_) => DashboardKoordinatorScreen()));} else if (role == 'walikelas') {Navigator.pushReplacement(context, MaterialPageRoute(builder: (_) => DashboardTeacherScreen()));} else {ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Akses Ditolak: Role '$rawRole' tidak dikenali."), backgroundColor: Colors.red),);await Supabase.instance.client.auth.signOut();}} catch (e) {if (!mounted) return;ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Gagal Masuk: ${e.toString().replaceAll('Exception:', '')}"), backgroundColor: Colors.red),);} finally {if (mounted) setState(() { _isLoading = false; });}}@overridevoid dispose() {_emailController.dispose();_passwordController.dispose();super.dispose();}@overrideWidget build(BuildContext context) {return Scaffold(body: Center(child: SingleChildScrollView(padding: const EdgeInsets.all(24.0),child: Column(mainAxisAlignment: MainAxisAlignment.center,children: [const Icon(Icons.security, size: 80, color: Colors.blue),const SizedBox(height: 20),const Text("MBG Monitoring", style: TextStyle(fontSize: 24, fontWeight: FontWeight.bold)),const Text("Silakan masuk untuk melanjutkan", style: TextStyle(color: Colors.grey)),const SizedBox(height: 40),// Input EmailTextField(controller: _emailController,keyboardType: TextInputType.emailAddress,decoration: const InputDecoration(labelText: "Email", border: OutlineInputBorder(), prefixIcon: Icon(Icons.email)),),const SizedBox(height: 16),// Input PasswordTextField(controller: _passwordController,obscureText: true,decoration: const InputDecoration(labelText: "Password", border: OutlineInputBorder(), prefixIcon: Icon(Icons.lock)),),const SizedBox(height: 10),// [BARU] Tombol Lupa PasswordAlign(alignment: Alignment.centerRight,child: TextButton(onPressed: () {Navigator.push(context,MaterialPageRoute(builder: (_) => const ForgotPasswordScreen()),);},child: const Text("Lupa Password?", style: TextStyle(color: Colors.blue)),),),const SizedBox(height: 20),// Tombol MasukSizedBox(width: double.infinity,height: 50,child: ElevatedButton(onPressed: _isLoading ? null : _login,style: ElevatedButton.styleFrom(backgroundColor: Colors.blue[800], foregroundColor: Colors.white, shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(10))),child: _isLoading? const CircularProgressIndicator(color: Colors.white): const Text("MASUK", style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold)),),),],),),),);}}

=== FILE: lib/features/autentikasi/services/auth_service.dart ===
import 'package:supabase_flutter/supabase_flutter.dart';import '../../../models/user_profile.dart';class AuthService {final SupabaseClient _supabase = Supabase.instance.client;// Fungsi LoginFuture<UserProfile?> signIn({required String email,required String password,}) async {try {// 1. Login ke Auth Supabase (Cek Email & Password)final AuthResponse response = await _supabase.auth.signInWithPassword(email: email,password: password,);if (response.user == null) {throw 'Login gagal: User tidak ditemukan';}final userId = response.user!.id;final userEmail = response.user!.email;// 2. Ambil Data Profil & Role dari Tabel 'profiles'// Kita select data berdasarkan ID user yang barusan loginfinal data = await _supabase.from('profiles').select().eq('id', userId).single();// 3. Kembalikan sebagai objek UserProfilereturn UserProfile.fromJson(data, userEmail);} on AuthException catch (e) {// Error khusus Supabase (misal: password salah)throw e.message;} catch (e) {// Error umum lainnyathrow 'Terjadi kesalahan: $e';}}// Fungsi LogoutFuture<void> signOut() async {await _supabase.auth.signOut();}// Cek apakah ada user yang sedang login (untuk auto-login)User? getCurrentUser() {return _supabase.auth.currentUser;}}

=== FILE: lib/features/admin_sppg/screens/complaint_list_screen.dart ===
import 'package:flutter/material.dart';import '../services/complaint_service.dart';class ComplaintListScreen extends StatefulWidget {const ComplaintListScreen({super.key});@overrideState<ComplaintListScreen> createState() => _ComplaintListScreenState();}class _ComplaintListScreenState extends State<ComplaintListScreen> with SingleTickerProviderStateMixin {late TabController _tabController;final ComplaintService _service = ComplaintService();@overridevoid initState() {super.initState();_tabController = TabController(length: 2, vsync: this);}// --- DIALOG RESPON ADMIN ---void _showRespondDialog(String table, String id, String currentNote) {final responseController = TextEditingController();showDialog(context: context,builder: (ctx) => AlertDialog(title: const Text("Beri Instruksi"),content: Column(mainAxisSize: MainAxisSize.min,crossAxisAlignment: CrossAxisAlignment.start,children: [const Text("Masalah:", style: TextStyle(fontWeight: FontWeight.bold)),Text(currentNote, style: const TextStyle(color: Colors.red)),const SizedBox(height: 15),TextField(controller: responseController,decoration: const InputDecoration(labelText: "Instruksi Tindak Lanjut",hintText: "Contoh: Segera retur, kami kirim pengganti.",border: OutlineInputBorder(),),maxLines: 3,),],),actions: [TextButton(onPressed: () => Navigator.pop(ctx), child: const Text("Batal")),ElevatedButton(onPressed: () async {Navigator.pop(ctx);await _service.respondToComplaint(table: table, id: id, response: responseController.text);setState(() {}); // Refresh listif (mounted) {ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Instruksi Terkirim!")));}},child: const Text("Kirim"),)],),);}@overrideWidget build(BuildContext context) {return Scaffold(appBar: AppBar(title: const Text("Pusat Pengaduan"),backgroundColor: Colors.red[700], // Warna Merah biar kerasa 'Urgent'foregroundColor: Colors.white,bottom: TabBar(controller: _tabController,indicatorColor: Colors.white,labelColor: Colors.white,unselectedLabelColor: Colors.white70,tabs: const [Tab(text: "Dari Koordinator"),Tab(text: "Dari Wali Kelas"),],),),body: TabBarView(controller: _tabController,children: [_buildCoordinatorList(),_buildTeacherList(),],),);}// TAB 1: LAPORAN KOORDINATORWidget _buildCoordinatorList() {return FutureBuilder<List<Map<String, dynamic>>>(future: _service.getCoordinatorComplaints(),builder: (context, snapshot) {if (snapshot.connectionState == ConnectionState.waiting) return const Center(child: CircularProgressIndicator());final data = snapshot.data ?? [];if (data.isEmpty) return const Center(child: Text("Tidak ada laporan dari Koordinator."));return ListView.builder(itemCount: data.length,itemBuilder: (ctx, i) {final item = data[i];final schoolName = item['schools']['name'];final note = item['reception_notes'];final isResolved = item['admin_response'] != null;return Card(margin: const EdgeInsets.all(8),color: isResolved ? Colors.grey[200] : Colors.red[50],child: ListTile(leading: Icon(Icons.warning, color: isResolved ? Colors.grey : Colors.red),title: Text(schoolName, style: const TextStyle(fontWeight: FontWeight.bold)),subtitle: Column(crossAxisAlignment: CrossAxisAlignment.start,children: [Text("Laporan: $note"),if (isResolved) Text("Respon: ${item['admin_response']}", style: const TextStyle(color: Colors.green, fontWeight: FontWeight.bold)),],),trailing: isResolved? const Icon(Icons.check_circle, color: Colors.green): ElevatedButton(onPressed: () => _showRespondDialog('delivery_stops', item['id'], note),child: const Text("Respon"),),),);},);},);}// TAB 2: LAPORAN WALI KELASWidget _buildTeacherList() {return FutureBuilder<List<Map<String, dynamic>>>(future: _service.getTeacherComplaints(),builder: (context, snapshot) {if (snapshot.connectionState == ConnectionState.waiting) return const Center(child: CircularProgressIndicator());final data = snapshot.data ?? [];if (data.isEmpty) return const Center(child: Text("Tidak ada laporan dari Wali Kelas."));return ListView.builder(itemCount: data.length,itemBuilder: (ctx, i) {final item = data[i];// Struktur JSON agak dalam karena join berlapisfinal schoolName = item['delivery_stops']['schools']['name'];final className = item['class_name'];final issue = item['issue_type'];final note = item['notes'];final isResolved = item['admin_response'] != null;return Card(margin: const EdgeInsets.all(8),color: isResolved ? Colors.grey[200] : Colors.red[50],child: ListTile(leading: const Icon(Icons.report_problem, color: Colors.orange),title: Text("$schoolName - Kls $className"),subtitle: Column(crossAxisAlignment: CrossAxisAlignment.start,children: [Text("Masalah: $issue"),Text("Catatan: $note"),if (isResolved) Text("Respon: ${item['admin_response']}", style: const TextStyle(color: Colors.green, fontWeight: FontWeight.bold)),],),trailing: isResolved? const Icon(Icons.check_circle, color: Colors.green): ElevatedButton(onPressed: () => _showRespondDialog('class_receptions', item['id'], "$issue: $note"),child: const Text("Respon"),),),);},);},);}}

=== FILE: lib/features/admin_sppg/screens/menu_management_screen.dart ===
import 'package:flutter/material.dart';import '../../../models/menu_model.dart';import '../services/menu_service.dart';import 'add_menu_screen.dart';class MenuManagementScreen extends StatefulWidget {const MenuManagementScreen({super.key});@overrideState<MenuManagementScreen> createState() => _MenuManagementScreenState();}class _MenuManagementScreenState extends State<MenuManagementScreen> {final MenuService _menuService = MenuService();// Method untuk mengambil data menuFuture<List<Menu>> _fetchMenus() async {return await _menuService.getMyMenus();}// Fungsi navigasi ke form tambah/editvoid _navigateToAddEdit(BuildContext context, {Menu? menu}) {Navigator.push(context,MaterialPageRoute(builder: (_) => AddMenuScreen(menuToEdit: menu), // Jika menu null, berarti tambah),).then((result) {if (result == true) {// Refresh tampilan list setelah kembali dari formsetState(() {});}});}// Fungsi hapus menuFuture<void> _deleteMenu(BuildContext context, String menuId) async {await _menuService.deleteMenu(menuId);if (!mounted) return;ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Menu berhasil dihapus!"), backgroundColor: Colors.green),);setState(() {}); // Refresh list}@overrideWidget build(BuildContext context) {return Scaffold(appBar: AppBar(title: const Text("Manajemen Menu Produksi"),backgroundColor: Colors.orange[800],foregroundColor: Colors.white,),body: FutureBuilder<List<Menu>>(future: _fetchMenus(), // Panggil data menubuilder: (context, snapshot) {if (snapshot.connectionState == ConnectionState.waiting) {return const Center(child: CircularProgressIndicator());}if (snapshot.hasError) {return Center(child: Text("Error: ${snapshot.error}"));}final menus = snapshot.data ?? [];if (menus.isEmpty) {return const Center(child: Text("Belum ada menu yang terdaftar."));}return ListView.builder(padding: const EdgeInsets.all(10),itemCount: menus.length,itemBuilder: (context, index) {final menu = menus[index];return Card(elevation: 2,child: ListTile(title: Text(menu.name, style: const TextStyle(fontWeight: FontWeight.bold)),subtitle: Text("${menu.category} | Durasi Masak: ${menu.cookingDurationMinutes} menit"),leading: const Icon(Icons.restaurant_menu, color: Colors.orange),trailing: Row(mainAxisSize: MainAxisSize.min,children: [// Tombol Edit (UC12)IconButton(icon: const Icon(Icons.edit, size: 20),onPressed: () => _navigateToAddEdit(context, menu: menu),),// Tombol Hapus (UC13)IconButton(icon: const Icon(Icons.delete, color: Colors.red, size: 20),onPressed: () => _deleteMenu(context, menu.id),),],),),);},);},),floatingActionButton: FloatingActionButton.extended(backgroundColor: Colors.orange[800],foregroundColor: Colors.white,icon: const Icon(Icons.add),label: const Text("Tambah Menu Baru"), // UC11onPressed: () => _navigateToAddEdit(context),),);}}

=== FILE: lib/features/admin_sppg/screens/edit_route_screen.dart ===
import 'package:flutter/material.dart';import 'package:flutter_map/flutter_map.dart';import 'package:latlong2/latlong.dart';import '../../../models/route_model.dart';import '../../../models/school_model.dart';import '../services/route_service.dart';import '../services/school_service.dart';class EditRouteScreen extends StatefulWidget {final DeliveryRoute route;const EditRouteScreen({super.key, required this.route});@overrideState<EditRouteScreen> createState() => _EditRouteScreenState();}class _EditRouteScreenState extends State<EditRouteScreen> {final RouteService _routeService = RouteService();final MapController _mapController = MapController();// List untuk menampung data Sekolah + ETAList<Map<String, dynamic>> _uiStops = [];List<School> _allSchools = [];// Data PetaLatLng? _sppgLocation;List<LatLng> _polylinePoints = [];int _cookingDuration =120; // Default durasi masak (bisa diambil dari menu nanti)bool _isLoading = true;@overridevoid initState() {super.initState();_fetchData();}Future<void> _fetchData() async {try {// 1. Ambil Lokasi Dapur (Start Point)_sppgLocation = await _routeService.getSppgLocation();// 2. Ambil Data Stops (Sekolah + ETA) dari Databasefinal stops = await _routeService.getRouteStops(widget.route.id);_uiStops = [];List<LatLng> validRoutingPoints = [];// Masukkan Dapur ke titik peta jika adaif (_sppgLocation != null) {validRoutingPoints.add(_sppgLocation!); // Use a new list name}for (var s in stops) {final sc = s['schools'];// Parsing Koordinat Sekolahdouble? lat, long;if (sc['gps_lat'] != null && sc['gps_long'] != null) {try {lat = double.parse(sc['gps_lat'].toString());long = double.parse(sc['gps_long'].toString());// Validate to ensure coordinates are valid non-zeroif (lat != 0 && long != 0 && lat.isFinite && long.isFinite) {validRoutingPoints.add(LatLng(lat, long)); // Add valid point} else {// Log or ignore invalid points.print("Skipping invalid coordinate for school: ${sc['name']}");}} catch (_) {}}// Masukkan ke List UI untuk ditampilkan di bawah peta_uiStops.add({'school': School(id: sc['id'],sppgId: "",name: sc['name'],address: sc['address'],latitude: lat,longitude: long,studentCount: sc['student_count'] ?? 0,deadlineTime: sc['deadline_time'],),'eta': s['estimated_arrival_time'] ?? '--:--', // Ambil Jam Estimasi});}// 3. Ambil Garis Rute (Polyline) dari OSRMif (validRoutingPoints.length >= 2) {_polylinePoints = await _routeService.getRoutePolyline(validRoutingPoints,);} else {// [FIX]: Set polyline to empty list explicitly if points are insufficient._polylinePoints = [];}// 4. Ambil Semua Sekolah (Untuk opsi tambah sekolah nanti)_allSchools = await SchoolService().getMySchools();if (!mounted) return;setState(() => _isLoading = false);// 5. Fit Camera (Zoom Peta Otomatis)// The original crash condition. Check must be precise.if (validRoutingPoints.isNotEmpty) {try {// Only proceed if we have points, otherwise LatLngBounds crashes.if (validRoutingPoints.length > 1) {// If we have multiple points, fit the map.Future.delayed(const Duration(milliseconds: 500), () {if (!mounted) return;_mapController.fitCamera(CameraFit.bounds(bounds: LatLngBounds.fromPoints(validRoutingPoints),padding: const EdgeInsets.all(60),),);});} else if (validRoutingPoints.length == 1 && _sppgLocation != null) {// If only the SPPG location exists, center on it._mapController.move(_sppgLocation!, 15.0);}} catch (e) {print("Map Fit Error: $e");}}} catch (e) {print("Error Fetch: $e");if (mounted) setState(() => _isLoading = false);}}// --- DIALOG TAMBAH SEKOLAH ---void _addSchoolDialog() {showDialog(context: context,builder: (ctx) => AlertDialog(title: const Text("Tambah Sekolah"),content: SizedBox(width: double.maxFinite,height: 300,child: ListView.builder(itemCount: _allSchools.length,itemBuilder: (c, i) {final s = _allSchools[i];// Cek duplikasi: Jangan tampilkan sekolah yang sudah ada di ruteif (_uiStops.any((item) => (item['school'] as School).id == s.id))return const SizedBox.shrink();return ListTile(title: Text(s.name),subtitle: Text("${s.studentCount} Pax | Deadline: ${s.deadlineTime ?? '-'}",),trailing: const Icon(Icons.add_circle, color: Colors.green),onTap: () {setState(() {_uiStops.add({'school': s,'eta':'Hitung...', // Placeholder sebelum save & recalculate});});Navigator.pop(ctx);_recalculateAndSave(); // Simpan & Hitung Ulang},);},),),),);}// --- HAPUS SEKOLAH ---void _removeSchool(int index) {setState(() => _uiStops.removeAt(index));_recalculateAndSave(); // Simpan & Hitung Ulang}// --- LOGIKA SIMPAN & HITUNG ULANG RUTE ---Future<void> _recalculateAndSave() async {if (_uiStops.isEmpty) {if (mounted)ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Rute kosong, tidak ada yang disimpan."),),);return;}setState(() => _isLoading = true);try {List<School> schoolsOnly = _uiStops.map((e) => e['school'] as School).toList();// Asumsi: The route service still needs the menu ID (or cooking duration) for recalculation.// The current implementation is flawed because EditRouteScreen doesn't know the Menu ID.// **CRITICAL WARNING**: The `updateRouteSchools` function in your service relies on getting the Menu ID// from the old route, which is fine, but if the menu changes, this breaks the core logic.// For now, we rely on the logic in the service to pull the necessary data (cooking duration).await _routeService.updateRouteSchools(widget.route.id,schoolsOnly,_cookingDuration, // This is hardcoded/defaulted, which is BAD. FIX LATER.);await _fetchData(); // Refresh agar Peta & ETA baru munculif (mounted)ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Rute & Jadwal Diperbarui!")),);} catch (e) {if (mounted)ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Gagal update: $e"),backgroundColor: Colors.red,),);setState(() => _isLoading = false);}}// Format Jam (Hapus detik HH:mm:ss -> HH:mm)String _formatTime(String? time) {if (time == null || time.isEmpty) return "--:--";if (time.length > 5) return time.substring(0, 5);return time;}@overrideWidget build(BuildContext context) {return Scaffold(appBar: AppBar(title: const Text("Edit Rute & Peta"),backgroundColor: Colors.orange[800],foregroundColor: Colors.white,),body: _isLoading? const Center(child: CircularProgressIndicator()): Column(children: [// --- PETA VISUALISASI ---SizedBox(height: 250,child: FlutterMap(mapController: _mapController,options: const MapOptions(initialCenter: LatLng(-6.9175,107.6191,), // Default BandunginitialZoom: 13.0,// Pastikan gesture aktif (Zoom/Pan)interactionOptions: InteractionOptions(flags: InteractiveFlag.all,),),children: [TileLayer(urlTemplate:'https://tile.openstreetmap.org/{z}/{x}/{y}.png',userAgentPackageName: 'com.example.mbg',),// Garis Rute (Biru)PolylineLayer(polylines: [Polyline(points: _polylinePoints,strokeWidth: 4.0,color: Colors.blue,),],),// Marker (Pin)MarkerLayer(markers: [// Marker Dapurif (_sppgLocation != null)Marker(point: _sppgLocation!,width: 50,height: 50,child: const Column(children: [Icon(Icons.store,color: Colors.purple,size: 35,),Text("DAPUR",style: TextStyle(fontSize: 10,fontWeight: FontWeight.bold,backgroundColor: Colors.white,),),],),),// Marker Sekolah..._uiStops.asMap().entries.map((entry) {final s = entry.value['school'] as School;if (s.latitude == null)return const Marker(point: LatLng(0, 0),child: SizedBox(),);return Marker(point: LatLng(s.latitude!, s.longitude!),width: 40,height: 40,child: Column(children: [const Icon(Icons.location_on,color: Colors.red,size: 30,),Container(padding: const EdgeInsets.symmetric(horizontal: 3,),decoration: BoxDecoration(color: Colors.white,border: Border.all(color: Colors.grey),),child: Text("${entry.key + 1}",style: const TextStyle(fontSize: 10,fontWeight: FontWeight.bold,),),),],),);}).toList(),],),],),),// --- INFO HEADER LIST ---Container(padding: const EdgeInsets.all(12),color: Colors.blue[50],child: Row(mainAxisAlignment: MainAxisAlignment.spaceBetween,children: [const Text("Urutan & Estimasi:",style: TextStyle(fontWeight: FontWeight.bold),),Text("${_uiStops.length} Sekolah",style: const TextStyle(fontWeight: FontWeight.bold,color: Colors.blue,),),],),),// --- LIST SEKOLAH (BISA DIGESER URUTANNYA) ---Expanded(child: ReorderableListView(onReorder: (oldIndex, newIndex) {if (newIndex > oldIndex) newIndex -= 1;final item = _uiStops.removeAt(oldIndex);_uiStops.insert(newIndex, item);setState(() {});_recalculateAndSave();},children: [for (int index = 0; index < _uiStops.length; index++)Card(key: ValueKey((_uiStops[index]['school'] as School).id,),margin: const EdgeInsets.symmetric(horizontal: 10,vertical: 5,),child: ListTile(leading: CircleAvatar(backgroundColor: Colors.orange[100],child: Text("${index + 1}"),),title: Text((_uiStops[index]['school'] as School).name,),// P1: Display ETA, Deadline, High Risksubtitle: Column(crossAxisAlignment: CrossAxisAlignment.start,children: [Text("Deadline: ${_formatTime((_uiStops[index]['school'] as School).deadlineTime)}",),Text("Status: ${(_uiStops[index]['school'] as School).isHighRisk ? 'High Risk' : 'Normal'}",style: TextStyle(color:(_uiStops[index]['school'] as School).isHighRisk? Colors.red: Colors.green,),),],),isThreeLine:true, // Needed for multiple subtitle linestrailing: Row(mainAxisSize: MainAxisSize.min,children: [// P1: Tampilan Estimasi Waktu (ETA)Container(padding: const EdgeInsets.symmetric(horizontal: 8,vertical: 4,),decoration: BoxDecoration(color: Colors.blue[50],borderRadius: BorderRadius.circular(5),border: Border.all(color: Colors.blue.shade200,),),child: Column(mainAxisAlignment: MainAxisAlignment.center,children: [const Text("Est. Tiba",style: TextStyle(fontSize: 8),),Text(_formatTime(_uiStops[index]['eta'].toString(),), // Using the fixed formatterstyle: const TextStyle(fontSize: 14,fontWeight: FontWeight.bold,color: Colors.blue,),),],),),const SizedBox(width: 10),// Tombol Hapus Sekolah dari RuteIconButton(icon: const Icon(Icons.remove_circle,color: Colors.red,),onPressed: () => _removeSchool(index),),// Handle Dragconst Icon(Icons.drag_handle,color: Colors.grey,),],),),),],),),],),// TOMBOL TAMBAH SEKOLAHfloatingActionButton: Column(mainAxisSize: MainAxisSize.min,children: [if (!_isLoading)FloatingActionButton.extended(heroTag: "recalculate",onPressed: _recalculateAndSave, // <--- P3label: const Text("HITUNG ULANG RUTE"),icon: const Icon(Icons.cached),backgroundColor: Colors.redAccent, // Make it urgentforegroundColor: Colors.white,),const SizedBox(height: 10),FloatingActionButton.extended(heroTag: "addschool",onPressed: _addSchoolDialog,label: const Text("Tambah Sekolah"),icon: const Icon(Icons.add_location),backgroundColor: Colors.orange[800],foregroundColor: Colors.white,),],),);}}

=== FILE: lib/features/admin_sppg/screens/create_route_screen.dart ===
import 'package:flutter/material.dart';import 'package:intl/intl.dart';import '../../../models/school_model.dart';import '../../../models/vehicle_model.dart';import '../../../models/courier_model.dart';import '../../../models/menu_model.dart';import '../services/school_service.dart';import '../services/vehicle_service.dart';import '../services/courier_service.dart';import '../services/menu_service.dart';import '../services/route_service.dart';class CreateRouteScreen extends StatefulWidget {const CreateRouteScreen({super.key});@overrideState<CreateRouteScreen> createState() => _CreateRouteScreenState();}class _CreateRouteScreenState extends State<CreateRouteScreen> {final _formKey = GlobalKey<FormState>();List<School> _schools = [];List<Vehicle> _vehicles = [];List<CourierModel> _couriers = [];List<Menu> _menus = [];DateTime _selectedDate = DateTime.now();List<String> _selectedVehicleIds = []; // [REVISI] Multi MobilString? _selectedCourierId;String? _selectedMenuId;final List<School> _selectedSchools = [];bool _isLoading = true;bool _isSubmitting = false;@overridevoid initState() {super.initState();_loadData();}Future<void> _loadData() async {try {final results = await Future.wait([SchoolService().getMySchools(),VehicleService().getMyVehicles(),CourierService().getMyCouriers(),MenuService().getMyMenus(),]);setState(() {_schools = results[0] as List<School>;_vehicles = results[1] as List<Vehicle>;_couriers = results[2] as List<CourierModel>;_menus = results[3] as List<Menu>;_isLoading = false;});} catch (e) {setState(() => _isLoading = false);}}Future<void> _submit() async {if (_formKey.currentState!.validate()) {if (_selectedSchools.isEmpty) {ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Pilih minimal 1 sekolah")));return;}if (_selectedVehicleIds.isEmpty) {ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Pilih minimal 1 mobil")));return;}if (_selectedSchools.length < _selectedVehicleIds.length) {ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Jumlah sekolah lebih sedikit dari mobil!")));return;}setState(() => _isSubmitting = true);try {final menu = _menus.firstWhere((m) => m.id == _selectedMenuId);await RouteService().createBatchRoutes(vehicleIds: _selectedVehicleIds,courierId: _selectedCourierId!,menuId: _selectedMenuId!,date: _selectedDate,selectedSchools: _selectedSchools,cookingDuration: menu.cookingDurationMinutes,);if (!mounted) return;Navigator.pop(context, true);ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Rute & Jadwal Otomatis Terbuat!")));} catch (e) {ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Error: $e")));} finally {setState(() => _isSubmitting = false);}}}@overrideWidget build(BuildContext context) {return Scaffold(appBar: AppBar(title: const Text("Buat Rute Otomatis"), backgroundColor: Colors.orange[800]),body: _isLoading? const Center(child: CircularProgressIndicator()): SingleChildScrollView(padding: const EdgeInsets.all(16),child: Form(key: _formKey,child: Column(crossAxisAlignment: CrossAxisAlignment.start,children: [// 1. TANGGALListTile(title: Text("Tanggal: ${DateFormat('dd MMM yyyy').format(_selectedDate)}"),trailing: const Icon(Icons.calendar_today),onTap: () async {final d = await showDatePicker(context: context, initialDate: _selectedDate, firstDate: DateTime.now(), lastDate: DateTime(2030));if (d != null) setState(() => _selectedDate = d);},),const SizedBox(height: 10),// 2. MENU (Wajib)DropdownButtonFormField<String>(decoration: const InputDecoration(labelText: "Menu (Hitung Masak Otomatis)", border: OutlineInputBorder()),items: _menus.map((m) => DropdownMenuItem(value: m.id, child: Text("${m.name} (${m.cookingDurationMinutes} mnt)"))).toList(),onChanged: (v) => setState(() => _selectedMenuId = v),validator: (v) => v == null ? "Wajib pilih menu" : null,),const SizedBox(height: 15),// 3. PILIH KURIRDropdownButtonFormField(decoration: const InputDecoration(labelText: "Kurir Penanggung Jawab", border: OutlineInputBorder()),items: _couriers.map((c) => DropdownMenuItem(value: c.id, child: Text(c.name))).toList(),onChanged: (v) => _selectedCourierId = v,validator: (v) => v == null ? "Pilih Kurir" : null,),const SizedBox(height: 15),// 4. PILIH MOBIL (MULTI SELECT)const Text("Pilih Armada (Bisa Lebih dari 1):", style: TextStyle(fontWeight: FontWeight.bold)),Container(height: 150,decoration: BoxDecoration(border: Border.all(color: Colors.grey), borderRadius: BorderRadius.circular(5)),child: ListView.builder(itemCount: _vehicles.length,itemBuilder: (ctx, i) {final v = _vehicles[i];final isSelected = _selectedVehicleIds.contains(v.id);return CheckboxListTile(title: Text(v.plateNumber),subtitle: Text(v.driverName ?? '-'),value: isSelected,onChanged: (val) {setState(() {if (val!) _selectedVehicleIds.add(v.id);else _selectedVehicleIds.remove(v.id);});},);},),),const SizedBox(height: 5),Text("${_selectedVehicleIds.length} Mobil Dipilih. Sistem akan membagi sekolah secara otomatis.", style: const TextStyle(fontSize: 12, color: Colors.blue)),const SizedBox(height: 20),const Divider(),// 5. PILIH SEKOLAHconst Text("Pilih Sekolah Tujuan:", style: TextStyle(fontWeight: FontWeight.bold)),ListView.builder(shrinkWrap: true,physics: const NeverScrollableScrollPhysics(),itemCount: _schools.length,itemBuilder: (ctx, i) {final s = _schools[i];final isSelected = _selectedSchools.any((e) => e.id == s.id);return CheckboxListTile(title: Text(s.name),subtitle: Text("${s.studentCount} Pax (Deadline: ${s.deadlineTime ?? '12:00'})"),value: isSelected,onChanged: (val) {setState(() {if (val!) _selectedSchools.add(s);else _selectedSchools.removeWhere((e) => e.id == s.id);});},);},),const SizedBox(height: 30),SizedBox(width: double.infinity,child: ElevatedButton(onPressed: _isSubmitting ? null : _submit,style: ElevatedButton.styleFrom(backgroundColor: Colors.green, padding: const EdgeInsets.all(15)),child: _isSubmitting? const CircularProgressIndicator(color: Colors.white): const Text("GENERATE BATCH RUTE", style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold)),),)],),),),);}}

=== FILE: lib/features/admin_sppg/screens/edit_account_screen.dart ===
import 'package:flutter/material.dart';import 'package:supabase_flutter/supabase_flutter.dart';import '../services/coordinator_service.dart';import '../services/teacher_service.dart';import '../services/courier_service.dart';import '../services/school_service.dart';import '../../../models/school_model.dart';class EditAccountScreen extends StatefulWidget {final String userId;final String initialRole;final Map<String, dynamic> initialData;const EditAccountScreen({super.key,required this.userId,required this.initialRole,required this.initialData,});@overrideState<EditAccountScreen> createState() => _EditAccountScreenState();}class _EditAccountScreenState extends State<EditAccountScreen> {final _formKey = GlobalKey<FormState>();late final TextEditingController _nameController;late final TextEditingController _emailController;late final TextEditingController _classController;List<School> _schools = [];String? _selectedSchoolId;bool _isLoading = true;bool _isSubmitting = false;@overridevoid initState() {super.initState();_nameController = TextEditingController(text: widget.initialData['name']);_emailController = TextEditingController(text: widget.initialData['email']);_classController = TextEditingController(text: widget.initialData['className'],);_selectedSchoolId = widget.initialData['schoolId'];_fetchSchools();}Future<void> _fetchSchools() async {try {final data = await SchoolService().getMySchools();if (!mounted) return;setState(() {_schools = data;_isLoading = false;});} catch (e) {if (!mounted) return;ScaffoldMessenger.of(context,).showSnackBar(SnackBar(content: Text("Error loading schools: $e")));setState(() => _isLoading = false);}}Future<void> _submit() async {if (_formKey.currentState!.validate()) {setState(() => _isSubmitting = true);try {final Map<String, dynamic> data = {'full_name': _nameController.text.trim(),'email': _emailController.text.trim(),};if (widget.initialRole == 'koordinator' ||widget.initialRole == 'walikelas') {data['school_id'] = _selectedSchoolId;}if (widget.initialRole == 'walikelas') {data['class_name'] = _classController.text.trim();}// Panggil service yang sesuaiif (widget.initialRole == 'kurir') {await CourierService().updateCourierAccount(widget.userId, data);} else if (widget.initialRole == 'koordinator') {await CoordinatorService().updateCoordinatorAccount(widget.userId,data,);} else if (widget.initialRole == 'walikelas') {await TeacherService().updateTeacherAccount(widget.userId, data);}if (!mounted) return;ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Akun berhasil diperbarui!"),backgroundColor: Colors.green,),);Navigator.pop(context, true);} catch (e) {ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Error: $e"), backgroundColor: Colors.red),);} finally {if (mounted) setState(() => _isSubmitting = false);}}}@overridevoid dispose() {_nameController.dispose();_emailController.dispose();_classController.dispose();super.dispose();}@overrideWidget build(BuildContext context) {return Scaffold(appBar: AppBar(title: Text("Edit Akun ${widget.initialRole.toUpperCase()}"),backgroundColor: Colors.orange[800],foregroundColor: Colors.white,),body: _isLoading? const Center(child: CircularProgressIndicator()): SingleChildScrollView(padding: const EdgeInsets.all(16.0),child: Form(key: _formKey,child: Column(children: [TextFormField(controller: _nameController,decoration: const InputDecoration(labelText: "Nama Lengkap",prefixIcon: Icon(Icons.person),),validator: (v) => v!.isEmpty ? "Wajib diisi" : null,),const SizedBox(height: 15),TextFormField(controller: _emailController,decoration: const InputDecoration(labelText: "Email Login",prefixIcon: Icon(Icons.email),),keyboardType: TextInputType.emailAddress,validator: (v) => v!.isEmpty ? "Wajib diisi" : null,),const SizedBox(height: 15),// Field Khusus Koordinator & Wali Kelasif (widget.initialRole == 'koordinator' ||widget.initialRole == 'walikelas')DropdownButtonFormField<String>(decoration: const InputDecoration(labelText: "Tugaskan di Sekolah",prefixIcon: Icon(Icons.school),),value: _selectedSchoolId,items: _schools.map((school) {return DropdownMenuItem(value: school.id,child: Text(school.name,overflow: TextOverflow.ellipsis,),);}).toList(),onChanged: (val) =>setState(() => _selectedSchoolId = val),validator: (val) =>val == null ? "Wajib pilih sekolah" : null,),const SizedBox(height: 15),// Field Khusus Wali Kelasif (widget.initialRole == 'walikelas')TextFormField(controller: _classController,decoration: const InputDecoration(labelText: "Nama Kelas (Misal: 7A)",prefixIcon: Icon(Icons.class_),),validator: (v) => v!.isEmpty ? "Wajib diisi" : null,),const SizedBox(height: 30),SizedBox(width: double.infinity,child: ElevatedButton(onPressed: _isSubmitting ? null : _submit,style: ElevatedButton.styleFrom(backgroundColor: Colors.orange[800],padding: const EdgeInsets.symmetric(vertical: 15),),child: _isSubmitting? const CircularProgressIndicator(color: Colors.white,): const Text("SIMPAN PERUBAHAN",style: TextStyle(color: Colors.white,fontWeight: FontWeight.bold,),),),),],),),),);}}

=== FILE: lib/features/admin_sppg/screens/add_coordinator_screen.dart ===
import 'package:flutter/material.dart';import '../services/coordinator_service.dart';import '../services/school_service.dart'; // Butuh ini buat list sekolahimport '../../../models/school_model.dart';class AddCoordinatorScreen extends StatefulWidget {const AddCoordinatorScreen({super.key});@overrideState<AddCoordinatorScreen> createState() => _AddCoordinatorScreenState();}class _AddCoordinatorScreenState extends State<AddCoordinatorScreen> {final _formKey = GlobalKey<FormState>();final _nameController = TextEditingController();final _emailController = TextEditingController();final _passwordController = TextEditingController();// Servicefinal SchoolService _schoolService = SchoolService();List<School> _schools = [];String? _selectedSchoolId;bool _isSubmitting = false;@overridevoid initState() {super.initState();_fetchSchools();}Future<void> _fetchSchools() async {try {final data = await _schoolService.getMySchools();setState(() {_schools = data;});} catch (e) {// Handle error diam-diam atau snackbar}}Future<void> _submit() async {if (_formKey.currentState!.validate()) {setState(() => _isSubmitting = true);try {await CoordinatorService().createCoordinatorAccount(email: _emailController.text.trim(),password: _passwordController.text,fullName: _nameController.text.trim(),schoolId: _selectedSchoolId!,);if (!mounted) return;ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Akun Koordinator Berhasil Dibuat!"), backgroundColor: Colors.green),);Navigator.pop(context, true);} catch (e) {ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Error: $e"), backgroundColor: Colors.red));} finally {if (mounted) setState(() => _isSubmitting = false);}}}@overrideWidget build(BuildContext context) {return Scaffold(appBar: AppBar(title: const Text("Tambah Koordinator Sekolah"),backgroundColor: Colors.orange[800],foregroundColor: Colors.white,),body: Padding(padding: const EdgeInsets.all(16.0),child: Form(key: _formKey,child: Column(children: [TextFormField(controller: _nameController,decoration: const InputDecoration(labelText: "Nama Koordinator", border: OutlineInputBorder(), prefixIcon: Icon(Icons.person)),validator: (v) => v!.isEmpty ? "Wajib diisi" : null,),const SizedBox(height: 15),// DROPDOWN PILIH SEKOLAHDropdownButtonFormField<String>(decoration: const InputDecoration(labelText: "Tugaskan di Sekolah", border: OutlineInputBorder(), prefixIcon: Icon(Icons.school)),value: _selectedSchoolId,items: _schools.map((school) {return DropdownMenuItem(value: school.id,child: Text(school.name, overflow: TextOverflow.ellipsis),);}).toList(),onChanged: (val) => setState(() => _selectedSchoolId = val),validator: (val) => val == null ? "Wajib pilih sekolah" : null,),const SizedBox(height: 15),TextFormField(controller: _emailController,decoration: const InputDecoration(labelText: "Email Login", border: OutlineInputBorder(), prefixIcon: Icon(Icons.email)),keyboardType: TextInputType.emailAddress,validator: (v) => v!.isEmpty ? "Wajib diisi" : null,),const SizedBox(height: 15),TextFormField(controller: _passwordController,obscureText: true,decoration: const InputDecoration(labelText: "Password", border: OutlineInputBorder(), prefixIcon: Icon(Icons.lock)),validator: (v) => v!.length < 6 ? "Minimal 6 karakter" : null,),const SizedBox(height: 30),SizedBox(width: double.infinity,child: ElevatedButton(onPressed: _isSubmitting ? null : _submit,style: ElevatedButton.styleFrom(backgroundColor: Colors.orange[800], padding: const EdgeInsets.symmetric(vertical: 15)),child: _isSubmitting? const CircularProgressIndicator(color: Colors.white): const Text("BUAT AKUN KOORDINATOR", style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold)),),)],),),),);}}

=== FILE: lib/features/admin_sppg/screens/add_school_screen.dart ===
import 'package:flutter/material.dart';import 'package:latlong2/latlong.dart';import '../../pengawas/screens/location_picker_screen.dart';import '../services/school_service.dart';import '../../../models/school_model.dart'; // Import Model Sekolahclass AddSchoolScreen extends StatefulWidget {final School? schoolToEdit; // Data sekolah (Kalau null = Mode Tambah)const AddSchoolScreen({super.key, this.schoolToEdit});@overrideState<AddSchoolScreen> createState() => _AddSchoolScreenState();}class _AddSchoolScreenState extends State<AddSchoolScreen> {final _formKey = GlobalKey<FormState>();// --- Controllers ---final TextEditingController _nameController = TextEditingController();final TextEditingController _addressController = TextEditingController();final TextEditingController _studentCountController = TextEditingController();final TextEditingController _serviceTimeController = TextEditingController(text: "10");// Controller VRPfinal TextEditingController _toleranceController = TextEditingController(text: "45");final TextEditingController _menuDefaultController = TextEditingController();final TextEditingController _latController = TextEditingController();final TextEditingController _longController = TextEditingController();// --- State Variables ---bool _isHighRisk = false;TimeOfDay? _deadlineTime;bool _isSubmitting = false;@overridevoid initState() {super.initState();// [LOGIKA EDIT]: Kalau ada data schoolToEdit, isi form-nyaif (widget.schoolToEdit != null) {final s = widget.schoolToEdit!;_nameController.text = s.name;_addressController.text = s.address ?? '';_studentCountController.text = s.studentCount.toString();_serviceTimeController.text = s.serviceTimeMinutes.toString();_toleranceController.text = s.toleranceMinutes.toString();_menuDefaultController.text = s.menuDefault ?? '';_isHighRisk = s.isHighRisk;if (s.latitude != null) _latController.text = s.latitude.toString();if (s.longitude != null) _longController.text = s.longitude.toString();// Parsing Jam (String "12:00:00" -> TimeOfDay)if (s.deadlineTime != null) {final parts = s.deadlineTime!.split(':');_deadlineTime = TimeOfDay(hour: int.parse(parts[0]), minute: int.parse(parts[1]));}}}// --- 1. Fungsi Pilih Jam ---Future<void> _pickTime() async {final TimeOfDay? picked = await showTimePicker(context: context,initialTime: _deadlineTime ?? const TimeOfDay(hour: 12, minute: 0),);if (picked != null) {setState(() => _deadlineTime = picked);}}// --- 2. Fungsi Buka Peta ---Future<void> _openMapPicker() async {double initialLat = double.tryParse(_latController.text) ?? -6.9175;double initialLong = double.tryParse(_longController.text) ?? 107.6191;final LatLng? result = await Navigator.push(context,MaterialPageRoute(builder: (context) => LocationPickerScreen(initialLat: initialLat,initialLong: initialLong,),),);if (result != null) {setState(() {_latController.text = result.latitude.toString();_longController.text = result.longitude.toString();});ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Lokasi Sekolah terpilih!")),);}}// --- 3. Submit ke Database (Bisa Create atau Update) ---Future<void> _submitForm() async {if (_formKey.currentState!.validate()) {if (_deadlineTime == null) {ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Harap tentukan Jam Deadline Pengiriman!")),);return;}setState(() => _isSubmitting = true);try {final String formattedTime ="${_deadlineTime!.hour.toString().padLeft(2, '0')}:${_deadlineTime!.minute.toString().padLeft(2, '0')}:00";final Map<String, dynamic> data = {'name': _nameController.text,'address': _addressController.text,'student_count': int.parse(_studentCountController.text),'service_time_minutes': int.parse(_serviceTimeController.text),'deadline_time': formattedTime,'is_high_risk': _isHighRisk,'gps_lat': double.tryParse(_latController.text),'gps_long': double.tryParse(_longController.text),'tolerance_minutes': int.parse(_toleranceController.text),'menu_default': _menuDefaultController.text,};if (widget.schoolToEdit == null) {// Mode TAMBAHawait SchoolService().createSchool(data);} else {// Mode EDITawait SchoolService().updateSchool(widget.schoolToEdit!.id, data);}if (!mounted) return;ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Data Sekolah berhasil ${widget.schoolToEdit == null ? 'ditambahkan' : 'diperbarui'}!"),backgroundColor: Colors.green),);Navigator.pop(context, true);} catch (e) {ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Gagal: $e"), backgroundColor: Colors.red),);} finally {if (mounted) setState(() => _isSubmitting = false);}}}@overridevoid dispose() {_nameController.dispose();_addressController.dispose();_studentCountController.dispose();_serviceTimeController.dispose();_toleranceController.dispose();_menuDefaultController.dispose();_latController.dispose();_longController.dispose();super.dispose();}@overrideWidget build(BuildContext context) {final isEdit = widget.schoolToEdit != null;return Scaffold(appBar: AppBar(title: Text(isEdit ? "Edit Sekolah" : "Tambah Sekolah"),backgroundColor: Colors.orange[800],foregroundColor: Colors.white,),body: SingleChildScrollView(padding: const EdgeInsets.all(16),child: Form(key: _formKey,child: Column(crossAxisAlignment: CrossAxisAlignment.start,children: [const Text("Data Umum", style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold)),const SizedBox(height: 15),// Nama SekolahTextFormField(controller: _nameController, decoration: const InputDecoration(labelText: "Nama Lokasi Penerima", prefixIcon: Icon(Icons.school)), validator: (v) => v!.isEmpty ? "Wajib diisi" : null),const SizedBox(height: 15),// Alamat TeksTextFormField(controller: _addressController, maxLines: 2, decoration: const InputDecoration(labelText: "Alamat Lengkap", prefixIcon: Icon(Icons.home))),const SizedBox(height: 15),// Jumlah Siswa & Service TimeRow(children: [Expanded(child: TextFormField(controller: _studentCountController,keyboardType: TextInputType.number,decoration: const InputDecoration(labelText: "Jml Penerima", prefixIcon: Icon(Icons.people)),validator: (v) => v!.isEmpty ? "Wajib" : null,),),const SizedBox(width: 10),Expanded(child: TextFormField(controller: _serviceTimeController,keyboardType: TextInputType.number,decoration: const InputDecoration(labelText: "Waktu Service (Menit)", prefixIcon: Icon(Icons.timer)),validator: (v) => v!.isEmpty ? "Wajib" : null,),),],),const SizedBox(height: 25),const Divider(thickness: 2),// --- BAGIAN CONSTRAINTS VRP ---const Text("Batasan Waktu (VRP Constraints)", style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold)),const SizedBox(height: 15),// Deadline PickerInkWell(onTap: _pickTime,child: InputDecorator(decoration: const InputDecoration(labelText: "Deadline Konsumsi", border: OutlineInputBorder(), prefixIcon: Icon(Icons.access_time)),child: Text(_deadlineTime == null ? "Pilih Jam..." : "${_deadlineTime!.hour.toString().padLeft(2, '0')}:${_deadlineTime!.minute.toString().padLeft(2, '0')}",style: TextStyle(color: _deadlineTime == null ? Colors.grey : Colors.black, fontSize: 16),),),),const SizedBox(height: 15),// ToleransiTextFormField(controller: _toleranceController,keyboardType: TextInputType.number,decoration: const InputDecoration(labelText: "Toleransi Awal (Menit)", hintText: "45", prefixIcon: Icon(Icons.fast_forward)),validator: (v) => v!.isEmpty ? "Wajib" : null,),const SizedBox(height: 15),// Menu DefaultTextFormField(controller: _menuDefaultController,decoration: const InputDecoration(labelText: "Menu Default", hintText: "Nasi, Ayam", prefixIcon: Icon(Icons.restaurant_menu)),),const SizedBox(height: 15),// High RiskSwitchListTile(title: const Text("Status High Risk"),value: _isHighRisk,activeColor: Colors.red,onChanged: (val) => setState(() => _isHighRisk = val),contentPadding: EdgeInsets.zero,),const Divider(thickness: 2),const SizedBox(height: 10),// --- BAGIAN LOKASI MAP ---Row(mainAxisAlignment: MainAxisAlignment.spaceBetween,children: [const Text("Titik GPS", style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold)),ElevatedButton.icon(onPressed: _openMapPicker,icon: const Icon(Icons.map, size: 18),label: const Text("Buka Peta"),style: ElevatedButton.styleFrom(backgroundColor: Colors.orange[700], foregroundColor: Colors.white),),],),const SizedBox(height: 10),Row(children: [Expanded(child: TextFormField(controller: _latController, decoration: const InputDecoration(labelText: "Lat", hintText: "Wajib dari Peta"), readOnly: true)),const SizedBox(width: 10),Expanded(child: TextFormField(controller: _longController, decoration: const InputDecoration(labelText: "Long", hintText: "Wajib dari Peta"), readOnly: true)),],),const SizedBox(height: 30),SizedBox(width: double.infinity,child: ElevatedButton(onPressed: _isSubmitting ? null : _submitForm,style: ElevatedButton.styleFrom(backgroundColor: Colors.orange[800], padding: const EdgeInsets.symmetric(vertical: 15)),child: _isSubmitting? const CircularProgressIndicator(color: Colors.white): Text(isEdit ? "SIMPAN PERUBAHAN" : "SIMPAN DATA BARU", style: const TextStyle(color: Colors.white, fontWeight: FontWeight.bold)),),),const SizedBox(height: 20),],),),),);}}

=== FILE: lib/features/admin_sppg/screens/add_courier_screen.dart ===
import 'package:flutter/material.dart';import '../services/courier_service.dart';class AddCourierScreen extends StatefulWidget {const AddCourierScreen({super.key});@overrideState<AddCourierScreen> createState() => _AddCourierScreenState();}class _AddCourierScreenState extends State<AddCourierScreen> {final _formKey = GlobalKey<FormState>();final _nameController = TextEditingController();final _emailController = TextEditingController();final _passwordController = TextEditingController();bool _isSubmitting = false;@overridevoid dispose() {_nameController.dispose();_emailController.dispose();_passwordController.dispose();super.dispose();}Future<void> _submit() async {if (_formKey.currentState!.validate()) {setState(() => _isSubmitting = true);try {await CourierService().createCourierAccount(email: _emailController.text.trim(), // TRIM untuk emailpassword: _passwordController.text,fullName: _nameController.text.trim(), // TRIM untuk nama);if (!mounted) return;ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Akun Kurir Berhasil Dibuat!"), backgroundColor: Colors.green),);Navigator.pop(context, true); // Sukses} catch (e) {if (!mounted) return;ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Error: $e"), backgroundColor: Colors.red));} finally {if (mounted) setState(() => _isSubmitting = false);}}}@overrideWidget build(BuildContext context) {return Scaffold(appBar: AppBar(title: const Text("Tambah Akun Kurir"),backgroundColor: Colors.orange[800],foregroundColor: Colors.white,),body: Padding(padding: const EdgeInsets.all(16.0),child: Form(key: _formKey,child: Column(children: [TextFormField(controller: _nameController,decoration: const InputDecoration(labelText: "Nama Lengkap Kurir", border: OutlineInputBorder(), prefixIcon: Icon(Icons.person)),validator: (v) => v!.isEmpty ? "Wajib diisi" : null,),const SizedBox(height: 15),TextFormField(controller: _emailController,decoration: const InputDecoration(labelText: "Email Login", border: OutlineInputBorder(), prefixIcon: Icon(Icons.email)),keyboardType: TextInputType.emailAddress,validator: (v) => v!.isEmpty ? "Wajib diisi" : null,),const SizedBox(height: 15),TextFormField(controller: _passwordController,obscureText: true,decoration: const InputDecoration(labelText: "Password", border: OutlineInputBorder(), prefixIcon: Icon(Icons.lock)),validator: (v) => v!.length < 6 ? "Minimal 6 karakter" : null,),const SizedBox(height: 30),SizedBox(width: double.infinity,child: ElevatedButton(onPressed: _isSubmitting ? null : _submit,style: ElevatedButton.styleFrom(backgroundColor: Colors.orange[800], padding: const EdgeInsets.symmetric(vertical: 15)),child: _isSubmitting? const CircularProgressIndicator(color: Colors.white): const Text("BUAT AKUN KURIR", style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold)),),)],),),),);}}

=== FILE: lib/features/admin_sppg/screens/add_teacher_screen.dart ===
import 'package:flutter/material.dart';import '../services/teacher_service.dart';import '../services/school_service.dart';import '../../../models/school_model.dart';class AddTeacherScreen extends StatefulWidget {const AddTeacherScreen({super.key});@overrideState<AddTeacherScreen> createState() => _AddTeacherScreenState();}class _AddTeacherScreenState extends State<AddTeacherScreen> {final _formKey = GlobalKey<FormState>();final _nameController = TextEditingController();final _classController = TextEditingController(); // Input Nama Kelasfinal _emailController = TextEditingController();final _passwordController = TextEditingController();final SchoolService _schoolService = SchoolService();List<School> _schools = [];String? _selectedSchoolId;bool _isSubmitting = false;@overridevoid initState() {super.initState();_fetchSchools();}Future<void> _fetchSchools() async {try {final data = await _schoolService.getMySchools();setState(() => _schools = data);} catch (e) { }}Future<void> _submit() async {if (_formKey.currentState!.validate()) {setState(() => _isSubmitting = true);try {await TeacherService().createTeacherAccount(email: _emailController.text.trim(),password: _passwordController.text,fullName: _nameController.text.trim(),schoolId: _selectedSchoolId!,className: _classController.text.trim(),);if (!mounted) return;ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Akun Wali Kelas Berhasil Dibuat!"), backgroundColor: Colors.green),);Navigator.pop(context, true);} catch (e) {ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Error: $e"), backgroundColor: Colors.red));} finally {if (mounted) setState(() => _isSubmitting = false);}}}@overrideWidget build(BuildContext context) {return Scaffold(appBar: AppBar(title: const Text("Tambah Akun Wali Kelas"),backgroundColor: Colors.orange[800],foregroundColor: Colors.white,),body: Padding(padding: const EdgeInsets.all(16.0),child: Form(key: _formKey,child: SingleChildScrollView(child: Column(children: [DropdownButtonFormField<String>(decoration: const InputDecoration(labelText: "Pilih Sekolah", border: OutlineInputBorder(), prefixIcon: Icon(Icons.school)),value: _selectedSchoolId,items: _schools.map((school) {return DropdownMenuItem(value: school.id, child: Text(school.name, overflow: TextOverflow.ellipsis));}).toList(),onChanged: (val) => setState(() => _selectedSchoolId = val),validator: (val) => val == null ? "Wajib pilih sekolah" : null,),const SizedBox(height: 15),TextFormField(controller: _nameController,decoration: const InputDecoration(labelText: "Nama Guru / Penanggung Jawab", border: OutlineInputBorder(), prefixIcon: Icon(Icons.person)),validator: (v) => v!.isEmpty ? "Wajib diisi" : null,),const SizedBox(height: 15),TextFormField(controller: _classController,decoration: const InputDecoration(labelText: "Nama Kelas (Misal: 7A)", border: OutlineInputBorder(), prefixIcon: Icon(Icons.class_)),validator: (v) => v!.isEmpty ? "Wajib diisi" : null,),const SizedBox(height: 15),TextFormField(controller: _emailController,decoration: const InputDecoration(labelText: "Email Login", border: OutlineInputBorder(), prefixIcon: Icon(Icons.email)),keyboardType: TextInputType.emailAddress,validator: (v) => v!.isEmpty ? "Wajib diisi" : null,),const SizedBox(height: 15),TextFormField(controller: _passwordController,obscureText: true,decoration: const InputDecoration(labelText: "Password", border: OutlineInputBorder(), prefixIcon: Icon(Icons.lock)),validator: (v) => v!.length < 6 ? "Minimal 6 karakter" : null,),const SizedBox(height: 30),SizedBox(width: double.infinity,child: ElevatedButton(onPressed: _isSubmitting ? null : _submit,style: ElevatedButton.styleFrom(backgroundColor: Colors.orange[800], padding: const EdgeInsets.symmetric(vertical: 15)),child: _isSubmitting? const CircularProgressIndicator(color: Colors.white): const Text("BUAT AKUN WALI KELAS", style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold)),),)],),),),),);}}

=== FILE: lib/features/admin_sppg/screens/admin_request_list_screen.dart ===
import 'package:flutter/material.dart';import '../../shared/services/request_service.dart';class AdminRequestListScreen extends StatefulWidget {const AdminRequestListScreen({super.key});@overrideState<AdminRequestListScreen> createState() => _AdminRequestListScreenState();}class _AdminRequestListScreenState extends State<AdminRequestListScreen> {final RequestService _service = RequestService();void _showRespondDialog(String id) {final responseController = TextEditingController();showDialog(context: context,builder: (ctx) => AlertDialog(title: const Text("Respon Pengajuan"),content: TextField(controller: responseController,decoration: const InputDecoration(labelText: "Alasan / Catatan",border: OutlineInputBorder(),),),actions: [TextButton(onPressed: () async {await _service.respondRequest(id,'rejected',responseController.text,);if (!mounted) return;Navigator.pop(ctx);setState(() {});},child: const Text("TOLAK", style: TextStyle(color: Colors.red)),),ElevatedButton(onPressed: () async {await _service.respondRequest(id,'approved',responseController.text,);if (!mounted) return;Navigator.pop(ctx);setState(() {});},child: const Text("TERIMA"),),],),);}@overrideWidget build(BuildContext context) {return Scaffold(appBar: AppBar(title: const Text("Kotak Masuk Pengajuan"),backgroundColor: Colors.orange[800],foregroundColor: Colors.white,),body: FutureBuilder<List<ChangeRequestModel>>(future: _service.getIncomingRequests(),builder: (context, snapshot) {if (snapshot.connectionState == ConnectionState.waiting)return const Center(child: CircularProgressIndicator());final data = snapshot.data ?? [];if (data.isEmpty)return const Center(child: Text("Tidak ada pengajuan baru."));return ListView.builder(itemCount: data.length,itemBuilder: (ctx, i) {final item = data[i];return Card(margin: const EdgeInsets.all(8),child: ListTile(leading: const Icon(Icons.mail, color: Colors.orange),title: Text(item.schoolName),subtitle: Column(crossAxisAlignment: CrossAxisAlignment.start,children: [Text("[${item.type}] ${item.requestDate}",style: const TextStyle(fontWeight: FontWeight.bold),),Text(item.oldNotes),if (item.status != 'pending')Text("Status: ${item.status} (${item.adminResponse})",style: const TextStyle(color: Colors.grey),),],),trailing: item.status == 'pending'? ElevatedButton(onPressed: () => _showRespondDialog(item.id),child: const Text("Jawab"),): const Icon(Icons.check, color: Colors.green),),);},);},),);}}

=== FILE: lib/features/admin_sppg/screens/add_menu_screen.dart ===
import 'package:flutter/material.dart';import '../../../models/menu_model.dart';import '../services/menu_service.dart';class AddMenuScreen extends StatefulWidget {final Menu? menuToEdit; // Jika ini diisi, berarti mode Editconst AddMenuScreen({super.key, this.menuToEdit});@overrideState<AddMenuScreen> createState() => _AddMenuScreenState();}class _AddMenuScreenState extends State<AddMenuScreen> {final _formKey = GlobalKey<FormState>();final MenuService _menuService = MenuService();// Controllersfinal TextEditingController _nameController = TextEditingController();final TextEditingController _durationController = TextEditingController();// Daftar Kategori Tetap (Untuk Dropdown)final List<String> _categories = ['Nasi/Karbo', 'Lauk Protein', 'Sayur/Serat', 'Pelengkap'];String? _selectedCategory;bool _isSubmitting = false;@overridevoid initState() {super.initState();if (widget.menuToEdit != null) {// Mode Edit: Isi form dengan data yang sudah ada_nameController.text = widget.menuToEdit!.name;_durationController.text = widget.menuToEdit!.cookingDurationMinutes.toString();_selectedCategory = widget.menuToEdit!.category;}}@overridevoid dispose() {_nameController.dispose();_durationController.dispose();super.dispose();}Future<void> _submitForm() async {if (_formKey.currentState!.validate() && _selectedCategory != null) {setState(() => _isSubmitting = true);final Map<String, dynamic> menuData = {'name': _nameController.text,'category': _selectedCategory,'cooking_duration_minutes': int.tryParse(_durationController.text) ?? 0,};try {if (widget.menuToEdit == null) {// Mode Tambah (UC11)await _menuService.createMenu(menuData);} else {// Mode Edit (UC12)await _menuService.updateMenu(widget.menuToEdit!.id, menuData);}if (!mounted) return;ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Menu berhasil ${widget.menuToEdit == null ? 'ditambahkan' : 'diperbarui'}!"),backgroundColor: Colors.green,),);Navigator.pop(context, true); // Balik dan kirim sinyal sukses} catch (e) {ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Gagal: $e"), backgroundColor: Colors.red));} finally {if (mounted) setState(() => _isSubmitting = false);}} else {if (_selectedCategory == null) {ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Kategori wajib dipilih!")));}}}@overrideWidget build(BuildContext context) {return Scaffold(appBar: AppBar(title: Text(widget.menuToEdit == null ? "Tambah Menu Baru" : "Edit Menu"),backgroundColor: Colors.orange[800],foregroundColor: Colors.white,),body: Padding(padding: const EdgeInsets.all(16.0),child: Form(key: _formKey,child: Column(crossAxisAlignment: CrossAxisAlignment.start,children: [// Nama MakananTextFormField(controller: _nameController,decoration: const InputDecoration(labelText: "Nama Makanan", prefixIcon: Icon(Icons.food_bank)),validator: (v) => v!.isEmpty ? "Wajib diisi" : null,),const SizedBox(height: 15),// Dropdown KategoriDropdownButtonFormField<String>(decoration: const InputDecoration(labelText: "Kategori Menu", prefixIcon: Icon(Icons.category)),value: _selectedCategory,items: _categories.map((String value) {return DropdownMenuItem<String>(value: value,child: Text(value),);}).toList(),onChanged: (String? newValue) => setState(() => _selectedCategory = newValue),validator: (v) => v == null ? "Pilih kategori" : null,),const SizedBox(height: 15),// Estimasi Durasi MasakTextFormField(controller: _durationController,keyboardType: TextInputType.number,decoration: const InputDecoration(labelText: "Estimasi Durasi Masak (Menit)",hintText: "Contoh: 60",prefixIcon: Icon(Icons.timer),),validator: (v) => v!.isEmpty ? "Wajib diisi" : null,),const SizedBox(height: 30),// Tombol SimpanSizedBox(width: double.infinity,child: ElevatedButton(onPressed: _isSubmitting ? null : _submitForm,style: ElevatedButton.styleFrom(backgroundColor: Colors.green[700],padding: const EdgeInsets.symmetric(vertical: 15)),child: _isSubmitting? const CircularProgressIndicator(color: Colors.white): Text(widget.menuToEdit == null ? "SIMPAN MENU" : "SIMPAN PERUBAHAN",style: const TextStyle(color: Colors.white, fontWeight: FontWeight.bold)),),),],),),),);}}

=== FILE: lib/features/admin_sppg/screens/add_transport_screen.dart ===
import 'package:flutter/material.dart';import '../services/vehicle_service.dart';import '../../../models/vehicle_model.dart'; // Import Modelclass AddTransportScreen extends StatefulWidget {final Vehicle? vehicleToEdit; // Data untuk dieditconst AddTransportScreen({super.key, this.vehicleToEdit});@overrideState<AddTransportScreen> createState() => _AddTransportScreenState();}class _AddTransportScreenState extends State<AddTransportScreen> {final _formKey = GlobalKey<FormState>();final TextEditingController _plateController = TextEditingController();final TextEditingController _driverController = TextEditingController();final TextEditingController _capacityController = TextEditingController();bool _isSubmitting = false;@overridevoid initState() {super.initState();// [LOGIKA EDIT] Isi form jika ada dataif (widget.vehicleToEdit != null) {_plateController.text = widget.vehicleToEdit!.plateNumber;_driverController.text = widget.vehicleToEdit!.driverName ?? '';_capacityController.text = widget.vehicleToEdit!.capacityLimit.toString();}}Future<void> _submit() async {if (_formKey.currentState!.validate()) {setState(() => _isSubmitting = true);final data = {'plate_number': _plateController.text,'driver_name': _driverController.text,'capacity_limit': int.parse(_capacityController.text),'is_active': true, // Default aktif};try {if (widget.vehicleToEdit == null) {// Mode Tambahawait VehicleService().createVehicle(data);} else {// Mode Editawait VehicleService().updateVehicle(widget.vehicleToEdit!.id, data);}if (!mounted) return;ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text(widget.vehicleToEdit == null ? "Berhasil ditambah!" : "Berhasil diperbarui!"),backgroundColor: Colors.green),);Navigator.pop(context, true); // Sukses} catch (e) {ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Error: $e")));} finally {if (mounted) setState(() => _isSubmitting = false);}}}@overrideWidget build(BuildContext context) {return Scaffold(appBar: AppBar(title: Text(widget.vehicleToEdit == null ? "Tambah Transportasi" : "Edit Transportasi"),backgroundColor: Colors.orange[800],foregroundColor: Colors.white,),body: Padding(padding: const EdgeInsets.all(16.0),child: Form(key: _formKey,child: Column(children: [TextFormField(controller: _plateController,decoration: const InputDecoration(labelText: "Plat Nomor", border: OutlineInputBorder()),validator: (v) => v!.isEmpty ? "Wajib diisi" : null,),const SizedBox(height: 15),TextFormField(controller: _driverController,decoration: const InputDecoration(labelText: "Nama Supir / Kurir", border: OutlineInputBorder()),validator: (v) => v!.isEmpty ? "Wajib diisi" : null,),const SizedBox(height: 15),TextFormField(controller: _capacityController,keyboardType: TextInputType.number,decoration: const InputDecoration(labelText: "Kapasitas Angkut (Box)", border: OutlineInputBorder()),validator: (v) => v!.isEmpty ? "Wajib diisi" : null,),const SizedBox(height: 30),SizedBox(width: double.infinity,child: ElevatedButton(onPressed: _isSubmitting ? null : _submit,style: ElevatedButton.styleFrom(backgroundColor: Colors.orange[800], padding: const EdgeInsets.symmetric(vertical: 15)),child: _isSubmitting? const CircularProgressIndicator(color: Colors.white): Text(widget.vehicleToEdit == null ? "SIMPAN" : "SIMPAN PERUBAHAN",style: const TextStyle(color: Colors.white, fontWeight: FontWeight.bold)),),)],),),),);}}

=== FILE: lib/features/admin_sppg/screens/statistics_screen.dart ===
import 'package:fl_chart/fl_chart.dart'; // Import Library Grafikimport 'package:flutter/material.dart';import '../services/stats_service.dart';class StatisticsScreen extends StatefulWidget {const StatisticsScreen({super.key});@overrideState<StatisticsScreen> createState() => _StatisticsScreenState();}class _StatisticsScreenState extends State<StatisticsScreen> {final StatsService _statsService = StatsService();Map<String, int>? _stats;bool _isLoading = true;@overridevoid initState() {super.initState();_loadStats();}Future<void> _loadStats() async {try {final data = await _statsService.getDeliveryStats();setState(() {_stats = data;_isLoading = false;});} catch (e) {setState(() => _isLoading = false);}}@overrideWidget build(BuildContext context) {return Scaffold(appBar: AppBar(title: const Text("Laporan Kinerja"),backgroundColor: Colors.indigo[800],foregroundColor: Colors.white,),body: _isLoading? const Center(child: CircularProgressIndicator()): _stats == null? const Center(child: Text("Gagal memuat data.")): Padding(padding: const EdgeInsets.all(16.0),child: Column(children: [const Text("Status Pengiriman Keseluruhan",style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold),),const SizedBox(height: 30),// --- GRAFIK LINGKARAN (PIE CHART) ---SizedBox(height: 250,child: PieChart(PieChartData(sectionsSpace: 2,centerSpaceRadius: 50,sections: [// Bagian Hijau (Sukses)PieChartSectionData(color: Colors.green,value: _stats!['received']!.toDouble(),title: '${_stats!['received']}',radius: 60,titleStyle: const TextStyle(fontSize: 16, fontWeight: FontWeight.bold, color: Colors.white),),// Bagian Merah (Masalah)PieChartSectionData(color: Colors.red,value: _stats!['issues']!.toDouble(),title: '${_stats!['issues']}',radius: 60,titleStyle: const TextStyle(fontSize: 16, fontWeight: FontWeight.bold, color: Colors.white),),// Bagian Abu (Pending)PieChartSectionData(color: Colors.grey,value: _stats!['pending']!.toDouble(),title: '${_stats!['pending']}',radius: 50,titleStyle: const TextStyle(fontSize: 14, fontWeight: FontWeight.bold, color: Colors.white),),],),),),const SizedBox(height: 30),// --- KETERANGAN (LEGEND) ---_buildLegend(Colors.green, "Sukses Diterima", _stats!['received']!),_buildLegend(Colors.red, "Ada Masalah/Komplain", _stats!['issues']!),_buildLegend(Colors.grey, "Dalam Proses", _stats!['pending']!),const Divider(height: 40),// Ringkasan TotalCard(color: Colors.indigo[50],child: ListTile(leading: const Icon(Icons.analytics, color: Colors.indigo),title: const Text("Total Aktivitas Pengiriman"),trailing: Text("${_stats!['total']}",style: const TextStyle(fontSize: 24, fontWeight: FontWeight.bold, color: Colors.indigo)),),)],),),);}Widget _buildLegend(Color color, String text, int value) {return Padding(padding: const EdgeInsets.symmetric(vertical: 8.0, horizontal: 20),child: Row(children: [Container(width: 16, height: 16, color: color),const SizedBox(width: 8),Text(text, style: const TextStyle(fontSize: 16)),const Spacer(),Text("$value", style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 16)),],),);}}

=== FILE: lib/features/admin_sppg/screens/dashboard_admin_screen.dart ===
import 'package:flutter/material.dart';import 'package:intl/intl.dart';// Import Auth & Loginimport '../../../features/autentikasi/services/auth_service.dart';import '../../../features/autentikasi/screens/login_screen.dart';// Import Modelimport '../../../models/school_model.dart';import '../../../models/vehicle_model.dart';import '../../../models/route_model.dart';import '../../../models/courier_model.dart';import '../services/coordinator_service.dart';import '../services/teacher_service.dart';// Import Servicesimport '../services/school_service.dart';import '../services/vehicle_service.dart';import '../services/courier_service.dart';import '../services/route_service.dart';// Import Forms & Screensimport 'add_school_screen.dart';import 'add_transport_screen.dart';import 'add_courier_screen.dart';import 'add_coordinator_screen.dart';import 'add_teacher_screen.dart';import 'create_route_screen.dart';import 'menu_management_screen.dart';import 'complaint_list_screen.dart';import 'statistics_screen.dart';import 'production_calendar_screen.dart';import '../../../core/screens/profile_screen.dart';import 'edit_account_screen.dart'; // Pastikan ini ada jika digunakan untuk edit userimport 'edit_route_screen.dart'; // [BARU] Import Screen Read Onlyclass DashboardAdminScreen extends StatefulWidget {const DashboardAdminScreen({super.key});@overrideState<DashboardAdminScreen> createState() => _DashboardAdminScreenState();}class _DashboardAdminScreenState extends State<DashboardAdminScreen> {int _selectedIndex = 0;// Inisialisasi Servicefinal SchoolService _schoolService = SchoolService();final VehicleService _vehicleService = VehicleService();final CourierService _courierService = CourierService();final CoordinatorService _coordinatorService = CoordinatorService();final TeacherService _teacherService = TeacherService();final RouteService _routeService = RouteService();Future<void> _logout() async {await AuthService().signOut();if (!mounted) return;Navigator.of(context).pushAndRemoveUntil(MaterialPageRoute(builder: (_) => const LoginScreen()),(route) => false,);}String _getAppBarTitle() {switch (_selectedIndex) {case 0:return "Kelola Sekolah";case 1:return "Kelola Armada";case 2:return "Kelola Kurir";case 3:return "Kelola Koordinator";case 4:return "Kelola Wali Kelas";case 5:return "Jadwal & Rute";default:return "Admin SPPG";}}String _getFabLabel() {switch (_selectedIndex) {case 0:return "Sekolah";case 1:return "Mobil";case 2:return "Kurir";case 3:return "Koord";case 4:return "Wali";case 5:return "Buat Rute";default:return "Tambah";}}@overrideWidget build(BuildContext context) {return Scaffold(appBar: AppBar(title: Text(_getAppBarTitle()),backgroundColor: Colors.orange[800],foregroundColor: Colors.white,actions: [IconButton(icon: const Icon(Icons.calendar_month),tooltip: "Kalender Produksi",onPressed: () {Navigator.push(context,MaterialPageRoute(builder: (_) => const ProductionCalendarScreen(),),);},),IconButton(icon: const Icon(Icons.notification_important,color: Colors.redAccent,),tooltip: "Laporan Pengaduan",onPressed: () {Navigator.push(context,MaterialPageRoute(builder: (_) => const ComplaintListScreen()),);},),IconButton(icon: const Icon(Icons.bar_chart),tooltip: "Laporan Kinerja",onPressed: () {Navigator.push(context,MaterialPageRoute(builder: (_) => const StatisticsScreen()),);},),IconButton(icon: const Icon(Icons.restaurant_menu),tooltip: "Manajemen Menu",onPressed: () {Navigator.push(context,MaterialPageRoute(builder: (_) => const MenuManagementScreen()),);},),IconButton(icon: const Icon(Icons.account_circle, size: 30),tooltip: "Profil Saya",onPressed: () {Navigator.push(context,MaterialPageRoute(builder: (_) => const ProfileScreen()),);},),],),body: IndexedStack(index: _selectedIndex,children: [_buildSchoolList(), // 0_buildTransportList(), // 1_buildCourierList(), // 2_buildCoordinatorList(), // 3_buildTeacherList(), // 4_buildRouteList(), // 5],),floatingActionButton: FloatingActionButton.extended(backgroundColor: Colors.orange[800],foregroundColor: Colors.white,icon: const Icon(Icons.add),label: Text(_getFabLabel()),onPressed: () {Widget nextPage;if (_selectedIndex == 0)nextPage = const AddSchoolScreen();else if (_selectedIndex == 1)nextPage = const AddTransportScreen();else if (_selectedIndex == 2)nextPage = const AddCourierScreen();else if (_selectedIndex == 3)nextPage = const AddCoordinatorScreen();else if (_selectedIndex == 4)nextPage = const AddTeacherScreen();elsenextPage = const CreateRouteScreen();Navigator.push(context,MaterialPageRoute(builder: (_) => nextPage),).then((val) {if (val == true) setState(() {});});},),bottomNavigationBar: BottomNavigationBar(currentIndex: _selectedIndex,type: BottomNavigationBarType.fixed,selectedItemColor: Colors.orange[800],unselectedItemColor: Colors.grey,onTap: (index) => setState(() => _selectedIndex = index),items: const [BottomNavigationBarItem(icon: Icon(Icons.school), label: "Sekolah"),BottomNavigationBarItem(icon: Icon(Icons.local_shipping),label: "Armada",),BottomNavigationBarItem(icon: Icon(Icons.person_pin_circle),label: "Kurir",),BottomNavigationBarItem(icon: Icon(Icons.supervisor_account),label: "Koord",),BottomNavigationBarItem(icon: Icon(Icons.class_), label: "Wali"),BottomNavigationBarItem(icon: Icon(Icons.map_outlined),label: "Rute",),],),);}// --- LIST BUILDERS (WITH RESTORED BUTTONS) ---// 0. SEKOLAH (UC25 Edit, UC26 Delete)Widget _buildSchoolList() {return FutureBuilder<List<School>>(future: _schoolService.getMySchools(),builder: (context, snapshot) {if (snapshot.connectionState == ConnectionState.waiting)return const Center(child: CircularProgressIndicator());final schools = snapshot.data ?? [];if (schools.isEmpty)return _buildEmptyState("Belum ada sekolah.", Icons.school_outlined);return ListView.builder(padding: const EdgeInsets.all(10),itemCount: schools.length,itemBuilder: (ctx, i) {final school = schools[i];return Card(child: ListTile(leading: const CircleAvatar(backgroundColor: Colors.orange,child: Icon(Icons.school, color: Colors.white),),title: Text(school.name,style: const TextStyle(fontWeight: FontWeight.bold),),subtitle: Text("Siswa: ${school.studentCount} | Deadline: ${school.deadlineTime}",),trailing: Row(// <--- RE-INSERTED ROWmainAxisSize: MainAxisSize.min,children: [// EDIT Button (UC25)IconButton(icon: const Icon(Icons.edit, color: Colors.blue),onPressed: () {Navigator.push(context,MaterialPageRoute(builder: (_) =>AddSchoolScreen(schoolToEdit: school),),).then((val) {if (val == true) setState(() {});});},),// DELETE Button (UC26)IconButton(icon: const Icon(Icons.delete, color: Colors.red),onPressed: () =>_deleteSchool(school.id), // <--- CORRECT CALL),],),),);},);},);}// 1. ARMADA (UC34 Edit, UC35 Delete)Widget _buildTransportList() {return FutureBuilder<List<Vehicle>>(future: _vehicleService.getMyVehicles(),builder: (context, snapshot) {if (snapshot.connectionState == ConnectionState.waiting)return const Center(child: CircularProgressIndicator());final vehicles = snapshot.data ?? [];if (vehicles.isEmpty)return _buildEmptyState("Belum ada kendaraan.",Icons.local_shipping_outlined,);return ListView.builder(padding: const EdgeInsets.all(10),itemCount: vehicles.length,itemBuilder: (ctx, i) {final vehicle = vehicles[i];return Card(child: ListTile(leading: Icon(Icons.directions_car,color: vehicle.isActive ? Colors.green : Colors.grey,size: 32,),title: Text(vehicle.plateNumber,style: const TextStyle(fontWeight: FontWeight.bold),),subtitle: Text("Supir: ${vehicle.driverName ?? '-'} | Kap.: ${vehicle.capacityLimit}",),trailing: Row(mainAxisSize: MainAxisSize.min,children: [// EDIT Button (UC34)IconButton(icon: const Icon(Icons.edit, color: Colors.blue),onPressed: () {Navigator.push(context,MaterialPageRoute(builder: (_) =>AddTransportScreen(vehicleToEdit: vehicle),),).then((val) {if (val == true) setState(() {});});},),// DELETE Button (UC35)IconButton(icon: const Icon(Icons.delete, color: Colors.red),onPressed: () => _deleteVehicle(vehicle.id),),// Status ToggleSwitch(value: vehicle.isActive,activeColor: Colors.green,onChanged: (val) async {await _vehicleService.toggleStatus(vehicle.id,vehicle.isActive,);setState(() {});},),],),),);},);},);}// 2. KURIR (UC31 Edit, UC32 Delete)Widget _buildCourierList() {return FutureBuilder<List<CourierModel>>(future: _courierService.getMyCouriers(),builder: (context, snapshot) {if (snapshot.connectionState == ConnectionState.waiting)return const Center(child: CircularProgressIndicator());final couriers = snapshot.data ?? [];if (couriers.isEmpty)return _buildEmptyState("Belum ada akun kurir.",Icons.person_off_outlined,);return ListView.builder(padding: const EdgeInsets.all(10),itemCount: couriers.length,itemBuilder: (ctx, i) {final courier = couriers[i];return Card(child: ListTile(leading: const CircleAvatar(backgroundColor: Colors.blueGrey,child: Icon(Icons.person, color: Colors.white),),title: Text(courier.name,style: const TextStyle(fontWeight: FontWeight.bold),),subtitle: Text(courier.email),trailing: Row(mainAxisSize: MainAxisSize.min,children: [// EDIT Button (UC31)IconButton(icon: const Icon(Icons.edit, color: Colors.blue),onPressed: () =>_navigateToEditAccount(courier.id, 'kurir', {'name': courier.name,'email': courier.email,'schoolId': null, // N/A'className': null, // N/A}),),// DELETE Button (UC32)IconButton(icon: const Icon(Icons.delete, color: Colors.red),onPressed: () => _deleteUser(courier.id, 'Kurir'),),],),),);},);},);}// 3. KOORDINATOR (UC31 Edit, UC32 Delete)Widget _buildCoordinatorList() {return FutureBuilder<List<CoordinatorModel>>(future: _coordinatorService.getMyCoordinators(),builder: (context, snapshot) {if (snapshot.connectionState == ConnectionState.waiting)return const Center(child: CircularProgressIndicator());final data = snapshot.data ?? [];if (data.isEmpty)return _buildEmptyState("Belum ada koordinator.",Icons.supervised_user_circle,);return ListView.builder(padding: const EdgeInsets.all(10),itemCount: data.length,itemBuilder: (ctx, i) {final coord = data[i];return Card(child: ListTile(leading: const CircleAvatar(backgroundColor: Colors.teal,child: Icon(Icons.person, color: Colors.white),),title: Text(coord.name,style: const TextStyle(fontWeight: FontWeight.bold),),subtitle: Text("${coord.schoolName}\n${coord.email}"),isThreeLine: true,trailing: Row(mainAxisSize: MainAxisSize.min,children: [// EDIT Button (UC31)IconButton(icon: const Icon(Icons.edit, color: Colors.blue),onPressed: () =>_navigateToEditAccount(coord.id, 'koordinator', {'name': coord.name,'email': coord.email,'schoolId': coord.schoolId,'className': null,}),),// DELETE Button (UC32)IconButton(icon: const Icon(Icons.delete, color: Colors.red),onPressed: () => _deleteUser(coord.id, 'Koordinator'),),],),),);},);},);}// 4. WALI KELAS (UC31 Edit, UC32 Delete)Widget _buildTeacherList() {return FutureBuilder<List<TeacherModel>>(future: _teacherService.getMyTeachers(),builder: (context, snapshot) {if (snapshot.connectionState == ConnectionState.waiting)return const Center(child: CircularProgressIndicator());final data = snapshot.data ?? [];if (data.isEmpty)return _buildEmptyState("Belum ada wali kelas.", Icons.class_);return ListView.builder(padding: const EdgeInsets.all(10),itemCount: data.length,itemBuilder: (ctx, i) {final teacher = data[i];return Card(child: ListTile(leading: const CircleAvatar(backgroundColor: Colors.indigo,child: Icon(Icons.class_, color: Colors.white),),title: Text(teacher.name,style: const TextStyle(fontWeight: FontWeight.bold),),subtitle: Text("${teacher.schoolName} - Kelas ${teacher.className}\n${teacher.email}",),isThreeLine: true,trailing: Row(mainAxisSize: MainAxisSize.min,children: [// EDIT Button (UC31)IconButton(icon: const Icon(Icons.edit, color: Colors.blue),onPressed: () =>_navigateToEditAccount(teacher.id, 'walikelas', {'name': teacher.name,'email': teacher.email,'schoolId': teacher.schoolId,'className': teacher.className,}),),// DELETE Button (UC32)IconButton(icon: const Icon(Icons.delete, color: Colors.red),onPressed: () => _deleteUser(teacher.id, 'Wali Kelas'),),],),),);},);},);}// [UPDATE] LIST RUTE DENGAN NAVIGASI KE READ-ONLYWidget _buildRouteList() {return FutureBuilder<List<DeliveryRoute>>(future: _routeService.getMyRoutes(),builder: (context, snapshot) {if (snapshot.connectionState == ConnectionState.waiting)return const Center(child: CircularProgressIndicator());final routes = snapshot.data ?? [];if (routes.isEmpty)return _buildEmptyState("Belum ada jadwal rute.", Icons.map_outlined);return ListView.builder(padding: const EdgeInsets.all(12),itemCount: routes.length,itemBuilder: (context, index) {final route = routes[index];final date = DateTime.tryParse(route.date) ?? DateTime.now();String dateStr = route.date;try {dateStr = DateFormat('EEEE, d MMM yyyy', 'id_ID').format(date);} catch (_) {}final isPending = route.status == 'pending'; // Check the statusreturn Card(elevation: 3,margin: const EdgeInsets.only(bottom: 12),child: InkWell(// [AKSI] Tap opens the Edit/Detail screenonTap: () {Navigator.push(context,MaterialPageRoute(builder: (_) => EditRouteScreen(route: route),),).then((val) {setState(() {});});},child: Padding(padding: const EdgeInsets.all(12),child: Column(children: [Row(mainAxisAlignment: MainAxisAlignment.spaceBetween,children: [Text(dateStr,style: const TextStyle(fontWeight: FontWeight.bold,fontSize: 16,),),// Status TextText(route.status.toUpperCase(),style: TextStyle(color: _getStatusColor(route.status),fontWeight: FontWeight.bold,),),],),const Divider(),Row(mainAxisAlignment: MainAxisAlignment.spaceBetween, // Added this for spacingchildren: [// Left Side: Courier & Vehicle InfoExpanded(child: Row(children: [const Icon(Icons.person,size: 16,color: Colors.grey,),const SizedBox(width: 5),Text(route.courierName ?? "Kurir Hapus",style: const TextStyle(fontSize: 14),),const SizedBox(width: 15),const Icon(Icons.local_shipping,size: 16,color: Colors.grey,),const SizedBox(width: 5),Text(route.vehiclePlate ?? "-",style: const TextStyle(fontSize: 14,fontWeight: FontWeight.w500,),),],),),// Right Side: DELETE BUTTONif (isPending)IconButton(icon: const Icon(Icons.delete, color: Colors.red),tooltip: "Hapus Rute",onPressed: () => _deleteRoute(route.id,), // <--- THE DAMN BUTTON IS HERE),],),],),),),);},);},);}// [NEW/RESTORED] Fungsi Delete Rute (UC18)Future<void> _deleteRoute(String routeId) async {final confirm = await showDialog(context: context,builder: (ctx) => AlertDialog(title: const Text("Hapus Rute?"),content: const Text("Menghapus rute akan menghapus semua perhentian terkait. Yakin?",),actions: [TextButton(onPressed: () => Navigator.pop(ctx, false),child: const Text("Batal"),),TextButton(onPressed: () => Navigator.pop(ctx, true),child: const Text("Hapus", style: TextStyle(color: Colors.red)),),],),);if (confirm == true) {try {await _routeService.deleteRoute(routeId);if (!mounted) return;ScaffoldMessenger.of(context,).showSnackBar(const SnackBar(content: Text("Rute Dihapus!")));setState(() {});} catch (e) {if (!mounted) return;ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Error Hapus Rute: $e"),backgroundColor: Colors.red,),);}}}// [RESTORED] Fungsi Delete Sekolah (UC26)Future<void> _deleteSchool(String schoolId) async {final confirm = await showDialog(context: context,builder: (ctx) => AlertDialog(title: const Text("Hapus Sekolah?"),content: const Text("Yakin mau hapus lokasi ini? Semua data terkait (koordinator/wali) mungkin kena imbas.",),actions: [TextButton(onPressed: () => Navigator.pop(ctx, false),child: const Text("Batal"),),TextButton(onPressed: () => Navigator.pop(ctx, true),child: const Text("Hapus", style: TextStyle(color: Colors.red)),),],),);if (confirm == true) {try {await _schoolService.deleteSchool(schoolId);if (!mounted) return;ScaffoldMessenger.of(context,).showSnackBar(const SnackBar(content: Text("Sekolah Dihapus!")));setState(() {});} catch (e) {if (!mounted) return;ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Gagal menghapus: $e"),backgroundColor: Colors.red,),);}}}// [RESTORED] Fungsi Delete Mobil (UC35)Future<void> _deleteVehicle(String vehicleId) async {final confirm = await showDialog(context: context,builder: (ctx) => AlertDialog(title: const Text("Hapus Kendaraan?"),content: const Text("Hapus plat ini dari armada?"),actions: [TextButton(onPressed: () => Navigator.pop(ctx, false),child: const Text("Batal"),),TextButton(onPressed: () => Navigator.pop(ctx, true),child: const Text("Hapus", style: TextStyle(color: Colors.red)),),],),);if (confirm == true) {await _vehicleService.deleteVehicle(vehicleId);if (!mounted) return;ScaffoldMessenger.of(context,).showSnackBar(const SnackBar(content: Text("Mobil Dihapus!")));setState(() {});}}// [RESTORED] Fungsi Delete User (Kurir/Koord/Wali) (UC32)Future<void> _deleteUser(String userId, String roleName) async {final confirm = await showDialog(context: context,builder: (ctx) => AlertDialog(title: Text("Hapus Akun $roleName?"),content: const Text("Tindakan ini permanen. Akun ini akan hilang."),actions: [TextButton(onPressed: () => Navigator.pop(ctx, false),child: const Text("Batal"),),TextButton(onPressed: () => Navigator.pop(ctx, true),child: const Text("Hapus", style: TextStyle(color: Colors.red)),),],),);if (confirm == true) {try {if (roleName == 'Kurir')await _courierService.deleteCourierAccount(userId);if (roleName == 'Koordinator')await _coordinatorService.deleteCoordinatorAccount(userId);if (roleName == 'Wali Kelas')await _teacherService.deleteTeacherAccount(userId);if (!mounted) return;ScaffoldMessenger.of(context,).showSnackBar(SnackBar(content: Text("Akun $roleName Dihapus!")));setState(() {});} catch (e) {ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Error: $e"), backgroundColor: Colors.red),);}}}// [RESTORED] Fungsi Navigasi ke Edit Screen (Kurir, Koord, Wali) (UC31)// NOTE: Assuming this function and EditAccountScreen exists and is imported.void _navigateToEditAccount(String userId,String role,Map<String, dynamic> data,) {Navigator.push(context,MaterialPageRoute(builder: (_) => EditAccountScreen(userId: userId,initialRole: role,initialData: data,),),).then((val) {if (val == true) setState(() {});});}Widget _buildEmptyState(String text, IconData icon) {return Center(child: Column(mainAxisAlignment: MainAxisAlignment.center,children: [Icon(icon, size: 70, color: Colors.grey[300]),const SizedBox(height: 10),Text(text, style: TextStyle(fontSize: 16, color: Colors.grey[600])),],),);}Color _getStatusColor(String status) {switch (status) {case 'completed':return Colors.green;case 'active':return Colors.blue;default:return Colors.orange;}}}

=== FILE: lib/features/admin_sppg/screens/production_calendar_screen.dart ===
import 'package:flutter/material.dart';import 'package:table_calendar/table_calendar.dart';import 'package:intl/intl.dart';import '../../../models/production_schedule_model.dart';import '../../../models/menu_model.dart';import '../services/schedule_service.dart';import '../services/menu_service.dart';class ProductionCalendarScreen extends StatefulWidget {const ProductionCalendarScreen({super.key});@overrideState<ProductionCalendarScreen> createState() =>_ProductionCalendarScreenState();}class _ProductionCalendarScreenState extends State<ProductionCalendarScreen> {final ScheduleService _scheduleService = ScheduleService();final MenuService _menuService = MenuService();DateTime _focusedDay = DateTime.now();DateTime? _selectedDay;Map<DateTime, List<ProductionSchedule>> _schedules = {};List<Menu> _availableMenus = [];bool _isLoading = true;@overridevoid initState() {super.initState();_selectedDay = _focusedDay;_loadInitialData();}Future<void> _loadInitialData() async {try {final menus = await _menuService.getMyMenus();_availableMenus = menus;_fetchSchedules();} catch (e) {setState(() => _isLoading = false);}}Future<void> _fetchSchedules() async {setState(() => _isLoading = true);try {final data = await _scheduleService.getSchedulesByMonth(_focusedDay);Map<DateTime, List<ProductionSchedule>> newMap = {};for (var item in data) {final dateKey = DateTime(item.date.year,item.date.month,item.date.day,);if (newMap[dateKey] == null) newMap[dateKey] = [];newMap[dateKey]!.add(item);}if (mounted) {setState(() {_schedules = newMap;_isLoading = false;});}} catch (e) {if (mounted) setState(() => _isLoading = false);}}List<ProductionSchedule> _getSchedulesForDay(DateTime day) {final dateKey = DateTime(day.year, day.month, day.day);return _schedules[dateKey] ?? [];}// --- DIALOG CRUD (TAMBAH KHUSUS / EDIT) ---void _showScheduleDialog({ProductionSchedule? scheduleToEdit}) {String? selectedMenuId = scheduleToEdit?.menuId;final portionController = TextEditingController(text: scheduleToEdit?.totalPortions.toString() ?? "100",);final noteController = TextEditingController(text: scheduleToEdit?.notes ?? "Tambahan Khusus",);TimeOfDay selectedTime = const TimeOfDay(hour: 11, minute: 0);if (scheduleToEdit?.targetFinishTime != null) {final parts = scheduleToEdit!.targetFinishTime!.split(':');selectedTime = TimeOfDay(hour: int.parse(parts[0]),minute: int.parse(parts[1]),);}showDialog(context: context,builder: (ctx) => StatefulBuilder(builder: (context, setDialogState) {final currentMenu = _availableMenus.isNotEmpty? _availableMenus.firstWhere((m) => m.id == selectedMenuId,orElse: () => _availableMenus.first,): null;String startTimeString = "--:--";if (currentMenu != null) {startTimeString = _scheduleService.calculateStartTime(selectedTime,selectedMenuId != null? currentMenu.cookingDurationMinutes: 0,).substring(0, 5);}return AlertDialog(title: Text(scheduleToEdit == null ? "Jadwal Khusus" : "Edit Jadwal",),content: SingleChildScrollView(child: Column(mainAxisSize: MainAxisSize.min,children: [if (scheduleToEdit == null)const Text("Gunakan ini HANYA untuk pesanan tambahan di luar rute rutin.",style: TextStyle(fontSize: 12, color: Colors.red),),const SizedBox(height: 10),DropdownButtonFormField<String>(decoration: const InputDecoration(labelText: "Pilih Menu",border: OutlineInputBorder(),),value: selectedMenuId,items: _availableMenus.map((m) => DropdownMenuItem(value: m.id,child: Text(m.name),),).toList(),onChanged: (val) =>setDialogState(() => selectedMenuId = val),),const SizedBox(height: 10),TextField(controller: portionController,keyboardType: TextInputType.number,decoration: const InputDecoration(labelText: "Jumlah Porsi",border: OutlineInputBorder(),),),const SizedBox(height: 10),ListTile(title: const Text("Target Selesai Jam:"),subtitle: Text(selectedTime.format(context),style: const TextStyle(fontWeight: FontWeight.bold),),trailing: const Icon(Icons.access_time),onTap: () async {final t = await showTimePicker(context: context,initialTime: selectedTime,);if (t != null) setDialogState(() => selectedTime = t);},),if (selectedMenuId != null && currentMenu != null)Padding(padding: const EdgeInsets.only(top: 10),child: Container(padding: const EdgeInsets.all(8),color: Colors.blue[50],child: Text("MULAI MASAK: $startTimeString (Durasi: ${currentMenu.cookingDurationMinutes} mnt)",style: const TextStyle(color: Colors.blue,fontWeight: FontWeight.bold,fontSize: 12,),),),),const SizedBox(height: 10),TextField(controller: noteController,decoration: const InputDecoration(labelText: "Catatan",border: OutlineInputBorder(),),),],),),actions: [TextButton(onPressed: () => Navigator.pop(ctx),child: const Text("Batal"),),ElevatedButton(onPressed: () async {if (selectedMenuId == null) return;Navigator.pop(ctx);final menu = _availableMenus.firstWhere((m) => m.id == selectedMenuId,);if (scheduleToEdit == null) {// TAMBAH KHUSUSawait _scheduleService.addSchedule(date: _selectedDay!,menuId: selectedMenuId!,portions: int.parse(portionController.text),deliverTime: selectedTime,cookingDuration: menu.cookingDurationMinutes,notes: noteController.text,);} else {// EDIT JADWAL (Rutin/Khusus)await _scheduleService.updateSchedule(id: scheduleToEdit.id,menuId: selectedMenuId!,portions: int.parse(portionController.text),deliverTime: selectedTime,cookingDuration: menu.cookingDurationMinutes,notes: noteController.text,);}_fetchSchedules();},child: const Text("Simpan"),),],);},),);}void _confirmDelete(String id) {showDialog(context: context,builder: (ctx) => AlertDialog(title: const Text("Hapus Jadwal?"),content: const Text("Jadwal produksi ini akan dihapus."),actions: [TextButton(onPressed: () => Navigator.pop(ctx),child: const Text("Batal"),),TextButton(onPressed: () async {Navigator.pop(ctx);await _scheduleService.deleteSchedule(id);_fetchSchedules();},child: const Text("Hapus", style: TextStyle(color: Colors.red)),),],),);}@overrideWidget build(BuildContext context) {return Scaffold(appBar: AppBar(title: const Text("Kalender Produksi"),backgroundColor: Colors.orange[800],foregroundColor: Colors.white,),body: Column(children: [TableCalendar<ProductionSchedule>(firstDay: DateTime.utc(2024, 1, 1),lastDay: DateTime.utc(2030, 12, 31),focusedDay: _focusedDay,selectedDayPredicate: (day) => isSameDay(_selectedDay, day),calendarFormat: CalendarFormat.month,eventLoader: _getSchedulesForDay,onDaySelected: (selected, focused) {setState(() {_selectedDay = selected;_focusedDay = focused;});},onPageChanged: (focused) {_focusedDay = focused;_fetchSchedules();},calendarStyle: const CalendarStyle(markerDecoration: BoxDecoration(color: Colors.orange,shape: BoxShape.circle,),todayDecoration: BoxDecoration(color: Colors.blue,shape: BoxShape.circle,),selectedDecoration: BoxDecoration(color: Colors.orange,shape: BoxShape.circle,),),headerStyle: const HeaderStyle(formatButtonVisible: false,titleCentered: true,),),const Divider(thickness: 1),const Padding(padding: EdgeInsets.all(8.0),child: Text("Jadwal Masak Hari Ini:",style: TextStyle(fontWeight: FontWeight.bold, color: Colors.grey),),),Expanded(child: _isLoading? const Center(child: CircularProgressIndicator()): _buildDayList(),),],),// Tombol KhususfloatingActionButton: FloatingActionButton.extended(backgroundColor: Colors.redAccent,foregroundColor: Colors.white,label: const Text("Jadwal Khusus"),icon: const Icon(Icons.add_alert),onPressed: () => _showScheduleDialog(),),);}Widget _buildDayList() {final events = _getSchedulesForDay(_selectedDay!);if (events.isEmpty)return const Center(child: Text("Tidak ada jadwal masak."));return ListView.builder(itemCount: events.length,itemBuilder: (context, index) {final schedule = events[index];// Check if the related route is already ACTIVE/COMPLETED to prevent accidental deletion!// NOTE: For now, we assume deleting the schedule is allowed by the admin, but a safer check// would involve querying the associated route status first!final isDeletable =true; // Simplified for now. Should check related route status.return Card(margin: const EdgeInsets.symmetric(horizontal: 16, vertical: 6),child: ListTile(leading: CircleAvatar(backgroundColor: Colors.orange[100],child: const Icon(Icons.restaurant, color: Colors.orange),),title: Text(schedule.menuName,style: const TextStyle(fontWeight: FontWeight.bold),),subtitle: Column(crossAxisAlignment: CrossAxisAlignment.start,children: [Text("Target: ${schedule.totalPortions} Porsi"),Text("Masak: ${schedule.startCookingTime?.substring(0, 5)} -> Selesai: ${schedule.targetFinishTime?.substring(0, 5)}",style: const TextStyle(color: Colors.red,fontWeight: FontWeight.bold,),),if (schedule.notes != null)Text(schedule.notes!,style: const TextStyle(fontStyle: FontStyle.italic,fontSize: 12,),),],),// REPLACING POPUP MENU WITH DIRECT ACTION BUTTONS (Edit and Delete)trailing: Row(mainAxisSize: MainAxisSize.min,children: [// EDIT ButtonIconButton(icon: const Icon(Icons.edit, color: Colors.blue),onPressed: () => _showScheduleDialog(scheduleToEdit: schedule,), // Mode Edit),// DELETE Buttonif (isDeletable) // Show delete button if allowedIconButton(icon: const Icon(Icons.delete, color: Colors.red),onPressed: () => _confirmDelete(schedule.id),),],),// NOTE: If you want to keep the PopupMenuButton approach, use the one below./*trailing: PopupMenuButton(onSelected: (value) {if (value == 'edit') _showScheduleDialog(scheduleToEdit: schedule);if (value == 'delete') _confirmDelete(schedule.id);},itemBuilder: (context) => [const PopupMenuItem(value: 'edit', child: Text("Edit")),const PopupMenuItem(value: 'delete', child: Text("Hapus", style: TextStyle(color: Colors.red))),],),*/),);},);}}

=== FILE: lib/features/admin_sppg/screens/route_calendar_screen.dart ===
import 'package:flutter/material.dart';import 'package:table_calendar/table_calendar.dart';import '../services/route_service.dart';import '../../../models/route_model.dart';import 'create_route_screen.dart';class RouteCalendarScreen extends StatefulWidget {const RouteCalendarScreen({super.key});@overrideState<RouteCalendarScreen> createState() => _RouteCalendarScreenState();}class _RouteCalendarScreenState extends State<RouteCalendarScreen> {final RouteService _service = RouteService();DateTime _focusedDay = DateTime.now();DateTime _selectedDay = DateTime.now();Map<DateTime, List<DeliveryRoute>> _routes = {};@overridevoid initState() {super.initState();_fetchRoutes();}Future<void> _fetchRoutes() async {try {final data = await _service.getRoutesByMonth(_focusedDay);Map<DateTime, List<DeliveryRoute>> newMap = {};for (var r in data) {final d = DateTime.parse(r.date);final k = DateTime(d.year, d.month, d.day);if (newMap[k] == null) newMap[k] = [];newMap[k]!.add(r);}setState(() => _routes = newMap);} catch (e) {print(e);}}@overrideWidget build(BuildContext context) {return Scaffold(appBar: AppBar(title: const Text("Kalender Pengiriman"), backgroundColor: Colors.orange[800]),body: Column(children: [TableCalendar<DeliveryRoute>(firstDay: DateTime(2024), lastDay: DateTime(2030),focusedDay: _focusedDay,selectedDayPredicate: (d) => isSameDay(_selectedDay, d),eventLoader: (d) => _routes[DateTime(d.year, d.month, d.day)] ?? [],onDaySelected: (sel, foc) {setState(() { _selectedDay = sel; _focusedDay = foc; });},onPageChanged: (foc) { _focusedDay = foc; _fetchRoutes(); },),const Divider(),Expanded(child: ListView.builder(itemCount: (_routes[DateTime(_selectedDay.year, _selectedDay.month, _selectedDay.day)] ?? []).length,itemBuilder: (ctx, i) {final route = _routes[DateTime(_selectedDay.year, _selectedDay.month, _selectedDay.day)]![i];return ListTile(leading: const Icon(Icons.local_shipping, color: Colors.blue),title: Text(route.vehiclePlate ?? '-'),subtitle: Text("Kurir: ${route.courierName}"),trailing: Text(route.status.toUpperCase()),);},),)],),floatingActionButton: FloatingActionButton(child: const Icon(Icons.add),onPressed: () => Navigator.push(context, MaterialPageRoute(builder: (_) => const CreateRouteScreen())).then((_) => _fetchRoutes()),),);}}

=== FILE: lib/features/admin_sppg/services/courier_service.dart ===
import 'dart:convert';import 'package:http/http.dart' as http;import 'package:supabase_flutter/supabase_flutter.dart';import '../../../models/courier_model.dart';class CourierService {final _supabase = Supabase.instance.client;Future<String> _getMySppgId() async {final userId = _supabase.auth.currentUser!.id;final profile = await _supabase.from('profiles').select('sppg_id').eq('id', userId).single();return profile['sppg_id'];}Future<List<CourierModel>> getMyCouriers() async {try {final mySppgId = await _getMySppgId();final response = await _supabase.from('profiles').select('id, full_name, email, sppg_id').eq('sppg_id', mySppgId).eq('role', 'kurir');final List<dynamic> data = response;return data.map((json) => CourierModel.fromJson(json)).toList();} catch (e) {throw Exception('Gagal ambil data kurir: $e');}}Future<void> createCourierAccount({required String email,required String password,required String fullName,}) async {const String projectUrl = 'https://mqyfrqgfpqwlrloqtpvi.supabase.co';const String anonKey ='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1xeWZycWdmcHF3bHJsb3F0cHZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0NTMxMDMsImV4cCI6MjA3OTAyOTEwM30.KoXKouhFN0H7Iz9MSnRhFQuBIePVMwWyXmrzSv3rEeQ';try {final myUserId = _supabase.auth.currentUser!.id;final profile = await _supabase.from('profiles').select('sppg_id').eq('id', myUserId).single();final String mySppgId = profile['sppg_id'];final url = Uri.parse('$projectUrl/auth/v1/signup');final response = await http.post(url,headers: {'Content-Type': 'application/json', 'apikey': anonKey},body: jsonEncode({'email': email.trim(),'password': password,'data': {'full_name': fullName},}),);if (response.statusCode == 200 || response.statusCode == 201) {final responseData = jsonDecode(response.body);String? newUserId = responseData['id'] ?? responseData['user']['id'];if (newUserId == null) throw Exception("Gagal dapat ID User Kurir.");await _supabase.from('profiles').insert({'id': newUserId,'full_name': fullName,'email': email.trim(),'role': 'kurir','sppg_id': mySppgId,'school_id': null,});} else {final errorData = jsonDecode(response.body);throw Exception(errorData['msg'] ?? 'Gagal mendaftar');}} catch (e) {if (e.toString().contains("User already registered")) {throw Exception("Email kurir sudah terdaftar!");}throw Exception('Gagal buat akun kurir: $e');}}// [BARU] 3. HAPUS AKUN KURIR (Delete Auth User)Future<void> deleteCourierAccount(String userId) async {try {// Hapus akun dari Auth.users. Ini akan otomatis menghapus dari profiles.await _supabase.rpc('delete_user_and_profile',params: {'user_id_input': userId},);} catch (e) {throw Exception('Gagal hapus akun kurir: $e');}}// [BARU] 4. UPDATE AKUN KURIRFuture<void> updateCourierAccount(String userId,Map<String, dynamic> data,) async {try {// Update data di tabel profilesawait _supabase.from('profiles').update(data).eq('id', userId);// Coba update email di auth.users (ini bisa gagal kalau Supabase Auth API tidak mengizinkan langsung)// Kita bypass Auth update user secara langsung, fokus ke profiles aja dulu.// Jika perlu ganti password, itu di halaman Profile Screen (Core)} catch (e) {throw Exception('Gagal update akun kurir: $e');}}}

=== FILE: lib/features/admin_sppg/services/school_service.dart ===
import 'package:supabase_flutter/supabase_flutter.dart';import '../../../models/school_model.dart'; // Sesuaikan path import iniclass SchoolService {final _supabase = Supabase.instance.client;// --- 1. AMBIL DATA SEKOLAH (KHUSUS SPPG YG LOGIN) ---Future<List<School>> getMySchools() async {try {// Langkah A: Kita harus tau dulu, siapa User yg lagi login?final userId = _supabase.auth.currentUser!.id;// Langkah B: Cek di tabel profiles, user ini kerja di SPPG mana?final profile = await _supabase.from('profiles').select('sppg_id').eq('id', userId).single();final String mySppgId = profile['sppg_id'];// Langkah C: Ambil sekolah yang sppg_id nya SAMA dengan punya userfinal response = await _supabase.from('schools').select().eq('sppg_id', mySppgId) // Filter penting!.order('name', ascending: true); // Urutkan abjadfinal List<dynamic> data = response;return data.map((json) => School.fromJson(json)).toList();} catch (e) {throw Exception('Gagal mengambil data sekolah: $e');}}// --- 2. TAMBAH SEKOLAH BARU ---Future<void> createSchool(Map<String, dynamic> schoolData) async {try {// Kita perlu inject 'sppg_id' otomatis biar admin gak perlu input manualfinal userId = _supabase.auth.currentUser!.id;final profile = await _supabase.from('profiles').select('sppg_id').eq('id', userId).single();// Masukkan ID SPPG ke dalam data yang mau dikirimschoolData['sppg_id'] = profile['sppg_id'];// Kirim ke tabel 'schools'await _supabase.from('schools').insert(schoolData);} catch (e) {throw Exception('Gagal menambah sekolah: $e');}}// --- 3. HAPUS SEKOLAH ---Future<void> deleteSchool(String schoolId) async {try {await _supabase.from('schools').delete().eq('id', schoolId);} catch (e) {throw Exception('Gagal menghapus sekolah: $e');}}// --- 4. UPDATE DATA SEKOLAH (BARU) ---Future<void> updateSchool(String schoolId, Map<String, dynamic> schoolData) async {try {// Kita tidak perlu update sppg_id karena itu tidak berubahawait _supabase.from('schools').update(schoolData).eq('id', schoolId);} catch (e) {throw Exception('Gagal mengupdate sekolah: $e');}}Future<List<School>> getSchoolsBySppgId(String sppgId) async {try {final response = await _supabase.from('schools').select().eq('sppg_id', sppgId).order('name', ascending: true);final List<dynamic> data = response;return data.map((json) => School.fromJson(json)).toList();} catch (e) {throw Exception('Gagal ambil sekolah: $e');}}}

=== FILE: lib/features/admin_sppg/services/coordinator_service.dart ===
import 'dart:convert';import 'package:http/http.dart' as http;import 'package:supabase_flutter/supabase_flutter.dart';class CoordinatorModel {final String id;final String name;final String email;final String schoolName; // Biar kita tau dia jaga di sekolah manafinal String? schoolId;CoordinatorModel({required this.id,required this.name,required this.email,required this.schoolName,required this.schoolId,});factory CoordinatorModel.fromJson(Map<String, dynamic> json) {// Ambil nama sekolah dari relasi (join)final school = json['schools'] != null? json['schools']['name']: 'Belum ditentukan';return CoordinatorModel(id: json['id'].toString(),name: json['full_name'] ?? 'Tanpa Nama',email: json['email'] ?? '-',schoolName: school,schoolId: json['school_id']?.toString(),);}}class CoordinatorService {final _supabase = Supabase.instance.client;// 1. AMBIL LIST KOORDINATOR (Milik SPPG Ini)Future<List<CoordinatorModel>> getMyCoordinators() async {try {final userId = _supabase.auth.currentUser!.id;// Cek SPPG ID Adminfinal profile = await _supabase.from('profiles').select('sppg_id').eq('id', userId).single();final String mySppgId = profile['sppg_id'];// Ambil profil role 'koordinator', join dengan tabel schools untuk dapat nama sekolahnyafinal response = await _supabase.from('profiles').select('id, full_name, email, school_id, schools(name)').eq('sppg_id', mySppgId).eq('role', 'koordinator');final List<dynamic> data = response;return data.map((json) => CoordinatorModel.fromJson(json)).toList();} catch (e) {throw Exception('Gagal ambil data koordinator: $e');}}// 2. BUAT AKUN KOORDINATOR BARUFuture<void> createCoordinatorAccount({required String email,required String password,required String fullName,required String schoolId, // Wajib ada}) async {// Kredensial Supabase (Sama kayak courier service)const String projectUrl = 'https://mqyfrqgfpqwlrloqtpvi.supabase.co';const String anonKey ='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1xeWZycWdmcHF3bHJsb3F0cHZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0NTMxMDMsImV4cCI6MjA3OTAyOTEwM30.KoXKouhFN0H7Iz9MSnRhFQuBIePVMwWyXmrzSv3rEeQ';try {final myUserId = _supabase.auth.currentUser!.id;final profile = await _supabase.from('profiles').select('sppg_id').eq('id', myUserId).single();final String mySppgId = profile['sppg_id'];// A. Request Signupfinal url = Uri.parse('$projectUrl/auth/v1/signup');final response = await http.post(url,headers: {'Content-Type': 'application/json', 'apikey': anonKey},body: jsonEncode({'email': email.trim(),'password': password,'data': {'full_name': fullName},}),);if (response.statusCode == 200 || response.statusCode == 201) {final responseData = jsonDecode(response.body);String? newUserId = responseData['id'] ?? responseData['user']['id'];if (newUserId == null) throw Exception("Gagal dapat ID User.");// B. Simpan ke Profiles (Role: koordinator, School ID: terisi)await _supabase.from('profiles').insert({'id': newUserId,'full_name': fullName,'email': email.trim(),'role': 'koordinator','sppg_id': mySppgId,'school_id': schoolId, // <-- PENTING});} else {final errorData = jsonDecode(response.body);throw Exception(errorData['msg'] ?? 'Gagal mendaftar');}} catch (e) {if (e.toString().contains("User already registered")) {throw Exception("Email sudah terdaftar!");}throw Exception('Gagal buat akun: $e');}}// [BARU] 3. UPDATE AKUN KOORDINATORFuture<void> updateCoordinatorAccount(String userId,Map<String, dynamic> data,) async {try {// Update data di tabel profilesawait _supabase.from('profiles').update(data).eq('id', userId);} catch (e) {throw Exception('Gagal update akun koordinator: $e');}}// [BARU] 4. HAPUS AKUN KOORDINATOR (Delete Auth User)Future<void> deleteCoordinatorAccount(String userId) async {try {// Hapus akun dari Auth.users. Ini akan otomatis menghapus dari profiles.await _supabase.rpc('delete_user_and_profile',params: {'user_id_input': userId},);} catch (e) {throw Exception('Gagal hapus akun koordinator: $e');}}}

=== FILE: lib/features/admin_sppg/services/menu_service.dart ===
import 'package:supabase_flutter/supabase_flutter.dart';import '../../../models/menu_model.dart';import '../../../models/sppg_model.dart';class MenuService {final _supabase = Supabase.instance.client;Future<String> _getMySppgId() async {final userId = _supabase.auth.currentUser!.id;final profile = await _supabase.from('profiles').select('sppg_id').eq('id', userId).single();return profile['sppg_id'];}Future<List<Menu>> getMyMenus() async {try {final mySppgId = await _getMySppgId();final response = await _supabase.from('menus').select().eq('sppg_id', mySppgId).order('category', ascending: true);final List<dynamic> data = response;return data.map((json) => Menu.fromJson(json)).toList();} catch (e) {throw Exception('Gagal mengambil daftar menu: $e');}}Future<void> createMenu(Map<String, dynamic> menuData) async {try {final mySppgId = await _getMySppgId();menuData['sppg_id'] = mySppgId;await _supabase.from('menus').insert(menuData);} catch (e) {throw Exception('Gagal menambah menu: $e');}}Future<void> updateMenu(String menuId, Map<String, dynamic> menuData) async {try {await _supabase.from('menus').update(menuData).eq('id', menuId);} catch (e) {throw Exception('Gagal mengedit menu: $e');}}Future<void> deleteMenu(String menuId) async {try {await _supabase.from('menus').delete().eq('id', menuId);} catch (e) {throw Exception('Gagal menghapus menu: $e');}}}

=== FILE: lib/features/admin_sppg/services/teacher_service.dart ===
import 'dart:convert';import 'package:http/http.dart' as http;import 'package:supabase_flutter/supabase_flutter.dart';class TeacherModel {final String id;final String name;final String email;final String schoolName;final String className;final String? schoolId; // <--- ADD THIS FUCKING FIELDTeacherModel({required this.id,required this.name,required this.email,required this.schoolName,required this.className,this.schoolId, // <--- ADD TO CONSTRUCTOR});factory TeacherModel.fromJson(Map<String, dynamic> json) {final school = json['schools'] != null? json['schools']['name']: 'Belum ditentukan';return TeacherModel(id: json['id'].toString(),name: json['full_name'] ?? 'Tanpa Nama',email: json['email'] ?? '-',schoolName: school,className: json['class_name'] ?? '-',schoolId: json['school_id']?.toString(), // <--- PARSE IT HERE);}}class TeacherService {final _supabase = Supabase.instance.client;// 1. AMBIL LIST WALI KELASFuture<List<TeacherModel>> getMyTeachers() async {try {final userId = _supabase.auth.currentUser!.id;final profile = await _supabase.from('profiles').select('sppg_id').eq('id', userId).single();final String mySppgId = profile['sppg_id'];final response = await _supabase.from('profiles').select('id, full_name, email, class_name, schools(name)').eq('sppg_id', mySppgId).eq('role', 'walikelas');final List<dynamic> data = response;return data.map((json) => TeacherModel.fromJson(json)).toList();} catch (e) {throw Exception('Gagal ambil data wali kelas: $e');}}// 2. BUAT AKUN WALI KELASFuture<void> createTeacherAccount({required String email,required String password,required String fullName,required String schoolId,required String className, // Input Baru}) async {const String projectUrl = 'https://mqyfrqgfpqwlrloqtpvi.supabase.co';const String anonKey ='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1xeWZycWdmcHF3bHJsb3F0cHZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0NTMxMDMsImV4cCI6MjA3OTAyOTEwM30.KoXKouhFN0H7Iz9MSnRhFQuBIePVMwWyXmrzSv3rEeQ';try {final myUserId = _supabase.auth.currentUser!.id;final profile = await _supabase.from('profiles').select('sppg_id').eq('id', myUserId).single();final String mySppgId = profile['sppg_id'];// A. Request Signupfinal url = Uri.parse('$projectUrl/auth/v1/signup');final response = await http.post(url,headers: {'Content-Type': 'application/json', 'apikey': anonKey},body: jsonEncode({'email': email.trim(),'password': password,'data': {'full_name': fullName},}),);if (response.statusCode == 200 || response.statusCode == 201) {final responseData = jsonDecode(response.body);String? newUserId = responseData['id'] ?? responseData['user']['id'];if (newUserId == null) throw Exception("Gagal dapat ID User.");// B. Simpan ke Profilesawait _supabase.from('profiles').insert({'id': newUserId,'full_name': fullName,'email': email.trim(),'role': 'walikelas','sppg_id': mySppgId,'school_id': schoolId,'class_name': className,});} else {final errorData = jsonDecode(response.body);throw Exception(errorData['msg'] ?? 'Gagal mendaftar');}} catch (e) {if (e.toString().contains("User already registered")) {throw Exception("Email sudah terdaftar!");}throw Exception('Gagal buat akun: $e');}}// [BARU] 3. UPDATE AKUN WALI KELASFuture<void> updateTeacherAccount(String userId,Map<String, dynamic> data,) async {try {// Update data di tabel profilesawait _supabase.from('profiles').update(data).eq('id', userId);} catch (e) {throw Exception('Gagal update akun wali kelas: $e');}}// [BARU] 4. HAPUS AKUN WALI KELAS (Delete Auth User)Future<void> deleteTeacherAccount(String userId) async {try {// Hapus akun dari Auth.users. Ini akan otomatis menghapus dari profiles.await _supabase.rpc('delete_user_and_profile',params: {'user_id_input': userId},);} catch (e) {throw Exception('Gagal hapus akun wali kelas: $e');}}}

=== FILE: lib/features/admin_sppg/services/complaint_service.dart ===
import 'package:supabase_flutter/supabase_flutter.dart';import 'package:intl/intl.dart';class ComplaintService {final _supabase = Supabase.instance.client;Future<String> _getMySppgId() async {final userId = _supabase.auth.currentUser!.id;final profile = await _supabase.from('profiles').select('sppg_id').eq('id', userId).single();return profile['sppg_id'];}// 1. AMBIL MASALAH DARI KOORDINATOR (Kemasan/Jumlah)Future<List<Map<String, dynamic>>> getCoordinatorComplaints() async {try {final mySppgId = await _getMySppgId();// Ambil delivery_stops yang statusnya 'issue_reported'// Dan join ke sekolah untuk tau nama sekolahnyafinal response = await _supabase.from('delivery_stops').select('*, schools(name), delivery_routes!inner(sppg_id)').eq('delivery_routes.sppg_id', mySppgId).eq('status', 'issue_reported').order('created_at', ascending: false);return List<Map<String, dynamic>>.from(response);} catch (e) {throw Exception("Gagal ambil komplain koordinator: $e");}}// 2. AMBIL MASALAH DARI WALI KELAS (Kualitas Makanan)Future<List<Map<String, dynamic>>> getTeacherComplaints() async {try {final mySppgId = await _getMySppgId();// Join class_receptions -> delivery_stops -> delivery_routes -> filter SPPGfinal response = await _supabase.from('class_receptions').select('*, delivery_stops!inner(schools(name), delivery_routes!inner(sppg_id))').eq('delivery_stops.delivery_routes.sppg_id', mySppgId).not('issue_type', 'is', null) // Ambil yang issue_type nya TIDAK NULL (berarti ada masalah).order('created_at', ascending: false);return List<Map<String, dynamic>>.from(response);} catch (e) {throw Exception("Gagal ambil komplain wali kelas: $e");}}// 3. KIRIM INSTRUKSI (TINDAK LANJUT)Future<void> respondToComplaint({required String table, // 'delivery_stops' atau 'class_receptions'required String id,required String response,}) async {try {await _supabase.from(table).update({'admin_response': response,'resolved_at': DateTime.now().toIso8601String(),}).eq('id', id);} catch (e) {throw Exception("Gagal kirim respon: $e");}}}

=== FILE: lib/features/admin_sppg/services/schedule_service.dart ===
import 'package:supabase_flutter/supabase_flutter.dart';import 'package:flutter/material.dart';import '../../../models/production_schedule_model.dart';class ScheduleService {final _supabase = Supabase.instance.client;Future<String> _getMySppgId() async {final userId = _supabase.auth.currentUser!.id;final profile = await _supabase.from('profiles').select('sppg_id').eq('id', userId).single();return profile['sppg_id'];}// --- 1. READ: AMBIL JADWAL BULANAN ---Future<List<ProductionSchedule>> getSchedulesByMonth(DateTime month) async {try {final mySppgId = await _getMySppgId();// Tentukan awal & akhir bulanfinal startDate = DateTime(month.year, month.month, 1);final endDate = DateTime(month.year, month.month + 1, 0);final response = await _supabase.from('production_schedules').select('*, menus(name, cooking_duration_minutes)').eq('sppg_id', mySppgId).gte('date', startDate.toIso8601String()).lte('date', endDate.toIso8601String());final List<dynamic> data = response;return data.map((json) => ProductionSchedule.fromJson(json)).toList();} catch (e) {throw Exception("Gagal ambil jadwal: $e");}}// --- LOGIKA HITUNG MUNDUR (BACKWARD SCHEDULING) ---String calculateStartTime(TimeOfDay deliverTime, int cookingDurationMinutes) {// Konversi ke menit dari jam 00:00int deliverMinutes = deliverTime.hour * 60 + deliverTime.minute;// Rumus: Jam Kirim - (Durasi Masak + 30 Menit Packing/Loading)int startMinutes = deliverMinutes - cookingDurationMinutes - 30;if (startMinutes < 0) startMinutes = 0;final int startHour = startMinutes ~/ 60;final int startMinute = startMinutes % 60;return "${startHour.toString().padLeft(2, '0')}:${startMinute.toString().padLeft(2, '0')}:00";}// --- 2. CREATE: TAMBAH JADWAL ---Future<void> addSchedule({required DateTime date,required String menuId,required int portions,required TimeOfDay deliverTime, // Target Jam Kirim (Deadline)required int cookingDuration, // Dari MenuString? notes,}) async {try {final mySppgId = await _getMySppgId();final String targetFinish = "${deliverTime.hour.toString().padLeft(2,'0')}:${deliverTime.minute.toString().padLeft(2,'0')}:00";final String startCooking = calculateStartTime(deliverTime, cookingDuration);await _supabase.from('production_schedules').insert({'sppg_id': mySppgId,'date': date.toIso8601String().split('T')[0],'menu_id': menuId,'total_portions': portions,'start_cooking_time': startCooking,'target_finish_time': targetFinish,'notes': notes,});} catch (e) {throw Exception("Gagal tambah jadwal: $e");}}// --- 3. UPDATE: UBAH JADWAL (JADWAL DADAKAN) ---Future<void> updateSchedule({required String id,required String menuId,required int portions,required TimeOfDay deliverTime,required int cookingDuration,String? notes,}) async {try {final String targetFinish = "${deliverTime.hour.toString().padLeft(2,'0')}:${deliverTime.minute.toString().padLeft(2,'0')}:00";final String startCooking = calculateStartTime(deliverTime, cookingDuration);await _supabase.from('production_schedules').update({'menu_id': menuId,'total_portions': portions,'start_cooking_time': startCooking, // Hitung ulang waktu masak'target_finish_time': targetFinish,'notes': notes,}).eq('id', id);} catch (e) {throw Exception("Gagal update jadwal: $e");}}// --- 4. DELETE: HAPUS JADWAL ---Future<void> deleteSchedule(String id) async {try {await _supabase.from('production_schedules').delete().eq('id', id);} catch (e) {throw Exception("Gagal hapus jadwal: $e");}}}

=== FILE: lib/features/admin_sppg/services/route_service.dart ===
import 'package:supabase_flutter/supabase_flutter.dart';import 'package:flutter/material.dart'; // Butuh untuk TimeOfDayimport 'package:intl/intl.dart';import 'package:latlong2/latlong.dart';import 'dart:convert';import 'package:http/http.dart' as http;// Import Modelsimport '../../../models/route_model.dart';import '../../../models/school_model.dart';class RouteService {final _supabase = Supabase.instance.client;// ===========================================================================// BAGIAN 1: LOGIKA PEMBUATAN & PERHITUNGAN RUTE (CORE LOGIC)// ===========================================================================// --- 1. CREATE BATCH RUTE (MULTI MOBIL) ---// Fungsi ini membagi daftar sekolah ke beberapa mobil, lalu membuat rute untuk masing-masing.Future<void> createBatchRoutes({required List<String> vehicleIds,required String courierId,required String menuId,required DateTime date,required List<School> selectedSchools,required int cookingDuration,}) async {try {final userId = _supabase.auth.currentUser!.id;final profile = await _supabase.from('profiles').select('sppg_id').eq('id', userId).single();final String mySppgId = profile['sppg_id'];// A. BAGI SEKOLAH KE MOBIL (Distribusi Sederhana)if (vehicleIds.isEmpty) return;int schoolsPerVehicle = (selectedSchools.length / vehicleIds.length).ceil();for (int i = 0; i < vehicleIds.length; i++) {// Ambil potongan list sekolah untuk mobil ke-iint start = i * schoolsPerVehicle;int end = (start + schoolsPerVehicle < selectedSchools.length)? start + schoolsPerVehicle: selectedSchools.length;if (start >= selectedSchools.length) break; // HabisList<School> assignedSchools = selectedSchools.sublist(start, end);String currentVehicleId = vehicleIds[i];// B. HITUNG & INSERT RUTE TUNGGALawait _createSingleRouteCalculation(sppgId: mySppgId,vehicleId: currentVehicleId,courierId: courierId,menuId: menuId,date: date,schools: assignedSchools,cookingDuration: cookingDuration,);}} catch (e) {throw Exception("Gagal bagi rute: $e");}}// --- 2. HITUNG MUNDUR & INSERT KE DB (PRIVATE HELPER) ---Future<void> _createSingleRouteCalculation({required String sppgId,required String vehicleId,required String courierId,required String menuId,required DateTime date,required List<School> schools,required int cookingDuration,}) async {// A. Ambil Lokasi Dapur (Titik Awal)final origin = await getSppgLocation();if (origin == null)throw Exception("Lokasi Dapur belum diset! Edit SPPG dulu.");// B. Susun Koordinat untuk Request OSRM (Dapur -> Sekolah A -> Sekolah B -> ...)// Format OSRM: {long},{lat};{long},{lat}String coordString = "${origin.longitude},${origin.latitude}";for (var s in schools) {if (s.latitude == null || s.longitude == null)throw Exception("Sekolah ${s.name} belum punya lokasi GPS!");coordString += ";${s.longitude},${s.latitude}";}// C. Panggil OSRM untuk dapatkan Durasi Per Segmen (Legs)final url = Uri.parse('https://router.project-osrm.org/route/v1/driving/$coordString?overview=false',);final response = await http.get(url);if (response.statusCode != 200)throw Exception("Gagal hitung durasi jalan (OSRM Error Status: ${response.statusCode}).",);final data = jsonDecode(response.body);// [CRASH FIX]: Check if OSRM found a valid route before proceeding.if (data['code'] != 'Ok' ||data['routes'] == null ||(data['routes'] as List).isEmpty) {// If the route fails (e.g., invalid input, or no road found), bail out cleanly.throw Exception("OSRM ROUTING FAILED: Could not find a valid route between points. Check GPS data or connectivity.",);}final List<dynamic> legs =data['routes'][0]['legs']; // This line was crashing!// D. Hitung Total Waktu & Durasi per Segmenint totalTravelSeconds = 0;List<int> travelSecondsPerLeg = [];for (var leg in legs) {int duration = (leg['duration'] as num).toInt(); // DetiktravelSecondsPerLeg.add(duration);totalTravelSeconds +=duration +(10 * 60); // Tambah 10 menit (600 detik) service time per titik}// E. Tentukan Deadline Paling Awal (The Bottle Neck)TimeOfDay earliestDeadline = const TimeOfDay(hour: 13,minute: 0,); // Default limit siangfor (var s in schools) {if (s.deadlineTime != null) {final parts = s.deadlineTime!.split(':');final time = TimeOfDay(hour: int.parse(parts[0]),minute: int.parse(parts[1]),);// Cari yang paling pagiif (time.hour < earliestDeadline.hour ||(time.hour == earliestDeadline.hour &&time.minute < earliestDeadline.minute)) {earliestDeadline = time;}}}// F. Hitung Mundur Jam Berangkat (Departure Time)// Konversi Deadline ke Detik dari jam 00:00int deadlineSeconds =earliestDeadline.hour * 3600 + earliestDeadline.minute * 60;int departureSeconds = deadlineSeconds - totalTravelSeconds;// Konversi Detik ke TimeOfDay (Jam Berangkat)TimeOfDay departureTime = TimeOfDay(hour: departureSeconds ~/ 3600,minute: (departureSeconds % 3600) ~/ 60,);// G. Hitung Jam Masak (Start Cooking)// Jam Berangkat - Durasi Masak - 30 Menit Packingint startCookingSeconds =departureSeconds - (cookingDuration * 60) - (30 * 60);if (startCookingSeconds < 0) startCookingSeconds = 0;TimeOfDay startCookingTime = TimeOfDay(hour: startCookingSeconds ~/ 3600,minute: (startCookingSeconds % 3600) ~/ 60,);// Format String untuk DB (HH:mm:ss)String fmtDep ="${departureTime.hour.toString().padLeft(2, '0')}:${departureTime.minute.toString().padLeft(2, '0')}:00";String fmtCook ="${startCookingTime.hour.toString().padLeft(2, '0')}:${startCookingTime.minute.toString().padLeft(2, '0')}:00";// H. INSERT RUTE KE DBfinal routeRes = await _supabase.from('delivery_routes').insert({'date': date.toIso8601String().split('T')[0],'sppg_id': sppgId,'vehicle_id': vehicleId,'courier_id': courierId,'menu_id': menuId,'departure_time': fmtDep, // Hasil Hitungan'status': 'pending',}).select().single();final String newRouteId = routeRes['id'];// I. INSERT STOPS (DENGAN ESTIMASI WAKTU TIBA / ETA)List<Map<String, dynamic>> stopsData = [];int currentSeconds = departureSeconds;for (int k = 0; k < schools.length; k++) {// Tambah durasi perjalanan nyata dari OSRM untuk segmen inicurrentSeconds += travelSecondsPerLeg[k];// Konversi ke String ETAint h = currentSeconds ~/ 3600;int m = (currentSeconds % 3600) ~/ 60;String fmtEta ="${h.toString().padLeft(2, '0')}:${m.toString().padLeft(2, '0')}:00";stopsData.add({'route_id': newRouteId,'school_id': schools[k].id,'sequence_order': k + 1,'estimated_arrival_time': fmtEta, // ETA Real berdasarkan jarak'status': 'pending',});// Tambah waktu service (10 menit) sebelum lanjut jalan ke sekolah berikutnyacurrentSeconds += (10 * 60);}await _supabase.from('delivery_stops').insert(stopsData);// J. AUTO-INSERT JADWAL PRODUKSIint totalPortions = schools.fold(0, (sum, item) => sum + item.studentCount);await _supabase.from('production_schedules').insert({'sppg_id': sppgId,'date': date.toIso8601String().split('T')[0],'menu_id': menuId,'total_portions': totalPortions,'start_cooking_time': fmtCook, // Hasil Hitung Mundur'target_finish_time': fmtDep, // Target Selesai = Jam Berangkat'notes': 'Auto-Schedule (Rute #$newRouteId)',});}// --- 3. UPDATE RUTE (EDIT SEKOLAH) ---Future<void> updateRouteSchools(String routeId,List<School> newSchoolList,int cookingDuration,) async {try {// 1. Ambil Data Rute Lama (untuk di-clone)final routeData = await _supabase.from('delivery_routes').select().eq('id', routeId).single();final DateTime date = DateTime.parse(routeData['date']);final String menuId = routeData['menu_id'];final String vehicleId = routeData['vehicle_id'];final String courierId = routeData['courier_id'];final String sppgId = routeData['sppg_id'];// 2. Hapus Rute Lama (Cascade akan menghapus stops & jadwal terkait jika foreign key diset cascade,// jika tidak, kita harus hapus manual. Asumsi: Kita hapus route, trigger DB atau logic app handle sisanya).// Cara aman: Hapus stops dulu, lalu route.await _supabase.from('delivery_stops').delete().eq('route_id', routeId);await _supabase.from('delivery_routes').delete().eq('id', routeId);// Catatan: Jadwal produksi yang lama mungkin masih ada (orphan).// Idealnya kita hapus juga berdasarkan 'notes' atau ID rute, tapi ini kompleks.// Untuk sekarang, sistem akan membuat jadwal produksi BARU. Admin bisa hapus yang lama manual di Kalender.// 3. Buat Ulang Rute dengan Sekolah Baru & Hitung Ulangawait _createSingleRouteCalculation(sppgId: sppgId,vehicleId: vehicleId,courierId: courierId,menuId: menuId,date: date,schools: newSchoolList,cookingDuration: cookingDuration,);} catch (e) {throw Exception("Gagal update rute: $e");}}// ===========================================================================// BAGIAN 2: FUNGSI GET & READ DATA// ===========================================================================// --- 4. AMBIL RUTE BULANAN (KALENDER) ---Future<List<DeliveryRoute>> getRoutesByMonth(DateTime month) async {try {final userId = _supabase.auth.currentUser!.id;final profile = await _supabase.from('profiles').select('role, sppg_id').eq('id', userId).single();final startDate = DateTime(month.year, month.month, 1);final endDate = DateTime(month.year, month.month + 1, 0);var query = _supabase.from('delivery_routes').select('*, vehicles(plate_number), profiles(full_name), menus(name)').gte('date', startDate.toIso8601String()).lte('date', endDate.toIso8601String());if (profile['role'] == 'kurir') {query = query.eq('courier_id', userId);} else {query = query.eq('sppg_id', profile['sppg_id']);}final response = await query;return (response as List).map((json) => DeliveryRoute.fromJson(json)).toList();} catch (e) {throw Exception("Gagal ambil jadwal: $e");}}// --- 5. AMBIL SEMUA RUTE (LIST HISTORY ADMIN) ---Future<List<DeliveryRoute>> getMyRoutes() async {try {final userId = _supabase.auth.currentUser!.id;final profile = await _supabase.from('profiles').select('sppg_id').eq('id', userId).single();final String mySppgId = profile['sppg_id'];final response = await _supabase.from('delivery_routes').select('*, vehicles(plate_number), profiles(full_name)').eq('sppg_id', mySppgId).order('date', ascending: false);final List<dynamic> data = response;return data.map((json) => DeliveryRoute.fromJson(json)).toList();} catch (e) {throw Exception("Gagal ambil rute admin: $e");}}// --- 6. AMBIL RUTE KURIR (LIST) ---Future<List<DeliveryRoute>> getRoutesByCourier() async {try {final currentCourierId = _supabase.auth.currentUser!.id;final response = await _supabase.from('delivery_routes').select('*, vehicles(plate_number), profiles(full_name)').eq('courier_id', currentCourierId).order('date', ascending: false);final List<dynamic> data = response;return data.map((json) => DeliveryRoute.fromJson(json)).toList();} catch (e) {throw Exception("Gagal ambil rute kurir: $e");}}// --- 7. AMBIL DETAIL STOPS (DENGAN KOORDINAT GPS) ---Future<List<Map<String, dynamic>>> getRouteStops(String routeId) async {try {final response = await _supabase.from('delivery_stops').select('*, schools(name, address, gps_lat, gps_long, student_count, menu_default, deadline_time)',).eq('route_id', routeId).order('sequence_order', ascending: true);return List<Map<String, dynamic>>.from(response);} catch (e) {throw Exception("Gagal ambil detail stop: $e");}}// ===========================================================================// BAGIAN 3: UPDATE STATUS & UTILITAS// ===========================================================================Future<void> updateRouteStatus(String routeId, String newStatus) async {try {await _supabase.from('delivery_routes').update({'status': newStatus}).eq('id', routeId);} catch (e) {throw Exception("Gagal update status rute: $e");}}Future<void> updateStopStatus(String stopId, String newStatus) async {try {await _supabase.from('delivery_stops').update({'status': newStatus,'arrival_time': newStatus == 'completed'? DateTime.now().toIso8601String(): null,}).eq('id', stopId);} catch (e) {throw Exception("Gagal update status stop: $e");}}Future<void> validateLoadWithPhoto(String routeId, String photoUrl) async {try {await _supabase.from('delivery_routes').update({'status': 'active','load_proof_photo_url': photoUrl,'start_time': DateTime.now().toIso8601String(),}).eq('id', routeId);} catch (e) {throw Exception("Gagal validasi muatan: $e");}}Future<void> completeStopWithPhoto(String stopId, String photoUrl) async {try {await _supabase.from('delivery_stops').update({'status': 'completed','courier_proof_photo_url': photoUrl,'arrival_time': DateTime.now().toIso8601String(),}).eq('id', stopId);} catch (e) {throw Exception("Gagal update stop: $e");}}Future<void> deleteRoute(String routeId) async {try {await _supabase.from('delivery_routes').delete().eq('id', routeId);} catch (e) {throw Exception("Gagal menghapus rute: $e");}}// --- UTILITAS PETA & LOKASI ---Future<List<LatLng>> getRoutePolyline(List<LatLng> coordinates) async {if (coordinates.length < 2) return [];String coordString = coordinates.map((p) => "${p.longitude},${p.latitude}").join(';');final url = Uri.parse('https://router.project-osrm.org/route/v1/driving/$coordString?overview=full&geometries=geojson',);try {final response = await http.get(url);if (response.statusCode == 200) {final data = jsonDecode(response.body);if (data['code'] != 'Ok') return [];final List<dynamic> coords =data['routes'][0]['geometry']['coordinates'];return coords.map((c) => LatLng(c[1].toDouble(), c[0].toDouble())).toList();} else {return [];}} catch (e) {return [];}}Future<LatLng?> getSppgLocation() async {try {final userId = _supabase.auth.currentUser!.id;final profile = await _supabase.from('profiles').select('sppg_id').eq('id', userId).single();final String sppgId = profile['sppg_id'];final sppgData = await _supabase.from('sppgs').select('gps_lat, gps_long').eq('id', sppgId).single();if (sppgData['gps_lat'] != null && sppgData['gps_long'] != null) {return LatLng(double.parse(sppgData['gps_lat'].toString()),double.parse(sppgData['gps_long'].toString()),);}return null;} catch (e) {return null;}}}

=== FILE: lib/features/admin_sppg/services/vehicle_service.dart ===
import 'package:supabase_flutter/supabase_flutter.dart';import '../../../models/vehicle_model.dart';class VehicleService {final _supabase = Supabase.instance.client;// 1. AMBIL LIST TRANSPORTASIFuture<List<Vehicle>> getMyVehicles() async {try {final userId = _supabase.auth.currentUser!.id;// Cek user ini kerja di SPPG mana?final profile = await _supabase.from('profiles').select('sppg_id').eq('id', userId).single();final String mySppgId = profile['sppg_id'];// Ambil kendaraan milik SPPG inifinal response = await _supabase.from('vehicles').select().eq('sppg_id', mySppgId).order('is_active', ascending: false); // Yg aktif paling atasfinal List<dynamic> data = response;return data.map((json) => Vehicle.fromJson(json)).toList();} catch (e) {throw Exception('Gagal ambil data transportasi: $e');}}// 2. TAMBAH TRANSPORTASI BARUFuture<void> createVehicle(Map<String, dynamic> data) async {try {final userId = _supabase.auth.currentUser!.id;final profile = await _supabase.from('profiles').select('sppg_id').eq('id', userId).single();// Inject ID SPPG otomatisdata['sppg_id'] = profile['sppg_id'];await _supabase.from('vehicles').insert(data);} catch (e) {throw Exception('Gagal menambah transportasi: $e');}}// 3. UPDATE STATUS (Aktif/Nonaktif)Future<void> toggleStatus(String vehicleId, bool currentStatus) async {try {await _supabase.from('vehicles').update({'is_active': !currentStatus}).eq('id', vehicleId);} catch (e) {throw Exception('Gagal update status: $e');}}Future<void> updateVehicle(String id, Map<String, dynamic> data) async {try {await _supabase.from('vehicles').update(data).eq('id', id);} catch (e) {throw Exception('Gagal update kendaraan: $e');}}Future<void> deleteVehicle(String id) async {try {// Hapus kendaraanawait _supabase.from('vehicles').delete().eq('id', id);} catch (e) {throw Exception('Gagal menghapus kendaraan: $e');}}}

=== FILE: lib/features/admin_sppg/services/stats_service.dart ===
import 'package:supabase_flutter/supabase_flutter.dart';class StatsService {final _supabase = Supabase.instance.client;Future<String> _getMySppgId() async {final userId = _supabase.auth.currentUser!.id;final profile = await _supabase.from('profiles').select('sppg_id').eq('id', userId).single();return profile['sppg_id'];}// Hitung status pengiriman (Sukses vs Masalah vs Pending)Future<Map<String, int>> getDeliveryStats() async {try {final mySppgId = await _getMySppgId();// Ambil semua data stops yang terkait dengan SPPG ini// Join: delivery_routes -> filter SPPGfinal response = await _supabase.from('delivery_stops').select('status, delivery_routes!inner(sppg_id)').eq('delivery_routes.sppg_id', mySppgId);final List<dynamic> data = response;int received = 0; // Suksesint issues = 0; // Masalahint pending = 0; // Belum selesaifor (var item in data) {final status = item['status'];if (status == 'received') {received++;} else if (status == 'issue_reported') {issues++;} else {pending++; // pending, active, completed (belum confirm)}}return {'received': received,'issues': issues,'pending': pending,'total': data.length,};} catch (e) {throw Exception("Gagal hitung statistik: $e");}}}

=== FILE: lib/features/kurir/screens/route_detail_screen.dart ===
import 'dart:io';import 'package:flutter/material.dart';import 'package:flutter_map/flutter_map.dart';import 'package:latlong2/latlong.dart';import 'package:url_launcher/url_launcher.dart';import 'package:image_picker/image_picker.dart';import '../../admin_sppg/services/route_service.dart';import '../../../models/route_model.dart';import '../../../core/services/storage_service.dart';class RouteDetailScreen extends StatefulWidget {final DeliveryRoute route;const RouteDetailScreen({super.key, required this.route});@overrideState<RouteDetailScreen> createState() => _RouteDetailScreenState();}class _RouteDetailScreenState extends State<RouteDetailScreen> {final RouteService _routeService = RouteService();final StorageService _storageService = StorageService();final MapController _mapController = MapController();List<Map<String, dynamic>> _stops = [];List<LatLng> _polylinePoints = [];LatLng? _sppgLocation;bool _isLoading = true;String _currentStatus = 'pending';// [BARU] Variabel untuk Jam BerangkatString _departureTime = "--:--";@overridevoid initState() {super.initState();_currentStatus = widget.route.status;_departureTime = _formatTime(widget.route.departureTime); // Ambil dari Model Route_fetchData();}String _formatTime(String? timeStr) {if (timeStr == null) return "--:--";try {// Format HH:mm:ss -> HH:mmreturn timeStr.substring(0, 5);} catch (_) { return timeStr; }}void _zoomMap(double change) {final currentZoom = _mapController.camera.zoom;final newZoom = (currentZoom + change).clamp(3.0, 18.0);_mapController.move(_mapController.camera.center, newZoom);}Future<void> _fetchData() async {try {final origin = await _routeService.getSppgLocation();_sppgLocation = origin;final stopsData = await _routeService.getRouteStops(widget.route.id);List<LatLng> routingPoints = [];if (origin != null) routingPoints.add(origin);for (var i = 0; i < stopsData.length; i++) {final school = stopsData[i]['schools'];if (school['gps_lat'] != null && school['gps_long'] != null) {double? lat = double.tryParse(school['gps_lat'].toString());double? long = double.tryParse(school['gps_long'].toString());if (lat != null && long != null) {routingPoints.add(LatLng(lat, long));}}}List<LatLng> polyline = [];if (routingPoints.length >= 2) {polyline = await _routeService.getRoutePolyline(routingPoints);}if (!mounted) return;setState(() {_stops = stopsData;_polylinePoints = polyline;_isLoading = false;});if (routingPoints.isNotEmpty) {Future.delayed(const Duration(seconds: 1), () {if (!mounted) return;try {_mapController.fitCamera(CameraFit.bounds(bounds: LatLngBounds.fromPoints(routingPoints),padding: const EdgeInsets.all(60),),);} catch (_) {}});}} catch (e) {if(mounted) setState(() => _isLoading = false);}}Future<void> _launchGoogleMaps(double lat, double long) async {final Uri googleMapsUrl = Uri.parse("google.navigation:q=$lat,$long&mode=d");try { await launchUrl(googleMapsUrl); }catch (e) { if (mounted) ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Gagal: $e"))); }}void _showValidationDialog() {File? photoFile;bool isSubmitting = false;showDialog(context: context, barrierDismissible: false, builder: (ctx) => StatefulBuilder(builder: (context, setDialogState) {return AlertDialog(title: const Text("Validasi Muatan"),content: Column(mainAxisSize: MainAxisSize.min, children: [const Text("Wajib lampirkan foto muatan di mobil."),const SizedBox(height: 15),GestureDetector(onTap: () async {final file = await _storageService.pickImage(ImageSource.camera);if (file != null) setDialogState(() => photoFile = file);},child: Container(height: 120, width: double.infinity, decoration: BoxDecoration(color: Colors.grey[200], border: Border.all(color: Colors.grey), borderRadius: BorderRadius.circular(8)), child: photoFile == null ? const Column(mainAxisAlignment: MainAxisAlignment.center, children: [Icon(Icons.camera_alt, size: 30), Text("FOTO BUKTI MUAT")]) : Image.file(photoFile!, fit: BoxFit.cover)),),if (isSubmitting) const Padding(padding: EdgeInsets.only(top: 10), child: LinearProgressIndicator()),]),actions: [if (!isSubmitting) TextButton(onPressed: () => Navigator.pop(ctx), child: const Text("Batal")),if (!isSubmitting) ElevatedButton(onPressed: () async {if (photoFile == null) { ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Foto bukti wajib ada!"))); return; }setDialogState(() => isSubmitting = true);try {final url = await _storageService.uploadEvidence(photoFile!, 'loading_proof');await _routeService.validateLoadWithPhoto(widget.route.id, url);if (!mounted) return;Navigator.pop(ctx);setState(() => _currentStatus = 'active');ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Pengiriman Dimulai!")));} catch (e) { setDialogState(() => isSubmitting = false); }}, child: const Text("Mulai Pengiriman")),],);}));}void _showCompleteDialog(String stopId, String schoolName) {File? photoFile;bool isSubmitting = false;showDialog(context: context, builder: (ctx) => StatefulBuilder(builder: (context, setDialogState) {return AlertDialog(title: Text("Tiba di $schoolName"),content: Column(mainAxisSize: MainAxisSize.min, children: [const Text("Lampirkan foto bukti makanan sampai."),const SizedBox(height: 15),GestureDetector(onTap: () async { final file = await _storageService.pickImage(ImageSource.camera); if (file != null) setDialogState(() => photoFile = file); },child: Container(height: 120, width: double.infinity, decoration: BoxDecoration(color: Colors.grey[200], border: Border.all(color: Colors.grey)), child: photoFile == null ? const Column(mainAxisAlignment: MainAxisAlignment.center, children: [Icon(Icons.camera_alt), Text("FOTO BUKTI")]) : Image.file(photoFile!, fit: BoxFit.cover)),),if (isSubmitting) const Padding(padding: EdgeInsets.only(top: 10), child: LinearProgressIndicator()),]),actions: [if (!isSubmitting) TextButton(onPressed: () => Navigator.pop(ctx), child: const Text("Batal")),if (!isSubmitting) ElevatedButton(onPressed: () async {if (photoFile == null) { ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text("Foto bukti wajib ada!"))); return; }setDialogState(() => isSubmitting = true);try {final url = await _storageService.uploadEvidence(photoFile!, 'arrival_proof');await _routeService.completeStopWithPhoto(stopId, url);if (!mounted) return;Navigator.pop(ctx);_fetchData();ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Selesai di $schoolName!")));} catch (e) { setDialogState(() => isSubmitting = false); }}, child: const Text("Selesai")),],);}));}@overrideWidget build(BuildContext context) {return Scaffold(appBar: AppBar(title: const Text("Detail Pengiriman"),backgroundColor: _currentStatus == 'active' ? Colors.green[700] : Colors.blue[800],foregroundColor: Colors.white,),body: Column(children: [// --- PETA (TETAP SAMA) ---SizedBox(height: 250,child: Stack(children: [FlutterMap(mapController: _mapController,options: const MapOptions(initialCenter: LatLng(-6.9175, 107.6191), initialZoom: 13.0, interactionOptions: InteractionOptions(flags: InteractiveFlag.all)),children: [TileLayer(urlTemplate: 'https://tile.openstreetmap.org/{z}/{x}/{y}.png', userAgentPackageName: 'com.example.mbg_monitoring'),PolylineLayer(polylines: [Polyline(points: _polylinePoints, strokeWidth: 5.0, color: Colors.blueAccent)]),MarkerLayer(markers: [if (_sppgLocation != null)Marker(point: _sppgLocation!, width: 60, height: 60, child: const Column(mainAxisAlignment: MainAxisAlignment.center, children: [Icon(Icons.store_mall_directory, color: Colors.purple, size: 35), Text("DAPUR", style: TextStyle(fontSize: 10, fontWeight: FontWeight.bold, color: Colors.purple, backgroundColor: Colors.white70))])),..._stops.map((stop) {final school = stop['schools'];final isCompleted = stop['status'] == 'completed';if (school['gps_lat'] == null) return const Marker(point: LatLng(0,0), child: SizedBox());double lat = double.parse(school['gps_lat'].toString());double long = double.parse(school['gps_long'].toString());return Marker(point: LatLng(lat, long), width: 60, height: 60, child: Column(mainAxisAlignment: MainAxisAlignment.center, children: [Icon(Icons.location_on, color: isCompleted ? Colors.green : Colors.red, size: 35), Container(padding: const EdgeInsets.symmetric(horizontal: 4, vertical: 2), decoration: BoxDecoration(color: Colors.white, borderRadius: BorderRadius.circular(4), border: Border.all(color: Colors.grey)), child: Text("${stop['sequence_order']}", style: const TextStyle(fontSize: 10, fontWeight: FontWeight.bold)))]));}).toList(),],),],),Positioned(right: 10, bottom: 10, child: Column(children: [FloatingActionButton.small(heroTag: "btnZoomIn", onPressed: () => _zoomMap(1), backgroundColor: Colors.white, child: const Icon(Icons.add, color: Colors.black)), const SizedBox(height: 10), FloatingActionButton.small(heroTag: "btnZoomOut", onPressed: () => _zoomMap(-1), backgroundColor: Colors.white, child: const Icon(Icons.remove, color: Colors.black))])),],),),// --- [BARU] INFO JADWAL BERANGKAT ---Container(padding: const EdgeInsets.symmetric(vertical: 12, horizontal: 16),color: Colors.orange[50],child: Row(mainAxisAlignment: MainAxisAlignment.spaceBetween,children: [const Text("Jadwal Berangkat:", style: TextStyle(fontWeight: FontWeight.bold)),Text(_departureTime, style: const TextStyle(fontSize: 18, fontWeight: FontWeight.bold, color: Colors.orange)),],),),// LIST SEKOLAHExpanded(child: _isLoading? const Center(child: CircularProgressIndicator()): ListView.builder(padding: const EdgeInsets.all(10),itemCount: _stops.length,itemBuilder: (context, index) {final stop = _stops[index];final school = stop['schools'];final bool isCompleted = stop['status'] == 'completed';// Ambil ETA (Estimasi Tiba)String eta = _formatTime(stop['estimated_arrival_time']);double? lat, long;if (school['gps_lat'] != null) {lat = double.parse(school['gps_lat'].toString());long = double.parse(school['gps_long'].toString());}return Card(color: isCompleted ? Colors.green[50] : Colors.white,elevation: 3,margin: const EdgeInsets.only(bottom: 10),child: ListTile(contentPadding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),leading: CircleAvatar(backgroundColor: isCompleted ? Colors.green : Colors.grey[300],child: Text("${index + 1}", style: TextStyle(color: isCompleted ? Colors.white : Colors.black, fontWeight: FontWeight.bold)),),title: Text(school['name'], style: const TextStyle(fontWeight: FontWeight.bold)),// [BARU] Tampilkan Estimasi Tibasubtitle: Text("Est. Tiba: $eta\nMenu: ${school['menu_default'] ?? '-'}"),isThreeLine: true,trailing: Row(mainAxisSize: MainAxisSize.min,children: [if (lat != null && long != null)IconButton(icon: const Icon(Icons.directions, color: Colors.blue),onPressed: () => _launchGoogleMaps(lat!, long!),tooltip: "Navigasi",),if (_currentStatus == 'active' && !isCompleted)ElevatedButton(style: ElevatedButton.styleFrom(backgroundColor: Colors.green, foregroundColor: Colors.white),onPressed: () => _showCompleteDialog(stop['id'], school['name']),child: const Text("Tiba"),)else if (isCompleted)const Icon(Icons.check_circle, color: Colors.green, size: 32),],),),);},),),],),bottomNavigationBar: _currentStatus == 'pending'? Padding(padding: const EdgeInsets.all(16.0),child: ElevatedButton.icon(onPressed: _showValidationDialog,icon: const Icon(Icons.checklist),label: const Text("VALIDASI MUATAN & MULAI"),style: ElevatedButton.styleFrom(backgroundColor: Colors.blue[800],foregroundColor: Colors.white,padding: const EdgeInsets.symmetric(vertical: 15),),),): null,);}}

=== FILE: lib/features/kurir/screens/dashboard_kurir_screen.dart ===
import 'package:flutter/material.dart';import 'package:supabase_flutter/supabase_flutter.dart';import 'package:intl/intl.dart';import 'package:table_calendar/table_calendar.dart';import '../../admin_sppg/services/route_service.dart';import '../../autentikasi/screens/login_screen.dart';import '../../../models/route_model.dart';import 'route_detail_screen.dart';import '../../../core/screens/profile_screen.dart';class DashboardKurirScreen extends StatefulWidget {const DashboardKurirScreen({super.key});@overrideState<DashboardKurirScreen> createState() => _DashboardKurirScreenState();}class _DashboardKurirScreenState extends State<DashboardKurirScreen> {final RouteService _routeService = RouteService();DateTime _focusedDay = DateTime.now();DateTime _selectedDay = DateTime.now();// Format Kalender DefaultCalendarFormat _calendarFormat = CalendarFormat.month;Map<DateTime, List<DeliveryRoute>> _routes = {};bool _isLoading = true;@overridevoid initState() {super.initState();_fetchRoutes();}Future<void> _fetchRoutes() async {setState(() => _isLoading = true);try {final data = await _routeService.getRoutesByMonth(_focusedDay);Map<DateTime, List<DeliveryRoute>> newMap = {};for (var route in data) {final date = DateTime.parse(route.date);final dateKey = DateTime(date.year, date.month, date.day);if (newMap[dateKey] == null) newMap[dateKey] = [];newMap[dateKey]!.add(route);}if (mounted) {setState(() {_routes = newMap;_isLoading = false;});}} catch (e) {if (mounted) setState(() => _isLoading = false);}}List<DeliveryRoute> _getRoutesForDay(DateTime day) {final dateKey = DateTime(day.year, day.month, day.day);return _routes[dateKey] ?? [];}Future<void> _logout() async {await Supabase.instance.client.auth.signOut();if (!mounted) return;Navigator.of(context).pushAndRemoveUntil(MaterialPageRoute(builder: (_) => const LoginScreen()),(route) => false,);}@overrideWidget build(BuildContext context) {return Scaffold(appBar: AppBar(title: const Text("Jadwal Pengiriman"),backgroundColor: Colors.blue[800],foregroundColor: Colors.white,actions: [IconButton(icon: const Icon(Icons.account_circle, size: 30),onPressed: () => Navigator.push(context, MaterialPageRoute(builder: (_) => const ProfileScreen())),),],),body: Column(children: [// --- HEADER CUSTOM: DROPDOWN FORMAT ---Container(padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),color: Colors.grey[100],child: Row(mainAxisAlignment: MainAxisAlignment.spaceBetween,children: [const Text("Tampilan Kalender:", style: TextStyle(fontWeight: FontWeight.bold)),// DROPDOWN MENUContainer(padding: const EdgeInsets.symmetric(horizontal: 12),decoration: BoxDecoration(color: Colors.white,borderRadius: BorderRadius.circular(8),border: Border.all(color: Colors.grey.shade300),),child: DropdownButtonHideUnderline(child: DropdownButton<CalendarFormat>(value: _calendarFormat,icon: const Icon(Icons.arrow_drop_down, color: Colors.blue),items: const [DropdownMenuItem(value: CalendarFormat.month,child: Text("Bulan (Full)"),),DropdownMenuItem(value: CalendarFormat.twoWeeks,child: Text("2 Minggu"),),DropdownMenuItem(value: CalendarFormat.week,child: Text("1 Minggu"),),],onChanged: (format) {if (format != null) {setState(() {_calendarFormat = format;});}},),),),],),),// --- KALENDER ---TableCalendar<DeliveryRoute>(firstDay: DateTime.utc(2024, 1, 1),lastDay: DateTime.utc(2030, 12, 31),focusedDay: _focusedDay,selectedDayPredicate: (day) => isSameDay(_selectedDay, day),// Gunakan variable state yang diubah oleh DropdowncalendarFormat: _calendarFormat,// Matikan tombol format bawaan karena kita sudah punya dropdownheaderStyle: const HeaderStyle(formatButtonVisible: false,titleCentered: true,),eventLoader: _getRoutesForDay,onDaySelected: (selected, focused) {setState(() {_selectedDay = selected;_focusedDay = focused;});},onPageChanged: (focused) {_focusedDay = focused;_fetchRoutes();},calendarStyle: const CalendarStyle(markerDecoration: BoxDecoration(color: Colors.blue, shape: BoxShape.circle),todayDecoration: BoxDecoration(color: Colors.orange, shape: BoxShape.circle),selectedDecoration: BoxDecoration(color: Colors.blue, shape: BoxShape.circle),),),const Divider(thickness: 1, height: 1),// --- LIST RUTE HARI INI ---Expanded(child: _isLoading? const Center(child: CircularProgressIndicator()): _buildDayList(),),],),);}Widget _buildDayList() {final routes = _getRoutesForDay(_selectedDay);if (routes.isEmpty) {return Center(child: Column(mainAxisAlignment: MainAxisAlignment.center,children: [Icon(Icons.event_busy, size: 60, color: Colors.grey[300]),const SizedBox(height: 10),Text("Tidak ada pengiriman tgl ${DateFormat('d MMM').format(_selectedDay)}",style: const TextStyle(color: Colors.grey),),],),);}return ListView.builder(padding: const EdgeInsets.all(12),itemCount: routes.length,itemBuilder: (context, index) {final route = routes[index];return Card(elevation: 3,margin: const EdgeInsets.only(bottom: 12),child: ListTile(leading: const Icon(Icons.local_shipping, color: Colors.blue, size: 32),title: Text("Armada: ${route.vehiclePlate ?? '-'}",style: const TextStyle(fontWeight: FontWeight.bold),),subtitle: Text("Status: ${route.status.toUpperCase()}"),trailing: const Icon(Icons.arrow_forward_ios, size: 16),onTap: () {Navigator.push(context,MaterialPageRoute(builder: (_) => RouteDetailScreen(route: route)),).then((val) {_fetchRoutes();});},),);},);}}

=== FILE: .env ===
SUPABASE_URL=https://mqyfrqgfpqwlrloqtpvi.supabase.coSUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1xeWZycWdmcHF3bHJsb3F0cHZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0NTMxMDMsImV4cCI6MjA3OTAyOTEwM30.KoXKouhFN0H7Iz9MSnRhFQuBIePVMwWyXmrzSv3rEeQ

=== FILE: pubspec.yaml ===
name: rplldescription: "A new Flutter project."publish_to: 'none' # Remove this line if you wish to publish to pub.devversion: 1.0.0+1environment:sdk: ^3.9.2dependencies:flutter:sdk: flutter# Iconscupertino_icons: ^1.0.8# Backend & Databasesupabase_flutter: ^2.10.3# Fitur Hardware & Lokasigoogle_maps_flutter: ^2.14.0geolocator: ^14.0.2camera: ^0.11.3image_picker: ^1.2.1# State Management & Routingprovider: ^6.1.5+1go_router: ^17.0.0# Utilitasintl: ^0.20.2flutter_dotenv: ^6.0.0flutter_map: ^8.2.2latlong2: ^0.9.1http: ^1.6.0url_launcher: ^6.3.2fl_chart: ^1.1.1table_calendar: ^3.2.0dev_dependencies:flutter_test:sdk: flutterflutter_lints: ^5.0.0flutter:uses-material-design: true# Bagian ini yang paling PENTING spasinya harus pasassets:- .env

=== FILE: android/app/src/main/AndroidManifest.xml ===
<manifest xmlns:android="http://schemas.android.com/apk/res/android"><uses-permission android:name="android.permission.INTERNET"/><uses-permission android:name="android.permission.ACCESS_FINE_LOCATION"/><uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION"/><uses-permission android:name="android.permission.CAMERA"/><uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"/><uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"/><queries><intent><action android:name="android.intent.action.VIEW" /><data android:scheme="google.navigation" /></intent><intent><action android:name="android.intent.action.VIEW" /><data android:scheme="geo" /></intent><intent><action android:name="android.intent.action.VIEW" /><data android:scheme="https" /></intent><intent><action android:name="android.intent.action.PROCESS_TEXT"/><data android:mimeType="text/plain"/></intent></queries><applicationandroid:label="SMASH"android:name="${applicationName}"android:icon="@mipmap/ic_launcher"><activityandroid:name=".MainActivity"android:exported="true"android:launchMode="singleTop"android:taskAffinity=""android:theme="@style/LaunchTheme"android:configChanges="orientation|keyboardHidden|keyboard|screenSize|smallestScreenSize|locale|layoutDirection|fontScale|screenLayout|density|uiMode"android:hardwareAccelerated="true"android:windowSoftInputMode="adjustResize"><meta-dataandroid:name="io.flutter.embedding.android.NormalTheme"android:resource="@style/NormalTheme"/><intent-filter><action android:name="android.intent.action.MAIN"/><category android:name="android.intent.category.LAUNCHER"/></intent-filter></activity><meta-dataandroid:name="flutterEmbedding"android:value="2" /></application></manifest>
